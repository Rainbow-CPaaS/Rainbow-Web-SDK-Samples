(function(e){function t(r){if(a[r])return a[r].exports;var n=a[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{enumerable:!0,get:r})},t.r=function(e){'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})},t.t=function(e,a){if(1&a&&(e=t(e)),8&a)return e;if(4&a&&'object'==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,'default',{enumerable:!0,value:e}),2&a&&'string'!=typeof e)for(var n in e)t.d(r,n,function(t){return e[t]}.bind(null,n));return r},t.n=function(e){var a=e&&e.__esModule?function(){return e['default']}:function(){return e};return t.d(a,'a',a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p='',t(t.s=117)})([function(e){'use strict';var t={};t.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split('\n').map(function(e){return e.trim()})},t.splitSections=function(e){var t=e.split('\nm=');return t.map(function(e,t){return(0<t?'m='+e:e).trim()+'\r\n'})},t.getDescription=function(e){var a=t.splitSections(e);return a&&a[0]},t.getMediaSections=function(e){var a=t.splitSections(e);return a.shift(),a},t.matchPrefix=function(e,a){return t.splitLines(e).filter(function(e){return 0===e.indexOf(a)})},t.parseCandidate=function(e){var t=0===e.indexOf('a=candidate:')?e.substring(12).split(' '):e.substring(10).split(' ');for(var a={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case'raddr':a.relatedAddress=t[r+1];break;case'rport':a.relatedPort=parseInt(t[r+1],10);break;case'tcptype':a.tcpType=t[r+1];break;case'ufrag':a.ufrag=t[r+1],a.usernameFragment=t[r+1];break;default:a[t[r]]=t[r+1];}return a},t.writeCandidate=function(e){var t=[e.foundation,e.component,e.protocol.toUpperCase(),e.priority,e.address||e.ip,e.port],a=e.type;return t.push('typ'),t.push(a),'host'!==a&&e.relatedAddress&&e.relatedPort&&(t.push('raddr'),t.push(e.relatedAddress),t.push('rport'),t.push(e.relatedPort)),e.tcpType&&'tcp'===e.protocol.toLowerCase()&&(t.push('tcptype'),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push('ufrag'),t.push(e.usernameFragment||e.ufrag)),'candidate:'+t.join(' ')},t.parseIceOptions=function(e){return e.substr(14).split(' ')},t.parseRtpMap=function(e){var t=e.substr(9).split(' '),a={payloadType:parseInt(t.shift(),10)};return t=t[0].split('/'),a.name=t[0],a.clockRate=parseInt(t[1],10),a.channels=3===t.length?parseInt(t[2],10):1,a.numChannels=a.channels,a},t.writeRtpMap=function(e){var t=e.payloadType;e.preferredPayloadType!==void 0&&(t=e.preferredPayloadType);var a=e.channels||e.numChannels||1;return'a=rtpmap:'+t+' '+e.name+'/'+e.clockRate+(1===a?'':'/'+a)+'\r\n'},t.parseExtmap=function(e){var t=e.substr(9).split(' ');return{id:parseInt(t[0],10),direction:0<t[0].indexOf('/')?t[0].split('/')[1]:'sendrecv',uri:t[1]}},t.writeExtmap=function(e){return'a=extmap:'+(e.id||e.preferredId)+(e.direction&&'sendrecv'!==e.direction?'/'+e.direction:'')+' '+e.uri+'\r\n'},t.parseFmtp=function(e){for(var t={},a=e.substr(e.indexOf(' ')+1).split(';'),r=0,n;r<a.length;r++)n=a[r].trim().split('='),t[n[0].trim()]=n[1];return t},t.writeFmtp=function(e){var t='',a=e.payloadType;if(void 0!==e.preferredPayloadType&&(a=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?r.push(t+'='+e.parameters[t]):r.push(t)}),t+='a=fmtp:'+a+' '+r.join(';')+'\r\n'}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(' ')+1).split(' ');return{type:t.shift(),parameter:t.join(' ')}},t.writeRtcpFb=function(e){var t='',a=e.payloadType;return void 0!==e.preferredPayloadType&&(a=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+='a=rtcp-fb:'+a+' '+e.type+(e.parameter&&e.parameter.length?' '+e.parameter:'')+'\r\n'}),t},t.parseSsrcMedia=function(e){var t=e.indexOf(' '),a={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(':',t);return-1<r?(a.attribute=e.substr(t+1,r-t-1),a.value=e.substr(r+1)):a.attribute=e.substr(t+1),a},t.parseSsrcGroup=function(e){var t=e.substr(13).split(' ');return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},t.getMid=function(e){var a=t.matchPrefix(e,'a=mid:')[0];if(a)return a.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(' ');return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,a){var r=t.matchPrefix(e+a,'a=fingerprint:');return{role:'auto',fingerprints:r.map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var a='a=setup:'+t+'\r\n';return e.fingerprints.forEach(function(e){a+='a=fingerprint:'+e.algorithm+' '+e.value+'\r\n'}),a},t.getIceParameters=function(e,a){var r=t.splitLines(e);r=r.concat(t.splitLines(a));var n={usernameFragment:r.filter(function(e){return 0===e.indexOf('a=ice-ufrag:')})[0].substr(12),password:r.filter(function(e){return 0===e.indexOf('a=ice-pwd:')})[0].substr(10)};return n},t.writeIceParameters=function(e){return'a=ice-ufrag:'+e.usernameFragment+'\r\na=ice-pwd:'+e.password+'\r\n'},t.parseRtpParameters=function(e){for(var a={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e),n=r[0].split(' '),o=3;o<n.length;o++){var i=n[o],s=t.matchPrefix(e,'a=rtpmap:'+i+' ')[0];if(s){var d=t.parseRtpMap(s),c=t.matchPrefix(e,'a=fmtp:'+i+' ');switch(d.parameters=c.length?t.parseFmtp(c[0]):{},d.rtcpFeedback=t.matchPrefix(e,'a=rtcp-fb:'+i+' ').map(t.parseRtcpFb),a.codecs.push(d),d.name.toUpperCase()){case'RED':case'ULPFEC':a.fecMechanisms.push(d.name.toUpperCase());break;default:}}}return t.matchPrefix(e,'a=extmap:').forEach(function(e){a.headerExtensions.push(t.parseExtmap(e))}),a},t.writeRtpDescription=function(e,a){var r='';r+='m='+e+' ',r+=0<a.codecs.length?'9':'0',r+=' UDP/TLS/RTP/SAVPF ',r+=a.codecs.map(function(e){return void 0===e.preferredPayloadType?e.payloadType:e.preferredPayloadType}).join(' ')+'\r\n',r+='c=IN IP4 0.0.0.0\r\n',r+='a=rtcp:9 IN IP4 0.0.0.0\r\n',a.codecs.forEach(function(e){r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)});var n=0;return a.codecs.forEach(function(e){e.maxptime>n&&(n=e.maxptime)}),0<n&&(r+='a=maxptime:'+n+'\r\n'),r+='a=rtcp-mux\r\n',a.headerExtensions&&a.headerExtensions.forEach(function(e){r+=t.writeExtmap(e)}),r},t.parseRtpEncodingParameters=function(e){var a=[],r=t.parseRtpParameters(e),n=-1!==r.fecMechanisms.indexOf('RED'),o=-1!==r.fecMechanisms.indexOf('ULPFEC'),i=t.matchPrefix(e,'a=ssrc:').map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return'cname'===e.attribute}),s=0<i.length&&i[0].ssrc,d=t.matchPrefix(e,'a=ssrc-group:FID').map(function(e){var t=e.substr(17).split(' ');return t.map(function(e){return parseInt(e,10)})}),c;0<d.length&&1<d[0].length&&d[0][0]===s&&(c=d[0][1]),r.codecs.forEach(function(e){if('RTX'===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:s,codecPayloadType:parseInt(e.parameters.apt,10)};s&&c&&(t.rtx={ssrc:c}),a.push(t),n&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:s,mechanism:o?'red+ulpfec':'red'},a.push(t))}}),0===a.length&&s&&a.push({ssrc:s});var l=t.matchPrefix(e,'b=');return l.length&&(l=0===l[0].indexOf('b=TIAS:')?parseInt(l[0].substr(7),10):0===l[0].indexOf('b=AS:')?.95*(1e3*parseInt(l[0].substr(5),10))-16000:void 0,a.forEach(function(e){e.maxBitrate=l})),a},t.parseRtcpParameters=function(e){var a={},r=t.matchPrefix(e,'a=ssrc:').map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return'cname'===e.attribute})[0];r&&(a.cname=r.value,a.ssrc=r.ssrc);var n=t.matchPrefix(e,'a=rtcp-rsize');a.reducedSize=0<n.length,a.compound=0===n.length;var o=t.matchPrefix(e,'a=rtcp-mux');return a.mux=0<o.length,a},t.parseMsid=function(e){var a=t.matchPrefix(e,'a=msid:'),r;if(1===a.length)return r=a[0].substr(7).split(' '),{stream:r[0],track:r[1]};var n=t.matchPrefix(e,'a=ssrc:').map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return'msid'===e.attribute});if(0<n.length)return r=n[0].value.split(' '),{stream:r[0],track:r[1]}},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,a,r){var n=a===void 0?2:a,o;o=e?e:t.generateSessionId();return'v=0\r\no='+(r||'thisisadapterortc')+' '+o+' '+n+' IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n'},t.writeMediaSection=function(e,a,r,n){var o=t.writeRtpDescription(e.kind,a);if(o+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),'offer'===r?'actpass':'active'),o+='a=mid:'+e.mid+'\r\n',o+=e.direction?'a='+e.direction+'\r\n':e.rtpSender&&e.rtpReceiver?'a=sendrecv\r\n':e.rtpSender?'a=sendonly\r\n':e.rtpReceiver?'a=recvonly\r\n':'a=inactive\r\n',e.rtpSender){var i='msid:'+n.id+' '+e.rtpSender.track.id+'\r\n';o+='a='+i,o+='a=ssrc:'+e.sendEncodingParameters[0].ssrc+' '+i,e.sendEncodingParameters[0].rtx&&(o+='a=ssrc:'+e.sendEncodingParameters[0].rtx.ssrc+' '+i,o+='a=ssrc-group:FID '+e.sendEncodingParameters[0].ssrc+' '+e.sendEncodingParameters[0].rtx.ssrc+'\r\n')}return o+='a=ssrc:'+e.sendEncodingParameters[0].ssrc+' cname:'+t.localCName+'\r\n',e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+='a=ssrc:'+e.sendEncodingParameters[0].rtx.ssrc+' cname:'+t.localCName+'\r\n'),o},t.getDirection=function(e,a){for(var r=t.splitLines(e),n=0;n<r.length;n++)switch(r[n]){case'a=sendrecv':case'a=sendonly':case'a=recvonly':case'a=inactive':return r[n].substr(2);default:}return a?t.getDirection(a):'sendrecv'},t.getKind=function(e){var a=t.splitLines(e),r=a[0].split(' ');return r[0].substr(2)},t.isRejected=function(e){return'0'===e.split(' ',2)[1]},t.parseMLine=function(e){var a=t.splitLines(e),r=a[0].substr(2).split(' ');return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(' ')}},t.parseOLine=function(e){var a=t.matchPrefix(e,'o=')[0],r=a.substr(2).split(' ');return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if('string'!=typeof e||0===e.length)return!1;for(var a=t.splitLines(e),r=0;r<a.length;r++)if(2>a[r].length||'='!==a[r].charAt(1))return!1;return!0},e.exports=t},function(e,t,a){'use strict';function r(e){return{inboundrtp:'inbound-rtp',outboundrtp:'outbound-rtp',candidatepair:'candidate-pair',localcandidate:'local-candidate',remotecandidate:'remote-candidate'}[e.type]||e.type}function n(e,t,a,r,n){var o=l.writeRtpDescription(e.kind,t);if(o+=l.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=l.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),'offer'===a?'actpass':n||'active'),o+='a=mid:'+e.mid+'\r\n',o+=e.rtpSender&&e.rtpReceiver?'a=sendrecv\r\n':e.rtpSender?'a=sendonly\r\n':e.rtpReceiver?'a=recvonly\r\n':'a=inactive\r\n',e.rtpSender){var i=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=i;var s='msid:'+(r?r.id:'-')+' '+i+'\r\n';o+='a='+s,o+='a=ssrc:'+e.sendEncodingParameters[0].ssrc+' '+s,e.sendEncodingParameters[0].rtx&&(o+='a=ssrc:'+e.sendEncodingParameters[0].rtx.ssrc+' '+s,o+='a=ssrc-group:FID '+e.sendEncodingParameters[0].ssrc+' '+e.sendEncodingParameters[0].rtx.ssrc+'\r\n')}return o+='a=ssrc:'+e.sendEncodingParameters[0].ssrc+' cname:'+l.localCName+'\r\n',e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+='a=ssrc:'+e.sendEncodingParameters[0].rtx.ssrc+' cname:'+l.localCName+'\r\n'),o}function o(e,t){var a=!1;return e=JSON.parse(JSON.stringify(e)),e.filter(function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&console.warn('RTCIceServer.url is deprecated! Use urls instead.');var n='string'==typeof r;return n&&(r=[r]),r=r.filter(function(e){var r=0===e.indexOf('turn:')&&-1!==e.indexOf('transport=udp')&&-1===e.indexOf('turn:[')&&!a;return r?(a=!0,!0):0===e.indexOf('stun:')&&14393<=t&&-1===e.indexOf('?transport=udp')}),delete e.url,e.urls=n?r[0]:r,!!r.length}})}function i(e,t){var a={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var a=0;a<t.length;a++)if(t[a].payloadType===e||t[a].preferredPayloadType===e)return t[a]},n=function(e,t,a,n){var o=r(e.parameters.apt,a),i=r(t.parameters.apt,n);return o&&i&&o.name.toLowerCase()===i.name.toLowerCase()};return e.codecs.forEach(function(r){for(var o=0,i;o<t.codecs.length;o++)if(i=t.codecs[o],r.name.toLowerCase()===i.name.toLowerCase()&&r.clockRate===i.clockRate){if('rtx'===r.name.toLowerCase()&&r.parameters&&i.parameters.apt&&!n(r,i,e.codecs,t.codecs))continue;i=JSON.parse(JSON.stringify(i)),i.numChannels=Math.min(r.numChannels,i.numChannels),a.codecs.push(i),i.rtcpFeedback=i.rtcpFeedback.filter(function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}),e.headerExtensions.forEach(function(e){for(var r=0,n;r<t.headerExtensions.length;r++)if(n=t.headerExtensions[r],e.uri===n.uri){a.headerExtensions.push(n);break}}),a}function s(e,t,a){return-1!=={offer:{setLocalDescription:['stable','have-local-offer'],setRemoteDescription:['stable','have-remote-offer']},answer:{setLocalDescription:['have-remote-offer','have-local-pranswer'],setRemoteDescription:['have-local-offer','have-remote-pranswer']}}[t][e].indexOf(a)}function d(e,t){var a=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return a||e.addRemoteCandidate(t),!a}function c(t,a){var r=new Error(a);return r.name=t,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[t],r}var l=a(0);e.exports=function(e,t){function a(t,a){a.addTrack(t),a.dispatchEvent(new e.MediaStreamTrackEvent('addtrack',{track:t}))}function p(t,a){a.removeTrack(t),a.dispatchEvent(new e.MediaStreamTrackEvent('removetrack',{track:t}))}function u(t,a,r,n){var o=new Event('track');o.track=a,o.receiver=r,o.transceiver={receiver:r},o.streams=n,e.setTimeout(function(){t._dispatchEvent('track',o)})}var m=function(a){var r=this,n=document.createDocumentFragment();if(['addEventListener','removeEventListener','dispatchEvent'].forEach(function(e){r[e]=n[e].bind(n)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState='stable',this.iceConnectionState='new',this.connectionState='new',this.iceGatheringState='new',a=JSON.parse(JSON.stringify(a||{})),this.usingBundle='max-bundle'===a.bundlePolicy,'negotiate'===a.rtcpMuxPolicy)throw c('NotSupportedError','rtcpMuxPolicy \'negotiate\' is not supported');else a.rtcpMuxPolicy||(a.rtcpMuxPolicy='require');switch(a.iceTransportPolicy){case'all':case'relay':break;default:a.iceTransportPolicy='all';}switch(a.bundlePolicy){case'balanced':case'max-compat':case'max-bundle':break;default:a.bundlePolicy='balanced';}if(a.iceServers=o(a.iceServers||[],t),this._iceGatherers=[],a.iceCandidatePoolSize)for(var s=a.iceCandidatePoolSize;0<s;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:a.iceServers,gatherPolicy:a.iceTransportPolicy}));else a.iceCandidatePoolSize=0;this._config=a,this.transceivers=[],this._sdpSessionId=l.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(m.prototype,'localDescription',{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(m.prototype,'remoteDescription',{configurable:!0,get:function(){return this._remoteDescription}}),m.prototype.onicecandidate=null,m.prototype.onaddstream=null,m.prototype.ontrack=null,m.prototype.onremovestream=null,m.prototype.onsignalingstatechange=null,m.prototype.oniceconnectionstatechange=null,m.prototype.onconnectionstatechange=null,m.prototype.onicegatheringstatechange=null,m.prototype.onnegotiationneeded=null,m.prototype.ondatachannel=null,m.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),'function'==typeof this['on'+e]&&this['on'+e](t))},m.prototype._emitGatheringStateChange=function(){var e=new Event('icegatheringstatechange');this._dispatchEvent('icegatheringstatechange',e)},m.prototype.getConfiguration=function(){return this._config},m.prototype.getLocalStreams=function(){return this.localStreams},m.prototype.getRemoteStreams=function(){return this.remoteStreams},m.prototype._createTransceiver=function(e,t){var a=0<this.transceivers.length,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&a)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();r.iceTransport=n.iceTransport,r.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(r),r},m.prototype.addTrack=function(t,a){if(this._isClosed)throw c('InvalidStateError','Attempted to call addTrack on a closed peerconnection.');var r=this.transceivers.find(function(e){return e.track===t});if(r)throw c('InvalidAccessError','Track already exists.');for(var n=0,o;n<this.transceivers.length;n++)this.transceivers[n].track||this.transceivers[n].kind!==t.kind||(o=this.transceivers[n]);return o||(o=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(a)&&this.localStreams.push(a),o.track=t,o.stream=a,o.rtpSender=new e.RTCRtpSender(t,o.dtlsTransport),o.rtpSender},m.prototype.addStream=function(e){var a=this;if(15025<=t)e.getTracks().forEach(function(t){a.addTrack(t,e)});else{var r=e.clone();e.getTracks().forEach(function(e,t){var a=r.getTracks()[t];e.addEventListener('enabled',function(e){a.enabled=e.enabled})}),r.getTracks().forEach(function(e){a.addTrack(e,r)})}},m.prototype.removeTrack=function(a){if(this._isClosed)throw c('InvalidStateError','Attempted to call removeTrack on a closed peerconnection.');if(!(a instanceof e.RTCRtpSender))throw new TypeError('Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.');var t=this.transceivers.find(function(e){return e.rtpSender===a});if(!t)throw c('InvalidAccessError','Sender was not created by this connection.');var r=t.stream;t.rtpSender.stop(),t.rtpSender=null,t.track=null,t.stream=null;var n=this.transceivers.map(function(e){return e.stream});-1===n.indexOf(r)&&-1<this.localStreams.indexOf(r)&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},m.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var a=t.getSenders().find(function(t){return t.track===e});a&&t.removeTrack(a)})},m.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},m.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},m.prototype._createIceGatherer=function(t,a){var r=this;if(a&&0<t)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,'state',{value:'new',writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var a=!e.candidate||0===Object.keys(e.candidate).length;n.state=a?'completed':'gathering',null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},n.addEventListener('localcandidate',this.transceivers[t].bufferCandidates),n},m.prototype._gather=function(t,a){var r=this,n=this.transceivers[a].iceGatherer;if(!n.onlocalcandidate){var o=this.transceivers[a].bufferedCandidateEvents;this.transceivers[a].bufferedCandidateEvents=null,n.removeEventListener('localcandidate',this.transceivers[a].bufferCandidates),n.onlocalcandidate=function(e){if(!(r.usingBundle&&0<a)){var o=new Event('icecandidate');o.candidate={sdpMid:t,sdpMLineIndex:a};var i=e.candidate,s=!i||0===Object.keys(i).length;if(s)('new'===n.state||'gathering'===n.state)&&(n.state='completed');else{'new'===n.state&&(n.state='gathering'),i.component=1,i.ufrag=n.getLocalParameters().usernameFragment;var d=l.writeCandidate(i);o.candidate=Object.assign(o.candidate,l.parseCandidate(d)),o.candidate.candidate=d,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var c=l.getMediaSections(r._localDescription.sdp);c[o.candidate.sdpMLineIndex]+=s?'a=end-of-candidates\r\n':'a='+o.candidate.candidate+'\r\n',r._localDescription.sdp=l.getDescription(r._localDescription.sdp)+c.join('');var p=r.transceivers.every(function(e){return e.iceGatherer&&'completed'===e.iceGatherer.state});'gathering'!==r.iceGatheringState&&(r.iceGatheringState='gathering',r._emitGatheringStateChange()),s||r._dispatchEvent('icecandidate',o),p&&(r._dispatchEvent('icecandidate',new Event('icecandidate')),r.iceGatheringState='complete',r._emitGatheringStateChange())}},e.setTimeout(function(){o.forEach(function(t){n.onlocalcandidate(t)})},0)}},m.prototype._createIceAndDtlsTransports=function(){var t=this,a=new e.RTCIceTransport(null);a.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var r=new e.RTCDtlsTransport(a);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,'state',{value:'failed',writable:!0}),t._updateConnectionState()},{iceTransport:a,dtlsTransport:r}},m.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var a=this.transceivers[e].iceTransport;a&&(delete a.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},m.prototype._transceive=function(e,a,r){var n=i(e.localCapabilities,e.remoteCapabilities);a&&e.rtpSender&&(n.encodings=e.sendEncodingParameters,n.rtcp={cname:l.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(n.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(n)),r&&e.rtpReceiver&&0<n.codecs.length&&('video'===e.kind&&e.recvEncodingParameters&&15019>t&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),n.encodings=e.recvEncodingParameters.length?e.recvEncodingParameters:[{}],n.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(n.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(n.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(n))},m.prototype.setLocalDescription=function(e){var t=this;if(-1===['offer','answer'].indexOf(e.type))return Promise.reject(c('TypeError','Unsupported type "'+e.type+'"'));if(!s('setLocalDescription',e.type,t.signalingState)||t._isClosed)return Promise.reject(c('InvalidStateError','Can not set local '+e.type+' in state '+t.signalingState));var a,r;if('offer'===e.type)a=l.splitSections(e.sdp),r=a.shift(),a.forEach(function(e,a){var r=l.parseRtpParameters(e);t.transceivers[a].localCapabilities=r}),t.transceivers.forEach(function(e,a){t._gather(e.mid,a)});else if('answer'===e.type){a=l.splitSections(t._remoteDescription.sdp),r=a.shift();var n=0<l.matchPrefix(r,'a=ice-lite').length;a.forEach(function(e,a){var o=t.transceivers[a],s=o.iceGatherer,d=o.iceTransport,c=o.dtlsTransport,p=o.localCapabilities,u=o.remoteCapabilities,m=l.isRejected(e)&&0===l.matchPrefix(e,'a=bundle-only').length;if(!m&&!o.rejected){var g=l.getIceParameters(e,r),v=l.getDtlsParameters(e,r);n&&(v.role='server'),t.usingBundle&&0!==a||(t._gather(o.mid,a),'new'===d.state&&d.start(s,g,n?'controlling':'controlled'),'new'===c.state&&c.start(v));var f=i(p,u);t._transceive(o,0<f.codecs.length,!1)}})}return t._localDescription={type:e.type,sdp:e.sdp},'offer'===e.type?t._updateSignalingState('have-local-offer'):t._updateSignalingState('stable'),Promise.resolve()},m.prototype.setRemoteDescription=function(r){var n=this;if(-1===['offer','answer'].indexOf(r.type))return Promise.reject(c('TypeError','Unsupported type "'+r.type+'"'));if(!s('setRemoteDescription',r.type,n.signalingState)||n._isClosed)return Promise.reject(c('InvalidStateError','Can not set remote '+r.type+' in state '+n.signalingState));var o={};n.remoteStreams.forEach(function(e){o[e.id]=e});var m=[],g=l.splitSections(r.sdp),v=g.shift(),f=0<l.matchPrefix(v,'a=ice-lite').length,S=0<l.matchPrefix(v,'a=group:BUNDLE ').length;n.usingBundle=S;var C=l.matchPrefix(v,'a=ice-options:')[0];return n.canTrickleIceCandidates=!!C&&0<=C.substr(14).split(' ').indexOf('trickle'),g.forEach(function(s,c){var u=l.splitLines(s),g=l.getKind(s),C=l.isRejected(s)&&0===l.matchPrefix(s,'a=bundle-only').length,h=u[0].substr(2).split(' ')[2],E=l.getDirection(s,v),R=l.parseMsid(s),b=l.getMid(s)||l.generateIdentifier();if(C||'application'===g&&('DTLS/SCTP'===h||'UDP/DTLS/SCTP'===h))return void(n.transceivers[c]={mid:b,kind:g,protocol:h,rejected:!0});!C&&n.transceivers[c]&&n.transceivers[c].rejected&&(n.transceivers[c]=n._createTransceiver(g,!0));var y=l.parseRtpParameters(s),T,I,N,A,O,P,D,_,M,w,U;C||(w=l.getIceParameters(s,v),U=l.getDtlsParameters(s,v),U.role='client'),D=l.parseRtpEncodingParameters(s);var L=l.parseRtcpParameters(s),F=0<l.matchPrefix(s,'a=end-of-candidates',v).length,k=l.matchPrefix(s,'a=candidate:').map(function(e){return l.parseCandidate(e)}).filter(function(e){return 1===e.component});if(('offer'===r.type||'answer'===r.type)&&!C&&S&&0<c&&n.transceivers[c]&&(n._disposeIceAndDtlsTransports(c),n.transceivers[c].iceGatherer=n.transceivers[0].iceGatherer,n.transceivers[c].iceTransport=n.transceivers[0].iceTransport,n.transceivers[c].dtlsTransport=n.transceivers[0].dtlsTransport,n.transceivers[c].rtpSender&&n.transceivers[c].rtpSender.setTransport(n.transceivers[0].dtlsTransport),n.transceivers[c].rtpReceiver&&n.transceivers[c].rtpReceiver.setTransport(n.transceivers[0].dtlsTransport)),'offer'===r.type&&!C){T=n.transceivers[c]||n._createTransceiver(g),T.mid=b,T.iceGatherer||(T.iceGatherer=n._createIceGatherer(c,S)),k.length&&'new'===T.iceTransport.state&&(F&&(!S||0===c)?T.iceTransport.setRemoteCandidates(k):k.forEach(function(e){d(T.iceTransport,e)})),_=e.RTCRtpReceiver.getCapabilities(g),15019>t&&(_.codecs=_.codecs.filter(function(e){return'rtx'!==e.name})),P=T.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var B=!1;if('sendrecv'!==E&&'sendonly'!==E)T.rtpReceiver&&T.rtpReceiver.track&&(T.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===T.rtpReceiver.track.id});t&&p(t,e)}),T.associatedRemoteMediaStreams=[]);else if(B=!T.rtpReceiver,O=T.rtpReceiver||new e.RTCRtpReceiver(T.dtlsTransport,g),B){var x;M=O.track,R&&'-'===R.stream||(R?(!o[R.stream]&&(o[R.stream]=new e.MediaStream,Object.defineProperty(o[R.stream],'id',{get:function(){return R.stream}})),Object.defineProperty(M,'id',{get:function(){return R.track}}),x=o[R.stream]):(!o.default&&(o.default=new e.MediaStream),x=o.default)),x&&(a(M,x),T.associatedRemoteMediaStreams.push(x)),m.push([M,O,x])}T.localCapabilities=_,T.remoteCapabilities=y,T.rtpReceiver=O,T.rtcpParameters=L,T.sendEncodingParameters=P,T.recvEncodingParameters=D,n._transceive(n.transceivers[c],!1,B)}else if('answer'===r.type&&!C){T=n.transceivers[c],I=T.iceGatherer,N=T.iceTransport,A=T.dtlsTransport,O=T.rtpReceiver,P=T.sendEncodingParameters,_=T.localCapabilities,n.transceivers[c].recvEncodingParameters=D,n.transceivers[c].remoteCapabilities=y,n.transceivers[c].rtcpParameters=L,k.length&&'new'===N.state&&((f||F)&&(!S||0===c)?N.setRemoteCandidates(k):k.forEach(function(e){d(T.iceTransport,e)})),S&&0!==c||('new'===N.state&&N.start(I,w,'controlling'),'new'===A.state&&A.start(U));var H=i(T.localCapabilities,T.remoteCapabilities),G=H.codecs.filter(function(e){return'rtx'===e.name.toLowerCase()}).length;!G&&T.sendEncodingParameters[0].rtx&&delete T.sendEncodingParameters[0].rtx,n._transceive(T,'sendrecv'===E||'recvonly'===E,'sendrecv'===E||'sendonly'===E),O&&('sendrecv'===E||'sendonly'===E)?(M=O.track,R?(!o[R.stream]&&(o[R.stream]=new e.MediaStream),a(M,o[R.stream]),m.push([M,O,o[R.stream]])):(!o.default&&(o.default=new e.MediaStream),a(M,o.default),m.push([M,O,o.default]))):delete T.rtpReceiver}}),void 0===n._dtlsRole&&(n._dtlsRole='offer'===r.type?'active':'passive'),n._remoteDescription={type:r.type,sdp:r.sdp},'offer'===r.type?n._updateSignalingState('have-remote-offer'):n._updateSignalingState('stable'),Object.keys(o).forEach(function(t){var a=o[t];if(a.getTracks().length){if(-1===n.remoteStreams.indexOf(a)){n.remoteStreams.push(a);var r=new Event('addstream');r.stream=a,e.setTimeout(function(){n._dispatchEvent('addstream',r)})}m.forEach(function(e){var t=e[0],r=e[1];a.id!==e[2].id||u(n,t,r,[a])})}}),m.forEach(function(e){e[2]||u(n,e[0],e[1],[])}),e.setTimeout(function(){n&&n.transceivers&&n.transceivers.forEach(function(e){e.iceTransport&&'new'===e.iceTransport.state&&0<e.iceTransport.getRemoteCandidates().length&&(console.warn('Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification'),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},m.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState('closed')},m.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event('signalingstatechange');this._dispatchEvent('signalingstatechange',t)},m.prototype._maybeFireNegotiationNeeded=function(){var t=this;'stable'!==this.signalingState||!0===this.needNegotiation||(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event('negotiationneeded');t._dispatchEvent('negotiationneeded',e)}},0))},m.prototype._updateIceConnectionState=function(){var e={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0},t;if(this.transceivers.forEach(function(t){t.iceTransport&&!t.rejected&&e[t.iceTransport.state]++}),t='new',0<e.failed?t='failed':0<e.checking?t='checking':0<e.disconnected?t='disconnected':0<e.new?t='new':0<e.connected?t='connected':0<e.completed&&(t='completed'),t!==this.iceConnectionState){this.iceConnectionState=t;var a=new Event('iceconnectionstatechange');this._dispatchEvent('iceconnectionstatechange',a)}},m.prototype._updateConnectionState=function(){var e={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0},t;if(this.transceivers.forEach(function(t){t.iceTransport&&t.dtlsTransport&&!t.rejected&&(e[t.iceTransport.state]++,e[t.dtlsTransport.state]++)}),e.connected+=e.completed,t='new',0<e.failed?t='failed':0<e.connecting?t='connecting':0<e.disconnected?t='disconnected':0<e.new?t='new':0<e.connected&&(t='connected'),t!==this.connectionState){this.connectionState=t;var a=new Event('connectionstatechange');this._dispatchEvent('connectionstatechange',a)}},m.prototype.createOffer=function(){var a=this;if(a._isClosed)return Promise.reject(c('InvalidStateError','Can not call createOffer after close'));var r=a.transceivers.filter(function(e){return'audio'===e.kind}).length,o=a.transceivers.filter(function(e){return'video'===e.kind}).length,i=arguments[0];if(i){if(i.mandatory||i.optional)throw new TypeError('Legacy mandatory/optional constraints not supported.');void 0!==i.offerToReceiveAudio&&(!0===i.offerToReceiveAudio?r=1:!1===i.offerToReceiveAudio?r=0:r=i.offerToReceiveAudio),void 0!==i.offerToReceiveVideo&&(!0===i.offerToReceiveVideo?o=1:!1===i.offerToReceiveVideo?o=0:o=i.offerToReceiveVideo)}for(a.transceivers.forEach(function(e){'audio'===e.kind?(r--,0>r&&(e.wantReceive=!1)):'video'===e.kind&&(o--,0>o&&(e.wantReceive=!1))});0<r||0<o;)0<r&&(a._createTransceiver('audio'),r--),0<o&&(a._createTransceiver('video'),o--);var s=l.writeSessionBoilerplate(a._sdpSessionId,a._sdpSessionVersion++);a.transceivers.forEach(function(r,n){var o=r.track,i=r.kind,s=r.mid||l.generateIdentifier();r.mid=s,r.iceGatherer||(r.iceGatherer=a._createIceGatherer(n,a.usingBundle));var d=e.RTCRtpSender.getCapabilities(i);15019>t&&(d.codecs=d.codecs.filter(function(e){return'rtx'!==e.name})),d.codecs.forEach(function(e){'H264'===e.name&&void 0===e.parameters['level-asymmetry-allowed']&&(e.parameters['level-asymmetry-allowed']='1'),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),d.headerExtensions.forEach(function(e){var t=r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[];t.forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var c=r.sendEncodingParameters||[{ssrc:1001*(2*n+1)}];o&&15019<=t&&'video'===i&&!c[0].rtx&&(c[0].rtx={ssrc:c[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new e.RTCRtpReceiver(r.dtlsTransport,i)),r.localCapabilities=d,r.sendEncodingParameters=c}),'max-compat'!==a._config.bundlePolicy&&(s+='a=group:BUNDLE '+a.transceivers.map(function(e){return e.mid}).join(' ')+'\r\n'),s+='a=ice-options:trickle\r\n',a.transceivers.forEach(function(e,t){s+=n(e,e.localCapabilities,'offer',e.stream,a._dtlsRole),s+='a=rtcp-rsize\r\n',e.iceGatherer&&'new'!==a.iceGatheringState&&(0===t||!a.usingBundle)&&(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,s+='a='+l.writeCandidate(e)+'\r\n'}),'completed'===e.iceGatherer.state&&(s+='a=end-of-candidates\r\n'))});var d=new e.RTCSessionDescription({type:'offer',sdp:s});return Promise.resolve(d)},m.prototype.createAnswer=function(){var a=this;if(a._isClosed)return Promise.reject(c('InvalidStateError','Can not call createAnswer after close'));if('have-remote-offer'!==a.signalingState&&'have-local-pranswer'!==a.signalingState)return Promise.reject(c('InvalidStateError','Can not call createAnswer in signalingState '+a.signalingState));var r=l.writeSessionBoilerplate(a._sdpSessionId,a._sdpSessionVersion++);a.usingBundle&&(r+='a=group:BUNDLE '+a.transceivers.map(function(e){return e.mid}).join(' ')+'\r\n'),r+='a=ice-options:trickle\r\n';var o=l.getMediaSections(a._remoteDescription.sdp).length;a.transceivers.forEach(function(e,s){if(!(s+1>o)){if(e.rejected)return'application'===e.kind?'DTLS/SCTP'===e.protocol?r+='m=application 0 DTLS/SCTP 5000\r\n':r+='m=application 0 '+e.protocol+' webrtc-datachannel\r\n':'audio'===e.kind?r+='m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n':'video'===e.kind&&(r+='m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n'),void(r+='c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:'+e.mid+'\r\n');if(e.stream){var d;'audio'===e.kind?d=e.stream.getAudioTracks()[0]:'video'===e.kind&&(d=e.stream.getVideoTracks()[0]),d&&15019<=t&&'video'===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1})}var c=i(e.localCapabilities,e.remoteCapabilities),l=c.codecs.filter(function(e){return'rtx'===e.name.toLowerCase()}).length;!l&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,r+=n(e,c,'answer',e.stream,a._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(r+='a=rtcp-rsize\r\n')}});var s=new e.RTCSessionDescription({type:'answer',sdp:r});return Promise.resolve(s)},m.prototype.addIceCandidate=function(e){var t=this,a;return e&&!(void 0!==e.sdpMLineIndex||e.sdpMid)?Promise.reject(new TypeError('sdpMLineIndex or sdpMid required')):new Promise(function(r,n){if(!t._remoteDescription)return n(c('InvalidStateError','Can not add ICE candidate without a remote description'));if(!e||''===e.candidate)for(var o=0;o<t.transceivers.length&&(t.transceivers[o].rejected||(t.transceivers[o].iceTransport.addRemoteCandidate({}),a=l.getMediaSections(t._remoteDescription.sdp),a[o]+='a=end-of-candidates\r\n',t._remoteDescription.sdp=l.getDescription(t._remoteDescription.sdp)+a.join(''),!t.usingBundle));o++);else{var s=e.sdpMLineIndex;if(e.sdpMid)for(var p=0;p<t.transceivers.length;p++)if(t.transceivers[p].mid===e.sdpMid){s=p;break}var i=t.transceivers[s];if(i){if(i.rejected)return r();var u=0<Object.keys(e.candidate).length?l.parseCandidate(e.candidate):{};if('tcp'===u.protocol&&(0===u.port||9===u.port))return r();if(u.component&&1!==u.component)return r();if((0===s||0<s&&i.iceTransport!==t.transceivers[0].iceTransport)&&!d(i.iceTransport,u))return n(c('OperationError','Can not add ICE candidate'));var m=e.candidate.trim();0===m.indexOf('a=')&&(m=m.substr(2)),a=l.getMediaSections(t._remoteDescription.sdp),a[s]+='a='+(u.type?m:'end-of-candidates')+'\r\n',t._remoteDescription.sdp=l.getDescription(t._remoteDescription.sdp)+a.join('')}else return n(c('OperationError','Can not add ICE candidate'))}r()})},m.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var a=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?a=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(a=e.rtpReceiver)}),!a)throw c('InvalidAccessError','Invalid selector.');return a.getStats()}var r=[];return this.transceivers.forEach(function(e){['rtpSender','rtpReceiver','iceGatherer','iceTransport','dtlsTransport'].forEach(function(t){e[t]&&r.push(e[t].getStats())})}),Promise.all(r).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})};['RTCRtpSender','RTCRtpReceiver','RTCIceGatherer','RTCIceTransport','RTCDtlsTransport'].forEach(function(t){var a=e[t];if(a&&a.prototype&&a.prototype.getStats){var n=a.prototype.getStats;a.prototype.getStats=function(){return n.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(a){e[a].type=r(e[a]),t.set(a,e[a])}),t})}}});var g=['createOffer','createAnswer'];return g.forEach(function(e){var t=m.prototype[e];m.prototype[e]=function(){var e=arguments;return'function'==typeof e[0]||'function'==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){'function'==typeof e[0]&&e[0].apply(null,[t])},function(t){'function'==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),g=['setLocalDescription','setRemoteDescription','addIceCandidate'],g.forEach(function(e){var t=m.prototype[e];m.prototype[e]=function(){var e=arguments;return'function'==typeof e[1]||'function'==typeof e[2]?t.apply(this,arguments).then(function(){'function'==typeof e[1]&&e[1].apply(null)},function(t){'function'==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),['getStats'].forEach(function(e){var t=m.prototype[e];m.prototype[e]=function(){var e=arguments;return'function'==typeof e[1]?t.apply(this,arguments).then(function(){'function'==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),m}},function(){},function(){window.sdkversion='1.52.5'},function(){window.app=angular.module('rainbow',['angular-jwt']),window.rainbowAdmin=angular.module('rainbowAdmin',[]),window.rainbow=angular.module('rainbow',['rainbowAdmin'])},function(e,t,a){a(6),a(7),a(8),a(9),a(10),a(11),a(12),a(13),a(14),a(15),a(16),a(17),a(18),a(19),a(20),a(21),a(22),a(23),a(24),a(25),a(26),a(27),a(28),a(29),a(30),a(31),a(32),a(33),a(34),a(35),a(36),a(37),a(38),a(39),a(40),a(41),a(42),a(43),a(44),a(45),a(46),a(47),a(48),a(49),a(50),a(51),a(52),a(53),a(54),a(55),a(56),a(57),a(58),a(59),a(60),a(61),a(62),a(63),a(64),a(65),a(66),a(67),a(68),a(69),a(70),a(71),a(72),a(73),a(74),a(75),a(76),a(77),a(78),a(79),a(80),a(81),a(82),a(83),a(84),a(85),a(86),a(87),a(88),a(89),a(90),a(91),a(92),a(93),a(94),a(95)},function(){angular.module('rainbow').factory('AuthSettings',[function(){'use strict';function e(e){if(0<e.length){if(1===e.length)var t=e[0];else var t=e.reduce(function(e,t){return'RAINBOW'===t.type&&'RAINBOW'!==e.type?(e.safetyUrl=t.url||t.loginUrl,e):(t.safetyUrl=e.url||e.loginUrl,t)});this.type=t.type,this.loginUrl=t.url||t.loginUrl,this.logoutUrl=t.logoutUrl,this.safetyUrl=t.safetyUrl}this.setParameter=function(e,t){switch(e){case'uid':this.userId=t();break;case'x-rainbow-app-auth':if('RAINBOW'!==this.type){var a=new URL(this.loginUrl),r=a.searchParams.get('challenge'),n=t(r);a.searchParams.append(e,n),this.loginUrl=a.href}break;default:}}}return e.createFromData=function(t){return new e(t)},e}])},function(){function e(e,t,a,r){this.name='RainbowError',this.message=e,this.details=t,this.detailsCode=a,this.detailsData=r,this.stack=new Error().stack}e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,window.RBError=e},function(){angular.module('rainbow').factory('Company',[function(){'use strict';function e(t){var a=this;e.attributes.forEach(function(e){angular.isDefined(t[e.name])?a[e.name]=t[e.name]:angular.isDefined(e.defaultValue)&&(a[e.name]=e.defaultValue)}),this.state=t.state?t.state:'USA'===t.country?'AL':'CAN'===t.country?'AB':null,this.logo=null,this.filterName=this.name.toLowerCase(),this.updateFromData=function(t){e.attributes.forEach(function(e){angular.isDefined(t[e.name])&&(a[e.name]=t[e.name])})},this.nameForLogs='',this.isActive=function(){return'active'===this.status},this.isInitializing=function(){return'initializing'===this.status},this.isInvited=function(){return'invited'===this.status},this.isFreemium=function(){return'freemium'===this.offerType},this.isPremium=function(){return'premium'===this.offerType}}return e.createFromData=function(t){return new e(t)},e.create=function(t,a){return new e({id:t,name:a})},e.prune=function(e,t){var a=Object.assign({},e);return delete a.dataLocation,a.isBP||(delete a.bpType,delete a.bpBusinessModel,delete a.bpApplicantNumber,delete a.bpCRDid,delete a.bpHasRightToSell,delete a.bpHasRightToConnect,delete a.bpIsContractAccepted),t&&(t.isSuperadmin()||t.isBPAdminFinance())||(delete a.bpType,delete a.adminHasRightToUpdateSubscriptions,delete a.adminAllowedUpdateSubscriptionsOps),''===a.economicActivityClassification&&delete a.economicActivityClassification,t&&(t.isSuperadmin()||null!==a.supportEmail&&''!==a.supportEmail)||delete a.supportEmail,t&&(t.isSuperadmin()||null!==a.privateDC&&''!==a.privateDC)||delete a.privateDC,a},e.StatusValues=['initializing','active','alerting','hold','terminated'],e.VisibilityValues=['private','organization','public'],e.VisibilityValuesWithoutOrg=['private','public'],e.SizeValues=['self-employed','1-10 employees','11-50 employees','51-200 employees','201-500 employees','501-1000 employees','1001-5000 employees','5001-10,000 employees','10,001+ employees'],e.OfferTypes=['freemium','premium'],e.BPTypes=['VAD','DR','IR'],e.BPTypeLabels={IR:'Indirect Reseller',VAD:'Value Added Distributor',DR:'Direct Reseller'},e.BPBusinessModels=['resell'],e.BPBusinessModelLabels={resell:'Resell',referral:'Referral'},e.adminAllowedUpdateSubscriptionsOperations=['all','increase_only'],e.EconomicActivityClassificationTypes={NONE:'notDefined-f',A:'agriculture',B:'mining',C:'manufacturing',D:'electricity',E:'water supply',F:'construction',G:'wholesale',H:'transportation',I:'accommodation',J:'information and communication',K:'financial',L:'real estate activities',M:'professional',N:'administrative',O:'public administration',P:'education',Q:'human health',R:'arts',S:'other service activities',T:'activities of households as employer',U:'activities of extraterritorial organisations and bodies'},e.PrivateDCValues=['HDS'],e.attributes=[{name:'id',defaultValue:void 0},{name:'name',defaultValue:''},{name:'companyContactId',defaultValue:void 0},{name:'adminEmail',defaultValue:''},{name:'supportEmail',defaultValue:void 0},{name:'status',defaultValue:'active'},{name:'economicActivityClassification',defaultValue:'NONE'},{name:'website',defaultValue:void 0},{name:'description',defaultValue:void 0},{name:'visibility',defaultValue:'private'},{name:'visibleBy',defaultValue:[]},{name:'organisationId',defaultValue:''},{name:'userSelfRegisterEnabled',defaultValue:!1},{name:'userSelfRegisterAllowedDomains',defaultValue:[]},{name:'offerType',defaultValue:'freemium'},{name:'country',defaultValue:void 0},{name:'state',defaultValue:null},{name:'size',defaultValue:void 0},{name:'slogan',defaultValue:void 0},{name:'isBP',defaultValue:!1},{name:'bpType',defaultValue:void 0},{name:'bpBusinessModel',defaultValue:void 0},{name:'bpApplicantNumber',defaultValue:void 0},{name:'bpCRDid',defaultValue:void 0},{name:'bpHasRightToSell',defaultValue:void 0},{name:'bpId',defaultValue:void 0},{name:'bpHasRightToConnect',defaultValue:void 0},{name:'adminHasRightToUpdateSubscriptions',defaultValue:!1},{name:'adminAllowedUpdateSubscriptionsOps',defaultValue:'all'},{name:'externalReference',defaultValue:void 0},{name:'externalReference2',defaultValue:void 0},{name:'lastAvatarUpdateDate',defaultValue:null},{name:'lastBannerUpdateDate',defaultValue:null},{name:'avatarShape',defaultValue:'circle'},{name:'catalogId',defaultValue:void 0},{name:'office365Tenant',defaultValue:void 0},{name:'isCentrex',defaultValue:void 0},{name:'tenantCallNumber',defaultValue:void 0},{name:'tenantName',defaultValue:void 0},{name:'numberUsers',defaultValue:void 0},{name:'giphyEnabled',defaultValue:!0},{name:'dataLocation',defaultValue:void 0},{name:'privateDC',defaultValue:void 0}],e.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.name){var e=this.name.replace(/[^\s](?=.{1,}$)/g,'*');this.nameForLogs=this.name.charAt(0)+e.substr(1)}return this.nameForLogs},e}]),angular.module('rainbow').filter('companyOfferFilter',[function(){'use strict';return function(e){return'freemium'===e?'Freemium':'premium'===e?'Premium':e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():e}}])},function(){angular.module('rainbow').factory('CompanyInvitation',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l,p,u,m){this.id=e,this.companyId=t,this.companyName=a,this.invitedUserId=r,this.invitedUserEmail=n,this.invitingAdminId=o,this.invitingAdminLoginEmail=i,this.invitationDate=s,this.lastNotificationDate=d,this.requestedNotificationLanguage=c,this.status=l,this.acceptationDate=p,this.declinationDate=u,this.invitedToBeCompanyAdmin=m}return e.createFromData=function(t){var a=new e(t.id,t.companyId,t.companyName,t.invitedUserId,t.invitedUserEmail,t.invitingAdminId,t.invitingAdminLoginEmail,t.invitationDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.declinationDate,t.invitedToBeCompanyAdmin);return a},e}])},function(){class e{}e.DELETED='deleted',e.UPLOADING='uploading',e.UPLOADED='uploaded',e.NOT_UPLOADED='not_uploaded',e.DOWNLOADING='downloading',e.UNKNOWN='unknown';class t{constructor(e,t){this.icon=e,this.style=t}}class a{constructor(e){e?(this.availableThumbnail=e.availableThumbnail,this.md5sum=e.md5sum,this.size=e.size,this.wantThumbnailDate=e.wantThumbnailDate):this.availableThumbnail=!1}isThumbnailAvailable(){return this.availableThumbnail}}class r{constructor(e=null,t=null,r=null,n=null,o=null,i=null,s=null,d=null,c=null,l=null,p=null,u=null,m=null,g){this.id=e,this.url=t,this.ownerId=r,this.fileName=n,this.extension=o,this.typeMIME=i,this.thumbnailPlaceholder=this.getThumbnailPlaceholderFromMimetype(i),this.size=s,this.registrationDate=d,this.uploadedDate=c,this.dateToSort=l,this.viewers=p,this.state=u,this.thumbnail=new a(m),this.fileToSend=void 0,this.previewBlob=void 0,this.orientation=g?g:void 0}isMicrosoftFile(){return['docx','doc','ppt','pptx','xls','xlsx'].some((e)=>e===this.extension)}isThumbnailPossible(){return this.isImage()||this.isPDF()}isPDF(){return'application/pdf'===this.typeMIME}isImage(){let e='image/';return this.typeMIME&&this.typeMIME.length>=e.length&&this.typeMIME.slice(0,e.length)===e}isAudioVideo(){return['avi','mpg','wma','mp3','wmv','mkv','mov','wav','ogg','mp4','aac'].some((e)=>e===this.extension)}isUploaded(){return this.state&&this.state===e.UPLOADED}isAlreadyFileViewer(e){return!!(this.ownerId&&this.ownerId===e)||!!this.viewers&&this.viewers.some((t)=>t.viewerId===e)}getDisplayName(){return this.fileName.replace(/\.[^/.]+$/,'')}getDisplayNameTruncated(){var e=this.fileName.replace(/\.[^/.]+$/,'');return[e.substring(0,e.length-4),e.slice(-4)]}getExtension(){return this.fileName.toUpperCase()===this.extension.toUpperCase()?'':'.'+this.extension}getThumbnailPlaceholderFromMimetype(e){return e?0===e.indexOf('image')?new t('icon_image','imageStyle'):'application/msword'===e||/^application\/vnd.openxmlformats-officedocument.wordprocessingml.*$/.test(e)||'application/vnd.oasis.opendocument.text'===e?new t('icon_doc','docStyle'):/^application\/vnd.ms-powerpoint.*$/.test(e)||/^application\/vnd.openxmlformats-officedocument.presentationml.*$/.test(e)||'application/vnd.oasis.opendocument.presentation'===e?new t('icon_ppt','pptStyle'):0===e.indexOf('application/vnd.ms-excel')||/^application\/vnd.openxmlformats-officedocument.spreadsheetml.*$/.test(e)?new t('icon_xls','xlsStyle'):'application/pdf'===e||'application/vnd.oasis.opendocument.spreadsheet'===e?new t('icon_pdf','pdfStyle'):0===e.indexOf('video/')||0===e.indexOf('audio/')?new t('icon_file-video','imageStyle'):new t('icon_filestandard','otherStyle'):new t('icon_filestandard','otherStyle')}releaseURL(){this.localURL=void 0}}angular.module('rainbow').factory('fileDescriptorFactory',[function(){return(e,t,a,n,o,i,s,d,c,l,p,u,m,g)=>new r(e,t,a,n,o,i,s,d,c,l,p,u,m,g)}])},function(){class e{}e.USER='user',e.ROOM='room';class t{constructor(e,t,a,r=null,n=null){this.contactService=r,this.channelService=n,this.viewerId=e,this.type=t,this.contact=a}get avatarSrc(){if('user'===this.type&&this.contact)this._avatarSrc=this.contact.avatar.src;else if('channel'===this.type&&this.channel)this._avatarSrc=this.channel.getAvatarSrc();else if(this._avatarSrc=null,'user'===this.type&&this.contactService.getContactByDBId(this.viewerId).then((e)=>{this.contact=e,this._avatarSrc=this.contact.avatar.src}),'channel'===this.type){let e=this.channelService.getChannelFromCache(this.viewerId,!1);e&&(this.channel=e,this._avatarSrc=this.channel.getAvatarSrc())}return this._avatarSrc}}angular.module('rainbow').factory('fileViewerFactory',[function(){return(e)=>{let a=[];for(let r of e)a.push(new t(r.viewerId,r.type,r.contact,r.contactService,r.channelService));return a}}]),angular.module('rainbow').factory('fileViewerElementFactory',[function(){return(e,a,r,n,o)=>new t(e,a,r,n,o)}])},function(){angular.module('rainbow').factory('CompanyRequest',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l){this.id=e,this.requestingUserId=t,this.requestingUserLoginEmail=a,this.requestedCompanyId=r,this.requestedCompanyName=n,this.status=o,this.requestingDate=i,this.requestedNotificationLanguage=s,this.lastNotificationDate=d,this.requestedToCompanyAdmin=c,this.requestedCompanyInvitationId=l}return e.createFromData=function(t){var a=new e(t.id,t.requestingUserId,t.requestingUserLoginEmail,t.requestedCompanyId,t.requestedCompanyName,t.status,t.requestingDate,t.requestedNotificationLanguage,t.lastNotificationDate,t.requestedToCompanyAdmin,t.requestedCompanyInvitationId);return a},e}])},function(){angular.module('rainbow').factory('CompanyBpLinkInvitation',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g){this.id=e,this.invitedCompanyId=t,this.invitedCompanyName=a,this.invitedToBeBpIr=r,this.invitingAdminId=n,this.invitingAdminLoginEmail=o,this.invitingCompanyId=i,this.invitingCompanyName=s,this.invitationDate=d,this.lastNotificationDate=c,this.requestedNotificationLanguage=l,this.status=p,this.acceptationDate=u,this.cancelationDate=m,this.declinationDate=g}return e.createFromData=function(t){var a=new e(t.id,t.invitedCompanyId,t.invitedCompanyName,t.invitedToBeBpIr,t.invitingAdminId,t.invitingAdminLoginEmail,t.invitingCompanyId,t.invitingCompanyName,t.invitationDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.cancelationDate,t.declinationDate);return a},e}])},function(){angular.module('rainbow').factory('CompanyBpLinkRequest',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g){this.id=e,this.requestingAdminId=t,this.requestingAdminLoginEmail=a,this.requestingCompanyId=r,this.requestingCompanyName=n,this.requestedCompanyId=o,this.requestedCompanyName=i,this.requestedToBeBpIr=s,this.requestDate=d,this.lastNotificationDate=c,this.requestedNotificationLanguage=l,this.status=p,this.acceptationDate=u,this.cancelationDate=m,this.declinationDate=g}return e.createFromData=function(t){var a=new e(t.id,t.requestingAdminId,t.requestingAdminLoginEmail,t.requestingCompanyId,t.requestingCompanyName,t.requestedCompanyId,t.requestedCompanyName,t.requestedToBeBpIr,t.requestDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.cancelationDate,t.declinationDate);return a},e}])},function(){angular.module('rainbow').factory('Conference',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l,p,u){this.companyId=e,this.id=t,this.mediaType=a,this.name=r,this.passCodes=n?n:[],this.scheduled=o,this.scheduledDuration=i,this.scheduledEndDate=s,this.scheduledStartDate=d,this.lastUpdateDate=c,this.scheduledTimezone=l,this.userId=p,this.confDialOutDisabled=u,this.updateFromData=function(e){this.companyId=e.companyId,this.id=e.id,this.mediaType=e.mediaType,this.name=e.name,this.passCodes=e.passCodes,this.scheduled=e.scheduled,this.scheduledDuration=e.scheduledDuration,this.scheduledEndDate=e.scheduledEndDate,this.scheduledStartDate=e.scheduledStartDate,this.lastUpdateDate=e.lastUpdateDate,this.scheduledTimezone=e.scheduledTimezone,this.userId=e.userId,this.confDialOutDisabled=e.confDialOutDisabled}}return e.createFromData=function(t){var a=new e(t.companyId,t.id,t.mediaType,t.name,t.passCodes,t.scheduled,t.scheduledDuration,t.scheduledEndDate,t.scheduledStartDate,t.lastUpdateDate,t.scheduledTimezone,t.userId,t.confDialOutDisabled);return a},e}])},function(){angular.module('rainbow').factory('ConferenceSession',['$log','ConferenceParticipant','contactService','$q',function(e,t,a,r){'use strict';function n(n,o,i,s){var d=this;d.id=n,d.participants=o,d.active=i,d.talkerActive=void 0,d.recordingStarted=void 0,d.talkers=void 0,d.isLeaderAlreadyConnected=!1,d.status=null,d.localStreams=[],d.sessions={},d.publishers=[],d.type=s,d.callId=null,d.hasLocalVideo=!1,d.jingleJid=null,d.localVideoSessionId=null,d.localSharingSessionId=null,d.haveJoined=!1,d.cleanupSessionData=function(){e.debug('[ConferenceSession] Cleanup for conferenceSession '+d.id),d.participants=[],d.talkerActive=void 0,d.recordingStarted=void 0,d.talkers=void 0,d.isLeaderAlreadyConnected=!1,d.localStreams=[],d.sessions={},d.publishers=[],d.hasLocalVideo=!1,d.metricsState='',d.recordingStarted=!1,d.status='ended',d.hasLocalSharing=!1,d.reversedVideos=!1,d.jingleJid=null,d.localVideoSessionId=null,d.localSharingSessionId=null,d.haveJoined=!1},d.updateFromData=function(e,t,a){d.id=e,d.participants=t,d.active=a},d.updateActiveState=function(e){d.active=e},d.updateStateFromData=function(e,t,a){d.active=e,d.talkerActive=t,d.recordingStarted=a},d.updateParticipants=function(a){return r(function(r){var n=!1;a||r(!1),d.participants||(d.participants=[]),0===a.length&&(d.participants=[]),a.forEach(function(a){if(a.participantId){e.debug('[conferenceSession] updateParticipants participantId='+a.participantId);var r=d.getParticipantById(a.participantId);r?(e.debug('[conferenceSession] updateParticipants update participantId='+a.participantId),r.updateFromData(a)):(e.debug('[conferenceSession] updateParticipants create participantId='+a.participantId),d.participants.push(t.createFromData(a)),n=!0)}}),r(n)})},d.removeParticipants=function(t){t&&t.forEach(function(t){var a=d.getParticipantIndexById(t);-1!==a&&(e.debug('[conferenceSession] removeParticipants remove participantId='+t),d.participants.splice(a,1))})},d.removePublisher=function(t){if(t){var a=d.getPublisherIndexById(t);-1!==a&&(e.debug('[conferenceSession] removePublisher remove participantId='+t),d.publishers.splice(a,1))}},d.updateTalkers=function(t){e.debug('[conferenceSession] updateTalkers talkers='+t),d.talkers=t},d.isActive=function(){return void 0!==d.active&&d.active},d.isTalkerActive=function(){return void 0!==d.talkerActive&&d.talkerActive},d.isRecordingStarted=function(){return void 0!==d.recordingStarted&&d.recordingStarted},d.getParticipants=function(){return d.participants},d.getConnectedParticipants=function(){return d.participants?d.participants.filter(function(e){return'disconnected'!==e.state}):void 0},d.getConnectedParticipantsExceptLeader=function(){return d.participants?d.participants.filter(function(e){return'disconnected'!==e.state&&'moderator'!==e.role}):void 0},d.getConnectedParticipantsExcept=function(e){return d.participants?d.participants.filter(function(t){return t.jid_im!==e&&'disconnected'!==t.state}):void 0},d.getLeaderParticipant=function(){return d.participants?d.participants.find(function(e){return'moderator'===e.role&&'disconnected'!==e.state}):void 0},d.getParticipantById=function(e){return d.participants?d.participants.find(function(t){return t.participantId===e}):void 0},d.getParticipantByJid=function(e){return d.participants?d.participants.find(function(t){return t.jid_im===e}):void 0},d.getConnectedParticipantByJid=function(e){return d.participants?d.participants.find(function(t){return t.jid_im===e&&'connected'===t.state}):void 0},d.getParticipantIndexById=function(e){return d.participants?d.participants.findIndex(function(t){return t.participantId===e}):-1},d.getPublisherIndexById=function(e){return d.publishers?d.publishers.findIndex(function(t){return t.participantId===e}):-1},d.isParticipantConnectedByJid=function(e){return void 0!==d.participants&&d.participants.some(function(t){return t.jid_im===e&&'connected'===t.state})},d.isParticipantRingingByJid=function(e){return void 0!==d.participants&&d.participants.some(function(t){return t.jid_im===e&&'ringing'===t.state})},d.isParticipantConnectedWithThisUAByJid=function(e){return d.haveJoined&&void 0!==d.participants&&d.participants.some(function(t){return t.jid_im===e&&'connected'===t.state})},d.getTalkers=function(){return d.talkers},d.setCallId=function(e){d.callId=e},d.getListOfRemoteVideoPublishers=function(){var e=[];if(d.publishers)for(var t=0;t<d.publishers.length;t++)'video'===d.publishers[t].mediaType&&d.publishers[t].jid_im!==a.userContact.jid&&e.push(d.publishers[t]);return e}}return n.createFromData=function(e,t,a,r){r||(r='pstnAudio');var o=new n(e,t,a,r);return o},n}])},function(){angular.module('rainbow').factory('ConferenceParticipant',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l){this.participantId=e,this.userId=t,this.jid_im=a,this.jid_tel=r,this.role=n,this.mute=o,this.held=i,this.confStartDate=s,this.startDate=d,this.phoneNumber=c,this.state=l,this.updateFromData=function(e){e.userId&&(this.userId=e.userId),this.jid_im=e.jid_im,e.jid_tel&&(this.jid_tel=e.jid_tel),this.role=e.participantRole,this.mute=e.mute,this.held=e.held,this.confStartDate=e.confStartDate,this.startDate=e.startDate,this.phoneNumber=e.phoneNumber,this.state=e.participantState}}return e.createFromData=function(t){var a=new e(t.participantId,t.userId,t.jid_im,t.jid_tel,t.participantRole,t.mute,t.held,t.confStartDate,t.startDate,t.phoneNumber,t.participantState);return a},e}])},function(){class e{constructor(e,t,a,r,n,o,i,s,d){this.id=e,this.providerUserId=t,this.providerCompanyId=a,this.confCompanyId=r,this.userId=n,this.companyId=o,this.firstName=i,this.lastName=s,this.providerType=d}}angular.module('rainbow').factory('conferenceUserFactory',function(){return(t)=>new e(t.id,t.providerUserId,t.providerCompanyId,t.confCompanyId,t.userId,t.companyId,t.firstName,t.lastName,t.providerType)})},function(){class e{constructor(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g){this.userRole='none',this.messageRetrieved=!1,this.messages=[],this.subscribed=!1,this.deleted=!1,this.invited=!1,this.type='SIMPLE',this.pageIndex=0,this.isLoading=!1,this.complete=!1,this.users=[],this.publishersRetreived=!1,this.name=e,this.id=t,this.visibility=a,this.topic=r,this.creatorId=n,this.companyId=o,this.creationDate=i,this.users_count=s,this.subscribers_count=g,this.category=u,this.mode=m,this.lastAvatarUpdateDate=d;let v=this.lastAvatarUpdateDate?'&ts='+new Date(this.lastAvatarUpdateDate).getTime():'';if(this.avatar=config.restServerUrl+'/api/channel-avatar/'+t+'?size=256'+v,void 0!==c&&(this.subscribed=c),void 0!==l&&(this.userRole=l),void 0!==p&&(this.invited=p),!this.mode)switch(this.visibility){case'company':this.mode='company_public';break;case'public':this.mode='all_public';break;case'private':this.mode='company_private';break;default:}}isNotMember(){return this.userRole='none'}isOwner(){return'owner'===this.userRole}isPublisher(){return this.subscribed&&('owner'===this.userRole||'publisher'===this.userRole)}isMember(){return'member'===this.userRole}getAvatarSrc(){return this.lastAvatarUpdateDate?this.avatar:'/resources/skins/rainbow/images/channels/default_channel_avatar.png'}static ChannelFactory(){return(t)=>new e(t.name,t.id,t.visibility,t.topic,t.creatorId,t.companyId,t.creationDate,t.users_count,t.lastAvatarUpdateDate,t.subscribed,t.type,t.invited,t.category,t.mode,t.subscribers_count)}}angular.module('rainbow').factory('Channel',e.ChannelFactory)},function(){class e{constructor(){this.body=void 0,this.date=void 0,this.isRoom=!1,this.isSent=!1,this.messageId=void 0}static SearchTextMsgResultFactory(){return()=>new e}}class t{constructor(e){this.room=null,this.contact=null,this.totalCount=-1,this.convRes=[],this.otherJid=e}getResultFromMsgId(e){for(let t of this.convRes)if(t.messageId===e)return t}addMsgItem(e){this.convRes.push(e)}isRoom(){return this.conversation?null!=this.conversation.room:null!==this.room}}class a{constructor(){this.searchedText='',this.results=[],this.queryIds=[],this.totalCount=0,this.searchCounter=0}isEmpty(){return 0===this.queryIds.length||0===Object.keys(this.results).length}searchCount(){this.searchCounter++}getAvailableCount(){let e=0;for(let t of this.results)e+=t.convRes.length;return e}getTotalCount(){return this.totalCount}clearAll(){this.queryIds=[],this.totalCount=0,this.clearMessagesResults()}clearMessagesResults(){this.results.splice(0,this.results.length)}isCurrentQuery(e){return-1<this.queryIds.indexOf(e)}getItemForConvId(e){for(let t of this.results)if(t.otherJid===e)return t}createNewResult(e){let a=this.getItemForConvId(e);return a||(a=new t(e),this.results.push(a)),a}addNewItemResult(e,a){let r=this.getItemForConvId(e);r||(r=new t(e),this.results.push(r));r.getResultFromMsgId(a.messageId)||r.addMsgItem(a)}splitText(e,t){var a='',r='',n='',o=this.cleanUpSpecialChars(e).toLowerCase(),i=this.cleanUpSpecialChars(t).toLowerCase(),s=o.indexOf(i);return 0<=s?(0<s&&(a=e.slice(0,s)),r=e.slice(s,s+t.length),e.length>t.length+s&&(n=e.slice(s+t.length,e.length))):a=e,[a,r,n]}cleanUpSpecialChars(e){return e=e.replace(/[]/g,'A'),e=e.replace(/[]/g,'a'),e=e.replace(/[]/g,'E'),e=e.replace(/[]/g,'e'),e=e.replace(/[]/g,'I'),e=e.replace(/[]/g,'i'),e=e.replace(/[]/g,'O'),e=e.replace(/[]/g,'o'),e=e.replace(/[]/g,'u'),e=e.replace(/[]/g,'c'),e}}angular.module('rainbow').factory('SearchTextConvResultsFactory',function(){return()=>new a}),angular.module('rainbow').factory('SearchTextMsgResultFactory',e.SearchTextMsgResultFactory)},function(){angular.module('rainbowAdmin').factory('Offer',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l,p){this.id=e,this.name=t,this.description=a,this.offerReference=r,this.profileId=n,this.canBeSold=!!o&&o,this.businessModel=i,this.isPrepaid=c,this.prepaidDuration=l,this.autoSubscribe=p,this.isDefault=s,this.isExclusive=d;var u=this.name.toLowerCase();u&&(-1===u.indexOf('enterprise')?-1===u.indexOf('business')?-1!==u.indexOf('conference')&&(u='conference'):u='business':u='enterprise'),this.logo='logo-offer-'+u+'.svg',this.isEnterprise=function(){return this.name.toLowerCase().startsWith('enterprise')},this.isBusiness=function(){return this.name.toLowerCase().startsWith('business')},this.isEssential=function(){return this.name.toLowerCase().startsWith('essential')},this.isUserLicense=function(){return this.isDefault||'nb_users'===this.businessModel||'usage'===this.businessModel},this.isFixedLicense=function(){return'flat_fee'===this.businessModel},this.isUserBasedLicense=function(){return'nb_users'===this.businessModel},this.isUsageBasedLicense=function(){return'usage'===this.businessModel}}return e.createFromData=function(t){return new e(t.id,t.name,t.description,t.offerReference,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration,t.autoSubscribe)},e.createFromSubscriptionData=function(t){return new e(t.offerId,t.offerName,void 0,t.offerReference,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,void 0)},e.createFromSubscriptionCountersData=function(t){return new e(t.offerId,t.offerName,void 0,t.offerReference,void 0,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration)},e.createFromProfileData=function(t){return new e(t.offerId,t.offerName,void 0,void 0,t.profileId,!1,void 0,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration)},e.createFromOperationLog=function(t){var a='delete'===t.operationType?t.previousData:t.newData;return new e(a.offerId,a.offerName,a.offerDescription,a.offerReference,a.profileId,a.canBeSold,a.businessModel,a.isDefault,a.isExclusive,a.isPrepaid,a.prepaidDuration)},e.offerComparator=function(e,t){var a=['Essential','Business','Enterprise','Conference'],r=a.findIndex(function(t){return e.name.startsWith(t)}),n=a.findIndex(function(e){return t.name.startsWith(e)});return r=-1===r?a.length:r,n=-1===n?a.length:n,r<n?-1:r>n?1:e.name>t.name?r===a.length?1:-1:e.name<t.name?r===a.length?-1:1:0},e.isExclusive=function(e){return e.isDefault||e.isExclusive},e.isOptional=function(t){return!e.isExclusive(t)},e.isEssential=function(e){return e.isDefault},e.isNotEssential=function(e){return!e.isDefault},e.isModelByNbUsers=function(e){return'nb_users'===e.businessModel},e.isPrepaid=function(e){return e.isPrepaid},e.isNotPrepaid=function(e){return!e.isPrepaid},e}])},function(){angular.module('rainbow').factory('Contact',['$q','$rootScope','$interval','$document','$translate','$sce','settingsService','Company','$log','randomString','xmppService','authService','utilService',function(e,t,a,r,n,o,s,i,d,c,l,p,u){'use strict';function m(e,a,r){var n=this;this.id=e,this.jid=e,this.fullJid=null,this.jidtel=null,this.dbId=null,this.login=null,this.temp=!1,this.status='unknown',this.telStatus='',this.imStatus='offline',this.imStatusStamp=[],this.resources={},this.loginEmail='',this.lastname='',this.firstname='',this.company=r,this.nickname='',this.title='',this.jobTitle='',this.country='',this.defaultAvatar=null,this._avatar=null,this._avatarLoading=!1,this.avatarSrc=null,this.timezone='',this.roles=null,this.confId='',this.phonePro='',this.phoneProCan='',this.phonePbx='',this.phoneInternalNumber='',this.pbxId='',this.mobilePro='',this.mobileProCan='',this.phonePerso='',this.phonePersoCan='',this.mobilePerso='',this.mobilePersoCan='',this.emailPro='',this.emailPerso='',this.oldImStatus=null,this.roster=!1,this.initialized=!1,this._displayName=a?a:e,this.name={value:this._displayName},this.initials='',this.message='',this.cellStyle='',this.ask='none',this.subscription='none',this.conversation=null,this.adminType=null,this.capabilities=null,this.groups=null,this.mobileResource=null,this.language=null,this.lastActivityDate=null,this.nameUpdatePrio=m.NameUpdatePrio.MAX_UPDATE_PRIO,this.isInDefaultCompany=!1,this.calendarState={},this.guest=!1,this.openInviteId=null,this.isVirtualTerm=!1,this.nameForLogs='',t.$on('$destroy',t.$on('ON_DISPLAY_ORDER_EVENT',function(){n.computeDisplayName()})),t.$on('$destroy',t.$on('ON_DISPLAY_ORDER_EVENT',function(){n.computeDisplayName()}))}return m.create=function(e,t,a,r,n){var o=new m(e,null,r);return t&&a&&(t=t.charAt(0).toUpperCase()+t.slice(1),a=a.charAt(0).toUpperCase()+a.slice(1),o.computeCompleteDisplayName(t,a)),o.login=n,o},m.createByPhoneNumber=function(e){var t=new m(null,e);return t.id=e,t},m.createBotContact=function(e,t,a){var r=new m(e),n=new Image;return n.src='/resources/skins/rainbow/images/emily.jpg',r.lastname=t,r.isBot=!0,r.computeDisplayName(),r.status='online',r.imStatus='online',r.subscription='both',r.avatar=n,r.dbId=a,r},m.updateContactToBot=function(e,t,a){var r=new Image;return r.src='/resources/skins/rainbow/images/emily.jpg',e.lastname=t,e.isBot=!0,e.computeDisplayName(),e.status='online',e.imStatus='online',e.subscription='both',e.avatar=r,e.dbId=a,e},m.AdminType={ORGANIZATION_ADMIN:'organization_admin',COMPANY_ADMIN:'company_admin',SITE_ADMIN:'site_admin',UNDEFINED:'undefined'},m.NameUpdatePrio={NO_UPDATE_PRIO:0,OUTLOOK_UPDATE_PRIO:1,SERVER_UPDATE_PRIO:2,MAX_UPDATE_PRIO:99},Object.defineProperty(m.prototype,'avatar',{set:function(e){this._avatar=e},get:function(){var e=this;if(e._avatar)return e._avatar;if(!e._avatarLoading&&e.avatarSrc){e._avatarLoading=!0;var r=new Image;r.onload=function(){var r=this;a(function(){e._avatar=r,e._avatarLoading=!1,d.log('[contact] Lazily load avatar for '+e.displayNameForLog()+' success'),t.$broadcast('ON_CONTACT_AVATAR_UPDATE',e.jid)},0,1,!0)},r.onerror=function(){d.warn('[contact] Lazily load avatar for '+e.displayNameForLog()+' failure : use text avatar'),e._avatar=e.defaultAvatar,e._avatarLoading=!1},r.src=e.avatarSrc}return e.defaultAvatar}}),Object.defineProperty(m.prototype,'displayName',{set:function(e){this._displayName=e,this.name.value=e,this.displayNameMD5=MD5.hexdigest(e)},get:function(){return this._displayName}}),Object.defineProperty(m.prototype,'lastActivityDate',{set:function(e){this._lastActivityDate=e,this.updateLastActivityMessage()},get:function(){return this._lastActivityDate}}),Object.defineProperty(m.prototype,'statusMessage',{get:function(){if((this._currentStatus!==this.status||this._currentLastActivityMessage!==this.lastActivityMessage||this._currentMessage!==this.message)&&(this._currentStatus=this.status,this._currentMessage=this.message,this._currentLastActivityMessage=this.lastActivityMessage,this._statusMessage='unknown'===this.status?this.company&&this.company.name?this.company.name:n.instant('unknown'):'offline'===this.status&&''===this.lastActivityMessage?n.instant('offlineFilter'):'away'===this.status&&''===this.lastActivityMessage?n.instant('shortAway'):n.instant(this.status,{offlineDate:this.lastActivityMessage}),this.message)){var e=n.instant(this.message);'('!==e.charAt(0)&&(e='('+e+')'),this._statusMessage+=' '+e}return this._statusMessage}}),Object.defineProperty(m.prototype,'lastActivityMessage',{get:function(){var e=this;if(!e._lastActivityMessage&&!e._lastActivityInProgress){e._lastActivityInProgress=!0;try{l.connection.lastactivity.query(e.jid,{onResponse:function(t){var a=1e3*$(t).find('query').attr('seconds'),r=new Date().getTime();e.lastActivityDate=new Date(r-a),e._lastActivityInProgress=!1}})}catch(t){d.error('[Contact] lastActivityDate getter accessor for contact '+e.jid_im+' -- failure : '+t),e._lastActivityInProgress=!1}return null}return this._lastActivityMessage}}),m.prototype.updateLastActivityMessage=function(){if(!this._lastActivityDate)this._lastActivityMessage='';else{var e=moment(this._lastActivityDate);this._lastActivityMessage=moment.locale().startsWith('de')?e.fromNow(!0).replace('Tage','Tagen'):e.fromNow(!0)}},m.prototype.getLastAvailableDate=function(){var e=null,t=this.imStatusStamp;return Object.keys(t).forEach(function(a){var r=t[a];e?e<r&&(e=r):e=r}),e},m.prototype.updateCalendarPresenceInfo=function(){var e=this.calendarState,t=null,a=null;e.iconId=null;var r=null;e.autoReplyOn?(e.iconId='icon_outofoffice',a='<div style=\'text-align:left\'>'+u.escapeHtml(e.autoReplyInfos.message).replace(/\n/g,'<br/>')+'</div>',t={meetingDate:e.autoReplyInfos.until,message:a},r=e.autoReplyInfos.until?e.autoReplyInfos.untilDate?'calendarAutoReply-date':'calendarAutoReply':'calendarAutoReplySimple'):('busy'===e.message?(e.iconId='icon_inameeting',r=e.untilDate?'calendar-busy-date':'calendar-busy'):'out_of_office'===e.message&&(e.iconId='icon_outofoffice',r=e.untilDate?'calendar-outofoffice-date':'calendar-outofoffice'),t={meetingDate:e.until}),r&&(e.tooltip=n.instant(r,{meetingDate:t.meetingDate}),t.message&&(t.message=t.message.replace(/<script>/g,''),e.tooltip=o.trustAsHtml(e.tooltip+' '+t.message)))},m.prototype.displayNameForLog=function(){return config&&config.debug?this.displayName:this.displayNameMD5},m.prototype.isMobileResource=function(e){return-1!==e.indexOf('mobile_android')||-1!==e.indexOf('mobile_ios')},m.prototype.calculateStatusFromResources=function(e){var t='offline',a='',r='',n='',o=this.fullJid,i=!1,s=config.webrtcWithMobiles;for(var d in this.resources)if(this.resources.hasOwnProperty(d)){if('dnd'===this.resources[d].show&&'phone'===this.resources[d].status){t='busy',a='audioPhone',i=!0,o=d;break}else if('xa'===this.resources[d].show||'dnd'===this.resources[d].show&&''===this.resources[d].status){var c=!1;this.resources[d].initStamp?r?this.resources[d].initStamp.getTime()>r.getTime()&&(r=this.resources[d].initStamp,c=!0):(r=this.resources[d].initStamp,c=!0):n?this.resources[d].stamp.getTime()>n.getTime()&&(n=this.resources[d].stamp,r=this.resources[d].stamp,c=!0):(n=this.resources[d].stamp,r=this.resources[d].stamp,c=!0),c&&(t=this.resources[d].show,a=this.resources[d].status)}else'xa'!==t&&('dnd'!==t||'dnd'===t&&''!==a)&&'dnd'===this.resources[d].show&&''!==this.resources[d].status?('presentation'===this.resources[d].status?(t=this.resources[d].show,a='presentation'):(t='busy',a=this.resources[d].status),o=d,i=!0):e&&'online'===this.resources[d].show&&'mode=auto'===this.resources[d].status&&d===this.fullJid?'busy'!==t&&'dnd'!==t&&'presentation'!==a&&(t='online',a='',this.resources[d].status='',this.isMobileResource(d)?t='online-mobile':i=!0):'online'===this.resources[d].show&&'xa'!==t&&'dnd'!==t&&'busy'!==t?(a='','online-mobile'!==t&&(t='online'),this.resources[d].status='',this.isMobileResource(d)?t='online-mobile':(o=d,i=!0),s&&(o=d)):'away'===this.resources[d].show&&'offline'===t&&(t='away',a='',o=d);'mode=auto'===this.resources[d].status&&(this.resources[d].status='')}for(var d in this.resources)this.resources.hasOwnProperty(d)&&'mode=auto'===this.resources[d].status&&(this.resources[d].status='');return e||this.fullJid||(this.fullJid=o),'online-mobile'===t&&i?(t='online',a=''):'online-mobile'===t&&!e&&!s&&(this.fullJid=null,a=''),{presence:t,message:a}},m.prototype.hasAdminRights=function(){return this.isSuperadmin()||this.isAdmin()||this.isBPAdmin()},m.prototype.isSuperadmin=function(){return 0<=this.roles.indexOf('superadmin')},m.prototype.isCPaaSGuest=function(){return 0<=this.roles.indexOf('guest')},m.prototype.isGuest=function(){return this.guestMode},m.prototype.isAdmin=function(){return!!(0<=this.roles.indexOf('admin'))&&(!this.isOrganizationAdmin()||!this.isBPAdmin())},m.prototype.isOrganizationAdmin=function(){return 0<=this.roles.indexOf('admin')&&this.adminType===m.AdminType.ORGANIZATION_ADMIN},m.prototype.isCompanyAdmin=function(){return 0<=this.roles.indexOf('admin')&&this.adminType===m.AdminType.COMPANY_ADMIN},m.prototype.isSiteAdmin=function(){return 0<=this.roles.indexOf('admin')&&this.adminType===m.AdminType.SITE_ADMIN},m.prototype.getAdminType=function(){return 0<=this.roles.indexOf('admin')?this.adminType:m.AdminType.UNDEFINED},m.prototype.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},m.prototype.isBPAdminOperations=function(){return 0<=this.roles.indexOf('bp_admin')},m.prototype.isBPAdminFinance=function(){return 0<=this.roles.indexOf('bp_finance')},m.prototype.updateIMStatus=function(e,a){if(this.imStatusStamp[e.jid]&&this.imStatusStamp[e.jid]>e.stamp)return void d.info('[Contact] Ignore obsolete presence message for contact '+this.jid);d.info('[Contact] updateIMStatus '+JSON.stringify(e)),this.imStatusStamp[e.jid]=e.stamp,e.status&&(this.imStatus=e.status);var r=e.message?e.message:'';if('offline'===this.imStatus)this.fullJid===e.jid&&(this.fullJid=null),delete this.resources[e.jid],delete this.imStatusStamp[e.jid],0===this.resources.length&&(this.message='');else{this.resources[e.jid]?(this.resources[e.jid].show=this.imStatus,this.resources[e.jid].status=r,this.resources[e.jid].stamp=e.stamp):this.resources[e.jid]={show:this.imStatus,status:r,initStamp:e.stamp,stamp:e.stamp},d.info('[Contact] updateIMStatus user resources after update '+JSON.stringify(this.resources)),this.isMobileResource(e.jid)||a||(this.fullJid=e.jid);var n=config.webrtcWithMobiles;!a&&n&&(this.fullJid=e.jid)}if(this.updateRichStatus(a),a&&this.isMobileResource(e.jid)&&('offline'!==e.status&&null===this.mobileResource&&(this.mobileResource=e.jid,d.info('[Contact] updateIMStatus: post event ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT'),t.$broadcast('ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT','started')),'offline'===e.status)){var o=null;for(var i in this.resources)if(this.resources.hasOwnProperty(i)&&this.isMobileResource(i)){o=i;break}this.mobileResource=o,null===this.mobileResource&&t.$broadcast('ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT','stopped')}},m.prototype.updateTelephonyStatus=function(e,t){this.telStatus=e,this.updateRichStatus(t)},m.prototype.updatePresenceStatus=function(e){this.status=e},m.prototype.updateRichStatus=function(e){if('EVT_SERVICE_INITIATED'===this.telStatus||'EVT_ESTABLISHED'===this.telStatus)this.status='busy',this.message='audioPhone';else if('subscribe'===this.ask)this.status='wait';else if('none'===this.subscription||'from'===this.subscription)this.status='unknown';else{var a=this.calculateStatusFromResources(e);'xa'===a.presence&&(''!==a.message||e?'away'===a.message&&(a.presence='away',a.message=''):a.presence='offline'),this.status=a.presence,this.message=a.message,e?d.info('[Contact] updateRichStatus MY PRESENCE : '+a.presence+' || message : '+a.message):d.info('[Contact] updateRichStatus presence : '+a.presence+' || message : '+a.message),'offline'!==this.status&&(this.lastActivityDate=null)}e&&t.$broadcast('ON_UPDATE_MYCONTACT_EVENT'),t.$broadcast('ON_UPDATE_CONTACT_RICH_STATUS_EVENT',this)},m.prototype.updateFromUserData=function(e){this.dbId=e.id,this.loginEmail=e.loginEmail,this.firstname=e.firstName,this.lastname=e.lastName,this.nickname=e.nickName?e.nickName:'',this.title=e.title?e.title:'',this.jobTitle=e.jobTitle?e.jobTitle:'',this.organisationId=e.organisationId,this.siteId=e.siteId,this.country=e.country?e.country:'FRA',this.timezone=e.timezone,this.roles=e.roles,this.adminType=e.adminType,this.isBot=!1,this.isTerminated=e.isTerminated,this.isInDefaultCompany=e.isInDefaultCompany,this.lastAvatarUpdateDate=e.lastAvatarUpdateDate,this.initialized=e.isInitialized,this.guestMode=!!e.guestMode&&e.guestMode,this.openInviteId=e.openInviteId?e.openInviteId:this.openInviteId,e.jid_im&&(this.id=e.jid_im,this.jid=e.jid_im,this.jidtel=e.jid_tel),this.company&&this.company.id===e.companyId||(this.company=i.create(e.companyId,e.companyName)),this.phonePro=this.phoneProCan='',this.phonePbx='',this.phoneInternalNumber='',this.pbxId='',this.mobilePro=this.mobileProCan='',this.phonePerso=this.phonePersoCan='',this.mobilePerso=this.mobilePersoCan='',this.voicemailNumber='',this.hasPhoneNumber=!1;var t=this;e.emails&&(t.emailPerso='',e.emails.forEach(function(e){switch(e.type){case'work':t.emailPro=e.email;break;case'home':t.emailPerso=e.email;break;default:}})),e.phoneNumbers&&(e.phoneNumbers.forEach(function(e){var a=e.number,r=e.numberE164,n=e.deviceType;switch(t.hasPhoneNumber=!0,e.type){case'work':'landline'===n&&(t.phonePro=a,t.phoneProCan=r,e.isFromSystem&&(t.phonePbx=e.shortNumber,e.internalNumber&&(t.phoneInternalNumber=e.internalNumber,('Remote Extension'===e.deviceName||'Any Device'===e.deviceName)&&(t.isVirtualTerm=!0)),t.pbxId=e.pbxId,t.voicemailNumber=e.voiceMailNumber)),'mobile'===n&&(t.mobilePro=a,t.mobileProCan=r);break;case'home':'landline'===n&&(t.phonePerso=a,t.phonePersoCan=r),'mobile'===n&&(t.mobilePerso=a,t.mobilePersoCan=r);break;default:}}),this.phoneNumbersInitialized=!0),this.computeDisplayName()},m.prototype.updateName=function(e,t){this.firstname=e,this.lastname=t,this.computeDisplayName(),this.getAvatar()},m.prototype.getNameUpdatePrio=function(){return this.nameUpdatePrio},m.prototype.setNameUpdatePrio=function(e){switch(e){case m.NameUpdatePrio.NO_UPDATE_PRIO:case m.NameUpdatePrio.OUTLOOK_UPDATE_PRIO:case m.NameUpdatePrio.SERVER_UPDATE_PRIO:case m.NameUpdatePrio.MAX_UPDATE_PRIO:this.nameUpdatePrio=e;break;default:}},m.prototype.containsEmail=function(e){var t=e.toLowerCase();return!!(this.loginEmail&&this.loginEmail.toLowerCase()===t)||!!(this.emailPro&&this.emailPro.toLowerCase()===t)||!!(this.emailPerso&&this.emailPerso.toLowerCase()===t)},m.prototype.computeDisplayName=function(){var e=this.firstname?this.firstname.charAt(0).toUpperCase()+this.firstname.slice(1):null,t=this.lastname?this.lastname.charAt(0).toUpperCase()+this.lastname.slice(1):null,a=this.nickname?this.nickname.charAt(0).toUpperCase()+this.nickname.slice(1):null;t&&e?this.computeCompleteDisplayName(e,t):t&&!e?(this.displayName=t,this.initials=t.charAt(0)):a?(this.displayName=a,this.initials=a.charAt(0)):this.loginEmail?(this.displayName=this.loginEmail,this.initials=this.loginEmail.substring(0,2).toUpperCase()):(this.displayName='Anonymous',this.initials='A')},m.prototype.computeCompleteDisplayName=function(e,t){var a='',r='';1!==t.length&&2!==e.length?'FL'===s.getSetting('displayOrder')?(a=e+' '+t,r=e.charAt(0)+t.charAt(0)):(a=t+' '+e,r=t.charAt(0)+e.charAt(0)):(a='FL'===s.getSetting('displayOrder')?e+' '+t:t+' '+e,r=e.charAt(0)+e.charAt(1)),this.displayName=a,this.initials=r;for(var n=this.displayName.toUpperCase(),o=0,d=0;d<n.length;d++)o+=n.charCodeAt(d);this.colorIndex=o%12,this.color=m.textAvatarColor[this.colorIndex]},m.prototype.getAvatarInBase64=function(){var t=this,a=this;return e(function(e){try{if(t&&t.avatar&&t.avatar.src||e(),t.avatar.src&&!t.avatar.src.startsWith('data:image/png')){var n=new Image,o=r[0].createElement('canvas');o.width=120,o.height=120;var i=o.getContext('2d');i.rect(0,0,120,120),i.fillStyle=a.color,i.fill(),n.onload=function(){i.drawImage(this,0,0,120,120);var t=o.toDataURL('image/png');e(t)},n.src=t.avatar.src}else e(t.avatar.src)}catch(t){d.warn('[contactService] getAvatarInBase64 error '+t),e()}})},m.prototype.getAvatar=function(a,r){var n=this;if(n.dbId&&n.lastAvatarUpdateDate){var o=config.webservices.protocol+'://'+config.webservices.currentServer;t.cdn&&(o=t.cdnServer);var i=o+'/api/avatar/'+n.dbId+'?size='+(a?a:256);i+='&update='+MD5.hexdigest(n.lastAvatarUpdateDate),n.avatarSrc=i}return p.fromSDK?(n.createTextAvatarImage(),e.when()):e(function(e){n.createTextAvatarImage(),(r||!n.lastAvatarUpdateDate)&&(n.avatar=null),e(n)})},m.prototype.createTextAvatarImage=function(){var e=this,t=new Image,a=r[0].createElement('canvas');a.width=t.width=225,a.height=t.height=225;var n=a.getContext('2d');n.rect(0,0,225,225),n.fillStyle=this.color,n.fill(),n.font='bold 100px Helvetica',n.textAlign='center',n.fillStyle='white',n.fillText(this.initials,110,150),t.src=a.toDataURL('image/png'),e.defaultAvatar=t},m.prototype.getGroups=function(){return this.groups},m.prototype.setGroups=function(e){this.groups=e},m.prototype.getOpenInviteId=function(){return this.openInviteId},m.prototype.setOpenInviteId=function(e){this.openInviteId=e},m.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.displayName){var e=this.displayName.replace(/[^\s](?=.{1,}$)/g,'*');this.nameForLogs=this.displayName.charAt(0)+e.substr(1)}return this.nameForLogs},m.textAvatarColor=['#ff4500','#d38700','#348833','#007356','#00b2a9','#00b0e5','#0085ca','#6639b7','#91278a','#cf0072','#a50034','#d20000'],m}])},function(){function e(t){return e='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&'function'==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?'symbol':typeof e},e(t)}angular.module('rainbow').factory('Conversation',['$log','$rootScope','$interval','$filter','contactService','xmppService','Message','uuid4','utilService','fileStorageService','fileServerService','$q','fileViewerFactory','Call','roomService','pstnConferenceService',function(t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f){'use strict';function S(e){this.id=e,this.dbId=null,this.type=null,this.owner=null,this.contact=null,this.room=null,this.capabilities=null,this.avatar=null,this.presenceStatus=null,this.name=function(){return{}},this.filterName='',this.missedCounter=0,this.missedCalls=0,this.messages=[],this.participantStatuses={},this.draft='',this.status=S.Status.ACTIVE,this.historyIndex=-1,this.historyMessages=[],this.historyDefered=null,this.historyComplete=!1,this.lastModification=void 0,this.creationDate=new Date,this.lastMessageText='',this.lastMessageSender='',this.pip=!0,this.videoCall={status:g.Status.UNKNOWN},this.audioCall=null,this.pstnConferenceSession=null,this.webConferenceSession=null,this.isMutedAudio=!1,this.isMutedVideo=!1,this.infoVisible=!1,this.muted=!1,this.isFavorite=!1,this.lastEditableMsg=null,this.cacheMessages=[]}S.ChatstatesNS='http://jabber.org/protocol/chatstates',S.ReceiptNS='urn:xmpp:receipts',S.Type={ONE_TO_ONE:0,ROOM:1,BOT:2},S.EventType={NEW:0,IM:1,CAPABILITIES:2,FILE:3},S.Status={ACTIVE:{key:0,value:'active'},INACTIVE:{key:1,value:'inactive'},COMPOSING:{key:2,value:'composing'},PAUSED:{key:3,value:'paused'}},S.createOneToOneConversation=function(e){t.info('[Conversation] Create one to one conversation ('+e.id+')');var a=new S(e.id);return a.contact=e,e.conversation=a,e.isBot?(a.avatar='',a.type=S.Type.BOT):(a.avatar=e.avatar?e.avatar.src:null,a.type=S.Type.ONE_TO_ONE),a.name=e.name,e.displayName&&(a.filterName=c.removeDiacritis(e.displayName.toLowerCase())),a},S.createRoomConversation=function(e){t.info('[Conversation] Create room conversation ('+e.jid+')');var a=new S(e.jid);return a.type=S.Type.ROOM,a.room=e,a.filterName=c.removeDiacritis(e.name.toLowerCase()),a.infoVisible=!0,a};var C=function(){return d.generate()}(),h=0;return S.getUniqueMessageId=function(){var e='web_'+C+h;return h++,e},S.stringToStatus=function(e){return'composing'===e?S.Status.COMPOSING:'paused'===e?S.Status.PAUSED:S.Status.ACTIVE},S.prototype.reset=function(){this.messages=[],this.historyIndex=-1,this.historyMessages=[],this.historyComplete=!1,this.currentHistoryId=null,this.lastMessageText=null,this.chatRenderer&&this.chatRenderer.removeAllMessages()},S.prototype.isInCall=function(){return this.pstnConferenceSession?this.pstnConferenceSession.isParticipantConnectedByJid(o.userContact.jid):this.webConferenceSession?this.webConferenceSession.isParticipantConnectedByJid(o.userContact.jid):this.videoCall&&this.videoCall.status&&'Unknown'!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&'Unknown'!==this.audioCall.status.value&&'incommingCall'!==this.audioCall.status.value&&'queued'!==this.audioCall.status.value},S.prototype.isNotInCall=function(){return(!this.videoCall||!this.videoCall.status||'Unknown'===this.videoCall.status.value)&&(!this.audioCall||!this.audioCall.status||'Unknown'===this.audioCall.status.value)&&('busy'!==o.userContact.status||''===o.userContact.message)},S.prototype.isActive=function(){return this.videoCall&&this.videoCall.status&&'active'===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&'active'===this.audioCall.status.value},S.prototype.isHeld=function(){return this.videoCall&&this.videoCall.status&&'held'===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&'held'===this.audioCall.status.value},S.prototype.getMessageById=function(e,t){if(t){var a=this.cacheMessages.find(function(t){return t.id===e});if(a)return a}return this.messages.find(function(t){return t.id===e})},S.prototype.getMessageByIdInHistory=function(e){return this.historyMessages.find(function(t){return t.id===e})},S.prototype.sendChatMessage=function(e,t){var a=n('emojiShortToUnicode')(e),d=null,c=this,l=S.getUniqueMessageId();if(this.type===S.Type.ONE_TO_ONE){var p=this.contact.jid;d=$msg({to:p,type:'chat',id:l,"xml:lang":o.currentLanguage}).c('body',{"xml:lang":o.currentLanguage}).t(a).up().c('request',{xmlns:S.ReceiptNS}).up().c('active',{xmlns:S.ChatstatesNS}).up()}else d=$msg({to:this.room.jid,type:'groupchat',id:l}).c('body',{"xml:lang":o.currentLanguage}).t(a).up().c('request',{xmlns:S.ReceiptNS}).up().c('active',{xmlns:S.ChatstatesNS}).up();var u=null,m=null;t&&(d=d.c('answeredMsg',{stamp:t.date.getTime()}).t(t.id).up(),u=t.id,m=t.date);var g=null;return(g=this.addChatMessage(o.userContact,new Date,a,l,!0,null,null,u,m),!g)?null:(g.serverAckTimer=r(function(){g.receiptStatus=s.ReceiptStatus.ERROR,c.updateMessage(g)},1e4),i.send(d),g)},S.prototype.sendCorrectedChatMessage=function(e,a,d){t.info('[Conversation] >sendCorrectedChatMessage: origMsgId='+d),this.sendAckReadMessages();var c=n('emojiShortToUnicode')(a),l=null,p=this,u=S.getUniqueMessageId();if(t.info('[Conversation] >sendCorrectedChatMessage: messageToSendID='+u),this.type===S.Type.ONE_TO_ONE){var m=this.contact.jid;l=$msg({to:m,type:'chat',id:u,"xml:lang":o.currentLanguage}).c('body',{"xml:lang":o.currentLanguage}).t(c).up().c('replace',{id:d,xmlns:'urn:xmpp:message-correct:0'}).up().c('request',{xmlns:S.ReceiptNS}).up().c('active',{xmlns:S.ChatstatesNS}).up()}else l=$msg({to:this.room.jid,type:'groupchat',id:u}).c('body',{"xml:lang":o.currentLanguage}).t(c).up().c('replace',{id:d,xmlns:'urn:xmpp:message-correct:0'}).t(c).up().c('request',{xmlns:S.ReceiptNS}).up().c('active',{xmlns:S.ChatstatesNS}).up();return e?(e.serverAckTimer=r(function(){e.receiptStatus=s.ReceiptStatus.ERROR,p.updateMessage(e)},1e4),e.addReplaceMsg(u,a),i.send(l),u):null},S.prototype.sendIsTypingState=function(e){var t=null,a=S.getUniqueMessageId(),r=e?'composing':'active';if(this.type===S.Type.ONE_TO_ONE){var n=this.contact.jid;t=$msg({to:n,type:'chat',id:a,"xml:lang":o.currentLanguage}).c(r,{xmlns:S.ChatstatesNS}).up()}else t=$msg({to:this.room.jid,type:'groupchat',id:a}).c(r,{xmlns:S.ChatstatesNS}).up();i.send(t)},S.prototype.sendRecordingMessage=function(e){var t=n('emojiShortToUnicode')(e),a=null,d=this,c=S.getUniqueMessageId();if(this.type===S.Type.ONE_TO_ONE){var l=this.contact.jid;a=$msg({to:l,type:'chat',id:c,"xml:lang":o.currentLanguage}).c('body',{"xml:lang":o.currentLanguage}).up().c('recording',{xmlns:'jabber:iq:recordingP2P'}).t(t).up().c('request',{xmlns:S.ReceiptNS}).up().c('active',{xmlns:S.ChatstatesNS}).up()}var e=null;return(e=this.addRecordingMessage(o.userContact,new Date,t,c),!e)?null:(e.serverAckTimer=r(function(){e.receiptStatus=s.ReceiptStatus.ERROR,d.updateMessage(e)},1e4),i.send(a),e)},S.prototype.sendExistingFSMessage=function(e,t){if(!e)return null;var a=n('emojiShortToUnicode')(e.data),r=null,d=this,c=e.id;if(this.type===S.Type.ONE_TO_ONE){var l=this.contact.jid;r=$msg({to:l,type:'chat',id:c,"xml:lang":o.currentLanguage}).c('body',{"xml:lang":o.currentLanguage}).t(a).up().c('request',{xmlns:S.ReceiptNS}).up().c('active',{xmlns:S.ChatstatesNS}).up()}else r=$msg({to:this.room.jid,type:'groupchat',id:c}).c('body',{"xml:lang":o.currentLanguage}).t(a).up().c('request',{xmlns:S.ReceiptNS}).up().c('active',{xmlns:S.ChatstatesNS}).up();var p=config.restServerUrl+'/api/rainbow/fileserver/v1.0/files/'+t.id;return r.c('x',{xmlns:'jabber:x:oob'}).c('url',{},p).c('mime',{},t.typeMIME).c('filename',{},t.fileName).c('size',{},t.size).up().c('store',{xmlns:'urn:xmpp:hints'}),e.fileId=t.id,e.setReceiptStatus(s.ReceiptStatus.SENT),d.updateMessage(e),i.send(r),e},S.prototype.sendAckReceivedMessage=function(e){if(!(e.receiptStatus>=s.ReceiptStatus.UNREAD)){t.info('[Conversation] '+this.id+' send received ack for message '+e.id);var a=this.type===S.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,r=o.userContact.jid,n=$msg({to:a,from:r,type:'chat'}).c('received',{xmlns:S.ReceiptNS,event:'received',entity:'client',id:e.id});this.type!==S.Type.ONE_TO_ONE&&(n=$msg({to:a,from:r,type:'groupchat'}).c('received',{xmlns:S.ReceiptNS,event:'received',entity:'client',type:'muc',id:e.id})),i.send(n),e.setReceiptStatus(s.ReceiptStatus.UNREAD)}},S.prototype.sendAckReadMessage=function(e){if(e.receiptStatus!==s.ReceiptStatus.READ){t.info('[Conversation] '+this.id+' send read ack for message '+e.id);var a=this.type===S.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,r=o.userContact.jid,n=$msg({to:a,from:r,type:'chat'}).c('received',{xmlns:S.ReceiptNS,event:'read',entity:'client',id:e.id});this.type!==S.Type.ONE_TO_ONE&&(n=$msg({to:a,from:r,type:'groupchat'}).c('received',{xmlns:S.ReceiptNS,event:'read',entity:'client',type:'muc',id:e.id})),i.send(n),e.setReceiptStatus(s.ReceiptStatus.READ)}},S.prototype.sendAckReadMessages=function(){t.info('[Conversation] '+this.id+' sendAckReadMessages');var e=!1,a=this;return this.messages.forEach(function(t){(t.receiptStatus===s.ReceiptStatus.SENT||t.receiptStatus===s.ReceiptStatus.UNREAD)&&(t.side===s.Side.LEFT||t.side===s.Side.ADMIN)&&(a.sendAckReadMessage(t),e=!0)}),e},S.prototype.sendFSMessage=function(r,n){t.debug('[conversation] >sendFSMessage');var o=u.defer(),i=this,d=r.name.split('.').pop(),c=r.type,g=[],v='object'===e(n)?n:void 0,f;return g=this.type===S.Type.ONE_TO_ONE?m([{viewerId:this.contact.dbId,type:'user'}]):m([{viewerId:this.room.dbId,type:'room'}]),l.createFileDescriptor(r.name,d,r.size,g).then(function(e){return f=e,e.fileToSend=r,e.isImage()&&r.preview&&(e.previewBlob=r.preview),v||(v=i.addFSMessage(e.id,c,n,'uploading')),v.fileId=e.id,v.fileName=e.fileName,e.state='uploading',a.$broadcast('ON_FILE_TRANSFER_EVENT',{fileDesc:e,cancelable:!0}),p.uploadAFileByChunk(e,r,v,null).then(function(){return t.debug('uploadAFileByChunk success'),u.resolve(e)},function(e){t.debug('uploadAFileByChunk error'),l.deleteFileDescriptor(f.id);var r=e.translatedMessage?e.translatedMessage:'Unable to share file';return a.$broadcast('ON_SHOW_INFO_MESSAGE',{type:'error',messageKey:r}),f.state='uploadError',v.receiptStatus=s.ReceiptStatus.ERROR,v.fileErrorMsg=r,i.updateMessage(v),u.reject(e)})}).then(function(e){e.state='uploaded',e.chunkPerformed=0,e.chunkTotalNumber=0,a.$broadcast('ON_FILE_TRANSFER_EVENT',{fileDesc:e}),i.sendExistingFSMessage(v,e),o.resolve(v)},function(e){t.debug('createFileDescriptor error'),o.reject(e)}),o.promise},S.prototype.sendEFSMessage=function(e,t){var r=this,n=e.extension,o='',i=null,d=this.addFSMessage(e.id,n,t,e.state);return this.type===S.Type.ONE_TO_ONE?(o='user',i=this.contact.dbId):(o='room',i=this.room.dbId),l.addFileViewer(e.id,i,o).then(function(){r.sendExistingFSMessage(d,e)}).catch(function(e){var t=e.translatedMessage?e.translatedMessage:'Unable to share file';a.$broadcast('ON_SHOW_INFO_MESSAGE',{type:'error',messageKey:t}),d.receiptStatus=s.ReceiptStatus.ERROR,r.updateMessage(d)}),d},S.prototype.addAdminBubbleMessage=function(e,a,r,n){var o=this.getMessageById(n);if(o)return t.info('[Conversation] '+this.id+' add addAdminBubbleMessage message ('+n+') already exists.'),null;t.info('[Conversation] '+this.id+' add addAdminBubbleMessage from '+e.jid+' : '+r);var i=s.Side.ADMIN,d=s.create(n,a,e,i,r+'MsgRoom',!1);return d.setReceiptStatus(s.ReceiptStatus.SENT),this.addMessage(d)},S.prototype.addFTMessage=function(e,a,r,n){t.info('[Conversation] '+this.id+' add FT message from '+e.jid+' : '+r.message);var i=o.isUserContact(e)?'R':'L',d=s.createFTMessage(n,a,e,i,r.message,!1,r);return this.addMessage(d)},S.prototype.addFSMessage=function(e,a,r,i){t.info('[Conversation] '+this.id+' add FS message from me');var d=S.getUniqueMessageId(),c=n('emojiShortToUnicode')(r),l=new Date;t.info('[Conversation] '+this.id+' add FILE SHARING message from me');var p=s.createFileSharingMessage(d,l,o.userContact,'R',c,i,e);return p.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS),this.addMessage(p)},S.prototype.addChatMessage=function(e,a,r,n,i,d,c,l,p){var u=this.getMessageById(n);if(u)return t.info('[Conversation] '+this.id+' add CHAT message ('+n+') already exists.'),null;t.info('[Conversation] '+this.id+' add CHAT message ('+n+') from '+e.jid);var m=o.isUserContact(e)?'R':'L',g=s.create(n,a,e,m,r,!1,d,c,l,p);return i?g.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS):g.setReceiptStatus(s.ReceiptStatus.SENT),this.addMessage(g)},S.prototype.addRecordingMessage=function(e,t,a,r){var n=s.createRecordingAdminMessage(r,t,e,'ADMIN',a);return this.addMessage(n)},S.prototype.addFileMessage=function(e,a,r,n){t.info('[Conversation] '+this.id+' add FILE message from '+e.jid+' : '+r);var i=o.isUserContact(e)?'R':'L',d=s.createFileMessage(n,a,e,i,r,!1);return this.addMessage(d)},S.prototype.addFileSharingMessage=function(e,a,r,n,i,d){t.info('[Conversation] '+this.id+' add FILE SHARING message from '+e.jid+' : '+r);var c=o.isUserContact(e)?'R':'L',l=s.createFileSharingMessage(n,a,e,c,r,!1,i,d);return this.addMessage(l)},S.prototype.addConferenceMessage=function(e,a,r,n){if('reminder'===n.type){var i=v.getRoomByJid(n.roomjid),d=f.conferenceSessions[i.getPstnConfEndpointId()];if(d&&d.isActive()&&d.isParticipantConnectedByJid(o.userContact.jid))return}t.info('[Conversation] '+this.id+' add CONFERENCE message from '+e.jid);var c=s.createConferenceMessage(r,a,e,'ADMIN',!1,n);return this.addMessage(c)},S.prototype.addWebRTCMessage=function(e,a,r,n){var i=this.getMessageById(n);if(i)return t.info('[Conversation] '+this.id+' add addWebRTCMessage message ('+n+') already exists.'),null;t.info('[Conversation] '+this.id+' add WebRTC message from '+e.jid+' : '+r);var d=o.isUserContact(e)?s.Side.RIGHT:s.Side.LEFT,c=s.createWebRTCMessage(n,a,e,d,r,!1);return this.addMessage(c)},S.prototype.updateMessage=function(e){this.chatRenderer&&this.chatRenderer.updateMessage(e,this.room)},S.prototype.addMessage=function(e){if(this.messages.find(function(t){return t.id===e.id}))return t.info('[Conversation] '+this.id+' try to add an already stored message with id '+e.id),e;if(e.side===s.Side.LEFT)e.type===s.Type.WEBRTC&&(this.missedCalls+=1),this.setStatusMessage(e.from,S.Status.ACTIVE);else{var i=this.lastEditableMsg;this.lastEditableMsg=e,this.updateMessage(i)}if(this.messages.push(e),this.chatRenderer&&(this.chatRenderer.appendMessages([e],this.room),this.contact&&this.contact._lastActivityDate)){var d=Math.abs(new Date-this.contact._lastActivityDate)/1e3/3600/24;if(this.contact.roster&&'offline'===this.contact.status&&14<=d){var c=this.chatRenderer;c.displayInfoMessage(n('translate')('offlineSendMail'),n('translate')('warningOfflineSendMail'),function(e,t){e?(c.sendingInfoMessage(n('translate')('sendingMail')),o.notifyImByEmail(t).then(function(){c.displayInfoMessage(n('translate')('sendMailSuccess')),r(function(){c.hideInfoMessage()},3e3,1)}).catch(function(e){c.displayErrorMessage(e),r(function(){c.hideInfoMessage()},5e3,1)})):c.hideInfoMessage()})}}return this.lastModification=new Date,this.lastMessageText=e.data,a.$broadcast('ON_CONVERSATION_UPDATED_EVENT',this.id),e},S.prototype.addMessageInHistoryMessages=function(e){if(e&&(this.historyMessages.push(e),e.side===s.Side.RIGHT&&(!this.lastEditableMsg||e.date.getTime()>this.lastEditableMsg.date.getTime()))){var t=this.lastEditableMsg;this.lastEditableMsg=e,this.updateMessage(t)}},S.prototype.addMessageInCacheMessages=function(e){e&&this.cacheMessages.push(e)},S.prototype.removeMessage=function(e){var t=this.messages.lastIndexOf(e);-1!==t&&this.messages.splice(t,1)},S.prototype.sendChatStatus=function(e){if((t.info('[Conversation] '+this.id+' setStatus '+e.value),this.status!==e)&&(this.status=e,e!==S.Status.IDLE)){var a=null,r='';this.type===S.Type.ONE_TO_ONE?(r=this.contact.jid,a=$msg({to:r,type:'chat'}).c(e.value,{xmlns:S.ChatstatesNS})):(r=this.room.jid,a=$msg({to:r,type:'groupchat'}).c(e.value,{xmlns:S.ChatstatesNS}));try{i.connection.send(a)}catch(e){t.error('[Conversation] sendChatStatus error '+e)}}},S.prototype.setStatusMessage=function(e,a){t.info('[Conversation] '+this.id+' add status message from '+e.jid+' : '+a.value),this.participantStatuses[e.jid]=a,this.chatRenderer&&this.chatRenderer.updateStatuses&&this.chatRenderer.updateStatuses()},S.prototype.sendInvitation=function(e){try{var a=e.jid,r={xmlns:'jabber:x:conference',jid:this.id},n=$msg({from:i.connection.jid,to:a}).c('x',r);i.connection.send(n)}catch(e){t.error('[Conversation] sendInvitation error '+e)}},S.prototype.ackReadAllMessages=function(){var e=this;this.messages.forEach(function(t){(t.receiptStatus===s.ReceiptStatus.SENT||t.receiptStatus===s.ReceiptStatus.UNREAD)&&(t.setReceiptStatus(s.ReceiptStatus.READ),e.chatRenderer&&e.chatRenderer.updateMessage(t,e.room))})},S}])},function(){angular.module('rainbow').factory('Message',['$log','$filter','$interval','ReplaceMsg','roomService',function(e,t,a,r,n){'use strict';function o(e,t,a,r,n,i,s,d,c,l,p,u,m){this.id=e,this.index=null,this.type=t,this.date=a,this.from=r,this.side=n,this.data=i,this.status=s,this.receiptStatus=o.ReceiptStatus.NONE,this.serverAckTimer=null,this.fileId=d,this.fileName=p,this.isMarkdown=c,this.subject=l,this.answeredMsgId=u,this.answeredMsgDate=m,this.showCorrectedMessages=!1,this.replaceMsgs=[]}return o.Type={CHAT:{key:0,value:'Chat'},FILE:{key:1,value:'File'},FS:{key:2,value:'FileSharing'},FT:{key:3,value:'FileTransfert'},WEBRTC:{key:4,value:'WebRTC CAll'},RECORDING:{key:5,value:'Recording'}},o.ReceiptStatus={NONE:0,ERROR:1,IN_PROGRESS:2,SENT:3,UNREAD:4,READ:5},o.Side={LEFT:'L',RIGHT:'R',ADMIN:'ADMIN'},o.ReceiptStatusText=['none','ko','inProgress','sent','received','read'],o.create=function(e,a,r,n,i,s,d,c,l,p){var u=t('emojiUnicodeToShort')(i);return new o(e,o.Type.CHAT,a,r,n,u,s,null,d,c,null,l,p)},o.createFileSharingMessage=function(e,a,r,n,i,s,d,c){var l=t('emojiUnicodeToShort')(i);return new o(e,o.Type.FS,a,r,n,l,s,d,null,null,c)},o.createConferenceMessage=function(e,a,r,i,s,d){var c=n.getRoomByJid(d.roomjid),l='';switch(d.type){case'invite':l=t('translate')('headerConferenceMessage',{sender:r._displayName,firstname:r.firstname,bubblename:c.name});break;case'reminder':l=c&&c.owner?t('translate')('conferenceReminderMessageforOwner',{sender:r._displayName}):t('translate')('conferenceReminderMessage',{sender:r._displayName});break;default:l=t('translate')('headerConferenceMessage',{sender:r._displayName,firstname:r.firstname,bubblename:c.name});}c.desc&&(l+='<br>'+t('translate')('conferenceSuject')+c.desc);var p=l;return new o(e,o.Type.CHAT,a,r,i,p,s)},o.createFileMessage=function(e,t,a,r,n,i){return new o(e,o.Type.FILE,t,a,r,n,i)},o.createWebRTCMessage=function(e,t,a,r,n,i){return new o(e,o.Type.WEBRTC,t,a,r,n,i)},o.createFTMessage=function(e,t,a,r,n,i,s){var d=new o(e,o.Type.FT,t,a,r,n,i);return d.fileTransfert=s,d},o.createBubbleAdminMessage=function(e,t,a,r){var n=o.Side.ADMIN,i=o.create(e,t,a,n,r+'MsgRoom',!1);return i},o.createRecordingAdminMessage=function(e,t,a,r,n){var i=r+'Recording';n&&(i+=n);var s=o.Side.ADMIN,d=new o(e,o.Type.RECORDING,t,a,s,i,!1);return d},o.prototype.addReplaceMsg=function(e,t){var a=r.create(e,t);this.replaceMsgs.push(a)},o.prototype.isTextModified=function(){return 0<this.replaceMsgs.length},o.prototype.getLastTextModified=function(){return 0<this.replaceMsgs.length?this.replaceMsgs[this.replaceMsgs.length-1].body:this.data},o.prototype.setReceiptStatus=function(t){return this.serverAckTimer&&t>o.ReceiptStatus.IN_PROGRESS&&(a.cancel(this.serverAckTimer),this.serverAckTimer=null),t>this.receiptStatus&&(this.receiptStatus=t,e.info('[Message] '+this.id+' : '+o.ReceiptStatusText[t])),this},o}])},function(){angular.module('rainbow').factory('Room',[function(){'use strict';function e(t,a,r,n,o,i,s,d,c,l){this.dbId=t,this.jid=a,this.name=r,this.nameForLogs='',this.desc=n,this.type=e.Type.PRIVATE,this.users=[],this.history=s||e.History.NONE,this.customData=d||{},this.ownerContact=null,this.organizers=[],this.members=[],this.avatarContacts=[],this.owner=!1,this.isModerator=!1,this.confEndpoints=i?i:[],this.conference=void 0===c?null:c,this.status='none',this.creationDate=o,this.initPresPromise=null,this.avatar=l,this.guestEmails=[],e.prototype.toString=function(){return'Room '+this.dbId+' '+this.name+' '+this.jid},e.prototype.updateAvatarInfo=function(){var e=[],t=this.users.slice();if(!this.avatar){t.sort(function(e,t){return new Date(e.date)-new Date(t.date)});for(var a=0;a<t.length;a++){var r=t[a].contact,n=t[a].status;if(r.dbId!==this.ownerContact.dbId&&(('accepted'===n||'invited'===n)&&e.push(r),2===e.length))break}this.avatarContacts=e}},e.prototype.isUserOwner=function(e){return!!e&&this.ownerContact.jid===e.jid},e.prototype.isUserModerator=function(e){var t=this.getOrganizerFromContactJid(e.jid);return void 0!==t},e.prototype.isUserStatusAccepted=function(e){var t=this.getUserByJid(e.jid);return void 0!==t&&'accepted'===t.status},e.prototype.isUserStillBelongToRoom=function(e){var t=this.getUserByJid(e);return!(t&&('unsubscribed'===t.status||'deleted'===t.status))},e.prototype.getOrganizerFromContactJid=function(e){var t;return this.organizers.forEach(function(a){a.contact.jid===e&&(t=a)}),t},e.prototype.getUserByJid=function(e){for(var t=0;t<this.users.length;t++)if(e===this.users[t].contact.jid)return this.users[t];return null},e.prototype.getPstnConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if('pstnAudio'===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.getSFUConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if('webrtc'===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.getSFUSharingConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if('webrtcSharingOnly'===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.isMeetingRoom=function(){return this.conference&&'pstnAudio'===this.conference.mediaType},e.prototype.isWebConferenceRoom=function(){return this.conference&&'pstnAudio'!==this.conference.mediaType&&this.getSFUConfEndpointId()},e.prototype.isMeetingOrWebConferenceRoom=function(){return this.isMeetingRoom()||this.getSFUConfEndpointId()},e.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.name){var e=this.name.replace(/[^\s](?=.{1,}$)/g,'*');this.nameForLogs=this.name.charAt(0)+e.substr(1)}return this.nameForLogs}}return e.Type={PRIVATE:0,PUBLIC:1},e.Privilege={USER:'user',MODERATOR:'moderator',GUEST:'guest'},e.History={ALL:'all',NONE:'none'},e.create=function(t,a,r,n,o,i,s,d,c,l){var p=new e(t,a,r,n,o,i,s,d,c,l);return p},e}])},function(){angular.module('rainbow').factory('Call',['$log',function(e){'use strict';function t(t,a,r,n){this.status=t,this.id=a,this.conversationId=null,this.connectionId=null,this.type=r,this.isVm=!1,this.contact=n,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.avatars=n&&n.avatar?[this.contact.avatar.src]:[],this.subject=void 0,this.currentCalled={contactPhoneNumber:'',contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid='',this.mediaPillarCall=null,this.isSecondary=!1,this.relevant=!0,this.relevantEquipmentId='unknown',e.debug('[CALL] createCall : '+this)}return t.Status={UNKNOWN:{key:0,value:'Unknown'},DIALING:{key:1,value:'dialing'},QUEUED_INCOMMING:{key:2,value:'queuedIncomming'},QUEUED_OUTGOING:{key:10,value:'queuedOutGoing'},RINGING_INCOMMING:{key:3,value:'incommingCall'},RINGING_OUTGOING:{key:4,value:'ringingOutgoing'},ACTIVE:{key:5,value:'active'},HOLD:{key:6,value:'held'},PUT_ON_HOLD:{key:7,value:'putOnHold'},RELEASING:{key:8,value:'releasing'},ANSWERING:{key:9,value:'answering'},CONNECTING:{key:12,value:'connecting'},ERROR:{key:11,value:'error'}},t.Type={WEBRTC:{key:1,value:'Video'},PHONE:{key:2,value:'Phone'}},t.Media={AUDIO:1,VIDEO:2,PHONE:4,SHARING:8},t.create=function(e,a,r,n){return new t(e,a,r,n)},t.prototype.setCallId=function(t){this.id=t,e.debug('[CALL] setId : '+this)},t.prototype.isInConversationWithMobile=function(){return!!this.fullJid&&(-1!==this.fullJid.indexOf('mobile_android')||-1!==this.fullJid.indexOf('mobile_ios'))},t.prototype.setConversationId=function(t){this.conversationId=t,e.debug('[CALL] setConversationId : '+this)},t.prototype.setConnectionId=function(a){this.connectionId=a,this.id=t.getIdFromConnectionId(a),e.debug('[CALL] setConnectionId : '+this)},t.prototype.setStatus=function(t){this.status=t,e.debug('[CALL] setStatus : '+this)},t.prototype.setType=function(t){this.type=t,e.debug('[CALL] setType : '+this)},t.prototype.setIsVm=function(t){this.isVm=t,e.debug('[CALL] setVm : '+this)},t.prototype.setContact=function(t){this.contact=t,this.avatars=[this.contact.avatar.src],e.debug('[CALL] setContact : '+t)},t.prototype.setParticipants=function(t){this.participants=t,this.avatars=[];var a=this;this.participants.forEach(function(e){a.avatars.push(e.avatar.src)}),e.debug('[CALL] setParticipants : '+t.join())},t.prototype.setSubject=function(e){this.subject=e},t.prototype.getCurrentCalled=function(){return this.currentCalled},t.prototype.setCurrentCalled=function(t){t?this.contact&&this.contact.id?(this.currentCalled.contactPhoneNumber=t.contactPhoneNumber&&''!==t.contactPhoneNumber?t.contactPhoneNumber:'',this.currentCalled.contact=t.contact?t.contact:null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null,e.debug('[Call] setCurrentCalled contactPhoneNumber : '+t.contactPhoneNumber),e.debug('[Call] setCurrentCalled call '+this.id+' contactPhoneNumber = '+t.contactPhoneNumber)):(this.currentCalled.contactPhoneNumber='',this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=t.participantsPhoneNumbers&&0<t.participantsPhoneNumbers.length?t.participantsPhoneNumbers:null,this.currentCalled.participants=t.participants&&0<t.participants.length?t.participants:null,this.currentCalled.participantsPhoneNumbers&&0<this.currentCalled.participantsPhoneNumbers.length&&(e.debug('[Call] setCurrentCalled participantsPhoneNumbers : '+t.participantsPhoneNumbers.join()),e.debug('[Call] setCurrentCalled '+this.id+' participantsPhoneNumbers : '+t.participantsPhoneNumbers.join()))):(this.currentCalled.contactPhoneNumber='',this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null)},t.prototype.setCurrentCalledContactNumber=function(t){e.debug('[Call] setCurrentCalledContactNumber call '+this.id+' phoneNumber = '+t),this.currentCalled.contactPhoneNumber=t},t.prototype.setRelevantEquipmentId=function(e){this.relevantEquipmentId=e},t.getIdFromConnectionId=function(e){return e},t.getCallIdFromConnectionId=function(e){return e?e.split('#')[0]:null},t.getDeviceIdFromConnectionId=function(e){return e?e.split('#')[1]:null},t.prototype.getMediaPillarCall=function(){return this.mediaPillarCall},t.prototype.setMediaPillarCall=function(e){this.mediaPillarCall=e?e:null},t.prototype.isMediaPillarCall=function(){return null!==this.mediaPillarCall},t.prototype.toString=function(){return'(type:'+this.type.value+', id:'+this.id+', status:'+this.status.value+(this.vm?'(voicemail))':')')},t.prototype.isInCallWithMediaPillar=function(){return this.fullJid&&-1!==this.fullJid.indexOf('mp_')},t}])},function(){(function(){'use strict';angular.module('rainbow').factory('RBNotification',['$log','$rootScope','$notification','$filter','notify',function(e,t,a,r,n){function o(t){e.info('[RBNotification] Create notification'),this.icon=t.icon,this.displayName=t.displayName,this.message=t.body,this.type=t.type,this.tag=t.tag,this.title=t.title,this.tooltip=t.tooltip,this.delay=t.delay?t.delay:i,this.focusAction=t.focusAction,this.sound=null,this.answerAudioButton=null,this.answerVideoButton=null,this.answerSharingButton=null,this.answerAudioButtonDisabled=null,this.answerClick=!1,this.declineButton=null,this.declineClick=!1,this.answerWithTemplateIMClick=!1,this.answerWithIMButton=null,this.bottomRightButton=null,this.handler=null,this.ascope=null,this.isSent=!1}var i=8e5,s=this;return o.notifs=[],o.create=function(e){var t=o.notifs[e.id];return t?(t.update(e),t):(t=new o(e),o.notifs[e.id]=t,t)},o.hide=function(a){e.info('[RBNotification] Hide notification');var r=o.notifs[a];r&&r.handler.close(),delete o.notifs[a],t.$broadcast('NOTIFICATION_HIDE_EVENT',this)},o.createNotificationListener=function(e){t.$on('$destroy',t.$on('NOTIFICATION_SHOW_EVENT',function(t,a){a.display(e)}))},o.prototype.update=function(t){e.info('[RBNotification] >update'),this.icon=t.icon,this.displayName=t.displayName,this.message=t.body,this.type=t.type,this.tag=t.tag,this.delay=t.delay?t.delay:i,this.focusAction=t.focusAction},o.prototype.send=function(){this.isSent||(this.isSent=!0,t.$broadcast('NOTIFICATION_SHOW_EVENT',this))},o.prototype.addAnswerAudioButton=function(e){this.answerAudioButton=e},o.prototype.addAnswerVideoButton=function(e){this.answerVideoButton=e},o.prototype.addAnswerSharingButton=function(e){this.answerSharingButton=e},o.prototype.addAnswerAudioButtonDisabled=function(e){this.answerAudioButtonDisabled=e},o.prototype.addDeclineButton=function(e){this.declineButton=e},o.prototype.addAnswerWithIMButton=function(e){this.answerWithIMButton=e},o.prototype.addBottomRightButton=function(e){this.bottomRightButton=e},o.prototype.display=function(e){if(!t.appVisible){var o=a(this.displayName,{tag:this.tag,body:this.message,icon:this.icon,delay:4e3});this.focusAction&&o.$on('click',this.focusAction)}s.answerClick=!1,s.declineClick=!1,s.answerWithTemplateIMClick=!1;var i=null;this.ascope||(this.ascope=e.$new(!0),this.ascope.notification=this,this.ascope.showIMTemplates=!1,this.ascope.answerAudioButtonClick=function(e){s.answerClick||(e.answerAudioButton.action(),s.answerClick=!0)},this.ascope.answerVideoButtonClick=function(e){s.answerClick||(e.answerVideoButton.action(),s.answerClick=!0)},this.ascope.answerSharingButtonClick=function(e){s.answerClick||(e.answerSharingButton.action(),s.answerClick=!0)},this.ascope.declineButtonClick=function(e){s.declineClick||(e.declineButton.action(),s.declineClick=!0)},this.ascope.answerWithIMButtonClick=function(e){if(e.ascope.showIMTemplates)e.ascope.showIMTemplates=!1,e.ascope.templatesIM=[];else{i=e;var t=[];e.answerWithIMButton&&Array.isArray(e.answerWithIMButton.choice)&&e.answerWithIMButton.choice.forEach(function(e){t.push(e)}),e.ascope.templatesIM=t,e.ascope.showIMTemplates=!0}},this.ascope.addBottomRightButtonClick=function(e){e.bottomRightButton.action()},this.ascope.answerWithTemplateIM=function(e){if(!s.answerWithTemplateIMClick){if(i){var t='';i.answerWithIMButton.label!==e.label&&(t=r('translate')(e.label)),i.answerWithIMButton.action(t)}s.answerWithTemplateIMClick=!0}}),this.handler||(this.handler=n({container:document.getElementById('leftArea'),position:'left',templateUrl:'notificationCallTemplate.html',message:this.title,duration:this.delay,startTop:80,scope:this.ascope}))},o}])})()},function(){angular.module('rainbow').factory('CallLog',[function(){'use strict';function e(t,a,r,n,o,i,s,d,c,l){this.id=t,this.contact=a,this.state=r,this.duration=n,this.direction=d,this.callSubject=c,this.isLatestCall=l,o='unknown'===o||'audio'===o||'webrtc'===o?e.Type.WEBRTC:'telephone'===o?e.Type.TELEPHONE:e.Type.CONFERENCE,this.type=o,this.read=i,this.date=s}return e.create=function(t,a,r,n,o,i,s,d,c,l){var p=new e(t,a,r,n,o,i,s,d,c,l);return p},e.getNames=function(e){var t={firstname:'',lastname:''};return e&&e.contact&&(t.firstname=e.contact.firstname.toUpperCase(),t.lastname=e.contact.lastname.toUpperCase(),e&&e.date&&(t.date=e.date.getTime())),t},e.getDate=function(e){return e&&e.date?e.date.getTime():0},e.sortByContact=function(e,t){var a=-1;if(e&&e.value.lastname&&t&&t.value.lastname){var r=e.value.lastname,n=t.value.lastname;a=r.localeCompare(n),0===a&&(r=e.value.firstname,n=t.value.firstname,a=r.localeCompare(n),0===a&&t.value.date&&e.value.date&&(a=t.value.date-e.value.date))}return a},e.sortByDate=function(e,t){var a=1;return e&&t&&(a=t.value-e.value),a},e.Type={WEBRTC:'webrtc',TELEPHONE:'telephone',CONFERENCE:'conference'},e}])},function(){(function(){'use strict';angular.module('rainbow').factory('Document',['$log','$filter',function(e,t){function a(t,a,r,n,o,i){this.publisher=t,this.item_id=o,this.data=a,this.timestamp=r,this.authorjid=n,this.pub_id=i,e.debug('[Document] createActu : '+this)}return a.create=function(e,t){return new a(e,t,Date.now(),e.jid)},a.createForSharing=function(e,t){return console.log(t.item_id),''===t.item_id?new a(e,'Repost',Date.now(),t.authorjid,t.pub_id):new a(e,'Repost',Date.now(),t.authorjid,t.item_id)},a.createFromXML=function(e,t){return new a(e,t.childNodes[0].childNodes[0].nodeValue,parseInt(t.childNodes[1].childNodes[0].nodeValue,10),t.childNodes[2].childNodes[0].nodeValue,1===t.childNodes[3].childNodes.length?t.childNodes[3].childNodes[0].nodeValue:'',t.parentNode.attributes.getNamedItem('id').nodeValue)},a.prototype.messageFilter=function(e){return t('quoteFilter')(t('emojione')(t('linky')(t('emojiUnicodeToShort')(e,'_blank'))))},a.prototype.setPubId=function(e){this.pub_id=e},a.prototype.setItemId=function(e){this.item_id=e},a.prototype.getXML=function(){return[{data:$build('entry').c('data',this.data).up().c('timestamp',this.timestamp).up().c('jidauthor',this.authorjid).up().c('item_id',this.item_id).tree()}]},a.prototype.getTime=function(e){return moment(this.timestamp).format(e)},a.prototype.toString=function(){return'(jid:'+this.contact+', id:'+this.pub_id+', data:'+this.data+', tsmp:'+this.timestamp+' )'},a}])})()},function(){angular.module('rainbow').factory('Group',[function(){'use strict';function e(e,t,a,r){this.id=e,this.name=t,this.comment=a?a:'',this.isFavorite=!!r&&r,this.users=[],this.sortedUserList=[]}return e.createFromData=function(t){return new e(t.id,t.name,t.comment,t.isFavorite)},e}])},function(){angular.module('rainbow').factory('Invitation',['userInfoService',function(e){'use strict';function t(t,a,r,n,o,i,s,d,c,l,p,u){this.id=t,this.invitedUserId=a,this.invitedUserEmail=r,this.invitedPhoneNumber=u,this.invitingUserId=n,this.invitingUserEmail=o,this.requestNotificationLanguage=i,this.invitingDate=s,this.lastNotificationDate=d,this.status=c,this.type=l,this.defaultAvatar=null,this.inviteToJoinMeeting=p,this.createDefaultAvatar=function(){if(!this.defaultAvatar&&this.invitedUserEmail){var t=e.computeUserColor(this.invitedUserEmail),a=this.invitedUserEmail.substring(0,2).toUpperCase();this.defaultAvatar=e.createDefaultAvatarImage(a,t)}}}return t.create=function(e,a,r,n,o,i,s,d,c,l,p){return new t(e,a,r,n,o,i,s,d,c,l,p)},t.createFromData=function(e){var a=new t(e.id,e.invitedUserId,e.invitedUserEmail,e.invitingUserId,e.invitingUserEmail,e.requestNotificationLanguage,e.invitingDate,e.lastNotificationDate,e.status,e.type,e.inviteToJoinMeeting,e.invitedPhoneNumber);return a.createDefaultAvatar(),a},t}])},function(){angular.module('rainbow').factory('VoiceMail',['profileService',function(e){'use strict';function t(){this.VMFlag=!1,this.VMCounter=0,this.infoMsg='',this.voiceMailFeatureEnabled=e.isFeatureEnabled(e.FeaturesEnum.TELEPHONY_VOICE_MAIL),this.setVMFlag=function(e){this.VMFlag=e},this.getVMFlag=function(){return this.VMFlag},this.setVMCounter=function(e){0<e?(this.VMFlag=!0,this.VMCounter=e):this.VMCounter=0},this.getVMCounter=function(){return this.VMCounter},this.setInfoMsg=function(e){this.infoMsg=e},this.getInfoMsg=function(){return this.infoMsg},this.getDisplayState=function(){return this.voiceMailFeatureEnabled}}return t.create=function(){return new t},t}])},function(){angular.module('rainbow').factory('ReplaceMsg',['$filter',function(e){'use strict';function t(e,t){this.id=e,this.body=t}return t.create=function(a,r){var n=e('emojiUnicodeToShort')(r);return new t(a,n)},t}])},function(){angular.module('rainbow').factory('Organisation',[function(){'use strict';function e(e,t,a){this.id=e,this.name=t,this.visibility=a,this.companies=[]}return e.createFromData=function(t){return new e(t.id,t.name,t.visibility)},e}])},function(){angular.module('rainbow').factory('Site',[function(){'use strict';function e(e,t,a,r,n,o){this.id=e,this.name=t?t:'',this.status=a?a:'',this.companyId=r?r:'',this.settings=n?n:'',angular.isDefined(o)&&(this.isCentrex=o)}return e.createFromData=function(t){return new e(t.id,t.name,t.status,t.companyId,t.settings,t.isCentrex)},e.create=function(t,a,r,n){return new e(t,a,r,n)},e.StatusValues=['active','alerting','hold','terminated'],e}])},function(){angular.module('rainbow').factory('System',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f,S,C){this.id=e||null,this.jid_pbxagent=a||'',this.jid_password=r||'',this.pbxMainBundlePrefix=n||['0'],this.usePbxMainBundlePrefix=!angular.isDefined(g)||g,this.pbxNumberingTranslator=v||[],this.type=i||null,this.country=l||'FRA',this.name=p||'',this.jid_pbxagent_password=u||'',this.jid_pbxagent_password_activating=m||'',c&&(this.siteId=c),t&&(this.pbxId=t),o&&(this.serverPingTimeout=o),s&&(this.status=s),d&&(this.version=d),angular.isDefined(f)&&(this.isCentrex=f),angular.isDefined(S)&&(this.isShared=S),C&&(this.bpId=C)}return e.createFromData=function(t){return new e(t.id,t.pbxId,t.jid_pbxagent,t.jid_password,t.pbxMainBundlePrefix,t.serverPingTimeout,t.type,t.status,t.version,t.siteId,t.country,t.name,t.jid_pbxagent_password,t.jid_pbxagent_password_activating,t.usePbxMainBundlePrefix,t.pbxNumberingTranslator,t.isCentrex,t.isShared,t.bpId)},e.create=function(){return new e},e.StatusValues=['created','activating','activated'],e}]),angular.module('rainbow').filter('serverTypeFilter',[function(){'use strict';return function(e){return'oxo'===e?'OXO Connect':'oxe'===e?'OmniPCX Enterprise':'third_party'===e?'Third party PBX':e}}]),angular.module('rainbow').filter('systemStateFilter',[function(){'use strict';return function(e){return'created'===e?'pending':'activating'===e?'connecting':'activated'===e?'normal':void 0}}]),angular.module('rainbow').filter('systemStateColorFilter',[function(){'use strict';return function(e){return'created'===e?'color_orange':'activating'===e?'color_red':'activated'===e?'color_green':void 0}}])},function(){angular.module('rainbow').factory('SystemsGroup',[function(){'use strict';function e(e,t,a,r){this.id=e||null,this.name=t,this.companies=a||[],this.systems=r,this.containsSystem=function(e){return!!this.systems&&this.systems.some(function(t){return t.systemId===e})}}return e.createFromData=function(t){return new e(t.id,t.name,t.companies,t.systems)},e.create=function(t,a,r,n){return new e(t,a,r,n)},e}])},function(){angular.module('rainbow').factory('User',['Subscription','userInfoService',function(e,t){'use strict';function a(r,n){var o=this;a.attributes.forEach(function(e){r&&angular.isDefined(r[e.name])?o[e.name]=r[e.name]:!n&&angular.isDefined(e.defaultValue)&&(o[e.name]=e.defaultValue)}),this.subscriptions=[],this.updateFromData=function(e){a.attributes.forEach(function(t){angular.isDefined(e[t.name])&&(o[t.name]=e[t.name])})},this.fillSubscriptionMap=function(){var e={};this.subscriptions.forEach(function(t){e[t.id]=t}),this.subscriptionMap=e},this.fillMainSubscriptionField=function(){var t=this.subscriptions.filter(e.isExclusive).sort(e.subscriptionComparator);0<t.length&&(this.mainSubscription=t[t.length-1],this.mainSubscriptionName=this.mainSubscription.offerName);var a=this.subscriptions.filter(e.isOptional);0<a.length&&(this.optionalSubscriptionNames=a.map(function(e){return e.offerName}).join(', ')),this.subscriptionNames=this.mainSubscriptionName+(this.optionalSubscriptionNames?', '+this.optionalSubscriptionNames:'')},this.getMainSubscription=function(){return this.mainSubscription||this.fillMainSubscriptionField(),this.mainSubscription},this.getOptionalSubscriptions=function(){return this.subscriptions.filter(e.isOptional)},this.getMainSubscriptionName=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.mainSubscriptionName},this.getOptionalSubscriptionNames=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.optionalSubscriptionNames},this.hasUserRoleOnly=function(){return 1===this.roles.length&&-1!==this.roles.indexOf(a.RoleValues.USER)},this.isAdmin=function(){return-1!==this.roles.indexOf(a.RoleValues.ADMIN)},this.isOrganizationAdmin=function(){return!!this.isAdmin()&&'organization_admin'===this.adminType},this.isSiteAdmin=function(){return!!this.isAdmin()&&'site_admin'===this.adminType},this.isCompanyAdmin=function(){return!!this.isAdmin()&&'company_admin'===this.adminType},this.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},this.isBPAdminOperations=function(){return-1!==this.roles.indexOf(a.RoleValues.BP_ADMIN_OPERATIONS)},this.isBPAdminFinance=function(){return-1!==this.roles.indexOf(a.RoleValues.BP_ADMIN_FINANCE)},this.isSuperadmin=function(){return-1!==this.roles.indexOf(a.RoleValues.SUPERADMIN)},this.isPublicChannelsAdmin=function(){return-1!==this.roles.indexOf(a.RoleValues.PUBLIC_CHANNELS_ADMIN)},this.isAllCompanyChannelsAdmin=function(){return-1!==this.roles.indexOf(a.RoleValues.ALL_COMPANY_CHANNELS_ADMIN)},this.isClosedChannelsAdmin=function(){return-1!==this.roles.indexOf(a.RoleValues.CLOSED_CHANNELS_ADMIN)},this.computeDisplayName=function(){var e=t.getNameInformation(this.firstName,this.lastName);this.displayName=e.displayName,this.initials=e.initials},this.getPhoneNumbers=function(e,t){return this.phoneNumbers?this.phoneNumbers.filter(function(a){return a.type===e&&a.deviceType===t}):[]},this.getSystemPhoneNumber=function(){return this.phoneNumbers?this.phoneNumbers.find(function(e){return angular.isDefined(e.systemId)}):void 0},this.getActivePhoneNumber=function(e,t){var a=this.getPhoneNumbers(e,t);if(1<a.length){var r=a.find(function(e){return angular.isDefined(e.systemId)});if(r)return r}return a[0]}}return a.createFromData=function(t,r){t&&t.roles&&t.roles.includes('private_channels_admin')&&t.roles.splice(t.roles.indexOf('private_channels_admin'),1,a.RoleValues.ALL_COMPANY_CHANNELS_ADMIN);var n=new a(t,r);return t.profiles&&(t.profiles.forEach(function(t){var a=e.createFromData(t);a.isTerminated()||n.subscriptions.push(a)}),n.fillMainSubscriptionField()),n.computeDisplayName(),n},a.create=function(){return new a},a.prune=function(e){var t=Object.assign({},e);return t},a.VisibilityValues=['private','public'],a.RoleValues={USER:'user',GUEST:'guest',SUPERADMIN:'superadmin',SUPPORT:'support',ADMIN:'admin',BP_ADMIN_OPERATIONS:'bp_admin',BP_ADMIN_FINANCE:'bp_finance',PUBLIC_CHANNELS_ADMIN:'public_channels_admin',ALL_COMPANY_CHANNELS_ADMIN:'all_company_channels_admin',CLOSED_CHANNELS_ADMIN:'closed_channels_admin'},a.AuthenticationTypeValues=[{value:'RAINBOW',label:'rainbowLogin'},{value:'SAML',label:'companySingleSignOn'},{value:'DEFAULT',label:'defaultLogin'}],a.attributes=[{name:'id',defaultValue:null},{name:'loginEmail',defaultValue:''},{name:'firstName',defaultValue:''},{name:'lastName',defaultValue:''},{name:'displayName',defaultValue:''},{name:'nickName',defaultValue:''},{name:'title',defaultValue:''},{name:'jobTitle',defaultValue:''},{name:'companyId',defaultValue:''},{name:'companyName',defaultValue:''},{name:'siteId',defaultValue:''},{name:'systemId',defaultValue:''},{name:'accountType',defaultValue:'free'},{name:'country',defaultValue:'FRA'},{name:'timezone',defaultValue:'Europe/Paris'},{name:'emails',defaultValue:[]},{name:'phoneNumbers',defaultValue:[]},{name:'roles',defaultValue:['user']},{name:'adminType',defaultValue:'company_admin'},{name:'isActive',defaultValue:!1},{name:'isInitialized',defaultValue:!1},{name:'password',defaultValue:void 0},{name:'jid_im',defaultValue:''},{name:'jid_tel',defaultValue:''},{name:'language',defaultValue:'en'},{name:'lastAvatarUpdateDate',defaultValue:null},{name:'visibility',defaultValue:void 0},{name:'authenticationType',defaultValue:void 0}],a}])},function(){angular.module('rainbow').factory('Subscription',['Offer',function(e){'use strict';function t(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f,S,C,h,E,R,b,y){this.id=e,this.offerId=t,this.offerName=a,this.offerReference=r,this.profileId=n,this.profileName=o,this.maxNumberUsers=i,this.numberAssignedUsers=s,this.status=d,this.syncOngoing=!!c&&c,this.updatingMaxNumberUsers=l,void 0!==p&&(this.nbBPLicences=p),void 0!==u&&(this.nbAssignedBPUsers=u),void 0!==m&&(this.nbLicencesAssignedToECs=m),void 0!==g&&(this.nbLicencesUsed=g),void 0!==v&&(this.nbFreeLicences=v),this.businessModel=f,this.canBeSold=S,this.isPrepaid=E,this.expirationDate=R,this.autoRenew=b,this.hasConference=y,this.isDefault=C,this.isExclusive=h,this.isEnterprise=function(){return this.offerName.toLowerCase().startsWith('enterprise')},this.isBusiness=function(){return this.offerName.toLowerCase().startsWith('business')},this.isEssential=function(){return this.offerName.toLowerCase().startsWith('essential')},this.isTerminated=function(){return'terminated'===this.status},this.isTerminating=function(){return'terminating'===this.status},this.isUserLicense=function(){return this.isDefault||'nb_users'===this.businessModel||'usage'===this.businessModel}}return t.createFromData=function(e){var a=e.id?e.id:e.subscriptionId;return new t(a,e.offerId,e.offerName,e.offerReference,e.profileId,e.profileName,e.maxNumberUsers,e.numberAssignedUsers,e.status,e.syncOngoing,e.updatingMaxNumberUsers,e.nbBPLicences,e.nbAssignedBPUsers,e.nbLicencesAssignedToECs,e.nbLicencesUsed,e.nbFreeLicences,e.businessModel,e.canBeSold,e.isDefault,e.isExclusive,e.isPrepaid,e.expirationDate,e.autoRenew,e.hasConference)},t.subscriptionComparator=function(t,a){var r=new e(t.offerId,t.offerName,null,null,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid),n=new e(a.offerId,a.offerName,null,null,a.profileId,a.canBeSold,a.businessModel,a.isDefault,a.isExclusive,a.isPrepaid);return e.offerComparator(r,n)},t.isUserLicense=function(e){return e.isDefault||'nb_users'===e.businessModel||'usage'===e.businessModel},t.isExclusive=function(e){return e.isDefault||e.isExclusive},t.isOptional=function(e){return!t.isExclusive(e)},t.isConference=function(e){return t.isOptional(e)&&(e.hasConference||'usage'===e.businessModel)},t.isNotConference=function(e){return t.isOptional(e)&&!(e.hasConference||'usage'===e.businessModel)},t.withLicenses=function(e){return e.isDefault||'usage'===e.businessModel||'nb_users'===e.businessModel&&0<e.maxNumberUsers},t.isPrepaid=function(e){return e.isPrepaid},t.isMonthly=function(e){return!e.isPrepaid},t}])},function(){angular.module('rainbow').factory('IceServer',[function(){'use strict';function e(e,t,a,r){this.id=e,this.urls=t,this.username=a,this.credential=r}return e.createFromData=function(t){return new e(t.id,t.urls,t.username,t.credential)},e}])},function(){angular.module('rainbow').factory('PhoneNumber',[function(){'use strict';function e(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f,S){this.id=e,this.shortNumber=t,this.number=a,this.numberE164=r,this.pbxUserId=n,this.userId=o,this.type=i,this.deviceType=s,this.pbxId=d,this.isFromSystem=c,this.isMonitored=l,this.systemId=p,this.country=u,this.voiceMailNumber=m,this.deviceName=g,this.firstName=v,this.lastName=f,this.internalNumber=S}return e.createFromData=function(t){return new e(t.id?t.id:t.phoneNumberId,t.shortNumber,t.number,t.numberE164,t.pbxUserId,t.userId,t.type,t.deviceType,t.pbxId,t.isFromSystem,t.isMonitored,t.systemId,t.country,t.voiceMailNumber,t.deviceName,t.firstName,t.lastName,t.internalNumber)},e}])},function(){angular.module('rainbow').service('helpersService',[function(){'use strict';this.findIndex=function(e,t){return e.findIndex(t)},this.checkBrowser=function(e){return-1!==navigator.userAgent.indexOf(e)}}])},function(){angular.module('rainbow').service('userInfoService',['$q','$log','$interval','$rootScope','settingsService',function(e,t,a,r,n){'use strict';var o=this;o.userColors=['#ff4500','#d38700','#348833','#007356','#00b2a9','#00b0e5','#0085ca','#6639b7','#91278a','#cf0072','#a50034','#d20000'],o.getAvatarImage=function(n,i,s,d,c){return e(function(e){c='undefined'!=typeof c&&c;var l=i?o.createDefaultAvatarImage(i,s):null;if(!c)e(l);else{var p=config.webservices.protocol+'://'+config.webservices.currentServer;r.cdn&&(p=r.cdnServer);var u=p+'/api/avatar/'+n+'?size='+(d?d:256);c&&(u+='&update='+MD5.hexdigest(c));var m=new Image;m.onload=function(){var r=this;a(function(){t.log('[avatarService] Load avatar for '+n+' success'),e(r)},1,1)},m.onerror=function(){a(function(){t.warn('[avatarService] Load avatar for '+n+' failure : use text avatar'),e(l)},1,1)},m.src=u}})},o.getNameInformation=function(e,t){var a={displayName:'',initials:''};return 1!==t.length&&2!==e.length?'FL'===n.getSetting('displayOrder')?(a.displayName=e+' '+t,a.initials=e.charAt(0).toUpperCase()+t.charAt(0).toUpperCase()):(a.displayName=t+' '+e,a.initials=t.charAt(0).toUpperCase()+e.charAt(0).toUpperCase()):(a.displayName='FL'===n.getSetting('displayOrder')?e+' '+t:t+' '+e,a.initials=e.charAt(0).toUpperCase()+e.charAt(1).toUpperCase()),a},o.createDefaultAvatarImage=function(e,t){var a=new Image,r=document.createElement('canvas');r.width=a.width=225,r.height=a.height=225;var n=r.getContext('2d');return n.rect(0,0,225,225),n.fillStyle=t,n.fill(),n.font='bold 100px Helvetica',n.textAlign='center',n.fillStyle='white',n.fillText(e,110,150),a.src=r.toDataURL('image/png'),a},o.computeUserColor=function(e){try{for(var a={colorIndex:0,color:o.userColors[0]},r=e.toUpperCase(),n=0,s=0;s<r.length;s++)n+=r.charCodeAt(s);a.colorIndex=n%12,a.color=o.userColors[a.colorIndex]}catch(e){t.error('[UserInfoService] computeUserColor failure'),a.colorIndex=1,a.color=o.userColors[a.colorIndex]}return a}}])},function(){angular.module('rainbow').service('errorHelperService',['$filter',function(e){'use strict';var t=this;t.ErrorCodeLabels={0:'errorNoServerResponse',400210:'invalidPhoneNumber',400400:'errorWrongPassword',400500:'invalidFile',400504:'companyNameAlreadyExist',400505:'BPCompanyWithoutPaymentConfigurationData',400506:'NoActiveSubscriptionToOffer',400511:'ActiveDirectoryDomainAlreadyUsed',400552:'BPCompanyAndECCompanyMustNotBeSame',400973:'noCreateUserPermission',400975:'userAlreadyExistsInOtherCompany',400983:'userAlreadyExistsInOtherCompany',400990:'noUserFound',400993:'noUserFound',401202:'errorInvalidToken',401500:'errorUnauthorized',401501:'errorLoginForbidden',401510:'errorUserUnauthorized',401520:'errorUserNotActive',401521:'errorUserNotActive',403:'Forbidden',403000:'accessDeniedNotRequiredRole',403001:'accessDeniedNotOwner',403034:'cantDeselectDefaultWebRTCGateway',403035:'cantDeleteDefaultWebRTCGateway',403200:'notAllowedToChangeRole',403203:'notAllowedToChangeRole',403204:'notAllowedToMoveExistingUserToThisCompany',403301:'notAllowedToManageCompany',403304:'notAllowedToAddAnotherAdmin',403311:'errorRemoveSyncOngoingSubscriptionForbidden',403315:'errorRemoveSubscriptionForbidden',403316:'errorRemoveAdminAllocatedSubscriptionForbidden',403317:'errorRemoveClientAllocatedSubscriptionForbidden',403500:'notAllowedBlacklistedEmail',403501:'notAllowedBlacklistedEmail',403503:'NotAllowedSelfRegistrationEmail',403504:'notAllowedLoggedInUserEmail',403507:'notAllowedSupportEmail',403513:'companyNotABpCompany',403516:'companyNotABpCompany',403517:'companySeenAsTerminated',403518:'companyBpTypeIncompatible',403519:'companyAlreadyLinkedToBp',403520:'companyNotVadBp',403531:'resetPasswordBlocked',403532:'resetPasswordForbidden',403608:'errorAssignSubscriptionSyncOngoing',403609:'errorAssignSubscriptionSyncOngoing',403610:'maxSubscriptionAllocationReached',403611:'notAllowedToCreateAnEquipment',403615:'maximumNumberConferenceParticipantsReach',403616:'subscriptionCompanyAdminEssentialAlreadyExists',403617:'roleCompanyAdminEssentialAlreadyExists',403620:'MaximumNumberRoomUsersReach',403630:'uploadErrorMaxQuotaReached',403655:'userAlreadyCompanyMember',403700:'errorDeleteSiteWithSystems',403701:'errorDeleteOrganisationLinkedCompany',403702:'errorDeleteCompanyWithSubscriptions',403703:'errorDeleteCompanyWithSites',403704:'errorDeleteCompanyWithUsers',403705:'errorDeleteCompanyStillTerminated',403706:'errorRemoveBusinessPartnerRole',404:'resourceNotFound',404000:'resourceNotFound',404001:'resourceNotFoundUpdateImpossible',404002:'resourceNotFoundDeleteImpossible',404300:'noValidOfferReferenceInACTISFile',404301:'offerNotFound',409000:'userAlreadyCreated',409011:'noMessagesToExport',409552:'internalNumberAlreadyUsed',409600:'userAlreadyExist',409601:'invitationReSentConflict',409602:'userAlreadyNetworkMember',409603:'invitationReSentConflict',409620:'offerAlreadySubscribed',409623:'conferenceOfferAlreadySubscribed',409625:'errorUpdateSyncOngoingSubscriptionForbidden',409800:'companyNotIrBp',409801:'companyNotLinkedToBp',409802:'actisCompanyAdminMismatch',409803:'actisCompanyNameMismatch',413000:'uploadErrorTooLarge',500:'errorInternalServerError',1001:'extensionNotLinkedToEquipment',1002:'extensionHasNoIdentifier',1003:'extensionDoesNotExist',1004:'extensionLookupFailure',1005:'extensionConflict',1006:'nonUniqueEquipmentForExtension',1007:'userAlreadyAssociatedToExtension',1008:'extensionAssociatedToAnotherUser',1009:'failedToAttachExtension',1010:'userHasNoExtension',1011:'userHasTooManyExtensions',1012:'failedToDetachExtension'},t.portalErrorCodeLabels={massprovisioning:{400502:'invalidColumnName',400506:'invalidValueInActionColumn',403610:'errorMaxSubscriptionReached'}},t.handleErrorMessage=function(e,a){t.getErrorFullMessage(e,a)},t.handleError=function(e,a){var r=t.getPortal(e),n=e.status;e.data&&e.data.errorDetailsCode&&(n=e.data.errorDetailsCode);var o=new Error(t.getDetailedErrorMessage(e));return o.status=e.status,o.fieldErrors=t.getBadRequestFieldErrors(e),o.errorDetailsCode=n,o.errorDetailsLabel=t.getErrorCodeLabel(n,r),o.translatedMessage=t.getTranslatedErrorMessage(e,a,r),o.portal=r,o},t.getPortal=function(e){var t=e.config?e.config.url:void 0,a=t?t.match(/api\/rainbow\/(\w+)\//):void 0,r=a?a[1]:void 0;return r},t.getBadRequestFieldErrors=function(e){var a={};if(400===e.status){if(e.data&&e.data.errorDetails instanceof Array)e.data.errorDetails.forEach(function(e){a[e.param]||(a[e.param]={ok:!1,message:e.msg,value:e.value})});else if(e.data&&e.data.errorDetails&&e.data.errorDetails.param){var r=e.data.errorDetails;a[r.param]={ok:!1,message:r.msg,value:r.value}}e.data&&400511===e.data.errorDetailsCode&&(a.office365Tenant={ok:!1,message:t.ErrorCodeLabels[400511]})}return a},t.getErrorMessage=function(e){var a=t.getStatusErrorMessage(e);return e.data&&e.data.errorMsg&&(a='',a+=e.data.errorDetails?e.data.errorDetails instanceof Array?'one or more fields are invalid':e.data.errorDetails.msg?e.data.errorDetails.msg:e.data.errorDetails:e.data.errorMsg),a},t.getStatusErrorMessage=function(e){var t;return t=500===e.status?'Internal server error':415===e.status?'Unsupported Media Type':413===e.status?'Request Entity Too Large':404===e.status?'Resource not found':403===e.status?'Access is forbidden':401===e.status?'Authorization failure':400===e.status?'Bad request':e.statusText?e.statusText:'Unknown error',t},t.getDetailedErrorMessage=function(e){var a=t.getErrorMessage(e);return e.data&&e.data.errorDetails&&e.data.errorDetails instanceof Array&&0<e.data.errorDetails.length&&(a+=' : '+e.data.errorDetails[0].msg),a},t.getTranslatedErrorMessage=function(e,a,r){if(500===e.status)return t.getLocalizedError('500');var n=null;e.data&&e.data.errorDetailsCode&&(n=e.data.errorDetailsCode);var o=null;return o=e.data&&e.data.errorDetailsData?Object.assign(e.data.errorDetailsData,a):a,t.getTranslatedErrorMessageByDetailsCode(n,o,t.getErrorMessage(e),r)},t.getTranslatedErrorMessageByDetailsCode=function(a,r,n,o){var i;return a&&(i=t.getLocalizedError(a,r,o)),i||(i=a?e('translate')('anErrorOccurred',{errorcode:a}):e('translate')('anErrorOccurred'),n&&(i+=' ('+e('translate')(n)+')')),i},t.getLocalizedError=function(a,r,n){var o;if(a){var i=t.getErrorCodeLabel(a,n);if(i){var s=e('translate')(i,r);s!==i&&(o=s)}}return o},t.getErrorCodeLabel=function(e,a){return a&&t.portalErrorCodeLabels[a]&&t.portalErrorCodeLabels[a][e]?t.portalErrorCodeLabels[a][e]:t.ErrorCodeLabels[e]},t.getErrorFullMessage=function(e,t){var a=t?t+' failure : ':'';return e&&e.data?(a+=e.data.errorMsg,e.data.errorDetails&&(a+=' - ',e.data.errorDetails instanceof Array?e.data.errorDetails.forEach(function(e){a+=e.msg}):e.data.errorDetails.msg?a+=e.data.errorDetails.msg:a+=e.data.errorDetails)):a+='Unknow error - Something goes really wrong',a}}])},function(){angular.module('rainbow').service('pushImageHelperService',['$log','$q','$http','authService','errorHelperService',function(e,t,a,r,n){'use strict';var o=this;o.pushImage=function(i,s,d){return t(function(c,l){var p=null;if(d&&d.nosize)p=function(){var e=new Image;return e.src=s,t.when(e)};else{var u=d&&d.width?d.width:512,m=d&&d.height?d.height:512;p=function(){return o.resizeImage(s,u,m)}}p().then(function(t){var s=o.getBinaryData(t);a({method:'POST',url:i,headers:r.getPostHeader('image/'+s.type),data:s.data,transformRequest:[]}).then(function(){e.info('[pushImageHelperService] pushImage : success'),c()},function(t){var a=n.handleError(t);l(a),e.error('[pushImageHelperService] '+n.getErrorFullMessage(t,'pushImage'))})})})},o.resizeImage=function(e,a,r){return t(function(t){var n=new Image;n.src=e,n.onload=function(){var e=n.width,o=n.height;e>o?e>a&&(o*=a/e,e=a):o>r&&(e*=r/o,o=r);var i=document.createElement('canvas');i.width=e,i.height=o,n.width=e,n.height=o;var s=i.getContext('2d');s.drawImage(this,0,0,e,o);var d=new Image;d.src=i.toDataURL('image/png'),t(d)}})},o.getBinaryData=function(e){for(var t=e.src.indexOf('image/')+6,a=e.src.indexOf(';base64,'),r=e.src.slice(a+8),n=e.src.slice(t,a),o=window.atob(r),s=o.length,d=new Uint8Array(s),c=0;c<s;c++)d[c]=o.charCodeAt(c);return{type:n,data:d}}}])},function(){angular.module('rainbow').service('$localStorage',['$q',function(e){'use strict';this.get=function(t){for(var a={},r=0;r<t.length;r++)a[t[r]]=localStorage.getItem(t[r]);return e.when(a)},this.set=function(t){for(var a=Object.keys(t),r=0;r<a.length;r++)localStorage.setItem(a[r],t[a[r]]);return e.when()},this.remove=function(t){for(var a=0;a<t.length;a++)localStorage.removeItem(t[a]);return e.when()}}])},function(){angular.module('rainbow').service('authService',['$http','$q','$window','$log','$localStorage','$interval','$rootScope','$translate','jwtHelper','settingsService','AuthSettings',function(e,t,a,r,n,o,i,s,d,c,l){'use strict';var p=this;try{window.SHA256=CryptoJS.SHA256}catch(t){}p.onInit=function(){r.info('[authService] === INITIALIZATION ==='),p.login=null,p.token=null,p.jidIm=null,p.jidTel=null,p.jidPwd=null,p.initialized=null,p.renewAppTokenInterval=null,p.renewTokenInterval=null,p.userData=null,p.firstUse=null===localStorage.getItem('firstUse'),p.browserFingerprint=null,p.isGuest=!1,p.logingItself=!1,config.appModuleKey||(config.appModuleKey=angular.module('rainbow').moduleIds?angular.module('rainbow').moduleIds.join(''):'default'),p.sdkHostForced=null,p.appToken=null,p.fromSDK=!1,p.firstUseNewVersion=!1;var e=localStorage.getItem('version'),t=p.getMajorVersion(e),a=p.getMajorVersion(version);t!==a&&(p.firstUseNewVersion=!0),n.set({version:version})},p.getMajorVersion=function(e){if(!e)return null;var t=/\d+\.\d+/g,a=t.exec(e);return a&&0<a.length?a[0]:null},p.registerEventsHandler=function(){p.visibilityHandlerRemoval&&p.visibilityHandlerRemoval(),p.visibilityHandlerRemoval=i.$on('ON_APP_VISIBLE_CHANGE_EVENT',function(e,t){t&&p.startTokenSurvey()})},p.isInitialized=function(){return p.initialized},p.isFirstUse=function(){return p.firstUse},p.getRequestHeader=function(){var e={Authorization:'Bearer '+p.token,Accept:'application/json'};return p.fromSDK&&p.appToken,e},p.getRequestHeaderWithRange=function(e){var t=p.getRequestHeader();return t.Range=e,t},p.getPostHeader=function(e){var t=p.getRequestHeader();return t['Content-Type']=e||'application/json',t},p.getPostHeaderWithRange=function(e,t){var a=p.getPostHeader(t);return a['Content-Range']=e,a},p.authenticateOnHost=function(e,t,a,r,n){return p.sdkHostForced=a,p.appToken=r,p.fromSDK=!0,n?(config.xmpp.currentServer=p.sdkHostForced,config.webservices.currentServer=p.sdkHostForced,config.restServerUrl=config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port,p.authenticateWithToken(n)):p.authenticate(e,t,!1)},p.authenticate=function(e,a,n,o){return t(function(t,i){r.info('[authService] authenticate with "'+e+'"'),p.getLocalStorageAuthInfo(!1).then(function(){return p.logon(e,a,n,o)}).then(function(){p.registerEventsHandler(),t()}).catch(function(e){r.error('[authService] authenticate failure -- '+e.message),i(e)})})},p.getUserAuthenticationSettings=function(a,n){var o=l.createFromData([{type:'RAINBOW',url:config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port+'/api/rainbow/authentication/v1.0/login'}]);return t(function(t,i){if(n)t(o);else{var s={};p.setInformationHeaders(s),e({method:'GET',url:config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port+'/api/rainbow/authentication/v1.0/urls?uid='+a,headers:s,timeout:15e3}).then(function(e){o=l.createFromData(e.data.data),o.setParameter('uid',function(){return a}),o.setParameter('x-rainbow-app-auth',p.getRainbowAppAuth.bind(this,config.rainbowApiClientKey,config.appModuleKey)),t(o)},function(e){var t='authenticate for login "'+a+'" failure : ',n='errorUltimateUnknownError';e||(t+='Ultimate unknown error'),0===e.status||-1===e.status?(t+='No server response',n='errorNoServerResponse'):404===e.status?(t+=e.data.errorDetails,n='unknownAccount'):500===e.status&&(t+=e.data.errorDetails,n='errorInternalServerError'),r.info('[authService] '+t),i(new RBError(t,n))})}})},p.getBasicAuthorizationCredentials=function(e,t){return a.btoa(unescape(encodeURIComponent(e+':'+t)))},p.getRainbowAppAuth=function(e,t,r){return a.btoa(unescape(encodeURIComponent(e+':'+SHA256(t+r))))},p.logon=function(o,d,c,l){return t(function(t,u){var m={Authorization:'Basic '+a.btoa(unescape(encodeURIComponent(o+':'+d))),Accept:'application/json'};p.setInformationHeaders(m),config.rainbowApiClientKey&&(m['x-rainbow-app-auth']='Basic '+a.btoa(unescape(encodeURIComponent(config.rainbowApiClientKey+':'+SHA256(config.appModuleKey+d))))),p.fromSDK&&p.appToken&&p.appToken.appID&&(m['x-rainbow-app-auth']='Basic '+a.btoa(unescape(encodeURIComponent(p.appToken.appID+':'+SHA256(p.appToken.appSecret+d)))));var g=l?l.loginUrl:config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port+'/api/rainbow/authentication/v1.0/login';e({method:'GET',withCredentials:!0,url:g,headers:m,timeout:15e3}).then(function(e){r.info('[authService] authenticate with "'+o+'" success'),i.disconnected=!1,p.userData=e.data.loggedInUser,p.token=e.data.token,p.userId=e.data.loggedInUser.id,p.login=e.data.loggedInUser.loginEmail,p.jidIm=e.data.loggedInUser.jid_im,p.jidTel=e.data.loggedInUser.jid_tel,p.jidPwd=e.data.loggedInUser.jid_password,p.initialized=e.data.loggedInUser.isInitialized,p.companyId=e.data.loggedInUser.companyId,p.firstUse=!1,p.logingItself=!0,p.isGuest=e.data.loggedInUser.guestMode,p.xmppDomain=p.jidIm.split('@')[1],p.handleUserLanguage(),n.set({firstUse:'false'}),p.rememberMe=c,c?(r.info('[authService] store credentials'),n.set({token:p.token,login:p.login,id:p.userId})):p.removeCredentials(),p.startTokenSurvey(),t()},function(e){var t='authenticate for login "'+o+'" failure : ',a='errorUltimateUnknownError',n,i;e||(t+='Ultimate unknown error'),0===e.status||-1===e.status?(t+='No server response',a='errorNoServerResponse'):401===e.status?(p.removeCredentials(),t+=e.data.errorDetails,n=e.data.errorDetailsCode,401500===e.data.errorDetailsCode?a=l&&d?s.instant('wrongAuthPwd',{text:s.instant('forgotYourPassword')}):'errorUnauthorized':401501===e.data.errorDetailsCode&&(a='errorLoginForbidden',e.data.errorDetailsData&&(i={delay:e.data.errorDetailsData.forbiddenDelay}))):500===e.status&&(t+=e.data.errorDetails,a='errorInternalServerError'),r.info('[authService] '+t),u(new RBError(t,a,n,i))})})},p.setInformationHeaders=function(e){e['x-rainbow-client']=p.getInformationHeadersApp(),e['x-rainbow-client-version']=p.getInformationHeadersAppVersion()},p.getInformationHeadersApp=function(){return'web_sdk'},p.getInformationHeadersAppVersion=function(){return window.sdkversion?window.sdkversion:'9.9.99'},p.authenticateWithToken=function(e,a){return t(function(t,o){if(e){var i=d.decodeToken(e);p.token=e,p.login=i.user.loginEmail,p.userId=i.user.id,a?(r.info('[authService] store credentials'),n.set({token:p.token,login:p.login,id:p.userId})):p.removeCredentials(),p.startTokenSurvey().then(function(){return p.getUserData()}).then(function(){p.registerEventsHandler(),t()}).catch(function(e){var t=e?e.message:'unknown error';r.error('[authService] authenticateWithToken failure -- '+t),o(new Error(t))})}else o(new Error('No token provided'))})},p.authenticateWithProvidedCredentials=function(e){return e?p.getLocalStorageAuthInfo(!1).then(function(){return p.authenticateWithToken(e,p.rememberMe)}):p.authenticateWithLocalCredentials()},p.authenticateWithLocalCredentials=function(e){return t(function(a,n){p.getLocalStorageAuthInfo(!0).then(function(){return e&&p.login!==e?t.reject(new Error('Login account mismatch')):t.resolve()}).then(function(){return p.startTokenSurvey()}).then(function(){return p.getUserData()}).then(function(){p.registerEventsHandler(),a()}).catch(function(e){r.error('[authService] authenticateWithLocalCredentials failure -- '+e.message),n(e)})})},p.getLocalStorageAuthInfo=function(e){return t(function(t,a){n.get(['token','appToken','login','server','support','id','rememberMe']).then(function(n){r.info('[authService] get authentication token'),n.server&&'null'!==n.server&&'undefined'!==n.server?(config.xmpp.currentServer=n.server,config.webservices.currentServer=n.server,'openrainbow.net'===n.server&&(config.appModuleKey=config.dotNetAppModuleKey,config.rainbowApiClientKey=config.dotNetRainbowApiClientKey),'openrainbow.com'===n.server&&(config.appModuleKey=config.dotComAppModuleKey,config.rainbowApiClientKey=config.dotComRainbowApiClientKey)):p.sdkHostForced?(config.xmpp.currentServer=p.sdkHostForced,config.webservices.currentServer=p.sdkHostForced):(config.xmpp.currentServer=config.xmpp.server,config.webservices.currentServer=config.webservices.server),config.restServerUrl=config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port,p.rememberMe=n.rememberMe,e?(p.token=n.token,p.appToken=n.appToken,p.login=n.login,p.userId=n.id,p.token&&p.login?t():a(new Error('No existing token'))):t()})})},p.startTokenSurvey=function(){return t(function(e,t){p.startAppTokenSurvey().then(function(){return p.startUserTokenSurvey()}).then(function(){r.debug('[authService] startTokenSurvey success'),e()}).catch(function(e){e&&e.message||(e=new Error('Unknown error')),r.error('[authService] startTokenSurvey failure -- '+e.message),t(e)})})},p.startUserTokenSurvey=function(e){var a=d.decodeToken(p.token),n=1e3*a.exp,s=1e3*a.iat,c=(n-s)/2,l=new Date(n),u=new Date,m=u.valueOf(),g=n-m;if(e&&r.info('[authService] on logon'),r.info('[authService] Extract auth token info (countRenewed: '+a.countRenewed+', maxTokenRenew: '+a.maxTokenRenew+', tokenExpirationDuration: '+g+')'),0>g)return r.info('[authService] auth token has already expired, display login page'),p.renewTokenInterval&&o.cancel(p.renewTokenInterval),p.token=null,i.$broadcast('ON_AUTH_TOKEN_EXPIRE'),t.reject(new Error('Token expired'));if(g<c)return r.info('[authService] auth token will expire in less '+c/1e3+' seconds, re-new it immediately'),p.renewAuthToken();var v=g-c;return r.info('[authService] start auth token survey (expirationDate: '+l+' tokenExpirationDuration: '+g+'ms usedExpirationDuration: '+v+'ms)'),p.renewTokenInterval&&o.cancel(p.renewTokenInterval),p.renewTokenInterval=o(function(){p.renewAuthToken()},v),t.resolve()},p.renewAuthToken=function(){return t(function(t,a){r.info('[authService] re-new authentication token'),e({method:'GET',url:config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port+'/api/rainbow/authentication/v1.0/renew',headers:p.getRequestHeader()}).then(function(e){r.info('[authService] renew authentication token success'),p.token=e.data.token,n.set({token:p.token}),i.$broadcast('ON_AUTH_TOKEN_RENEW'),p.startTokenSurvey(),t()},function(e){var t=e.data&&e.data.errorDetails?e.data.errorDetails:'no details',n='renew authentication token failure -- '+t,s=new Error(n);s.details='AUTH_TOKEN_EXPIRED',r.error('[authService] '+n),o.cancel(p.renewTokenInterval),i.$broadcast('ON_AUTH_TOKEN_EXPIRE'),a(s)})})},p.startAppTokenSurvey=function(){if(!p.appToken||'string'!=typeof p.appToken||!p.appToken.length)return r.info('[authService] No application token.'),t.resolve();var e=d.decodeToken(p.appToken),a=1e3*e.exp,n=new Date(a),i=new Date,s=i.valueOf(),c=a-s;if(r.info('[authService] Extract application token info (countRenewed: '+e.countRenewed+', maxTokenRenew: '+e.maxTokenRenew+')'),0>c)return r.info('[authService] application token has already expired, re-new it immediately'),p.renewAppToken();if(3e4>c)return r.info('[authService] application token will expire in less 5 minutes, re-new it immediately'),p.renewAppToken();var l=c-24e3;return r.info('[authService] start application token survey (expirationDate: '+n+' tokenExpirationDuration: '+c+'ms usedExpirationDuration: '+l+'ms)'),p.renewAppTokenInterval&&o.cancel(p.renewAppTokenInterval),p.renewAppTokenInterval=o(function(){p.renewAppToken()},l),t.when()},p.renewAppToken=function(){return t(function(t,a){r.info('[authService] re-new application token'),e({method:'GET',url:config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port+'/api/rainbow/applications/v1.0/authentication/renew',headers:p.getRequestHeader()}).then(function(e){r.info('[authService] renew application token success'),p.appToken=e.data.token,n.set({appToken:p.appToken}),i.$broadcast('ON_APP_TOKEN_RENEW'),p.startAppTokenSurvey(),t()},function(e){var t=e.data&&e.data.errorDetails?e.data.errorDetails:'no details',n='renew application token failure -- '+t,s=new Error(n);s.details='APP_TOKEN_EXPIRED',r.error('[authService] '+n),o.cancel(p.renewAppTokenInterval),i.$broadcast('ON_APP_TOKEN_EXPIRE'),a(s)})})},p.getUserData=function(){return t(function(t,a){e({method:'GET',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+p.userId,headers:p.getRequestHeader()}).then(function(e){p.userData=e.data.data,p.login=e.data.data.loginEmail,p.jidIm=e.data.data.jid_im,p.jidTel=e.data.data.jid_tel,p.jidPwd=e.data.data.jid_password,p.initialized=e.data.data.isInitialized,p.companyId=e.data.data.companyId,p.isGuest=e.data.data.guestMode,p.xmppDomain=p.jidIm.split('@')[1],p.handleUserLanguage(),t(p.userData)},function(e){p.removeCredentials(),a(new Error('Wrong token -- '+e.message))})})},p.getFingerPrint=function(){return t(function(e){if(p.browserFingerprint)e(p.browserFingerprint);else{imprint.test(['audio','availableScreenResolution','canvas','colorDepth','cookies','cpuClass','deviceDpi','doNotTrack','indexedDb','installedFonts','language','localIp','localStorage','pixelRatio','platform','plugins','processorCores','screenResolution','sessionStorage','timezoneOffset','touchSupport','userAgent','webGl']).then(function(t){p.browserFingerprint=t,e(t)})}})},p.handleUserLanguage=function(){var e=p.userData.language;e&&c.setAppliLangageCodeFromServer(e)},p.removeCredentials=function(){r.info('[authService] remove credentials');var e=['token','id'];p.isGuest&&e.push('login'),n.remove(e),p.isGuest=!1},p.onInit()}])},function(){var e=1e4;angular.module('rainbow').service('xmppService',['$rootScope','$log','$q','$interval','authService','randomString','settingsService','utilService',function(t,a,r,n,o,i,s,d){'use strict';var c=this;c.disconnectionHandler=null,Strophe.log=function(e,t){switch(e){case Strophe.LogLevel.WARN:a.warn(t);break;case Strophe.LogLevel.ERROR:a.error(t);break;case Strophe.LogLevel.FATAL:a.error(t);break;default:a.debug(t);}},c.start=function(e){a.info(''),a.info('[xmppService] === STARTING ===');var t=performance.now();c.showBodyMessage='true'===s.getSetting('showBodyMessage'),c.started=!1,c.connected=!1,c.stropheStatus=null,c.presenceStatus='offline';var n=config.xmpp.pingInterval?config.xmpp.pingInterval:6e4;return this.pingTimeout=2*n,c.serverURL=config.xmpp.protocol+'://'+config.xmpp.currentServer+':'+config.xmpp.port+'/websocket',c.presenceWaitingList=[],c.jidsToRemove=[],c.fullJid=null,o.jidIm&&o.jidPwd?this.connect().then(function(){c.started=!0;var r=Math.round(performance.now()-t);e.push({service:'xmppService',startDuration:r}),a.info('[xmppService] === STARTED ('+r+' ms) ===')}).catch(function(e){return a.error('[xmppService] === STARTING FAILURE ('+e.message+') === '),r.reject(new Error('Starting failure : '+e.message))}):(a.info('Starting failure : No valid XMPP credentials'),r.reject(new Error('No valid XMPP credentials')))},c.stop=function(){try{return this.disconnect('Stop service').finally(function(){c.connection=null,c.started=!1,c.stropheStatus=null,c.presenceWaitingList=[],c.deferDisconnect=null,c.fullJid=null})}catch(e){return a.error('XMPP disconnect error : '+e),c.connection=null,c.started=!1,c.stropheStatus=null,c.presenceWaitingList=[],c.deferDisconnect=null,c.fullJid=null,r.when()}},c.connect=function(){a.info('[xmppService] -- ASK CONNECTION --');try{var e=r.defer();if(c.stropheStatus===Strophe.Status.CONNECTING||c.stropheStatus===Strophe.Status.CONNECTED||c.stropheStatus===Strophe.Status.AUTHENTICATING){a.info('[xmppService] already connecting');var i=new Error('XMPP service already-connected');return i.details='XMPP_ALLREADY_CONNECTED',r.reject(i)}return c.connection=new Strophe.Connection(c.serverURL+'?x-rainbow-client='+o.getInformationHeadersApp()+'&x-rainbow-client-version='+o.getInformationHeadersAppVersion()+'&x-rainbow-xmpp-dom='+o.xmppDomain),c.connection.rawInput=function(e){return c.handleRawXmppMessage(e,'Recv: ')},c.connection.rawOutput=function(e){return c.handleRawXmppMessage(e,'Sent: ')},c.connecting=!0,c.generateRandomFullJid(o.jidIm).then(function(r){c.fullJid&&(r=c.fullJid),c.connection.connect(r,o.jidPwd,function(r,i){switch(c.stropheStatus=r,i=angular.isUndefined(i)?'':i,r){case Strophe.Status.CONNECTING:a.info('[xmppService] -- Connecting --'),t.$broadcast('ON_CONNECTION_STATE_CHANGE_EVENT','inProgress');break;case Strophe.Status.AUTHFAIL:a.error('[xmppService] -- Authentication failure -- '+i),e.reject(new Error('Authentication failure -- '+i));break;case Strophe.Status.CONNFAIL:c.connecting&&(a.error('[xmppService] -- Connection failure -- '+i),e.reject(new Error('Connection failure -- '+i)));break;case Strophe.Status.CONNECTED:a.info('[xmppService] -- Connected -- '+c.connection.jid),c.connecting=!1,c.connected=!0,c.jid=o.jidIm,c.fullJid=c.connection.jid,c.connection.addHandler(c.onRosterChanged,'jabber:iq:roster','iq','set'),c.connection.addHandler(c.onMamMessageReceived,Strophe.NS.MAM,'message',null),c.connection.addHandler(c.onMamMessageReceived,Strophe.NS.MAM,'iq',null),c.connection.addHandler(c.onSearchTextMessageReceived,'urn:xmpp:mam:tmp','message',null),c.addPresenceHandler(),c.presenceWaitingList=[],c.connection.ping.addPingHandler(function(e){var t=new Date;return a.info('[xmppService] -- Receive keepAlive Ping request ('+t+')'),c.connected&&c.connection.ping.pong(e),!0}),c.enableCarbon(),e.resolve();break;case Strophe.Status.DISCONNECTING:a.info('[xmppService] -- Disconnecting -- '+i);break;case Strophe.Status.DISCONNECTED:a.info('[xmppService] -- Disconnected -- '+c.fullJid),c.started?(t.$broadcast('ON_CONNECTION_STATE_CHANGE_EVENT','disconnected'),-1===c.jidsToRemove.indexOf(c.fullJid)&&(c.jidsToRemove.push(c.fullJid),c.jidsToRemove.forEach(function(e){a.info('[xmppService] -- invalid jid to remove -- '+e)})),c.deferDisconnect?(a.info('[xmppService] -- disable ping connection watcher'),c.connectionWatcherPromise&&n.cancel(c.connectionWatcherPromise),c.connected=!1,c.deferDisconnect.resolve()):c.connected&&!c.connecting?(a.error('[xmppService] -- Unexpected disconnection'),c.connecting=!0,c.connected=!1,t.disconnected=!0,c.disconnectionHandler()):c.connected||c.connecting||!c.fullJid?!c.connected&&!c.connecting&&!c.fullJid&&(a.error('[xmppService] -- Unexpected disconnection without fullJid'),c.connecting=!0,c.disconnectionHandler()):(a.error('[xmppService] -- Unexpected disconnection with fullJid'),c.connecting=!0,c.disconnectionHandler())):(a.info('[xmppService] -- received disconnect event but service not started !!'),a.info('[xmppService] -- disable ping connection watcher'),c.connectionWatcherPromise&&n.cancel(c.connectionWatcherPromise),t.disconnected=!0);break;default:a.error('[xmppService] -- Connection to the xmpp server failure -- '+r+' -- '+i),c.connecting?e.reject(new Error('Connection failure -- '+i)):c.disconnectionHandler();}})}),e.promise}catch(e){return a.error('XMPP service connect error : '+e),r.reject('catch-connect-error')}},c.handleRawXmppMessage=function(e,t){if(c.connectionWatcherPromise&&n.cancel(c.connectionWatcherPromise),c.connectionWatcherPromise=n(c.connectionWatcher,c.pingTimeout),!(-1<e.indexOf('<PHOTO>'))){var r=t;if(-1<e.indexOf('<message')&&(-1<e.indexOf('<body')||-1<e.indexOf('<content>')))r+=c.messageBodyDiscretion(e);else{var o=e,i=$(e).find('data');if(i&&'http://jabber.org/protocol/ibb'===i.attr('xmlns')&&(i.html('Encoded file in base 64'),r+=i.html()),!c.showBodyMessage){if(-1!==e.indexOf('<identity')){var s=e.indexOf('firstName='),l=e.indexOf('\'',s);if(-1!==s&&-1!==l){var p=e.indexOf('\'',l+1);l+1!==p&&(o=e.substr(0,l+2)+'***'+e.substr(p))}var u=o.indexOf('lastName='),m=o.indexOf('\'',u);if(-1!==u&&-1!==m){var g=o.indexOf('\'',m+1);m+1!==g&&(o=o.substr(0,m+2)+'***'+o.substr(g))}}if(-1!==o.indexOf('<caller_info')||-1!==o.indexOf('<callee_info')){var v=o.indexOf('number='),f=o.indexOf('\'',v);if(-1!==v&&-1!==f){var S=o.indexOf('\'',f+1);if(f+1!==S){var C=o.substr(f+1,S-f-1);o=o.substr(0,f+1)+d.anonymizePhoneNumber(C)+o.substr(S)}}}if(-1!==o.indexOf('<caller>')){var h=o.indexOf('<caller>'),E=o.indexOf('</caller>',h),C=o.substring(h+8,E);-1===C.indexOf('@')&&-1===C.indexOf('janus')&&(o=o.substr(0,h+8)+d.anonymizePhoneNumber(C)+o.substr(E))}if(-1!==o.indexOf('<callee>')){var R=o.indexOf('<callee>'),b=o.indexOf('</callee>',R),C=o.substring(R+8,b);-1===C.indexOf('@')&&-1===C.indexOf('janus')&&(o=o.substr(0,R+8)+d.anonymizePhoneNumber(C)+o.substr(b))}}r+=o}a.debug(r)}},c.messageBodyDiscretion=function(e){return c.showBodyMessage?e:(e=c.messageTagDiscretion('content',e),e=c.messageTagDiscretion('body',e),e=c.messageTagDiscretion('subject',e),e)},c.messageTagDiscretion=function(e,t){var a=t.indexOf('<'+e);if(-1!==a){var r=t.indexOf('>',a),n=t.indexOf('/>',a);if(-1!==r&&r!==n+1)return t.substr(0,r+2)+'***'+t.substr(t.indexOf('</'+e+'>')-1)}return t},this.connectionWatcher=function(){try{if(a.error('[xmppService] -- Connection watcher : so bad, no message since '+c.pingTimeout/1e3+' seconds (no ping)'),c.connection){var e=c.stropheStatus===Strophe.Status.CONNECTED?'Have lost connectivity':'Stuck in reconnecting state';a.info('[xmppService] -- Connection watcher -- '+e),c.stropheStatus=null,c.connection.disconnect('No ping')}}catch(e){a.error('connectionWatcher error '+e)}},c.disconnect=function(e){return c.deferDisconnect=r.defer(),a.info('[xmppService] -- ASK DISCONNECTION --'),this.connected?c.stropheStatus===Strophe.Status.CONNECTED&&c.connection.disconnect(e):(a.info('[xmppService] -- disconnect - service is not started'),c.deferDisconnect.resolve()),c.deferDisconnect.promise},c.generateRandomFullJid=function(e){return c.generateRandomFullJidForWeb(e)},c.generateRandomFullJidForWeb=function(e){return r.when(e+'/web_sdk_'+version+'_'+i(8))},c.removeOldConnection=function(){n(function(){var e=c.jidsToRemove.map(function(e){return e&&''!==e?e===c.fullJid?void a.info('[xmppService] -- ignore disconnect obsolete jid for '+e):c.disconnectObsoleteJid(e).then(function(){a.info('[xmppService] -- disconnect obsolete jid -- '+e+' done')}):void a.info('[xmppService] -- ignore disconnect obsolete jid for empty jid')});c.jidsToRemove=[],r.all(e).catch(function(e){a.warn('[xmppService] -- somethings goes wrong during obsolete jid removal -- '+e.message)})},1e4,1)},c.disconnectObsoleteJid=function(e){var t=$iq({type:'set',id:i(8),from:c.fullJid}).c('disconnect',{xmlns:'jabber:iq:configuration'}).c('to').t(e);return c.sendIQ(t)},this.onRosterChanged=function(e){try{return angular.element(e).find('item').each(function(){var e=Strophe.getBareJidFromJid(angular.element(this).attr('jid')),a='favorites'===angular.element(this).find('group').first().text(),r=angular.element(this).attr('subscription'),n=angular.element(this).attr('ask');t.$apply(function(){t.$broadcast('ON_ROSTER_CHANGED_EVENT',{jid:e,subscription:r?r:'none',favorite:a,ask:n?n:'none'})})}),!0}catch(e){return!0}},this.addHistoryHandler=function(e){this.historyHandler=e},this.addSearchTextHandler=function(e){this.searchTextHandler=e},this.addHistoryCallLogsHandler=function(e){this.callLogHandler=e},this.onMamMessageReceived=function(e){a.info('[XmppService] onMamMessageReceived');try{var t=angular.element(e).find('result').attr('queryid');return t||(t=angular.element(e).find('fin').attr('queryid')),t&&0!==t.indexOf('tel_')&&c.historyHandler?c.historyHandler(e):c.callLogHandler&&c.callLogHandler(e),!0}catch(e){return!0}},this.onSearchTextMessageReceived=function(e){a.info('[XmppService] onSearchTextMessageReceived');try{var t=angular.element(e).find('result').attr('queryid');return t||(t=angular.element(e).find('fin').attr('queryid')),c.searchTextHandler&&c.searchTextHandler(t,e),!0}catch(e){return a.warn('[XmppService] onSearchTextMessageReceived error : '+e.message),!0}},this.addPresenceHandler=function(){return a.info('[xmppService] -- Add presence handler'),this.connection.addHandler(c.onPresence,null,'presence'),r.when()},this.sendPresence=function(e,t,r){if(!this.connection&&c.stropheStatus!==Strophe.Status.CONNECTED)return void a.error('[xmppService] Try to send "presence IQ" but no xmpp connection');try{a.info('Send presence '+e+' - '+t+' ('+c.jid+')');var n=$pres();if(n.c('priority').t('5'),n.up(),e&&'online'!==e&&n.c('show').t(e),t&&(!e||'online'===e)?n.c('status').t(t):t&&n.up().c('status').t(t),!this.connection||!this.connection.send)return void a.error('Try to send "presence IQ" but no xmpp connection');!0===r&&(n.c('application',{xmlns:'jabber:iq:application'}),n.c('appid').t(config.rainbowApiClientKey).up(),n.c('userid').t(o.userId)),this.connection.send(n)}catch(e){return void a.error('this.connection.send error : '+e)}},this.resetPresence=function(e){a.info('Reset presence to '+c.presenceStatus+' ('+c.jid+')'),c.sendPresence(e.show,e.status)},this.onPresence=function(e){try{var r=angular.element(e).attr('from'),n=Strophe.getBareJidFromJid(r),o=angular.element(e).find('x').attr('xmlns'),i=angular.element(e).attr('type'),s=angular.element(e).find('show').text();if(o&&0===o.indexOf(Strophe.NS.MUC))return!0;if(0<angular.element(e).find('actor').length&&'jabber:iq:configuration'===angular.element(e).find('actor').attr('xmlns')&&(0<angular.element(e).find('avatar').length?t.$broadcast('ON_VCARD_UPDATE_EVENT',n,'avatar'):0<angular.element(e).find('data').length&&t.$broadcast('ON_VCARD_UPDATE_EVENT',n,'data'),angular.element(e).find('x').length&&'vcard-temp:x:update'===angular.element(e).find('x').attr('xmlns')))return t.$broadcast('ON_PROFILE_FEATURES_UPDATE_NEEDED'),!0;if('error'===i)a.error('Receive error presence message');else if('subscribe'===i)a.info('Receive subscribe from ('+n+')'),t.$broadcast('ON_ROSTER_SUBSCRIBE_EVENT',n);else{var d=$(e),l='offline',p='';'unavailable'!==i&&(s=d.find('show').text(),p=d.find('status').text(),l=''===s||'chat'===s?'online':'dnd'===s?'dnd':'xa'===s?'xa':'away');var u=d.find('delay').attr('stamp'),m=u?new Date(u):new Date,g=d.find('until').text();g=g?new Date(g):null;var v={jid:r,status:l,message:p,stamp:m,until:g};t.$$listeners&&t.$$listeners.ON_ROSTER_PRESENCE_CHANGED_EVENT?t.$broadcast('ON_ROSTER_PRESENCE_CHANGED_EVENT',v):(a.info('[XMPP Service] Receive presence message but contact service is not ready yet'),c.presenceWaitingList.push(v))}return!0}catch(e){return!0}},this.getPresenceWaitingList=function(){return c.presenceWaitingList},this.resetPresenceWaitingList=function(){c.presenceWaitingList=[]},this.enableCarbon=function(){var e=$iq({type:'set'});return e.c('enable',{xmlns:'urn:xmpp:carbons:2'}),c.sendIQ(e)},this.send=function(e){if(!c.connection&&c.stropheStatus!==Strophe.Status.CONNECTED)return a.error('[xmppService] Try to send "stanza" but no xmpp connection'),r.reject(new Error('No XMPP connection'));try{this.connection.send(e)}catch(e){return a.error('[xmppService] this.connection.send error : '+e),r.when()}return r.when()},this.sendIQ=function(t,n){if(!this.connection&&c.stropheStatus!==Strophe.Status.CONNECTED)return a.error('[xmppService] Try to send "iq" but no xmpp connection'),r.reject(new Error('No XMPP connection'));var o=r.defer();try{this.connection.sendIQ(t,function(e){o.resolve(e)},function(e){null===e?o.reject(new Error('XMPP request timeout')):o.reject(new Error(e.innerHTML))},n&&n>e?n:e)}catch(e){return a.error('[xmppService] this.connection.sendIQ error : '+e),r.reject(new Error('this.connection.sendIQ error'))}return o.promise},this.getBareJidFromJid=function(e){return Strophe.getBareJidFromJid(e)},this.getResourceFromJid=function(e){return Strophe.getResourceFromJid(e)},this.addHandler=function(e,t,a,r,n,o,i){return this.connection.addHandler(e,t,a,r,n,o,i)},this.deleteHandler=function(e){this.connection&&this.connection.deleteHandler(e)},this.addFileTransfertHandlers=function(e,t){this.connection.ibb.addIBBHandler(e),this.connection.si_filetransfer.addFileHandler(t)},this.addCallLogsHandler=function(e){this.rtcStartRef&&(this.connection.deleteHandler(this.rtcStartRef),this.rtcStartRef=null),this.rtcEndRef&&(this.connection.deleteHandler(this.rtcEndRef),this.rtcEndRef=null),this.rtcRingingRef&&(this.connection.deleteHandler(this.rtcRingingRef),this.rtcRingingRef=null),this.rtcStartRef=this.connection.addHandler(e,null,'message','webrtc-start'),this.rtcEndRef=this.connection.addHandler(e,null,'message','webrtc-end'),this.rtcRingingRef=this.connection.addHandler(e,null,'message','webrtc-ringing')},this.addTelephonyCallLogsHandler=function(e){this.telephonyMessageRef&&(this.connection.deleteHandler(this.telephonyMessageRef),this.telephonyMessageRef=null),this.telephonyIqRef&&(this.connection.deleteHandler(this.telephonyIqRef),this.telephonyIqRef=null),this.telephonyMessageRef=c.connection.addHandler(e,Strophe.NS.CALLLOG,'message',null),this.telephonyIqRef=c.connection.addHandler(e,Strophe.NS.CALLLOG,'iq',null)},this.addPubSubPublishHandler=function(e){c.connection.addHandler(e,'jabber:client','message','headline',null,'pubsub.demo-all-in-one-dev-1.opentouch.cloud')},this.getIpAddress=function(){return r(function(e,t){if(!RTCPeerConnection)return void t();var a=new RTCPeerConnection({iceServers:[]}),r=function(){},n=[];a.createDataChannel(''),a.createOffer(a.setLocalDescription.bind(a),r),a.onicecandidate=function(o){if(o&&o.candidate&&o.candidate.candidate){var i=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(o.candidate.candidate);if(i&&2<=i.length){var s=i[1];n.push(s)}}else{if(a.onicecandidate=r,!n.length)return void t();e(n)}}})}}])},function(){angular.module('rainbow').service('contactService',['$q','$rootScope','$translate','$log','$injector','$http','xmppService','authService','Contact','$interval','settingsService','PromiseQueue','companyService','errorHelperService','utilService',function(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g){'use strict';function v(){r.debug('[contactService] startUpdatePresentationModeRefreshTimer'),null!==C&&(c.cancel(C),C=null),C=c(function(){r.debug('[contactService] startUpdatePresentationModeRefreshTimer interval reach'),S===f.presentationModeActive?(r.debug('[contactService] startUpdatePresentationModeRefreshTimer interval - no presence update needed'),S=null):(r.debug('[contactService] startUpdatePresentationModeRefreshTimer interval - request presence update'),S=f.presentationModeActive,f.updatePresence(),v())},1e3,1,!0)}var f=this;f.start=function(a){r.info(''),r.info('[contactService] === STARTING ===');var n=performance.now();return e(function(o,m){if(f.userContact=null,f.contacts=[],f.dbContacts=[],f.jtelContacts={},f.contactPromises=[],f.getOrCreateContactPromises=[],f.networkSize=0,f.started=!1,f.changePasswordInfo=null,f.subscriptionPromiseQueue=p.create(),f.presentationModeActive=!1,f.awayStateActive=!1,f.busyState={status:null,message:null},f.forcedState=!1,f.manualState=!1,f.currentLanguage=l.getSetting('lang'),f.langUpdateEventHandlerCleaner&&f.langUpdateEventHandlerCleaner(),f.langUpdateEventHandlerCleaner=t.$on('ON_LANGUAGE_UPDATED_EVENT',function(e,t){f.currentLanguage=t,f.updateContactsLastActivity()}),f.rosterUpdateEventHandlerCleaner&&f.rosterUpdateEventHandlerCleaner(),f.rosterUpdateEventHandlerCleaner=t.$on('ON_ROSTER_CHANGED_EVENT',f.rosterChangedHandler),f.presenceUpdateEventHandlerCleaner&&f.presenceUpdateEventHandlerCleaner(),f.presenceUpdateEventHandlerCleaner=t.$on('ON_ROSTER_PRESENCE_CHANGED_EVENT',f.contactPresenceChangedHandler),f.calendarPresenceEventHandlerCleaner&&f.calendarPresenceEventHandlerCleaner(),f.calendarPresenceEventHandlerCleaner=t.$on('ON_CONTACT_CALENDAR_STATUS_CHANGE',f.contactCalendarPresenceChangedHandler),r.info('[contactService] Create userContact ('+i.jid+')'),f.userContact=new d,f.userContact.ask=null,f.userContact.subscription=null,f.userContact.id=i.jid,f.userContact.jid=i.jid,f.userContact.fullJid=i.fullJid,f.userContact.language=f.currentLanguage,f.userContact.updateFromUserData(s.userData),f.userContact.getAvatar(),f.userContact.updateRichStatus(),f.retrieveOpenInviteId().catch(function(){f.resetOpenInviteId()}),f.dbContacts[f.userContact.dbId]=f.userContact,f.contacts[f.userContact.id]=f.userContact,f.jtelContacts[f.userContact.jidtel]=f.userContact,!s.userData.language){var g=l.getAppliLanguageCodeForServer();f.updateUserContact({language:g})}f.getUserSettings().then(function(t){return f.manageCalendarPresencePrompt(t),l.settings.activeAlarm=t.activeAlarm,l.settings.activeNotif=t.activeNotif,r.info('[contactService] Get alarm & notif data ('+l.settings.activeAlarm+' / '+l.settings.activeNotif+')'),l.settings.protectionAgainstMailTypeOffline=t.protectionAgainstMailTypeOffline,r.info('[contactService] Get mail setting data ('+l.settings.protectionAgainstMailTypeOffline+')'),e.resolve()}).then(function(){return u.getCompanyById(f.userContact.company.id)}).then(function(e){return f.userContact.company=e,f.attachHandlers(),f.getMyNetwork()}).then(function(){return f.updateNetworkWithRosterInfo()}).then(function(){f.appActiveEventHandlerCleaner&&f.appActiveEventHandlerCleaner(),f.appActiveEventHandlerCleaner=t.$watch('appActive',function(e){return r.info('[contactService] AppActive changed : '+e),!e&&f.userContact&&'online'===f.userContact.status&&(f.awayStateActive=!0),e&&f.awayStateActive&&(f.awayStateActive=!1),angular.isDefined(e)&&f.updatePresence(!0),!0}),f.vcardUpdateEventHandlerCleaner&&f.vcardUpdateEventHandlerCleaner(),f.vcardUpdateEventHandlerCleaner=t.$on('ON_VCARD_UPDATE_EVENT',f.onVCardChangeEvent),f.getMissedPresenceMessages();var e=Math.round(performance.now()-n);a.push({service:'contactService',startDuration:e}),r.info('[contactService] === STARTED ('+e+' ms) ==='),f.started=!0,o()}).catch(function(e){r.error('[contactService] === STARTING FAILURE === '+e.message),m(e)}),f.connectionStateEventHandlerCleaner&&f.connectionStateEventHandlerCleaner(),f.connectionStateEventHandlerCleaner=t.$on('ON_CONNECTION_STATE_CHANGE_EVENT',f.onConnectionStateChangeEvent),f.contactLastActivityTimerInterval=c(f.updateContactsLastActivity,6e4)})},f.manageCalendarPresencePrompt=function(e){if(e.promptForCalendarPresence!==void 0)l.setSetting('disableCalendarPresence',e.promptForCalendarPresence?'false':'true'),r.info('[contactService] promptForCalendarPresence -- '+e.promptForCalendarPresence);else{var t='true'!==l.getSetting('disableCalendarPresence');r.info('[contactService] MIGRATION NECESSARY -- promptForCalendarPresence : '+t),f.setUserSettings({promptForCalendarPresence:t})}},f.getMyNetwork=function(){return e(function(e,t){var a=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/networks?limit=2000';o({method:'GET',url:a,headers:s.getRequestHeader()}).then(function(t){var a=t.data.data;r.info('[contactService] GetMyNetwork success -- find '+a.length+' contact(s)'),a.forEach(function(e){var t=new d;t.updateFromUserData(e),f.contacts[t.id]=t,f.dbContacts[t.dbId]=t,f.jtelContacts[t.jidtel]=t,t.updateRichStatus(),t.getAvatar(),f.sendUpdateEvent(t)}),f.networkSize=a.length,e()},function(){var e='GetMyNetwork failure';r.error('[contactService] '+e),t(new Error(e))})})},f.updateNetworkWithRosterInfo=function(){return e(function(e,t){i.sendIQ($iq({type:'get'}).c('query',{xmlns:'jabber:iq:roster'})).then(function(t){r.info('[contactService] Get rosters info successfully'),$(t).find('item').each(function(){var e=$(this),t=i.getBareJidFromJid(e.attr('jid'));if(t&&t.length&&!f.isTelJid(t)){var a=f.contacts[t];if(a){var n=e.attr('ask'),o=e.attr('subscription');a.ask=angular.isDefined(n)?n:'none',a.subscription=angular.isDefined(o)?o:'none',a.roster=!0,a.updateRichStatus(),r.info('[contactService] Update contact from roster ('+a.ask+', '+a.subscription+') '+t)}}}),e()}).catch(function(e){r.error('[contactService] Get rosters failure : '+e.message),t(e)})})},f.getMissedPresenceMessages=function(){r.info('[contactService] GetMissedPresenceMessages');try{var e=i.getPresenceWaitingList();if(e.length){for(r.info('[contactService] GetMissedPresenceMessages length '+e.length);0<e.length;){var t=e.pop();f.contactPresenceChangedHandler(null,t)}i.resetPresenceWaitingList()}}catch(e){r.error('[contactService] GetMissedPresenceMessages error '+e)}},f.attachHandlers=function(){r.info('[contactService] AttachHandlers'),this.contactConfigRef&&(i.connection.deleteHandler(this.contactConfigRef),this.contactConfigRef=null),this.contactConfigRef=i.connection.addHandler(f.onUserManagementEvent,null,'message','management')},f.stop=function(){return r.info('[contactService] Stopping'),f.userContact=null,f.contacts=null,f.dbContacts=null,f.started=!1,f.presentationModeActive=!1,f.awayStateActive=!1,f.busyState={status:null,message:null},f.forcedState=!1,f.manualState=!1,r.info('[contactService] Stopped'),f.vcardUpdateEventHandlerCleaner&&(f.vcardUpdateEventHandlerCleaner(),f.vcardUpdateEventHandlerCleaner=null),f.connectionStateEventHandlerCleaner&&(f.connectionStateEventHandlerCleaner(),f.connectionStateEventHandlerCleaner=null),f.contactLastActivityTimerInterval&&(c.cancel(f.contactLastActivityTimerInterval),f.contactLastActivityTimerInterval=null),e.when()},f.onConnectionStateChangeEvent=function(e,t){if('disconnected'===t&&f.userContact){for(var a in f.userContact.resources={},f.contacts)f.contacts.hasOwnProperty(a)&&!f.contacts[a].isBot&&(f.contacts[a].resources={},'unknown'!==f.contacts[a].status&&'none'!==f.contacts[a].subscription&&(f.contacts[a].status='offline',f.contacts[a].imStatusStamp={}));f.presentationModeActive=!1,f.awayStateActive=!1,f.busyState={status:null,message:null},f.forcedState=!1,f.manualState=!1}},f.onVCardChangeEvent=function(t,a,n){r.info('[contactService] onVCardChangeEvent event: '+t+' || status: '+a+' || type: '+n),c(function(){var t=f.getContactByJid(a);t&&('avatar'===n||'data'===n?f.getVCardByDbId(t.dbId,!0).then(function(){return'avatar'===n?t.getAvatar(256,!0):e.when()}).then(function(){f.sendUpdateEvent(t)}):f.sendUpdateEvent(t))},2e3,1)},f.onUserManagementEvent=function(e){try{var a=$(e).find('usersettings');if(a.length&&'update'===a.attr('action'))return r.info('[contactService] onUserManagementEvent - should update the presence'),f.sendPresenceFromConfiguration(),!0;var n=$(e).find('userpassword');if(n.length&&'update'===n.attr('action'))return r.info('[contactService] onUserManagementEvent - userPassword updated'),f.changePasswordInfo||(f.changePasswordInfo={fromThirdParty:!0}),!0;var o=$(e).find('openinvite');if(o.length&&'update'===o.attr('action')){r.info('[contactService] onUserManagementEvent - update about openinviteid');var i=f.userContact.getOpenInviteId();return f.retrieveOpenInviteId().then(function(){i!==f.userContact.getOpenInviteId()&&t.$broadcast('ON_OPEN_INVITE_ID_UPDATED_EVENT')}),!0}return!0}catch(e){return!0}},f.updateUserContactFullJid=function(){f.userContact.fullJid=i.fullJid,f.attachHandlers()},this.getMinimumContactByDBId=function(t){return e(function(e){e(f.createEmptyContactContact(t))})},f.createEmptyContactContact=function(e){var t=f.createBasicContact(e);return t.initials='?',t.displayName='Unknown contact',t.lastname='Unknown contact',t.firstname='',t.temp=!0,t.avatar=new Image,t.avatar.src='/resources/skins/rainbow/images/conversations/unknownContact.png',t},f.getContact=function(e,t){var a=null,r=e?e:t;return a=this.isUserContactJid(r)?f.userContact:this.contacts[r],a},f.getOrCreateContact=function(t,a){if(!t&&!a)return e.reject(new Error('No jid or no phoneNumber'));f.contacts||(f.contacts=[]);var n=f.getContact(t,a);if(n)return e.resolve(n);if(t&&-1===t.indexOf('@'))return e.reject(new Error('Invalid jid '+t));var o=t?t:a;return t?(f.getOrCreateContactPromises[o]||(f.getOrCreateContactPromises[o]=e(function(e,i){f.getVCardInfoByJid(t).then(function(r){n=f.createBasicContact(t,a,!1),n.updateFromUserData(r),n.updateRichStatus(),n.getAvatar(),f.contacts[n.id]=n,f.dbContacts[n.dbId]=n,f.jtelContacts[n.jidtel]=n,f.sendUpdateEvent(n),e(n),delete f.getOrCreateContactPromises[o]}).catch(function(e){r.error('[contactService] getOrCreateContact -- failure -- '+e.message),i(e),delete f.getOrCreateContactPromises[o]})})),f.getOrCreateContactPromises[o]):e.resolve(n=f.createBasicContact(null,a))},this.createBasicContact=function(e,t,a){r.debug('[contactService] CreateContact '+e+' '+g.anonymizePhoneNumber(t));var n=new d;if(!e)return n.id=t,n.initials='?',n.displayName=t?t:'Unknown contact',n.lastname=t?t:'Unknown contact',n.firstname='',n.phoneProCan=t?t:'',n.temp=!0,n.avatar=new Image,n.avatar.src='/resources/skins/rainbow/images/conversations/unknownContact.png',n.setNameUpdatePrio(d.NameUpdatePrio.NO_UPDATE_PRIO),n;var o=e;return o||(o=t,n.phoneProCan=t),o||(o='anonymous'),n.jid=e,n.id=o,n.ask='none',n.subscription='none',n.updateRichStatus(),!1!==a&&(f.contacts[n.id]=n),n},this.getContactByJid=function(e){var t=null;return this.isUserContactJid(e)?t=f.userContact:this.contacts?t=this.contacts[e]:this.contacts=[],t},this.getContactByEmail=function(e){var t=null;for(var a in this.contacts)this.contacts.hasOwnProperty(a)&&this.contacts[a].containsEmail(e)&&(t=this.contacts[a]);return t},this.getContacts=function(){var e=[];for(var t in this.contacts)this.contacts.hasOwnProperty(t)&&e.push(this.contacts[t]);return e},this.searchContacts=function(e){var t=this.getContacts();return t.filter(function(t){return(t.roster||t.isBot)&&!t.isTerminated&&f.contactMatcher(t,e)})},this.contactMatcher=function(e,t){var a=e.firstname+' '+e.lastname,r=t.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/[ ]+/),n=a.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/[ ]+/);return r.every(function(e){return n.some(function(t,a){return!!(t.length&&0===t.indexOf(e))&&(n[a]='',!0)})})},f.getContactById=function(e){return f.dbContacts[e]},f.getContactByDBId=function(t,a){var n=f.dbContacts[t];if(!a&&n)return e.when(n);var i=f.contactPromises[t];if(i)return r.debug('[contactService] getContactByDBId for '+t+' already lauched'),i.promise;var d=e.defer();f.contactPromises[t]=d;var c=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+t;return o({method:'GET',url:c,headers:s.getRequestHeader()}).then(function(e){var a=e.data.data;r.info('[contactService] GetContactByDBId ('+t+') -- '+a.jid_im+' -- success');var o=n?n:f.createBasicContact(a.jid_im);o.updateFromUserData(a),o.getAvatar(),f.dbContacts[o.dbId]=o,f.jtelContacts[o.jidtel]=o,d.resolve(o),delete f.contactPromises[t]},function(e){var a=m.handleError(e);d.reject(a),delete f.contactPromises[t],r.error('[contactService] '+m.getErrorFullMessage(e,'GetContactByDBId'))}),d.promise},f.completeContactPhoneNumbers=function(t){return e(function(e,a){return t.isBot?void a(new Error('No phone numbers for bot contacts')):void(t.phoneNumbersInitialized?e(t):f.getContactByDBId(t.dbId,!0).then(function(t){e(t)}).catch(function(e){a(e)}))})},f.getOpenInviteIdLink=function(){var e=this.userContact.getOpenInviteId(),t=a.instant('notAvailable'),r=config.webUrl.replace('web','meet');return e&&(t=r+'/'+e),t},f.retrieveOpenInviteId=function(){return e(function(e,t){var a=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+f.userContact.dbId+'/open-invites';o({method:'GET',url:a,headers:s.getRequestHeader()}).then(function(a){var n=a.data.data;if(n&&n.openInviteId)f.userContact.setOpenInviteId(n.openInviteId),e(n.openInviteId);else{var o='retrieveOpenInviteId failure -- No openInviteId';r.error('[contactService] '+o),t(new Error(o))}},function(){var e='retrieveOpenInviteId failure';r.error('[contactService] '+e),t(new Error(e))})})},f.resetOpenInviteId=function(){return e(function(e,t){var a=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+f.userContact.dbId+'/open-invites/reset';o({method:'POST',url:a,headers:s.getRequestHeader()}).then(function(a){var n=a.data.data;if(n&&n.openInviteId)f.userContact.setOpenInviteId(n.openInviteId),e(n.openInviteId);else{var o='resetOpenInviteId failure -- something wrong when resetting';r.error('[contactService] '+o),t(new Error(o))}},function(){var e='resetOpenInviteId failure';r.error('[contactService] '+e),t(new Error(e))})})},this.getContactsByJids=function(t){return e(function(e,a){r.info('[contactService] getContactsByJids with ['+t.join()+']');var n=config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port;o({method:'POST',headers:s.getPostHeader(),url:n+'/api/rainbow/enduser/v1.0/users/jids?limit=1000',data:{jid_im:t}}).then(function(t){t.data.data.forEach(function(e){var t=f.getContactByJid(e.jid_im);t||(t=new d),t.updateFromUserData(e),f.contacts[t.id]=t,f.dbContacts[t.dbId]=t,f.jtelContacts[t.jidtel]=t,t.getAvatar(),t.temp=!1}),e()},function(e){var t=m.handleError(e);a(t),r.error('[contactService] '+m.getErrorFullMessage(e,'getContactsByJids'))})})},this.getContactsByEmails=function(t){return e(function(e,a){r.info('[contactService] getContactsByEmails with ['+t.join()+']');var n=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/loginemails',i=t.map(function(e){return e.toLowerCase()});o({method:'POST',headers:s.getPostHeader(),url:n,data:{loginEmail:i}}).then(function(t){var a={},r=[];t.data.data.forEach(function(e){var t=f.dbContacts[e.id];t||(t=new d,f.contacts[t.id]=t,f.dbContacts[t.dbId]=t,f.jtelContacts[t.jidtel]=t),t.updateFromUserData(e),t.getAvatar(),a[t.loginEmail]=t,r.push(t),i.splice(i.indexOf(t.loginEmail.toLowerCase()),1)}),e({contacts:a,contactsArray:r,emails:i})},function(e){var t=m.handleError(e);a(t),r.error('[contactService] '+m.getErrorFullMessage(e,'getContactsByEmails'))})})},f.getUserSettings=function(){return e(function(e){var t=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+f.userContact.dbId+'/settings';o({method:'GET',url:t,headers:s.getRequestHeader()}).then(function(t){r.info('[contactService] GetUserSettings success');var a=t.data.data.presence||'online',n=t.data.data.activeAlarm||'relax1',o=t.data.data.activeNotif||'notif1',i=t.data.data.promptForCalendarPresence,s=t.data.data.protectionAgainstMailTypeOffline;e({presence:a,activeAlarm:n,activeNotif:o,promptForCalendarPresence:i,protectionAgainstMailTypeOffline:s})},function(t){r.error('[contactService] '+m.getErrorFullMessage(t,'GetUserSettings')),e({presence:'online',activeAlarm:'relax1',activeNotif:'notif1',promptForCalendarPresence:!1})})})},f.setUserSettings=function(t){return e(function(e,a){var n=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+f.userContact.dbId+'/settings';o({method:'PUT',url:n,headers:s.getRequestHeader(),data:t}).then(function(){r.info('[contactService] SetUserSettings '+JSON.stringify(t)+' -- success'),e()},function(e){var t=m.handleError(e);r.error('[contactService] '+m.getErrorFullMessage(e,'SetUserSettings')),a(t)})})},f.getVCardByDbId=function(t,a){return e(function(e,n){var i=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+t;o({method:'GET',url:i,headers:s.getRequestHeader()}).then(function(t){var r=t.data.data,n=f.contacts[r.jid_im];n.updateFromUserData(r),n.updateRichStatus(f.isUserContactJid(r.jid_im)),a||n.getAvatar(),f.sendUpdateEvent(n),e(n)},function(e){var t=m.handleError(e);n(t),r.error('[contactService] '+m.getErrorFullMessage(e,'getVCardByDbId'))})})},f.getVCardInfoByJid=function(t){return e(function(e,a){var n=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/jids/'+t;o({method:'GET',url:n,headers:s.getRequestHeader()}).then(function(t){e(t.data.data)}).catch(function(e){r.error('[contactService] '+m.getErrorFullMessage(e,'getVCardInfoByJid')),a(m.handleError(e))})})},f.getVCardInfoByEmail=function(t){return e(function(e,a){var n=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/loginemails?format=full';o({method:'POST',url:n,headers:s.getRequestHeader(),data:{loginEmail:[t]}}).then(function(t){e(t.data.data)}).catch(function(e){r.error('[contactService] '+m.getErrorFullMessage(e,'getVCardsByEmail')),a()})})},this.pushAvatarImage=function(t){var a=e.defer(),n=config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port;r.info('[contactService] Push avatar image ');var i=f.userContact.avatar;return f.resizeImage(t,512,512).then(function(e){f.userContact.avatar=e;var t=f.getBinaryData(e);o({method:'POST',url:n+'/api/rainbow/enduser/v1.0/users/'+f.userContact.dbId+'/avatar',headers:s.getPostHeader('image/'+t.type),data:t.data,transformRequest:[]}).then(function(){a.resolve()},function(e){f.userContact.avatar=i;var t=m.handleError(e);a.reject(t),r.error('[contactService] '+m.getErrorFullMessage(e,'pushAvatarImage'))})}),a.promise},this.resizeImage=function(t,a,r){var n=e.defer(),o=new Image;return o.src=t,o.onload=function(){var e=o.width,t=o.height;e>t?e>a&&(t*=a/e,e=a):t>r&&(e*=r/t,t=r);var i=document.createElement('canvas');i.width=e,i.height=t,o.width=e,o.height=t,o.crossOrigin='Anonymous';var s=i.getContext('2d');s.drawImage(this,0,0,e,t);var d=new Image;d.src=i.toDataURL('image/png'),n.resolve(d)},n.promise},this.getBinaryData=function(e){for(var t=e.src.indexOf('image/')+6,a=e.src.indexOf(';base64,'),r=e.src.slice(a+8),n=e.src.slice(t,a),o=window.atob(r),s=o.length,d=new Uint8Array(s),c=0;c<s;c++)d[c]=o.charCodeAt(c);return{type:n,data:d}},this.sendSubscription=function(t){return'to'===t.subscribe||'both'===t.subscribe?e.when(t):(f.sendSubscribeInvitation(t.jid),f.sendSubscribeInvitation(t.jidtel),e.when(t))},f.sendSubscribeInvitation=function(e){return r.info('[contactService] Send subscribe invitation to '+e),i.send($pres({to:e,type:'subscribe'}))},f.rosterChangedHandler=function(e,t){f.subscriptionPromiseQueue.add(function(){return f.rosterChangedHandlerPromise(t)})},f.rosterChangedHandlerPromise=function(a){return f.isTelJid(a.jid)?(r.debug('[contactService] Contact changed ('+a.jid+') ignored'),e.when()):e(function(e){var n=a.subscription,o=a.ask,i=a.jid;f.getOrCreateContact(i).then(function(i){'remove'===n?(i.ask='none',i.subscription='none',i.roster=!1):(i.ask=o,i.subscription=n,i.roster=!0,'both'===n&&f.updatePresence(!0)),i.updateRichStatus(),f.sendUpdateEvent(i),t.$broadcast('ON_CONTACT_ROSTER_UPDATE_EVENT'),r.info('[contactService] rosterChangedHandler - contact '+a.jid+' changed ('+o+', '+n+') success'),e()}).catch(function(t){r.error('[contactService] rosterChangedHandler - contact '+a.jid+' failure - '+t.message),e()})})},this.updateUserContact=function(t){r.info('[contactService] updateUserContact');var a=e.defer(),n=config.restServerUrl+'/api/rainbow/enduser/v1.0/';return o({method:'PUT',url:n+'users/'+s.userId,headers:s.getPostHeader(),data:t}).then(function(e){r.info('[contactService] updateUserContact successfully'),f.userContact.updateFromUserData(e.data.data),a.resolve()},function(e){var t=m.handleError(e);a.reject(t),r.error('[contactService] '+m.getErrorFullMessage(e,'updateUserContact'))}),a.promise},f.updateUserPassword=function(t,a,n){var i=e.defer();return f.changePasswordInfo={defered:i,newPassword:a},o({method:'PUT',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userId+'/change-password',headers:s.getPostHeader(),data:{oldPassword:t,newPassword:a}}).then(function(){r.info('[contactService] updateUserPasswordRequest -- success'),n||i.resolve()}).catch(function(e){r.error('[contactService] '+m.getErrorFullMessage(e,'updateUserPasswordRequest')),f.changePasswordInfo=null,i.reject(m.handleError(e))}),i.promise},this.deleteUserAccount=function(){return e(function(e,t){r.info('[contactService] deleteUserAccount'),o({method:'DELETE',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+f.userContact.dbId,headers:s.getRequestHeader()}).then(function(){r.info('[contactService] deleteUserAccount -- success'),e()}).catch(function(e){r.error('[contactService] '+m.getErrorFullMessage(e,'deleteUserAccount')),t(m.handleError(e))})})},this.isTelJid=function(e){return 0===e.indexOf('tel_')},this.getImJid=function(e){var t=i.getBareJidFromJid(e);if(this.isTelJid(t)){var a=this.jtelContacts[t];return a?a.jid:(r.warn('[contactService] -- getIMJid('+e+') -- failure -- no associated contact'),null)}return t},this.getRessourceFromJid=function(e){var t='';if(e){var a=e.indexOf('/');-1!==a&&(t=e.substr(a+1))}return t},this.isUserContactJid=function(e){return!!(f.userContact&&e&&0!==e.length)&&e.startsWith(f.userContact.jid)},this.isUserContact=function(e){return!!(e&&e.jid&&0!==e.jid.length)&&(f.userContact?e.jid.startsWith(f.userContact.jid):e.jid.startsWith(i.jid))},f.updateContactsLastActivity=function(){f.contacts&&Object.keys(f.contacts).forEach(function(e){f.contacts[e].updateLastActivityMessage()})},f.updateLastActivity=function(e){e.lastActivityDate='offline'===e.status||'away'===e.status?e.getLastAvailableDate():null},this.createBotContact=function(e,t,a){var r;return r=f.contacts[e]?d.updateContactToBot(f.contacts[e],t,a):d.createBotContact(e,t,a),f.contacts[r.id]=r,r},this.contactPresenceChangedHandler=function(e,t){if('calendar'!==f.getRessourceFromJid(t.jid)){var a=f.getImJid(t.jid);!a||a.startsWith('room')||f.getOrCreateContact(a).then(function(e){f.isTelJid(t.jid)?(r.info('[contactService] Update telephony presence ('+a+') : '+t.message),e.updateTelephonyStatus(t.message,f.isUserContact(e))):(r.info('[contactService] Update im presence contact ('+a+') : '+t.status+' '+t.stamp),f.isUserContact(e)&&'mode=auto'===t.message&&'online'!==e.status&&e.resources.hasOwnProperty(t.jid)&&t.jid!==e.fullJid&&'EVT_SERVICE_INITIATED'!==e.telStatus&&'EVT_ESTABLISHED'!==e.telStatus&&(e.resources[e.fullJid]&&'online'===e.resources[e.fullJid].show?r.info('[contactService] Current ressource is already online, ignore message!'):(f.manualState&&(r.info('[contactService] User is in manual state, leave it'),f.setUserContactStatus('online','mode=auto')),f.busyState&&'dnd'===f.busyState.status&&'busy'!==f.userContact.status&&(r.info('[contactService] User is in call, re-update presence state'),c(function(){f.updatePresence(!0)},500,1,!0)))),e.updateIMStatus(t,f.isUserContact(e)),f.updateLastActivity(e)),f.sendUpdateEvent(e)})}},this.contactCalendarPresenceChangedHandler=function(e,t){t.updateCalendarPresenceInfo()},this.setUserContactStatus=function(e,t,a){try{if(r.info('[contactService] Set userContact status : '+e+(t?'('+t+')':'')),i.started)'online'===e?(f.manualState=!1,i.sendPresence(null,t,a)):(f.manualState=!0,'away'===e?i.sendPresence('away',t):'dnd'===e?i.sendPresence('dnd',t):'xa'==e&&i.sendPresence('xa',t));else if('online'===e){var o=n.get('serviceLauncher');o.startServices()}}catch(e){r.error('[contactService] Set userContact status error : '+e)}},this.sendPresenceFromConfiguration=function(a){r.info('(with auth info)');var n=e.defer();return f.getUserSettings().then(function(e){var o='',i=e.presence;if('invisible'===i?i='xa':'away'==i&&(i='xa',o='away'),r.info('[contactService] sendPresenceFromConfiguration -> getUserSettings are '+i+' || message : '+o),f.userContact&&f.userContact.resources&&f.userContact.resources[f.userContact.fullJid]){var s=f.userContact.resources[f.userContact.fullJid];s&&(s.show!==i||'xa'===s.show&&s.status!==o)?(!f.busyState||'dnd'!==f.busyState.status||f.manualState)&&(r.info('[contactService] sendPresenceFromConfiguration should update my status from '+s.show+' to '+i+' ('+o+')'),f.setUserContactStatus(i,o,a)):t.$broadcast('ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT')}else r.info('[contactService] sendPresenceFromConfiguration set initial presence '),f.setUserContactStatus(i,o,a);n.resolve()}).catch(function(){r.info('[contactService] sendPresenceFromConfiguration failure, send online'),f.setUserContactStatus('online',null,a),n.resolve()}),n.promise},f.updateUserSettings=function(e,t){var a='online';'xa'===e&&'away'===t?a='away':'dnd'===e?a='dnd':'xa'==e&&(a='invisible'),f.setUserSettings({presence:a})};var S=null,C;this.onPresentationModeChangedEvent=function(e,t){'active'===t?f.presentationModeActive=!0:'disable'==t&&(f.presentationModeActive=!1),null===S&&(r.debug('[contactService] onPresentationModeChangedEvent status:'+t+' request presence update'),S=f.presentationModeActive,f.updatePresence()),v()},this.changeMyPresence=function(e){if(r.info('[contactService] changeMyPresence '+e+' '+f.userContact.message),('dnd'!==e||'presentation'!==f.userContact.message)&&'busy'!==e){var t='';'online'===e&&(t='mode=auto'),'away'===e&&(e='xa',t='away'),f.setUserContactStatus(e,t),'online'===e&&c(function(){f.manualState=!1,f.updatePresence()},1e3,1,!0),f.updateUserSettings(e,t)}},this.computeStatusList=function(){var e=[];return f.userContact&&f.userContact.status&&(r.info('[contactService] computeStatusList '+f.userContact.status+' '+f.userContact.message),e='offline'===f.userContact.status?['online']:'busy'===f.userContact.status?['busy']:'dnd'===f.userContact.status&&'presentation'===f.userContact.message?['dnd']:['online','away','xa','dnd']),e},this.resetBusyState=function(){r.info('[contactService] resetBusyState'),f.setBusyState(null,null,!0),f.sendPresenceFromConfiguration()},this.setBusyState=function(e,t,a){r.info('[contactService] setBusyState -- '+e+' -- '+t),f.busyState={status:e,message:t},a||f.updatePresence()},t.$on('$destroy',t.$on('ON_PRESENTATION_MODE_CHANGED_EVENT',f.onPresentationModeChangedEvent)),this.updatePresence=function(e){r.info('[contactService] updatePresence'),f.manualState?(r.info('[contactService] updatePresence manualState'),'away'===f.userContact.status&&f.busyState&&'dnd'===f.busyState.status&&(f.setUserContactStatus('online','mode=auto'),c(function(){f.updatePresence()},1e3,1,!0))):!f.presentationModeActive||f.busyState&&f.busyState.status?f.busyState&&'dnd'===f.busyState.status?(r.info('[contactService] updatePresence dnd '+f.busyState.message),i.sendPresence('dnd',f.busyState.message)):f.awayStateActive?(r.info('[contactService] updatePresence away'),i.sendPresence('away','')):f.userContact&&'online'!==f.userContact.status?(r.info('[contactService] updatePresence online'),f.setUserContactStatus('online')):e&&f.userContact&&'online'===f.userContact.status&&(r.info('[contactService] updatePresence forced online'),f.setUserContactStatus('online')):(r.info('[contactService] updatePresence dnd presentation'),i.sendPresence('dnd','presentation'))},this.removeContact=function(t){return e(function(e,a){return t?void(r.info('[contactService] removeContact : '+t.displayNameForLog()),f.removeContactFromRoster(t.dbId).then(function(){r.info('[contactService] removeContact : '+t.displayNameForLog()+' success'),e()}).catch(function(e){r.error('[contactService] removeContact: '+t.displayNameForLog()+' failure : '+e.message),a(e)})):(r.error('[contactService] removeContact : missing contact !'),void a())})},this.removeContactFromRoster=function(t){return e(function(e,a){if(!t)return r.error('[contactService] removeContactFromRoster : missing id !'),void a();r.info('[contactService] removeContactFromRoster for id '+t);var n=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/networks/'+t;o({method:'DELETE',url:n,headers:s.getRequestHeader()}).then(function(){r.info('[contactService] removeContactFromRoster success for id '+t),e()},function(e){var t='removeContactFromRoster failure: no server response';e&&(t='removeContactFromRoster failure: '+JSON.stringify(e)),r.error('[contactService] '+t),a(new Error(t))})})},this.sendUpdateEvent=function(e){var a=f.isUserContact(e)?'ON_USER_CONTACT_UPDATED_EVENT':'ON_CONTACT_UPDATED_EVENT';t.$broadcast(a,e)},this.myMobileAvailable=function(){return f.userContact?f.userContact.mobileResource:null},this.notifyImByEmail=function(t){return e(function(e,a){o({method:'POST',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/notifications/emails/offline',headers:s.getRequestHeader(),data:{userId:t.dbId}}).then(function(t){var a='';t.data&&t.data.data&&t.data.data.email&&(a=t.data.data.email.substr(0,3)+'***'+t.data.data.email.substr(-3)),r.info('[contactService] notifyImByEmail '+a+' - success'),e()},function(e){r.error('[contactService] notifyImByEmail failure ('+e.data.errorDetailsCode+') : '+e.data.errorDetails.errorMsg),a(e)})})}}])},function(){(function(){'use strict';angular.module('rainbow').service('botService',['$http','$q','$log','authService','contactService','conversationService',function(e,t,a,r,n,o){var i=this;i.init=function(){i.bots=[],i.emily=null,this.portalURL=config.restServerUrl+'/api/rainbow/enduser/v1.0/'},i.start=function(e){a.info('[botService] === STARTING ===');var r=performance.now();return t(function(t,n){i.init(),i.getBots().then(function(){a.info(''),i.findEmily(),i.unlockWaitingConversations();var n=Math.round(performance.now()-r);e.push({service:'botService',startDuration:n}),a.info('[botService] === STARTED ('+n+' ms) ==='),a.info(''),t()}).catch(function(e){a.info('[botService] === STARTING FAILURE === '+e.message),n()})})},i.stop=function(){a.info('[botService] === STOPPED ===')},i.getBots=function(){return t(function(t,n){e({method:'GET',url:i.portalURL+'bots',headers:r.getRequestHeader()}).then(function(e){a.info('[botService] getBots success'),i.bots=e.data.data,t(i.bots)}).catch(function(e){var t='getBots failure '+e.data.errorDetails+' with status '+e.status;a.error('[botService] '+t),n(new Error(t))})})},i.findEmily=function(){i.bots.forEach(function(e){'Emily'===e.name&&(i.emily=e,a.info('[botService] Emily is found'),n.createBotContact(i.emily.jid,i.emily.name,i.emily.id))})},i.getEmily=function(){return i.emily},i.openConversationWithEmily=function(){return t(function(e,t){a.info('[botService] openConversationWithEmily');var r=n.getContactByJid(i.emily.jid);o.getOrCreateOneToOneConversation(r.jid).then(function(t){o.setActiveConversation(t),e(t)}).catch(function(){a.error('[botService] openConversationWithEmily failure'),t()})})},i.unlockWaitingConversations=function(){o.unlockWaitingBotConversations(!0)}}])})()},function(){angular.module('rainbow').service('conversationService',['$q','$log','$rootScope','$http','$interval','xmppService','authService','contactService','Conversation','Call','videoService','telephonyService','roomService','settingsService','ConversationServiceEventHandler','ConversationServiceHistoryHandler','utilService','profileService','SearchTextConvResultsFactory','pstnConferenceService','webrtcGatewayService',function(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f,S,C,h,E){'use strict';var R=this;this.started=!1;var b=5;R.start=function(r){t.info(''),t.info('[conversationService] === STARTING ===');var n=e.defer(),o=performance.now();return this.pendingMessages={},this.activeConversation=null,this.conversations=[],this.inCallConversations=[],this.idleConversations=[],this.involvedContactIds=[],this.favoriteConversations=[],this.searchTextResults=C(),this.waitingBotConversations=[],this.botServiceReady=!1,this.isBasicCallAllowed=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_BASIC_CALL),this.isSecondCallAllowed=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_SECOND_CALL),this.attachHandlers(),R.getServerConversations().then(function(){R.started=!0,R.linkAllActiveCallsToConversations();var e=Math.round(performance.now()-o);r.push({service:'conversationService',startDuration:e}),t.info('[conversationService] === STARTED ('+e+' ms) ==='),n.resolve()}).catch(function(e){t.info('[conversationService] === STARTING FAILURE === '+e.message),n.reject(e)}),this.contactUpdateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_CONTACT_UPDATED_EVENT, rehandle it'),this.contactUpdateEventHandlerCleaner()),this.contactUpdateEventHandlerCleaner=a.$on('ON_CONTACT_UPDATED_EVENT',this.onContactChangedEvent),this.roomUpdateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event '+u.ROOM_UPDATE_EVENT+', rehandle it'),this.roomUpdateEventHandlerCleaner()),this.roomUpdateEventHandlerCleaner=a.$on(u.ROOM_UPDATE_EVENT,this.onRoomChangedEvent),this.roomAddConferenceEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event '+u.ROOM_ADD_CONF_ENDPOINT_EVENT+', rehandle it'),this.roomAddConferenceEventHandlerCleaner()),this.roomAddConferenceEventHandlerCleaner=a.$on(u.ROOM_ADD_CONF_ENDPOINT_EVENT,this.onRoomAddConferenceEvent),this.roomHistoryUpdateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event '+u.ROOM_HISTORY_UPDATE_EVENT+', rehandle it'),this.roomHistoryUpdateEventHandlerCleaner()),this.roomHistoryUpdateEventHandlerCleaner=a.$on(u.ROOM_HISTORY_UPDATE_EVENT,this.onRoomHistoryChangedEvent),this.roomAdminMessageEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event '+u.ROOM_ADMIN_MESSAGE_EVENT+', rehandle it'),this.roomAdminMessageEventHandlerCleaner()),this.roomAdminMessageEventHandlerCleaner=a.$on(u.ROOM_ADMIN_MESSAGE_EVENT,this.onRoomAdminMessageEvent),this.callUpdateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_CALL_UPDATED_EVENT, rehandle it'),this.callUpdateEventHandlerCleaner()),this.callUpdateEventHandlerCleaner=a.$on('ON_CALL_UPDATED_EVENT',this.onCallEvent),this.conversationUpdateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_CONVERSATIONS_UPDATED_EVENT, rehandle it'),this.conversationUpdateEventHandlerCleaner()),this.conversationUpdateEventHandlerCleaner=a.$on('ON_CONVERSATIONS_UPDATED_EVENT',this.onConversationEvent),this.capacityUpdateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_UPDATE_MYCONTACT_EVENT, rehandle it'),this.capacityUpdateEventHandlerCleaner()),this.capacityUpdateEventHandlerCleaner=a.$on('ON_UPDATE_MYCONTACT_EVENT',this.onMyContactChangedEvent),this.telephonyStateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_TELEPHONY_STATUS_CHANGED_EVENT, rehandle it'),this.telephonyStateEventHandlerCleaner()),this.telephonyStateEventHandlerCleaner=a.$on('ON_TELEPHONY_STATUS_CHANGED_EVENT',this.onTelephonyStateChangeEvent),this.conferenceStateEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_CONFERENCE_STATE_EVENT, rehandle it'),this.conferenceStateEventHandlerCleaner()),this.conferenceStateEventHandlerCleaner=a.$on('ON_CONFERENCE_STATE_EVENT',this.onConferenceStateChangeEvent),this.conferenceParticipantsEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_CONFERENCE_PARTICIPANT_EVENT, rehandle it'),this.conferenceParticipantsEventHandlerCleaner()),this.conferenceParticipantsEventHandlerCleaner=a.$on('ON_CONFERENCE_PARTICIPANT_EVENT',this.onConferenceParticipantChangeEvent),this.reloadCapabilitiesForMyContactEventHandlerCleaner&&(t.warn('[conversationService] already subscribed to event ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT, rehandle it'),this.reloadCapabilitiesForMyContactEventHandlerCleaner()),this.reloadCapabilitiesForMyContactEventHandlerCleaner=a.$on('ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT',this.onReloadCapabilitiesForMyContactEvent),n.promise},this.attachHandlers=function(){this.removeHandlers(),t.info('[conversationService] attachHandlers'),this.conversationHistoryHandler=v.create(this),this.conversationServiceEventHandler=g.create(this),o.addHistoryHandler(function(e){return R.conversationHistoryHandler.onHistoryMessageReceived(e)}),o.addSearchTextHandler(function(e,a){if(t.info('[conversationService] addSearchTextHandler'),R.searchTextResults.isCurrentQuery(e)){t.info('[conversationService] searchText: queryId are matching');var r=R.conversationHistoryHandler.onSearchTextMessageReceived(a);r&&(t.info('[conversationService] searchText: save item result'),R.searchTextResults.addNewItemResult(r.otherJid,r))}else t.info('[conversationService] searchText: queryId are NOT matching : '+e)}),this.messageHandlerRef||(this.messageHandlerRef=o.addHandler(function(e){return R.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,'message','chat')),this.messageMucHandlerRef||(this.messageMucHandlerRef=o.addHandler(function(e){return R.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,'message','groupchat')),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=o.addHandler(function(e){return R.conversationServiceEventHandler.onFileMessageReceived(e),!0},null,'message','file')),this.webrtcMessageHandlerRef||(this.webrtcMessageHandlerRef=o.addHandler(function(e){return R.conversationServiceEventHandler.onWebRTCMessageReceived(e),!0},null,'message','webrtc')),this.convMessageHandlerRef||(this.convMessageHandlerRef=o.addHandler(function(e){return R.conversationServiceEventHandler.onManagementMessageReceived(e),!0},null,'message','management')),this.receiptMessageHandlerRef||(this.receiptMessageHandlerRef=o.addHandler(function(e){return R.conversationServiceEventHandler.onReceiptMessageReceived(e),!0},null,'message')),this.audioConfMessageHandlerRef||(this.audioConfMessageHandlerRef=o.addHandler(function(e){return R.conversationServiceEventHandler.onConferenceMessageReceived(e),!0},'jabber:x:audioconference','message','chat'))},this.removeHandlers=function(){t.info('[conversationService] removeHandlers '),this.conversationHistoryHandler&&(this.conversationHistoryHandler=null),this.conversationServiceEventHandler&&(this.conversationServiceEventHandler=null),this.messageHandlerRef&&(o.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(o.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(o.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.convMessageHandlerRef&&(o.deleteHandler(this.convMessageHandlerRef),this.convMessageHandlerRef=null),this.receiptMessageHandlerRef&&(o.deleteHandler(this.receiptMessageHandlerRef),this.receiptMessageHandlerRef=null),this.messageMucHandlerRef&&(o.deleteHandler(this.messageMucHandlerRef),this.messageMucHandlerRef=null),this.recordingMessageHandlerRef&&(o.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(o.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null)},R.stop=function(){return t.info('[conversationService] === STOPPING ==='),this.conversations=null,this.messageHandlerRef&&(o.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(o.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(o.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.recordingMessageHandlerRef&&(o.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(o.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null),this.contactUpdateEventHandlerCleaner&&(this.contactUpdateEventHandlerCleaner(),this.contactUpdateEventHandlerCleaner=null),this.roomUpdateEventHandlerCleaner&&(this.roomUpdateEventHandlerCleaner(),this.roomUpdateEventHandlerCleaner=null),this.roomAddConferenceEventHandlerCleaner&&(this.roomAddConferenceEventHandlerCleaner(),this.roomAddConferenceEventHandlerCleaner=null),this.roomAdminMessageEventHandlerCleaner&&(this.roomAdminMessageEventHandlerCleaner(),this.roomAdminMessageEventHandlerCleaner=null),this.callUpdateEventHandlerCleaner&&(this.callUpdateEventHandlerCleaner(),this.callUpdateEventHandlerCleaner=null),this.conversationUpdateEventHandlerCleaner&&(this.conversationUpdateEventHandlerCleaner(),this.conversationUpdateEventHandlerCleaner=null),this.capacityUpdateEventHandlerCleaner&&(this.capacityUpdateEventHandlerCleaner(),this.capacityUpdateEventHandlerCleaner=null),this.telephonyStateEventHandlerCleaner&&(this.telephonyStateEventHandlerCleaner(),this.telephonyStateEventHandlerCleaner=null),this.started=!1,t.info('[conversationService] === STOPPED ==='),e.when()},R.getServerConversations=function(){var a=e.defer();return r({method:'GET',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId+'/conversations',headers:i.getRequestHeader()}).then(function(r){var n=[];r.data.data.forEach(function(e){var t=parseInt(e.unreadMessageNumber,10),a=null,r=!0===e.mute;a='user'===e.type?R.getOrCreateOneToOneConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,t,r,e.creationDate,e.isFavorite):R.getRoomConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,t,!0,r,e.creationDate,e.isFavorite,e.lastMessageSender,e.topic,e.type),n.push(a)}),e.all(n).then(function(){return R.removeOlderConversations()}).then(function(){R.orderConversations(),a.resolve()}).catch(function(e){var r='getServerConversations failure: '+e.message;t.error('[conversationService] '+r),a.reject(new Error(r))})},function(e){var r='getServerConversations failure: no server response';e&&(r='getServerConversations failure: '+JSON.stringify(e)),t.error('[conversationService] '+r),a.reject(new Error(r))}),a.promise},this.createServerConversation=function(a){var n=e.defer();if(a.dbId)return e.when(a);var o={};if(a.type===d.Type.ONE_TO_ONE){if(!a.contact.dbId)return e.when(a);o.peerId=a.contact.dbId,o.type='user'}else if(a.type===d.Type.BOT){if(a.type=d.Type.ONE_TO_ONE,!a.contact.dbId)return e.when(a);o.peerId=a.contact.dbId,o.type='bot'}else o.peerId=a.room.dbId,o.type='room';if(a.room&&a.room.avatar)var c=a.room.avatar;return r({method:'POST',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId+'/conversations',headers:i.getRequestHeader(),data:o}).then(function(e){t.info('[conversationService] createServerConversation success: '+a.id),a.dbId=e.data.data.id,a.lastModification=e.data.data.lastMessageDate?new Date(e.data.data.lastMessageDate):void 0,a.creationDate=e.data.data.creationDate?new Date(e.data.data.creationDate):new Date,a.missedCounter=e.data.data.unreadMessageNumber?parseInt(e.data.data.unreadMessageNumber,10)||0:0,c&&(a.room.avatar=c),R.orderConversations(),n.resolve(a)},function(e){var a='createServerConversation failure: '+e.data.errorDetails;t.warn('[conversationService] '+a),n.reject(new Error(a))}),n.promise},this.deleteServerConversation=function(a){var n=e.defer();return a?(r({method:'DELETE',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId+'/conversations/'+a,headers:i.getRequestHeader()}).then(function(){t.info('[conversationService] deleteServerConversation success: '+a),R.orderConversations(),n.resolve()},function(e){if(404002===e.data.errorDetailsCode)t.info('[conversationService] deleteServerConversation success: '+a),n.resolve();else{var r='deleteServerConversation failure: '+e.data.errorDetails;t.warn('[conversationService] '+r),n.reject(new Error(r))}}),n.promise):e.when()},this.isAddingFavoritePossible=function(){return 10>R.favoriteConversations.length},this.updateServerConversation=function(a){var n=e.defer();return a?(r({method:'PUT',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId+'/conversations/'+a.dbId,headers:i.getPostHeader(),data:{mute:a.muted,isFavorite:a.isFavorite}}).then(function(){t.info('[conversationService] updateServerConversation success: '+a.dbId),n.resolve()},function(e){var a='updateServerConversation failure: '+e.data.errorDetails;t.warn('[conversationService] '+a),n.reject(new Error(a))}),n.promise):e.when()},this.ackAllMessages=function(a){return e(function(e,n){if(!a)return t.error('[conversationService] ackAllMessages for conversation error -- missing conversation id'),void n();var o=R.getConversationByDbId(a);return o?void(t.info('[conversationService] ackAllMessages for conversation '+a),o.ackReadAllMessages(),r({method:'PUT',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId+'/conversations/'+a+'/markallread',headers:i.getPostHeader()}).then(function(){t.info('[conversationService] ackAllMessages success: '+a),e()},function(e){var a='ackAllMessages failure: '+e.data.errorDetails;t.warn('[conversationService] '+a),n(new Error(a))})):(t.error('[conversationService] ackAllMessages for conversation error -- can not find conversation'),void n())})},this.getOrCreateOneToOneConversation=function(r,n,o,i,c,l,p,u){t.info('[conversationService] getOrCreateOneToOneConversation '+r+' '+n+' '+c);var m=R.getConversationById(r);if(m)return m.preload=!0,e.when(m);var g=e.defer();return s.getOrCreateContact(r).then(function(e){var t=d.createOneToOneConversation(e);return t.lastModification=o?new Date(o):void 0,t.lastMessageText=i,t.muted=l,t.isFavorite=u,t.creationDate=p?new Date(p):new Date,t.preload=!1,R.computeCapabilitiesForContact(e),t.dbId=n,c&&(t.missedCounter=c),R.conversations[e.id]=t,R.createServerConversation(t)}).then(function(e){a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',e,d.EventType.NEW),g.resolve(e)}).catch(function(e){var a='getOrCreateOneToOneConversation '+r+' failure '+e.message;t.error('[conversationService] '+a),g.reject(new Error(a))}),g.promise},this.getRoomConversation=function(r,n,o,i,s,c,l,p,m,g,v,f){t.info('[conversationService] getRoomConversation '+r);var S=R.getConversationById(r);return S?(S.preload=!0,e.when(S)):e(function(e,C){var h=u.getRoomByJid(r);if(!h){'bot'!==f&&t.error('[conversationService] getRoomConversation ('+r+') failure : no such room');R.waitingBotConversations.push({jid:r,conversationDbId:n,lastModification:o,lastMessageText:i,missedIMCounter:s,muted:l,isFavorite:m,creationDate:p}),R.unlockWaitingBotConversations(),e()}else S=d.createRoomConversation(h),S.dbId=n,S.lastModification=o?new Date(o):void 0,S.lastMessageText=i,S.muted=l,S.isFavorite=m,S.creationDate=p?new Date(p):new Date,S.preload=!1,S.lastMessageSender=g,S.room&&v&&(S.room.desc=v),s&&(S.missedCounter=s),R.conversations[S.id]=S,n?R.getRoomConferences(S).then(function(){a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',S,d.EventType.NEW),e(S)}):R.createServerConversation(S).then(function(t){h&&'unsubscribed'!==h.status&&u.sendInitialRoomPresence(h),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',t,d.EventType.NEW),e(t)}).catch(function(a){var o='getRoomConversation ('+r+') failure : '+a.message;t.error('[conversationService] '+o),R.deleteServerConversation(n),c?e():C(new Error(o))})})},R.getRoomConferences=function(t){return e(function(e){var a=t.room.confEndpoints;a&&a.forEach(function(e){if('pstnAudio'===e.mediaType){var a=h.getConferenceSessionById(e.confEndpointId);a&&(t.pstnConferenceSession=a)}}),e()})},R.updateRoomConferences=function(){var e=R.getConversations();e.forEach(function(e){if(e.room&&e.room.confEndpoints){var t=h.getConferenceSessionById(e.room.getPstnConfEndpointId());e.pstnConferenceSession=t?t:null}else e.pstnConferenceSession=null})},this.closeConversation=function(a){return e(function(e,r){t.info('[conversationService] closeConversation '+a.id),R.deleteServerConversation(a.dbId).then(function(){R.removeConversation(a),e()}).catch(function(e){r(e)})})},this.removeConversation=function(e){if(t.info('[conversationService] remove conversation '+e.id),e.videoCall&&e.videoCall.status!==c.Status.UNKNOWN)return void t.info('[conversationService] Ignore conversation deletion message for conversation'+e.id);delete R.conversations[e.id],R.orderConversations();var r=R.getOrderedConversations();R.activeConversation&&!(0<=r.idle.indexOf(R.activeConversation))&&(0<r.idle.length?R.setActiveConversation(r.idle.first()):0<r.inCall.length?R.setActiveConversation(r.inCall.first()):R.setActiveConversation(null)),e.contact&&(e.contact.conversation=null,e.contact=null),a.$broadcast('ON_CONVERSATION_REMOVE_EVENT',e)},this.getConversationByDbId=function(e){if(R.conversations)for(var t in R.conversations)if(R.conversations.hasOwnProperty(t)&&R.conversations[t].dbId===e)return R.conversations[t];return null},this.getConversationByRoomDbId=function(e){if(R.conversations)for(var t in R.conversations)if(R.conversations.hasOwnProperty(t)&&R.conversations[t].room&&R.conversations[t].room.dbId===e)return R.conversations[t];return null},this.removeOlderConversations=function(){var a=parseInt(m.getSetting('nbMaxConversations'),10);(!a||15>a)&&(m.setSetting('nbMaxConversations',15),a=15);var r=R.getNotFavoritesConversations().sort(R.sortFunction);if(t.info('[conversationService] removeOlderConversations -- maxConversations : '+a),r.length>a){t.info('[conversationService] removeOlderConversations -- orderedConversations : '+r.length);for(var n=[],o=a;o<r.length;o++)n.push(R.closeConversation(r[o]));return e.all(n)}return e.when()},this.searchConversations=function(e){var t=f.removeDiacritis(e.toLowerCase()).trim().split(/[ ]+/);return R.getOrderedConversations().idle.filter(function(e){var a=e.filterName.trim().split(/[ ]+/),r=t.every(function(e){return a.some(function(t){return!!(t.length&&0===t.indexOf(e))})});return r})},this.searchFavoritesConversations=function(e){var t=f.removeDiacritis(e.toLowerCase()).trim().split(/[ ]+/);return R.getOrderedConversations().favorites.filter(function(e){var a=e.filterName.trim().split(/[ ]+/),r=t.every(function(e){return a.some(function(t){return!!(t.length&&0===t.indexOf(e))})});return r})},this.sendFSMessage=function(t,r,n){var o=e.defer();return n&&0!==n.length||(n=r.name),t.sendFSMessage(r,n).then(function(e){R.pendingMessages[e.id]={conversation:t,message:e},o.resolve(e)},function(e){var t=e.translatedMessage?e.translatedMessage:'Unable to share file';a.$broadcast('ON_OPEN_GLOBAL_POPUP',{popupTitle:'fileTransfer',popupBodyTranslated:t,okLabel:'ok'}),o.reject(e)}),o.promise},this.sendEFSMessage=function(e,t,r){var n=e.sendEFSMessage(t,r);return this.pendingMessages[n.id]={conversation:e,message:n},a.$broadcast('ON_SEND_EFS_MESSAGE',t),n},this.sendChatMessage=function(e,t){var a=e.sendChatMessage(t,null);return this.pendingMessages[a.id]={conversation:e,message:a},a},this.sendAnswerChatMessage=function(e,t,a){var r=e.sendChatMessage(t,a);return this.pendingMessages[r.id]={conversation:e,message:r},r},this.sendIsTypingState=function(e,t){e.sendIsTypingState(t)},this.sendRecordingMessage=function(e,t){var a=e.sendRecordingMessage(t);return this.pendingMessages[a.id]={conversation:e,message:a},a},this.sendCorrectedChatMessage=function(e,t,a){var r=e.getMessageById(a),n=e.sendCorrectedChatMessage(r,t,a);return this.pendingMessages[n]={conversation:e,message:r},r},this.removeAllMessages=function(a){t.info('[conversationService] removeAllMessage '+a.id);var r=e.defer(),n=o.connection.getUniqueId(),i={queryid:n,with:a.id,onComplete:function(){r.resolve()}},s=o.connection.getUniqueId();return o.connection.mam.delete(s,i),r.promise},this.removeMessagesFromConversation=function(a,r,n){t.info('[conversationService] removeMessagesFromConversation '+a.id),t.info('[conversationService] removing '+n+' messages after '+r);var i=e.defer(),s={queryid:'remove_'+a.id,with:a.id,start:moment(r).format('YYYY-MM-DDTHH:mm:ss.SSSSSSZ'),max:n,onComplete:function(){t.info('[conversationService] MAM Message deleted !!!'),i.resolve()}};return o.connection.mam.delete(a.id,s),i.promise},this.sendConversationByEmail=function(a){var n=e.defer(),o=s.userContact,d=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+o.dbId+'/conversations/'+a.dbId+'/downloads';return r({method:'POST',url:d,headers:i.getRequestHeader(),data:{}}).then(function(){t.error('[conversationService] sendConversationByEmail - success'),n.resolve()},function(e){var a={message:'Impossible to download conversation'};e&&e.data&&409011===e.data.errorDetailsCode&&(a.message='No messages to export for the last 30 days.',a.messageKey='noMessagesToExport'),t.error('[adminUserService] sendConversationByEmail - '+a.message),n.reject(a)}),n.promise},this.getHistoryPage=function(e,t){return R.conversationHistoryHandler.getHistoryPage(e,t)},this.getHistoryPageAroundMsg=function(e,t){return R.conversationHistoryHandler.getHistoryPageAroundMsg(e,20,t+'000')},this.retrieveMsgByDate=function(e,a){return t.debug('[conversationService] >retrieveMsgByDate: '+a),R.conversationHistoryHandler.retrieveMsgByDate(e,a+'000')},this.clearSearchText=function(){t.debug('[conversationService] - clearSearchText'),this.searchTextResults.clearAll()},this.clearAndGetAllMessagesResults=function(a,r){t.debug('[conversationService] - clearAndGetAllMessagesResults'),this.searchTextResults.clearAll(),this.searchTextResults.searchCount();var n=[];r.forEach(function(e){e.desc&&(!e.desc||e.desc.startsWith('Rainbow_OutlookCreation_InternalUseOnly'))||n.push(R.searchTextInRoom(s.userContact.jid,e,a,b,R.searchTextResults.searchCounter))}),e.all(n).finally(function(){t.debug('[conversationService] - ALL SearchText Promises finished'),R.searchTextInConversations(a,100)})},this.searchTextInConversations=function(a,r){t.debug('[conversationService] - searchTextInConversations: '+a);var n=e.defer(),i=o.connection.getUniqueId();return this.searchTextResults.queryIds.push(i),this.searchTextResults.searchedText=a,t.debug('[conversationService] - searchTextResults QueryId: '+i),R.conversationHistoryHandler.searchTextInConversations(i,a,r).then(function(e){R.searchTextResults.totalCount+=parseInt(e,10),R.searchTextResults.results.forEach(function(r){if(r.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1}),!r.isRoom()){R.getConversationTextCount(a,r.otherJid).then(function(e){r.totalCount=parseInt(e,10)});var o=s.getContactByJid(r.otherJid);o?(r.contact=o,!o.avatar&&o.getAvatar()):s.getContactsByJids([r.otherJid]).then(function(){if(t.info('[conversations] getContactsByJids success'),o=s.getContactByJid(r.otherJid),o)r.contact=o,o.avatar||o.getAvatar();else{t.info('[conversations] Contact with Id '+r.otherJid+' not Found');var e=R.searchTextResults.results.indexOf(r);0<=e&&(R.searchTextResults.results.splice(e,1),R.searchTextResults.totalCount-=r.totalCount)}})}n.resolve(parseInt(e,10))})}).catch(function(e){t.warn('[conversationService] - searchTextInConversations: Error '+e.message),n.reject(e)}),n.promise},this.searchTextResultsInConversation=function(a,r){t.debug('[conversationService] - searchTextResultsInConversation: '+a);var n=e.defer(),i=o.connection.getUniqueId();return this.searchTextResults.clearAll(),this.searchTextResults.queryIds.push(i),r.room?R.searchTextInRoom(s.userContact.jid,r.room,a,b,this.searchTextResults.searchCounter).then(function(e){var t=R.searchTextResults.createNewResult(r.id);t.totalCount=parseInt(e,10),t.conversation=r,t.room=r.room,R.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),R.searchTextResults.totalCount=parseInt(e,10),n.resolve(parseInt(e,10))}):R.conversationHistoryHandler.searchTextResultsInConversation(i,a,r.id,b).then(function(e){var t=R.searchTextResults.createNewResult(r.id);t.totalCount=parseInt(e,10),t.contact=r.contact,t.conversation=r,R.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),R.searchTextResults.totalCount=parseInt(e,10),n.resolve(parseInt(e,10))}),n.promise},this.searchTextMoreResultsInConversation=function(a,r,n){t.debug('[conversationService] - searchTextMoreResultsInConversation: '+a);var i=e.defer(),d=o.connection.getUniqueId();return this.searchTextResults.queryIds.push(d),r.room?R.conversationHistoryHandler.searchTextMoreResultsInRoom(d,a,s.userContact.jid,r.room.jid,n+'000',b).then(function(e){R.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),i.resolve(parseInt(e,10))}):R.conversationHistoryHandler.searchTextMoreResultsInConversation(d,a,r.id,n+'000',b).then(function(e){R.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),i.resolve(parseInt(e,10))}),i.promise},this.getConversationTextCount=function(e,a){t.debug('[conversationService] - getConversationTextCount: '+e);var r=o.connection.getUniqueId();return this.searchTextResults.queryIds.push(r),R.conversationHistoryHandler.getConversationTextCount(r,e,a)},this.searchTextInRoom=function(a,r,n,i,s){t.debug('[conversationService] - searchTextInRoom: '+n);var d=e.defer();if(this.searchTextResults.searchCounter!==s)return t.debug('[conversationService] - counter has changed - skip promise'),d.promise;var c=o.connection.getUniqueId();return this.searchTextResults.queryIds.push(c),R.conversationHistoryHandler.searchTextInRoom(c,a,r.jid,n,i).then(function(e){t.info('[conversationService] - searchTextInRoom: Room response received : '+e);var a=parseInt(e,10);0<a&&(R.searchTextResults.totalCount+=a,R.searchTextResults.results.forEach(function(t){t.otherJid===r.jid&&(t.totalCount=parseInt(e,10),t.room=r)})),d.resolve(e)}).catch(function(e){t.warn('[conversationService] - searchTextInRoom: Error '+e.message),d.reject(e)}),d.promise},this.setActiveConversation=function(e){return t.debug('[conversationService] - setActiveConversation: '+(e?e.id:'null')),this.activeConversation=e,this.activeConversation},this.setMostRecentConversationActive=function(){var e=R.getConversations().sort(R.sortFunction);return 0<e.length?this.setActiveConversation(e.first()):this.setActiveConversation(null)},this.getActiveConversation=function(){return this.activeConversation},this.getConversationById=function(e){return R.conversations?R.conversations[e]:null},this.getConversations=function(){var e=[];for(var t in R.conversations)R.conversations.hasOwnProperty(t)&&e.push(R.conversations[t]);return e},this.getNotFavoritesConversations=function(){var e=[];for(var t in R.conversations)R.conversations.hasOwnProperty(t)&&(R.conversations[t].isFavorite||e.push(R.conversations[t]));return e},this.orderConversations=function(){R.inCallConversations=[],R.idleConversations=[],R.involvedContactIds=[],R.favoriteConversations=[],Object.keys(R.conversations).forEach(function(e){var t=R.conversations[e];if(t.isFavorite&&R.favoriteConversations.push(t),t.isInCall()&&!t.isFavorite)R.inCallConversations.push(t);else if(!t.isFavorite&&(R.idleConversations.push(t),t.type===d.Type.ROOM&&t.room.owner&&t.room.isMeetingRoom()&&!t.room.conference.scheduled)){var a=h.getConferenceSessionById(t.room.getPstnConfEndpointId());a&&a.isActive()&&R.idleConversations.pop()}t.type===d.Type.ONE_TO_ONE&&R.involvedContactIds.push(t.contact.id)}),R.idleConversations.sort(R.sortFunction)},this.getOrderedConversations=function(){return{inCall:R.inCallConversations,idle:R.idleConversations,contactIds:R.involvedContactIds,favorites:R.favoriteConversations}},this.sortFunction=function(e,t){var a=e.lastModification,r=e.creationDate,n=t.lastModification,o=t.creationDate,i=r,s=o;return i=!a&&r?r:a,s=!n&&o?o:n,s-i},this.formatDate=function(e){return moment(e).utc().format('YYYY-MM-DDTHH:mm:ss')+'Z'},this.resetConversationMissedCounters=function(e){a.appVisible&&(e.missedCounter=0,e.missedCalls=0,this.updateMissedCounters())},this.decreaseMissedIMCounterForConversation=function(e){0<e.missedCounter&&(e.missedCounter-=1),this.updateMissedCounters()};var y=0,T=0;this.updateMissedCounters=function(){var e=0,t=0,r=[];Object.keys(R.conversations).forEach(function(t){var a=R.conversations[t];0!==a.missedCounter&&(e+=a.missedCounter,r.push(a))});e===y&&t==T||(y=e,T=t,a.$broadcast('ON_MISSED_COUNTER_CHANGED_EVENT',{missedIMCounter:e,missedCallCounter:t,missedIMDetails:r}))},this.dropConversationCall=function(e){e.audioCall&&p.releaseCall(e.audioCall),e.videoCall&&(l.attachLocalMediaStream(!1),l.attachDistantMediaStream(!1),l.releaseCall(e.videoCall))},this.holdConversationCall=function(e){e.audioCall&&(p.holdCall(e.audioCall),e.videoCall&&(l.attachLocalMediaStream(!1),l.attachDistantMediaStream(!1),l.releaseCall(e.videoCall)))},this.retrieveConversationCall=function(e){e.audioCall&&p.retrieveCall(e.audioCall),e.videoCall&&t.error('Not implemented for the moment')},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.updateConversationCall=function(e,t){t.type===c.Type.WEBRTC?e.videoCall=t:t.type===c.Type.PHONE&&(e.audioCall=t),t.setConversationId(e.id),this.computeCapabilitiesForContact(e.contact),R.computeCapabilitiesForMyContact()},this.computeCapabilitiesForContact=function(e,r){var n=!1,o=!1,i=!1,u=!1,m=!1,g=e.status,v=e.fullJid,f=s.userContact;if(e.jid===f.jid)return void this.computeCapabilitiesForMyContact();var S=e.company&&s.userContact.company&&'Rainbow'!==e.company.name&&'Default'!==e.company.name&&e.company.name===s.userContact.company.name,C=this.getConversationById(e.id);if(l.started){var h=C?C.videoCall:null;(!h||h.status===c.Status.UNKNOWN)&&('unknown'===g&&S||'online'===g||'online-mobile'===g||'away'===g||'busy'===g&&'audioPhone'===e.message)&&(o=!0,i=!0)}if(p.started){var E=e.phonePro||e.phonePbx&&e.pbxId||e.mobilePro||e.phonePerso||e.mobilePerso,R=p.getActiveCallsForContact(e);0===R.length&&E&&(n=!0),(0!==R.length||l.getMediaPillarAudioCall())&&v&&(m=!0)}('online'===g||'busy'===g||'away'===g||'dnd'===g)&&(u=!0);var b={telephony:n,webRTC:o,sharedDesktop:i,fileTransfert:u,mediaAvailable:n||o,addMedia:m};(e.isBot||e.displayName&&-1!==e.displayName.indexOf('E-HELPER'))&&(b={telephony:!1,webRTC:!1,sharedDesktop:!1,fileTransfert:!1,mediaAvailable:!1,addMedia:!1}),e.capabilities=b,C&&(C.capabilities=b,!r&&a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',C,d.EventType.CAPABILITIES)),t.info('[conversationService] update capabilities for contact "'+e.displayNameForLog()+'" capabilities (tel:'+n+', webRTC:'+o+', sharing: '+i+', addMedia: '+m+')')},this.computeCapabilitiesForMyContact=function(){var e=!1,a=!1,r=!1,n=s.userContact;if(l.started){var o=l.isUserContactInCall();o||'busy'===n.status&&('busy'!==n.status||'audioPhone'!==n.message)||(a=!0,R.allowDesktopSharing()&&(r=!0)),o&&l.getMediaPillarAudioCall()&&!l.getCurrentSharingCall()&&R.allowDesktopSharing()&&(r=!0)}if(p.started){var i=p.getCalls();(0===i.length&&R.isBasicCallAllowed||1===i.length&&R.isSecondCallAllowed)&&(e=!0)}var d={telephony:e,webRTC:a,sharedDesktop:r,mediaAvailable:e||a};n.capabilities=d,t.info('[conversationService] update capabilities for my contact : capabilities (tel:'+e+', webRTC:'+a+', sharing: '+r+')')},this.onCallEvent=function(e,r){switch(r.type){case c.Type.WEBRTC:if(E.isMediaPillarJid(r.fullJid))return;R.getOrCreateOneToOneConversation(r.contact.id).then(function(e){R.updateConversationCall(e,r),R.orderConversations(),a.$broadcast('ON_CONVERSATION_CALL_UPDATED_EVENT',{conversation:e,call:r})});break;case c.Type.PHONE:if(r.status===c.Status.UNKNOWN&&(r.contact&&!p.getConferenceCallForContact(r.contact)&&l.endAllCallsForContact(r.contact),r.isConference&&n(function(){(r.participants||[]).forEach(function(e){e&&0===p.getActiveCallsForContact(e).length&&l.endAllCallsForContact(e)})},1e3,1)),E.isMediaPillarCallSituation(r)){if(!r.isSecondary)return void a.$broadcast('ON_UPDATE_TELEPHONY_ICON_EVENT');if(r.status===c.Status.RINGING_INCOMMING)return}if(r.status!==c.Status.UNKNOWN&&null!==r.connectionId){t.info('[ConversationService] onCallEvent -- '+r.connectionId+'  -- relevantEquipmentId : '+r.relevantEquipmentId);var o=c.getDeviceIdFromConnectionId(r.connectionId);if(o!==r.relevantEquipmentId&&r.status!==c.Status.ACTIVE)return void a.$broadcast('ON_UPDATE_TELEPHONY_ICON_EVENT')}a.$broadcast('ON_CONVERSATION_CALL_UPDATED_EVENT',{conversation:null,call:r});break;default:}},this.onReloadCapabilitiesForMyContactEvent=function(){t.info('[conversationService] onReloadCapabilitiesForMyContactEvent'),R.computeCapabilitiesForMyContact()},this.onConversationEvent=function(){R.updateMissedCounters()},this.onContactChangedEvent=function(e,t){R.computeCapabilitiesForContact(t),R.computeCapabilitiesForMyContact()},this.onTelephonyStateChangeEvent=function(){var e=R.getConversations();e&&e.forEach(function(e){e.type===d.Type.ONE_TO_ONE&&R.computeCapabilitiesForContact(e.contact)}),R.computeCapabilitiesForMyContact()},this.onConferenceStateChangeEvent=function(){R.updateRoomConferences(),R.orderConversations(),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT')},this.onConferenceParticipantChangeEvent=function(){R.orderConversations(),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT')},this.onRoomChangedEvent=function(e,t,a){if(t){var r=R.getConversationById(t.jid);r&&('remove'===a?R.closeConversation(r):r.room=t)}},this.onRoomHistoryChangedEvent=function(e,t){if(t){var a=R.getConversationById(t.jid);a&&a.chatRenderer&&(a.reset(),a.chatRenderer.loadMore())}},this.onRoomAdminMessageEvent=function(e,a,r,n,o){t.info('[conversationService] onRoomAdminMessageEvent');var i=R.getConversationById(a);i&&'welcome'===n&&i.room&&i.room.ownerContact&&(r=i.room.ownerContact.jid);var d=s.getContactByJid(r);if(i&&d){if(!i.room.owner&&'invitation'===n)return;if(i.room&&i.room.isMeetingRoom())return;R.conversationServiceEventHandler.onRoomAdminMessageReceived(i,d,n,o)}},this.onRoomAddConferenceEvent=function(){t.info('[conversationService] onRoomAddConferenceEvent'),R.orderConversations(),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT')},this.onMyContactChangedEvent=function(){var e=R.getOrderedConversations();e.idle.forEach(function(e){e.type===d.Type.ONE_TO_ONE&&R.computeCapabilitiesForContact(e.contact)}),R.computeCapabilitiesForMyContact()},this.reinit=function(){var a=e.defer();return t.info('[conversationService] Re-initialize conversation service'),R.activeConversation&&(R.activeConversation.reset(),R.activeConversation=null),delete R.conversations,R.conversations=[],R.botServiceReady=!0,R.getServerConversations().then(function(){R.linkAllActiveCallsToConversations(),a.resolve()}).catch(function(){n(function(){t.info('[conversationService] getServerConversations failure, try again'),R.getServerConversations().then(function(){R.linkAllActiveCallsToConversations()})},1e4,1,!0),a.resolve()}),a.promise},this.linkAllActiveCallsToConversations=function(){for(var e in p.calls)if(p.calls.hasOwnProperty(e)){var t=p.calls[e];a.$broadcast('ON_CALL_UPDATED_EVENT',t)}for(var e in l.calls)if(l.calls.hasOwnProperty(e)){var t=l.calls[e];a.$broadcast('ON_CALL_UPDATED_EVENT',t)}},this.unlockWaitingBotConversations=function(e){e&&(R.botServiceReady=!0),R.botServiceReady&&(R.botServiceReady=!1,R.waitingBotConversations.forEach(function(e,t){var a=s.getContactByJid(e.jid);a&&(R.getOrCreateOneToOneConversation(a.jid,null,e.lastModification,e.lastMessageText,e.missedIMCounter,e.muted,e.creationDate,e.isFavorite),R.waitingBotConversations.splice(t,1))}),R.waitingBotConversations=[])}}])},function(){angular.module('rainbow').factory('ConversationServiceEventHandler',['$q','$log','$rootScope','contactService','xmppService','roomService','Conversation','Message','fileStorageService','fileServerService','webrtcGatewayService',function(e,t,a,r,n,o,i,s,d,c,l){'use strict';function p(e){this.conversationService=e}return p.create=function(e){return new p(e)},p.prototype.onChatMessageReceived=function(e){t.info('[ConversationServiceEventHandler] onChatMessageReceived');try{var a=this,n=$(e);return 0<n.find('event').length||0<n.find('propose').length||0<n.find('received').length?t.info('[ConversationServiceEventHandler] onChatMessageReceived ignore the message'):0<n.find('recording').length?(t.info('[ConversationServiceEventHandler] onChatMessageReceived : recording msg case'),this.onRecordingMessageReceived(e)):this.extractStanzaData(e).then(function(t){t.body||t.oob||t.conference?a.handleChatMessage(t):!t.outgoingMessage&&!r.isUserContact(t.participant)&&t.status&&a.handleStatusMessage(t.conversation,t.participant,e)}),!0}catch(e){return t.error('[ConversationServiceEventHandler] onChatMessageReceived ERROR '+e),!0}},p.prototype.onConferenceMessageReceived=function(e){t.info('[ConversationServiceEventHandler] onConferenceMessageReceived');try{var a=this,r=$(e);return 0<r.find('event').length?this.extractStanzaData(e).then(function(e){e.conference&&a.handleChatMessage(e)}):t.info('[ConversationServiceEventHandler] onConferenceMessageReceived ignore the message'),!0}catch(e){return t.error('[ConversationServiceEventHandler] onConferenceMessageReceived ERROR '+e),!0}},p.prototype.onFileTransfertReceived=function(e){var t=n.getBareJidFromJid(e.from),r=this;this.conversationService.getOrCreateOneToOneConversation(t).then(function(t){var n=t.contact,o=i.getUniqueMessageId(),s=t.addFTMessage(n,new Date,e,o);t.setStatusMessage(n,i.Status.ACTIVE),t===r.conversationService.activeConversation&&a.appVisible&&'conversations'===a.activeApplication||(t.missedCounter+=1),t.sendAckReceivedMessage(s),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',t,i.EventType.FILE)})},p.prototype.onRoomAdminMessageReceived=function(e,r,n,o){t.info('[ConversationServiceEventHandler] onRoomAdminMessageReceived');var s=this,d=e.addAdminBubbleMessage(r,new Date,n,o);e.setStatusMessage(r,i.Status.ACTIVE),e.sendAckReceivedMessage(d),e===s.conversationService.activeConversation&&a.appVisible&&'conversations'===a.activeApplication||(e.missedCounter+=1),a.$broadcast('ON_CONVERSATION_MESSAGE_RECEIVED',d,e,!1),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',e,i.EventType.IM)},p.prototype.onFileMessageReceived=function(e){t.info('[ConversationServiceEventHandler] onFileMessageReceived');try{return this.extractStanzaData(e).then(function(e){if(e.body){var t=e.conversation;t.addFileMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,i.Status.ACTIVE),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',t,i.EventType.FILE)}}),!0}catch(e){return t.error('[ConversationServiceEventHandler] onFileMessageReceived ERROR '+e),!0}},p.prototype.onWebRTCMessageReceived=function(e){t.info('[ConversationServiceEventHandler] onWebRTCMessageReceived');try{return 0<angular.element(e).find('call_log').length?this.extractWebrtcStanzaData(e).then(function(e){if(e&&e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,i.Status.ACTIVE),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',t)}}):this.extractStanzaData(e).then(function(e){if(e&&e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,i.Status.ACTIVE),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',t)}}),!0}catch(e){return t.error('[ConversationServiceEventHandler] onWebRTCMessageReceived error '+e),!0}},p.prototype.onManagementMessageReceived=function(e){try{var r=angular.element(e).find('conversation');if(r){var n=this.conversationService.getConversationByDbId(r.attr('id'));if(n){var o=r.attr('action');if('delete'===o)t.info('[ConversationServiceEventHandler] onManagementMessageReceived (delete conversation)'),this.conversationService.removeConversation(n);else if('update'===o){t.info('[ConversationServiceEventHandler] onManagementMessageReceived (update conversation)');var i='true'===r.find('isFavorite').text();t.info('[ConversationServiceEventHandler] onManagementMessageReceived : favorite is changed to '+i),n.isFavorite=i,this.conversationService.orderConversations(),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT')}}}if(angular.element(e).find('mute')||angular.element(e).find('unmute')){var s=0!==angular.element(e).find('mute').length,d=angular.element(e).find('mute').attr('conversation')||angular.element(e).find('unmute').attr('conversation'),n=this.conversationService.getConversationByDbId(d);n&&(t.info('[ConversationServiceEventHandler] onManagementMessageReceived : mute is changed to '+s),n.muted=s)}return!0}catch(e){return t.error('[ConversationServiceEventHandler] onManagementMessageReceived error '+e),!0}},p.prototype.onReceiptMessageReceived=function(e){t.info('[ConversationServiceEventHandler] onReceiptMessageReceived');try{var o=angular.element(e),i=n.getBareJidFromJid(o.attr('from')),d=o.find('message');r.isUserContactJid(i)&&0<d.length&&(o=angular.element(d));var c=o.find('received');if(c.length&&0<c.length){var l=angular.element(c).attr('id'),p=angular.element(c).attr('entity'),u=angular.element(c).attr('event');if('server'===p&&'received'===u){var m=this.conversationService.pendingMessages[l];if(m&&m.message){var g=m.message,v=m.conversation;t.info('[conversationService] Receive server ack ('+v.id+', '+g.id+')'),g.setReceiptStatus(s.ReceiptStatus.SENT),v.updateMessage(g),delete this.conversationService.pendingMessages[l],a.$broadcast('ON_CONVERSATION_RECEIPT_RECEIVED',g,v,'server')}}else if('client'===p){var f=this;this.extractStanzaData(e).then(function(t){f.handleReceiptReceiveMessage(t.conversation,e)})}}else if(o.find('mark_as_read').length){var S=o.find('mark_as_read').attr('with'),v=this.conversationService.getConversationById(S);if(v)switch(o.find('mark_as_read').attr('id')){case'all-received':v.missedCounter=0;break;case'all-sent':v.ackReadAllMessages();break;default:t.error('[ConversationServiceEventHandler] onReceiptMessageReceived error - unknown read type');}}return!0}catch(e){return t.error('[ConversationServiceEventHandler] onReceiptMessageReceived error '+e),!0}},p.prototype.extractStanzaData=function(a){var i=n.getBareJidFromJid(angular.element(a).attr('from')),s={},d=null,c=null,l=null,p=e.defer(),u=angular.element(a).find('message');if(r.isUserContactJid(i)&&0<u.length){var m=n.getBareJidFromJid(angular.element(u).attr('from')),g=n.getResourceFromJid(angular.element(u).attr('from')),v=n.getBareJidFromJid(angular.element(u).attr('to')),f=n.getResourceFromJid(angular.element(u).attr('to'));s.outgoingMessage=r.isUserContactJid(m),s.body=angular.element(u).find('body').text(),s.participant=s.outgoingMessage?r.userContact:null,s.messageId=angular.element(u).attr('id'),s.carbon=!0,s.replace=angular.element(u).find('replace'),s.answeredMsg=angular.element(u).find('answeredMsg'),d=s.outgoingMessage?v:m,c=s.outgoingMessage?f:g,l=angular.element(u).find('delay');var S=angular.element(u).find('x[xmlns=\'jabber:x:oob\']');if(S&&S.length){var C=angular.element(S).find('url').text(),h=angular.element(S).find('mime').text(),E=angular.element(S).find('filename').text(),R=angular.element(S).find('size').text();s.oob={url:C,mime:h,filename:E,filesize:R}}var b=$(a).find('x[xmlns=\'jabber:x:audioconference\']');if(b&&b.length){var y=$(b),T=y.attr('subject'),I=y.attr('confendpointid'),N=b.attr('jid'),A=b.attr('type');s.conference={type:A,subject:T,confendpointid:I,roomjid:N,ownerjid:d}}s.status=null;var O=angular.element(a).find('composing'),P=angular.element(a).find('paused'),D=angular.element(a).find('active');O.length?s.status='composing':P.length?s.status='paused':D.length&&(s.status='active')}else{var _=$(a);s.outgoingMessage=!1,s.body=_.find('body').text(),s.messageId=_.attr('id'),s.carbon=!1,s.replace=_.find('replace'),s.answeredMsg=_.find('answeredMsg'),d=n.getBareJidFromJid(_.attr('from')),c=n.getResourceFromJid(_.attr('from')),l=_.find('delay');var M='push'===_.find('retransmission').attr('source'),S=_.find('x[xmlns=\'jabber:x:oob\']');if(S&&S.length){var w=$(S),C=w.find('url').text(),h=w.find('mime').text(),E=w.find('filename').text(),R=w.find('size').text();s.oob={url:C,mime:h,filename:E,filesize:R}}var b=_.find('x[xmlns=\'jabber:x:audioconference\']');if(b&&b.length){var y=$(b),U=y.attr('message'),I=y.attr('confendpointid'),N=b.attr('jid'),A=b.attr('type');if(s.conference={type:A,message:U,confendpointid:I,roomjid:N,ownerjid:d},'reminder'===A)d=N;else return t.debug('[conversationServiceEventHandler] ignored message stanza for conference'),p.resolve(s),p.promise}var L=_.find('content[xmlns=\'urn:xmpp:content\']');L&&'text/markdown'===L.attr('type')&&(s.markdown=!0,s.body=L.text());var T=_.find('subject');T&&''!==T.text()&&(s.subject=T.text()),s.status=null;var O=_.find('composing'),P=_.find('paused'),D=_.find('active');O.length?s.status='composing':P.length?s.status='paused':D.length&&(s.status='active')}if(s.date=new Date,s.offline=!1,'Offline Storage'===l.text()&&(s.date=new Date(l.attr('stamp')),s.offline=!0),M){var F=this.conversationService.getConversationById(d);if(!F){var k=this.conversationService,B=d.startsWith('room_')?k.getRoomConversation(d):k.getOrCreateOneToOneConversation(d);B.then(function(e){F=e,p.reject()})}else p.reject();return p.promise}if(s.body||this.conversationService.getConversationById(d)||s.oob||s.conference){if(0===d.indexOf('room_')){var x=o.getRoomByJid(d),T=_.find('subject'),H=T.length&&''===T.text();x&&'accepted'!==x.status||H?t.info('[conversationServiceEvent] extractStanzaData -- ignore this stanza message'):this.conversationService.getRoomConversation(d).then(function(e){return(s.conversation=e,s.conference&&s.conference.ownerjid)?r.getOrCreateContact(s.conference.ownerjid):(c&&-1!==c.indexOf('/')&&(c=c.split('/')[0]),r.getOrCreateContact(c))}).then(function(e){s.participant=e,p.resolve(s)}).catch(function(e){t.error('[conversationServiceEventHandler] impossible to fetch conversation '+e.message),p.reject()})}else this.conversationService.getOrCreateOneToOneConversation(d).then(function(e){s.conversation=e,s.participant||(s.participant=e.contact),p.resolve(s)}).catch(function(e){t.error('[conversationServiceEventHandler] impossible to fetch conversation '+e.message),p.reject()});}else if($(a).find('deleted')){var G=$(a).find('deleted')[0];if(G&&'all'===G.getAttribute('id')){var V=this.conversationService.getConversationById(G.getAttribute('with'));V&&(t.info('[conversationServiceEventHandler] Remove all messages for conversation '+V.id),V.reset())}}else t.debug('[conversationServiceEventHandler] ignored message stanza'),p.reject();return p.promise},p.prototype.extractWebrtcStanzaData=function(a){t.debug('[conversationServiceEventHandler] extractWebrtcStanzaData');var n=this;return e(function(e,o){var i={messageId:$(a).attr('id'),callerJid:$(a).find('caller').text(),calleeJid:$(a).find('callee').text(),state:$(a).find('state').text()},s=null;if(r.isUserContactJid(i.callerJid)?(s=i.calleeJid,i.participant=r.userContact):s=i.callerJid,-1!==s.indexOf('janusgateway'))return t.debug('[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore Janus message'),o();if(l.isMediaPillarJid(i.callerJid))return t.debug('[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore MediaPillar message'),e();var d=0;$(a).find('duration')&&(d=parseInt($(a).find('duration').text(),10)),i.duration=0<d?'('+moment.duration(d,'ms').format('h[H] mm[m] ss[s]')+')':0;var c=$(a).find('date').text();c&&(c=new Date(c)),i.date=c,i.body='','missed'===i.state?i.body='missedCall||'+c:'answered'===i.state&&(i.body='activeCallMsg||'+c+'||'+i.duration),n.conversationService.getOrCreateOneToOneConversation(s).then(function(t){i.conversation=t,i.participant||(i.participant=t.contact),e(i)}).catch(function(e){t.error('[conversationServiceEventHandler] impossible to fetch conversation '+e.message),o()})})},p.prototype.handleChatMessage=function(e){t.info('[ConversationServiceEventHandler] handleChatMessage');var r=this,n=e.conversation,o=null,i=e.body,s=e.replace;if(e.oob){var l=e.oob.url,p=e.oob.filename,u=d.extractFileIdFromUrl(l);d.retrieveAndStoreOneFileDescriptor(u).then(function(t){o=n.addFileSharingMessage(e.participant,e.date,e.body,e.messageId,u,p),r.acknowledgeHandledChatMessage(e,n,o),c.getBlobThumbnailFromFileDescriptor(t).then(function(e){var r=d.getFileDescriptorById(t.id);r.previewBlob=e,a.$broadcast('ON_FILE_DESCRIPTOR_RECEIVED_EVENT',{fileId:r.id})}),a.$broadcast('ON_FILE_DESCRIPTOR_RECEIVED_EVENT',{fileId:t.id})}).catch(function(e){t.info('[ConversationServiceEventHandler] handleChatMessage error '+e)})}else if(e.conference){var m={type:e.conference.type,message:e.conference.subject,confendpointid:e.conference.confendpointid,roomjid:e.conference.roomjid};if(n=this.conversationService.getConversationById(m.roomjid),a.$broadcast('ROOM_UPDATE_CONFID'),n)o=n.addConferenceMessage(e.participant,e.date,e.messageId,m);else return!0}else if(s&&s.length){var g=s.attr('id'),v=n.getMessageById(g);v?v.addReplaceMsg(e.messageId,i):t.debug('[conversationServiceHistoryHandler] no Msg available'),o=v}else{var f=e.answeredMsg?e.answeredMsg.text():null,S=e.answeredMsg?e.answeredMsg.attr('stamp'):null;o=n.addChatMessage(e.participant,e.date,e.body,e.messageId,null,e.markdown,e.subject,f,S)}o&&r.acknowledgeHandledChatMessage(e,n,o)},p.prototype.acknowledgeHandledChatMessage=function(e,n,o){return t.info('[ConversationServiceEventHandler] acknowledgeHandledChatMessage'),o?void(o.side===s.Side.LEFT?(n===this.conversationService.activeConversation&&'away'!==r.userContact.status&&a.appVisible&&'conversations'===a.activeApplication?n.sendAckReceivedMessage(o):(n.sendAckReceivedMessage(o),!e.offline&&n.preload&&(n.missedCounter+=1)),o.isTextModified()&&n.updateMessage(o)):(e.carbon?o.setReceiptStatus(s.ReceiptStatus.SENT):o.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS),n.updateMessage(o)),n.setStatusMessage(e.participant,i.Status.ACTIVE),a.$broadcast('ON_CONVERSATION_MESSAGE_RECEIVED',o,n,e.carbon),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',n)):(o=n.getMessageById(e.messageId),n.room&&o&&o.side===s.Side.RIGHT&&n.sendAckReceivedMessage(o),!0)},p.prototype.handleReceiptReceiveMessage=function(e,n){t.info('[ConversationServiceEventHandler] handleReceiptReceiveMessage');var o=angular.element(n).find('received[xmlns=\'urn:xmpp:receipts\']');if(o.length){var i=angular.element(o).attr('id'),d=e.getMessageById(i);if(d){var c=angular.element(n).attr('from').split('/')[1];c||(c=angular.element(n).attr('from'));var l=angular.element(o).attr('event');(e.room&&r.isUserContactJid(c)||!e.room)&&('received'===l?d.setReceiptStatus(s.ReceiptStatus.UNREAD):'read'===l&&(d.setReceiptStatus(s.ReceiptStatus.READ),e.missedCounter=0)),r.isUserContactJid(c)&&'read'===l&&'L'===d.side&&(e.missedCounter=0),e.updateMessage(d),a.$broadcast('ON_CONVERSATION_RECEIPT_RECEIVED',d,e,l),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',e)}else{var p=angular.element(n).attr('from'),l=angular.element(o).attr('event'),c='';p&&(c=p.split('/')[1]),c||(c=p),r.isUserContactJid(c)&&'read'===l&&(e.missedCounter=0,a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',e))}}},p.prototype.handleStatusMessage=function(e,r,n){t.info('[conversationServiceEventHandler] handleStatusMessage ');var o='';o='thread'===angular.element(n).children().prop('tagName')?i.stringToStatus(angular.element(angular.element(n).children()[1]).prop('tagName')):i.stringToStatus(angular.element(n).children().prop('tagName')),e.setStatusMessage(r,o),a.$broadcast('ON_CONVERSATIONS_STATUS_MESSAGE_EVENT',e,r,o)},p.prototype.onRecordingMessageReceived=function(e){t.info('[ConversationServiceEventHandler] onRecordingMessageReceived');try{var r=e.textContent;return this.extractStanzaData(e).then(function(e){if('start'===r){var t=e.conversation;t.addRecordingMessage(e.participant,e.date,r,e.messageId),t.setStatusMessage(e.participant,i.Status.ACTIVE),a.$broadcast('ON_CONVERSATIONS_UPDATED_EVENT',t),a.$broadcast('ON_RECORDING_START_MSG_RECEIVED')}else if('stop'===r){var t=e.conversation;t&&t.addRecordingMessage(e.participant,e.date,r,e.messageId),a.$broadcast('ON_RECORDING_STOP_MSG_RECEIVED')}else'remoteStopVideo'===r?a.$broadcast('ON_RECORDING_REMOTESTOPVIDEO_MSG_RECEIVED'):'remoteChangeMediaVideo'===r?a.$broadcast('ON_RECORDING_REMOTECHANGEMEDIAVIDEO_MSG_RECEIVED'):'remoteStopSharing'===r?a.$broadcast('ON_RECORDING_REMOTESTOPSHARING_MSG_RECEIVED'):'remoteChangeMediaSharing'===r&&a.$broadcast('ON_RECORDING_REMOTECHANGEMEDIASHARING_MSG_RECEIVED')}),!0}catch(e){return t.error('[ConversationServiceEventHandler] onRecordingMessageReceived error '+e),!0}},p}])},function(){angular.module('rainbow').factory('ConversationServiceHistoryHandler',['$log','$q','$filter','$rootScope','xmppService','contactService','fileStorageService','fileServerService','Message','SearchTextMsgResultFactory',function(e,t,a,r,n,o,i,s,d,c){'use strict';function l(e){this.conversationService=e}return l.create=function(e){return new l(e)},l.prototype.getHistoryPage=function(e,t){var a=this,r=e.room;return r&&r.initPresPromise?r.initPresPromise.promise.then(function(){return a.getHistoryPageInternal(e,t)}):this.getHistoryPageInternal(e,t)},l.prototype.getHistoryPageInternal=function(a,r){if(a.currentHistoryId&&a.currentHistoryId===a.historyIndex)return e.info('[ConversationServiceHistoryHandler] getHistoryPage('+a.id+', '+r+', '+a.historyIndex+') already asked'),t.when();a.currentHistoryId=a.historyIndex,e.info('[ConversationServiceHistoryHandler] getHistoryPage('+a.id+', '+r+', '+a.historyIndex+')');var i=a.historyDefered=t.defer();if(o.isUserContact(a.contact))return i.reject(),i.promise;if(a.historyComplete)return e.info('[ConversationServiceHistoryHandler] getHistoryPage('+a.id+') : already complete'),i.reject(),i.promise;var s={queryid:a.id,with:a.id,max:r,before:''};return-1!==a.historyIndex&&(s.before=a.historyIndex),a.room?(s={queryid:a.id,with:o.userContact.jid,max:r,before:''},-1!==a.historyIndex&&(s.before=a.historyIndex),n.connection.mam.querymuc(a.id,a.room.jid,s)):n.connection.mam.query(a.id,s),i.promise},l.prototype.retrieveMsgByDate=function(a,r){a.historyDefered=t.defer();var n=t.defer();if(o.isUserContact(a.contact))return n.reject(),n.promise;var i='cache_'+a.id;return l.prototype.getCommonHistoryPageAroundMsg(i,a,1,r,'after',function(){e.info('[ConversationServiceHistoryHandler] retrieveMsgByDate finished'),n.resolve()}),n.promise},l.prototype.getHistoryPageAroundMsg=function(a,r,n){a.historyDefered=t.defer();var i=t.defer();return o.isUserContact(a.contact)?(i.reject(),i.promise):(l.prototype.getCommonHistoryPageAroundMsg(a.id,a,r+1,n,'after',function(){e.info('[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg BEFORE finished'),l.prototype.getCommonHistoryPageAroundMsg(a.id,a,r,n,'before',function(){e.info('[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg AFTER finished'),i.resolve()})}),i.promise)},l.prototype.getCommonHistoryPageAroundMsg=function(t,a,r,i,s,d){if(e.info('[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg('+t+', '+r+', '+a.historyIndex+')'),a.room){var c={queryid:t,with:o.userContact.jid,max:r,onComplete:d};c[s]=i,n.connection.mam.querymuc(t,a.room.jid,c)}else{var c={queryid:t,with:a.id,max:r,onComplete:d};c[s]=i,n.connection.mam.query(t,c)}},l.prototype.searchTextInConversations=function(a,r,o){e.info('[ConversationServiceHistoryHandler] searchTextInConversations('+r+')');var i=t.defer(),s=n.connection.getUniqueId(),d=$iq({id:s,type:'get'}).c('query',{queryid:a,xmlns:'urn:xmpp:mam:tmp'}).c('set',{xmlns:'http://jabber.org/protocol/rsm'}).c('max').t(o).up().c('before').up().up().c('x',{xmlns:'jabber:x:data',type:'form'}).c('field',{var:'FORM_TYPE',type:'hidden'}).c('value').t('urn:xmpp:mam:1').up().up().c('field',{var:'withtext',type:'text-single'}).c('value').t(r).up().up();return n.sendIQ(d).then(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Success: '+r);var a=$(t).find('query'),n=a.find('set').find('count').text();e.info('[ConversationServiceHistoryHandler] >searchTextInConversations: count= '+n),i.resolve(n)}).catch(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Failure: '+t.message),i.reject(t)}),i.promise},l.prototype.getConversationTextCount=function(a,r,o){e.info('[ConversationServiceHistoryHandler] getConversationTextCount('+r+')');var i=t.defer(),s=n.connection.getUniqueId(),d=$iq({id:s,type:'get'}).c('query',{queryid:a,xmlns:'urn:xmpp:mam:tmp'}).c('set',{xmlns:'http://jabber.org/protocol/rsm'}).c('max').t('0').up().up().c('x',{xmlns:'jabber:x:data',type:'form'}).c('field',{var:'FORM_TYPE',type:'hidden'}).c('value').t('urn:xmpp:mam:1').up().up().c('field',{var:'withtext',type:'text-single'}).c('value').t(r).up().up().c('field',{var:'with',type:'text-single'}).c('value').t(o).up().up();return n.sendIQ(d).then(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Success: '+r);var a=$(t).find('query'),n=a.find('set').find('count').text();e.info('[ConversationServiceHistoryHandler] >getConversationTextCount: count= '+n),i.resolve(n)}).catch(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Failure: '+t.message),i.reject(t)}),i.promise},l.prototype.searchTextResultsInConversation=function(a,r,o,i){e.info('[ConversationServiceHistoryHandler] searchTextResultsInConversation('+r+')');var s=t.defer(),d=n.connection.getUniqueId(),c=$iq({id:d,type:'get'}).c('query',{queryid:a,xmlns:'urn:xmpp:mam:tmp'}).c('set',{xmlns:'http://jabber.org/protocol/rsm'}).c('max').t(i).up().c('before').up().up().c('x',{xmlns:'jabber:x:data',type:'form'}).c('field',{var:'FORM_TYPE',type:'hidden'}).c('value').t('urn:xmpp:mam:1').up().up().c('field',{var:'withtext',type:'text-single'}).c('value').t(r).up().up().c('field',{var:'with',type:'text-single'}).c('value').t(o).up().up();return n.sendIQ(c).then(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Success: '+r);var a=$(t).find('query'),n=a.find('set').find('count').text();e.info('[ConversationServiceHistoryHandler] >getConversationTextCount: count= '+n),s.resolve(n)}).catch(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Failure: '+t.message),s.reject(t)}),s.promise},l.prototype.searchTextMoreResultsInConversation=function(a,r,o,i,s){e.info('[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation('+r+')');var d=t.defer(),c=n.connection.getUniqueId(),l=$iq({id:c,type:'get'}).c('query',{queryid:a,xmlns:'urn:xmpp:mam:tmp'}).c('set',{xmlns:'http://jabber.org/protocol/rsm'}).c('max').t(s).up().c('before').t(i).up().up().c('x',{xmlns:'jabber:x:data',type:'form'}).c('field',{var:'FORM_TYPE',type:'hidden'}).c('value').t('urn:xmpp:mam:1').up().up().c('field',{var:'withtext',type:'text-single'}).c('value').t(r).up().up().c('field',{var:'with',type:'text-single'}).c('value').t(o).up().up();return n.sendIQ(l).then(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Success: '+r);var a=$(t).find('query'),n=a.find('set').find('count').text();e.info('[ConversationServiceHistoryHandler] >getConversationTextCount: count= '+n),d.resolve(n)}).catch(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Failure: '+t.message),d.reject(t)}),d.promise},l.prototype.searchTextInRoom=function(a,r,o,i,s){e.info('[ConversationServiceHistoryHandler] searchTextInRoom('+i+')');var d=t.defer(),c=n.connection.getUniqueId(),l=$iq({to:o,id:c,type:'get'}).c('query',{queryid:a,xmlns:'urn:xmpp:mam:tmp'}).c('set',{xmlns:'http://jabber.org/protocol/rsm'}).c('max').t(s).up().c('before').up().up().c('x',{xmlns:'jabber:x:data',type:'form'}).c('field',{var:'FORM_TYPE',type:'hidden'}).c('value').t('urn:xmpp:mam:1').up().up().c('field',{var:'with',type:'text-single'}).c('value').t(r).up().up().c('field',{var:'withtext',type:'text-single'}).c('value').t(i).up().up();return n.sendIQ(l).then(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Success: '+i);var a=$(t).find('query'),r=a.find('set').find('count').text();e.info('[ConversationServiceHistoryHandler] >searchTextInRoom: count= '+r),d.resolve(r)}).catch(function(t){e.info('[ConversationServiceHistoryHandler] >searchTextInRoom: Failure: '+t.message),d.reject(t)}),d.promise},l.prototype.searchTextMoreResultsInRoom=function(a,r,o,i,s,d){e.info('[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation('+r+')');var c=t.defer(),l=n.connection.getUniqueId(),p=$iq({to:i,id:l,type:'get'}).c('query',{queryid:a,xmlns:'urn:xmpp:mam:tmp'}).c('set',{xmlns:'http://jabber.org/protocol/rsm'}).c('max').t(d).up().c('before').t(s).up().up().c('x',{xmlns:'jabber:x:data',type:'form'}).c('field',{var:'FORM_TYPE',type:'hidden'}).c('value').t('urn:xmpp:mam:1').up().up().c('field',{var:'withtext',type:'text-single'}).c('value').t(r).up().up().c('field',{var:'with',type:'text-single'}).c('value').t(o).up().up();return n.sendIQ(p).then(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Success: '+r);var a=$(t).find('query'),n=a.find('set').find('count').text();e.info('[ConversationServiceHistoryHandler] >getConversationTextCount: count= '+n),c.resolve(n)}).catch(function(t){e.info('[ConversationServiceHistoryHandler] sendIq Failure: '+t.message),c.reject(t)}),c.promise},l.prototype.onHistoryMessageReceived=function(t){e.info('[ConversationServiceHistoryHandler] onHistoryMessageReceived');try{var c=null,l=$(t),p=l.find('result').attr('queryid');if(p){if(c=this.conversationService.getConversationById(p),c){if(l.find('call_log').length)return this.onWebrtcHistoryMessageReceived(t,c);var u=l.find('forwarded message').attr('from'),m=!1,g;if(g=u&&0===u.indexOf('room_')?u.split('/')[1]:n.getBareJidFromJid(l.find('forwarded message').attr('from')),!g&&l.find('event').length&&(m=l.find('event').attr('name'),g=l.find('event').attr('jid'),'welcome'===m&&c.room&&c.room.ownerContact&&(g=c.room.ownerContact.jid)),!g)return e.warn('[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information'),!0;var v=o.getContactByJid(g),f=l.find('forwarded message').attr('type'),S=l.find('forwarded message').attr('id'),C=new Date(l.find('forwarded delay').attr('stamp')),h=l.find('forwarded message body').text(),E=l.find('forwarded message ack'),R=l.find('forwarded message x[xmlns=\'jabber:x:oob\']'),b=l.find('forwarded message x[xmlns=\'jabber:x:bubble:conference:pstn\']'),y=l.find('content[xmlns=\'urn:xmpp:content\']'),T=l.find('replace'),I=l.find('answeredMsg'),N=o.isUserContact(v)?d.Side.RIGHT:d.Side.LEFT;if(v||(e.warn('[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : '+g+', ignore message'),v=o.createEmptyContactContact(g)),m){if(e.info('[ConversationServiceHistoryHandler] ('+c.id+') add Room admin event message '+m),f='admin',c.room&&c.room.isMeetingRoom()&&('welcome'===m||'conferenceAdd'===m||'conferenceRemove'===m||'invitation'===m))return!0;if(('conferenceAdd'===m||'conferenceRemove'===m)&&c.room&&c.room.ownerContact){var A=l.find('event').attr('jid'),O=c.room.getUserByJid(A);v=O&&O.contact?O.contact:c.room.ownerContact}}var P=c.getMessageById(S);if(P||(P=c.historyMessages.find(function(e){return e.id===S})),P)e.info('[ConversationServiceHistoryHandler] ('+c.id+') try to add an already stored message with id '+P.id);else{switch(f){case'file':P=d.createFileMessage(S,C,v,N,h,!1);break;case'webrtc':P=d.createWebRTCMessage(S,C,v,N,h,!1);break;case'admin':P=d.createBubbleAdminMessage(S,C,v,m);break;case'recording':P=d.createRecordingAdminMessage(S,C,v,'Admin');break;default:if(R&&R.length){var D=$(R),_=D.find('url').text(),M=D.find('filename').text(),w=i.extractFileIdFromUrl(_);P=d.createFileSharingMessage(S,C,v,N,h,!1,w,M),i.retrieveAndStoreOneFileDescriptor(w).then(function(e){e&&'not_uploaded'===e.state&&(P.receiptStatus=1,P.fileErrorMsg=a('translate')('file_notuploaded')),s.getBlobThumbnailFromFileDescriptor(e).then(function(t){e.previewBlob=t,r.$broadcast('ON_FILE_DESCRIPTOR_RECEIVED_EVENT',{fileId:e.id})}),r.$broadcast('ON_FILE_DESCRIPTOR_RECEIVED_EVENT',{fileId:e.id})}).catch(function(t){e.info('[ConversationServiceHistoryHandler] onHistoryMessageReceived error '+t)})}else if(b&&b.length){var U=$(b),L=U.attr('subject'),F=U.attr('confendpointid'),k=b.attr('jid'),B=b.attr('type');if('reminder'===B)return!0;P=d.createConferenceMessage(S,C,v,N,!1,{subject:L,confendpointid:F,roomjid:k})}else{var x=y&&'text/markdown'===y.attr('type');if(h=x?y.text():h,T&&T.length){var H=T.attr('id'),G=c.getMessageByIdInHistory(H);G?G.addReplaceMsg(S,h):e.debug('[conversationServiceHistoryHandler] no Msg available')}else{var V=I?I.text():null,j=I?I.attr('stamp'):null;P=d.create(S,C,v,N,h,!1,x,null,V,j)}}}P&&(P.receiptStatus='true'===angular.element(E).attr('read')?5:'true'===angular.element(E).attr('recv')?4:3,e.info('[ConversationServiceHistoryHandler] onHistoryMessageReceived : pushing msg inside historyMessages'),c.addMessageInHistoryMessages(P))}}else if(p.startsWith('cache_')){e.info('[ConversationServiceHistoryHandler] onHistoryMessageReceived : Query Id for Cached Message');var W=p.substr(6);if(c=this.conversationService.getConversationById(W),c){e.info('[ConversationServiceHistoryHandler] onHistoryMessageReceived : Conversation Found');var u=l.find('forwarded message').attr('from'),g;if(g=u&&0===u.indexOf('room_')?u.split('/')[1]:n.getBareJidFromJid(l.find('forwarded message').attr('from')),!g&&l.find('event').length&&(m=l.find('event').attr('name'),g=l.find('event').attr('jid'),'welcome'===m&&c.room&&c.room.ownerContact&&(g=c.room.ownerContact.jid)),!g)return e.warn('[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information'),!0;var v=o.getContactByJid(g),S=l.find('forwarded message').attr('id'),C=new Date(l.find('forwarded delay').attr('stamp')),h=l.find('forwarded message body').text(),N=o.isUserContact(v)?d.Side.RIGHT:d.Side.LEFT;v||(e.warn('[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : '+g+', ignore message'),v=o.createEmptyContactContact(g)),P=d.create(S,C,v,N,h,!1,!1),P&&c.addMessageInCacheMessages(P)}}}else if(p=angular.element(t).find('fin').attr('queryid'),c=this.conversationService.getConversationById(p),c){c.historyComplete='true'===angular.element(t).find('fin').attr('complete');var q=angular.element(t).find('fin set first').text();-1===c.historyIndex?(c.messages.unshift.apply(c.messages,c.historyMessages),c.chatRenderer&&c.chatRenderer.prependMessages(c.messages,c.room)):(c.messages.unshift.apply(c.messages,c.historyMessages),c.chatRenderer&&c.chatRenderer.prependMessages(c.historyMessages,c.room)),c.historyIndex=q,c.historyMessages=[],c.lastMessageText=angular.isDefined(c.messages)&&0<c.messages.length?c.messages[c.messages.length-1].data:'',c.historyDefered&&c.historyDefered.resolve(c)}return!0}catch(t){return e.error('[ConversationServiceHistoryHandler] onHistoryMessageReceived error : '+t),!0}},l.prototype.onSearchTextMessageReceived=function(t){e.info('[ConversationServiceHistoryHandler] onSearchTextMessageReceived');try{var a=$(t),r=a.find('forwarded message').attr('from'),i=a.find('forwarded message').attr('to'),s=!1,d=!1,l;if(o.isUserContactJid(r)?(e.info('[ConversationServiceHistoryHandler] sent message'),s=!0,l=i):(e.info('[ConversationServiceHistoryHandler] received message'),s=!1,l=r),l&&0===l.indexOf('room_')?(l=l.split('/')[0],d=!0):l=n.getBareJidFromJid(l),!l)return void e.warn('[ConversationServiceHistoryHandler] onSearchTextMessageReceived - Receive message without valid otherJid information');var p=a.find('forwarded message').attr('id'),u=new Date(a.find('forwarded delay').attr('stamp')),m=a.find('forwarded message body').text(),g=c();return g.body=m,g.date=u,g.isRoom=d,g.isSent=s,g.messageId=p,g.otherJid=l,g}catch(t){return e.error('[ConversationServiceHistoryHandler] onSearchTextMessageReceived error : '+t),!0}},l.prototype.onWebrtcHistoryMessageReceived=function(t,a){console.log('onWebrtcHistoryMessageReceived');try{var r=$(t),n=r.find('forwarded message').attr('id'),i=r.find('caller').text(),s=r.find('state').text(),c=0;r.find('duration')&&(c=r.find('duration').text(),c=parseInt(c,10)),c=0<c?'('+moment.duration(c,'ms').format('h[H] mm[m] ss[s]')+')':0;var l=r.find('date').text();l=l?new Date(l):new Date(r.find('forwarded delay').attr('stamp'));var p='';'missed'===s?p='missedCall||'+l:'answered'===s&&(p='activeCallMsg||'+l+'||'+c);var u=a.getMessageById(n);if(u||(u=a.historyMessages.find(function(e){return e.id===n})),u)e.info('[ConversationServiceHistoryHandler] ('+a.id+') try to add an already stored message with id '+u.id);else{var m=o.getContactByJid(i);m||(e.warn('[ConversationServiceHistoryHandler] onWebrtcHistoryMessageReceived missing contact for jid : '+i+', ignore message'),m=o.createEmptyContactContact(i));var g=o.isUserContact(m)?d.Side.RIGHT:d.Side.LEFT;u=d.createWebRTCMessage(n,l,m,g,p,!1);var v=r.find('forwarded message ack');v&&(u.receiptStatus='true'===angular.element(v).attr('read')?5:'true'===angular.element(v).attr('received')?4:3),a.historyMessages.push(u)}return!0}catch(e){return console.error(e),!0}},l}])},function(){angular.module('rainbow').service('telephonyService',['$q','$interval','$http','$rootScope','$log','xmppService','contactService','authService','Call','TelephonyServiceEventHandler','errorHelperService','VoiceMail','profileService','utilService',function(e,t,a,r,n,o,i,s,d,c,l,p,u,m){'use strict';var g=this,v=[],f='urn:xmpp:pbxagent:callservice:1';g.start=function(e){n.info('[telephonyService] === STARTING ==='),g.startDate=performance.now(),g.stats=e,g.calls=[],g.started=!1,g.agentStatus={phoneApi:'disconnected',xmppAgent:'stopped',agentVersion:'unknown'},g.voicemailNumber=i.userContact.voicemailNumber,g.pbxId=i.userContact.pbxId,g.makingCall=!1,g.starting=!1,g.voiceMail=p.create(),g.forwardObject={},g.nomadicObject={},g.nomadicAnswerNotTakedIntoAccount=!1,g.isBasicCallAllowed=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_BASIC_CALL),g.isSecondCallAllowed=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_SECOND_CALL),g.isTransferAllowed=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_TRANSFER_CALL),g.isConferenceAllowed=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_CONFERENCE_CALL),g.isVMDeflectCallAllowed=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_DEFLECT_CALL),g.voiceMailFeatureEnabled=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_VOICE_MAIL),g.isForwardEnabled=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_CALL_FORWARD),g.isNomadicEnabled=u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_NOMADIC),g.userJidTel=s.jidTel,g.portalURL=config.restServerUrl+'/api/rainbow/telephony/v1.0/',v.push(r.$on('ON_ROSTER_PRESENCE_CHANGED_EVENT',g.onTelPresenceChange)),g.telephonyEventHandler=c.create(g),n.info('[telephonyService] starting on user jidTel: '+g.userJidTel),i.userContact&&(n.info('[telephonyService] starting user email: '+i.userContact.emailPro+', full jid: '+i.userContact.fullJid),n.info('[telephonyService] starting phonePbx: '+i.userContact.phonePbx+', phonePro: '+i.userContact.phonePro+', voicemailNumber: '+i.userContact.voicemailNumber+', pbxId: '+i.userContact.pbxId)),i.userContact&&i.userContact.telStatus?(n.info('[telephonyService] start with my existing telephony presence '+i.userContact.telStatus+' of user contact ('+i.userContact.jidtel+') '),g.onTelPresenceChange(null,{jid:g.userJidTel+'/phone',status:i.userContact.telStatus})):n.info('[telephonyService] wait for my telephony presence')},g.onTelPresenceChange=function(t,a){if(i.isTelJid(a.jid)){if('phone'!==i.getRessourceFromJid(a.jid))return!0;var o=i.getImJid(a.jid);if(!o)return!0;var s=a.status;i.isUserContactJid(o)&&('unavailable'===s||'offline'===s?(n.info('[telephonyService] received my telephony presence -- '+s),g.started=!1,g.calls=[],r.$broadcast('ON_TELEPHONY_STATUS_CHANGED_EVENT','stopped'),n.info('[telephonyService] === STOPPED ===')):!g.started&&!g.starting&&(n.info('[telephonyService] received my telephony presence -- '+s),g.starting=!0,g.getAgentStatus().then(function(){return g.attachHandlers(),g.getTelephonyState(!1)}).then(function(){return g.isNomadicEnabled&&g.getNomadicStatus().then(function(){return g.nomadicObject.featureActivated&&g.nomadicObject.modeActivated&&!g.nomadicObject.makeCallInitiatorIsMain?g.getTelephonyState(!0):e.when()}),e.when()}).then(function(){return g.isForwardEnabled&&g.getForwardStatus(),e.when()}).then(function(){var e=Math.round(performance.now()-g.startDate);g.stats.push({service:'telephonyService',startDuration:e}),n.info('[telephonyService] === STARTED ('+e+' ms) ==='),g.started=!0,g.starting=!1,r.$broadcast('ON_TELEPHONY_STATUS_CHANGED_EVENT','started')}).catch(function(e){g.starting=!1,n.error('[telephonyService] receive telephony presence but no agent response - '+e.message)})))}return!0},g.getTelephonyState=function(t){var a=e.defer(),r;return r=t?$iq({type:'get',to:g.userJidTel+'/phone'}).c('callservice',{xmlns:f}).c('connections',{deviceType:'SECONDARY'}):$iq({type:'get',to:g.userJidTel+'/phone'}).c('callservice',{xmlns:f}).c('connections'),o.sendIQ(r,6e4).then(function(t){var r=g.getErrorMessage(t,'getTelephonyState');if(r)return n.info('[telephonyService] getTelephonyState -- failure -- '+r),a.reject(new Error(r)),a.promise;var o=angular.element(t).find('connection');if(0===o.length)return n.info('[telephonyService] getTelephonyState -- success -- no existing call'),a.resolve(),a.promise;var i=[];return o.each(function(){i.push(g.createCallFromConnectionElem(this))}),e.all(i).then(function(){n.info('[telephonyService] getTelephonyState -- success'),a.resolve()}).catch(function(e){n.error('[telephonyService] getTelephonyState -- failure -- '+e.message),a.reject(e)}),a.promise}).catch(function(e){n.error('[telephonyService] getTelephonyState -- failure -- '+e.message),a.reject(e)}),a.promise},g.getAgentStatus=function(){var t=e.defer(),a=$iq({type:'get',to:g.userJidTel+'/phone'}).c('pbxagentstatus',{xmlns:'urn:xmpp:pbxagent:monitoring:1'});return o.sendIQ(a,6e4).then(function(e){var a=angular.element(e).find('phoneapi').text(),r=angular.element(e).find('xmppagent').text(),o=angular.element(e).find('version').text();o&&(g.agentStatus={phoneApi:a,xmppAgent:r,agentVersion:o}),n.info('[telephonyService] getAgentStatus -- success -- version '+o),t.resolve()}).catch(function(e){var a='getAgentStatus -- failure : '+e.message;n.error('[telephonyService] '+a),t.reject(new Error(a))}),t.promise},g.getSnapshotCall=function(t){return n.info('[telephonyService] getSnapshotCall'),e(function(e,a){var r=$iq({type:'get',to:g.userJidTel+'/phone'}).c('callservice',{xmlns:f}).c('snapshotCall',{callId:t});o.sendIQ(r).then(function(t){console.error(t),e()}).catch(function(e){var t='getSnapshotCall failure : '+e.message;n.error('[telephonyService] '+t),a(new Error(t))})})},g.getVoiceMessageCounter=function(){return e(function(e,t){if(!g.voiceMailFeatureEnabled){var a=new Error('getVoiceMessageCounter failure - Not Allowed');a.status=a.errorDetailsCode='403',n.error('[telephonyService] '+a.message),t(a)}var r=$iq({type:'get',to:g.userJidTel+'/phone'}).c('callservice',{xmlns:f}).c('messaging');o.sendIQ(r).then(function(t){console.error(t),e()}).catch(function(e){var a='getVoiceMessageCounter failure : '+e.message;n.error('[telephonyService] '+a),t(new Error(a))})})},g.createCallFromConnectionElem=function(t){return e(function(e,a){var o=angular.element(t),s=o.attr('endpointIm'),c=o.attr('endpointTel'),l=o.attr('callId'),p=o.attr('endpointLci'),v=o.attr('lci'),f=o.find('participant'),S=o.find('identity').attr('firstName'),C=o.find('identity').attr('lastName'),h='',E='';s||c||(c='****'),u.isFeatureEnabled(u.FeaturesEnum.TELEPHONY_PHONE_BOOK)&&0===f.length&&C&&C.length&&(E=C,S&&S.length&&(h=S),n.info('[telephonyService] createCallFromConnectionElem - name resolution for: '+l+' for phoneNumber:'+m.anonymizePhoneNumber(c)+' with firstname : '+h.slice(0,1)+'***')),'LCI_INITIATED'===v&&e();var R=function(){return 0===f.length?i.getOrCreateContact(s,c):g.getParticipantsFromParticipantsElem(f)};R().then(function(t){var a=d.Status.ACTIVE;'LCI_HELD'===v&&'LCI_CONNECTED'===p&&(a=d.Status.HOLD),'LCI_CONNECTED'===v&&'LCI_HELD'===p&&(a=d.Status.PUT_ON_HOLD),'LCI_CONNECTED'===v&&'LCI_QUEUED'===p&&(a=d.Status.QUEUED_OUTGOING),'LCI_QUEUED'===v&&'LCI_CONNECTED'===p&&(a=d.Status.QUEUED_INCOMMING);var o=null;if(0===f.length)t&&t.temp&&''!==E&&t.updateName(h,E),o=g.getOrCreateCall(a,l,t),n.info('[telephonyService] createCallFromConnectionElem - create call for user: '+t.id+' with callId: '+l+' '+v);else{var o=g.getOrCreateCall(a,l);o.setParticipants(t),o.isConference=!0,n.info('[telephonyService] createCallFromConnectionElem - create conference call with callId: '+l+' '+v)}o.relevantEquipmentId=d.getDeviceIdFromConnectionId(l),r.$broadcast('ON_CALL_UPDATED_EVENT',o),e(o)}).catch(function(e){n.error('[TelephonyService] createCallFromConnectionElem - failure - '+e.message),a(e)})})},g.getParticipantsFromParticipantsElem=function(t){return e(function(a,r){var n=[],o=[];t.each(function(){var t=angular.element(this),a=t.find('endpointTel').text(),r=t.find('endpointIm').text();r&&i.isUserContactJid(r)||o.push(e(function(e,t){r||a||(a='****'),i.getOrCreateContact(r,a).then(function(t){n.push(t),e()}).catch(function(e){t(e)})}))}),e.all(o).then(function(){a(n)},function(e){r(e)})})},g.getOrCreateCall=function(e,t,a){var r=g.calls[t];return r?(r.setConnectionId(t),r.startDate=new Date):(r=d.create(e,null,d.Type.PHONE,a),r.setConnectionId(t),g.calls[r.id]=r),r},g.attachHandlers=function(){n.info('[telephonyService] attachHandlers'),g.started=!1,g.calls=[],r.telephonyAreaClass='',g.messageHandlerRef&&(o.deleteHandler(g.messageHandlerRef),g.messageHandlerRef=null),g.messageHandlerRef=o.addHandler(function(e){return g.telephonyEventHandler.onCallserviceMessageReceived(e),!0},f,'message',null)},g.stop=function(){n.info(''),n.info('[telephonyService] === STOPPING ==='),g.started=!1,g.userJidTel=null,g.calls=null,g.messageHandlerRef&&(o.deleteHandler(g.messageHandlerRef),g.messageHandlerRef=null);for(var t;t=v.pop();)t();return n.info('[telephonyService] === STOPPED ==='),r.$broadcast('ON_TELEPHONY_STATUS_CHANGED_EVENT','stopped'),e.when()},g.getCallToHangOut=function(){var e=g.getCalls();if(!e||0===e.length)return null;var t=e[0].status;return 1===e.length||t===d.Status.DIALING||t===d.Status.ACTIVE||t===d.Status.PUT_ON_HOLD?e[0]:e[1]},g.getActiveCall=function(){var e=null;return Object.keys(g.calls||[]).forEach(function(t){var a=g.calls[t];a.status===d.Status.ACTIVE&&(e=a)}),e},g.getCalls=function(){var e=[];return Object.keys(g.calls||[]).forEach(function(t){var a=g.calls[t],r=a.status;(r===d.Status.DIALING&&a.currentCalled.contactPhoneNumber||r===d.Status.RINGING_OUTGOING||r===d.Status.QUEUED_OUTGOING||r===d.Status.ACTIVE||r===d.Status.HOLD||r===d.Status.PUT_ON_HOLD||r===d.Status.ERROR)&&e.push(g.calls[t])}),e},g.getActiveCallsForContact=function(e){var t=[];return e&&e.jid&&Object.keys(g.calls||[]).forEach(function(a){g.calls[a].contact&&g.calls[a].contact.jid===e.jid&&(g.calls[a].status===d.Status.DIALING||g.calls[a].status===d.Status.RINGING_OUTGOING||g.calls[a].status===d.Status.ACTIVE||g.calls[a].status===d.Status.HOLD||g.calls[a].status===d.Status.PUT_ON_HOLD)&&t.push(g.calls[a])}),t},g.getConferenceCallForContact=function(e){var t=null;return e&&e.jid&&Object.keys(g.calls||[]).forEach(function(a){g.calls[a].status===d.Status.ACTIVE&&g.calls[a].isConference&&(g.calls[a].participants||[]).some(function(t){return t&&t.jid===e.jid})&&(t=g.calls[a])}),t},g.makeCall=function(t,a,r){var o=g.getActiveCall();return g.makingCall?(n.warn('[telephonyService] makeCall failure - makeCall already making a call'),e.reject()):(g.makingCall=!0,o?g.makeConsultationCall(t,a,o.connectionId):g.makeSimpleCall(t,a,r))},g.makeSimpleCall=function(o,i,c){return e(function(e,p){if(n.info('[telephonyService] makeSimpleCall to '+(o?o.getNameForLogs():m.anonymizePhoneNumber(i))),!g.isBasicCallAllowed){var u=new Error('makeSimpleCall failure - Not Allowed');u.status=u.errorDetailsCode='403',n.error('[telephonyService] '+u.message),g.makingCall=!1,p(u)}var v=g.getPhoneInfo(o,i),f='POST',S=g.portalURL+'calls',C={calleeExtNumber:v.longNumber,calleeIntNumber:v.internalNumber,calleeShortNumber:v.shortNumber,calleePbxId:v.pbxId,calleeDisplayName:o.displayName,callSubject:c,secondaryDeviceMakeCall:angular.isDefined(g.nomadicObject.makeCallInitiatorIsMain)&&!0===g.nomadicObject.featureActivated&&g.isNomadicEnabled?g.nomadicObject.makeCallInitiatorIsMain?'false':'true':void 0};n.info('[telephonyService] makeSimpleCall '+f+' '+S),n.info('[telephonyService] makeSimpleCall data: '+JSON.stringify(C)),a({method:f,url:S,headers:s.getRequestHeader(),data:C}).then(function(t){n.info('[telephonyService] makeSimpleCall success : callee '+m.anonymizePhoneNumber(i));var a=d.create(d.Status.DIALING,null,d.Type.PHONE,o);a.setConnectionId(t.data.data.callId),a.setRelevantEquipmentId(d.getDeviceIdFromConnectionId(a.connectionId)),a.isSecondary=g.nomadicObject&&!g.nomadicObject.makeCallInitiatorIsMain,g.calls[a.id]=a,n.info('[telephonyService] makeSimpleCall Call created ('+a+')'),g.makingCall=!1,a.setIsVm(i===g.voicemailNumber),r.$broadcast('ON_CALL_UPDATED_EVENT',a),e(a.id)},function(e){var a=d.create(d.Status.ERROR,null,d.Type.PHONE,o);a.errorMessage=e&&'403'===e.errorDetailsCode?'notAllowed':'invalidPhoneNumber',g.calls[a.contact.id]=a,a.autoClear=t(function(){g.clearCall(a)},5e3,1),g.makingCall=!1,r.$broadcast('ON_CALL_UPDATED_EVENT',a);var i=l.handleError(e);p(i),n.error('[telephonyService] '+l.getErrorFullMessage(e,'makeCall'))})})},g.makeConsultationCall=function(o,i,c){return e(function(e,p){if(n.info('[telephonyService] makeConsultationCall to '+(o?o.getNameForLogs():m.anonymizePhoneNumber(i))),!g.isSecondCallAllowed){var u=new Error('makeConsultationCall failure - Not Allowed');u.status=u.errorDetailsCode='403',n.error('[telephonyService] '+u.message),g.makingCall=!1,p(u)}var v=g.getPhoneInfo(o,i),f='POST',S=g.portalURL+'calls/'+encodeURIComponent(c)+'/consultation',C={calleeExtNumber:v.longNumber,calleeIntNumber:v.internalNumber,calleeShortNumber:v.shortNumber,calleePbxId:v.pbxId,calleeDisplayName:o.displayName};n.info('[telephonyService] makeConsultationCall '+f+' '+S),n.info('[telephonyService] makeConsultationCall data: '+JSON.stringify(C)),a({method:f,url:S,headers:s.getRequestHeader(),data:C}).then(function(t){n.info('[telephonyService] makeConsultationCall success : callee '+m.anonymizePhoneNumber(i));var a=d.create(d.Status.DIALING,null,d.Type.PHONE,o);a.setConnectionId(t.data.data.callId),a.setRelevantEquipmentId(d.getDeviceIdFromConnectionId(a.connectionId)),a.isSecondary=g.nomadicObject&&!g.nomadicObject.makeCallInitiatorIsMain,g.calls[a.id]=a,n.info('[telephonyService] makeConsultationCall Call created ('+a+')'),g.makingCall=!1,a.setIsVm(i===g.voicemailNumber),r.$broadcast('ON_CALL_UPDATED_EVENT',a),e(a.id)},function(e){var a=d.create(d.Status.ERROR,null,d.Type.PHONE,o);a.errorMessage=e&&'403'===e.errorDetailsCode?'notAllowed':'invalidPhoneNumber',g.calls[a.contact.id]=a,a.autoClear=t(function(){g.clearCall(a)},5e3,1),g.makingCall=!1;var i=l.handleError(e);g.deleteCallIfInvalid(i,g.calls[d.getIdFromConnectionId(c)]),r.$broadcast('ON_CALL_UPDATED_EVENT',a),p(i),n.error('[telephonyService] '+l.getErrorFullMessage(e,'makeConsultationCall'))})})},g.makeCallByPhoneNumber=function(t){return e(function(e,a){if(n.info('[telephonyService] makeCallByPhoneNumber : '+m.anonymizePhoneNumber(t)),i.userContact.phonePro===t||i.userContact.phoneProCan===t||i.userContact.phonePbx===t){var r='makeCallByPhoneNumber failure: impossible to call its own phone number';n.error('[telephonyService] '+r),a(new Error(r))}var o=null;i.getOrCreateContact(null,t).then(function(e){return o=e,g.makeCall(e,t)}).then(function(){e()}).catch(function(e){var t='makeCallByPhoneNumber failure '+(e?e.message:'');n.error('[telephonyService] - callService - '+t),a(new Error(t))})})},g.getPhoneInfo=function(e,t){var a=t,r='',n='',o='';return e&&(t===e.phonePro||t===e.phoneProCan?(a=e.phoneProCan?e.phoneProCan:'',r=e.phonePbx,o=e.pbxId,n=e.phoneInternalNumber):t===e.phonePbx&&(a='',r=e.phonePbx,o=e.pbxId,n=e.phoneInternalNumber)),{longNumber:a,shortNumber:r,pbxId:o,internalNumber:n}},g.getErrorMessage=function(e,t){var a=t+' failure : ';if('error'===angular.element(e).attr('type')){var r=angular.element(e).find('error');if(r){var o=r.attr('type'),i=r.attr('code');o&&(a+=o+' : ','modify'===o&&(a+=r.find('text').text())),i&&'503'===i&&(a+='Agent error : service unavailable'),n.error('[telephonyService] '+a)}else a+='Unknown error';return a}return null},g.releaseCall=function(t){return e(function(e,o){if(n.info('[telephonyService] releaseCall '+t.id),!g.isBasicCallAllowed){var i=new Error('releaseCall failure - Not Allowed');i.status=i.errorDetailsCode='403',n.error('[telephonyService] '+i.message),o(i)}var c='DELETE',p=g.portalURL+'calls/'+encodeURIComponent(t.connectionId);n.info('[telephonyService] releaseCall '+c+' '+p),a({method:c,url:p,headers:s.getRequestHeader()}).then(function(){t.setStatus(d.Status.UNKNOWN),t.startDate=null,t.vm=!1,n.info('[telephonyService] releaseCall '+t.id+' - success'),r.$broadcast('ON_CALL_UPDATED_EVENT',t),delete g.calls[t.id],e(t)},function(e){var a=l.handleError(e);g.deleteCallIfInvalid(a,t),o(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'releaseCall'))})})},g.deleteCallIfInvalid=function(e,t){e&&'telephony'===e.portal&&404100===e.errorDetailsCode&&'Invalid connection identifier.'===e.message&&t&&(n.warn('[telephonyService] deleteCallIfInvalid: delete client call non existing on server: '+t.id),t.setStatus(d.Status.UNKNOWN),r.$broadcast('ON_CALL_UPDATED_EVENT',t),g.calls[t.id]&&delete g.calls[t.id])},g.answerCall=function(t){return e(function(e,o){n.info('[telephonyService] answerCall : '+t.id);var i=g.getActiveCall();if(!g.isBasicCallAllowed){var c=new Error('answerCall failure - Not Allowed');c.status=c.errorDetailsCode='403',n.error('[telephonyService] '+c.message),o(c)}t.status===d.Status.QUEUED_INCOMMING&&i?g.holdCall(i).then(function(){return g.answerCall(t)}).then(function(t){e(t)}).catch(function(e){var t='answerCall failure : '+e.message;n.error('[telephonyService] - callService -  '+t),o(new Error(t))}):a({method:'PUT',url:g.portalURL+'calls/'+encodeURIComponent(t.connectionId)+'/answer',headers:s.getRequestHeader()}).then(function(a){t.setConnectionId(a.data.data.callId),t.setStatus(d.Status.ACTIVE),n.info('[telephonyService] answerCall success : '+m.anonymizePhoneNumber(t.contact.phone)+' Call ('+t+')'),r.$broadcast('ON_CALL_UPDATED_EVENT',t),e(t)},function(e){e.data&&'Device is not able to answer a call'===e.data.errorDetails&&r.$broadcast('ON_OPEN_GLOBAL_POPUP',{autoClose:!1,okLabel:'close',popupTitle:'warning',popupBody:'deviceDoesntAllowAnswer'}),t.setStatus(d.Status.UNKNOWN);var a=l.handleError(e);o(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'answerCall'))})})},g.holdCall=function(t){return e(function(e,o){if(t&&t.status!==d.Status.HOLD||e(t),!g.isSecondCallAllowed){var i=new Error('holdCall failure - Not Allowed');i.status=i.errorDetailsCode='403',n.error('[telephonyService] '+i.message),o(i)}a({method:'PUT',url:g.portalURL+'calls/'+encodeURIComponent(t.connectionId)+'/hold',headers:s.getRequestHeader()}).then(function(a){n.info('[telephonyService] holdCall success : '+m.anonymizePhoneNumber(t.contact.phone)+' Call ('+t+')'),t.setConnectionId(a.data.data.callId),t.setStatus(d.Status.HOLD),r.$broadcast('ON_CALL_UPDATED_EVENT',t),e(t)},function(e){var t=l.handleError(e);o(t),n.error('[telephonyService] '+l.getErrorFullMessage(e,'holdCall'))})})},g.retrieveCall=function(t){return e(function(e,o){if(n.info('[telephonyService] retrieveCall : '+t.contact.displayNameForLog()),!g.isSecondCallAllowed){var i=new Error('retrieveCall failure - Not Allowed');i.status=i.errorDetailsCode='403',n.error('[telephonyService] '+i.message),o(i)}var c=g.getActiveCall();c?g.holdCall(c).then(function(){return g.retrieveCall(t)}).then(function(t){e(t)}).catch(function(e){var t='retrieveCall failure : '+e.message;n.error('[telephonyService] - callService -  '+t),o(new Error(t))}):a({method:'PUT',url:g.portalURL+'calls/'+encodeURIComponent(t.connectionId)+'/retrieve',headers:s.getRequestHeader()}).then(function(a){n.info('[telephonyService] retrieveCall success : '+m.anonymizePhoneNumber(t.contact.phone)+' Call ('+t+')'),t.setConnectionId(a.data.data.callId),t.setStatus(d.Status.ACTIVE),r.$broadcast('ON_CALL_UPDATED_EVENT',t),e()},function(e){var a=l.handleError(e);g.deleteCallIfInvalid(a,t),o(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'retrieveCall'))})})},g.deflectCallToVM=function(t){return e(function(e,r){if(t||e(t),!g.isVMDeflectCallAllowed){var o=new Error('deflectCall failure - Not Allowed');o.status=o.errorDetailsCode='403',n.error('[telephonyService] '+o.message),r(o)}n.info('[telephonyService] deflectCallToVM '+t.contact.displayNameForLog()),a({method:'PUT',url:g.portalURL+'calls/'+encodeURIComponent(t.connectionId)+'/deflect',headers:s.getRequestHeader(),data:{calleeExtNumber:'',calleeIntNumber:g.voicemailNumber,calleeShortNumber:g.voicemailNumber,calleePbxId:g.pbxId}}).then(function(){n.info('[telephonyService] deflectCall success'),e()},function(e){var t=l.handleError(e);r(t),n.error('[telephonyService] '+l.getErrorFullMessage(e,'deflectCallToVM'))})})},g.transfertCall=function(t,r){return e(function(e,o){if(t&&r||e(),!g.isTransferAllowed){var i=new Error('transferCall failure - Not Allowed');i.status=i.errorDetailsCode='403',n.error('[telephonyService] '+i.message),o(i)}n.info('[telephonyService] transfertCall held('+r.contact.displayName+') to active('+t.contact.displayName+')'),a({method:'PUT',url:g.portalURL+'calls/'+encodeURIComponent(t.connectionId)+'/transfer/'+encodeURIComponent(r.connectionId),headers:s.getRequestHeader()}).then(function(){n.info('[telephonyService] transferCall success'),e()},function(e){var t=l.handleError(e);o(t),n.error('[telephonyService] '+l.getErrorFullMessage(e,'transfertCall'))})})},g.conferenceCall=function(t,r){return e(function(e,o){if(t&&r||e(),!g.isConferenceAllowed){var i=new Error('conferenceCall failure - Not Allowed');i.status=i.errorDetailsCode='403',n.error('[telephonyService] '+i.message),o(i)}n.info('[telephonyService] conferenceCall '+t.contact.displayName+' and '+r.contact.displayName),a({method:'PUT',url:g.portalURL+'calls/'+encodeURIComponent(t.connectionId)+'/conference/'+encodeURIComponent(r.connectionId),headers:s.getRequestHeader()}).then(function(){n.info('[telephonyService] conferenceCall success'),e()},function(e){var t=l.handleError(e);o(t),n.error('[telephonyService] '+l.getErrorFullMessage(e,'conferenceCall'))})})},g.forwardToDevice=function(t){return e(function(e,r){if(n.info('[telephonyService] forwardToDevice : '+t),!g.isForwardEnabled){var o=new Error('forwardToDevice failure - Not Allowed');o.status=o.errorDetailsCode='403',n.error('[telephonyService] '+o.message),r(o)}if(i.userContact.phonePro===t||i.userContact.phoneProCan===t||i.userContact.phonePbx===t){var d='forwardToDevice failure: impossible to forward its own phone number';n.error('[telephonyService] '+d),r(new Error(d))}i.getOrCreateContact(null,t).then(function(o){var i=g.getPhoneInfo(o,t);a({method:'PUT',url:g.portalURL+'forward',headers:s.getRequestHeader(),data:{calleeExtNumber:i.longNumber,calleeIntNumber:i.internalNumber,calleeShortNumber:i.shortNumber,calleePbxId:i.pbxId,calleeDisplayName:o.displayName}}).then(function(){e()},function(e){var t=l.handleError(e);r(t),n.error('[telephonyService] '+l.getErrorFullMessage(e,'forwardToDevice'))})})})},g.forwardToVoicemail=function(){return e(function(e,t){if(n.info('[telephonyService] forwardToVoicemail'),!g.voiceMailFeatureEnabled||!g.isForwardEnabled){var r=new Error('forwardToVoicemail failure - voicemail/forward feature not enabled');r.status=r.errorDetailsCode='404',n.error('[telephonyService] '+r.message),t(r)}a({method:'PUT',url:g.portalURL+'forward',headers:s.getRequestHeader(),data:{calleeExtNumber:'',calleeIntNumber:g.voicemailNumber,calleePbxId:g.pbxId}}).then(function(){n.info('[telephonyService] forwardToVoicemail success'),e()},function(e){var a=l.handleError(e);t(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'forwardToVoicemail'))})})},g.cancelForward=function(){return e(function(e,t){if(n.info('[telephonyService] cancelForward'),!g.isForwardEnabled){var r=new Error('cancelForward failure - Not Allowed');r.status=r.errorDetailsCode='403',n.error('[telephonyService] '+r.message),t(r)}i.userContact.phonePbx?a({method:'PUT',url:g.portalURL+'forward',headers:s.getRequestHeader(),data:{calleeExtNumber:'',calleeIntNumber:'CANCELFORWARD',calleePbxId:g.pbxId}}).then(function(){n.info('[telephonyService] cancelForward success'),e()},function(e){var a=l.handleError(e);t(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'cancelForward'))}):t()})},g.getForwardStatus=function(){return e(function(e,t){if(!g.isForwardEnabled){var r=new Error('getForwardStatus failure - Not Allowed');r.status=r.errorDetailsCode='403',n.error('[telephonyService] '+r.message),t(r)}i.userContact&&i.userContact.phonePbx?a({method:'GET',url:g.portalURL+'forward',headers:s.getRequestHeader()}).then(function(){n.info('[telephonyService] getForwardStatus success'),e()},function(e){var a=l.handleError(e);t(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'getForwardStatus'))}):t()})},g.getForwardObject=function(){return g.forwardObject},g.nomadicLogin=function(t,r){return e(function(e,o){if(!g.isNomadicEnabled||!g.nomadicObject.featureActivated){var d=new Error('nomadicLogin failure - Not Allowed');d.status=d.errorDetailsCode='403',n.error('[telephonyService] '+d.message),o(d)}if(i.userContact.phonePro===t||i.userContact.phoneProCan===t||i.userContact.phonePbx===t){var c='nomadicLogin failure: impossible to use its own phone number like nomadic phone';n.error('[telephonyService] '+c),o(new Error(c))}n.info('[telephonyService] nomadicLogin : '+t),r=r||!1,g.nomadicAnswerNotTakedIntoAccount=r,i.getOrCreateContact(null,t).then(function(r){var i=g.getPhoneInfo(r,t);a({method:'PUT',url:g.portalURL+'nomadic/login',headers:s.getRequestHeader(),data:{destinationExtNumber:i.longNumber,destinationIntNumber:i.internalNumber,destinationShortNumber:i.shortNumber,destinationPbxId:i.pbxId,destinationDisplayName:r.displayName,destinationCountry:r.country}}).then(function(){n.info('[telephonyService] nomadicLogin success'),e()},function(e){var t=l.handleError(e);o(t),n.error('[telephonyService] '+l.getErrorFullMessage(e,'nomadicLogin'))})})})},g.nomadicLoginOnOfficePhone=function(){return e(function(e,t){if(!g.isNomadicEnabled||!g.nomadicObject.featureActivated){var r=new Error('nomadicLoginOnOfficePhone failure - Not Allowed');r.status=r.errorDetailsCode='403',n.error('[telephonyService] '+r.message),t(r)}n.info('[telephonyService] nomadicLoginOnOfficePhone'),a({method:'PUT',url:g.portalURL+'nomadic/login',headers:s.getRequestHeader()}).then(function(){n.info('[telephonyService] nomadicLoginOnOfficePhone success'),e()},function(e){var a=l.handleError(e);t(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'nomadicLoginOnOfficePhone'))})})},g.nomadicLogout=function(){return e(function(e,t){if(!g.isNomadicEnabled||!g.nomadicObject.featureActivated){var r=new Error('nomadicLogout failure - Not Allowed');r.status=r.errorDetailsCode='403',n.error('[telephonyService] '+r.message),t(r)}n.info('[telephonyService] nomadicLogout'),a({method:'PUT',url:g.portalURL+'nomadic/logout',headers:s.getRequestHeader()}).then(function(){n.info('[telephonyService] nomadicLogout success'),e()},function(e){var a=l.handleError(e);t(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'nomadicLogout'))})})},g.getNomadicStatus=function(){return e(function(e,t){if(!g.isNomadicEnabled){var r=new Error('getNomadicStatus failure - Not Allowed');r.status=r.errorDetailsCode='403',n.error('[telephonyService] '+r.message),t(r)}i.userContact&&i.userContact.phonePbx?a({method:'GET',url:g.portalURL+'nomadic',headers:s.getRequestHeader()}).then(function(t){n.info('[telephonyService] nomadicStatus success'),g.updateNomadicData(t.data.data),e()},function(e){var a=l.handleError(e);t(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'getNomadicStatus'))}):t()})},g.setNomadicState=function(){return e(function(e,t){n.info('[telephonyService] setNomadicState'),a({method:'PUT',url:g.portalURL+'nomadic/state',headers:s.getRequestHeader(),data:{makeCallInitiatorIsMain:'true'}}).then(function(){n.info('[telephonyService] setNomadicState success'),e()},function(e){var a=l.handleError(e);t(a),n.error('[telephonyService] '+l.getErrorFullMessage(e,'setNomadicState'))})})},g.updateNomadicData=function(e){if(n.info('[telephonyService] updateNomadicData destination:'+e.destination+' featureActivated:'+e.featureActivated+' makeCallInitiatorIsMain:'+e.makeCallInitiatorIsMain+' modeActivated:'+e.modeActivated+' monodevice:'+i.userContact.isVirtualTerm),g.nomadicObject.featureActivated='true'===e.featureActivated,g.nomadicObject.modeActivated='true'===e.modeActivated,g.nomadicObject.destination=e.destination,g.nomadicObject.makeCallInitiatorIsMain='true'===e.makeCallInitiatorIsMain,g.nomadicAnswerNotTakedIntoAccount||r.$broadcast('ON_CALL_NOMADIC_EVENT',g.nomadicObject),g.nomadicAnswerNotTakedIntoAccount=!1,i.userContact.isVirtualTerm&&g.nomadicObject.featureActivated&&(''===g.nomadicObject.destination||void 0===g.nomadicObject.destination)&&(i.userContact.mobileProCan||i.userContact.mobilePerso)){var t=i.userContact.mobileProCan?i.userContact.mobileProCan:i.userContact.mobilePerso;g.nomadicLogin(t)}},g.getNomadicObject=function(){return g.nomadicObject},g.getNomadicDestination=function(){return g.nomadicObject.destination},g.sendDtmf=function(t,o){return e(function(e,i){t&&o?a({method:'PUT',url:g.portalURL+'calls/'+encodeURIComponent(t.connectionId)+'/dtmf',headers:s.getRequestHeader(),data:{dtmf:o}}).then(function(){r.$broadcast('ON_DTMF_SENT',o),e()},function(e){var t=l.handleError(e);i(t),n.error('[telephonyService] '+l.getErrorFullMessage(e,'sendDtmf'))}):i()})},g.clearCall=function(e,t){n.info('[telephonyService] clearCall for call id: '+e.id),e.setStatus(d.Status.UNKNOWN),t||r.$broadcast('ON_CALL_UPDATED_EVENT',e),e.contact&&delete g.calls[e.contact.id],e.getCurrentCalled()&&e.setCurrentCalled(null)},g.startAsPhoneNumber=function(e){var t=e.trim().split('.').join(''),a=/^(\+|\d|#|\*|\(|\)|\.|-|\s|\/)*$/,r=t.match(a);return!!r&&r[0]===t},g.updateContactFromOutlookInfos=function(){return n.info('[telephonyService] default updateContactFromOutlookInfos'),e.reject()}}])},function(){angular.module('rainbow').factory('TelephonyServiceEventHandler',['$log','$q','$rootScope','$interval','$injector','contactService','Call','profileService','Contact','PromiseQueue','pstnConferenceService','utilService',function(e,t,a,r,n,o,s,i,d,c,l,p){'use strict';function u(e){this.telephonyService=e,this.promiseQueue=c.create()}return u.create=function(e){return new u(e)},u.CallFailureLabels={DESTNOTOBTAINABLE:'outOfService',DONOTDISTURB:'dnd',TRUNKSBUSY:'trunksbusy',BUSY:'busy'},u.prototype.onCallserviceMessageReceived=function(t){try{var a=$(t),r=this,n=a.find('delay');if('Offline Storage'===n.text())return!0;var o=a.find('callservice').children(),i=o.prop('tagName').split(':'),s=i[i.length-1].toLowerCase(),d=o.attr('callId');d=d?' -- '+d:'';var c=o.attr('deviceType');c=c?' -- '+c:'';var l=o.attr('oldCallId');switch(l=l?' -- '+l:'',e.info('[TelephonyServiceEventHandler] onCallserviceMessageReceived -- '+s.toUpperCase()+d+l+c),s){case'initiated':this.promiseQueue.add(function(){return r.onInitiatedEvent(o)});break;case'originated':this.promiseQueue.add(function(){return r.onOriginatedEvent(o)});break;case'delivered':this.promiseQueue.add(function(){return r.onDeliveredEvent(o)});break;case'established':this.promiseQueue.add(function(){return r.onEstablishedEvent(o)});break;case'retrievecall':this.promiseQueue.add(function(){return r.onRetrieveCallEvent(o)});break;case'queued':this.promiseQueue.add(function(){return r.onQueuedEvent(o)});break;case'holdcall':case'held':this.promiseQueue.add(function(){return r.onHeldEvent(o)});break;case'diverted':this.promiseQueue.add(function(){return r.onDivertedEvent(o)});break;case'transfercall':case'transferred':this.promiseQueue.add(function(){return r.onTransferEvent(o)});break;case'conferenced':this.promiseQueue.add(function(){return r.onConferenceEvent(o)});break;case'connectioncleared':this.promiseQueue.add(function(){return r.onClearCallEvent(o)});break;case'failed':this.promiseQueue.add(function(){return r.onFailCallEvent(o)});break;case'messaging':this.promiseQueue.add(function(){return r.onVoiceMessageEvent(o)});break;case'updatecall':this.promiseQueue.add(function(){return r.onUpDateCallEvent(o)});break;case'forwarded':this.promiseQueue.add(function(){return r.onCallForwardedEvent(o)});break;case'callsubject':this.promiseQueue.add(function(){return r.onCallSubjectEvent(o)});break;case'nomadicstatus':this.promiseQueue.add(function(){return r.onCallNomadicEvent(o)});break;case'openDesktop':e.info('[TelephonyServiceEventHandler] openDesktop detected ');break;default:}return!0}catch(t){return e.error('[TelephonyServiceEventHandler] onCallserviceMessageReceived -- failure -- '+t.message),!0}},u.prototype.onInitiatedEvent=function(a){e.info('[TelephonyServiceEventHandler] onInitiatedEvent');var r=this;return this.getCall(a).then(function(o){try{var i=a.attr('deviceState'),d=a.attr('newCallId');return void 0!==d&&r.getOrCreateCall(d).then(function(t){e.info('[TelephonyServiceEventHandler] onInitiatedEvent : changed call id from '+o.id+' to '+d),r.computeCallRelevancy(a,t),'LCI_CONNECTED'===i?t.setStatus(s.Status.ACTIVE):t.setStatus(o.status),t.setContact(o.contact);var c=l.getConferenceSessionWithConnId(o.connectionId);if(c&&c.setCallId(d),o.isMediaPillarCall()){var p=n.get('webrtcGatewayService');p.replaceCallRefs(t,o)}r.telephonyService.clearCall(o),r.sendCallUpdateEvent(o),r.sendCallUpdateEvent(t),delete r.telephonyService.calls[o.id]}),t.when()}catch(a){var c='onInitiatedEvent -- '+a.message;return e.error('[TelephonyServiceEventHandler] '+c),t.reject(new Error(c))}})},u.prototype.onOriginatedEvent=function(a){e.info('[TelephonyServiceEventHandler] onOriginatedEvent');var r=this;return this.getCall(a).then(function(o){try{var i=a.attr('endpointIm'),s=a.attr('endpointTel'),d=a.attr('newCallId'),c={contactPhoneNumber:'',contact:o.contact,participantsPhoneNumbers:null,participants:null};return i||s?c.contactPhoneNumber=s?s:'':o.contact&&o.contact.temp&&(c.contactPhoneNumber=o.contact.id),o.setCurrentCalled(c),void 0===d?r.sendCallUpdateEvent(o):r.getOrCreateCall(d,i,s).then(function(t){e.info('[TelephonyServiceEventHandler] onOriginatedEvent : changed call id from '+o.id+' to '+d),r.computeCallRelevancy(a,t),t.setStatus(o.status),t.setContact(o.contact),t.setCurrentCalled(c);var i=l.getConferenceSessionWithConnId(o.connectionId);if(i&&i.setCallId(d),o.isMediaPillarCall()){var s=n.get('webrtcGatewayService');s.replaceCallRefs(t,o)}r.telephonyService.clearCall(o),r.sendCallUpdateEvent(o),r.sendCallUpdateEvent(t),delete r.telephonyService.calls[o.id]}),t.when()}catch(a){var p='onOriginatedEvent -- '+a.message;return e.error('[TelephonyServiceEventHandler] '+p),t.reject(new Error(p))}})},u.prototype.onDeliveredEvent=function(a){e.info('[TelephonyServiceEventHandler] onDeliveredEvent');var r=this;return this.getCall(a).then(function(n){try{if(r.computeCallRelevancy(a,n),n.status===s.Status.QUEUED_INCOMMING)return t.resolve();var o=a.attr('type'),i=a.attr('endpointIm'),d=a.attr('endpointTel');return n.setStatus('outgoing'===o?s.Status.RINGING_OUTGOING:s.Status.RINGING_INCOMMING),n.startDate=null,n.vm=!1,r.updateCallContact(i,d,a,n)}catch(a){var c='onDeliveredEvent -- '+a.message;return e.error('[TelephonyServiceEventHandler] '+c),t.reject(new Error(c))}})},u.prototype.onEstablishedEvent=function(a){e.info('[TelephonyServiceEventHandler] onEstablishedEvent');var r=this;return this.getCall(a).then(function(n){try{r.computeCallRelevancy(a,n);var d=a.attr('endpointIm'),c=a.attr('endpointTel'),l=a.attr('callId');if(n.contact&&n.contact.id)return n.setStatus(s.Status.ACTIVE),n.setConnectionId(l),r.sendCallUpdateEvent(n,a),r.updateCallContact(d,c,a,n);if(n.participants&&0<n.participants.length){for(var p=null,u=0;u<n.participants.length&&!p;u++)n.participants[u].id===d?p=n.participants[u]:n.currentCalled.participantsPhoneNumbers&&0<n.currentCalled.participantsPhoneNumbers.length&&n.currentCalled.participantsPhoneNumbers[u]===c&&(p=n.participants[u]);n.participants=[],n.isConference=!1;var i=n.getCurrentCalled();if(p)n.setContact(p),n.setStatus(s.Status.ACTIVE),i={contactPhoneNumber:c,contact:p},n.setCurrentCalled(i),r.sendCallUpdateEvent(n,a);else return d||c||(c='****'),o.getOrCreateContact(d,c).then(function(e){return n.setContact(e),n.setStatus(s.Status.ACTIVE),i={contactPhoneNumber:c,contact:e},n.setCurrentCalled(i),r.sendCallUpdateEvent(n,a),t.when()})}else return e.info('[TelephonyServiceEventHandler] onEstablishedEvent, no call contact / no participants'),d||c||(c='****'),o.getOrCreateContact(d,c).then(function(e){return n.setContact(e),n.setStatus(s.Status.ACTIVE),i={contactPhoneNumber:c,contact:e},n.setCurrentCalled(i),r.sendCallUpdateEvent(n,a),t.when()});return t.when()}catch(a){var m='onEstablishedEvent -- '+a.message;return e.error('[TelephonyServiceEventHandler] '+m),t.reject(new Error(m))}})},u.prototype.onRetrieveCallEvent=function(t){e.info('[TelephonyServiceEventHandler] onRetrieveCallEvent');var a=this;return this.getCall(t,!0).then(function(e){e.setStatus(s.Status.ACTIVE),a.sendCallUpdateEvent(e,t)})},u.prototype.onClearCallEvent=function(a){var r=this,n=a.attr('callId'),o=s.getIdFromConnectionId(n);return(e.info('[TelephonyServiceEventHandler] onClearCallEvent, connectionId: '+n),this.telephonyService.calls[o])?this.getCall(a).then(function(e){r.computeCallRelevancy(a,e),r.telephonyService.clearCall(e,!0),r.sendCallUpdateEvent(e,a)}):(e.info('[TelephonyServiceEventHandler] onClearCallEvent, no call for connectionId: '+n),t.resolve())},u.prototype.onHeldEvent=function(a){e.info('[TelephonyServiceEventHandler] onHeldEvent');var r=this;return this.getCall(a,!0).then(function(n){try{var o=a.attr('callId'),i=s.getDeviceIdFromConnectionId(n.connectionId),d=s.getDeviceIdFromConnectionId(o);return i===d?n.setStatus(s.Status.HOLD):n.setStatus(s.Status.PUT_ON_HOLD),r.sendCallUpdateEvent(n,a),t.when()}catch(a){var c='onHeldEvent -- '+a.message;return e.error('[TelephonyServiceEventHandler] '+c),t.reject(new Error(c))}})},u.prototype.onQueuedEvent=function(a){e.info('[TelephonyServiceEventHandler] onQueuedEvent');var r=this,n=a.attr('cause');return'PARK'===n?(e.warn('[TelephonyServiceEventHandler] onQueuedEvent - ignore PARK cause'),t.when()):'NEWCALL'===n?(e.warn('[TelephonyServiceEventHandler] onQueuedEvent - ignore NEWCALL cause'),t.when()):this.getCall(a).then(function(n){try{r.computeCallRelevancy(a,n);var o=a.attr('type'),i=a.attr('endpointIm'),d=a.attr('endpointTel'),c='outgoing'===o?s.Status.QUEUED_OUTGOING:s.Status.QUEUED_INCOMMING;return n.setStatus(c),n.startDate=null,n.vm=!1,n.relevantEquipmentId=s.getDeviceIdFromConnectionId(n.connectionId),r.updateCallContact(i,d,a,n)}catch(a){var l='onQueuedEvent -- '+a.message;return e.error('[TelephonyServiceEventHandler] '+l),t.reject(new Error(l))}})},u.prototype.onDivertedEvent=function(a){e.info('[TelephonyServiceEventHandler] onDivertedEvent');var r=this,o=a.attr('oldCallId'),i=s.getIdFromConnectionId(o),d=this.telephonyService.calls[i];if(!d)return e.warn('[TelephonyServiceEventHandler] onDivertedEvent - receive divertedEvent on unknown call --- ignored'),t.when();r.computeCallRelevancy(a,d);var c=n.get('webrtcGatewayService');return c.isMediaPillarCallCase()?d.isSecondary?this.telephonyService.clearCall(d):this.telephonyService.clearCall(d,!0):this.telephonyService.clearCall(d),this.sendCallUpdateEvent(d,a),t.when()},u.prototype.onTransferEvent=function(a){e.info('[TelephonyServiceEventHandler] onTransferEvent');var r=this,n=a.attr('activeCallId'),o=a.attr('heldCallId'),i=a.attr('newCallId'),d=s.getIdFromConnectionId(n),c=this.telephonyService.calls[d];if(o){var l=s.getIdFromConnectionId(o),p=this.telephonyService.calls[l];p.setStatus(s.Status.UNKNOWN),c.setStatus(s.Status.UNKNOWN),r.sendCallUpdateEvent(p),r.sendCallUpdateEvent(c)}if(i){var u=a.attr('newEndpointIm'),m=a.attr('newEndpointTel'),g=a.attr('deviceState');return g||(g=a.attr('deviceStatus')),c.setStatus(s.Status.UNKNOWN),r.sendCallUpdateEvent(c),u||m||(m='****'),this.getOrCreateCall(i,u,m).then(function(e){return g&&'LCI_ALERTING'===g?e.setStatus(s.Status.RINGING_INCOMMING):e.setStatus(s.Status.ACTIVE),e.relevantEquipmentId=s.getDeviceIdFromConnectionId(i),r.updateCallContact(u,m,a,e)})}return t.resolve()},u.prototype.onConferenceEvent=function(a){e.info('[TelephonyServiceEventHandler] onConferenceEvent');var r=this,n=a.find('primaryOldCallId').text(),i=a.find('secondaryOldCallId').text(),d=a.find('newCallId').text(),c=s.getIdFromConnectionId(n),l=s.getIdFromConnectionId(i),p=this.telephonyService.calls[c],u=this.telephonyService.calls[l],m=[],g=[],v=[];return a.find('participant').each(function(){var a=angular.element(this),n=a.find('endpointTel').text(),i=a.find('endpointIm').text();i&&o.isUserContactJid(i)||g.push(t(function(t){i||n||(n='****'),!i&&p&&p.contact&&p.currentCalled.contactPhoneNumber===n?(m.push(p.contact),v.push(n),t()):!i&&u&&u.contact&&u.currentCalled.contactPhoneNumber===n?(m.push(u.contact),v.push(n),t()):o.getOrCreateContact(i,n).then(function(a){m.push(a),v.push(n),r.telephonyService.updateContactFromOutlookInfos(a,n).then(function(t){t?e.debug('[TelephonyServiceEventHandler] on conferenced, update from outlook for contact :'+a.displayNameMD5):e.debug('[TelephonyServiceEventHandler] on conferenced, no update from outlook for contact :'+a.displayNameMD5)},function(){e.debug('[TelephonyServiceEventHandler] on conferenced, no Outlook search available')}).finally(function(){t()})}).catch(function(a){e.error('[TelephonyServiceEventHandler] onConferenceEvent - Impossible to get contact - '+a.message),t()})}))}),t.all(g).finally(function(){var t=!1;p&&(t=t||p.isSecondary),u&&(t=t||u.isSecondary);var a=r.createConferenceCall(d,m),n=a.getCurrentCalled();n.participants=m,n.participantsPhoneNumbers=v,a.setCurrentCalled(n),a.setStatus(s.Status.ACTIVE),a.relevantEquipmentId=s.getDeviceIdFromConnectionId(d),a.isSecondary=t,e.debug('[TelephonyServiceEventHandler] on conferenced, create new call: '+a),r.sendCallUpdateEvent(a),p&&(p.setStatus(s.Status.UNKNOWN),e.debug('[TelephonyServiceEventHandler] on conferenced, updated primaryOldCall: '+p),r.sendCallUpdateEvent(p)),u&&(u.setStatus(s.Status.UNKNOWN),e.debug('[TelephonyServiceEventHandler] on conferenced, updated secondaryOldCall: '+u),r.sendCallUpdateEvent(u))})},u.prototype.onVoiceMessageEvent=function(r){if(e.info('[TelephonyServiceEventHandler] onVoiceMessageEvent'),!i.isFeatureEnabled(i.FeaturesEnum.TELEPHONY_VOICE_MAIL))return e.info('[TelephonyServiceEventHandler] onVoiceMessageEvent feature not enabled => IGNORED event'),t.when();var n=r.find('voiceMessageCounter').text();if(n){var o=+n;Number.isInteger(o)&&0<=o&&(this.telephonyService.voiceMail.setVMCounter(o),this.telephonyService.voiceMail.setVMFlag(0<o),this.telephonyService.voiceMail.setInfoMsg(''),a.$broadcast('ON_VOICE_MESSAGE_UPDATE_EVENT',o))}var s=r.find('voiceMessageWaiting').text();return'changed'===s&&this.telephonyService.getVoiceMessageCounter(),t.when()},u.prototype.onUpDateCallEvent=function(a){e.info('[TelephonyServiceEventHandler] onUpDateCallEvent');var n=this;return this.getCall(a).then(function(s){var c=a.attr('endpointIm'),l=a.attr('endpointTel'),u='',m='',g=a.find('identity').attr('firstName'),v=a.find('identity').attr('lastName'),f=a.find('identity').attr('displayName'),S=!1;if(!config.permitSearchFromPhoneBook&&!i.isFeatureEnabled(i.FeaturesEnum.TELEPHONY_PHONE_BOOK))return e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent xnames not allowed for the user profile => IGNORED event'),t.when();if(v&&v.length)m=v,g&&g.length&&(u=g),e.info('[TelephonyServiceEventHandler] onUpDateCallEvent received for call '+s.id+' for phoneNumber:'+p.anonymizePhoneNumber(l)+' with name : '+u.slice(0,1)+'***');else if(f&&f.length&&f!==l)m=f,e.info('[TelephonyServiceEventHandler] onUpDateCallEvent only displayName available');else return e.info('[TelephonyServiceEventHandler] onUpDateCallEvent xnames not available => IGNORED event'),t.when();return o.getOrCreateContact(c,l).then(function(t){if(t.temp){if(t.updateName(u,m),s.contact&&s.contact.id){var o={contactPhoneNumber:l,contact:t};(s.contact.id!==t.id||s.contact.displayName===l||s.contact.getNameUpdatePrio()===d.NameUpdatePrio.OUTLOOK_UPDATE_PRIO)&&(t.setNameUpdatePrio(d.NameUpdatePrio.SERVER_UPDATE_PRIO),s.setContact(t),s.setCurrentCalled(o),S=!0,e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent xnames updated for '+l+' with contact : '+t.displayNameMD5))}else if(s.participants&&0<s.participants.length){for(var o=s.getCurrentCalled(),p=0;p<s.participants.length;p++)s.participants[p].temp?s.participants[p].phoneProCan&&s.participants[p].phoneProCan===l&&(e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent temp participant '+s.participants[p].displayNameMD5+' updated with : '+t.displayNameMD5),s.participants[p]=t,s.participants[p].setNameUpdatePrio(d.NameUpdatePrio.SERVER_UPDATE_PRIO),o.participantsPhoneNumbers[p]=l,o.participants[p]=t,S=!0):e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent STRANGE former participant was a rainbow: '+s.participants[p].displayNameMD5);s.setCurrentCalled(o)}}else if(s.contact&&s.contact.id){var o={contactPhoneNumber:l,contact:t};s.contact.id!==t.id&&(s.contact.temp&&(s.contact.updateName(u,m),s.contact.setNameUpdatePrio(d.NameUpdatePrio.SERVER_UPDATE_PRIO)),s.setContact(t),s.setCurrentCalled(o),S=!0,e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent call update with rainbow contact : '+t.displayNameMD5))}else if(s.participants&&0<s.participants.length){for(var o=s.getCurrentCalled(),p=0;p<s.participants.length;p++)s.participants[p].temp?s.participants[p].phoneProCan&&s.participants[p].phoneProCan===l&&(e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent temp participant '+s.participants[p].displayNameMD5+' updated with : '+t.displayNameMD5),s.participants[p]=t,s.setParticipants(s.participants),o.participantsPhoneNumbers[p]=l,o.participants[p]=t,S=!0):s.participants[p].jid===c?(o.participantsPhoneNumbers[p]=l,o.participants[p]=s.participants[p],S=!0,e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent rainbow participant '+s.participants[p].displayNameMD5+' updated with the same : '+t.displayNameMD5)):e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent other participant not updated : '+s.participants[p].displayNameMD5+' vs '+t.displayNameMD5);s.setCurrentCalled(o)}S?r(function(){n.sendCallUpdateEvent(s,a)},300,1):e.debug('[TelephonyServiceEventHandler] onUpDateCallEvent, no update needed for call : '+s.id)})})},u.prototype.onFailCallEvent=function(t){e.info('[TelephonyServiceEventHandler] onFailCallEvent');var a=t.attr('cause'),r=this;return this.getCall(t).then(function(e){e.setStatus(s.Status.ERROR),e.errorMessage=u.CallFailureLabels[a],e.errorMessage||(e.errorMessage=a),r.sendCallUpdateEvent(e,t)})},u.prototype.onCallNomadicEvent=function(a){e.info('[TelephonyServiceEventHandler] onCallNomadicEvent');var r={destination:a.attr('destination'),featureActivated:a.attr('featureActivated'),makeCallInitiatorIsMain:a.attr('makeCallInitiatorIsMain'),modeActivated:a.attr('modeActivated')};return this.telephonyService.updateNomadicData(r),t.when()},u.prototype.onCallForwardedEvent=function(r){return e.info('[TelephonyServiceEventHandler] onCallForwardedEvent'),a.$broadcast('ON_CALL_FORWARDED_EVENT',{forwardType:r.attr('forwardType'),forwardTo:r.attr('forwardTo')}),this.telephonyService.forwardObject.forwardType=r.attr('forwardType'),this.telephonyService.forwardObject.forwardTo=r.attr('forwardTo'),t.when()},u.prototype.onCallSubjectEvent=function(a){e.info('[TelephonyServiceEventHandler] onCallSubjectEvent');var r=this;return this.getCall(a).then(function(n){try{n.subject=a.find('subject').text(),n.subject&&r.sendCallUpdateEvent(n)}catch(a){var o='onCallSubjectEvent -- '+a.message;e.error('[TelephonyServiceEventHandler] '+o),t.reject(new Error(o))}})},u.prototype.computeCallRelevancy=function(t,a){var r=t.attr('newCallId'),n=r?r:t.attr('callId'),o=t.attr('deviceType'),i=s.getDeviceIdFromConnectionId(n),d=this.telephonyService.getNomadicObject(),c=d.makeCallInitiatorIsMain;o||(o='MAIN'),d.modeActivated||(c=!0),'MAIN'===o&&c&&(a.relevantEquipmentId=i,a.connectionId=n),'SECONDARY'!==o||c||(a.relevantEquipmentId=i,a.connectionId=n),a.isSecondary=o&&'SECONDARY'===o&&!c,e.info('[TelephonyServiceEventHandler] computeCallRelevancy -- relevantEquipmentId: '+a.relevantEquipmentId+' connectionId: '+a.connectionId+' isSecondary: '+a.isSecondary)},u.prototype.getCall=function(e,a){var r=this;return t(function(t){var n=e.attr('endpointIm'),o=e.attr('endpointTel'),i=e.attr('callId');r.getOrCreateCall(i,n,o,a).then(function(e){t(e)})})},u.prototype.getOrCreateCall=function(a,r,n,i){var d=this;if(i){var c=a;a=Object.keys(this.telephonyService.calls||[]).find(function(e){var t=d.telephonyService.calls[e];return t.status!==s.Status.UNKNOWN&&s.getCallIdFromConnectionId(e)===s.getCallIdFromConnectionId(a)}),e.debug('[TelephonyServiceEventHandler] getOrCreateCall - search call with callId: '+s.getCallIdFromConnectionId(a)+' from connection id: '+c+' => found connectionId: '+a)}if(!a)return t.reject('no connection id');var l=this.telephonyService.calls[a];return l?(e.debug('[TelephonyServiceEventHandler] getOrCreateCall - '+a+' - '+p.anonymizePhoneNumber(n)+' - '+r+' => found call: '+l),t.when(l)):(e.debug('[TelephonyServiceEventHandler] getOrCreateCall - '+a+' - '+p.anonymizePhoneNumber(n)+' - '+r+' => not found : create call...'),t(function(e){r||n?o.getOrCreateContact(r,n).then(function(t){e(d.telephonyService.getOrCreateCall(s.Status.UNKNOWN,a,t))}):e(d.telephonyService.getOrCreateCall(s.Status.UNKNOWN,a))}))},u.prototype.createConferenceCall=function(e,t){var a=s.create(s.Status.UNKNOWN,null,s.Type.PHONE);return a.setConnectionId(e),a.isConference=!0,a.setParticipants(t),this.telephonyService.calls[a.id]=a,a},u.prototype.sendCallUpdateEvent=function(e,t){var r=this.extractInfoEvent(t);a.$broadcast('ON_CALL_UPDATED_EVENT',e,r)},u.prototype.extractInfoEvent=function(e){var t={actionElemName:'',cause:''};if(e&&null!==e){var a=e.prop('tagName').split(':');t.actionElemName=a[a.length-1].toLowerCase(),t.cause=e.attr('cause'),t.cause=t.cause?t.cause:''}else t=null;return t},u.prototype.analyzeContactChange=function(e,t,a){var r=!1,n=!1;return e||t?a.isConference?void 0:a.contact?(''===e?a.contact.temp?a.contact.id===t?a.contact.displayName===t&&(r=!1,n=!0):(r=!0,n=!0):''!==a.getCurrentCalled().contactPhoneNumber&&''!==t&&a.getCurrentCalled().contactPhoneNumber!==t&&(r=!0,n=!0):a.contact.id!==e&&(r=!0,n=!1),r||n?{updateContactToBeDone:r,searchOutlookToBeDone:n}:null):{updateContactToBeDone:!0,searchOutlookToBeDone:!0}:null},u.prototype.updateCallContact=function(a,r,n,i){var s=this,d=n.prop('tagName').split(':'),c=d[d.length-1].toLowerCase();try{var l=s.analyzeContactChange(a,r,i);return(i.isConference||''===r||i.setCurrentCalledContactNumber(r),l)?o.getOrCreateContact(a,r).then(function(a){return l.searchOutlookToBeDone?s.telephonyService.updateContactFromOutlookInfos(a,r).then(function(t){t?(e.debug('[TelephonyServiceEventHandler] on '+c+', update from outlook for contact :'+a.displayNameMD5),s.makeUpdateContact(i,a,r,c)):(e.debug('[TelephonyServiceEventHandler] on '+c+', no update from outlook for contact :'+a.displayNameMD5),l.updateContactToBeDone?(e.debug('[TelephonyServiceEventHandler] on '+c+', update contact :'+a.displayNameMD5),s.makeUpdateContact(i,a,r,c)):s.sendCallUpdateEvent(i,n))},function(){e.debug('[TelephonyServiceEventHandler] on '+c+', no Outlook search available'),l.updateContactToBeDone?(e.debug('[TelephonyServiceEventHandler] on '+c+', update contact :'+a.displayNameMD5),s.makeUpdateContact(i,a,r,c)):s.sendCallUpdateEvent(i,n)}):(e.debug('[TelephonyServiceEventHandler] on '+c+', update contact :'+a.displayNameMD5),s.makeUpdateContact(i,a,r,c),t.when())}):(s.sendCallUpdateEvent(i,n),t.when())}catch(a){var p='updateCallContact -- '+a.message;return e.error('[TelephonyServiceEventHandler] '+p),t.reject(new Error(p))}},u.prototype.makeUpdateContact=function(e,t,a,n){var o=this;e.setContact(t);e.setCurrentCalled({contactPhoneNumber:a,contact:t}),'delivered'===n&&e.status===s.Status.RINGING_INCOMMING?r(function(){o.sendCallUpdateEvent(e)},300,1):o.sendCallUpdateEvent(e)},u}])},function(){angular.module('rainbow').service('directoryService',['$q','$rootScope','$log','$http','$injector','contactService','authService','orderByFilter','conversationService',function(e,t,a,r,n,o,i,s,d){'use strict';var c=this;this.start=function(e){a.info(''),a.info('[directoryService] === STARTING ===');var t=performance.now();try{c.centralizedService=n.get('centralizedService')}catch(e){}var r=Math.round(performance.now()-t);e.push({service:'directoryService',startDuration:r}),a.info('[directoryService] === STARTED ('+r+' ms) ===')},this.stop=function(){a.info('[directoryService] Stopping'),a.info('[directoryService] Stopped')},this.search=function(n,c,l,p){return a.info('[directoryService] searchContact with text '+n),e(function(e,u){l||(l=20);var m=config.restServerUrl+'/api/rainbow/search/v1.0/users?limit='+l+'&displayName='+encodeURIComponent(n);p&&(m+='&companyId='+encodeURIComponent(p)),r({method:'GET',url:m,headers:i.getRequestHeader()}).then(function(t){var r=t.data.data;a.info('[directoryService] search find '+r.length+' contact(s)');var i=[];if(r.forEach(function(e){if(!o.isUserContactJid(e.jid_im)){var t=o.getContactByJid(e.jid_im);if(!t){var t=o.createBasicContact(e.jid_im);t.updateFromUserData(e),t.getAvatar(),o.dbContacts[e.id]=t,o.jtelContacts[t.jidtel]=t}t.dbId=e.id,t.updateRichStatus(),d.computeCapabilitiesForContact(t,!1),i.push(t)}}),c){var l=o.searchContacts(n);i=i.concat(l.filter(function(e){return e.roster&&0>i.indexOf(e)}))}i=s(i,'_displayName',!1),e(i)},function(e){401===e.data.errorCode&&t.$broadcast('ON_SESSION_EXPIRED_NOTIFICATION_EVENT'),a.warn('[directoryService] searchContact failure '+e.data.errorMsg),u(new Error('Directory service failure'))})})},this.searchUserByLogin=function(n){a.info('[directoryService] searchUserByLogin with "'+n+'"');var s=e.defer(),d=config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port+'/api/rainbow/enduser/v1.0/';return r({method:'POST',url:d+'users/loginEmails',headers:i.getPostHeader(),data:{loginEmail:[n]}}).then(function(e){var t=e.data.data;1===t.length?o.getOrCreateContact(t[0].jid_im).then(function(e){e.loginEmail=n,s.resolve(e)}).catch(function(){s.resolve(null)}):s.resolve(null)},function(e){401===e.data.errorCode&&t.$broadcast('ON_SESSION_EXPIRED_NOTIFICATION_EVENT'),a.warn('[directoryService] searchUserByLogin with "'+n+'" failure'),s.reject(new Error('Directory searchUserByLogin with "'+n+'" failure'))}),s.promise},this.searchUserByJid=function(n){a.info('[directoryService] searchUserByJid with "'+n+'"');var s=e.defer(),d=config.webservices.protocol+'://'+config.webservices.currentServer+':'+config.webservices.port+'/api/rainbow/enduser/v1.0/users/jids/';return r({method:'GET',url:d+encodeURIComponent(n),headers:i.getRequestHeader()}).then(function(e){var t=e.data;t?o.getOrCreateContact(n).then(function(e){e.updateFromUserData(t.data),s.resolve(e)}).catch(function(){s.resolve(null)}):s.resolve(null)},function(e){401===e.data.errorCode&&t.$broadcast('ON_SESSION_EXPIRED_NOTIFICATION_EVENT'),a.warn('[directoryService] searchUserByJid with "'+n+'" failure'),s.reject(new Error('Directory searchUserByJid with "'+n+'" failure'))}),s.promise},this.searchOutlookUsersByName=function(t){return e(function(e){c.centralizedService?c.centralizedService.outlook.searchByNameWithAvatar(t,2).then(function(t){e(t)}).catch(function(){e([])}):e([])})},this.searchOutlookUsersByEmail=function(t){return e(function(e){c.centralizedService?c.centralizedService.outlook.searchByEmailWithAvatar(t,2).then(function(t){e(t)}).catch(function(){e([])}):e([])})},this.searchAllContacts=function(t,r,n,i,s){return a.info('[directoryService] searchAllContacts with text '+t),e(function(e){var a=[];r&&(a=o.searchContacts(t)),c.search(t,!1,i,s).then(function(r){a=a.concat(r.filter(function(e){return!e.roster||0>a.indexOf(e)})),n?c.searchOutlookUsersByEmail(t).then(function(r){var n=[];c.centralizedService&&(r&&r.length&&(n=c.centralizedService.outlook.mergeOutlookContact(n,r)),c.searchOutlookUsersByName(t).then(function(t){t&&t.length&&(n=c.centralizedService.outlook.mergeOutlookContact(n,t)),a=a.concat(n),e(a)}))}):e(a)})})}}])},function(){angular.module('rainbow').service('invitationService',['$q','$log','$http','$rootScope','authService','Invitation','contactService','xmppService','errorHelperService','settingsService',function(e,t,a,r,n,o,i,s,d,c){'use strict';var l=this;l.start=function(a){t.info(''),t.info('[invitationService] === STARTING ===');var n=performance.now();l.receivedInvitations={},l.sentInvitations={},l.acceptedInvitationsArray=[],l.sentInvitationsArray=[],l.receivedInvitationsArray=[],l.listeners=[],l.portalURL=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/',l.attachHandlers(),l.getAllSentInvitations(),l.getAllReceivedInvitations();var o=Math.round(performance.now()-n);return a.push({service:'invitationService',startDuration:o}),t.info('[invitationService] === STARTED ('+o+' ms) ==='),l.listeners.push(r.$on('ON_ROSTER_CHANGED_EVENT',l.getAllSentInvitations)),e.when()},l.stop=function(){t.info(''),t.info('[invitationService] === STOPPING ===');var a;if(l.listeners)for(;a=l.listeners.pop();)a();return t.info('[invitationService] === STOPPED ==='),e.when()},l.attachHandlers=function(){t.info('[invitationService] attachHandlers'),l.contactConfigRef&&(s.connection.deleteHandler(l.contactConfigRef),l.contactConfigRef=null),l.contactConfigRef=s.connection.addHandler(l.onInvitationsUpdate,null,'message','management')},l.onInvitationsUpdate=function(e){var a=$(e).find('userinvite');if(a.length){var r=a.attr('id'),n=a.attr('type'),o=a.attr('action');switch(n){case'received':l.handleReceivedInvitation(r,o);break;case'sent':l.handleSentInvitation(r,o);break;default:t.warn('[invitationService] onInvitationsUpdate - received unexpected type - '+n);}}return!0},l.handleReceivedInvitation=function(e,a){t.info('[invitationService] handleReceivedInvitation'),'delete'===a?(delete l.receivedInvitations[e],l.updateReceivedInvitationsArray()):l.getServerInvitation(e).then(function(e){var t=null,a='none';switch(e.status){case'pending':l.receivedInvitations[e.id]=e,t=e,a='ask';break;case'accepted':case'auto-accepted':l.receivedInvitations[e.id]=e,r.$broadcast('ON_INVITATION_ACCEPTED',e.invitingUserId);break;default:delete l.receivedInvitations[e.id],a='unknown';}e.invitingUserId?l.updateContactInvitationStatus(e.invitingUserId,a,t).then(function(){l.updateReceivedInvitationsArray()}):l.updateReceivedInvitationsArray(),r.$broadcast('ON_INVITATION_CHANGED',e)})},l.handleSentInvitation=function(a,n){return e(function(e){t.info('[invitationService] handleSentInvitation'),'delete'===n?(delete l.sentInvitations[a],l.updateReceivedInvitationsArray(),e()):(l.getServerInvitation(a).then(function(t){var a=null;switch(t.status){case'pending':l.sentInvitations[t.id]=t,a='wait';break;case'accepted':case'auto-accepted':r.$broadcast('ON_INVITATION_ACCEPTED',t.invitedUserId);break;default:delete l.sentInvitations[t.id],a='unknown';}t.invitedUserId?l.updateContactInvitationStatus(t.invitedUserId,a,t).then(function(){l.updateSentInvitationsArray(),e()}):(l.updateSentInvitationsArray(),e())}),'resend'==n&&r.$broadcast('ON_INVITATIONS_RE_SEND',a))})},l.updateReceivedInvitationsArray=function(){for(var e in l.receivedInvitationsArray=[],l.acceptedInvitationsArray=[],l.receivedInvitations)if(l.receivedInvitations.hasOwnProperty(e)){var t=l.receivedInvitations[e];switch(t.status){case'pending':l.receivedInvitationsArray.push(t);break;case'accepted':case'auto-accepted':l.acceptedInvitationsArray.push(t);break;default:}}l.receivedInvitationsArray.sort(l.sortInvitationArray),l.acceptedInvitationsArray=l.acceptedInvitationsArray.filter(function(e){var t=moment(e.lastNotificationDate),a=moment.duration(moment().diff(t)),r=a.asHours();return 168>r}),l.acceptedInvitationsArray.sort(l.sortInvitationArray),r.$broadcast('ON_INVITATIONS_NUMBER_UPDATED')},l.updateSentInvitationsArray=function(){for(var e in l.sentInvitationsArray=[],l.sentInvitations)l.sentInvitations.hasOwnProperty(e)&&l.sentInvitationsArray.push(l.sentInvitations[e]);l.sentInvitationsArray.sort(l.sortInvitationArray),r.$broadcast('ON_INVITATIONS_NUMBER_UPDATED')},l.getServerInvitation=function(r){return e(function(e,s){a({method:'GET',url:l.portalURL+i.userContact.dbId+'/invitations/'+r,headers:n.getRequestHeader()}).then(function(a){t.info('[invitationService] getServerInvitation success');var r=o.createFromData(a.data.data);e(r)},function(e){var a=d.handleError(e);s(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'getServerInvitation'))})})},l.getReceivedInvitations=function(){return l.receivedInvitationsArray},l.getAcceptedInvitations=function(){return l.acceptedInvitationsArray},l.getSentInvitations=function(){return l.sentInvitationsArray},l.getInvitationsNumberForCounter=function(){return l.receivedInvitationsArray.length},l.getAllInvitationsNumber=function(){return l.receivedInvitationsArray.length+l.sentInvitationsArray.length+l.acceptedInvitationsArray.length},l.getInvitation=function(e){var t=l.receivedInvitations[e];return t||(t=l.acceptedInvitationsArray[e]),t||(t=l.sentInvitations[e]),t},l.joinContactInvitation=function(r){return e(function(e,o){t.info('[invitationService] joinContactInvitation contact ('+r.jid+')'),a({method:'POST',url:l.portalURL+i.userContact.dbId+'/invitations',headers:n.getRequestHeader(),data:{invitedUserId:r.dbId}}).then(function(){t.info('[invitationService] joinContactInvitation - success ('+r.jid+')'),'unknown'===r.status&&l.updateContactInvitationStatus(r.dbId,'wait'),e()},function(e){var a=d.handleError(e);o(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'joinContactInvitation'))})})},l.sendInvitationByEmail=function(r,o){return e(function(e,i){var s=c.getAppliLanguageCodeForServer();t.info('[invitationService] sendInvitationByEmail'),a({method:'POST',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/notifications/emails/invite-by-end-user',headers:n.getRequestHeader(),data:{email:r,lang:s,customMessage:o}}).then(function(){t.info('[invitationService] sendInvitationByEmail - success'),e()},function(e){var a=d.handleError(e);i(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'sendInvitationByEmail'))})})},l.cancelOneSendInvitation=function(r){return e(function(e,o){a({method:'POST',url:l.portalURL+r.invitingUserId+'/invitations/'+r.id+'/cancel',headers:n.getRequestHeader()}).then(function(){t.info('[invitationService] cancelOneSendInvitation success'),e()},function(e){var a=d.handleError(e);o(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'cancelOneSendInvitation'))})})},l.reSendInvitation=function(r){return e(function(e,o){a({method:'POST',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+i.userContact.dbId+'/invitations/'+r+'/re-send',headers:n.getRequestHeader()}).then(function(){t.info('[invitationService] reSendInvitation '+r+' - success'),e()},function(e){var a=d.handleError(e);o(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'reSendInvitation'))})})},l.sendInvitationsParBulk=function(r){return!r.length||100<r.length?(t.error('[invitationService] sendInvitationsParBulk mail list length not correct'),e.reject()):e(function(e,o){a({method:'POST',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+i.userContact.dbId+'/invitations/bulk',headers:n.getRequestHeader(),data:{emails:r}}).then(function(){t.info('[invitationService] sendInvitationsParBulk - success'),e()},function(e){var a=d.handleError(e);o(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'sendInvitationsParBulk'))})})},l.acceptInvitation=function(r){return e(function(e,o){a({method:'POST',url:l.portalURL+r.invitedUserId+'/invitations/'+r.id+'/accept',headers:n.getRequestHeader()}).then(function(){t.info('[invitationService] acceptInvitation success'),e()},function(e){var a=d.handleError(e);o(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'acceptInvitation'))})})},l.declineInvitation=function(r){return e(function(e,o){a({method:'POST',url:l.portalURL+r.invitedUserId+'/invitations/'+r.id+'/decline',headers:n.getRequestHeader()}).then(function(){t.info('[invitationService] declineInvitation success'),e()},function(e){var a=d.handleError(e);o(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'declineInvitation'))})})},l.updateContactInvitationStatus=function(t,a,r){return e(function(e){i.getContactByDBId(t).then(function(t){switch(a){case'ask':t.status='unknown',t.ask='ask',t.invitation=r;break;case'wait':t.status='wait',t.ask='subscribe',t.invitation=r;break;default:t.ask='none',t.invitation=null;}t.updateRichStatus(),e()})})},l.sortInvitationArray=function(e,t){return new Date(t.lastNotificationDate)-new Date(e.lastNotificationDate)},l.getAllReceivedInvitations=function(){return e(function(e,r){a({method:'GET',url:l.portalURL+i.userContact.dbId+'/invitations/received?format=full&status=pending&status=accepted&status=auto-accepted&limit=500',headers:n.getRequestHeader()}).then(function(a){var r=a.data.data;t.info('[invitationService] getAllReceivedInvitations success (find '+r.length+' invitations)'),l.receivedInvitations={},l.acceptedInvitations={},r.forEach(function(e){if('pending'===e.status&&'registration'!==e.type){var t=o.createFromData(e);l.receivedInvitations[e.id]=t,e.invitingUserId&&l.updateContactInvitationStatus(e.invitingUserId,'ask',t)}else('accepted'===e.status||'auto-accepted'===e.status)&&(l.receivedInvitations[e.id]=o.createFromData(e))}),l.updateReceivedInvitationsArray(),e(l.receivedInvitations)},function(e){var a=d.handleError(e);r(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'getAllReceivedInvitations'))})})},l.getAllSentInvitations=function(){return e(function(e,r){a({method:'GET',url:l.portalURL+i.userContact.dbId+'/invitations/sent?format=full&status=pending&limit=500',headers:n.getRequestHeader()}).then(function(a){var r=a.data.data;t.info('[invitationService] getAllSentInvitations success (find '+r.length+' invitations)'),l.sentInvitations={},r.forEach(function(e){if('pending'===e.status&&!e.inviteToJoinMeeting){var t=o.createFromData(e);l.sentInvitations[e.id]=t,t.invitedUserId!==void 0&&l.updateContactInvitationStatus(t.invitedUserId,'wait',t)}}),l.updateSentInvitationsArray(),e(l.sentInvitations)},function(e){var a=d.handleError(e);r(a),t.error('[invitationService] '+d.getErrorFullMessage(e,'getAllSentInvitations'))})})}}])},function(){var e=Math.round;angular.module('rainbow').service('roomService',['$q','$log','$rootScope','$http','$filter','$interval','authService','contactService','fileStorageService','xmppService','Room','utilService','profileService','errorHelperService','randomString','orderByFilter','$translate',function(t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f,S){'use strict';var C=this;C.ROOM_UPDATE_EVENT='ROOM_UPDATE_EVENT',C.ROOM_AVATAR_UPDATE_EVENT='ROOM_AVATAR_UPDATE_EVENT',C.ROOM_HISTORY_UPDATE_EVENT='ROOM_HISTORY_UPDATE_EVENT',C.ROOM_ADMIN_MESSAGE_EVENT='ROOM_ADMIN_MESSAGE_EVENT',C.ROOM_INVITATION='ROOM_INVITATION',C.ROOM_ADD_CONF_ENDPOINT_EVENT='ROOM_ADD_CONF_ENDPOINT_EVENT',C.ROOM_REMOVE_CONF_ENDPOINT_EVENT='ROOM_REMOVE_CONF_ENDPOINT_EVENT',C.ROOM_ADD_USERS_EVENT='ROOM_ADD_USERS_EVENT',C.ROOM_DELETE_USERS_EVENT='ROOM_DELETE_USERS_EVENT',C.ROOM_ADD_CONF_GUESTS_EVENT='ROOM_ADD_CONF_GUESTS_EVENT',C.ROOM_DELETE_CONF_GUESTS_EVENT='ROOM_DELETE_CONF_GUESTS_EVENT',C.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT='ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT',C.RoomUserStatus={INVITED:'invited',ACCEPTED:'accepted',UNSUBSCRIBED:'unsubscribed',REJECTED:'rejected',DELETED:'deleted'},C.listeners=[],C.start=function(r){return t(function(t){var n=performance.now();a.info(''),a.info('[roomService] === STARTING ==='),C.portalURL=config.restServerUrl+'/api/rainbow/enduser/v1.0/',C.invitationCounter=0,C.meetingInvitationCounter=0,C.rooms={},C.roomsByJids={},C.roomsInProgress={},C.contactsInProgress={},C.updateLater={},C.maxRoomsUsers=m.getFeatureLimitMax(m.FeaturesEnum.BUBBLE_PARTICIPANT_COUNT),C.openInviteRoomId='',C.attachHandlers(),C.getServerRooms().then(function(){C.computeInvitationCounter();var o=e(performance.now()-n);r.push({service:'roomService',startDuration:o}),a.info('[roomService] === STARTED ('+o+' ms) ==='),t()}).catch(function(e){a.error('[roomService] === STARTING FAILURE === '+e.message),C.computeInvitationCounter(),C.reconnect(),t()})})},C.stop=function(){return a.info(''),a.info('[roomService] === STOPPING ==='),C.listeners.forEach(function(e){e()}),C.rooms={},C.roomsByJids={},a.info('[roomService] === STOPPED ==='),t.when()},C.attachHandlers=function(){a.info('[roomService] attachHandlers'),this.roomPresenceRef&&(l.connection.deleteHandler(this.roomPresenceRef),this.roomPresenceRef=null),this.roomPresenceRef=l.connection.addHandler(C.onRoomPresence,'http://jabber.org/protocol/muc#user','presence'),this.roomMessageRef&&(l.connection.deleteHandler(this.roomMessageRef),this.roomMessageRef=null),this.roomMessageRef=l.connection.addHandler(C.onRoomMessage,'jabber:x:conference','message'),this.roomInfoMessageRef&&(l.connection.deleteHandler(this.roomInfoMessageRef),this.roomInfoMessageRef=null),this.roomInfoMessageRef=l.connection.addHandler(C.onRoomInfoMessage,null,'message','groupchat'),this.roomMessageConfigRef&&(l.connection.deleteHandler(this.roomMessageConfigRef),this.roomMessageConfigRef=null),this.roomMessageConfigRef=l.connection.addHandler(C.onRoomMessageConfig,null,'message','management'),this.roomHistoryInfoRef&&(l.connection.deleteHandler(this.roomHistoryInfoRef),this.roomHistoryInfoRef=null),this.roomHistoryInfoRef=l.connection.addHandler(C.onRoomHistoryInfoMessage,'jabber:iq:notification','message'),this.roomNotificationRef&&(l.connection.deleteHandler(this.roomNotificationRef),this.roomNotificationRef=null),this.roomNotificationRef=l.connection.addHandler(C.onRoomNotificationMessage,'jabber:x:bubble:conference','message'),C.listeners.push(r.$on('ON_CONNECTION_STATE_CHANGE_EVENT',C.onConnectionStateChange))},C.reconnect=function(){a.info('[roomService] reconnect'),C.attachHandlers(),C.getServerRooms().then(function(){C.computeInvitationCounter(),a.info('[roomService] reconnect success')}).catch(function(e){a.error('[roomService] reconnect failure -- '+e.message)})},C.onConnectionStateChange=function(e,t){a.info('[roomService] onConnectionStateChange status:'+t),'disconnected'===t&&C.rooms&&Object.keys(C.rooms).forEach(function(e){var t=C.rooms[e];t&&(t.initPresInterval&&(a.info('[roomService] onConnectionStateChange cancel initPresence retryer for room: '+t.jid+' '+t.getNameForLogs()),i.cancel(t.initPresInterval),t.initPresInterval=null),t.initPresPromise&&(a.info('[roomService] onConnectionStateChange remove initPresPromise for room: '+t.jid+' '+t.getNameForLogs()),t.initPresPromise=null))})},C.getRooms=function(){var e=[];return Object.keys(C.rooms).forEach(function(t){e.push(C.rooms[t])}),e},C.searchRooms=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return C.getRooms().filter(function(e){if('accepted'===e.status)var a=e.name.toLowerCase().trim().split(/[ ]+/),r=t.every(function(t){return a.some(function(r,n){return!!(r.length&&0===u.removeDiacritis(r).indexOf(u.removeDiacritis(t)))&&(a[n]='',e.filterName=u.removeDiacritis(e.name),!0)})});else return!1;return r})},C.getMyRooms=function(){return C.getRooms().filter(function(e){return e.owner})},C.getRoomById=function(e){return C.rooms[e]},C.getRoomByJid=function(e){return C.roomsByJids[e]},C.computeInvitationCounter=function(){C.invitationCounter=0,C.meetingInvitationCounter=0,Object.keys(C.rooms).forEach(function(e){var t=C.rooms[e];'invited'===t.status&&(t.isMeetingRoom()&&m.isFeatureEnabled('CONFERENCE_PARTICIPANT_ALLOWED')?C.meetingInvitationCounter+=1:C.invitationCounter+=1)})},C.getOrderedRooms=function(e){return'creationDate'===e?f(C.getRooms(),C.getCreationDate,!0,C.sortByDate):f(C.getRooms(),C.getName,!1,C.sortByName)},C.getMyOrderedRooms=function(e){return'creationDate'===e?f(C.getMyRooms(),C.getCreationDate,!0,C.sortByDate):f(C.getMyRooms(),C.getName,!1,C.sortByName)},C.getServerRoom=function(e){return t(function(t,r){a.info('[roomService] getServerRoom('+e+')'),n({method:'GET',url:C.portalURL+'rooms/'+e+'?format=full',headers:s.getRequestHeader()}).then(function(t){var r=t.data.data;return a.info('[roomService] getServerRoom('+e+') successfully'),C.getAllRoomsParticipants([r])}).then(function(e){var a=C.createRoomFromData(e[0]);t(a)},function(t){var n=t.data?t.data.errorDetails:t.data,o='getServerRoom('+e+') failure: '+n;a.error('[roomService] '+o),r(new Error(o))})})},C.getServerRooms=function(){var e=function(e,r,o){return t(function(t,i){n({method:'GET',headers:s.getRequestHeader(),url:C.portalURL+'rooms?format=full&userId='+d.userContact.dbId+'&status=invited&status=accepted&status=unsubscribed&offset='+e+'&limit='+r}).then(function(e){o=o.concat(e.data.data),a.info('[roomService] getServerRooms retrieved '+e.data.data.length+' rooms, total '+o.length+', existing '+e.data.total),t({rooms:o,finished:o.length===e.data.total})}).catch(function(e){i(e)})})},r=function r(n,o,i){return t(function(t,s){e(n,o,i).then(function(e){e.finished?(a.info('[roomService] getServerRooms no need to loop again. All rooms retrieved...'),t(e.rooms)):(n+=o,a.info('[roomService] getServerRooms need another loop to get more rooms... ['+e.rooms.length+']'),r(n,o,e.rooms).then(function(e){t(e)}).catch(function(e){s(e)}))}).catch(function(e){s(e)})})};return t(function(e,t){r(0,1e3,[]).then(function(e){var t=e;return a.info('[roomService] getServerRooms successfully: find '+t.length+' room(s)'),C.getAllRoomsParticipants(t)}).then(function(t){t.forEach(function(e){C.createRoomFromData(e)}),e()}).catch(function(e){var r=e.data?e.data.errorDetails:e.message,n='getServerRooms failure: '+r;a.error('[roomService] '+n),t(new Error(n))})})},C.getAllRoomsParticipants=function(r){var o=t.defer(),i=function(e,r,o,i){return t(function(t,d){n({method:'GET',headers:s.getRequestHeader(),url:C.portalURL+'rooms/'+e.id+'/users?format=full&offset='+r+'&limit='+o}).then(function(e){i=i.concat(e.data.data),a.info('[roomService] getAllRoomsParticipants retrieved '+e.data.data.length+' users, total '+i.length+', existing '+e.data.total),t({users:i,finished:i.length===e.data.total})}).catch(function(e){d(e)})})},c=function e(r,n,s,d){return t(function(t,c){i(r,n,s,d).then(function(o){o.finished?(a.info('[roomService] getAllRoomsParticipants no need to loop again. All users retrieved...'),t(o.users)):(n+=s,a.info('[roomService] getAllRoomsParticipants need another loop to get more users... ['+o.users.length+']'),e(r,n,s,o.users).then(function(e){t(e)}).catch(function(e){c(e)}))}).catch(function(e){o.reject(e)})})},l=performance.now(),p={},u=[];return r.forEach(function(e){var a=t.defer();if(u.push(a),e.activeUsersCounter&&e.users.length<e.activeUsersCounter){c(e,0,100,[]).then(function(t){e.users=t,a.resolve(e)}).catch(function(e){reject(e)})}else a.resolve(e);return a.promise.then(function(e){e.users.forEach(function(e){var t=d.getContactByJid(e.jid_im);p[e.jid_im]||t&&!t.temp||(p[e.jid_im]=e.jid_im)})})}),t.all(u).then(function(){var t=Object.keys(p);return t.length?d.getContactsByJids(t).then(function(){var n=performance.now();a.info('[roomService] getAllRoomsParticipants - get '+t.length+' participants in '+e(n-l)+' milliseconds.'),o.resolve(r)}):(a.info('[roomService] getAllRoomsParticipants - nothing to get, all known.'),void o.resolve(r))}),o.promise},C.createRoomFromData=function(e){var t=p.create(e.id,e.jid,e.name,e.topic,e.creationDate,e.confEndpoints,e.history,e.customData,e.conference),n=d.dbContacts[e.creator];if(!n)return a.error('[roomService] createRoomFromData -- failure -- Impossible to find owner of room '+e.name+' --- ignored'),t;t.ownerContact=n,t.owner=n.jid===d.userContact.jid,e.users.forEach(function(e){var a=d.getContactById(e.userId);a&&(t.users.push({contact:a,status:e.status,date:new Date(e.additionDate),privilege:e.privilege}),d.isUserContact(a)&&(t.status=e.status))}),t.guestEmails=e.guestEmails,C.refreshMemberAndOrganizerLists(t);var o=t.getUserByJid(d.userContact.jid);if(t.isModerator=o&&o.status!==C.RoomUserStatus.UNSUBSCRIBED&&t.isUserModerator(d.userContact),C.rooms[t.dbId]&&C.rooms[t.dbId].initPresPromise&&(t.initPresPromise=C.rooms[t.dbId].initPresPromise),t.updateAvatarInfo(),e.lastAvatarUpdateDate){var i=config.restServerUrl;r.cdn&&(i=r.cdnServer),t.avatar=i+'/api/room-avatar/'+e.id+'?size=512&update='+MD5.hexdigest(e.lastAvatarUpdateDate)}return C.rooms[t.dbId]=t,C.roomsByJids[t.jid]=t,r.$broadcast(C.ROOM_UPDATE_EVENT,t),'accepted'===t.status&&C.sendInitialRoomPresenceSync(t),t},C.refreshMemberAndOrganizerLists=function(e){e.organizers=[],e.members=[],e.users.forEach(function(t){(t.status===C.RoomUserStatus.ACCEPTED||t.status===C.RoomUserStatus.INVITED||t.contact.jid===e.ownerContact.jid)&&(t.privilege===p.Privilege.MODERATOR?e.organizers.push(t):e.members.push(t))})},C.equalContactsArrayByDbId=function(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e.length!==t.length)return!1;for(var a=0;a<e.length;++a)if(e[a].dbId!==t[a].dbId)return!1;return!0},C.getOrCreateRoomWithContacts=function(e,r){return t(function(t){var n=null,i=[].concat([d.userContact],e).sort(C.sortObjectByProperty('dbId'));if(C.getMyRooms().some(function(e){return!!(e&&e.status===C.RoomUserStatus.ACCEPTED&&C.equalContactsArrayByDbId(e.users.map(function(e){return e.contact}).sort(C.sortObjectByProperty('dbId')),i))&&(n=e,a.debug('[roomService] getOrCreateRoomWithContacts - Found Room '+e.getNameForLogs()),!0)}),n)return void(r.length?C.addRoomUsers(n,null,r).then(function(){t(n)}):t(n));for(var s=d.userContact.initials+' '+o('translate')('bubble')+' ',c=C.getMyRooms().filter(function(e){return e&&0===e.name.indexOf(s)}),l=function(e){return e&&e.name===m},p=null,u=1,m;!p;)m=s+u.toString(),c.sort(C.sortObjectByProperty('name')).some(l)||(p=m),u++;C.createRoomWithContacts(p,'',e,r).then(function(e){t(e)})})},C.createRoomWithContacts=function(e,r,n,o){return t(function(t,i){C.createRoom(e,r,!0).then(function(e){return C.addRoomUsers(e,n,o)}).then(function(e){t(e)}).catch(function(e){var t='createRoomWithContacts failure: '+e.message;a.error('[roomService] '+t),i(new Error(t))})})},C.setAvatarRoom=function(e,o){var i=t.defer();return o?(C.resizeImage(o,512,512).then(function(t){var o=C.getBinaryData(t);n({method:'POST',url:C.portalURL+'rooms/'+e.id+'/avatar',headers:s.getPostHeader('image/'+o.type),data:o.data,transformRequest:[]}).then(function(t){a.info('[roomService] setAvatarRoom success: '+t.data.status);var n=config.restServerUrl;r.cdn&&(n=r.cdnServer),e.avatar=n+'/api/room-avatar/'+e.id+'?size=512&rand='+v(),i.resolve(e)},function(e){var t=g.handleError(e);a.error('[roomService] '+g.getErrorFullMessage(e,'setAvatarRoom')),i.reject(t)})}),i.promise):(i.resolve(e),i.promise)},C.deleteAvatarRoom=function(e){return t(function(t,r){n({method:'DELETE',url:C.portalURL+'rooms/'+e+'/avatar',headers:s.getRequestHeader()}).then(function(){a.info('[roomService] avatar room sucessfully deleted'),t()}).catch(function(e){r(e)})})},C.resizeImage=function(e,a,r){var n=t.defer(),o=new Image;return o.src=e,o.onload=function(){var e=o.width,t=o.height;e>t?e>a&&(t*=a/e,e=a):t>r&&(e*=r/t,t=r);var i=document.createElement('canvas');i.width=e,i.height=t,o.width=e,o.height=t;var s=i.getContext('2d');s.drawImage(this,0,0,e,t);var d=new Image;d.src=i.toDataURL('image/png'),n.resolve(d)},n.promise},C.getBinaryData=function(e){for(var t=e.src.indexOf('image/')+6,a=e.src.indexOf(';base64,'),r=e.src.slice(a+8),n=e.src.slice(t,a),o=window.atob(r),s=o.length,d=new Uint8Array(s),c=0;c<s;c++)d[c]=o.charCodeAt(c);return{type:n,data:d}},C.pushContactInRoom=function(e,r){return t(function(t){d.getContactByDBId(e.userId).then(function(n){r.users.push({contact:n,status:e.status,date:new Date(e.additionDate),privilege:e.privilege}),d.isUserContact(n)&&(r.status=e.status),a.info('[roomService] pushContactInRoom success'),t()}).catch(function(e){a.info('[roomService] pushContactInRoom failure : '+e.message),t()})})},C.addRoomUser=function(e,o,i,d,c){return t(function(t,l){var u=e.users.some(function(e){return!(e.status!==C.RoomUserStatus.INVITED&&e.status!==C.RoomUserStatus.ACCEPTED&&e.status!==C.RoomUserStatus.REJECTED||e.contact.dbId!==o.dbId)});if(u)return a.debug('[roomService] user: '+o.dbId+' already invited or accepted, will not be added'),void t(e);var m=e.users.filter(function(e){return e.status!==C.RoomUserStatus.DELETED}).length;if(m>=C.maxRoomsUsers){var g=new Error('addRoomUser failure - Not Allowed : Participants max limit has been reached: '+C.maxRoomsUsers);return g.status=g.errorDetailsCode='403',a.error('[roomService] '+g.message),void l(g)}var v=C.RoomUserStatus.INVITED;'boolean'==typeof c&&c&&(v=C.RoomUserStatus.ACCEPTED);var f=i?i:'JustForFun',S=d?d:p.Privilege.USER;n({method:'POST',url:C.portalURL+'rooms/'+e.dbId+'/users',headers:s.getPostHeader(),data:{userId:o.dbId,privilege:S,reason:f,status:v}}).then(function(n){a.info('[roomService] addRoomUser '+o.displayNameForLog()+' to room '+e.dbId+'('+e.getNameForLogs()+') success');var i=n.data.data,s=e.getUserByJid(i.jid_im);s?(s.status=i.status,s.date=new Date,s.privilege=i.privilege):e.users.push({contact:o,status:v,date:new Date,privilege:S}),C.refreshMemberAndOrganizerLists(e),r.$broadcast(C.ROOM_UPDATE_EVENT,e),t(e)},function(t){var r='addRoomUser '+o.displayNameForLog()+' to room '+e.dbId+'('+e.getNameForLogs()+') failure: '+t.data.errorDetails;a.error('[roomService] '+r),l(new Error(r))})})},C.addRoomUsers=function(e,n,o){return t(function(i,s){var d=[];n.forEach(function(t){var a=e.users.some(function(a){if(a.contact.dbId===t.dbId){switch(a.status){case C.RoomUserStatus.UNSUBSCRIBED:d.push(C.ownerReinviteRejectedUser(e,t));break;case C.RoomUserStatus.DELETED:d.push(C.ownerReinviteDeletedUser(e,t));break;case C.RoomUserStatus.REJECTED:d.push(C.ownerReinviteRejectedUser(e,t));break;default:}return!0}return!1});a||d.push(C.addRoomUser(e,t))}),t.all(d).then(function(){a.info('[roomService] addRoomUsers success'),r.$broadcast(C.ROOM_ADD_USERS_EVENT,e),i(e)}).then(function(){C.inviteGuestEmailToJoinRoom(e,o)}).catch(function(e){var t='addRoomUsers failure: '+e.message;a.error('[roomService] '+t),s(new Error(t))})})},C.deleteRoomUsers=function(e,n){return t(function(o,i){var s=[];n.forEach(function(t){var a=e.users.some(function(e){return!(e.contact.dbId!==t.dbId)});a&&s.push(C.ownerDeletesUserFromRoom(e,t))}),t.all(s).then(function(){a.info('[roomService] deleteRoomUsers success'),r.$broadcast(C.ROOM_DELETE_USERS_EVENT,e),o(e)}).catch(function(e){var t='deleteRoomUsers failure: '+e.message;a.error('[roomService] '+t),i(new Error(t))})})},C.sendInitialRoomPresence=function(e,t){var r=t?' -- attempt '+t:'';a.info('[roomService] sendInitialRoomPresence '+r+' -- '+e.getNameForLogs()+' -- '+e.dbId);var n=$pres({to:e.jid+'/'+l.fullJid});n.c('x',{xmlns:'http://jabber.org/protocol/muc'}).c('history',{maxchars:'0'}),l.send(n)},C.sendInitialRoomPresenceSync=function(e){if(e.initPresPromise)return e.initPresPromise.promise;var r=e.initPresPromise=t.defer();C.sendInitialRoomPresence(e,'0');var n=5,o=0;return e.initPresInterval=i(function(){o<n?C.sendInitialRoomPresence(e,++o):(a.error('[roomService] sendInitialRoomPresenceSync : no response after '+o+' retries => clean presence promise and interval for '+e.getNameForLogs()+' -- '+e.jid),e.initPresPromise=null)},5e3,n+1),r.promise},C.sendPresenceWithResponseWait=function(e){if(e.initPresPromiseReceived)return C.sendInitialRoomPresence(e),t.when(e);var a=e.initPresPromise=t.defer();return C.sendInitialRoomPresence(e),a.promise},C.sendUnavailableRoomPresence=function(e){var t=$pres({to:e.jid+'/'+d.userContact.jid,type:'unavailable'});t.c('x',{xmlns:'http://jabber.org/protocol/muc'}),l.send(t)},C.createRoom=function(e,r,o,i,c,l){var u=e.charAt(0)+'***'+e.slice(-1);return a.info('[roomService] createRoom "'+u+'"'),t(function(t,m){var g,v;(void 0===c||c&&'boolean'!=typeof c)&&(c=!0),g=o?'all':'none';var v={name:e,topic:r,history:g,disableNotifications:c};l&&(v.mediaType=l),n({method:'POST',url:C.portalURL+'rooms/',headers:s.getPostHeader(),data:v}).then(function(e){var t=e.data.data;return C.setAvatarRoom(t,i)}).then(function(e){C.rooms[e.id]&&(a.info('[roomService] createRoom -- room "'+u+'" already exists'),t(C.rooms[e.id]));var r=p.create(e.id,e.jid,e.name,e.topic,e.creationDate,e.confEndpoints,e.history,e.customData,e.conference,e.avatar);r.ownerContact=d.userContact,r.owner=!0,r.isModerator=!0,r.status='accepted',C.rooms[r.dbId]=r,C.roomsByJids[r.jid]=r,a.info('[roomService] createRoom "'+u+'" -- success'),t(C.sendInitialRoomPresenceSync(r))}).catch(function(e){var t=e;e&&e.data&&(t=e.data.errorDetailsCode+' '+e.data.errorDetails),a.error('[roomService] createRoom "'+u+'" -- failure : '+t),m(e)})})},C.updateRoomUser=function(e,o,i,d){var c={};return i&&(c.status=i),d&&(c.privilege=d),t(function(t,i){n({method:'PUT',url:C.portalURL+'rooms/'+e.dbId+'/users/'+o.dbId,headers:s.getPostHeader(),data:c}).then(function(n){a.info('[roomService] updateRoomUser '+o.displayNameForLog()+' to room '+e.dbId+'('+e.getNameForLogs()+') success');var i=n.data.data;e.users.forEach(function(e){e.contact.jid===i.jid_im&&(e.privilege=i.privilege,e.status=i.status)}),C.refreshMemberAndOrganizerLists(e),r.$broadcast(C.ROOM_UPDATE_EVENT,e),t(e)},function(t){var r='updateRoomUser '+o.displayNameForLog()+' to room '+e.dbId+'('+e.getNameForLogs()+') failure: '+t.data.errorDetails;a.error('[roomService] '+r),i(new Error(r))})})},C.ownerArchiveRoom=function(e){return a.info('[roomService] ownerArchiveRoom'),t(function(r,n){var o=[];e.users.forEach(function(t){d.isUserContact(t.contact)||t.status===C.RoomUserStatus.DELETED||t.status===C.RoomUserStatus.REJECTED||o.push(C.unsubscribeUserFromRoom(e,t.contact))}),t.all(o).then(function(){a.info('[roomService] unsubscribe all other users successfully'),C.unsubscribeMeFromRoom(e).then(function(){a.info('[roomService] ownerArchiveRoom successfully'),r(e)})}).catch(function(e){var t='ownerArchiveRoom failure: '+e.message;a.error('[roomService] '+t),n(new Error(t))})})},C.unsubscribeUserFromRoom=function(e,t){return C.updateRoomUser(e,t,C.RoomUserStatus.UNSUBSCRIBED)},C.ownerDeletesUserFromRoom=function(e,o){return a.info('[roomService] ownerDeletesUserFromRoom'),t(function(t,i){var d=o.dbId;n({method:'DELETE',url:C.portalURL+'rooms/'+e.dbId+'/users/'+d,headers:s.getRequestHeader()}).then(function(){a.info('[roomService] ownerDeletesUserFromRoom '+d+' from room '+e.dbId+'('+e.getNameForLogs()+') success'),r.$broadcast(C.ROOM_UPDATE_EVENT,e),t(e)},function(t){var r='ownerDeletesUserFromRoom '+d+' from room '+e.dbId+'('+e.getNameForLogs()+') failure: '+t.data.errorDetails;a.error('[roomService] '+r),i(new Error(r))})})},C.ownerReinviteRejectedUser=function(e,r,n,o,i){return t(function(t,s){C.ownerDeletesUserFromRoom(e,r).then(function(){C.addRoomUser(e,r,n,o,i).then(function(){a.info('[roomService] ownerReinviteRejectedUser '+r.dbId+' from room '+e.dbId+'('+e.getNameForLogs()+') success'),t(e)})}).catch(function(e){var t='ownerReinviteRejectedUser failure: '+e.message;a.error('[roomService] '+t),s(new Error(t))})})},C.ownerReinviteDeletedUser=function(e,r,n,o,i){return t(function(t,s){C.addRoomUser(e,r,n,o,i).then(function(){a.info('[roomService] ownerReinviteDeletedUser '+r.dbId+' from room '+e.dbId+'('+e.getNameForLogs()+') success'),t(e)}).catch(function(e){var t='ownerReinviteDeletedUser failure: '+e.message;a.error('[roomService] '+t),s(new Error(t))})})},C.ownerDeleteRoom=function(e){return t(function(t,o){var i=e.dbId;return i?void n({method:'DELETE',url:C.portalURL+'rooms/'+i,headers:s.getRequestHeader()}).then(function(){a.info('[roomService] ownerDeleteRoom '+e.dbId+'('+e.getNameForLogs()+') success'),delete C.rooms[e.dbId],r.$broadcast(C.ROOM_UPDATE_EVENT,e),t(e)},function(t){var n='ownerDeleteRoom ('+i+') failure: unknown error occurred';t&&t.data&&(n='ownerDeleteRoom ('+i+') failure: '+t.data.errorDetails),t&&404===t.status&&(a.info('[roomService] ownerDeleteRoom '+e.dbId+'('+e.getNameForLogs()+') not found, deleting it from local storage'),delete C.rooms[e.dbId],r.$broadcast(C.ROOM_UPDATE_EVENT,e)),a.error('[roomService] '+n),o(new Error(n))}):void a.error('[roomService] ownerDeleteRoom failure because the roomId is empty ...')})},C.ownerUpdateRoom=function(e){return a.info('[roomService] ownerUpdateRoom'),t(function(t,r){var o={name:e.name,topic:e.desc,visibility:e.type?'public':'private'};n({method:'PUT',url:C.portalURL+'rooms/'+e.dbId,headers:s.getPostHeader(),data:o}).then(function(e){var r=e.data.data;C.rooms[r.id].desc=r.topic,C.rooms[r.id].type='private'===r.visibility?p.Type.PRIVATE:p.Type.PUBLIC,a.info('[roomService] ownerUpdateRoom successfully ('+r.id+', '+r.jid+')'),t(C.rooms[r.id])},function(e){var t='ownerUpdateRoom failure: '+e.data.errorDetails;a.error('[roomService] '+t),r(new Error(t))})})},C.changeRoomOwner=function(e,r){return a.info('[roomService] changeRoomOwner'),t(function(t,o){if(!e||!r){var i='changeRoomOwner error: - missing room or new owner';return a.error('[roomService] '+i),void o(new Error(i))}var c={owner:r.dbId},l=e.confEndpoints&&e.confEndpoints.length?e.confEndpoints[0].confEndpointId:'';C.deleteRoomConferenceEndPoint(e,l).then(function(){n({method:'PUT',url:C.portalURL+'rooms/'+e.dbId,headers:s.getPostHeader(),data:c}).then(function(){e.ownerContact=r,e.owner=r.jid===d.userContact.jid,a.info('[roomService] changeRoomOwner successfully ('+e.dbId+')'),t(C.rooms[e.dbId])},function(e){var t='changeRoomOwner failure: '+e.data.errorDetails;a.error('[roomService] '+t),o(new Error(t))})}).catch(function(e){a.error('[roomService] changeRoomOwner error'),o(e)})})},C.ownerUpdateRoomCustomData=function(e){return a.info('[roomService] ownerUpdateRoomCustomData'),t(function(t,r){var o={customData:e.customData};n({method:'PUT',url:C.portalURL+'rooms/'+e.dbId+'/custom-data',headers:s.getPostHeader(),data:o}).then(function(e){var r=e.data.data;a.info('[roomService] ownerUpdateRoomCustomData successfully got ('+JSON.stringify(r,null,4)+')'),t(r.customData||{})},function(e){var t='ownerUpdateRoomCustomData failure: '+e.data.errorDetails;a.error('[roomService] '+t),r(new Error(t))})})},C.ownerUpdateRoomNameAndDescription=function(e){return a.info('[roomService] ownerUpdateRoomNameAndDescription'),t(function(t,r){var o={name:e.name,topic:e.desc,visibility:e.type?'public':'private'};n({method:'PUT',url:C.portalURL+'rooms/'+e.dbId,headers:s.getPostHeader(),data:o}).then(function(e){var r=e.data.data;C.rooms[r.id].desc=r.topic,C.rooms[r.id].type='private'===r.visibility?p.Type.PRIVATE:p.Type.PUBLIC,(r.conference||r.confEndpoints)&&(C.rooms[r.id].conference=r.conference?r.conference:null,C.rooms[r.id].confEndpoints=r.confEndpoints?r.confEndpoints:[]),a.info('[roomService] ownerUpdateRoomNameAndDescription successfully ('+r.id+', '+r.jid+')'),t(C.rooms[r.id])},function(e){var t='ownerUpdateRoomNameAndDescription failure: '+e.data.errorDetails;a.error('[roomService] '+t),r(new Error(t))})})},C.updateMyRoomUser=function(e,r){return t(function(t,o){n({method:'PUT',url:C.portalURL+'rooms/'+e.dbId+'/users/'+d.userContact.dbId,headers:s.getPostHeader(),data:{status:r}}).then(function(){a.info('[roomService] updateMyRoomUser '+d.userContact.displayNameForLog()+' to room '+e.dbId+'('+e.getNameForLogs()+') success'),t(e)},function(t){var r='updateMyRoomUser '+d.userContact.displayNameForLog()+' to room '+e.dbId+'('+e.getNameForLogs()+') failure: '+t.data.errorDetails;a.error('[roomService] '+r),o(new Error(r))})})},C.unsubscribeMeFromRoom=function(e){return C.updateMyRoomUser(e,C.RoomUserStatus.UNSUBSCRIBED)},C.participantCloseRoom=function(e){return a.info('[roomService] participantCloseRoom'),t(function(t,o){var i=d.userContact.dbId;n({method:'DELETE',url:C.portalURL+'rooms/'+e.dbId+'/users/'+i,headers:s.getRequestHeader()}).then(function(){a.info('[roomService] participantCloseRoom '+i+' from room '+e.dbId+'('+e.getNameForLogs()+') success'),delete C.rooms[e.dbId],r.$broadcast(C.ROOM_UPDATE_EVENT,e),t(e)},function(t){var r='participantCloseRoom '+i+' from room '+e.dbId+'('+e.getNameForLogs()+') failure: '+t.data.errorDetails;a.error('[roomService] '+r),o(new Error(r))})})},C.acceptRoomInvitation=function(e){return C.updateMyRoomUser(e,C.RoomUserStatus.ACCEPTED).then(function(){return c.retrieveReceivedFilesForRoom(e.dbId)}).then(function(){return C.sendInitialRoomPresenceSync(e)})},C.declineRoomInvitation=function(e){return C.updateMyRoomUser(e,C.RoomUserStatus.REJECTED)},C.getRoomConferenceEndPoint=function(e,r){return a.info('[roomService] getRoomConferenceEndPoint'),t(function(t,o){n({method:'GET',url:C.portalURL+'rooms/'+e.dbId+'/conference/'+r,headers:s.getRequestHeader()}).then(function(n){var o=n.data.data;a.info('[roomService] getRoomConferenceEndPoint '+r+' from room '+e.dbId+'success'),t(o)},function(t){var n='getRoomConferenceEndPoint '+r+' from room '+e.dbId+'failure: '+t.data.errorDetails;a.error('[roomService] '+n),o(new Error(n))})})},C.addRoomConferenceEndPoint=function(e,o,i){if(a.info('[roomService] addRoomConferenceEndPoint'),null===o||angular.isUndefined(o)){var d=new Error('No ConferenceEndPoint to associate with Room');return t.reject(d)}return t(function(t,d){var c=!1;return e.confEndpoints.forEach(function(e){e.confEndpointId===o.id&&(c=!0)}),c?(a.info('[roomService] addRoomConferenceEndPoint : already attached to room !'),void t(e)):void(i&&'pstnAudio'===i&&Object.keys(C.rooms).forEach(function(e){C.rooms[e].conference&&!C.rooms[e].conference.scheduled&&C.rooms[e].getPstnConfEndpointId()===o.id&&C.deleteRoomConferenceEndPoint(C.rooms[e],o.id)}),n({method:'POST',url:C.portalURL+'rooms/'+e.dbId+'/conferences',headers:s.getPostHeader(),data:{confId:o.id}}).then(function(n){var i=n.data.data;a.debug('[roomService] addRoomConferenceEndPoint response data:'+JSON.stringify(i)),e.confEndpoints.push(i),a.info('[roomService] addRoomConferenceEndPoint '+o.id+' to room '+e.dbId+'success'),r.$broadcast(C.ROOM_ADD_CONF_ENDPOINT_EVENT,e),t(e)},function(e){var t=g.handleError(e);a.error('[roomService] addRoomConferenceEndPoint '+t.message),d(t)}))})},C.deleteRoomConferenceEndPoint=function(e,o){return a.info('[roomService] deleteRoomConferenceEndPoint'),t(function(t,d){if(!e||!o)return a.info('[roomService] deleteRoomConferenceEndPoint : missing parameters '),void t();var c=!1;if(e.confEndpoints&&e.confEndpoints.length)for(var l=0;l<e.confEndpoints.length;l++)if(e.confEndpoints[l].confEndpointId===o){c=!0;break}return c?void n({method:'DELETE',url:C.portalURL+'rooms/'+e.dbId+'/conferences/'+o,headers:s.getRequestHeader()}).then(function(n){var i=n.data.data;a.info('[roomService] deleteRoomConferenceEndPoint '+o+' from room '+e.dbId+'success'),e.confEndpoints=i,r.$broadcast(C.ROOM_REMOVE_CONF_ENDPOINT_EVENT,e),t()},function(n){var i='deleteRoomConferenceEndPoint '+o+' from room '+e.dbId+'failure: '+n.data.errorDetails;a.error('[roomService] '+i),404===n.status?(e.confEndpoints=[],r.$broadcast(C.ROOM_REMOVE_CONF_ENDPOINT_EVENT,e),t(n.status)):d(new Error(i))}):(a.info('[roomService] deleteRoomConferenceEndPoint : room has no such conference attached'),void t())})},C.inviteGuestEmailToJoinRoom=function(e,o){return a.info('[roomService] inviteGuestEmailToJoinRoom'),o&&o.length?t(function(t,i){n({method:'POST',url:C.portalURL+'rooms/'+e.dbId+'/invitations',headers:s.getRequestHeader(),data:{scenario:'chat',emails:o,lang:s.userData.language}}).then(function(a){e.guestEmails=a.data.data.guestEmails,r.$broadcast('ROOM_ADD_CONF_GUESTS_EVENT',e),t(e)}).catch(function(e){var t=g.handleError(e);a.error('[roomService] inviteGuestEmailToJoinRoom '+t.message),i(t)})}):t.resolve(e)},C.ownerCancelGuestFromRoom=function(e,o){return a.info('[roomService] ownerCancelGuestFromRoom'),o&&o.length?t(function(t,i){n({method:'POST',url:C.portalURL+'rooms/'+e.dbId+'/invitations/cancel',headers:s.getRequestHeader(),data:{scenario:'chat',emails:o,lang:s.userData.language}}).then(function(a){e.guestEmails=a.data.guestEmails,r.$broadcast('ROOM_REMOVE_CONF_GUESTS_EVENT',e),t(e)}).catch(function(e){var t=g.handleError(e);a.error('[roomService] ownerCancelGuestFromRoom '+t.message),i(t)})}):t.resolve(e)},C.notifyRoomUsersJoinConference=function(e,o,i,d,c){return a.info('[roomService] notifyRoomUsersJoinConference'),d=angular.isDefined(d)?d:'false',c=angular.isDefined(c)?c:'false',t(function(t,l){var p=e.getPstnConfEndpointId();if(!p)t(e);else{var u=e.desc;n({method:'POST',url:C.portalURL+'rooms/'+e.dbId+'/invitations',headers:s.getPostHeader(),data:{scenario:'pstn-conference',confId:p,noMail:d.toString(),update:c.toString(),users:o?o.map(function(e){return e.dbId}):void 0,emails:i,instantMessage:u,lang:s.userData.language}}).then(function(){a.info('[roomService] notifyRoomUsersJoinConference '+p+' from room '+e.dbId+'success'),C.rooms[e.dbId].guestEmails=i,r.$broadcast('ROOM_ADD_CONF_GUESTS_EVENT',C.rooms[e.dbId]),t(C.rooms[e.dbId])},function(t){var r='notifyRoomUsersJoinConference '+p+' from room '+e.dbId+'failure: '+t.data.errorDetails;a.error('[roomService] '+r),l(new Error(r))})}})},C.notifyUsersCancelConference=function(e,o,i,d){return a.debug('[roomService] notifyUsersCancelConference'),d=angular.isDefined(d)?d:'false',t(function(t,c){var l=e.getPstnConfEndpointId();l?n({method:'DELETE',url:C.portalURL+'rooms/'+e.dbId+'/invitations',headers:s.getPostHeader(),data:{scenario:'pstn-conference',confId:l,noMail:d.toString(),users:o?o.map(function(e){return e.dbId}):void 0,emails:i,lang:s.userData.language}}).then(function(){a.info('[roomService] notifyUsersCancelConference '+l+' from room '+e.dbId+'success'),C.rooms[e.dbId].guestEmails=C.rooms[e.dbId].guestEmails.filter(function(e){return-1===i.indexOf(e)}),r.$broadcast('ROOM_DELETE_CONF_GUESTS_EVENT',C.rooms[e.dbId]),t(C.rooms[e.dbId])},function(t){var r='notifyUsersCancelConference '+l+' from room '+e.dbId+'failure: '+t.data.errorDetails;a.error('[roomService] '+r),c(new Error(r))}):t(e)})},C.getRoomByConferenceEndpointId=function(e){return a.info('[roomService] getRoomFromConferenceEndpointId'),t(function(t,r){n({method:'GET',url:C.portalURL+'rooms?userId='+d.userContact.dbId+'&confId='+e+'&format=full',headers:s.getRequestHeader()}).then(function(n){a.info('[roomService] getRoomFromConferenceEndpointId -- '+e+' -- success');var o=n.data.data;o.length?(C.createRoomFromData(o[0]),t(C.getRoomById(o[0].id))):(a.info('[roomService] getRoomFromConferenceEndpointId -- no room with confId '+e),r())},function(t){var n='getRoomFromConferenceEndpointId -- '+e+' -- failure: '+t.data.errorDetails;a.error('[roomService] '+n),r(new Error(n))})})},C.onRoomMessage=function(e){a.info('[roomService] onRoomMessage');try{if(0<angular.element(e).find('event').length&&('conferenceAdd'===angular.element(e).find('event').attr('name')||'conferenceRemove'===angular.element(e).find('event').attr('name')))return!0;var t=angular.element(e).find('x').attr('thread');return C.getServerRoom(t).then(function(e){e.isMeetingRoom()&&r.$broadcast('MEETING_CREATED_EVENT',e),C.computeInvitationCounter(),r.$broadcast(C.ROOM_INVITATION,e),r.$broadcast(C.ROOM_UPDATE_EVENT,e)}).catch(function(e){a.error('[roomService] onRoomMessage failure :  impossible to get associated room : '+e.message)}),!0}catch(e){return a.error('[roomService] onRoomMessage error '+e),!0}},C.onRoomNotificationMessage=function(e){try{var t=$(e),n=t.find('x');if(t.find('event').length&&n.length){var o=t.find('event').attr('name');if(!o||'invitation'!==o)return!0;a.info('[roomService] onRoomNotificationMessage');var i=$(n[0]).attr('roomid');return i?(C.getServerRoom(i).then(function(e){e.isMeetingRoom()&&r.$broadcast('MEETING_CREATED_EVENT',e),C.computeInvitationCounter(),r.$broadcast(C.ROOM_INVITATION,e),r.$broadcast(C.ROOM_UPDATE_EVENT,e)}).catch(function(e){a.error('[roomService] onRoomNotificationMessage failure :  impossible to get associated room : '+e.message)}),!0):(a.info('[roomService] onRoomNotificationMessage error -- missing roomId'),!0)}}catch(e){return a.error('[roomService] onRoomNotificationMessage error '+e),!0}},C.onRoomInfoMessage=function(e){a.info('[roomService] onRoomInfoMessage');try{if(0<angular.element(e).find('event').length){a.info('[roomService] onRoomInfoMessage : room event message');var t=angular.element(e).attr('from'),n=l.getBareJidFromJid(t),o=angular.element(e).find('event').attr('jid'),s=angular.element(e).find('event').attr('name'),c=angular.element(e).attr('id');if(a.info('[roomService] onRoomInfoMessage : room event message with parameters '+n+' || '+o+' || '+s+' || '+c),n&&o&&s&&c){var p=C.getRoomByJid(n),u=p.getUserByJid(o);switch(u&&'deleted'!==u.status&&r.$broadcast(C.ROOM_ADMIN_MESSAGE_EVENT,n,o,s,c),s){case'conferenceAdd':i(function(){C.getServerRoom(p.dbId).then(function(e){a.info('[roomService] onRoomInfoMessage : conferenceAdd event'),r.$broadcast('ROOM_UPDATE_CONFID',e),r.$broadcast('ROOM_ADD_CONF_ENDPOINT_EVENT',e),r.$broadcast('ON_CONFERENCE_STARTED_INVITATION',e,u)})},2e3,1);break;case'conferenceRemove':i(function(){C.getServerRoom(p.dbId).then(function(e){a.info('[roomService] onRoomInfoMessage : conferenceRemove event'),r.$broadcast('ROOM_REMOVE_CONF_ENDPOINT_EVENT',e),r.$broadcast('ON_CONFERENCE_ENDED_INVITATION',e)})},2e3,1);break;case'invitation':p.isUserModerator(d.userContact)&&(!u||u.status===C.RoomUserStatus.DELETED)&&C.getServerRoom(p.dbId).then(function(e){r.$broadcast(C.ROOM_UPDATE_EVENT,e)});break;default:}}}else if(0<angular.element(e).find('subject').length){var t=angular.element(e).attr('from'),m=l.getBareJidFromJid(t),p=C.getRoomByJid(m),g=angular.element(e).find('subject').text();p&&g&&(a.info('[roomService] onRoomInfoMessage : update subject of room'),p.desc=g,r.$broadcast(C.ROOM_UPDATE_EVENT,p))}return!0}catch(e){return a.error('[roomService] onRoomInfoMessage error '+e),!0}},C.onRoomHistoryInfoMessage=function(e){var t=$(e),n=t.find('changed');if(0<n.length){var o=n.attr('with'),i=C.getRoomByJid(o);a.debug('[roomService] onRoomHistoryInfoMessage with '+o),r.$broadcast(C.ROOM_HISTORY_UPDATE_EVENT,i)}return!0},C.onRoomMessageConfig=function(e){try{var t=$(e),n=t.find('room');if('management'===t.attr('type')&&0<n.length){var o=n.attr('roomid'),i=n.attr('userjid'),s=n.attr('status'),c=n.attr('topic'),l=n.attr('name'),m=n.attr('scheduledStartDate'),g=n.attr('scheduledEndDate'),v=n.attr('scheduledTimezone'),f=n.attr('lastAvatarUpdateDate'),h=t.find('avatar'),E=null;0<h.length&&('delete'===h.attr('action')?E='delete':E='update');var R=n.attr('privilege'),b=n.attr('customData'),y=C.getRoomById(o);a.info('[roomService] onRoomMessageConfig -- management -- '+o);var T=n.find('guests');if(0<T.length&&(a.info('[roomService] onRoomMessageConfig -- '+o+' -- update guests list'),'update'===T.attr('action')&&(y.guestEmails=[],$(T).find('email').each(function(e,t){y.guestEmails.push(t.textContent)}))),y&&s){var I=y.getUserByJid(i);I?I&&(a.info('[roomService] onRoomMessageConfig update user status'),C.updateUserStatus(y,I,s)):(a.info('[roomService] onRoomMessageConfig room exists, but user not. Update the room'),C.getServerRoom(o).then(function(){y.updateAvatarInfo()}))}else if(y&&l)a.info('[roomService] onRoomMessageConfig update Room name or topic'),y.name=l,y.desc=c?c:'',C.roomsByJids[y.jid].name=l,C.rooms[y.dbId].name=l,C.roomsByJids[y.jid].desc=c?c:'',C.rooms[y.dbId].desc=c?c:'',y.isMeetingRoom()&&C.getServerRoom(y.dbId).then(function(){r.$broadcast('MEETING_UPDATE_EVENT',y)}),r.$broadcast(C.ROOM_UPDATE_EVENT,y);else if(y&&b){a.info('[roomService] onRoomMessageConfig update Room customData');var N=u.extractHtmlContent(b);try{b=JSON.parse(N)}catch(e){a.error('[roomService] onRoomMessageConfig update Room Parsing error:',e),b={}}y.customData=b,C.roomsByJids[y.jid].customData=b,C.rooms[y.dbId].customData=b,r.$broadcast(C.ROOM_UPDATE_EVENT,y)}else if(y&&y.conference&&m&&g&&v)a.info('[roomService] onRoomMessageConfig update Room conference data'),y.conference.scheduledStartDate=moment(m).toISOString(),y.conference.scheduledEndDate=moment(g).toISOString(),y.conference.scheduledTimezone=v,y.conference.scheduledDuration=moment.duration(moment(g).diff(moment(m))).asMinutes(),r.$broadcast(C.ROOM_UPDATE_EVENT,y);else if(y&&(f||E))a.info('[roomService] onRoomMessageConfig '+E+' avatar'),C.getServerRoom(y.dbId).then(function(e){e.updateAvatarInfo(),r.$broadcast(C.ROOM_AVATAR_UPDATE_EVENT,y)});else if(y&&R){a.info('[roomService] onRoomMessageConfig update user\'s privilege '+R);var I=i?y.getUserByJid(i):null;if(I&&I.contact&&I.contact.jid!==d.userContact.jid&&'owner'!==R?('moderator'===R?I.privilege=p.Privilege.MODERATOR:'user'===R&&(I.privilege=p.Privilege.USER),d.getVCardByDbId(I.contact.dbId).then(function(){C.refreshMemberAndOrganizerLists(y),r.$broadcast(C.ROOM_UPDATE_EVENT,y)})):C.getServerRoom(y.dbId).then(function(e){C.refreshMemberAndOrganizerLists(e),r.$broadcast(C.ROOM_UPDATE_EVENT,e)}),'owner'===R&&I&&I.contact&&I.contact.jid===d.userContact.jid){var A=S.instant('promotedToOwner',{name:_escape(y.name)});r.$broadcast('GLOBAL_NOTIFY_MESSAGE_EVENT',A)}}else void 0===y&&o&&!C.roomsInProgress[o]&&'deleted'!==s&&'rejected'!==s?(C.roomsInProgress[o]=!0,a.info('[roomService] onRoomMessageConfig -- room does not exist, create new one'),C.getServerRoom(o).then(function(e){delete C.roomsInProgress[o],a.info('[roomService] onRoomMessageConfig -- sendInitialRoomPresence to the new room'),C.sendInitialRoomPresence(e),C.updateLater[o]&&(delete C.updateLater[o],a.info('[roomService] onRoomMessageConfig -- later update of the new room'),C.getServerRoom(o).then(function(e){e.updateAvatarInfo()}))})):C.roomsInProgress[o]&&(C.updateLater[o]=o)}var O=angular.element(e).find('openinvite');if(O&&'update'===O.attr('action')){var o=O.find('roomid').text();o?C.openInviteRoomId&&C.openInviteRoomId!==o?(a.debug('[roomService] room bound to openinviteId changed'),C.openInviteRoomId='',C.retrieveOpenInviteRoom().then(function(){r.$broadcast(C.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT)})):r.$broadcast(C.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT):(r.$broadcast(C.ON_OPEN_INVITE_ROOM_ID_UPDATED_EVENT),a.warn('[roomService] openInviteId unbound'))}return!0}catch(e){return a.info('[roomService] onRoomMessageConfig  -- failure -- '+e.message),!0}},C.onRoomPresence=function(e){try{var t=angular.element(e),n=t.attr('from'),o=l.getBareJidFromJid(n),s=l.getResourceFromJid(n),c=C.getRoomByJid(o);if(c)if(a.info('[roomService] onRoomPresence -- '+c.dbId),-1!==s.indexOf('/')&&(s=l.getBareJidFromJid(s)),d.isUserContactJid(s)){var p=t.find('status'),u=null;p.each(function(e,t){'332'===$(t).attr('code')&&(u='332')}),'332'===u?(a.error('[roomService] disconnected from room '+c.getNameForLogs()+' because of a system shutdown'),C.sendInitialRoomPresenceSync(c)):c.initPresPromise&&(a.info('[roomService] onRoomPresence - initPresPromise resolved'),c.initPresPromise.resolve(c),c.initPresInterval&&i.cancel(c.initPresInterval),c.initPresPromise=null,r.$broadcast(C.ROOM_UPDATE_EVENT,c),c.initPresPromiseReceived=!0)}else c.dbId&&!C.rooms[c.dbId]&&C.getServerRoom(c.dbId);return!0}catch(e){return a.error('[roomService] onRoomPresence error '+e),!0}},C.updateUserStatus=function(e,t,n){if(a.info('[roomService] '+t.status+' || '+n),d.isUserContactJid(t.contact.jid)&&t.status!==n)switch(a.info('[roomService] my new status '+n),n){case'deleted':delete C.roomsByJids[e.jid],delete C.rooms[e.dbId],a.info('[roomService] deleteRoom successfully ('+e.dbId+')'),C.sendUnavailableRoomPresence(e),C.computeInvitationCounter(),e.isMeetingRoom()&&r.$broadcast('MEETING_DELETE_EVENT',e),r.$broadcast(C.ROOM_UPDATE_EVENT,e,'remove');break;case'unsubscribed':a.info('[roomService] unsubscribed successfully ('+e.dbId+')'),C.sendUnavailableRoomPresence(e),e.status=C.RoomUserStatus.UNSUBSCRIBED,t.status=n,e.updateAvatarInfo(),e.isModerator=!1,C.computeInvitationCounter(),r.$broadcast(C.ROOM_UPDATE_EVENT,e);break;case'accepted':c.retrieveReceivedFilesForRoom(e.dbId).then(function(){C.sendInitialRoomPresence(e),e.status=C.RoomUserStatus.ACCEPTED,t.status=n,e.updateAvatarInfo(),C.computeInvitationCounter(),r.$broadcast(C.ROOM_UPDATE_EVENT,e)});break;case'rejected':delete C.roomsByJids[e.jid],delete C.rooms[e.dbId],e.status=C.RoomUserStatus.REJECTED,t.status=n,C.computeInvitationCounter(),r.$broadcast(C.ROOM_UPDATE_EVENT,e);break;default:}else t&&!d.isUserContactJid(t.contact.jid)&&(a.info('[roomService] Update user with status '+n),t.status===C.RoomUserStatus.DELETED&&n===C.RoomUserStatus.ACCEPTED&&(t.date=new Date,t.privilege===p.Privilege.MODERATOR&&(t.privilege=p.Privilege.USER)),t.status=n,e.updateAvatarInfo(),C.refreshMemberAndOrganizerLists(e),r.$broadcast(C.ROOM_UPDATE_EVENT,e))},C.findRoomsWithConfId=function(e){var t=C.getRooms().filter(function(t){return!!(t.confEndpoints&&t.confEndpoints.length)&&t.confEndpoints.some(function(t){return t.confEndpointId===e})});return t},C.removeConfIdInAllRooms=function(e){var a=[];return e.forEach(function(e){e.confEndpoints&&0<e.confEndpoints.length&&a.push(C.deleteRoomConferenceEndPoint(e,e.confEndpoints[0].confEndpointId))}),t.all(a)},C.getCreationDate=function(e){return e.creationDate?moment(e.creationDate):moment()},C.sortByDate=function(e,t){var a=1;return e&&t&&(a=e.value-t.value),a},C.bindOpenInviteToRoom=function(e,r){return t(function(t,o){n({method:'PUT',url:C.portalURL+'users/'+d.userContact.dbId+'/open-invites/bind',headers:s.getRequestHeader(),data:{roomId:e}}).then(function(){a.info('[roomService] openInvite '+r+' successfully bound to room '+e),t(C.rooms[e])}).catch(function(e){a.error('[roomService] Error binding openInviteId to Room'),o(e)})})},C.unbindOpenInviteFromRoom=function(){return t(function(e,t){n({method:'PUT',url:C.portalURL+'users/'+d.userContact.dbId+'/open-invites/unbind',headers:s.getRequestHeader()}).then(function(r){var n=r.data.data;n&&n.openInviteId&&n.roomId?(a.error('[roomService] An error occured, room '+n.roomId+' is still bound with openInviteId '+n.openInviteId),t()):(C.openInviteRoomId='',a.info('[roomService] openInvite successfully unbound'),e())},function(){var e='unbindOpenInvite failure';a.error('[roomService] '+e),t(new Error(e))})})},C.joinRoomUsingOpenInviteId=function(e){return t(function(t,r){n({method:'POST',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/rooms/open-invites',headers:s.getRequestHeader(),data:{openInviteId:e}}).then(function(e){var a=e.data.data;a&&a.roomId?t(a.roomId):r()}).catch(function(e){a.error('[roomService] Error retrieveRoomFromOpenInvite'),r(e)})})},C.retrieveRoomIdFromOpenInviteId=function(){return t(function(e,t){n({method:'GET',url:C.portalURL+'users/'+d.userContact.dbId+'/open-invites',headers:s.getRequestHeader()}).then(function(r){var n=r.data.data;n&&n.roomId?e(n.roomId):(a.error('[roomService] Error - no roomId associated to openInviteId'),t())}).catch(function(e){a.error('[roomService] Error retrieveRoomFromOpenInvite'),t(e)})})},C.retrieveOpenInviteRoom=function(){return a.debug('[roomService] retrieveOpenInviteRoom'),t(function(e,t){C.openInviteRoomId?C.rooms[C.openInviteRoomId]?e(C.rooms[C.openInviteRoomId]):(a.warn('[roomService] retrieveOpenInviteRoom - unknown room'),C.openInviteRoomId='',C.unbindOpenInviteFromRoom().finally(function(){t()})):C.retrieveRoomIdFromOpenInviteId().then(function(r){if(r){C.openInviteRoomId=r;var n=C.getRoomById(r);if(n)return void e(n);a.warn('[roomService] retrieveOpenInviteRoom - room with openInvite not found locally, retrieving it from server.'),C.getServerRoom(r).then(function(t){e(t)}).catch(function(){a.warn('[roomService] retrieveOpenInviteRoom - no room attached'),t(new Error('[roomService] retrieveOpenInviteRoom - no room attached'))})}else a.warn('[roomService] retrieveOpenInviteRoom - no room attached'),t(new Error('[roomService] retrieveOpenInviteRoom - no room attached'))}).catch(function(){a.warn('[roomService] retrieveOpenInviteRoom - no room attached'),t(new Error('[roomService] retrieveOpenInviteRoom - no room attached'))})})},C.getName=function(e){return e.name},C.sortByName=function(e,t){return e&&t&&'string'===e.type&&'string'===t.type&&e.value&&t.value?e.value.localeCompare(t.value):-1},C.sortObjectByProperty=function(e){return function(t,a){return t[e]<a[e]?-1:t[e]>a[e]?1:0}}}])},function(){(function(){'use strict';angular.module('rainbow').service('groupService',['$q','$rootScope','$log','$http','authService','contactService','xmppService','Group','usersService','utilService',function(e,t,a,r,n,o,i,s,d,c){var l=this;this.started=!1,l.ON_REMOVE_GROUP_USER_EVENT='ON_REMOVE_GROUP_USER_EVENT',l.ON_ADD_GROUP_USER_EVENT='ON_ADD_GROUP_USER_EVENT',l.ON_GROUP_USERS_UPDATE_EVENT='ON_GROUP_USERS_UPDATE_EVENT',l.ON_CREATED_GROUP_EVENT='ON_CREATED_GROUP_EVENT',l.ON_UPDATE_GROUP_EVENT='ON_UPDATE_GROUP_EVENT',l.ON_REMOVED_GROUP_EVENT='ON_REMOVED_GROUP_EVENT',this.start=function(){a.info(''),a.info('[groupService] === STARTING ==='),l.portalURL=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+n.userId+'/';var t=e.defer();return(l.$q=e,l.groups=null,o.userContact.isCPaaSGuest())?t.resolve():(this.attachHandlers(),this.getGroups(),l.started=!0,a.info('[groupService] === STARTED ==='),t.resolve(),t.promise)},this.stop=function(){return a.info('[groupService] === STOPPING ==='),l.conversations=null,l.groups=null,this.groupMessageHandlerRef&&(i.deleteHandler(this.groupMessageHandlerRef),this.groupMessageHandlerRef=null),this.started=!1,a.info('[groupService] === STOPPED ==='),e.when()},this.getGroups=function(){return l.groups?e.when(l.groups):l.getRemoteGroups()},l.getGroupsAsArray=function(){var e=[];for(var t in l.groups)l.groups.hasOwnProperty(t)&&e.push(l.groups[t]);return e},this.searchGroups=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return l.groups.filter(function(e){var a=e.name.toLowerCase().trim().split(/[ ]+/),r=t.every(function(t){return a.some(function(r,n){return!!(r.length&&0===c.removeDiacritis(r).indexOf(c.removeDiacritis(t)))&&(a[n]='',e._displayName=c.removeDiacritis(e.name),!0)})});return r})},this.getRemoteGroups=function(){a.info('[groupService] getGroups');var t=e.defer();return r({method:'GET',url:l.portalURL+'groups?format=full',headers:n.getRequestHeader()}).then(function(t){var r=t.data.data;a.info('[groupService] getGroups success (find '+t.data.total+' group(s))'),l.groups=[];var n=[];return r.forEach(function(e){var t=s.createFromData(e);l.groups.push(t),angular.forEach(e.users,function(e){n=o.getContactByDBId(e).then(function(e){e&&t.users.push(e)})}),l.logGroupUsers(t),l.sortUsersInGroup(t)}),e.all(n)},function(e){var r='getGroups'+l.handleErrorMessage(e);t.reject(new Error(r)),a.error('[groupService] '+r)}).then(function(){t.resolve(l.groups)}),t.promise};var p=function(a,r){return e(function(e){var n=l.groups.some(function(n){if(n.id===a){var i=n.users.some(function(e){return r===e.dbId});return i?(e(n),t.$broadcast(l.ON_ADD_GROUP_USER_EVENT,a,r),!0):(o.getContactByDBId(r).then(function(o){n.users.push(o),l.sortUsersInGroup(n);o.getGroups()?o.getGroups().push(n):o.setGroups([n]),t.$broadcast(l.ON_ADD_GROUP_USER_EVENT,a,r),e(n)}),!0)}return!1});n||(t.$broadcast(l.ON_ADD_GROUP_USER_EVENT,a,r),e())})};this.getGroup=function(t){a.info('[groupService] getGroup  for '+t);var i=e.defer(),d=null;return r({method:'GET',url:l.portalURL+'groups/'+t,headers:n.getRequestHeader()}).then(function(t){var r=t.data.data,n=[];d=s.createFromData(r),a.info('[groupService] getGroup success for '+d.name+' : '+d.id);var i=l.groups.some(function(e,t){return e.id===r.id&&(l.groups[t]=d,angular.forEach(r.users,function(e){n=o.getContactByDBId(e.id).then(function(e){e&&(l.groups[t].users.push(e),l.sortUsersInGroup(l.groups[t]))})}),!0)});return i||(l.groups.push(d),angular.forEach(r.users,function(e){n=o.getContactByDBId(e.id).then(function(e){if(e){d.users.push(e),l.sortUsersInGroup(d);var t=[d];e.getGroups()?e.getGroups().push(d):e.setGroups(t)}})})),e.all(n)},function(e){var t='getGroup'+l.handleErrorMessage(e);i.reject(new Error(t)),a.error('[groupService] '+t)}).then(function(){i.resolve(d)}),i.promise},this.addGroup=function(t){a.info('[groupService] addGroup : '+t.name);var o=e.defer();return r({method:'POST',url:l.portalURL+'groups',headers:n.getPostHeader(),data:{name:t.name,comment:t.comment,isFavorite:t.isFavorite}}).then(function(e){a.info('[groupService] addGroup success for : '+t.name);var r=e.data.data,n=s.createFromData(r);o.resolve(n)},function(e){var t='addGroup'+l.handleErrorMessage(e);o.reject(new Error(t)),a.error('[groupService] '+t)}),o.promise};var u=function(e){angular.forEach(l.groups,function(t,a){t.id===e&&l.groups.splice(a,1)})};this.removeGroup=function(t){a.info('[groupService] removeGroup : '+t);var o=e.defer();return r({method:'DELETE',url:l.portalURL+'groups/'+t,headers:n.getRequestHeader()}).then(function(){a.info('[groupService] removeGroup success for : '+t),u(t),o.resolve()},function(e){var t='removeGroup'+l.handleErrorMessage(e);o.reject(new Error(t)),a.error('[groupService] '+t)}),o.promise},this.updateGroup=function(t){a.info('[groupService] updateGroup for : '+t.name);var o=e.defer();return r({method:'PUT',url:l.portalURL+'groups/'+t.id,headers:n.getRequestHeader(),data:{name:t.name,comment:t.comment,isFavorite:t.isFavorite}}).then(function(){a.info('[groupService] updateGroup success for : '+t.name),o.resolve()},function(e){var t=l.handleErrorMessage(e,'updateGroup');o.reject(t),a.error('[groupService] '+t.message)}),o.promise},this.getGroupUsers=function(t){a.info('[groupService] getGroupUsers : '+t);var o=e.defer();return r({method:'GET',url:l.portalURL+'groups/'+t+'/users',headers:n.getRequestHeader()}).then(function(e){var r=e.data.data;a.info('[groupService] getGroupUsers success for '+t+' (find '+e.data.total+' users(s))'),o.resolve(r.users)},function(e){var t='getGroupUsers'+l.handleErrorMessage(e);o.reject(new Error(t)),a.error('[groupService] '+t)}),o.promise},this.addGroupUser=function(e,o){a.info('[groupService] addGroupUser');var i=l.$q.defer(),d=e.users.some(function(e){return o.dbId===e.dbId});return d?(a.info('[groupService] addGroupUser - user: '+o.id+' already exist in group: '+e.name+' - no remote action'),void i.resolve()):(r({method:'POST',url:l.portalURL+'groups/'+e.id+'/users/'+o.dbId,headers:n.getPostHeader()}).then(function(r){a.info('[groupService] addGroupUser success: '+o.id+'/'+e.name),p(e.id,o.dbId).then(function(e){if(e)i.resolve(e);else{var t=r.data.data,a=s.createFromData(t);i.resolve(a)}}),t.$broadcast(l.ON_GROUP_USERS_UPDATE_EVENT)},function(e){var t='addGroupUser'+l.handleErrorMessage(e);i.reject(new Error(t)),a.error('[groupService] '+t)}),i.promise)};var m=function(e,t){angular.forEach(l.groups,function(a){a.id===e&&(angular.forEach(a.users,function(r,n){r.dbId===t&&(a.users.splice(n,1),r.getGroups()&&angular.forEach(r.getGroups(),function(t,a){t.id===e&&r.getGroups().splice(a,1)}))}),l.sortUsersInGroup(a))})};this.getGroupById=function(e){var t=null;return angular.forEach(l.groups,function(a){a.id===e&&(t=a)}),t},this.removeGroupUser=function(o,i){a.info('[groupService] removeGroupUser : '+o+'/'+i.id);var s=e.defer();return r({method:'DELETE',url:l.portalURL+'groups/'+o+'/users/'+i.dbId,headers:n.getRequestHeader()}).then(function(){a.info('[groupService] removeGroupUser success : '+o+'/'+i.id),m(o,i.dbId);var e=l.getGroupById(o);t.$broadcast(l.ON_GROUP_USERS_UPDATE_EVENT),s.resolve(e)},function(e){var t='removeGroupUser'+l.handleErrorMessage(e);s.reject(new Error(t)),a.error('[groupService] '+t)}),s.promise},this.getUserGroups=function(t){if(!t)return a.info('[groupService] getUserGroups for unknown user !'),e.when();a.info('[groupService] getUserGroups for user : '+t.id);var o=e.defer(),i=t.getGroups();return i?e.when(i):(r({method:'GET',url:l.portalURL+'groups?userId='+t.dbId,headers:n.getRequestHeader()}).then(function(e){var r=e.data.data;a.info('[groupService] getUserGroups success (find '+e.data.total+' group(s))');var n=[];r.forEach(function(e){var t=s.createFromData(e);n.push(t)}),t.setGroups(n),l.logUserGroups(t.displayNameForLog(),n),o.resolve(n)},function(e){var t='getUserGroups'+l.handleErrorMessage(e);o.reject(new Error(t)),a.error('[groupService] '+t)}),o.promise)},this.getGroupFromName=function(t){a.info('[groupService] getGroupFromName : '+t);var r=e.defer();return this.getGroups().then(function(e){var a=null;e.forEach(function(e){e.name===t&&(a=e)}),r.resolve(a)}),r.promise},this.sortUsersInGroup=function(e){e&&(e.sortedUserList=d.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity(e.users,t.orderType,t.filterType,!0))},this.searchLocalGroup=function(e){var t=[];return a.info('[groupService] searchLocalGroup with text '+e),e&&l.groups.forEach(function(a){0<=a.name.toLowerCase().indexOf(e.toLowerCase().toString())&&t.push(a)}),t},this.extractStanzaData=function(t){var a=e.defer(),r={};return r.outgoingMessage=!1,r.body=angular.element(t)[0].firstChild,r.messageId=angular.element(t).attr('id'),a.resolve(r),a.promise},this.onGroupMessageReceived=function(e){try{return this.extractStanzaData(e).then(function(e){if(e.body&&'group'===e.body.tagName){var a=e.body.getAttribute('action'),r=e.body.getAttribute('scope'),n=e.body.getAttribute('id');switch(r){case'group':switch(a){case'create':l.getGroup(n),t.$broadcast(l.ON_CREATED_GROUP_EVENT,n);break;case'update':var o=e.body.getAttribute('name'),i=e.body.getAttribute('comment'),s='true'===e.body.getAttribute('isFavorite');t.$broadcast(l.ON_UPDATE_GROUP_EVENT,n,o,i,s);break;case'delete':u(n),t.$broadcast(l.ON_REMOVED_GROUP_EVENT,n);break;default:}break;case'user':{var d=e.body.getAttribute('userId');switch(a){case'create':p(n,d);break;case'delete':m(n,d),t.$broadcast(l.ON_REMOVE_GROUP_USER_EVENT,n,d);break;default:}}break;default:}}}),!0}catch(e){return!0}},this.attachHandlers=function(){l.removeHandlers(),l.groupMessageHandlerRef||(l.groupMessageHandlerRef=i.addHandler(function(e){return l.onGroupMessageReceived(e)},null,'message','management'))},this.removeHandlers=function(){l.groupMessageHandlerRef&&(i.deleteHandler(l.groupMessageHandlerRef),l.groupMessageHandlerRef=null)},this.handleBadRequest=function(e,t){if(400===t.status&&t.data.errorDetails&&0<t.data.errorDetails.length){var a={};t.data.errorDetails.forEach(function(e){a[e.param]=e.msg});var r=new Error(e+' failure: BadRequest');return r.fieldErrors=a,r}return null},this.handleErrorMessage=function(e){var t=' failure: ';return 500===e.status&&(t+='Internal server error'),403===e.status?t+='Access is forbidden for the current user':404===e.status?t+=e.data.errorMsg:e.data&&e.data.errorDetails&&(t+=e.data.errorDetails),t},this.logUserGroups=function(e,t){var r='';t&&0!==t.length&&(t.forEach(function(e){e.name&&(r+=' '+e.name)}),a.info('[groupService] logUserGroups for '+e+':'+r))},this.logGroupUsers=function(e){var t='';e&&e.users&&0!==e.users.length&&(t=e.users.map(function(e){return e.displayNameForLog()}).join(' / '),a.info('[groupService] logGroupUsers for '+e.name+': '+t))}}])})()},function(){const e=3e5,t=9e5;var a;(function(e){e[e.Unknow=0]='Unknow',e[e.Free=1]='Free',e[e.WaitWebrtc=2]='WaitWebrtc',e[e.WaitTelephony=3]='WaitTelephony',e[e.CallOffer=4]='CallOffer',e[e.CallOnGoing=5]='CallOnGoing',e[e.CallActive=6]='CallActive',e[e.CallActiveNoWebMedia=7]='CallActiveNoWebMedia',e[e.TelCallReleasing=8]='TelCallReleasing',e[e.WebCallReleasing=9]='WebCallReleasing',e[e.RemoteControled=10]='RemoteControled',e[e.AnomalyCCS=11]='AnomalyCCS'})(a||(a={}));class r{constructor(t,a,r,n,o,i,s,d,c,l,p,u,m,g,v){this.$q=t,this.$rootScope=a,this.$log=r,this.$http=n,this.authService=o,this.$interval=i,this.xmppService=s,this.videoService=d,this.errorHelperService=c,this.contactService=l,this.profileService=p,this.Call=u,this.uuid4=m,this.telephonyService=g,this.settingsService=v,this.started=!1,this.myContact=null,this.mediaPillarContact=null,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarJid='',this.evtQueue=[],this.SEM=0,this.fakeMediaPillarJid='00a241586a984a869c73719007b27921@demo-all-in-one-dev-1.opentouch.cloud',this.TO_transition=15e3,this.TO_transition_long=3e4,this.TO_NoWebMedia=6e4,this.TO_PILLAR_POLLING=e,this.mediaPillarKeepAliveSuspend=!1}start(t){return this.$q((r)=>{let n=performance.now();this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.portalURL=config.restServerUrl+'/api/rainbow/mediapillar/v1.0/mediapillars',this.myContact=this.contactService.userContact,this.mediaPillarContact=null,this.mediaPillarCallContext={callState:a.Free,keepAlive_TO:null,callState_TO:null,isOutgoingCall3PCC:!1,telephonyCallRefs:[],webrtcCallRef:null,mediaPillarJid:'',rainbowPhoneNumber:'',remoteExtension:'',previousCallConnectionId:null,previousCallStatus:null,updateContactFlag:!1},this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)?(this.$log.info('[WebrtcGatewayService] === STARTING ==='),this.started=!0,this.SEM=0,this.resetEvtAutomaton(),this.getMediaPillarData().then((a)=>{this.mediaPillarContact=this.createMediaPillarContact(a),this.mediaPillarCallContext.mediaPillarJid=a,this.$log.info('[WebrtcGatewayService] Pillar remoteExtension used : '+this.mediaPillarCallContext.remoteExtension),''===this.mediaPillarCallContext.remoteExtension?(this.$log.warn('[WebrtcGatewayService] no remoteExtention available '),this.mediaPillarConfigured=!1):this.mediaPillarConfigured=!0,this.mediaPillarConfigured&&this.dummyRegisterMediaPillarCall().then(()=>{this.mediaPillarAlive=!0,this.$log.info('[WebrtcGatewayService] Pseudo media pillar register OK with extension '+this.mediaPillarCallContext.remoteExtension),this.$rootScope.$broadcast('ON_WEBRTCGATEWAY_STATE_CHG',this.mediaPillarAlive)}).catch(()=>{this.mediaPillarAlive=!1,this.$log.info('[WebrtcGatewayService] Pseudo media pillar register KO'),this.$log.info('[WebrtcGatewayService] Initial polling activated on starting issue'),this.mediaPillarKeepAlivePolling('START',e),this.$rootScope.$broadcast('ON_WEBRTCGATEWAY_STATE_CHG',this.mediaPillarAlive)}),this.$rootScope.$on('ON_CONNECTION_STATE_CHANGE_EVENT',(t,a)=>{'disconnected'===a?(this.$log.info('[WebrtcGatewayService] onConnectionStateChangeEvent : disconnected then MP keepalive suspended'),this.mediaPillarKeepAliveSuspend=!0):'connected'==a&&(this.$log.info('[WebrtcGatewayService] onConnectionStateChangeEvent : connected then keepalive as necessary'),this.mediaPillarKeepAliveSuspend=!1,this.TO_PILLAR_POLLING=e)}),this.$rootScope.$on('$destroy',this.$rootScope.$on('ON_CALL_UPDATED_EVENT',(e,t,a)=>{this.onCallEvent(e,t,a)})),this.$rootScope.$on('$destroy',this.$rootScope.$on('ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT',(e,t)=>{this.onRemoteCtrlCall(e,t)}));var o=Math.round(performance.now()-n);t.push({service:'WebrtcGatewayService',startDuration:o}),this.$log.info('[WebrtcGatewayService] === STARTED ('+o+' ms) ==='),r()}).catch((e)=>{this.mediaPillarCallContext.mediaPillarJid='',this.mediaPillarCallContext.rainbowPhoneNumber='',this.mediaPillarCallContext.remoteExtension='',this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.$log.info('[WebrtcGatewayService] === STARTING FAILURE === '+e.message),r()})):(this.$log.info('[WebrtcGatewayService] === NO WEBRTCGATEWAY ENVOLVED === '),r())})}stop(){return this.$log.info('[WebrtcGatewayService] === STOPPING ==='),this.started=!1,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarKeepAlivePolling('STOP',0),this.mediaPillarCallContext&&(this.releaseMediaPillarCallContext(),this.mediaPillarCallContext.callState=a.Unknow,this.mediaPillarCallContext.mediaPillarJid='',this.mediaPillarCallContext.rainbowPhoneNumber='',this.mediaPillarCallContext.remoteExtension=''),this.$log.info('[WebrtcGatewayService] === STOPPED ==='),this.$q.resolve()}onCallEvent(e,t,a){if(this.isMediaPillarCallCase()){if(this.SEM++,this.$log.info('[WebrtcGatewayService] onCallEvent IN('+this.SEM+') state = '+this.mediaPillarCallContext.callState),this.$log.info('[WebrtcGatewayService] onCallEvent '+this.mediaPillarCallContext.callState+' --- '+t.type.value+'('+t.id+','+t.status.value+')'),t.connectionId===this.mediaPillarCallContext.previousCallConnectionId&&t.status===this.mediaPillarCallContext.previousCallStatus)return this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.$log.info('[WebrtcGatewayService] onCallEvent | DEBOUNCE EVT'),this.SEM--,void this.$log.info('[WebrtcGatewayService] onCallEvent OUT('+this.SEM+')');if(t.type.value===this.Call.Type.PHONE.value&&null===t.id)return this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.$log.info('[WebrtcGatewayService] onCallEvent | FILTER EVT null/error'),this.SEM--,void this.$log.info('[WebrtcGatewayService] onCallEvent OUT('+this.SEM+')');if(a&&null!==a&&(this.$log.info('[WebrtcGatewayService] onCallEvent tel infoEvt : Evt = '+a.actionElemName+' / cause = '+a.cause),'updatecall'===a.actionElemName&&(this.mediaPillarCallContext.updateContactFlag=!0,this.$log.info('[WebrtcGatewayService] updateContactFlag = true'))),this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.evtQueue.push(t),1<this.evtQueue.length)return this.SEM--,void this.$log.info('[WebrtcGatewayService] onCallEvent OUT('+this.SEM+') evt pushed = '+t.status.value);for(;this.evtQueue.length;){try{this.processEvt(this.evtQueue[0])}catch(e){this.$log.error('[WebrtcGatewayService] onCallEvent queue processing | call : '+this.evtQueue[0].status.value+' Error : '+e)}this.evtQueue.splice(0,1)}this.SEM--,this.$log.info('[WebrtcGatewayService] onCallEvent OUT('+this.SEM+') state = '+this.mediaPillarCallContext.callState),0!==this.SEM&&(this.$log.error('[WebrtcGatewayService] onCallEvent OUT | Unmanaged Eventing Reentrancy Situation'),this.resetEvtAutomaton(),this.SEM=0)}}processEvt(e){if(this.$log.info('[WebrtcGatewayService] processEvt | process '+e.type.value+'('+e.id+','+e.status.value+') in MPcontextCallstate = '+this.mediaPillarCallContext.callState),e.type.value===this.Call.Type.PHONE.value){var t=this.telephonyService.getCalls().length;let r=(()=>{let t=!1;return(e.status===this.Call.Status.DIALING&&(e.isSecondary=!0),!e.isSecondary)?(this.$log.info('[WebrtcGatewayService] processEvt | NOT SECONDARY then ignore'),t=!0,t):e.status===this.Call.Status.UNKNOWN||e.status===this.Call.Status.RINGING_INCOMMING||e.status===this.Call.Status.QUEUED_INCOMMING||e.status===this.Call.Status.ACTIVE?(this.addTelCallRefs(e),t=!1,t):this.mediaPillarCallContext.callState===a.RemoteControled?(this.$log.info('[WebrtcGatewayService] processEvt |  RemoteControled state for call : '+e.id+' then ignore'),t=!0,t):(this.addTelCallRefs(e),1<this.mediaPillarCallContext.telephonyCallRefs.length?(this.$log.info('[WebrtcGatewayService] processEvt |  nthCall : '+this.mediaPillarCallContext.telephonyCallRefs.length+' then ignore'),t=!0,t):t)})();if(!r)switch(this.$log.info('[WebrtcGatewayService] processEvt |  call('+e.id+' / SEC '+e.isSecondary+', '+e.status.value+') -> EVT PROCESSED'),this.$log.info('[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = '+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info('[WebrtcGatewayService] processEvt |  calls.length = '+t),e.status){case this.Call.Status.RINGING_INCOMMING:this.onTelCallIncomming(e);break;case this.Call.Status.DIALING:this.onTelCallDialling(e);break;case this.Call.Status.RINGING_OUTGOING:this.onTelCallOutgoing(e);break;case this.Call.Status.ACTIVE:this.onTelCallActive(e);break;case this.Call.Status.UNKNOWN:this.onTelCallReleasing(e);break;default:}else this.$log.info('[WebrtcGatewayService] processEvt |  call('+e.id+' / SEC '+e.isSecondary+', '+e.status.value+') -> EVT IGNORED'),this.$log.info('[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = '+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info('[WebrtcGatewayService] processEvt |  calls.length = '+t)}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(e.fullJid)))switch(e.status){case this.Call.Status.RINGING_INCOMMING:this.onWebrtcCallIncomming(e);break;case this.Call.Status.CONNECTING:this.onWebrtcCallConnecting(e);break;case this.Call.Status.ACTIVE:this.onWebrtcCallActive(e);break;case this.Call.Status.ANSWERING:this.onWebrtcCallAnswering(e);break;case this.Call.Status.UNKNOWN:this.onWebrtcCallReleasing(e);break;default:}else this.$log.info('[WebrtcGatewayService] processEvt | process call('+e.id+','+e.status.value+') -> Not a webrtcgateway case')}releaseMediaPillarCallContext(){this.mediaPillarCallContext.callState=a.Free,this.stopCallStateTimeOut(),this.mediaPillarCallContext.isOutgoingCall3PCC=!1,this.mediaPillarCallContext.updateContactFlag=!1,0<this.mediaPillarCallContext.telephonyCallRefs.length&&this.$log.warn('[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but telephonyCallRefs not empty !'),null!==this.mediaPillarCallContext.webrtcCallRef&&this.$log.warn('[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but webrtcCallRef not null !'),this.mediaPillarCallContext.telephonyCallRefs=[],this.mediaPillarCallContext.webrtcCallRef=null,this.mediaPillarCallContext.previousCallConnectionId=null,this.mediaPillarCallContext.previousCallStatus='',this.$log.log('[WebrtcGatewayService] releaseMediaPillarCallContext | =====  mediaPillarCallContext RELEASED  ===== ')}resetEvtAutomaton(){this.evtQueue=[]}stopCallStateTimeOut(){this.mediaPillarCallContext.callState_TO&&this.$interval.cancel(this.mediaPillarCallContext.callState_TO),this.mediaPillarCallContext.callState_TO=null}onRemoteCtrlCall(e,t){this.$log.info('[WebrtcGatewayService] onRemoteCtrlCall for call '+t.id+' in previous state: '+this.mediaPillarCallContext.callState+': => Becomes REMOTECONTROLED'),this.mediaPillarCallContext.callState=a.RemoteControled,this.stopCallStateTimeOut()}addTelCallRefs(e){if('undefined'==typeof e||null===e)return void this.$log.warn('[WebrtcGatewayService] addTelCallRefs | ANOMALY callRef not valid');let t=!1;for(var a=0;a<this.mediaPillarCallContext.telephonyCallRefs.length;a++)this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[a].id===e.id&&(t=!0);t||this.mediaPillarCallContext.telephonyCallRefs.push(e)}removeTelCallRefs(e){if('undefined'==typeof e||null===e)return void this.$log.warn('[WebrtcGatewayService] removeTelCallRefs | ANOMALY callRef not valid');for(let t=0;t<this.mediaPillarCallContext.telephonyCallRefs.length;)this.mediaPillarCallContext.telephonyCallRefs[t].id===e.id?(this.mediaPillarCallContext.telephonyCallRefs.splice(t,1),0===t&&this.mediaPillarCallContext.telephonyCallRefs.length&&(this.mediaPillarCallContext.telephonyCallRefs[0].setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.log('[WebrtcGatewayService] removeTelCallRefs | master MP call becomes : '+this.mediaPillarCallContext.telephonyCallRefs[0].id))):t++}putAsMasterTelCallRefs(e){if('undefined'==typeof e||null===e)return void this.$log.warn('[WebrtcGatewayService] putAsMasterTelCallRefs | ANOMALY callRef not valid');let t=-1;for(var a=0;a<this.mediaPillarCallContext.telephonyCallRefs.length;a++)this.mediaPillarCallContext.telephonyCallRefs[a].id===e.id&&(t=a);if(this.$log.log('[WebrtcGatewayService] putAsMasterTelCallRefs | master MP call is : '+e.id),0!==t)if(-1!==t){let a=this.mediaPillarCallContext.telephonyCallRefs[0];this.mediaPillarCallContext.telephonyCallRefs[0]=e,this.mediaPillarCallContext.telephonyCallRefs[t]=a,e.setMediaPillarCall(this.getMediaPillarCallContext())}else this.$log.warn('[WebrtcGatewayService] putAsMasterTelCallRefs | Anomaly call not in telephonyCallRefs')}isMasterTelCallRefs(e){return'undefined'==typeof e||null===e?(this.$log.warn('[WebrtcGatewayService] isMasterTelCallRefs | ANOMALY callRef not valid'),!1):0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[0].id===e.id}isInTelCallRefs(e){if('undefined'==typeof e||null===e)return void this.$log.warn('[WebrtcGatewayService] isInTelCallRefs | ANOMALY callRef not valid');let t=-1;for(var a=0;a<this.mediaPillarCallContext.telephonyCallRefs.length;a++)this.mediaPillarCallContext.telephonyCallRefs[a].id===e.id&&(t=a);return-1!==t}replaceCallRefs(e,t){if('undefined'==typeof e||null===e||'undefined'==typeof t||null===t)return void this.$log.warn('[WebrtcGatewayService] replaceCallRefs | ANOMALY callRef not valid');let a=!1,r=e.isMediaPillarCall(),n=t.isMediaPillarCall();this.isInTelCallRefs(e)&&(a=!0,this.$log.warn('[WebrtcGatewayService] replaceCallRefs | ANOMALY newcallRef already existing'),this.removeTelCallRefs(e));let o=-1;for(var i=0;i<this.mediaPillarCallContext.telephonyCallRefs.length;i++)this.mediaPillarCallContext.telephonyCallRefs[i].id===t.id&&(o=i);-1===o?(this.$log.warn('[WebrtcGatewayService] replaceCallRefs | ANOMALY oldCallRef not found'),a&&(this.addTelCallRefs(e),r&&e.setMediaPillarCall(this.getMediaPillarCallContext()))):(this.mediaPillarCallContext.telephonyCallRefs[o]=e,n&&e.setMediaPillarCall(this.getMediaPillarCallContext()),t.setMediaPillarCall(null),0===o&&this.$log.log('[WebrtcGatewayService] replaceCallRefs | master MP call becomes : '+this.mediaPillarCallContext.telephonyCallRefs[0].id))}automatonDefenseTimout(t){let r=0;if(void 0===t||null===t)this.mediaPillarCallContext.callState!==a.CallActive&&this.mediaPillarCallContext.callState!==a.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==a.RemoteControled&&this.mediaPillarCallContext.callState!==a.CallOffer&&this.mediaPillarCallContext.callState!==a.CallOnGoing&&(this.$log.log('[WebrtcGatewayService] automatonDefenseTimout | anomaly timout in unexpected state'),r=2);else if(t.type.value===this.Call.Type.PHONE.value)switch(this.$log.log('[WebrtcGatewayService] automatonDefenseTimout | transition telcall call='+t.id+' evt='+t.status.value+' then timout'),t.status){case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.RINGING_INCOMMING:break;default:this.mediaPillarCallContext.callState!==a.CallActive&&this.mediaPillarCallContext.callState!==a.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==a.CallOffer&&this.mediaPillarCallContext.callState!==a.CallOnGoing&&(r=2);}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(t.fullJid)))switch(this.$log.log('[WebrtcGatewayService] automatonDefenseTimout | transition webrtc '+t.status.value+' then timout'),t.status){case this.Call.Status.ACTIVE:break;default:this.mediaPillarCallContext.callState!==a.CallActive&&this.mediaPillarCallContext.callState!==a.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==a.CallOffer&&this.mediaPillarCallContext.callState!==a.CallOnGoing&&(r=3);}else this.$log.warn('[WebrtcGatewayService] automatonDefenseTimout | anomaly transition webrtc call but Not a webrtcgateway case'),r=2;switch(0!=r&&this.$log.warn('[WebrtcGatewayService] automatonDefenseTimout | actionlevel '+r),r){case 0:break;case 1:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING);break;case 2:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING),this.releaseMediaPillarCallContext();break;case 3:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext();break;default:this.TO_PILLAR_POLLING=e,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING),this.MediaPillarCallTerminator();}this.mediaPillarCallContext.callState!==a.Free&&(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(null)},this.TO_transition,1))}onTelCallIncomming(e){if(1<this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==a.Free&&this.mediaPillarCallContext.callState!==a.WaitTelephony&&this.mediaPillarCallContext.callState!==a.WaitWebrtc)return this.$log.info('[WebrtcGatewayService] onTelCallIncomming | nth calls BUT trig the GUI & link the call'),e.setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.info('[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = '+e.id),this.mediaPillarCallContext.updateContactFlag=!0,void this.$rootScope.$broadcast('ON_CONVERSATION_CALL_UPDATED_EVENT',{conversation:null,call:e});switch(this.$log.info('[WebrtcGatewayService] onTelCallIncomming | mediapilaryse as necessary for call '+e.id),this.mediaPillaryseTheCall(e,null)){case'Ok':if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),!this.isMediaPillarOutgoingCall()&&this.mediaPillarCallContext.callState===a.CallOffer&&this.mediaPillarCallContext.webrtcCallRef)for(var t=0;t<this.mediaPillarCallContext.telephonyCallRefs.length;t++)(this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.RINGING_INCOMMING||this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.QUEUED_INCOMMING)&&(this.$log.info('[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = '+e.id),this.mediaPillarCallContext.updateContactFlag=!0,this.$rootScope.$broadcast('ON_CONVERSATION_CALL_UPDATED_EVENT',{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[t]}));break;case'Update':!this.isMediaPillarOutgoingCall()&&this.mediaPillarCallContext.webrtcCallRef&&(e.status===this.Call.Status.RINGING_INCOMMING||e.status===this.Call.Status.QUEUED_INCOMMING)?(this.$rootScope.$broadcast('ON_CONVERSATION_CALL_UPDATED_EVENT',{conversation:null,call:e}),this.$log.info('[WebrtcGatewayService] onTelCallIncomming | update call')):this.$log.info('[WebrtcGatewayService] onTelCallIncomming | ignore update call');break;case'Ignore':this.$log.info('[WebrtcGatewayService] onTelCallIncomming | ignore evt');break;default:this.$log.error('[WebrtcGatewayService] onTelCallIncomming | media Pillar call anomaly '+status);}}onTelCallDialling(e){if(this.mediaPillarCallContext.callState===a.Free||this.mediaPillarCallContext.callState===a.WaitTelephony)switch(this.mediaPillarCallContext.isOutgoingCall3PCC=!0,this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.mediaPillaryseTheCall(e,null)){case'Ok':this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState===a.CallOffer&&(this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,'audio'),this.$log.info('[WebrtcGatewayService] onTelCallDialling | outgoing3PCC then send webrtc proceed')),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1);break;case'Ignore':case'Update':this.$log.info('[WebrtcGatewayService] onTelCallDialling | ignore evt');break;default:this.$log.error('[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly '+status),this.MediaPillarCallTerminator();}else this.mediaPillarCallContext.callState===a.CallOffer||this.mediaPillarCallContext.callState===a.CallOnGoing?(this.$log.warn('[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, on state : ',this.mediaPillarCallContext.callState),this.$log.info('[WebrtcGatewayService] onTelCallDialling | ignored , on state : ',this.mediaPillarCallContext.callState)):(this.$log.warn('[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, MP context not compatible'),this.MediaPillarCallTerminator())}onTelCallOutgoing(e){this.isMediaPillarOutgoingCall()?(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition_long,1)):(this.$log.warn('[WebrtcGatewayService] onTelCallOutgoing | media Pillar, not a 1st 3PCC outgoing call then ignore & release MP CallContext'),this.releaseMediaPillarCallContext())}onTelCallActive(e){switch(this.mediaPillarCallContext.callState){case a.CallOnGoing:this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState=a.CallActive;break;case a.TelCallReleasing:this.$log.warn('[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = '+this.mediaPillarCallContext.callState),this.$log.info('[WebrtcGatewayService] onTelCallActive | media Pillar , RE-ACTIVATION'),this.stopCallStateTimeOut(),e.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=a.CallActive;break;case a.CallActive:this.$log.info('[WebrtcGatewayService] onTelCallActive | media Pillar , ignore tel active on state CallActive ');break;case a.WebCallReleasing:this.$log.info('[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state WebCallReleasing then releaseMediaPillarCallContext'),this.releaseMediaPillarCallContext();break;case a.Free:this.$log.info('[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = 1 ; probably call taken on deskphone ; ignore active & release call context '),this.releaseMediaPillarCallContext();break;default:this.$log.info('[WebrtcGatewayService] onTelCallActive | Anomaly media Pillar recv tel active on state = '+this.mediaPillarCallContext.callState);}}onTelCallReleasing(e){this.telephonyService.getCalls().length;return 1<this.mediaPillarCallContext.telephonyCallRefs.length?(e.setMediaPillarCall(null),this.removeTelCallRefs(e),void this.$log.info('[WebrtcGatewayService] onTelCallReleasing -- '+e.id+' -- postpone mediaPillarCallContext release ;  remaining calls = '+this.mediaPillarCallContext.telephonyCallRefs.length)):void(this.isMediaPillarReleasableCall()?(e.setMediaPillarCall(null),this.removeTelCallRefs(e),this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState!==a.WebCallReleasing&&this.mediaPillarCallContext.callState!==a.RemoteControled?this.mediaPillarCallContext.callState===a.TelCallReleasing?this.$log.info('[WebrtcGatewayService] onTelCallReleasing -- '+e.id+' -- ignore telrelease on state = '+this.mediaPillarCallContext.callState):(this.mediaPillarCallContext.callState=a.TelCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.$log.info('[WebrtcGatewayService] onTelCallReleasing -- '+e.id+' -- wait web release: state = '+this.mediaPillarCallContext.callState)):this.mediaPillarCallContext.callState!==a.Free&&(this.releaseMediaPillarCallContext(),this.$log.info('[WebrtcGatewayService] onTelCallReleasing -- '+e.id+' -- release MP context'))):(this.$log.warn('[WebrtcGatewayService] onTelCallReleasing | media Pillar call release anomaly on state = '+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator()))}onWebrtcCallIncomming(e){if(this.mediaPillarCallContext.webrtcCallRef)return void this.$log.info('[WebrtcGatewayService] onWebrtcCallIncomming -- '+e.id+' --- ignored other incomming');switch(this.mediaPillaryseTheCall(null,e)){case'Ok':if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.isMediaPillarOutgoingCall())this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,'audio'),this.$log.info('[WebrtcGatewayService] onWebrtcCallIncomming | outgoing3PCC then send webrtc proceed');else if(this.mediaPillarCallContext.callState===a.CallOffer)for(var t=0;t<this.mediaPillarCallContext.telephonyCallRefs.length;t++)(this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.RINGING_INCOMMING||this.mediaPillarCallContext.telephonyCallRefs[t].status===this.Call.Status.QUEUED_INCOMMING)&&(this.$log.info('[WebrtcGatewayService] onWebrtcCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = '+this.mediaPillarCallContext.telephonyCallRefs[t].id),this.$rootScope.$broadcast('ON_CONVERSATION_CALL_UPDATED_EVENT',{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[t]}));break;case'Ignore':break;default:this.$log.error('[WebrtcGatewayService] onWebrtcCallIncomming | media Pillar call anomaly '+status);}}onWebrtcCallConnecting(){this.mediaPillarCallContext.callState===a.CallActive&&(this.$log.info('[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnecting'),this.mediaPillarCallContext.callState=a.CallActiveNoWebMedia,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.timeOutCallActiveNoWebMedia()},this.TO_NoWebMedia,1))}onWebrtcCallActive(){this.mediaPillarCallContext.callState===a.CallActiveNoWebMedia&&(this.$log.info('[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnected'),this.mediaPillarCallContext.callState=a.CallActive,this.stopCallStateTimeOut())}onWebrtcCallAnswering(e){this.mediaPillarCallContext.callState=a.CallOnGoing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1)}onWebrtcCallReleasing(e){this.isMediaPillarReleasableCall()?(e.setMediaPillarCall(null),this.mediaPillarCallContext.webrtcCallRef=null,0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==a.TelCallReleasing?this.mediaPillarCallContext.callState===a.WebCallReleasing?this.$log.info('[WebrtcGatewayService] onWebrtcCallReleasing -- '+e.id+' -- ignore webrelease on state = '+this.mediaPillarCallContext.callState):(this.mediaPillarCallContext.callState=a.WebCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(e)},this.TO_transition,1),this.$log.info('[WebrtcGatewayService] onWebrtcCallReleasing -- '+e.id+' -- wait tel release: state = '+this.mediaPillarCallContext.callState)):(this.releaseMediaPillarCallContext(),this.$log.info('[WebrtcGatewayService] onWebrtcCallReleasing -- '+e.id+' -- release MP context'))):(this.$log.warn('[WebrtcGatewayService] onWebrtcCallReleasing | media Pillar call release anomaly on state = '+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())}mediaPillarMakeCall(e,t){this.$log.info('[WebrtcGatewayService] mediaPillarMakeCall');let a=this.getMyMediaPillarJid();if(6<e.length&&t&&(e=t.phonePbx),this.videoService.makingCall=!0,''!==a){var r='web_'+this.uuid4.generate();if(!t||null===t){var n=this.Call.create(this.Call.Status.DIALING,r,this.Call.Type.WEBRTC,this.mediaPillarContact);n.fullJid=a,this.mediaPillarStartCall(n,e,a)}else{var n=this.Call.create(this.Call.Status.DIALING,r,this.Call.Type.WEBRTC,t);n.fullJid=a,this.mediaPillarStartCall(n,e,a)}}else this.$log.info('[WebrtcGatewayService] mediaPillarMakeCall ANOMALY no mediaPillarJid')}mediaPillarStartCall(e,t,a){this.$log.info('[WebrtcGatewayService] mediaPillarStartCall for phone number '+t),this.initiateMediaPillarCall(e).then(()=>{this.dummyRegisterMediaPillarCall().then(()=>{this.$log.info('[WebrtcGatewayService] mediaPillarMakeCall for number '+t),this.videoService.makeJingleCall(e,a,t)}).catch(()=>{this.$log.info('[WebrtcGatewayService] mediaPillarMakeCall ANOMALY dummyRegisterMediaPillarCall then abort call'),this.abortCall(e)})}).catch(()=>{this.$log.info('[WebrtcGatewayService] mediaPillarMakeCall ANOMALY initiateMediaPillarCall then abort call'),this.abortCall(e)})}abortCall(e){this.videoService.makingCall=!1,e&&this.videoService.removeCallObject(e),this.videoService.resetToSafeState()}initiateMediaPillarCall(e){return this.$q((t,a)=>{this.$log.info('[WebrtcGatewayService] initiateMediaPillarCall');var r=['audio'];this.videoService.getBrowserMedia(r).then((a)=>{e.isInitiator=!0,this.videoService.localStreams.push(a),this.videoService.calls[e.id]=e,e.localMedia|=this.Call.Media.AUDIO,this.contactService.setBusyState('dnd',this.videoService.calculatePresenceMessage(e)),this.$rootScope.$broadcast('ON_CALL_UPDATED_EVENT',e),t()}).catch((e)=>{this.$log.info('[WebrtcGatewayService]   | initate call failure : '+JSON.stringify({error:e.message})),0<=r.indexOf('sharing')||-1===e.toString().indexOf('getUserMedia')||this.videoService.openErrorPopup(),a(e)})})}dummyRegisterMediaPillarCall(){return this.$q((e,t)=>{var a=$iq({from:this.myContact.fullJid,to:this.mediaPillarCallContext.mediaPillarJid,type:'set'}).c('mediapillar',{xmlns:'urn:xmpp:janus:1'}).c('register').c('jidIm').t(this.contactService.userContact.jid).up().c('jidTel').t(this.contactService.userContact.jidtel).up().c('number').t(this.mediaPillarCallContext.rainbowPhoneNumber).up().c('displayName').t(this.myContact.displayName).up().c('secret').t(this.mediaPillarCallContext.rainbowPhoneNumber).up();this.xmppService.sendIQ(a).then(()=>{e()}).catch((e)=>{this.IsMediaPillarUserSelected()&&this.$log.warn('[WebrtcGatewayService] dummyRegisterMediaPillarCall -- register failure -- '+e.message),t(e)})})}getMediaPillarData(){return this.$q((e,t)=>{this.$http({method:'GET',url:this.portalURL+'/data',headers:this.authService.getRequestHeader()}).then((a)=>{if(this.$log.log('[WebrtcGatewayService] getMediaPillarData success'),a.data&&a.data.data){let t=a.data.data.prefix,r=a.data.data.rainbowPhoneNumber;t&&r&&(this.mediaPillarCallContext.rainbowPhoneNumber=r,this.mediaPillarCallContext.remoteExtension=t+r);let n=a.data.data.jid_im;n&&-1===n.indexOf('/')&&(n+='/mediapillar'),e(n)}else this.$log.error('[WebrtcGatewayService] getMediaPillarData success -- missing data'),t(new Error('[WebrtcGatewayService] getMediaPillarData -- missing data in response'))}).catch((e)=>{let a=this.errorHelperService.handleError(e);this.$log.info('[WebrtcGatewayService] getMediaPillarData error -- '+a.message),t(a)})})}mediaPillarKeepAlivePolling(e,t){this.started&&('START'===e?(this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&(this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null),this.mediaPillarCallContext.keepAlive_TO=this.$interval(()=>{this.mediaPillarKeepAlive()},t,1)):'STOP'===e?(this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null):this.$log.error('[WebrtcGatewayService] mediaPillarKeepAlivePolling cmd error : '+e))}mediaPillarUserSelectAndPolling(e){this.started&&(this.$log.log('[WebrtcGatewayService] mediaPillarUserSelectAndPolling : '+e),e?(this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING),this.mediaPillarKeepAlive()):this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling('STOP',0))}mediaPillarKeepAlive(){if(this.$log.info('[WebrtcGatewayService] mediaPillarKeepAlive'),!this.mediaPillarKeepAliveSuspend){let a=!1;this.dummyRegisterMediaPillarCall().then(()=>{a=!0,this.$log.info('[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is UP')}).catch(()=>{a=!1,this.$log.info('[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is DOWN')}).finally(()=>{this.mediaPillarAlive!==a&&(this.mediaPillarAlive=a,this.$rootScope.$broadcast('ON_WEBRTCGATEWAY_STATE_CHG',this.mediaPillarAlive),this.$log.info('[WebrtcGatewayService] mediaPillarKeepAlive ON_WEBRTCGATEWAY_STATE_CHG')),this.mediaPillarAlive?this.TO_PILLAR_POLLING<t?this.TO_PILLAR_POLLING+=t/500:this.TO_PILLAR_POLLING=t:(this.TO_PILLAR_POLLING=e,this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING)),this.IsMediaPillarUserSelected()&&this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING)})}else this.$log.info('[WebrtcGatewayService] KeepAlive suspended')}forceMPpooling(){this.started&&(this.$log.log('[WebrtcGatewayService] forceMPpooling '),this.TO_PILLAR_POLLING=e,this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING),this.$rootScope.$broadcast('ON_WEBRTCGATEWAY_STATE_CHG',this.mediaPillarAlive))}getMyMediaPillarJid(){return this.$log.info('[WebrtcGatewayService] getMyMediaPillarJid : '+this.mediaPillarCallContext.mediaPillarJid),this.mediaPillarCallContext.mediaPillarJid}getMyMediaPillarRemoteExtension(){return this.mediaPillarCallContext.remoteExtension}shouldUseMediaPillar(){var e=this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected();return'undefined'!=typeof config.devMediaPillarEnabled&&config.devMediaPillarEnabled||(e=!1),!1}isMediaPillarConfigured(){var e=this.mediaPillarConfigured&&this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING);return e}isMediaPillarAvailable(){var e=this.isMediaPillarConfigured();return e=e&&this.mediaPillarAlive,e}IsMediaPillarUserSelected(){var e=!this.telephonyService.nomadicObject.makeCallInitiatorIsMain&&this.telephonyService.getNomadicDestination()===this.getMyMediaPillarRemoteExtension();return e}isMediaPillarJid(e){let t=-1;return!!e&&(t=e.search('mp_'),0===t)}isMediaPillarCallCase(){var e=this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected();return e}isMediaPillarCallSituation(e){var t=this.isMediaPillarCallCase();if(e)if(e.type===this.Call.Type.WEBRTC)t=t&&this.isMediaPillarJid(e.fullJid);else if(1>=this.telephonyService.getCalls().length&&1>=this.mediaPillarCallContext.telephonyCallRefs.length)switch(e.status){case this.Call.Status.RINGING_INCOMMING:case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.QUEUED_INCOMMING:case this.Call.Status.DIALING:case this.Call.Status.RELEASING:break;default:t=!!e.mediaPillarCall&&t&&this.isInTelCallRefs(e);}else switch(e.status){case this.Call.Status.RINGING_INCOMMING:case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.QUEUED_INCOMMING:case this.Call.Status.DIALING:case this.Call.Status.RELEASING:break;default:e.mediaPillarCall?(t=t&&1<=e.mediaPillarCall.telephonyCallRefs.length,t=t&&this.isInTelCallRefs(e)):t=!1;}return t}mediaPillaryseTheCall(e,t){if(this.mediaPillarCallContext.callState!==a.Free){if(e&&this.mediaPillarCallContext.updateContactFlag)return this.$log.info('[WebrtcGatewayService] mediaPillaryseTheCall | only Update'),'Update';if(t&&this.mediaPillarCallContext.callState!==a.WaitWebrtc)return this.$log.info('[WebrtcGatewayService] mediaPillaryseTheCall | only Ignore'),'Ignore'}var r='';if(!e&&!t)return'NoCallRef';if(e&&t)return'toManyCallRef';if(e){switch(this.mediaPillarCallContext.callState){case a.Free:this.mediaPillarCallContext.callState=a.WaitWebrtc,r='Ok';break;case a.WaitTelephony:this.mediaPillarCallContext.callState=a.CallOffer,r='Ok';break;default:this.mediaPillarCallContext.callState=a.AnomalyCCS,r='Ano_inTel_contextCallState_'+this.mediaPillarCallContext.callState;}'Ok'==r&&(this.putAsMasterTelCallRefs(e),e.setMediaPillarCall(this.getMediaPillarCallContext()))}else if(t){switch(this.mediaPillarCallContext.webrtcCallRef=t,this.mediaPillarCallContext.callState){case a.Free:this.mediaPillarCallContext.callState=a.WaitTelephony,r='Ok';break;case a.WaitWebrtc:this.mediaPillarCallContext.callState=a.CallOffer,r='Ok';break;default:this.mediaPillarCallContext.callState=a.AnomalyCCS,r='Ano_inWrtc_contextCallState_'+this.mediaPillarCallContext.callState;}'Ok'==r&&t.setMediaPillarCall(this.getMediaPillarCallContext())}return r}getMediaPillarCallContext(){return this.mediaPillarCallContext}isMediaPillarOutgoingCall(){var e;switch(this.mediaPillarCallContext.callState){case a.WaitWebrtc:case a.WaitTelephony:case a.CallOffer:case a.CallOnGoing:case a.CallActive:case a.CallActiveNoWebMedia:case a.TelCallReleasing:case a.WebCallReleasing:e=!0;break;default:e=!1;}return e&&this.mediaPillarCallContext.isOutgoingCall3PCC}isMediaPillarReleasableCall(){var e;switch(this.mediaPillarCallContext.callState){case a.AnomalyCCS:case a.Unknow:e=!1;break;default:e=!0;}return e}MediaPillarReleaseWebrtcCall(){this.mediaPillarCallContext.webrtcCallRef&&(this.mediaPillarCallContext.webrtcCallRef.mediaPillarCall=null,this.videoService.releaseCall(this.mediaPillarCallContext.webrtcCallRef))}timeOutCallActiveNoWebMedia(){this.$log.info('[WebrtcGatewayService] timeOutCallActiveNoWebMedia'),this.mediaPillarCallContext.callState===a.CallActiveNoWebMedia&&(this.MediaPillarCallTerminator(),this.mediaPillarKeepAlive(),this.$log.info('[WebrtcGatewayService] timeOutCallActiveNoWebMedia noWebMedia then release calls if existing & force keepalive'))}MediaPillarCallTerminator(){0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs.forEach((e)=>{null!==e&&e.type.value===this.Call.Type.PHONE.value&&(e.mediaPillarCall=null,this.telephonyService.releaseCall(e),this.$log.info('[WebrtcGatewayService] MediaPillarCallTerminator | release call'+e))}),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext(),this.resetEvtAutomaton(),this.TO_PILLAR_POLLING+=e,this.mediaPillarKeepAlivePolling('START',this.TO_PILLAR_POLLING),this.$log.warn('[WebrtcGatewayService] MediaPillarCallTerminator | Full cleaning')}createMediaPillarContact(e){this.$log.info('[webrtcGatewayService] createMediaPillarContact -- '+e);let t=this.contactService.createBasicContact(e);return t.displayName='mediaPillar',t.avatar=new Image,t.avatar.src='/resources/skins/rainbow/images/conversations/unknownContact.png',t}muteAudio(e,t,a){if(!e)return void this.$log.error('[webrtcGatewayService] muteAudio - trying to mute a non existing call !');if(this.isMediaPillarCallSituation(e)){let n=this.mediaPillarCallContext.webrtcCallRef;if(n){var r=this.xmppService.connection.jingle.sessions[n.id];if(r){r.muteAudio(t),e.isMuted=t,a&&(a.isMutedAudio=t),this.$log.info('[webrtcGatewayService] muteAudio conversation: '+(a?a.id:'undefined')+' / call: '+e.id+'-- '+(t?'mute':'unumute'));let n={call:e};a&&(n.conversation=a),this.$rootScope.$broadcast('ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT',n)}else this.$log.error('[webrtcGatewayService] muteAudio '+e.id+' -- failure: no session')}}}getActivePbxCall(){if(this.isMediaPillarCallCase()&&this.mediaPillarCallContext){var e=this.mediaPillarCallContext.telephonyCallRefs.find((e)=>e.status===this.Call.Status.ACTIVE);return e}return null}}r.$inject=['$q','$rootScope','$log','$http','authService','$interval','xmppService','videoService','errorHelperService','contactService','profileService','Call','uuid4','telephonyService','settingsService'],angular.module('rainbow').service('webrtcGatewayService',r)},function(){angular.module('rainbow').service('callLogService',['$q','$log','$rootScope','$interval','contactService','xmppService','CallLog','orderByFilter','profileService','$injector','telephonyService','webrtcGatewayService',function(e,t,a,r,n,o,i,s,d,c,l,p){'use strict';var u=this;this.started=!1,this.callLogs=[],this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.callLogsPromises=[],this.callLogNamespace='jabber:iq:telephony:call_log',this.callLogAckNamespace='urn:xmpp:telephony:call_log:receipts',this.callLogNotificationsNamespace='jabber:iq:notification:telephony:call_log',this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.callLogNotificationRef=null,this.numberMissedCalls=0,this.lastTimestamp=null,this.callLogsHistory=[],this.telephonyCallLog={},this.telephonyCallLogHistory={},this.deferedObject=null,this.callLogComplete=!1,this.callLogIndex=-1,this.start=function(a){return t.info(''),t.info('[callLogService] === STARTING ==='),this.attachHandlers(),r(function(){var e=performance.now();u.getCallLogHistoryPage().then(function(){var r=Math.round(performance.now()-e);a.push({service:'callLogService',startDuration:r}),t.info('[callLogService] === STARTED ('+r+' ms) ==='),u.started=!0}).catch(function(){t.error('[callLogService] === STARTING FAILURE ===')})},3e3,1,!0),e.when()},this.stop=function(){return t.info('[callLogService] Stopping'),this.started=!1,this.callLogs=[],this.callLogsPromises=[],this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.numberMissedCalls=0,this.lastTimestamp=null,this.telephonyCallLog={},this.telephonyCallLogHistory={},this.callLogComplete=!1,this.callLogIndex=-1,this.callLogsHistory=[],t.info('[callLogService] Stopped'),e.when()},this.attachHandlers=function(){t.info('[callLogService] attachHandlers'),u.callLogHandlerRef&&(o.connection.deleteHandler(u.callLogHandlerRef),u.callLogHandlerRef=null),u.callLogMessageAckRef&&(o.connection.deleteHandler(u.callLogMessageAckRef),u.callLogMessageAckRef=null),u.callLogNotificationRef&&(o.connection.deleteHandler(u.callLogNotificationRef),u.callLogNotificationRef=null),u.callLogHandlerRef=o.connection.addHandler(u.onCallLogMessageReceived,u.callLogNamespace,null,null),u.callLogMessageAckRef=o.connection.addHandler(u.onCallLogAckReceived,u.callLogAckNamespace,null,null),u.callLogNotificationRef=o.connection.addHandler(u.callLogNotificationReceived,u.callLogNotificationsNamespace,null,null),u.started&&u.lastTimestamp&&r(function(){u.getCallLogHistoryPage(u.lastTimestamp)},1e3,1,!0)},this.getCallLogHistoryPage=function(a){t.info('[callLogService] getCallLogHistoryPage');var r=n.userContact,i=$iq({from:r.jid,type:'set'}),s=i.c('query',{xmlns:this.callLogNamespace});return s.c('set',{xmlns:'http://jabber.org/protocol/rsm'}),s.c('max').t(75).up(),a?s.c('after').t(a).up():s.c('before').t('').up(),s.up(),s.up(),o.sendIQ(s),e.when()},this.deleteOneCallLog=function(e){t.info('[callLogService] deleteOneCallLog '+e);var a=n.userContact,r=$iq({from:a.jid,to:a.jid,type:'set'}),i=r.c('delete',{xmlns:this.callLogNamespace,call_id:e});o.sendIQ(i)},this.deleteCallLogsForContact=function(e){t.info('[callLogService] deleteCallLogsForContact '+e);var a=n.userContact,r=$iq({from:a.jid,to:a.jid,type:'set'}),i=r.c('delete',{xmlns:this.callLogNamespace,peer:e});o.sendIQ(i)},this.deleteAllCallLogs=function(){t.info('[callLogService] deleteAllCallLogs');var e=n.userContact,a=$iq({from:e.jid,to:e.jid,type:'set'}),r=a.c('delete',{xmlns:this.callLogNamespace});o.sendIQ(r)},this.markCallLogAsRead=function(e){t.info('[callLogService] markCallLogAsRead '+e);var a=n.userContact,r=$msg({from:a.jid,to:a.jid}),i=r.c('read',{xmlns:this.callLogAckNamespace,call_id:e});o.sendIQ(i)},this.markAllCallsLogsAsRead=function(){t.info('[callLogService] markAllCallsLogsAsRead ');for(var e=n.userContact,a=0;a<u.callLogs.length;a++)if(!u.callLogs[a].read){var r=$msg({from:e.jid,to:e.jid}),i=r.c('read',{xmlns:this.callLogAckNamespace,call_id:u.callLogs[a].id});o.sendIQ(i)}},this.onCallLogMessageReceived=function(r){try{0<$(r).find('call_log').length?u.callLogsPromises.push(u.createCallLogFromMessage(r)):0<$(r).find('count').length&&0<$(r).find('query').length?(u.lastTimestamp=$(r).find('last').text(),t.info('[callLogService] onCallLogMessageReceived : all call logs received'),e.all(u.callLogsPromises).finally(function(){t.info('[callLogService] onCallLogMessageReceived : all call logs are ready'),u.callLogsPromises=[],u.orderCallLogsFunction(),a.$broadcast('ON_CALL_LOG_UPDATED');var e=u.getMissedCallLogCounter();e!==u.numberMissedCalls&&(u.numberMissedCalls=e,a.$broadcast('ON_CALL_LOG_ACK_UPDATED'))})):t.info('[callLogService] onCallLogMessageReceived : ignored !')}catch(e){return t.error('[callLogService] onCallLogMessageReceived '+e),!0}return!0},this.onCallLogAckReceived=function(e){try{if(t.info('[callLogService] onCallLogAckReceived'),0<$(e).find('read').length){var r=$(e).find('read').attr('call_id');u.callLogAckUpdate(r);var n=u.getMissedCallLogCounter();n!==u.numberMissedCalls&&(u.numberMissedCalls=n,a.$broadcast('ON_CALL_LOG_ACK_UPDATED'))}}catch(e){return t.error('[callLogService] onCallLogAckReceived '+e),!0}return!0},this.callLogNotificationReceived=function(r){t.info('[callLogService] callLogNotificationReceived');try{if(0<$(r).find('deleted_call_log').length){t.info('[callLogService] callLogNotificationReceived : deleted IQ');var n=$(r).find('deleted_call_log').attr('peer');n?u.removeCallLogsForUser(n):u.resetCallLogs()}else 0<$(r).find('updated_call_log').length&&(t.info('[callLogService] callLogNotificationReceived : Update call-logs'),u.callLogsPromises.push(u.createCallLogFromMessage(r)),e.all(u.callLogsPromises).finally(function(){t.info('[callLogService] callLogNotificationReceived : update is done'),u.callLogsPromises=[],u.orderCallLogsFunction(),a.$broadcast('ON_CALL_LOG_UPDATED');var e=u.getMissedCallLogCounter();e!==u.numberMissedCalls&&(u.numberMissedCalls=e,a.$broadcast('ON_CALL_LOG_ACK_UPDATED'))}))}catch(e){return t.error('[callLogService] callLogNotificationReceived ERROR '+e),!0}return!0},this.removeCallLogsForUser=function(e){e.endsWith('@_')&&(e=e.substring(0,e.length-2)),t.info('[callLogService] removeCallLogsForUser with jid: '+e);for(var r=[],n=0;n<u.callLogs.length;n++)u.callLogs[n].contact&&(u.callLogs[n].contact.jid===e||u.callLogs[n].contact.id===e)||r.push(u.callLogs[n]);u.callLogs=r,u.orderCallLogsFunction(),a.$broadcast('ON_CALL_LOG_UPDATED');var o=u.getMissedCallLogCounter();o!==u.numberMissedCalls&&(u.numberMissedCalls=o,a.$broadcast('ON_CALL_LOG_ACK_UPDATED'))},this.createCallLogFromMessage=function(a){var r=e.defer(),o=$(a),s=null,m=null,g='',v=o.find('call_id').text(),f=o.find('caller').text(),S=o.find('callee').text(),C=o.find('state').text(),h=parseInt(o.find('duration').text(),10),E=o.find('subject').text(),R='',b='',y='',T='webrtc';if(f&&-1!==f.indexOf('janusgateway')||S&&-1!==S.indexOf('janusgateway'))return t.info('[callLogService] createCallLogFromMessage ignore janusgateway call-logs'),void e.when();if(f&&p.isMediaPillarJid(f)||S&&p.isMediaPillarJid(S))return t.info('[callLogService] createCallLogFromMessage ignore janusgateway call-logs'),void e.when();var I=o.find('call_log').attr('type');I||(I=o.find('type').text());var N='true'===o.find('ack').attr('read'),A=o.find('delay').attr('stamp'),O='conference'===o.find('call_log').attr('service');return(d.isFeatureEnabled(d.FeaturesEnum.TELEPHONY_PHONE_BOOK)||config.permitSearchFromPhoneBook)&&(R=o.find('identity')),h=0<h?moment.duration(h,'ms').format('h[H] mm[m] ss[s]'):0,A&&(A=new Date(A)),O?(s=f,T='conference',g=n.isUserContactJid(f)?'outgoing':'incoming',-1===s.indexOf('@')&&(m=s,s=null)):('phone'===I&&(T='telephone'),n.isUserContactJid(f)?(s=S,g='outgoing'):(s=f,g='incoming'),-1===s.indexOf('@')&&(m=s,s=null,T='telephone')),s||m?n.getOrCreateContact(s,m).then(function(e){if(t.info('[callLogService] createCallLogFromMessage otherParticipant jid:'+s+'  Number:'+m+' => contact retrieved (temp:'+e.temp+')'),!O&&!s&&e.temp){if(R&&R.length){var a=R.attr('firstName'),n=R.attr('lastName'),o=R.attr('displayName');b=a?a:'',y=n?n:'',''===y&&''===b&&o&&0!==o.length&&o!==m&&(y=o),(b.length||y.length)&&(t.debug('[callLogService] createCallLogFromMessage  xNames updated from directories for contact '+e.id),e.updateName(b,y))}else try{var d=c.get('centralizedService');d.outlook.updateContactFromOutlookInfos(e,m,!0).then(function(a){a?t.debug('[callLogService] createCallLogFromMessage  xNames updated from outlook for contact '+e.id):t.debug('[callLogService] createCallLogFromMessage no update from outlook for contact :'+e.id)},function(){t.debug('[callLogService] createCallLogFromMessage  no Outlook search available')})}catch(e){}var p=!1,f=/^[0-9A-D #\-\+\*\(\)\./]{1,32}$/;if(l.started){var S=e.displayName.match(f);p=S&&l.startAsPhoneNumber(e.displayName)}p&&e.phoneProCan&&''!==e.phoneProCan&&(e.displayName=e.phoneProCan)}var I=i.create(v,e,C,h,T,N,A,g,E);u.logAlreadyExists(I)||'failed'===C||'ongoing'===C?t.info('[callLogService] createCallLogFromMessage ignore call log with id: '+v+', state: '+C):u.callLogs.push(I),t.info('[callLogService] createCallLogFromMessage success'),r.resolve(I)}).catch(function(e){t.error('[callLogService] createCallLogFromMessage error '+e),r.resolve()}):(t.info('[callLogService] createCallLogFromMessage  No jid or no phoneNumber '),r.resolve()),r.promise},this.getOrderByNameCallLogs=function(){return u.orderByNameCallLogs},this.getOrderByDateCallLogs=function(){return 0!==u.orderByDateCallLogs.length&&(u.orderByDateCallLogs[0].isLatestCall=!0,u.orderByDateCallLogs[1]&&(u.orderByDateCallLogs[1].isLatestCall=!1)),u.orderByDateCallLogs},this.getOrderByDateCallLogsBruts=function(){return u.orderByDateCallLogsBruts},this.getSimplifiedCallLogs=function(){return u.simplifiedCallLogs},this.orderCallLogsFunction=function(){t.info('[callLogService] orderByFunction'),u.orderByNameCallLogs=s(u.callLogs,i.getNames,!1,i.sortByContact),u.orderByDateCallLogsBruts=s(u.callLogs,i.getDate,!1,i.sortByDate),u.simplifiedCallLogs=u.simplifyCallLogs(u.orderByDateCallLogsBruts),u.orderByNameCallLogs=u.fusionInformation(u.orderByNameCallLogs),u.orderByDateCallLogs=u.fusionInformation(u.orderByDateCallLogsBruts)},this.simplifyCallLogs=function(e){for(var t=[],a=0;a<e.length;a++)t[a]={},t[a].contact=e[a].contact.id,t[a].contactDisplayName=e[a].contact.displayName,t[a].contactInitials=e[a].contact.initials,t[a].id=e[a].id,t[a].state=e[a].state,t[a].duration=e[a].duration,t[a].direction=e[a].direction,t[a].type=e[a].type,t[a].read=e[a].read,t[a].date=e[a].date;return t},this.fusionInformation=function(e){for(var t={},a=0,r=[],n=0;n<e.length;n++){var o=e[n],i=o.contact.jid;if(o.contact.jid||(i=o.contact.id),'conference'===o.type){0!==n&&a++,r[a]=o,r[a].count=1,r[a].editable=!1;continue}if(0===n){t[i]=1,r[a]=o,r[a].count=1,r[a].editable=!0,'missed'===o.state&&'incoming'===o.direction?r[a].isMissed=!0:'missed'===o.state&&'outgoing'===o.direction&&(r[a].isNotAnswered=!0);continue}if(t[i]){var s=t[i],d=r[s-1];d.editable&&(d.isMissed&&'missed'===o.state&&'incoming'===o.direction?d.count++:d.isNotAnswered&&'missed'===o.state&&'outgoing'===o.direction?d.count++:d.editable=!1)}else{a++,t[i]=a+1,r[a]=o,r[a].count=1,r[a].editable=!0,'missed'===o.state&&'incoming'===o.direction?r[a].isMissed=!0:'missed'===o.state&&'outgoing'===o.direction&&(r[a].isNotAnswered=!0);continue}}return r},this.callLogAckUpdate=function(e){u.callLogs.forEach(function(t){if(t.id===e)return void(t.read=!0)})},this.getMissedCallLogCounter=function(){var e=0;return u.callLogs.forEach(function(t){t.read||'missed'!==t.state||'incoming'!==t.direction||e++}),e},this.getNumberMissedCalls=function(){return u.numberMissedCalls},this.resetCallLogs=function(){t.info('[callLogService] resetCallLogs'),u.callLogs=[],u.getCallLogHistoryPage()},this.logAlreadyExists=function(e){var t;for(t=0;t<u.callLogs.length;t++)if(u.callLogs[t].id===e.id)return!0;return!1}}])},function(){angular.module('rainbow').service('videoService',['$q','$rootScope','$window','$log','$http','$interval','xmppService','contactService','Call','browserService','gRTCStatsService','fRTCStatsService','platformService','gaService','settingsService','authService','VideoServiceEventHandler','extensionSharingService',function(e,t,a,r,n,o,s,d,c,i,l,p,u,m,g,v,f,S){'use strict';var C=this;this.started=!1,this.connected=!1,this.RTC=null,this.videoEventHandler=null,this.config=null,this.calls={},this.localStream=null,this.autoreleaseTimeout=null,this.callsStats={},this.localStreams=[],this.makingCall=!1,this.reconnectCall=!1,this.statsInterval=null,this.audioProfileChanging=!1,this.reverseAudioCallInitiated=!1,this.alreadyAttaching=!1;var h=[];this.callsStatsSimplified={},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.getDesktopSharingSource=function(){return null},this.askToAddSharing=function(){return!1},this.askToStartSharing=function(){return!1},this.start=function(a){r.webrtc('[videoService] SERVICE | === STARTING ===');var n=performance.now();if(this.RTC=C.getBrowserMethodHandler(),!this.RTC)r.error('[videoService] SERVICE | === STARTING FAILURE ===  webRTC capable browser is really required !');else{C.started=!0,C.connected=!0,C.setWebrtcConfiguration();var o=Math.round(performance.now()-n);a.push({service:'videoService',startDuration:o}),r.info('[videoService] SERVICE | === STARTED ('+o+' ms) ===')}return h.push(t.$on('ON_CONNECTION_STATE_CHANGE_EVENT',C.onConnectionStateChangeEvent)),h.push(t.$on('ON_INPUT_DEVICE_CHANGED_EVENT',C.onAudioProfileChangeEvent)),h.push(t.$on('ON_VIDEO_INPUT_DEVICE_CHANGED_EVENT',C.onVideoInputChangeEvent)),this.attachHandlers(),e.when()},this.stop=function(){try{if(this.started){r.webrtc('[videoService] SERVICE | === STOPPING ==='),this.started=!1;for(var t;t=h.pop();)t();for(var a in C.removeHandlers(),C.config=null,C.calls)if(C.calls.hasOwnProperty(a)){var n=C.calls[a];C.removeCallObject(n)}s.connection.jingle.terminate(),C.connected=!1,C.reconnectCall=!1,C.makingCall=!1,C.statsInterval&&window.clearInterval(C.statsInterval),r.webrtc('SERVICE | === STOPPED ===')}return e.when()}catch(t){return r.webrtc('[videoService] SERVICE | === STOPPING ERROR : '+t),e.when()}},this.attachHandlers=function(){this.removeHandlers(),r.info('[videoService] attachHandlers'),this.videoEventHandler=f.create(this)},this.removeHandlers=function(){r.info('[videoService] removeHandlers'),this.videoEventHandler&&(this.videoEventHandler=null)},this.setWebrtcConfiguration=function(){return r.webrtc('[videoService] setWebrtcConfiguration'),e(function(e,t){C.config?(r.webrtc('[videoService] setWebrtcConfiguration from stored variable'),adapter&&adapter.default&&'chrome'===adapter.default.browserDetails.browser&&70<=adapter.default.browserDetails.version&&(r.info('[VideoService] Plan-b activated'),C.config.sdpSemantics='plan-b'),s.connection.jingle.ice_config=C.config,e()):(r.webrtc('[videoService] setWebrtcConfiguration from server'),C.getIceConfig().then(function(t){C.config=t,adapter&&adapter.default&&'chrome'===adapter.default.browserDetails.browser&&70<=adapter.default.browserDetails.version&&(r.info('[VideoService] Plan-b activated'),C.config.sdpSemantics='plan-b'),s.connection.jingle.ice_config=C.config,g.setIceConfig(C.config),r.webrtc('[videoService] setWebrtcConfiguration from server success !'),e()}).catch(function(e){r.error('[videoService] setWebrtcConfiguration from server ERROR : '+e),-1!==e.status&&C.openErrorPopup('IceConfigurationFailed'),t()}))})},this.onConnectionStateChangeEvent=function(e,a){try{if('disconnected'===a){for(var n in r.info('MEDIA   | onConnectionStateChangeEvent : disconnected'),C.connected=!1,C.config=null,C.calls)if(C.calls.hasOwnProperty(n)){var o=C.calls[n];C.reconnectCall=!0,o&&o.status!==c.Status.UNKNOWN&&(r.webrtc('INFO    | onConnectionStateChangeEvent : disconnected -> call goes to connecting state'),o.setStatus(c.Status.CONNECTING),t.$broadcast('ON_CALL_UPDATED_EVENT',o)),C.statsInterval&&window.clearInterval(C.statsInterval)}}else if('connected'===a){for(var n in r.info('MEDIA   | onConnectionStateChangeEvent : connected'),C.attachHandlers(),C.setWebrtcConfiguration(),C.connected=!0,C.statsInterval&&(window.clearInterval(C.statsInterval),C.statsinterval=null),C.calls)if(C.calls.hasOwnProperty(n)){var o=C.calls[n],i=s.connection.jingle.sessions[o.id];C.reconnectCall&&i&&i.peerconnection&&(r.info('MEDIA   | onConnectionStateChangeEvent : connected - start reconnection on session '+o.id),i.me=d.userContact.fullJid,i.isInitiator&&(i.initiator=i.me),i.connection=s.connection,d.setBusyState('dnd',C.calculatePresenceMessage(o)),i.sendTransportReplace())}C.reconnectCall=!1}}catch(e){r.info('MEDIA   | onConnectionStateChangeEvent : disconnected error : '+e)}},C.isUserContactInCall=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];if(t.status!==c.Status.UNKNOWN)return!0}return!1},this.getCurrentActiveSession=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];if(t.status!==c.Status.UNKNOWN)return s.connection.jingle.sessions[t.id]}return null},C.getMediaPillarAudioCall=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];if(t.status!==c.Status.UNKNOWN&&t.localMedia&c.Media.AUDIO&&t.isMediaPillarCall())return t}return null},C.getMediaPillarSession=function(){var e=C.getMediaPillarAudioCall();return e?s.connection.jingle.sessions[e.id]:null},C.getCurrentSharingCall=function(){for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e];if(t.status!==c.Status.UNKNOWN&&(t.localMedia===c.Media.SHARING||t.remoteMedia===c.Media.SHARING))return t}return null},C.endAllCallsForContact=function(e){if(e)for(var t in r.webrtc('[videoService] endAllCallsForContact '+e.jid),C.calls)if(C.calls.hasOwnProperty(t)){var a=C.calls[t];a.status!==c.Status.UNKNOWN&&a.contact&&a.contact.jid===e.jid&&C.releaseCall(a)}},C.onVideoInputChangeEvent=function(){for(var e in r.webrtc('MEDIA   | onVideoInputChangeEvent'),C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e],a=s.connection.jingle.sessions[t.id];a&&t.localMedia&&t.localMedia===c.Media.AUDIO+c.Media.VIDEO&&(r.webrtc('MEDIA   | audio + video call, renegotiate the profile'),C.escalateToVideoCall(t,!0))}},C.onAudioProfileChangeEvent=function(){if(r.webrtc('MEDIA   | onAudioProfileChangeEvent'),C.audioProfileChanging)return void r.webrtc('MEDIA   | onAudioProfileChangeEvent -- already changing');for(var e in C.calls)if(C.calls.hasOwnProperty(e)){var t=C.calls[e],a=s.connection.jingle.sessions[t.id];a&&t.localMedia&&(C.audioProfileChanging=!0,o(function(e){C.audioProfileChanging=!1,C.renegotiateCurrentCall(e)},500,1,!0,t))}},this.renegotiateCurrentCall=function(e){e.localMedia===c.Media.AUDIO||e.localMedia===c.Media.AUDIO+c.Media.SHARING?(r.webrtc('MEDIA   | renegotiate the audio profile'),C.addAudioToCall(e,!0)):(e.localMedia===c.Media.AUDIO+c.Media.VIDEO||e.localMedia===c.Media.AUDIO+c.Media.SHARING+c.Media.VIDEO)&&(r.webrtc('MEDIA   | audio + video call, renegotiate the profile'),C.addVideoToCall(e,!0))},this.getCallByJid=function(e){var t=null;if(!e)return t;for(var a in r.webrtc('[videoService] getCallByJid '+e),C.calls)if(C.calls.hasOwnProperty(a)){var n=C.calls[a];if(n.contact&&n.contact.jid===e){t=n;break}}return t},this.resetAudioOutputElement=function(){return!u.allowDevicesManagement()||this.audioProfileChanging?void 0:$('#globalAudioTag').length?void(r.webrtc('[videoService] resetAudioOutputElement'),this.audioProfileChanging=!0,u.getCurrentSpeaker().then(function(e){var t='default';e&&e.id&&(t=e.id);var a='default';'default'!==t&&DetectRTC.audioOutputDevices.forEach(function(e){'default'!==e.deviceId&&'communications'!==e.deviceId&&e.deviceId!==t&&(a=e.deviceId)}),$('#globalAudioTag')[0].setSinkId(a).then(function(){r.webrtc('[videoService] resetAudioOutputElement sinkId is '+$('#globalAudioTag')[0].sinkId),'default'===t?C.audioProfileChanging=!1:$('#globalAudioTag')[0].setSinkId(t).then(function(){r.webrtc('[videoService] resetAudioOutputElement sinkId is '+$('#globalAudioTag')[0].sinkId),C.audioProfileChanging=!1,$('#globalAudioTag')[0].load&&$('#globalAudioTag')[0].load()}).catch(function(){C.audioProfileChanging=!1})}).catch(function(e){r.warn('[videoService] resetAudioOutputElement globalAudioTag error '+e),C.audioProfileChanging=!1}),o(function(){$('#largevideo')[0]&&$('#largevideo')[0].setSinkId(a).then(function(){r.webrtc('[videoService] resetAudioOutputElement largevideo '+$('#largevideo')[0].sinkId),'default'!==t&&$('#largevideo')[0].setSinkId(t).then(function(){r.webrtc('[videoService] resetAudioOutputElement largevideo '+$('#largevideo')[0].sinkId)}).catch(function(e){r.warn('[videoService] resetAudioOutputElement largevideo error '+e)})}).catch(function(e){r.warn('[videoService] resetAudioOutputElement largevideo error '+e)}),$('#p2pSecondVideo')[0]&&$('#p2pSecondVideo')[0].setSinkId(a).then(function(){'default'!==t&&$('#p2pSecondVideo')[0].setSinkId(t).then(function(){r.webrtc('[videoService] resetAudioOutputElement p2pSecondVideo '+$('#p2pSecondVideo')[0].sinkId)}).catch(function(e){r.warn('[videoService] resetAudioOutputElement p2pSecondVideo error '+e)})}).catch(function(e){r.warn('[videoService] resetAudioOutputElement p2pSecondVideo error '+e)})},3e3,1)}).catch(function(){r.webrtc('[videoService] resetAudioOutputElement getCurrentSpeaker error'),C.audioProfileChanging=!1})):void r.warn('[videoService] resetAudioOutputElement -- missing global audio tag !')},this.disableAudioVideoMedia=function(e,t){if(e?r.webrtc('MEDIA   | disableAudioVideoMedia for session '+JSON.stringify({sid:e.sid})):t?r.webrtc('MEDIA   | disableAudioVideoMedia no session, sessionId: '+t):r.webrtc('MEDIA   | disableAudioVideoMedia no session, no session Id'),!e&&!t){var a=C.localStreams.length;if(0<C.localStreams.length)for(C.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null});0<C.localStreams.length;){var n=C.localStreams.pop();n=null}r.webrtc('MEDIA   | disableAudioVideoMedia : All local streams stopped and removed: '+a)}if(e){if(0<e.localStreams.length){var o=e.localStreams.length;for(e.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null}),C.localStreams=C.localStreams.filter(function(t){return!e.localStreams.includes(t)});0<e.localStreams.length;){var n=e.localStreams.pop();n=null}r.webrtc('MEDIA   | disableAudioVideoMedia : Session streams stopped and removed: '+o+'. Remaining local streams: '+C.localStreams.length)}}else if(t){var i=C.localStreams.filter(function(e){return e.callId===t});if(i){var o=i.length;i.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),C.localStreams.splice(C.localStreams.indexOf(e),1),e=null}),r.webrtc('MEDIA   | disableAudioVideoMedia : Locals streams for sessionId '+t+' stopped and removed: '+o+'. Remaining local streams: '+C.localStreams.length)}}C.statsInterval&&(window.clearInterval(C.statsInterval),C.statsinterval=null)},this.attachDistantMediaStreams=function(e,t){if(e){if(C.alreadyAttaching)return;C.alreadyAttaching=!0;var a=s.connection.jingle.sessions[t.id];if(a.remoteStreams){if(1<a.remoteStreams.length){var n,o;a.remoteStreams[0].getAudioTracks().length?(o=a.remoteStreams[0],n=a.remoteStreams[1]):(n=a.remoteStreams[0],o=a.remoteStreams[1]),0<n.getVideoTracks().length&&(r.webrtc('attachDistantMediaStreams video track for element largevideo '+n.id),C.RTC.attachMediaStreamIfNeeded(angular.element('#largevideo'),n,n.id),angular.element('#largevideo')[0]&&(angular.element('#largevideo')[0].muted=!0,angular.element('#largevideo')[0].volume=0)),0<n.getAudioTracks().length&&(r.webrtc('attachDistantMediaStreams audio track for element globalAudioTag '+n.id),C.RTC.attachMediaStream(angular.element('#globalAudioTag'),n)),0<o.getVideoTracks().length&&(r.webrtc('attachDistantMediaStreams video track for element p2pSecondVideo '+o.id),C.RTC.attachMediaStreamIfNeeded(angular.element('#p2pSecondVideo'),o,o.id),angular.element('#p2pSecondVideo')[0]&&(angular.element('#p2pSecondVideo')[0].muted=!0,angular.element('#p2pSecondVideo')[0].volume=0)),0<o.getAudioTracks().length&&(r.webrtc('attachDistantMediaStreams audio track for element globalAudioTag '+o.id),C.RTC.attachMediaStream(angular.element('#globalAudioTag'),o))}else a.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&(r.webrtc('attachDistantMediaStreams video track'),C.RTC.attachMediaStreamIfNeeded(angular.element('#largevideo'),e,e.id),angular.element('#largevideo')[0]&&(angular.element('#largevideo')[0].muted=!0,angular.element('#largevideo')[0].volume=0),C.RTC.attachMediaStreamIfNeeded(angular.element('#p2pSecondVideo'),e,e.id),angular.element('#p2pSecondVideo')[0]&&(angular.element('#p2pSecondVideo')[0].muted=!0,angular.element('#p2pSecondVideo')[0].volume=0)),0<e.getAudioTracks().length&&(r.webrtc('attachDistantMediaStreams audio track'),C.RTC.attachMediaStream(angular.element('#globalAudioTag'),e))});C.alreadyAttaching=!1}}else C.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element('#largevideo'),null),this.RTC.clearMediaStream(angular.element('#globalVideoTag'),null),this.RTC.clearMediaStream(angular.element('#globalAudioTag'),null))},this.attachLocalMediaStreams=function(e){if(r.webrtc('attachLocalMediaStreams '+e),e){if(this.localStreams&&this.localStreams.length){var t=!1;this.localStreams.forEach(function(e){e.getVideoTracks().length&&e.getAudioTracks().length?(t?C.RTC.attachMediaStreamIfNeeded($('#minivideo2'),e,e.id):(t=!0,C.RTC.attachMediaStreamIfNeeded($('#minivideo'),e,e.id)),C.RTC.attachMediaStreamIfNeeded($('#callVideoPip'),e,e.id)):e.getVideoTracks().length&&(t?C.RTC.attachMediaStreamIfNeeded($('#minivideo2'),e,e.id):(t=!0,C.RTC.attachMediaStreamIfNeeded($('#minivideo'),e,e.id)),C.RTC.attachMediaStreamIfNeeded($('#callSharingPip'),e,e.id))})}$('#callVideoPip')[0]&&($('#callVideoPip')[0].volume=0),$('#minivideo')[0]&&($('#minivideo')[0].volume=0),$('#minivideo2')[0]&&($('#minivideo2')[0].volume=0),$('#callSharingPip')[0]&&($('#callSharingPip')[0].volume=0)}else this.RTC.clearMediaStream($('#minivideo'),null),this.RTC.clearMediaStream($('#minivideo2'),null),this.RTC.clearMediaStream($('#callVideoPip'),null),this.RTC.clearMediaStream($('#callSharingPip'),null)},this.pushInLocalStreams=function(e,t){e.callId=t,C.localStreams.push(e)},this.openErrorPopup=function(e){e||(e='cameraNotAvailable'),t.$broadcast('ON_WEBRTC_CALL_ERROR_EVENT',e)},this.openCalendarBusyPopup=function(e){t.$broadcast('ON_WEBRTC_CALENDAR_BUSY_EVENT',e)},this.makeVideoCall=function(e){C.makeCall(e,'videoOnly')},this.makeCall=function(e,t,a){return r.webrtc('MEDIA   | makeCall to '+JSON.stringify({displayName:e.displayNameForLog(),resources:e.resources})),C.makingCall?void r.info('MEDIA   | makeCall already making a call !'):void(C.makingCall=!0,this.videoEventHandler.sendProposition(e,t,a))},this.makeJingleCall=function(e,a,n){r.webrtc('MEDIA   | makeJingleCall'),C.setWebrtcConfiguration().then(function(){var o='';e.localMedia&c.Media.AUDIO&&(o='audio'),e.localMedia&c.Media.VIDEO&&(o=o?'audio+video':'video'),a&&''!==a&&r.webrtc('MEDIA   | makeJingleCall in mediaPillar case for number : '+n),a&&''!==a&&n&&''!==n?(o='sip',s.connection.jingle.initiate(a,s.connection.jid,o,C.localStreams,e.id,null,n)):s.connection.jingle.initiate(e.fullJid,s.connection.jid,o,C.localStreams,e.id),e.status=c.Status.CONNECTING,t.$broadcast('ON_CALL_UPDATED_EVENT',e)}).catch(function(t){r.webrtc('MEDIA   | makeCall failure : '+JSON.stringify({error:t.message})),C.makingCall=!1,e&&C.removeCallObject(e),C.resetToSafeState()})},this.makeJingleSharingCall=function(e){r.webrtc('MEDIA   | makeJingleSharingCall - make desktop sharing call');var a='sharing';e.localMedia===c.Media.SHARING&&(a='sharing-only'),C.setWebrtcConfiguration().then(function(){r.webrtc('SHARING | getUserMedia success');var n=C.getMediaPillarSession(),o=n?C.localStreams.filter(function(e){return!(n.localStreams&&n.localStreams.includes(e))}):C.localStreams;s.connection.jingle.initiate(e.fullJid,s.connection.jid,a,o,e.id),e.status=c.Status.CONNECTING,t.$broadcast('ON_CALL_UPDATED_EVENT',e)}).catch(function(t){C.makingCall=!1,e&&C.removeCallObject(e),C.resetToSafeState(),r.webrtc('MEDIA   | makeJingleSharingCall failure : '+JSON.stringify({error:t.message}))})},this.startDesktopSharing=function(e,t){if(C.makingCall)return void r.info('MEDIA   | startDesktopSharing already making a call !');C.makingCall=!0;var a=!C.askToStartSharing(e.jid,t);a&&C.makeDesktopSharingCall(e,t)},this.startSharingCancelled=function(){C.makingCall=!1},this.makeDesktopSharingCall=function(e,t){t||(t='sharing'),r.webrtc('MEDIA   | makeDesktopSharingCall - trying to start a desktop sharing call with media '+t),this.videoEventHandler.sendProposition(e,t)},this.answerJingleCall=function(e){r.webrtc('MEDIA   | answerJingleCall '+e.id);var a=[],n='audio';e.localMedia&c.Media.AUDIO&&a.push('audio'),e.localMedia&c.Media.VIDEO&&(a.push('video'),n='audio+video'),e.localMedia===c.Media.VIDEO&&(n='video');var o={};e.isInConversationWithMobile()&&(o=C.getMobileMediaConstraints('video')),C.setWebrtcConfiguration().then(function(){C.getBrowserMedia(a,o.fixedVideoWidth,o.fixedVideoHeight,o.fixedFrameRate).then(function(a){var r=s.connection.jingle.sessions[e.id];a?(C.pushInLocalStreams(a,e.id),r.addStream(C.localStreams[0]),r.localStreams.push(C.localStreams[0])):n=null,r.localType=n,r.sendAnswer(),r.accept(),t.$broadcast('ON_CALL_UPDATED_EVENT',e)}).catch(function(t){r.webrtc('MEDIA   | answerJingleCall failure for : '+e+' failure : '+t.message),-1!==t.toString().indexOf('getUserMedia')&&(C.releaseCall(e),C.openErrorPopup()),C.resetToSafeState()})})},this.answerCall=function(e,t){this.videoEventHandler.acceptProposition(e,t)},this.rejectCall=function(e,t){if(!e)return void r.webrtc('MEDIA   | rejectCall - trying to rejectCall a non existing call !');C.makingCall=!1,C.autoreleaseTimeout&&o.cancel(C.autoreleaseTimeout);var a=s.connection.jingle.sessions[e.id];a?C.releaseCall(e):e.isInitiator?this.videoEventHandler.retractProposition(e):this.videoEventHandler.rejectProposition(e,t)},this.releaseCall=function(e,t,a){return e?void(C.makingCall=!1,this.execute('releaseCall',function(){r.webrtc('MEDIA   | releaseCall : '+e);try{var n=s.connection.jingle.sessions[e.id];C.disableAudioVideoMedia(n),d.resetBusyState(),C.autoreleaseTimeout&&o.cancel(C.autoreleaseTimeout),C.createOrUpdateStatisticsForCall(e.id),C.callsStats[e.id]&&delete C.callsStats[e.id],C.callsStatsSimplified[e.id]&&delete C.callsStatsSimplified[e.id],C.removeCallObject(e,t,a),C.displayWebRTCStats(e.id)}catch(t){r.webrtc('MEDIA   | releaseCall ERROR'),r.error(t),C.createOrUpdateStatisticsForCall(e.id),C.callsStats[e.id]&&delete C.callsStats[e.id],C.callsStatsSimplified[e.id]&&delete C.callsStatsSimplified[e.id],C.resetToSafeState(),C.displayWebRTCStats(e.id),C.removeCallObject(e)}})):void r.webrtc('MEDIA   | releaseCall - trying to release a non existing call !')},this.askToAddDesktopSharing=function(e){r.webrtc('MEDIA   | askToAddDesktopSharing - Desktop sharing escalation');var t=!C.askToAddSharing(e.id);t&&C.addSharingToCall(e.videoCall)},this.addAudioToCall=function(e,t){r.webrtc('MEDIA   | addAudioToCall');var a=s.connection.jingle.sessions[e.id];a.isRenegotiating=!0;this.getBrowserMedia(['audio']).then(function(r){C.stopActiveAudioVideoStreams(a),C.pushInLocalStreams(r,e.id);for(var n=0;n<C.localStreams.length;n++)a.removeStream(C.localStreams[n]);var o=t?'contentModify':'contentAdd';C.updateCurrentCall(e,a,'audio',o)}).catch(function(t){r.webrtc('MEDIA   | addAudioToCall failure : '+t),C.releaseCall(e),C.resetToSafeState()})},this.addSharingToCall=function(e){r.webrtc('MEDIA   | addSharingToCall - Desktop sharing escalation');var t=s.connection.jingle.sessions[e.id];t.isRenegotiating=!0;var a={};e.isInConversationWithMobile()&&(a=C.getMobileMediaConstraints('sharing')),this.getBrowserMedia(['sharing'],null,null,a.fixedFrameRate).then(function(a){for(var r=0;r<C.localStreams.length;r++)t.removeStream(C.localStreams[r]),t.localStreams[r]=null;t.localStreams=[],C.pushInLocalStreams(a,e.id);for(var r=0;r<C.localStreams.length;r++)t.removeStream(C.localStreams[r]);C.updateCurrentCall(e,t,'sharing','contentAdd')}).catch(function(e){r.webrtc('MEDIA   | addSharingToCall failure : '+e),t.isRenegotiating=!1,-1!==e.toString().indexOf('getUserMedia')&&C.openErrorPopup()})},this.addVideoToCall=function(e,t){r.webrtc('MEDIA   | addVideoToCall');var a=s.connection.jingle.sessions[e.id];a.isRenegotiating=!0;var n={};e.isInConversationWithMobile()&&(n=C.getMobileMediaConstraints('video')),C.getBrowserMedia(['audio','video'],n.fixedVideoWidth,n.fixedVideoHeight,n.fixedFrameRate).then(function(r){C.stopActiveAudioVideoStreams(a),C.pushInLocalStreams(r,e.id);for(var n=0;n<C.localStreams.length;n++)a.removeStream(C.localStreams[n]);var o=t?'contentModify':'contentAdd';C.updateCurrentCall(e,a,'video',o)}).catch(function(t){r.webrtc('MEDIA   | addVideoToCall failure for : '+e+' failure : '+t.message),-1===t.toString().indexOf('getUserMedia')?(C.releaseCall(e),C.resetToSafeState()):(r.info('addVideoToCall impossible, no webcam plugged'),C.openErrorPopup())})},this.removeSharingFromCall=function(e){r.webrtc('MEDIA   | removeSharingFromCall');var t=s.connection.jingle.sessions[e.id];this.stopAllActiveStreams(t);var a=['audio'];e.localMedia&c.Media.VIDEO&&a.push('video'),t.isRenegotiating=!0,C.getBrowserMedia(a).then(function(a){C.pushInLocalStreams(a,e.id),C.updateCurrentCall(e,t,'sharing','contentRemove')}).catch(function(t){r.webrtc('MEDIA   | removeSharingFromCall failure for : '+e+' failure : '+t.message),-1!==t.toString().indexOf('getUserMedia')&&C.openErrorPopup(),C.releaseCall(e),C.resetToSafeState()})},this.removeVideoFromCall=function(e){r.webrtc('MEDIA   | removeVideoFromCall'),this.reverseAudioCallInitiated=!0;var t=s.connection.jingle.sessions[e.id];this.stopActiveAudioVideoStreams(t),this.localStreams.forEach(function(e){t.removeStream(e)});t.isRenegotiating=!0,C.getBrowserMedia(['audio']).then(function(a){C.pushInLocalStreams(a,e.id),C.updateCurrentCall(e,t,'video','contentRemove')}).catch(function(t){r.webrtc('MEDIA   | removeVideoFromCall failure for : '+e+' failure : '+t),-1!==t.toString().indexOf('getUserMedia')&&C.openErrorPopup(),C.releaseCall(e),C.resetToSafeState()})},this.calculatePresenceMessage=function(e){var t='audio';return e&&e.localMedia&c.Media.VIDEO&&(t='video'),e&&e.remoteMedia&c.Media.VIDEO&&(t='video'),e&&e.localMedia&c.Media.SHARING&&(t='sharing'),e&&e.remoteMedia&c.Media.SHARING&&(t='sharing'),t},this.calculateAudioState=function(e){var t=0;return e.availableIncomingAudioBandwidth&&(15>e.availableIncomingAudioBandwidth&&0<e.availableIncomingAudioBandwidth?t=1:15<=e.availableIncomingAudioBandwidth&&30>e.availableIncomingAudioBandwidth?t=2:t=3),t},this.calculateVideoState=function(e){var t=0;return e.availableIncomingVideoBandwidth&&(300>e.availableIncomingVideoBandwidth?t=1:300<=e.availableIncomingVideoBandwidth&&500>e.availableIncomingVideoBandwidth?t=2:t=3),t},this.execute=function(e,t,a){this.started||'releaseCall'===e?t(a):r.webrtc('MEDIA   | '+e+' failure : videoService is not started')},this.getOrCreateCallByCallId=function(e){var t=C.calls[e];if(!t){var a=s.connection.jingle.sessions[e],r=s.getBareJidFromJid(a.peerjid),n=d.getContactByJid(r);t=c.create(c.Status.UNKNOWN,e,c.Type.WEBRTC,n),C.calls[t.id]=t}return t},this.getCallByContact=function(e){for(var t in this.calls)if(this.calls.hasOwnProperty(t)){var a=C.calls[t];if(a.contact&&e.jid===a.contact.jid)return a}return null},this.removeCallObject=function(e,a,n){try{if(e){r.debug('removeCallObject Call id: '+e.id),e.status=c.Status.UNKNOWN;var o=s.connection.jingle.sessions?s.connection.jingle.sessions[e.id]:null;C.disableAudioVideoMedia(o,e.id),delete C.calls[e.id],t.$broadcast('ON_CALL_UPDATED_EVENT',e),o&&s.connection.jingle.terminate(e.id,a,n)}}catch(e){r.error('removeCallObject error '+e)}},this.updateRemoteTypeMedia=function(e,t){t.remoteMedia='audio'===e?c.Media.AUDIO:'video'===e?c.Media.VIDEO:'audio+video'===e?c.Media.AUDIO|c.Media.VIDEO:'sharing'===e?c.Media.SHARING|c.Media.AUDIO:'sharing-only'===e?c.Media.SHARING:null;r.debug('REMOTE TYPE || REMOTE MEDIA  '+t.remoteMedia)},this.checkStreamAndStatus=function(e,t){return e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)?(C.openErrorPopup(),!1):!t.capabilities||t.capabilities.webRTC||(r.webrtc('MEDIA   | initSharedDesktop failure : remote contact is no more available'),e.stop&&e.stop(),C.openErrorPopup('remoteUserNoMoreAvailable'),!1)},this.displayWebRTCStats=function(e){try{var t=null,a=0;if(l.hasStatsForCall(e)){if(r.webrtc('STATS   | Bundle policy used: '+l.getBundlePolicyForCall(e)),t=l.getStreamsDetailsFromCall(e),0===t.length)r.webrtc('STATS   | No channel information available for call '+e);else for(a=0;a<t.length;a++)r.webrtc('STATS   | '+t[a].id+': '+JSON.stringify(t[a].streams));var n=l.getCodecDetailsFromCall(e);r.webrtc('STATS   | codecs used: '+JSON.stringify(n)),m.trackCodecsUsed(n.codec.audio,n.codec.video)}else if(p.hasStatsForCall(e))if(r.webrtc('STATS   | Bundle policy used: '+p.getBundlePolicyForCall(e)),t=p.getStreamsDetailsFromCall(e),0===t.length)r.webrtc('STATS   | No channel information available for call '+e);else for(a=0;a<t.length;a++)r.webrtc('STATS   | '+t[a].id+': '+JSON.stringify(t[a].streams))}catch(e){r.error('[videoService] displayWebRTCStats error : '+e)}},this.muteAudio=function(e,a){var n=e.videoCall;if(!n)return void r.webrtc('MEDIA   | muteAudio - trying to mute a non existing call !');r.webrtc('MEDIA   | mute audio: '+n+' | state: '+a),e.isMutedAudio=a,n.isMuted=a;var o=s.connection.jingle.sessions[n.id];if(o)o.muteAudio(a);else return void r.webrtc('MEDIA   | muteAudio - trying to mute a non existing session !');t.$broadcast('ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT',{conversation:e,call:n})},this.muteVideo=function(e,a){var n=e.videoCall;if(!n)return void r.webrtc('MEDIA   | muteVideo - trying to mute a non existing call !');r.webrtc('MEDIA   | muteVideo: '+n);var o=s.connection.jingle.sessions[n.id];o&&(o.muteVideo(a),o.sendMute(a)),t.$broadcast('ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT',{conversation:e,call:n})},this.stopAllActiveStreams=function(e){this.stopActiveAudioVideoStreams(e,!0)},this.stopActiveAudioVideoStreams=function(e,t){if(0<C.localStreams.length)if(C.localStreams.forEach(function(e){(e.getAudioTracks().length||t)&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)}),t)for(;C.localStreams.length;){var a=C.localStreams.pop();a=null}else for(var r=0;r<C.localStreams.length;r++)if(C.localStreams[r]&&C.localStreams[r].getAudioTracks().length){var a=C.localStreams.splice(r,1);a=null}if(e&&e.localStreams){if(e.localStreams.forEach(function(a){(a.getAudioTracks().length||t)&&(a.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),a.stop&&a.stop(),e.removeStream(a))}),t)for(;e.localStreams.length;){var a=e.localStreams.pop();a=null}e.localStreams=[]}e&&s.connection.jingle.localStream&&e.removeStream(s.connection.jingle.localStream)},this.resetToSafeState=function(){r.webrtc('MEDIA   | resetToSafeState'),C.autoreleaseTimeout&&o.cancel(C.autoreleaseTimeout),(C.localStream||C.localStreams.length)&&C.disableAudioVideoMedia(),d.resetBusyState()},this.vidRes={1080:[1920,1080],720:[1280,720],360:[640,360],180:[320,180],960:[960,720],640:[640,480],320:[320,240]},this.getMobileMediaConstraints=function(e){var t={};return'sharing'===e?t.fixedFrameRate=3:'video'==e&&(t.fixedFrameRate=20,t.fixedVideoWidth=640,t.fixedVideoHeight=480),t},this.minFirefoxWebRTCVersion=45,this.minChromeWebRTCVersion=42,this.minEdgeWebRTCVersion=25,this.firefoxPreferedSharing='screen',this.getBrowserMedia=function(a,n,o,i){return a&&0!==a.length?new Promise(function(s,d){var c=e.defer(),l={audio:!1,video:!1},p=n?n:1280,g=o?o:720,v=[];if(u.allowDevicesManagement()){if(0<=a.indexOf('audio')){var f=e.defer();u.getCurrentMicrophone().then(function(e){l.audio=!e||{optional:[{sourceId:e.id}]},f.resolve(l);var t='default';e&&(t='id - '+e.id+' and label '+e.label),r.info('[VideoService] GetUserMedia for microphone '+t)}),v.push(f.promise)}if(0<=a.indexOf('video')){var h=i?i:30,E=e.defer();u.getCurrentCamera().then(function(e){l.video=e&&'default'!==e.id?{width:p,height:g,frameRate:h,deviceId:{exact:e.id}}:{width:p,height:g,frameRate:h},E.resolve(l);var t='default';e&&(t='id - '+e.id+' and label '+e.label),r.info('[VideoService] GetUserMedia for camera '+t)}),v.push(E.promise)}}else 0<=a.indexOf('audio')&&(l.audio=!0),0<=a.indexOf('video')&&(l.video={width:p,height:g});if(0<=a.indexOf('sharing')){var h=i?i:5;if(S.extensionFound)l.video={mandatory:{chromeMediaSource:'desktop',maxWidth:1920,maxHeight:1080,maxFrameRate:h}},v.push(S.getStreamToShareFromExtension(l));else if('firefox'===adapter.default.browserDetails.browser)l.video={mediaSource:C.firefoxPreferedSharing};else{var R=C.getDesktopSharingSource(),b=R&&R.chromeMediaSource?R.chromeMediaSource:'desktop',y=R&&R.chromeMediaSourceId?R.chromeMediaSourceId:null;l.video={mandatory:{chromeMediaSource:b,maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,maxFrameRate:h}},y&&(l.video.mandatory.chromeMediaSourceId=y)}}e.all(v).then(function(){c.resolve(l)}).catch(function(){c.resolve()}),c.promise.then(function(e){if(r.info('[VideoService] GetUserMedia with constraint '+JSON.stringify(e)),!e)d({message:'getUserMedia cancelled'});else try{navigator.mediaDevices.getUserMedia(e).then(function(e){r.webrtc('MEDIA   | getUserMedia success'),e.getAudioTracks().length&&r.info('[videoService] getUserMedia audio stream kind '+e.getAudioTracks()[0].kind+', id '+e.getAudioTracks()[0].id+', label '+e.getAudioTracks()[0].label+', readyState '+e.getAudioTracks()[0].readyState+', enabled '+e.getAudioTracks()[0].enabled),e.getVideoTracks().length&&r.info('[videoService] getUserMedia video stream kind '+e.getVideoTracks()[0].kind+', id '+e.getVideoTracks()[0].id+', label '+e.getVideoTracks()[0].label+', readyState '+e.getVideoTracks()[0].readyState+', enabled '+e.getVideoTracks()[0].enabled),e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)&&(r.webrtc('Stream has no active audio or video tracks'),m.trackGetUserMediaErrorNoTrack(),d(new Error('getUserMedia failure : Stream has no active audio or video tracks'))),S.extensionFound&&0<=a.indexOf('sharing')&&(e.getVideoTracks()[0].onended=function(){r.info('Stop screensharing in chrome has been triggered'),t.$broadcast('ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED')}),e&&e.getAudioTracks().length&&(e.getAudioTracks()[0].onended=function(e){r.error('audio stream track ended'),console.log(this),console.log(e)}),s(e),m.trackGetUserMediaSuccess()}).catch(function(e){r.webrtc('MEDIA   | getUserMedia failure: '+e),m.trackGetUserMediaError(),t.$broadcast('ON_WEBRTC_GETUSERMEDIA_ERROR',e),d(new Error('getUserMedia failure '+e))})}catch(e){r.webrtc('MEDIA   | getUserMedia failure: '+e),m.trackGetUserMediaError(),d(new Error('getUserMedia failure '+e))}})}):e.when()},this.getBrowserMethodHandler=function(){var e='',t=null;if(navigator.mozGetUserMedia&&a.mozRTCPeerConnection){if(e=i.extractBrowserVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),r.webrtc('BROWSER | Detect Firefox navigator (version '+e+')'),e<this.minFirefoxWebRTCVersion)return r.webrtc('BROWSER | Firefox navigator is not WebRTC capable before version '+this.minFirefoxWebRTCVersion),t;t={browser:'firefox',attachMediaStream:function(e,t){e&&e[0]&&(e[0].mozSrcObject=t,e[0].srcObject=t,e[0].play())},pc_constraints:{},clearMediaStream:function(e){try{angular.isDefined(e[0])&&(e[0].pause(),e[0].mozSrcObject=null,e[0].srcObject=null,e[0].uniqueId=null)}catch(e){r.webrtc('BROWSER | clearMediaStream failure '+e)}},attachMediaStreamIfNeeded:function(e,t,a){r.webrtc('BROWSER | attachMediaStreamIfNeeded for ID '+a),e&&e[0]&&(e[0].uniqueId!==a||!e[0].mozSrcObject&&!e[0].srcObject)&&(e[0].uniqueId=a,C.RTC.attachMediaStream(e,t))}}}else if(navigator.webkitGetUserMedia&&a.webkitRTCPeerConnection){if(e=i.extractBrowserVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),r.webrtc('BROWSER | Detect Chrome navigator (version '+e+')'),e<this.minChromeWebRTCVersion)return r.webrtc('BROWSER | Chrome navigator is not WebRTC capable before version '+this.minChromeWebRTCVersion),t;t={browser:'chrome',attachMediaStream:function(e,t){r.webrtc('BROWSER | attachMediaStream to element'),e&&e[0]&&(e[0].srcObject=t),o(function(){e&&e[0]&&e[0].load&&e[0].load()},1e3,1)},pc_constraints:{},clearMediaStream:function(e){angular.isDefined(e[0])&&(e[0].pause(),e[0].srcObject=null,e[0].uniqueId=null)},attachMediaStreamIfNeeded:function(e,t,a){r.webrtc('BROWSER | attachMediaStreamIfNeeded for ID '+a),e&&e[0]&&(e[0].uniqueId!==a||!e[0].srcObject)&&(e[0].uniqueId=a,C.RTC.attachMediaStream(e,t))}}}return t},this.getIceConfig=function(){return e(function(e,t){var a=config.restServerUrl+'/api/rainbow/geolocation/v1.0/';n({method:'GET',url:a+'settings/iceservers?nbServers=2',headers:v.getRequestHeader()}).then(function(t){r.info('[videoService] getIceConfig success');var a=t.data.data;a.forEach(function(e){delete e.id},this),e({iceServers:a})}).catch(function(e){r.error('[videoService] getIceConfig failure -- '+e.message),t(e)})})},this.calculateNewCallType=function(e,t,a,n){var o=t.localType;return'contentAdd'===n&&('video'===a?(o=e.localMedia&c.Media.SHARING?'sharing+video':'video',e.localMedia|=c.Media.VIDEO):'sharing'===a?(o=e.localMedia&c.Media.VIDEO?'sharing+video':'sharing',e.localMedia|=c.Media.SHARING):'audio'==a&&(e.localMedia&c.Media.SHARING?(o='sharing',e.localMedia|=c.Media.AUDIO):(o='audio',e.localMedia=c.Media.AUDIO))),'contentRemove'===n&&('video'===a?e.localMedia&c.Media.SHARING?(o='sharing',e.localMedia=c.Media.AUDIO|c.Media.SHARING):(o='audio',e.localMedia=c.Media.AUDIO):'sharing'==a&&(e.localMedia&c.Media.VIDEO?(o='video',e.localMedia=c.Media.AUDIO|c.Media.VIDEO):(o='audio',e.localMedia=c.Media.AUDIO))),'contentModify'===n&&e.localMedia&c.Media.VIDEO&&!(e.localMedia&c.Media.SHARING)&&(o='video'),r.info('[videoService] calculateNewCallType for type '+a+' and action '+n+' with result '+o),o},this.updateCurrentCall=function(e,a,n,o){r.info('[videoService] updateCurrentCall for type '+n+' and action '+o);for(var s=this.calculateNewCallType(e,a,n,o),c=0;c<C.localStreams.length;c++)'chrome'===adapter.default.browserDetails.browser?a.addStream(C.localStreams[c]):a.replaceStream(C.localStreams[c]),a.localStreams.push(C.localStreams[c]);switch(o){case'contentAdd':a.contentAdd(s);break;case'contentRemove':a.contentRemove(s);break;case'contentModify':a.contentModify(s);break;default:}d.setBusyState('dnd',C.calculatePresenceMessage(e)),t.$broadcast('ON_CALL_UPDATED_EVENT',e),t.$broadcast('ON_WEBRTC_CALL_ESCALATION',e)},this.createOrUpdateStatisticsForCall=function(e){var t=this.calls[e];if(!t)return void r.warn('[videoService] createOrUpdateStatisticsForCall -- missing call '+e);var a=[];return this.callsStats[e]?(a.push({connectionId:e,stats:this.callsStats[e]}),void this.updateStatisticsForCall(this.callsStats[e].id,e,t.contact.dbId,'ended',a)):void(r.info('[videoService] createOrUpdateStatisticsForCall '+e),this.callsStats[e]={},a.push({connectionId:e,stats:this.callsStats[e]}),this.createStatisticsForSession(e,t.contact.dbId,'pending',a).then(function(t){C.callsStats[e].id=t,r.info('[videoService] createOrUpdateStatisticsForCall success for session '+e+' with id '+t)}).catch(function(e){r.error('[videoService] createOrUpdateStatisticsForCall '+e.message)}))},this.createStatisticsForSession=function(t,a,o,i){return e(function(e,s){r.info('[videoService] createStatisticsForSession '+t);var d=config.restServerUrl+'/api/rainbow/metrics/v1.0/';n({method:'POST',url:d+'webrtcmetrics',headers:v.getRequestHeader(),data:{callId:t,peerId:a,callState:o,metrics:i}}).then(function(a){r.info('[videoService] createStatisticsForSession success'),a&&a.data&&a.data.data&&a.data.data.id&&C.callsStats[t]&&e(a.data.data.id)},function(e){r.error('[videoService] createStatisticsForSession failure '+e.errorMsg),s(new Error(e.errorMsg))})})},this.updateStatisticsForCall=function(e,t,a,o,i){if(r.info('[videoService] updateStatisticsForCall '+t),!e)return void r.warn('[videoService] updateStatisticsForCall -- missing id for callId '+t);var s=config.restServerUrl+'/api/rainbow/metrics/v1.0/';n({method:'POST',url:s+'webrtcmetrics/'+e+'/metrics',headers:v.getRequestHeader(),data:{metrics:i}}).then(function(){r.info('[videoService] updateStatisticsForCall success')},function(e){r.error('[videoService] updateStatisticsForCall failure '+e.errorMsg)})},angular.element(document).bind('transportreplace.jingle',function(e,t){r.webrtc('JINGLE  | transportreplace.jingle '+t);var a=s.connection.jingle.sessions[t];a?a.sendAnswer(void 0,'transport-accept'):r.warn('JINGLE  | transportreplace.jingle no such session !')}),angular.element(document).bind('callactive.jingle',function(e,t){r.webrtc('JINGLE  | callactive '+t)}),angular.element(document).bind('remotestreamadded.jingle',function(e,a,n){r.webrtc('JINGLE  | remoteStreamadded '+a);var o=s.connection.jingle.sessions[a];if(o&&o.remoteStreams&&!o.confId){var i=C.calls[a];i&&C.attachDistantMediaStreams(!0,i),t.$broadcast('ON_WEBRTC_REMOTE_STREAM_ADDED',o.remoteStreams)}n&&C.resetAudioOutputElement()}),angular.element(document).bind('remotestreamremoved.jingle',function(e,t){r.webrtc('JINGLE  | remotestreamremoved '+t)}),angular.element(document).bind('callaccepted.jingle',function(e,t){r.webrtc('JINGLE  | callaccepted '+t);var a=C.calls[t],n=s.connection.jingle.sessions[t];a&&n&&(C.statsInterval&&(r.webrtc('JINGLE  | remove getStats interval'),window.clearInterval(C.statsInterval),C.statsinterval=null),C.createOrUpdateStatisticsForCall(a.id),r.webrtc('JINGLE  | start getStats interval'),C.statsInterval=n.getStats(5e3)),a&&a.status.key!==c.Status.ACTIVE.key&&(r.webrtc('INFO    | call has been accepted. Set current call to ACTIVE state'),angular.element(document).trigger('callactive.jingle',[t]))}),angular.element(document).bind('nostuncandidates.jingle',function(e,t){r.webrtc('JINGLE  | nostuncandidates '+t),m.trackICENoSTUNCandidate()}),angular.element(document).bind('ringing.jingle',function(e,t){r.webrtc('JINGLE  | callremoteringing '+t)}),angular.element(document).bind('mediafailure.jingle',function(){r.webrtc('JINGLE  | callmediafailure')}),angular.element(document).bind('mute.jingle',function(e,a){r.webrtc('JINGLE  | mute '+a);var n=C.calls[a];n.isRemoteVideoMuted=!0,t.$broadcast('ON_CALL_UPDATED_EVENT',n)}),angular.element(document).bind('unmute.jingle',function(e,a){r.webrtc('JINGLE  | unmute '+a);var n=C.calls[a];n.isRemoteVideoMuted=!1,t.$broadcast('ON_CALL_UPDATED_EVENT',n)}),angular.element(document).bind('hold.jingle',function(e,a){r.webrtc('JINGLE  | hold '+a);var n=s.connection.jingle.sessions[a];if(n)n.muteAudio(!0);else return void r.webrtc('MEDIA   | hold - received on a non existing session !');t.$broadcast('ON_HOLD_TONE_EVENT','hold')}),angular.element(document).bind('unhold.jingle',function(e,a){r.webrtc('JINGLE  | unhold '+a);var n=s.connection.jingle.sessions[a];if(n)n.muteAudio(!1);else return void r.webrtc('MEDIA   | unhold - received on a non existing session !');t.$broadcast('ON_HOLD_TONE_EVENT','unhold')}),angular.element(document).bind('remoteIceFailed.jingle',function(e){r.webrtc('JINGLE  | remoteIceFailed '+e),C.openErrorPopup('IceConnectionFailed')}),angular.element(document).bind('mediamodified.jingle',function(e,t,a){r.webrtc('JINGLE  | mediamodified '+t),C.videoEventHandler.mediaModified(t,a)}),angular.element(document).bind('statsChrome.jingle',function(e,t,a){for(var r=0;r<a.length;++r)switch(a[r].type){case'googComponent':l.addStreamToCall(t,a[r]);break;case'ssrc':l.addSSRCToStream(t,a[r]);break;default:}}),angular.element(document).bind('statsFirefox.jingle',function(e,t,a){for(var r=0;r<a.length;++r)switch(a[r].type){case'inboundrtp':p.addStreamToCall(t,a[r]);break;case'outboundrtp':p.addStreamToCall(t,a[r]);break;case'candidatepair':p.addCandidatePairToCall(t,a[r]);break;default:}}),angular.element(document).bind('webrtcFirefoxStats.jingle',function(e,a,r){C.callsStats.sid||(C.callsStats.sid={}),C.callsStats[a]||(C.callsStats[a]={});var n=C.calls[a];if(n){var o=C.calculateAudioState(r),i=0;n.remoteMedia&c.Media.VIDEO&&(i=C.calculateVideoState(r));var s=C.callsStats[a];s&&(r.videoReceived?s.video=r:s.audio=r,C.callsStats[a]=s),t.$broadcast('ON_WEBRTC_CALL_STATS',o,i)}}),angular.element(document).bind('webrtcConnectionType.jingle',function(e,t,a){var n=C.calls[t];a&&(r.webrtc('STATS   | Local candidate ('+a.localAddress+') type is '+a.localCandidateType),r.webrtc('STATS   | Remote candidate  ('+a.remoteAddress+') type is '+a.remoteCandidateType),n&&n.isInitiator&&m.trackICEUsed(a.localCandidateTypee,a.remoteCandidateType),a.networkType&&(r.webrtc('STATS   | Network type is '+a.networkType),n&&n.isInitiator&&m.trackICETopology(a.networkType)))}),angular.element(document).bind('webrtcSessionStats.jingle',function(e,t,a){C.callsStats.sid||(C.callsStats.sid={}),C.callsStats[t]||(C.callsStats[t]={});var r=C.callsStats[t].id;C.callsStats[t]=a,C.callsStats[t].id=r}),this.escalateToSharingCall=function(e,t){r.webrtc('MEDIA   | escalateToSharingCall - Desktop sharing escalation');var a=s.connection.jingle.sessions[e.id];a.isRenegotiating=!0;this.getBrowserMedia(['sharing']).then(function(r){a.removeStream(C.localStreams[0]),a.localStreams[0]=null,a.localStreams=[],C.pushInLocalStreams(r,e.id),C.updateCurrentSharingCall(e,a,t)}).catch(function(e){r.webrtc('MEDIA   | escalateToSharingCall failure : '+e),a.isRenegotiating=!1,-1!==e.toString().indexOf('getUserMedia')&&C.openErrorPopup()})},this.escalateToVideoCall=function(e,t){r.webrtc('MEDIA   | Escalate to video call');var a=s.connection.jingle.sessions[e.id];a.isRenegotiating=!0,C.getBrowserMedia(['audio','video']).then(function(r){C.stopActiveAudioVideoStreams(a),C.pushInLocalStreams(r,e.id);for(var n=0;n<C.localStreams.length;n++)a.localStreams.push(C.localStreams[n]);C.updateCurrentAudioOrVideoCall(e,a,'video',t)}).catch(function(t){r.webrtc('MEDIA   | escalateToVideoCall failure for : '+e+' failure : '+t.message),-1===t.toString().indexOf('getUserMedia')?(C.releaseCall(e),C.resetToSafeState()):(r.info('Escalation to video impossible, no webcam plugged'),C.openErrorPopup())})},this.addAudioToSharingCall=function(e){r.webrtc('MEDIA   | addAudioToSharingCall');var t=s.connection.jingle.sessions[e.id];t.isRenegotiating=!0,C.localStreams.length&&t.removeStream(C.localStreams[0]),t.localStreams[0]=null,t.localStreams=[];this.getBrowserMedia(['audio']).then(function(a){C.pushInLocalStreams(a,e.id),C.updateCurrentSharingCall(e,t)}).catch(function(t){r.webrtc('MEDIA   | addAudioToSharingCall failure : '+t),C.releaseCall(e),C.resetToSafeState()})},this.reverseToAudioCall=function(e,t){r.webrtc('MEDIA   | reverseToAudioCall'),this.reverseAudioCallInitiated=!0;var a=s.connection.jingle.sessions[e.id];this.stopActiveAudioVideoStreams(a);a.isRenegotiating=!0,C.getBrowserMedia(['audio']).then(function(r){C.pushInLocalStreams(r,e.id);for(var n=0;n<C.localStreams.length;n++)a.localStreams.push(C.localStreams[n]);C.updateCurrentAudioOrVideoCall(e,a,'audio',t)}).catch(function(t){r.webrtc('MEDIA   | reverseToAudioCall failure for : '+e+' failure : '+t.message),-1!==t.toString().indexOf('getUserMedia')&&C.openErrorPopup(),C.releaseCall(e),C.resetToSafeState()})},C.updateCurrentSharingCall=function(e,a,n){if(r.webrtc('MEDIA   | updateCurrentSharingCall | Add new streams to the current session'),!a||!s.connection.jingle.sessions[e.id])return C.disableAudioVideoMedia(),C.resetToSafeState(),void C.removeCallObject(e);var o='audio';'chrome'===adapter.default.browserDetails.browser?(a.localStreams.push(C.localStreams[0]),a.addStream(C.localStreams[0]),C.localStreams[1]&&(o=e.localMedia===c.Media.AUDIO||e.localMedia===c.Media.SHARING?'sharing':'sharing+video',e.localMedia=e.localMedia|c.Media.SHARING|c.Media.AUDIO,a.localStreams.push(C.localStreams[1]),a.addStream(C.localStreams[1]),a.localStreams.push(C.localStreams[1]),a.addStream(C.localStreams[1]))):(e.localMedia=c.Media.AUDIO,a.replaceStream(C.localStreams[0])),n?a.contentModify(o):a.contentAdd(o),d.setBusyState('dnd',C.calculatePresenceMessage(e)),t.$broadcast('ON_CALL_UPDATED_EVENT',e),t.$broadcast('ON_WEBRTC_CALL_ESCALATION',e)},this.updateCurrentAudioOrVideoCall=function(e,a,n,o){r.webrtc('MEDIA   | updateCurrentAudioOrVideoCall | Add new stream to the current session');for(var s=0;s<C.localStreams.length;s++)'chrome'===adapter.default.browserDetails.browser?a.addStream(C.localStreams[s]):a.replaceStream(C.localStreams[s]);o?a.contentModify(a.localType):'audio'===n?e.localMedia&c.Media.SHARING?(a.contentRemove('sharing'),a.localType='sharing',e.localMedia=c.Media.AUDIO|c.Media.SHARING):(a.contentRemove('audio'),a.localType='audio',e.localMedia=c.Media.AUDIO):'video'==n&&(e.localMedia&c.Media.SHARING?(a.contentAdd('sharing+video'),a.localType='sharing+video'):(a.contentAdd('video'),a.localType='audio+video'),e.localMedia|=c.Media.VIDEO),d.setBusyState('dnd',C.calculatePresenceMessage(e)),t.$broadcast('ON_CALL_UPDATED_EVENT',e),t.$broadcast('ON_WEBRTC_CALL_ESCALATION',e)},this.attachLocalMediaStream=function(e){e?(this.localStreams&&this.localStreams.length&&this.localStreams[0].getVideoTracks().length&&this.RTC.attachMediaStream($('#minivideo'),this.localStreams[0]),$('#minivideo')[0]&&($('#minivideo')[0].volume=0)):this.RTC.clearMediaStream($('#minivideo'),null)},this.attachDistantMediaStream=function(e,t){if(e){var a=s.connection.jingle.sessions[t.id];a.remoteStreams?a.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&(r.webrtc('attachDistantMediaStream video track'),C.RTC.attachMediaStream(angular.element('#largevideo'),e),angular.element('#largevideo')[0]&&(angular.element('#largevideo')[0].muted=!0,angular.element('#largevideo')[0].volume=0)),0<e.getAudioTracks().length&&(r.webrtc('attachDistantMediaStream audio track'),C.RTC.attachMediaStream(angular.element('#globalAudioTag'),e))}):a.remoteStream&&(0<a.remoteStream.getVideoTracks().length&&(r.error('attachDistantMediaStream NOT GOOD !!! video track'),C.RTC.attachMediaStream(angular.element('#largevideo'),a.remoteStream),angular.element('#largevideo')[0]&&(angular.element('#largevideo')[0].muted=!0,angular.element('#largevideo')[0].volume=0)),0<a.remoteStream.getAudioTracks().length&&(r.error('attachDistantMediaStream NOT GOOD !!! audio track'),C.RTC.attachMediaStream(angular.element('#globalAudioTag'),a.remoteStream)))}else C.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element('#largevideo'),null),this.RTC.clearMediaStream(angular.element('#globalVideoTag'),null),this.RTC.attachMediaStream(angular.element('#globalAudioTag'),null))},this.sendDTMF=function(e,t,a){var n=s.connection.jingle.sessions[t.id];if(n&&n.peerconnection){var o=n.peerconnection.getSenders(),i=o.find(function(e){return e.dtmf&&e.track&&e.track.enabled&&'audio'===e.track.kind}),d=i?i.dtmf:null;d?(r.debug('sendDTMF: dtmf sender found on webrtc session for call id '+t.id+' dialstring: '+e),d.ontonechange=a?this.silentToneChangeEventHandle:this.handleToneChangeEvent,d.insertDTMF(e)):r.error('sendDTMF: no dtmf sender found on webrtc session for call id '+t.id)}else r.error('sendDTMF: no webrtc session found for call id '+t.id)},this.handleToneChangeEvent=function(e){''!==e.tone&&(r.debug('Tone played: '+e.tone),t.$broadcast('ON_DTMF_SENT',e.tone))},this.silentToneChangeEventHandle=function(e){r.debug('Tone played: '+e.tone)}}])},function(){angular.module('rainbow').factory('VideoServiceEventHandler',['$log','$rootScope','$interval','contactService','xmppService','Call','gaService','uuid4',function(e,t,a,r,n,o,i,s){'use strict';function d(e){this.videoService=e,this.nameSpace='urn:xmpp:jingle-message:0'}return d.create=function(e){return new d(e)},d.prototype.setRemoteTypeMedia=function(t,a){a.remoteMedia=0;for(var r=0;r<t.length;r++)switch(t[r]){case'audio':a.remoteMedia|=o.Media.AUDIO;break;case'video':a.remoteMedia|=o.Media.VIDEO;break;case'sharing':a.remoteMedia|=o.Media.SHARING;break;default:a.remoteMedia=null;}e.debug('REMOTE TYPE || REMOTE MEDIA  '+a.remoteMedia)},d.prototype.setLocalTypeMedia=function(t,a){a.localMedia=0;for(var r=0;r<t.length;r++)switch(t[r]){case'audio':a.localMedia|=o.Media.AUDIO;break;case'video':a.localMedia|=o.Media.VIDEO;break;case'sharing':a.localMedia|=o.Media.SHARING;break;default:a.localMedia=null;}e.debug('LOCAL TYPE || LOCAL MEDIA  '+a.localMedia)},d.prototype.sendProposition=function(i,d,c){e.info('[VideoServiceEventHandler]   | sendProposition to '+JSON.stringify({displayName:i.displayNameForLog(),resources:i.resources}));var l=this,p=['audio'],u=[];'video'===d?p.push('video'):'videoOnly'===d?p=['video']:'sharing'===d?(p=['sharing'],u=['audio']):'sharingOnly'==d&&(p=['sharing']);var m='web_'+s.generate(),g=o.create(o.Status.DIALING,m,o.Type.WEBRTC,i);this.videoService.getBrowserMedia(p).then(function(o){l.videoService.getBrowserMedia(u).then(function(d){if(l.videoService.makingCall&&l.videoService.started){g.isInitiator=!0,o.callId=m,l.videoService.localStreams.push(o),d&&(d.callId=m,l.videoService.localStreams.push(d),p.push(u.pop())),l.videoService.calls[g.id]=g,l.setLocalTypeMedia(p,g);var v='web_'+s.generate(),f=$msg({from:r.userContact.fullJid,to:i.jid,id:v});f.c('propose',{xmlns:l.nameSpace,id:m}),c&&f.c('subject',{xmlns:'urn:xmpp:jingle-subject:0'}).t(c).up(),f.c('description',{xmlns:'urn:xmpp:jingle:apps:rtp:1',media:p[0]}).up(),p[1]&&(f=f.c('description',{xmlns:'urn:xmpp:jingle:apps:rtp:1',media:p[1]}).up()),n.send(f),l.videoService.makingCall=!1,r.setBusyState('dnd',l.videoService.calculatePresenceMessage(g)),t.$broadcast('ON_CALL_UPDATED_EVENT',g),l.videoService.autoreleaseTimeout&&a.cancel(l.videoService.autoreleaseTimeout),l.videoService.autoreleaseTimeout=a(function(t){e.webrtc('MEDIA   | send proposition : no response after 30 seconds : release the call'),g&&l.videoService.rejectCall(t)},3e4,1,!0,g)}else e.warn('[VideoServiceEventHandler]   | sendProposition -- call should no longer be made !'),l.videoService.makingCall=!1,o.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),o.stop&&o.stop(),o=null,d&&(d.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),d.stop&&d.stop(),d=null)}).catch(function(t){e.info('[VideoServiceEventHandler]   | sendProposition failure : '+JSON.stringify({error:t.message})),l.videoService.makingCall=!1,-1!==t.toString().indexOf('getUserMedia')&&l.videoService.openErrorPopup(),l.videoService.removeCallObject(g),l.videoService.resetToSafeState(),l.videoService.autoreleaseTimeout&&a.cancel(l.videoService.autoreleaseTimeout)})}).catch(function(t){e.info('[VideoServiceEventHandler]   | sendProposition failure : '+JSON.stringify({error:t.message})),l.videoService.makingCall=!1,0<=p.indexOf('sharing')||-1===t.toString().indexOf('getUserMedia')||l.videoService.openErrorPopup(),l.videoService.removeCallObject(g),l.videoService.resetToSafeState()})},d.prototype.retractProposition=function(t){e.info('[VideoServiceEventHandler]   | retractProposition for call '+t.id);var a='web_'+s.generate(),o=$msg({from:r.userContact.fullJid,to:t.contact.jid,id:a}).c('retract',{xmlns:this.nameSpace,id:t.id});n.send(o),r.resetBusyState(),this.videoService.removeCallObject(t)},d.prototype.acceptProposition=function(i,d){e.info('[VideoServiceEventHandler]   | acceptProposition for call '+i.id);var c='web_'+s.generate(),l=$msg({from:r.userContact.fullJid,to:r.userContact.jid,id:c}).c('accept',{xmlns:this.nameSpace,id:i.id});n.send(l);var p='web_'+s.generate();l=$msg({from:r.userContact.fullJid,to:i.fullJid,id:p}).c('proceed',{xmlns:this.nameSpace,id:i.id}),n.send(l);var u=['audio'];d&&'video'===d&&u.push('video'),i.remoteMedia===o.Media.VIDEO&&(u=['video']),i.remoteMedia===o.Media.SHARING&&(u=[]),this.setLocalTypeMedia(u,i),r.setBusyState('dnd',this.videoService.calculatePresenceMessage(i)),i.status=o.Status.ANSWERING,t.$broadcast('ON_CALL_UPDATED_EVENT',i);var m=this;m.videoService.autoreleaseTimeout&&a.cancel(m.videoService.autoreleaseTimeout),m.videoService.autoreleaseTimeout=a(function(t){t&&(null===i.getMediaPillarCall()?e.webrtc('[VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call '+t.id):e.warn('[webrtcgateway/VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call :'+t.id),m.videoService.removeCallObject(t),r.resetBusyState())},45e3,1,!0,i)},d.prototype.rejectProposition=function(i,d){e.info('[VideoServiceEventHandler]   | rejectProposition for call '+i.id);var c='web_'+s.generate(),l=$msg({from:r.userContact.fullJid,to:r.userContact.jid,id:c}).c('reject',{xmlns:this.nameSpace,id:i.id});n.send(l);var p=i.getMediaPillarCall(),u=p&&p.mediaPillarJid?p.mediaPillarJid:i.contact.jid,m='web_'+s.generate();l=$msg({from:r.userContact.fullJid,to:u,id:m}).c('reject',{xmlns:this.nameSpace,id:i.id,reason:d}),n.send(l),i&&(i.status=o.Status.UNKNOWN,delete this.videoService.calls[i.id],t.$broadcast('ON_CALL_UPDATED_EVENT',i)),this.videoService.setWebrtcConfiguration(),this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout)},d.prototype.onMessageReceived=function(a){var r=this;try{t.$apply(function(){e.info('[VideoServiceEventHandler]   | onMessageReceived');var t=$(a);0<t.find('error').length||0<t.find('delay').length||0<$(a).find('service-unavailable').length?r.onMessageReceivedError():0<t.find('propose').length?r.onPropositionReceived(a):0<t.find('retract').length?r.onRetractReceived(a):0<t.find('reject').length?r.onRejectReceived(a):0<t.find('accept').length?r.onAcceptReceived(a):0<t.find('proceed').length&&r.onProceedReceived(a)})}catch(t){return e.error('[VideoServiceEventHandler]   | onMessageReceived error '+t),!0}return!0},d.prototype.onMessageReceivedError=function(t){e.info('[VideoServiceEventHandler]   | onMessageReceivedError');var a=$(t).find('propose').attr('id'),r=this.videoService.calls[a];r&&e.error('[VideoServiceEventHandler]   | onMessageReceivedError call is in '+r.status.value+' state')},d.prototype.onPropositionReceived=function(s){e.info('[VideoServiceEventHandler]   | onPropositionReceived');var i=$(s).find('propose').attr('id'),d=this.videoService.calls[i],c=this;if(!d){var l=$(s).attr('from'),p=[],u=n.getBareJidFromJid(l);d=o.create(o.Status.UNKNOWN,i,o.Type.WEBRTC),d.fullJid=l,c.videoService.calls[d.id]=d,r.getOrCreateContact(u).then(function(r){for(var n=$(s).find('description').length,l=0,i;l<n;l++)i=$(s).find('description')[l],p.push($(i).attr('media'));if(c.videoService.calls[d.id]){if(d.contact=r,0<$(s).find('subject').length){var u=$(s).find('subject')[0];e.debug('[VideoServiceEventHandler]   | onPropositionReceived subject Detected: '+u.textContent),d.setSubject(u.textContent)}d.setStatus(o.Status.RINGING_INCOMMING),c.setRemoteTypeMedia(p,d),t.$broadcast('ON_CALL_UPDATED_EVENT',d),c.videoService.autoreleaseTimeout&&a.cancel(c.videoService.autoreleaseTimeout),c.videoService.autoreleaseTimeout=a(function(t){t&&(e.webrtc('[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call '+t.id),c.videoService.removeCallObject(t))},12e4,1,!0,d)}}).catch(function(t){e.error('[VideoServiceEventHandler]   | onPropositionReceived error '+t),c.videoService.removeCallObject(d)})}else{if(0<$(s).find('subject').length){var m=$(s).find('subject')[0];e.debug('[VideoServiceEventHandler]   | onPropositionReceived subject Detected: '+m.textContent),d.setSubject(m.textContent)}d.setStatus(o.Status.RINGING_INCOMMING),this.setRemoteTypeMedia(p,d),t.$broadcast('ON_CALL_UPDATED_EVENT',d),c.videoService.autoreleaseTimeout&&a.cancel(c.videoService.autoreleaseTimeout),c.videoService.autoreleaseTimeout=a(function(t){t&&(e.webrtc('[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call '+t.id),c.videoService.removeCallObject(t))},12e4,1,!0,d)}},d.prototype.onRetractReceived=function(t){e.info('[VideoServiceEventHandler]   | onRetractReceveid');var n=$(t).find('retract').attr('id'),i=this.videoService.calls[n];i&&(i.status===o.Status.ANSWERING&&r.resetBusyState(),this.videoService.removeCallObject(i)),this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout)},d.prototype.onRejectReceived=function(n){e.info('[VideoServiceEventHandler]   | onRejectReceived');var i=$(n).find('reject').attr('id'),s=this.videoService.calls[i],d=$(n).attr('from'),c='calendarBusy'===$(n).find('reject').attr('reason');this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout),s&&(s.status===o.Status.RINGING_INCOMMING&&(null!==s.getMediaPillarCall()&&t.$broadcast('ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT',s),this.videoService.removeCallObject(s)),s.status===o.Status.DIALING&&(r.resetBusyState(),this.videoService.removeCallObject(s)),(s.status===o.Status.ACTIVE||s.status===o.Status.CONNECTING)&&s.fullJid&&s.fullJid===d&&(r.resetBusyState(),this.videoService.removeCallObject(s))),c&&this.videoService.openCalendarBusyPopup(s.contact.id)},d.prototype.onAcceptReceived=function(n){e.info('[VideoServiceEventHandler]   | onAcceptReceived');var o=$(n).find('accept').attr('id'),i=this.videoService.calls[o],s=$(n).attr('from');i&&s!==r.userContact.fullJid&&(null!==i.getMediaPillarCall()&&t.$broadcast('ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT',i),this.videoService.removeCallObject(i)),s!==r.userContact.fullJid&&this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout)},d.prototype.onProceedReceived=function(t){e.info('[VideoServiceEventHandler]   | onProceedReceived'),this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout);var r=$(t).find('proceed').attr('id'),n=this.videoService.calls[r],i=$(t).attr('from');if(n.fullJid=i,n.isInConversationWithMobile()&&n.localMedia&o.Media.VIDEO){var s=this,d=[],c=s.videoService.getMobileMediaConstraints('video');d=['audio','video'],n.localMedia&o.Media.AUDIO||(d=['video']),s.videoService.getBrowserMedia(d,c.fixedVideoWidth,c.fixedVideoHeight,c.fixedFrameRate).then(function(t){e.info('[VideoServiceEventHandler]   | onProceedReceived --> renegociate video quality'),n.localMedia&o.Media.VIDEO&&s.videoService.stopActiveAudioVideoStreams(null,!0),s.videoService.localStreams.push(t),s.videoService.makeJingleCall(n)}).catch(function(t){e.info('[VideoServiceEventHandler]   | onProceedReceived '+n+' failure : '+t.message),-1===t.toString().indexOf('getUserMedia')?(s.videoService.releaseCall(n),s.videoService.resetToSafeState()):(e.info('onProceedReceived impossible, no webcam plugged'),s.videoService.openErrorPopup())})}else n.localMedia&o.Media.SHARING?this.videoService.makeJingleSharingCall(n):this.videoService.makeJingleCall(n)},d.prototype.incomingCall=function(o){e.info('[VideoServiceEventHandler] incomingCall '+o);var i=this,s=null,d=n.connection.jingle.sessions[o];if(d&&d.peerjid){var c=n.getBareJidFromJid(d.peerjid),l=r.getContactByJid(c);s=this.videoService.getCallByJid(l.jid)}s?(d.sendRinging(),a(function(e){i.videoService.answerJingleCall(e)},350,1,!0,s),t.$broadcast('ON_CALL_UPDATED_EVENT',s),this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout),this.videoService.statsInterval&&(e.info('[VideoServiceEventHandler] remove getStats interval'),window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),i.videoService.createOrUpdateStatisticsForCall(s.id),e.info('[VideoServiceEventHandler] start getStats interval'),this.videoService.statsInterval=d.getStats(5e3)):(e.warn('[VideoServiceEventHandler] incomingCall no such call ! Terminate the session '),r.resetBusyState(),d&&d.terminate())},d.prototype.activeCall=function(r){e.info('[VideoServiceEventHandler] activeCall '+r);var s=n.connection.jingle.sessions[r];this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout);var d=this.videoService.calls[r];this.videoService.updateRemoteTypeMedia(s.remoteType,d),d&&d.status.key!==o.Status.RELEASING.key&&d.status.key!==o.Status.UNKNOWN.key&&(d.setStatus(o.Status.ACTIVE),t.$broadcast('ON_CALL_UPDATED_EVENT',d)),d.isInitiator&&i.trackCallSuccessNumber(s.localType)},d.prototype.terminatedCall=function(t,o){0===Object.keys(n.connection.jingle.sessions).length&&e.webrtc('INFO    | all calls terminated');var s=this.videoService.calls[t];return s||0===this.videoService.calls.length?void('busy'===o&&this.videoService.openErrorPopup('remoteUserNoMoreAvailable'),this.videoService.autoreleaseTimeout&&a.cancel(this.videoService.autoreleaseTimeout),this.videoService.disableAudioVideoMedia(null,t),this.videoService.createOrUpdateStatisticsForCall(t),this.videoService.callsStats[t]&&delete this.videoService.callsStats[t],s&&('cancel'!==o&&i.trackCallDuration(new Date().getTime()-s.startDate.getTime()),this.videoService.removeCallObject(s)),a(function(){r.resetBusyState()},1e3,1,!0),this.videoService.statsInterval&&(window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),this.videoService.displayWebRTCStats(t)):void e.webrtc('INFO    | terminatedCall : no call with '+t+' exists.')},d.prototype.onJingleError=function(e){var t=this;e&&t.videoService.calls[e]&&t.videoService.calls[e].status!==o.Status.ACTIVE&&(t.videoService.removeCallObject(t.calls[e]),t.videoService.resetToSafeState(),t.videoService.openErrorPopup('IceConnectionFailed'))},d.prototype.iceConnectionStateChange=function(a,s){e.info('[VideoServiceEventHandler] iceConnectionStateChange for '+a);var d=this,c=null,l=d.videoService.calls[s.sid];try{if(s.peerconnection&&'stable'===s.peerconnection.signalingState&&'connected'===s.peerconnection.iceConnectionState){e.webrtc('INFO    | ICE Connection established successfully'),angular.element('#globalAudioTag')[0]&&e.info('[VideoServiceEventHandler] sinkId for globalAudioTag is '+angular.element('#globalAudioTag')[0].sinkId),d.videoService.reconnectCall=!1,c=d.videoService.calls[a],c&&c.status!==o.Status.ACTIVE&&(e.webrtc('INFO    | ICE Connection : call is active now !'),this.activeCall(a)),s.isRenegotiating&&(e.webrtc('INFO    | Renegotiating done'),s.isRenegotiating=!1,t.$broadcast('ON_WEBRTC_CALL_ESCALATION',c),t.$broadcast('ON_WEBRTC_CALL_ESCALATION_SUCCESS',c)),i.endNegotiationTime();var p=i.negotiationTime();p&&(e.webrtc('INFO    | negotiation time: '+p+'ms'),i.trackNegotiationTime()),c&&c.isInitiator&&i.trackICESuccess(a)}s.peerconnection&&'stable'===s.peerconnection.signalingState&&'completed'===s.peerconnection.iceConnectionState&&(e.webrtc('INFO    | ICE Connection completed successfully'),d.videoService.reconnectCall=!1,c=d.videoService.calls[a],c&&c.status!==o.Status.ACTIVE&&(e.webrtc('INFO    | ICE Connection : call is active now !'),this.activeCall(a)),s.isRenegotiating&&(e.webrtc('INFO    | Renegotiating done'),s.isRenegotiating=!1,t.$broadcast('ON_WEBRTC_CALL_ESCALATION',c),t.$broadcast('ON_WEBRTC_CALL_ESCALATION_SUCCESS',c))),s.peerconnection&&'stable'===s.peerconnection.signalingState&&'disconnected'===s.peerconnection.iceConnectionState&&(e.webrtc('INFO    | signalingState disconnected'),l&&l.status!==o.Status.UNKNOWN&&(e.webrtc('INFO    | iceConnectionStateChange go to connecting state'),l.setStatus(o.Status.CONNECTING),t.$broadcast('ON_CALL_UPDATED_EVENT',l)),!d.videoService.connected&&(d.videoService.reconnectCall=!0)),s.peerconnection&&'stable'===s.peerconnection.signalingState&&'failed'===s.peerconnection.iceConnectionState&&(e.webrtc('INFO    | signalingState FAILED'),l&&l.status!==o.Status.UNKNOWN&&(e.webrtc('INFO    | iceConnectionStateChange go to connecting state'),l.setStatus(o.Status.CONNECTING),t.$broadcast('ON_CALL_UPDATED_EVENT',l),t.$broadcast('ON_RECORDING_CNXLOST_EVENT')),!d.videoService.connected&&(d.videoService.reconnectCall=!0))}catch(t){try{e.error('JINGLE  | iceconnectionstatechange error '+t),l?d.videoService.removeCallObject(l,'unsupported-applications'):n.connection.jingle.terminate(null,'unsupported-applications'),r.resetBusyState()}catch(t){e.error('JINGLE  | iceconnectionstatechange error '+t),r.resetBusyState()}}},d.prototype.mediaModified=function(a,i){e.info('[VideoServiceEventHandler] mediaModified '+a);var s=this.videoService.calls[a],d=n.connection.jingle.sessions[a];d.isRenegotiating=!0,s.remoteMedia='sharing'===i?o.Media.AUDIO|o.Media.SHARING:'video'===i?o.Media.AUDIO|o.Media.VIDEO:'sharing+video'===i?o.Media.AUDIO|o.Media.VIDEO|o.Media.SHARING:o.Media.AUDIO,r.setBusyState('dnd',this.videoService.calculatePresenceMessage(s)),t.$broadcast('ON_WEBRTC_CALL_ESCALATION',s)},d}])},function(){angular.module('rainbow').service('webrtcServiceEventHandler',['$log','$q','$rootScope','videoService','webConferenceService','xmppService','contactService','Call',function(e,t,a,r,n,o,i,s){'use strict';var d=this;this.nameSpace='urn:xmpp:jingle-message:0',this.messageHandlerRef=null,this.started=!1,this.start=function(){return this.started=!0,this.attachHandlers(),t.when()},this.stop=function(){return this.started=!1,d.removeHandlers(),t.when()},this.attachHandlers=function(){this.removeHandlers(),e.info('[webrtcServiceEventHandler] attachHandlers'),this.messageHandlerRef||(this.messageHandlerRef=o.addHandler(function(t){try{return d.onMessageReceived(t),!0}catch(t){return e.error('[webrtcServiceEventHandler] caught error '+t),!0}},d.nameSpace,'message'))},this.removeHandlers=function(){e.info('[webrtcServiceEventHandler] removeHandlers'),this.messageHandlerRef&&(o.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null)},this.onMessageReceived=function(t){var a=$(t).attr('from'),s=o.getBareJidFromJid(a),d=$(t).find('propose'),c=d.find('conference'),l=c.attr('id'),p=n.getConferenceSessionById(l);if(p)try{e.info('[webrtcServiceEventHandler]   | onMessageReceived');var u=$(t);if(0<u.find('propose').length){var m=$(t).find('propose').attr('id'),g=$msg({from:i.userContact.fullJid,to:i.userContact.jid}).c('accept',{xmlns:this.nameSpace,id:m});o.send(g);var g=$msg({from:i.userContact.fullJid,to:s}).c('proceed',{xmlns:this.nameSpace,id:m});return o.send(g),!0}}catch(e){return r.videoEventHandler.onMessageReceived(t)}return r.videoEventHandler.onMessageReceived(t)},this.checkSessionAudioSentHealthStatus=function(t){e.info('[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- 0 audio packets sent !');var i=r.calls[t];if(!(i&&!i.isInCallWithMediaPillar())){var d=n.getActiveConferenceSession();if(d&&d.id&&d.active&&'connected'===d.status){var c=n.getRemoteAudioSession(d.id);if(c&&c.sid===t){if(r.callsStatsSimplified[t].numberOfErrorAudioSent+=1,r.callsStatsSimplified[t].numberOfErrorAudioSent%2)return void e.info('[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore');e.info('[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego SFU conference'),n.onAudioProfileChangeEvent()}}}else if(i.status.key===s.Status.ACTIVE.key&&i.localMedia&s.Media.AUDIO&&!i.isMuted){if(r.callsStatsSimplified[t].numberOfErrorAudioSent+=1,r.callsStatsSimplified[t].numberOfErrorAudioSent%2)return void e.info('[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore');var l=o.connection.jingle.sessions[i.id];l&&!l.isRenegotiating&&(e.info('[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego P2P call'),r.renegotiateCurrentCall(i)),a.$broadcast('ON_WEBRTC_CALL_AUDIO_ISSUE',!0)}},this.checkSessionAudioReceivedHealthStatus=function(t){e.info('[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- user hears nothing !');var a=r.calls[t];if(a&&!a.isInCallWithMediaPillar())a.status.key===s.Status.ACTIVE.key&&a.remoteMedia&s.Media.AUDIO&&(r.callsStatsSimplified[t].errorAudioReceived=1,e.info('[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- reset output device'),r.resetAudioOutputElement());else{var o=n.getActiveConferenceSession();if(o&&o.id&&o.active&&'connected'===o.status){var i=n.getRemoteAudioSession(o.id);i&&i.sid===t&&(r.callsStatsSimplified[t].errorAudioReceived=1,e.info('[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- renego SFU conference'),r.resetAudioOutputElement())}}},angular.element(document).bind('callincoming.jingle',function(t,a){e.webrtc('webrtcServiceEventHandler  | callincoming.jingle '+a);var i=o.connection.jingle.sessions[a];i&&i.confId?n.onIncomingCall(a):r.videoEventHandler.incomingCall(a)}),angular.element(document).bind('callterminated.jingle',function(t,o,i){a.$apply(function(){var t=i?i:'';if(e.webrtc('webrtcServiceEventHandler  | callterminated '+o+' reason: '+t),'multi-device'===i)n.onConferenceCallSwitched(o);else{var a=r.calls[o];a?r.videoEventHandler.terminatedCall(o,t):n.onTerminatedCall(o)}})}),angular.element(document).bind('iceconnectionstatechange.jingle',function(t,a,o){if(!o.peerconnection)return void e.webrtc('JINGLE  | iceconnectionstatechange - peerConnection does not exist anymore !!!');e.webrtc('JINGLE  | iceconnectionstatechange '+a+' '+o.peerconnection.iceConnectionState+'|'+o.peerconnection.signalingState);var i=r.calls[a];i?r.videoEventHandler.iceConnectionStateChange(a,o):n.onIceConnectionStateChange(a,o)}),angular.element(document).bind('error.jingle',function(t,a){e.error('JINGLE  | callerror'),a&&a.error&&e.error(JSON.stringify(a.error));var o=a.sid;if(o){var i=r.calls[o];i?r.videoEventHandler.onJingleError(o):n.onJingleError(o)}}),angular.element(document).bind('webrtcSessionStatsSimplyfied.jingle',function(t,n,o){r.callsStatsSimplified[n]||(r.callsStatsSimplified[n]={},r.callsStatsSimplified[n].numberOfErrorAudioSent=0,r.callsStatsSimplified[n].errorAudioReceived=0),o.numberOfErrorAudioSent=r.callsStatsSimplified[n].numberOfErrorAudioSent,o.errorAudioReceived=r.callsStatsSimplified[n].errorAudioReceived,r.callsStatsSimplified[n]=o,e.info('[videoService] on webrtcSessionStatsSimplyfied for session '+n+' : '+JSON.stringify(o)),'chrome'===adapter.default.browserDetails.browser&&71>adapter.default.browserDetails.version&&(0===o.packetsAudioSent||0===o.audioInputLevel?d.checkSessionAudioSentHealthStatus(n):(r.callsStatsSimplified[n].numberOfErrorAudioSent&&a.$broadcast('ON_WEBRTC_CALL_AUDIO_ISSUE',!1),r.callsStatsSimplified[n].numberOfErrorAudioSent=0)),o.packetsAudioReceived&&0===o.audioOutputLevel&&0===o.errorAudioReceived&&d.checkSessionAudioReceivedHealthStatus(n)})}])},function(){angular.module('rainbow').service('settingsService',['$rootScope','$translate','$localStorage',function(e,t,a){'use strict';var r=this;r.initialize=function(){r.defaultLanguage={label:'English',settingCode:'en',code:'en',isoCode:'en',codeMoment:'en',unicode:'1f1ec-1f1e7',beta:!1},r.languages=[r.defaultLanguage,{label:'Fran\xE7ais',settingCode:'fr',code:'fr',isoCode:'fr',codeMoment:'fr',unicode:'1f1eb-1f1f7',beta:!1},{label:'Deutsch',settingCode:'de',code:'de',isoCode:'de',codeMoment:'de',unicode:'1f1e9-1f1ea',beta:!1},{label:'Espa\xF1ol',settingCode:'es-es',code:'es-es',isoCode:'es-ES',codeMoment:'es',unicode:'1f1ea-1f1f8',beta:!1},{label:'Suomi',settingCode:'fi',code:'fi',isoCode:'fi',codeMoment:'fi',unicode:'1f1eb-1f1ee',beta:!0},{label:'Italiano',settingCode:'it',code:'it',isoCode:'it',codeMoment:'it',unicode:'1f1ee-1f1f9',beta:!1},{label:'\u05E2\u05D1\u05E8\u05D9\u05EA',settingCode:'he',code:'he',isoCode:'he',codeMoment:'he',unicode:'1f1ee-1f1f1',beta:!1},{label:'\u65E5\u672C\u8A9E',settingCode:'ja',code:'ja',isoCode:'ja',codeMoment:'ja',unicode:'1f1ef-1f1f5',beta:!1},{label:'\uD55C\uAD6D\uC5B4',settingCode:'ko',code:'ko',isoCode:'ko',codeMoment:'ko',unicode:'1f1f0-1f1f7',beta:!1},{label:'Nederlands',settingCode:'nl',code:'nl',isoCode:'nl',codeMoment:'nl',unicode:'1F1F3-1F1F1',beta:!1},{label:'Nynorsk',settingCode:'no',code:'no',isoCode:'no',codeMoment:'nn',unicode:'1F1F3-1F1F4',beta:!0},{label:'Portugu\xEAs do Brasil',settingCode:'pt-br',code:'pt-BR',isoCode:'pt-BR',codeMoment:'pt-br',unicode:'1F1E7-1F1F7',beta:!1},{label:'Portugu\xEAs',settingCode:'pt-pt',code:'pt-PT',isoCode:'pt-PT',codeMoment:'pt',unicode:'1F1F5-1F1F9',beta:!1},{label:'Polski',settingCode:'pl',code:'pl',isoCode:'pl',codeMoment:'pl',unicode:'1F1F5-1F1F1',beta:!0},{label:'Svenskt',settingCode:'sv-se',code:'sv-SE',isoCode:'sv-SE',codeMoment:'sv',unicode:'1F1F8-1F1EA',beta:!0},{label:'T\xFCrk\xE7e',settingCode:'tr',code:'tr',isoCode:'tr',codeMoment:'tr',unicode:'1f1f9-1f1f7',beta:!1},{label:'\u4E2D\u6587',settingCode:'zh-cn',code:'zh-cn',isoCode:'zh-CN',codeMoment:'zh-cn',unicode:'1f1e8-1f1f3',beta:!1},{label:'\u7E41\u9AD4\u4E2D\u6587',settingCode:'zh-tw',code:'zh-TW',isoCode:'zh-TW',codeMoment:'zh-tw',unicode:'1F1F9-1F1FC',beta:!1}],r.languageCodes=r.getAvailableLanguages().map(function(e){return e.settingCode}),r.settings={init:!0,lang:'en',imSound:'true',imNotif:'true',notifReminder:'gentle',displayOrder:'FL',nbMaxConversations:'100',skin:'rainbow',microphone:'default',headsetMicrophone:null,speakerphoneMicrophone:null,customMicrophone:null,headsetDeviceName:null,speakerphoneDeviceName:null,speaker:'default',headsetSpeaker:null,speakerphoneSpeaker:null,customSpeaker:null,ringingSpeaker:'default',camera:'default',audioProfile:'handfree',currentDevice:null,iceConfig:null,sdk:!1,userWiewOrderType:'lastname',userWiewFilterType:'all',one2oneColors:'true',accessibleColors:'false',autoStartAnimatedGif:'false',translationMsg:'false',server:null,activeAlarm:'relax1',activeNotif:'stairs',devMode:'false',hasSecondRinger:'false',validationMode:'false',disableCalendarPresence:'false',giphy:'false',deviceList:'[]',displayFilesType:'document-cell--as-grid',handFreeInputDeviceName:null,handFreeOutputDeviceName:null,customSpeakerName:null,customMicrophoneName:null,showBodyMessage:'false',bubblesFilterType:'all',bubblesOrderType:'creationDate',isSuggestionsVisible:null,protectionAgainstMailTypeOffline:!1,channelMarkdown:'false',chrisPrankMode:'true',joinSfuSound:'true',disableSingleSignOn:'true',disableSingleSignOnAuthPopup:'true',searchFilterValue:'NoFiltering'},a.get(Object.keys(r.settings)).then(function(o){if(!o.nbMaxConversations)o.nbMaxConversations=r.settings.nbMaxConversations;else{var i=parseInt(o.nbMaxConversations,10);15>i&&r.setSetting('nbMaxConversations',15)}if(o.skin||(o.skin=r.settings.skin),e.default_language&&(o.lang=n(e.default_language),r.setSetting('lang',o.lang)),'default'===o.headsetMicrophone&&(o.headsetMicrophone=null),'default'===o.headsetSpeaker&&(o.headsetSpeaker=null),'default'===o.speakerphoneMicrophone&&(o.speakerphoneMicrophone=null),'default'===o.speakerphoneSpeaker&&(o.speakerphoneSpeaker=null),'default'===o.customMicrophone&&(o.customMicrophone=null),'default'===o.customSpeaker&&(o.customSpeaker=null),null===o.init){var s=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;r.settings.lang=o.lang?o.lang:n(s),a.set(r.settings)}else Object.keys(o).forEach(function(e){null!==o[e]&&(r.settings[e]=o[e])});var d=r.getAppliLanguage();t.use(d.code),moment.locale(d.codeMoment)})},r.getSetting=function(e){return r.settings[e]},r.setSetting=function(e,t){r.settings[e]=t,a.set(r.settings)},r.getAvailableLanguages=function(){return r.languages.filter(function(e){return!1===e.beta||config.betaLanguages})},r.getAppliLanguage=function(){var e=r.getAvailableLanguages().filter(function(e){return e.settingCode===r.settings.lang})[0];return e?e:r.defaultLanguage},r.setAppliLanguageCode=function(a,n){n?r.setSetting('lang',a):r.settings.lang=a;var o=r.getAppliLanguage();moment.locale(o.codeMoment),t.use(o.code).then(function(){e.$broadcast('ON_LANGUAGE_UPDATED_EVENT',a)})},r.getAppliLanguageCodeForServer=function(){var e=r.settings.lang.split('-');return 1===e.length?r.settings.lang:e[0]+'-'+e[1].toUpperCase()},r.setAppliLangageCodeFromServer=function(e){var t=e.split('-'),a=t[0];a&&(a=a.toLowerCase()),2===t.length&&(a+='-'+t[1].toLowerCase()),a=n(a),a=0<=r.languageCodes.indexOf(a)?a:'en',r.setAppliLanguageCode(a)},r.getLanguageByIsoCode=function(e){return r.languages.find(function(t){return t.isoCode===e})},r.getBestLanguageForIsoCode=function(e){var t=r.getLanguageByIsoCode(e);if(!t){if(-1!==e.indexOf('-')){var a=e.split('-')[0];t=r.getLanguageByIsoCode(a)}t||(t=r.getLanguageByIsoCode('en'))}return t},r.setIceConfig=function(e){r.settings.iceConfig=e},r.forceTurn=function(t){config.turnOn=t;var a=t?'Debug mode : Only use turn servers':'Normal mode : use stun and turn servers';e.$broadcast('ON_SETTING_FORCE_TURN_EVENT',a)},r.enableRemoteConsole=function(e){var t=document.createElement('script');t.src='//console.re/connector.js',t.id='consolerescript',t.setAttribute('data-channel',e),t.onreadystatechange=t.onload=function(){app.remoteConsole.info=!0,app.remoteConsole.debug=!0,app.remoteConsole.log=!0,console.re.info('Connected')},document.getElementsByTagName('head')[0].appendChild(t)};var n=function(e){var t='en';if(e){var a=e.split('-')[0];t='en'===a?'en':'fr'===a?'fr':'de'===a?'de':'es'===a?'es-es':'fi'===a?'fi':'it'===a?'it':'he'===a?'he':'ja'===a?'ja':'ko'===a?'ko':'nl'===a?'nl':'no'===a?'no':'pt'===a?'pt-br'===e.toLowerCase()?'pt-br':'pt-pt':'pl'===a?'pl':'sv'===a?'sv-SE':'tr'===a?'tr':'zh'===a?0<=['zh-cn','zh-tw'].indexOf(e.toLowerCase())?e.toLowerCase():'zh-cn':'en'}return t};r.initialize()}])},function(){var e=Number.parseInt;class t{constructor(){this.messages=[],this.complete=!1,this.pageIndex=0,this.isLoading=!1,this.type='AGGREGATE'}}class a{constructor(e,t,a,r,n,o,i,s,d,c,l){this.$q=e,this.$http=t,this.$log=a,this.$rootScope=r,this.authService=n,this.xmppService=o,this.contactService=i,this.Channel=s,this.roomService=d,this.Contact=c,this.profileService=l,this.listeners=[],this.channels={},this.channelsList=[],this.LIST_EVENT_TYPE={ADD:0,UPDATE:1,REMOVE:2,DELETE:3,SUBSCRIBE:4,UNSUBSCRIBE:5,CREATE:6},this.USER_ROLE={NONE:'none',OWNER:'owner',PUBLISHER:'publisher',MEMBER:'member'},this.MESSAGE_ACTION={ADD:0,RETRACT:1},this.xmpp_message_handler=null,this.xmpp_management_handler=null,this.notificationCounter=0,this.messageCounter=0,this.invitationCounter=0,this.CHANNEL_UPDATE_EVENT='CHANNEL_UPDATE_EVENT',this.CHANNEL_MESSAGE_RECEIVED='CHANNEL_MESSAGE_RECEIVED',this.CHANNEL_USERS_UPDATE_EVENT='CHANNEL_USERS_UPDATE_EVENT',this.CHANNEL_NOTIFICATION_NUMBER_UPDATED='CHANNEL_NOTIFICATION_NUMBER_UPDATED',this.CHANNEL_USER_SUBSCRIPTION_EVENT='CHANNEL_USER_SUBSCRIPTION_EVENT'}start(e){return this.$q((t)=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CHANNEL_ACTIVATED))return t();if(this.contactService.userContact.isCPaaSGuest())return t();this.$log.info('[channelService] === STARTING ===');let a=performance.now();this.init(),this.getMyChannels().then(()=>{let r=Math.round(performance.now()-a);this.$log.info('[channelService] === STARTED ('+r+' ms) ==='),e.push({service:'channelService',startDuration:r}),t()}).catch((e)=>{this.$log.info('[channelService] === STARTING FAILURE === '+e.message),t()})})}init(){this.feedChannel=new t,this.portalURL=config.restServerUrl+'/api/rainbow/channels/v1.0/channels',this.attachHandlers(),this.attachListeners()}attachHandlers(){this.$log.info('[channelService] attachHandlers'),this.xmpp_message_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_message_handler),this.xmpp_message_handler=null),this.xmpp_management_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_management_handler),this.xmpp_management_handler=null),this.xmpp_message_handler=this.xmppService.connection.addHandler((e)=>this.onChannelMessageReceived(e),null,'message','headline'),this.xmpp_management_handler=this.xmppService.connection.addHandler((e)=>this.onChannelManagementReceived(e),null,'message','management')}attachListeners(){this.listeners.push(this.$rootScope.$on(this.CHANNEL_USERS_UPDATE_EVENT,(e,t,a)=>this.usersUpdateHandler(e,t,a)))}stop(){return this.$q((e)=>{this.$log.info('[channelService] === STOPPING ==='),this.listeners.forEach((e)=>{e()}),this.channels={},this.channelsList=[],this.feedChannel=null,this.notificationCounter=0,this.$log.info('[channelService] === STOPPED ==='),e()})}reconnect(){return this.$q((e)=>{this.$log.info('[channelService] reconnect'),this.stop(),this.start([]),e()})}removeChannelFromCache(e){return this.$q((t,a)=>{let r=this.getChannelFromCache(e);if(r){let n=r.name;r.invited&&this.decrementInvitationCounter(),delete this.channels[e],this.updateChannelsList(),this.feedChannel.messages=[],this.retrieveLatests().then(()=>{t(n)}).catch((e)=>{a(e)})}})}onChannelMessageReceived(e){try{return this.$rootScope.$apply(()=>{let t=angular.element(e).find('event');if(t&&'http://jabber.org/protocol/pubsub#event'===t.attr('xmlns')){this.$log.info('[channelService] onChannelMessageReceived ');let e=t.find('items'),a=e.find('item'),r=e.find('retract');if(1===a.length)this.onNewMessage(a);else if(1===r.length){let t=r.attr('id'),a=e.attr('node').split(':')[0];this.onRetractMessage(a,t)}}}),!0}catch(e){return this.$log.error('[channelService] onChannelMessageReceived -- failure -- '+e.message),!0}}onNewMessage(e){let t=e.find('entry'),a=e.attr('id'),r=t.attr('channelId'),n=t.attr('creation'),o=n?'modify':'new';this.$log.info('[channelService] onChannelMessageReceived -- '+o+' message '+a+' on channel '+r);let i={id:a,displayId:a+'-'+t.attr('timestamp'),channelId:r,from:t.attr('from'),fromDetails:null,new:!1,entry:{type:t.find('type').length?t.find('type')[0].textContent:'',message:t.find('message').length?t.find('message')[0].textContent:'',title:t.find('title').length?t.find('title')[0].textContent:'',url:t.find('url').length?t.find('url')[0].textContent:'',images:[],attachments:[],video:null},modified:'modify'==o,timestamp:new Date(t.attr('timestamp'))};i.entry.message=i.entry.message.replace(/<a/gi,'<a target=\'_blank\' rel=\'noopener noreferrer\' ');let s=e.find('images');0!==s.length&&s.find('id').each((e,t)=>{i.entry.images.push({id:t.textContent})});let d=e.find('attachments');0!==d.length&&d.find('id').each((e,t)=>{i.entry.attachments.push({id:t.textContent})});let c=e.find('video');0!==c.length&&(i.entry.video={provider:c.find('provider')[0].textContent,id:c.find('id')[0].textContent});let l=this.getChannelFromCache(r);this.contactService.getOrCreateContact(i.from).then((e)=>{if(i.fromDetails={displayName:e.displayName,id:e.dbId,avatar:e.avatar},i.fromContact=e,'new'==o)l.messages.unshift(i),this.feedChannel.messages.unshift(i),this.contactService.userContact.jid!==i.from&&(i.new=!0,this.incrementMessagesCounter()),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.ADD,i);else{let e=l.messages.findIndex((e)=>e.id===a),t=this.feedChannel.messages.findIndex((e)=>e.id===a);-1!==e&&l.messages.splice(e,1,i),-1!==t&&this.feedChannel.messages.splice(t,1,i)}})}onRetractMessage(e,t){this.$log.info('[channelService] onChannelMessageReceived -- retract message '+t+' on channel '+e);let a=this.getChannelFromCache(e),r=a.messages.findIndex((e)=>e.id===t);if(-1!==r){let e=a.messages[r];e.new&&this.decrementMessagesCounter(),a.messages.splice(r,1)}let n=this.feedChannel.messages.findIndex((e)=>e.id===t);-1!==n&&this.feedChannel.messages.splice(n,1),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.RETRACT,t)}onChannelManagementReceived(t){try{return this.$rootScope.$apply(()=>{let a=angular.element(t).find('channel');if(a&&0<a.length){let e=a.attr('channelid'),t=this.getChannelFromCache(e);if(t){let r=a.find('avatar'),n=a.find('name'),o=a.find('topic'),i=a.find('category');r&&0<r.length&&this.onAvatarChange(e,r),n&&0<n.length&&(t.name=n.text()),o&&0<o.length&&(t.topic=o.text()),i&&0<i.length&&(t.category=i.text())}let r=a.attr('action');switch(this.$log.info('[channelService] onChannelManagementReceived -- '+r+' event received on channel '+e),r){case'add':this.onAddToChannel(e);break;case'update':this.onUpdateToChannel(e);break;case'remove':this.onRemovedFromChannel(e);break;case'subscribe':this.onSubscribeToChannel(e,a.attr('subscribers'));break;case'unsubscribe':this.onUnsubscribeToChannel(e,a.attr('subscribers'));break;case'delete':this.onDeleteChannel(e);break;default:}}let r=angular.element(t).find('channel-subscription');if(r&&0<r.length){let t=r.attr('channelid'),a=r.attr('action'),n=r.attr('id'),o=r.attr('subscribers'),i=this.getChannelFromCache(t);switch(i.subscribers_count=e(o),this.$log.info('[channelService] onChannelManagementReceived -- subscription-'+a+' event received on channel '+t),a){case'subscribe':this.onUserSubscribeEvent(t,n);break;case'unsubscribe':this.onUserUnsubscribeEvent(t,n);break;default:}}}),!0}catch(e){return this.$log.error('[channels] onChannelManagementReceived -- failure -- '+e.message),!0}}onAvatarChange(e,t){let a=t.attr('action'),r=t.attr('lastAvatarUpdateDate')?new Date(t.attr('lastAvatarUpdateDate')):null;if(this.$log.info('[channelService] onChannelManagementReceived -- '+a+' avatar for '+e),'delete'===a||'update'===a){let t=this.getChannelFromCache(e);t.lastAvatarUpdateDate=r,null!==r&&(t.avatar=config.restServerUrl+'/api/channel-avatar/'+e+'?size=256&ts='+new Date(r).getTime())}}onUpdateToChannel(e){this.getChannelFromCache(e);this.getChannel(e).then((e)=>{e.invited&&(this.addChannelToCache(e),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,e.id))})}onAddToChannel(e){let t=this.getChannelFromCache(e);this.getChannel(e).then((a)=>{t||a.invited?!t&&a.invited?(this.addChannelToCache(a),this.incrementInvitationCounter(),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,a.id)):t&&a.userRole!==this.USER_ROLE.NONE&&(t.userRole=a.userRole,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,e)})):(this.addChannelToCache(a),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,a.id))})}onRemovedFromChannel(e){this.removeChannelFromCache(e).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,e)})}onSubscribeToChannel(t,a){let r=this.getChannelFromCache(t),n=e(a);r?(r.invited=!1,r.subscribed=!0,r.subscribers_count=n,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,t)})):this.getChannel(t).then((e)=>(this.addChannelToCache(e),this.feedChannel.messages=[],this.retrieveLatests())).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,t)})}onUnsubscribeToChannel(t,a){let r=e(a),n=this.getChannelFromCache(t);n.subscribers_count=r,n.subscribed=!1,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,t)})}onDeleteChannel(e){this.removeChannelFromCache(e).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,e)})}onUserSubscribeEvent(e,t){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,e,t)}onUserUnsubscribeEvent(e,t){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,e,t)}getChannelNextPage(e,t=!1){return this.$q((r,n)=>{let o='AGGREGATE'===e.type?'feedChannel':e.id;if(e.isLoading)return this.$log.info('[channelService] getChannelNextPage('+o+', '+e.pageIndex+') -- ignored (isLoading)'),r();e.isLoading=!0,t&&(e.pageIndex=0);let i=e.messages.length,s=(e.pageIndex+1)*a.PAGE_SIZE;if(s<=e.messages.length)this.$log.info('[channelService] getChannelNextPage('+o+', '+e.pageIndex+') -- success from cache'),e.pageIndex+=1,e.isLoading=!1,r({messages:e.messages,nbMessages:s});else if(e.complete)this.$log.info('[channelService] getChannelNextPage('+o+', '+e.pageIndex+') -- success from cache (complete)'),e.isLoading=!1,r({messages:e.messages,nbMessages:e.messages.length});else{let t=e.messages,i=t.length?t[t.length-1].timestamp:null;this.getChannelMessages(e,i).then((t)=>{t<a.PAGE_SIZE&&(e.complete=!0),this.$log.info('[channelService] getChannelNextPage('+o+', '+e.pageIndex+') -- success from server '+(e.complete?'(complete)':'')+' -- retreive '+t+' message(s)'),e.pageIndex+=1,e.isLoading=!1,r({messages:e.messages,nbMessages:e.messages.length})}).catch((t)=>{e.isLoading=!1,this.channelErrorHandler('getChannelNextPage('+o+', '+e.pageIndex+')',n,t)})}})}getChannelPublishers(e){return this.$q((t,a)=>e.publishersRetreived?t():void this.getChannelUsers(e.id,{format:'full',types:'owner publisher'}).then((a)=>{a.data.forEach((t)=>{let a=this.contactService.getContactByJid(t.jid_im);a||(a=new this.Contact,a.updateFromUserData(t),a.updateRichStatus(),this.contactService.contacts[a.id]=a,this.contactService.dbContacts[a.dbId]=a,this.contactService.jtelContacts[a.jidtel]=a),e.users.push(a)}),e.publishersRetreived=!0,this.$log.info('[channelService] getChannelPublishers ('+e.id+') -- success -- find '+a.length+' publisher(s)'),t()}).catch((t)=>{this.channelErrorHandler('getChannelPublishers ('+e.id+')',a,t)}))}getChannelMessages(e,t){return this.$q((r)=>{let n=null;n='AGGREGATE'===e.type?this.getLatestMessages(10,t):this.getChannelItems(e.id,a.PAGE_SIZE,t),n.then((t)=>{t.forEach((e)=>{'null'===e.entry.images&&(e.entry.images=[]),('null'===e.entry.attachments||e.entry.attachments===void 0)&&(e.entry.attachments=[]),e.entry.attachments instanceof Array||(e.entry.attachments=[e.entry.attachments]),e.entry.message&&(e.entry.message=e.entry.message.replace(/<a/gi,'<a target=\'_blank\' rel=\'noopener noreferrer\' '));e.entry.message?e.entry.message:'';this.contactService.getOrCreateContact(e.from).then((t)=>{e.fromDetails={displayName:t.displayName,id:t.dbId,avatar:t.avatar},e.fromContact=t})}),e.messages.push.apply(e.messages,t),r(t.length)})})}getMyChannels(){return this.$q((e,t)=>{this.$http({method:'GET',url:this.portalURL+'?format=full',headers:this.authService.getRequestHeader()}).then((t)=>{this.$log.info('[channelService] getMyChannels -- success'),t.data.data.forEach((e)=>{let t=this.Channel(e);t.invited&&this.incrementInvitationCounter(),(t.subscribed||t.invited)&&(this.channels[t.id]=t)}),this.updateChannelsList(),e(this.channelsList)}).catch((e)=>{this.channelErrorHandler('getMyChannels',t,e)})})}createChannel(e,t,a='',r='globalnews',n=!1,o=100){return this.$q((i,s)=>{let d=this.portalURL+(n?'?auto_provisioning=true':'');this.$http({method:'POST',url:d,headers:this.authService.getPostHeader(),data:{name:e,mode:t,topic:a,category:r,max_items:o}}).then((a)=>{this.$log.info('[channelService] createChannel -- '+e+' -- '+t+' -- success');let r=this.Channel(a.data.data);i(r)}).catch((a)=>{this.channelErrorHandler('createChannel -- '+e+' -- '+t,s,a)})})}deleteChannel(e){return this.$q((t,a)=>{this.$http({method:'DELETE',url:this.portalURL+'/'+e,headers:this.authService.getPostHeader()}).then((a)=>{this.$log.info('[channelService] deleteChannel -- '+e+' -- success'),t(a)}).catch((t)=>{this.channelErrorHandler('deleteChannel ('+e+')',a,t)})})}findChannels(e){return this.$q((t,a)=>{let r='?sortOrder='+(e.sortOrder&&1===e.sortOrder?'1':'-1');e.subscribed!==void 0&&(r+='&subscribed='+e.subscribed),e.name&&(r+='&name='+e.name),e.topic&&(r+='&topic='+e.topic),e.limit&&(r+='&limit='+e.limit),e.offset&&(r+='&offset='+e.offset),e.sortField&&(r+='&sortField='+e.sortField),e.category&&(r+='&category='+e.category),this.$http({method:'GET',url:this.portalURL+'/search'+r,headers:this.authService.getRequestHeader()}).then((e)=>{let a=[];e.data.data.forEach((e)=>{a.push(this.Channel(e))}),t(a)}).catch((e)=>{this.channelErrorHandler('findChannels ('+r+')',a,e)})})}browseChannels(e){return this.$q((t,a)=>{let r='?sortOrder='+(e.sortOrder&&1===e.sortOrder?'1':'-1');e.category&&(r+='&category='+e.category),e.excluded_category&&(r+='&excluded_category='+e.excluded_category),e.subscribed!==void 0&&(r+='&subscribed='+e.subscribed),e.limit&&(r+='&limit='+e.limit),e.offset&&(r+='&offset='+e.offset),e.sortField&&(r+='&sortField='+e.sortField),this.$http({method:'GET',url:this.portalURL+'/browse'+r,headers:this.authService.getRequestHeader()}).then((e)=>{let a=[];e.data.data.forEach((e)=>{a.push(this.Channel(e))}),t(a)}).catch((e)=>{this.channelErrorHandler('browseChannels ('+r+')',a,e)})})}getChannel(e){return this.$q((t,a)=>{this.$http({method:'GET',url:this.portalURL+'/'+e,headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[channelService] getChannel -- '+e+' -- success');let r=this.Channel(a.data.data);t(r)}).catch((t)=>{this.channelErrorHandler('getChannel ('+e+')',a,t)})})}getChannelFromCache(e){let t=this.channels[e];return t===void 0?null:t}publishToChannel(e,t,a,r,n,o,i,s,d){return this.$q((o,c)=>{let l={type:a,title:n||'',message:r||'',images:i||[],attachments:d||[]},p=t?'?itemId='+t:'';s&&(l.video=s),this.$http({method:'POST',url:this.portalURL+'/'+e+'/publish'+p,headers:this.authService.getRequestHeader(),data:l}).then((t)=>{this.$log.info('[channelService] publishToChannel -- '+e+' -- '+a+' -- success'),o(t)}).catch((t)=>{this.channelErrorHandler('publishToChannel ('+e+')',c,t)})})}subscribeToChannel(e){return this.$q((t,a)=>{this.$http({method:'POST',url:this.portalURL+'/'+e.id+'/subscribe',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[channelService] subscribeToChannel -- '+e.id+' -- success'),e.subscribed=!0,e.users_count+=1,t(a)}).catch((t)=>{this.channelErrorHandler('subscribeToChannel ('+e.id+')',a,t)})})}unsubscribeToChannel(e){return this.$q((t,a)=>{this.$http({method:'DELETE',url:this.portalURL+'/'+e.id+'/subscribe',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[channelService] unsubscribeToChannel -- success'),e.subscribed=!1,e.users_count-=1,t(a)}).catch((e)=>{this.channelErrorHandler('unsubscribeToChannel',a,e)})})}updateChannel(e,t){return this.$q((a,r)=>{this.$http({method:'PUT',url:this.portalURL+'/'+e,headers:this.authService.getPostHeader(),data:t}).then((t)=>{let r=this.getChannelFromCache(e);r.name=t.data.data.name,r.topic=t.data.data.topic,r.category=t.data.data.category,this.$log.info('[channelService] updateChannel ( '+e+') -- success'),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UPDATE,r.id),a(r)}).catch((t)=>{this.channelErrorHandler('updateChannel ('+e+')',r,t)})})}getChannelItems(e,t,a=null,r=null){return this.$q((n,o)=>{this.$http({method:'GET',url:this.portalURL+'/'+e+'/items',headers:this.authService.getRequestHeader(),params:{max:t,before:a,after:r}}).then((e)=>{this.$log.info('[channelService] getChannelItems -- success'),this.chewReceivedItems(e.data.data.items),n(e.data.data.items)}).catch((e)=>{this.channelErrorHandler('getChannelItems',o,e)})})}deleteChannelItem(e,t){return this.$q((a,r)=>{this.$http({method:'DELETE',url:this.portalURL+'/'+e+'/items/'+t,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info('[channelService] deleteChannelItem ('+e+') -- success'),a()}).catch((t)=>{this.channelErrorHandler('deleteChannelItem ('+e+')',r,t)})})}getChannelUsers(e,t){return this.$q((a,r)=>{let n={};t&&(t.format&&'string'==typeof t.format&&t.format.length&&(n.format=t.format),t.types&&'string'==typeof t.types&&t.types.length&&(n.types=t.types),t.limit&&'number'==typeof t.limit&&0<t.limit&&(n.limit=t.limit),t.offset&&'number'==typeof t.offset&&0<t.offset&&(n.offset=t.offset),t.sortField&&'string'==typeof t.sortField&&t.sortField.length&&(n.sortField=t.sortField),t.sortOrder&&('-1'===t.sortOrder||'1'===t.sortOrder)&&(n.sortOrder=t.sortOrder)),this.$http({method:'GET',url:this.portalURL+'/'+e+'/users',headers:this.authService.getRequestHeader(),params:n}).then((t)=>{this.$log.info('[channelService] getChannelUsers ('+e+') -- success'),a(t.data)}).catch((t)=>{this.channelErrorHandler('getChannelUsers ('+e+')',r,t)})})}searchUsersByName(e,t,a){return a.displayName=t,this.$q((t,r)=>{this.$http({method:'GET',url:this.portalURL+'/'+e+'/users/search',headers:this.authService.getRequestHeader(),params:a}).then((a)=>{this.$log.info('[channelService] searchUsersByName ('+e+' -- success'),t(a.data.data)}).catch((t)=>{this.channelErrorHandler('searchUsersByName ('+e+')',r,t)})})}deleteChannelAvatar(e){return this.$q((t,a)=>{this.$http({method:'DELETE',url:this.portalURL+'/'+e+'/avatar',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[channelService] deleteChannelAvatar '+e+' -- success'),t(a)}).catch((t)=>{this.channelErrorHandler('deleteChannelAvatar '+e,a,t)})})}uploadChannelAvatar(e,t,a){return this.$q((r,n)=>{this.roomService.resizeImage(t,a,a).then((t)=>{var a=this.roomService.getBinaryData(t);this.$http({method:'POST',url:this.portalURL+'/'+e+'/avatar',headers:this.authService.getPostHeader('image/'+a.type),data:a.data,transformRequest:[]}).then((t)=>{this.$log.info('[channelService] uploadChannelAvatar '+e+' -- success'),r(t)}).catch((e)=>{this.channelErrorHandler('uploadChannelAvatar',n,e)})})})}updateChannelUsers(e,t,a){return this.$q((r,n)=>{let o=t.map((e)=>({id:e.dbId,type:a}));this.$http({method:'PUT',url:this.portalURL+'/'+e+'/users',headers:this.authService.getRequestHeader(),data:{data:o}}).then((t)=>{this.$log.info('[channelService] updateChannelUsers -- success');let a=t.data.data;this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,e,a),r(a)}).catch((e)=>{this.channelErrorHandler('updateChannelUsers',n,e)})})}usersUpdateHandler(e,t,a){let r=this.getChannelFromCache(t);if(null!==a&&(r.users_count+=a.added.length-a.removed.length,r.users.length)){for(let e=0;e<a.added.length;e++)this.contactService.getContactByDBId(a.added[e]).then((e)=>{r.users.push(e)});for(let e=0;e<a.removed.length;e++)for(let t=r.users.length-1;0<=t;t--)if(r.users[t].dbId===a.removed[e]){r.users.splice(t,1);break}}}retrieveUsers(e){if(this.$log.info('Retrieving users'),0===e.users.length&&e.userRole===this.USER_ROLE.OWNER){let t=this.contactService.userContact,a;return t.type='owner',this.getChannelUsers(e.id,{format:'full',types:'publisher',limit:19}).then((t)=>(a=t.data.length?t.data:[],19>a.length?this.getChannelUsers(e.id,{format:'full',types:'member',limit:19-a.length}):[])).then((r)=>{a.push.apply(a,r.data);const n=a;return this.usersToContacts(n).then((a)=>(e.users=a,e.users.unshift(t),a))})}return this.$q.resolve(null)}usersToContacts(e){if(null!==e){let t=[];for(let a=0,r;a<e.length;a++)r=this.Contact.create(e[a].jid_im,e[a].firstName,e[a].lastName,e[a].company,e[a].loginEmail),r.dbId=e[a].id,r.lastAvatarUpdateDate=e[a].lastAvatarUpdateDate,r.type=e[a].type||e[a].affiliation,t.push(r.getAvatar());return this.$q.all(t).then((e)=>e)}}retrieveMessages(e){return e.messageRetrieved?this.$q.resolve(null):this.getChannelItems(e.id,100,null,null).then((t)=>{e.messages=t;let a=[];var r=Array.from(new Set(e.messages.map((e)=>e.from)));for(let e=0,n;e<r.length;e++)n=this.contactService.getOrCreateContact(r[e]),a.push(n);return this.$q.all(a).then((t)=>{for(let a=0,r;a<e.messages.length;a++)r=t.find((t)=>t.id===e.messages[a].from),e.messages[a].fromDetails={displayName:r.displayName,id:r.dbId,avatar:r.avatar},e.messages[a].fromContact=r;return e.messageRetrieved=!0,this.$q.resolve(e.messages)})})}retrieveLatests(e=null){return this.getLatestMessages(10,e,null).then((e)=>(this.feedChannel.messages.push.apply(this.feedChannel.messages,e),e.length))}incrementMessagesCounter(){this.messageCounter+=1,this.updateNotificationCounter()}decrementMessagesCounter(){this.messageCounter-=1,this.updateNotificationCounter()}incrementInvitationCounter(){this.invitationCounter+=1,this.updateNotificationCounter()}decrementInvitationCounter(){this.invitationCounter-=1,this.updateNotificationCounter()}ackMessages(){this.messageCounter=0,this.updateNotificationCounter(),this.feedChannel.messages.forEach((e)=>{e.new=!1})}updateNotificationCounter(){this.notificationCounter=this.messageCounter+this.invitationCounter,0>this.notificationCounter&&(this.notificationCounter=0),this.$rootScope.$broadcast(this.CHANNEL_NOTIFICATION_NUMBER_UPDATED,this.notificationCounter)}removeAllUsersFromChannel(e){return this.$q((t,a)=>{this.$http({method:'DELETE',url:this.portalURL+'/'+e+'/users',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[channelService] Removed all users from channel -- success'),this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,e,null),t(a)}).catch((e)=>{this.channelErrorHandler('removeAllUsersFromChannel',a,e)})})}getPortalInfos(){return this.$q((e,t)=>{this.$http({method:'GET',url:config.restServerUrl+'/api/rainbow/channels/v1.0/about',headers:this.authService.getRequestHeader()}).then((t)=>{this.$log.info('[channelService] successfully retrieved portal infos -- success'),e(t.data)}).catch((e)=>{this.channelErrorHandler('getPortalInfos',t,e)})})}getLatestMessages(e,t=null,a=null){return this.$q((r,n)=>{this.$http({method:'GET',url:this.portalURL+'/latest-items',headers:this.authService.getRequestHeader(),params:{max:e,before:t,after:a}}).then((e)=>{this.chewReceivedItems(e.data.data.items),r(e.data.data.items)}).catch((e)=>{this.channelErrorHandler('getLatestMessages',n,e)})})}acceptInvitation(e){return this.$q((t,a)=>{this.$http({method:'PUT',url:this.portalURL+'/'+e+'/accept',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[channelService] acceptInvitation ('+e+') -- success'),this.decrementInvitationCounter(),t(a)}).catch((e)=>{this.channelErrorHandler('acceptInvitation',a,e)})})}declineInvitation(e){return this.$q((t,a)=>{this.$http({method:'PUT',url:this.portalURL+'/'+e+'/decline',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[channelService] declineInvitation ('+e+') -- success'),this.decrementInvitationCounter(),t(a)}).catch((e)=>{this.channelErrorHandler('declineInvitation',a,e)})})}chewReceivedItems(e){e.forEach((e)=>{'urn:xmpp:channels:simple'===e.type&&(e.entry={message:e.message},delete e.message),e.displayId=e.id+'-'+e.timestamp,e.modified=e.creation!==void 0})}updateChannelsList(){this.channelsList=Object.keys(this.channels).map((e)=>this.channels[e])}addChannelToCache(e){this.channels[e.id]=e,this.updateChannelsList()}channelErrorHandler(e,t,a){let r=null;a.data?(this.$log.error('[channelService] '+e+' -- failure -- '+a.data.errorDetails),r=new RBError(a.data.errorMsg,a.data.errorDetails,a.data.errorDetailsCode)):(this.$log.error('[channelService] '+e+' -- failure -- Server failure'),r=new RBError('Server failure')),t(r)}}a.PAGE_SIZE=10,a.$inject=['$q','$http','$log','$rootScope','authService','xmppService','contactService','Channel','roomService','Contact','profileService'],angular.module('rainbow').service('channelService',a)},function(){},function(){angular.module('rainbow').service('companyService',['$q','$log','$http','$rootScope','authService','errorHelperService','userInfoService','Company',function(e,t,a,r,n,o,i,s){'use strict';var d=this;d.start=function(a){t.info(''),t.info('[companyService] === STARTING ===');var n=performance.now();d.portalURL=config.restServerUrl+'/api/rainbow/enduser/v1.0/',d.companies={};var o=Math.round(performance.now()-n);return a.push({service:'companyService',startDuration:o}),t.info('[companyService] === STARTED ('+o+' ms) ==='),r.$on('$destroy',r.$on('ON_COMPANY_CHANGE_EVENT',function(e,t){d.getCompanyById(t,!0)})),e.when()},d.stop=function(){return t.info(''),t.info('[companyService] === STOPPING ==='),t.info('[companyService] === STOPPED ==='),d.companies={},e.when()},d.searchCompanies=function(r,i,c,l){return e(function(e,p){var u=d.portalURL+'companies?name='+r+'&format=full';i!==void 0&&null!==i&&(u+='&hasBP='+i),c!==void 0&&null!==c&&(u+='&isBP='+c),l&&(u+='&bpType='+l),a({method:'GET',url:u,headers:n.getRequestHeader()}).then(function(a){var n=a.data.data,o=[];angular.forEach(n,function(e){if('Default'!==e.name&&'Rainbow'!==e.name&&'active'===e.status){var t=d.companies[e.id];t||(t=s.createFromData(e),d.companies[t.id]=t,d.getCompanyLogo(t)),o.push(t)}}),t.info('[companyService] searchCompanies with criteria \''+r+'\' - success - found '+n.length+' companies : returns '+o.length+' companies'),e(o)},function(e){var a=o.handleError(e);t.error('[companyService] '+o.getErrorFullMessage(e,'searchCompanies')),p(a)})})},d.getCompanyById=function(r,i){return e(function(e,c){if(!r)return t.error('[companyService] getCompanyById -- missing companyId'),void c(new Error('[companyService] getCompanyById -- missing companyId'));var l=d.companies[r];l&&!i?(t.info('[companyService] getCompanyById (cache) '+r+' - success'),e(l)):a({method:'GET',url:d.portalURL+'companies/'+r,headers:n.getRequestHeader()}).then(function(a){var n=a.data.data;l?(l.updateFromData(n),t.info('[companyService] getCompanyById (update) '+r+' - success')):(l=s.createFromData(n),d.companies[l.id]=l,t.info('[companyService] getCompanyById '+r+' - success')),d.getCompanyLogo(l),d.getCompanyBanner(l),e(l)},function(e){var a=o.handleError(e);t.error('[companyService] '+o.getErrorFullMessage(e,'getCompanyById')),c(a)})})},d.getAdministratorIds=function(r){return e(function(e,i){var s=d.portalURL+'companies/'+r+'/administrators';a({method:'GET',url:s,headers:n.getRequestHeader()}).then(function(a){var r=a.data.data,n=[];r.forEach(function(e){n.push(e.id)}),t.info('[companyService] getAdministratorIds success)'),e(n)},function(e){var a=o.handleError(e);t.error('[companyService] '+o.getErrorFullMessage(e,'getAdministratorIds')),i(a)})})},d.getCompanyLogo=function(a){return e(function(e,n){var o=i.computeUserColor(a.name),s=a.name.substr(0,1);i.getAvatarImage(a.id,s,o.color,130,a.lastAvatarUpdateDate).then(function(n){a.logo=n,r.$broadcast('ON_COMPANY_LOGO_UPDATED',a.id),t.info('[companyService] getCompanyLogo - '+a.getNameForLogs()+' - success'),e(n)}).catch(function(e){t.error('[companyService] getCompanyLogo - failure - '+e.message),n(e)})})},d.getCompanyBanner=function(a){return e(function(e){var n=new Image;if(!a.lastBannerUpdateDate)n.src='/cache/images/company-banner-01.svg',a.banner=n,r.$broadcast('ON_COMPANY_BANNER_UPDATED',a.id),t.log('[companyService] Load default banner for '+a.getNameForLogs()+' success'),e(n);else{var o=config.webservices.protocol+'://'+config.webservices.currentServer;r.cdn&&(o=r.cdnServer);var i=o+'/api/banner/'+a.id+'?size=831';i+='&update='+MD5.hexdigest(a.lastBannerUpdateDate),n.onload=function(){var n=this;r.$apply(function(){a.banner=n,r.$broadcast('ON_COMPANY_BANNER_UPDATED',a.id),t.log('[companyService] Load banner for '+a.getNameForLogs()+' success'),e(n)})},n.onerror=function(){r.$apply(function(){t.warn('[companyService] Load banner for '+a.getNameForLogs()+' failure'),e(null)})},n.src=i}})}}])},function(){(function(){'use strict';angular.module('rainbow').service('browserService',[function(){this.extractBrowserVersion=function(e,t,a){var r=e.match(t);return r&&r.length>=a&&parseInt(r[a],10)}}])})()},function(){angular.module('rainbow').service('gRTCStatsService',[function(){'use strict';var e={};this.resetStatsForAllCalls=function(){e={}},this.resetStatsForCall=function(t){t in e&&delete e[t]},this.getCalls=function(){return e},this.nbCalls=function(){return Object.keys(e).length},this.hasStatsForCall=function(t){return t in e},this.addStreamToCall=function(t,a){t in e||(e[t]={});var r=e[t];r[a.id]={},r[a.id].stream=a},this.nbStreamsInACall=function(t){return t in e?Object.keys(e[t]).length:0},this.getBundlePolicyForCall=function(t){if(!(t in e))return'unknown';var a=e[t],r=0,n=this.nbStreamsInACall(t);for(var o in a)'selectedCandidatePairId'in a[o].stream&&r++;return 4===n?0==r?'failed':1==r?'max-bundle':2==r?'balanced':4==r?'max-compat':'unknown':2===n?0==r?'failed':1==r?'max-bundle':2==r?'max-compat':'unknown':'unknown'},this.addSSRCToStream=function(t,a){var r=null,n=null;'ssrc'===a.type&&t in e&&(r=e[t],a.transportId in r&&(n=r[a.transportId],!n.ssrc&&(n.ssrc={}),n.ssrc[a.ssrc]=a))},this.hasSSRCInStream=function(t,a,r){var n=null,o=null;return!!(t in e)&&(n=e[t],!!(a in n))&&(o=n[a],!!o.ssrc&&r in o.ssrc)},this.getSSRCMediaType=function(t,a,r){var n=null,o=null,i=null;return t in e?(n=e[t],!(a in n))?'unknown':(o=n[a],!o.ssrc)?'unknown':r in o.ssrc?(i=o.ssrc[r],i.mediaType):'unknown':'unknown'},this.getSSRCDirection=function(a,r,n){var o=null,i=null,s=null;return a in e?(o=e[a],!(r in o))?'unknown':(i=o[r],!i.ssrc)?'unknown':n in i.ssrc?(s=i.ssrc[n],t(s.id)):'unknown':'unknown'},this.getSSRCAudioCodecName=function(t,a,r){var n=null,o=null,i=null;return t in e?(n=e[t],!(a in n))?'unknown':(o=n[a],!o.ssrc)?'unknown':r in o.ssrc?(i=o.ssrc[r],i.googCodecName):'unknown':'unknown'},this.isSSRCFlowing=function(a,r,n){var o=null,i=null,s=null;if(!(a in e))return!1;if(o=e[a],!(r in o))return!1;if(i=o[r],!i.ssrc)return!1;if(!(n in i.ssrc))return!1;s=i.ssrc[n];var d=t(s.id),c=0;return c='IN'===d?parseInt(s.bytesReceived,10):parseInt(s.bytesSent,10),0<c},this.getStreamsDetailsFromCall=function(t){var a=null,r=null;if(!(t in e))return[];a=e[t];var n=[];for(var o in a)if(a.hasOwnProperty(o)){r=a[o];var i='no',s='no',d=!1,c=!1,l=!1,p=!1;for(var u in r.ssrc)if(r.ssrc&&r.ssrc.hasOwnProperty&&r.ssrc.hasOwnProperty(u)){var m=this.getSSRCMediaType(t,o,u),g=this.getSSRCDirection(t,o,u),v=this.isSSRCFlowing(t,o,u);'audio'===m&&'IN'===g&&v?d=!0:'audio'===m&&'OUT'===g&&v?l=!0:'video'===m&&'IN'===g&&v?c=!0:'video'===m&&'OUT'===g&&v&&(p=!0)}d&&l?i='IN|OUT':d?i='IN':l&&(i='OUT'),c&&p?s='IN|OUT':c?s='IN':p&&(s='OUT'),d||l||c||p?n.push({id:o,streams:{audio:i,video:s}}):n.push({id:o,streams:{}})}return n},this.getCodecDetailsFromCall=function(t){var a=null,r=null,n='-',o='-',i={codec:{audio:n,video:o}};if(!(t in e))return i;for(var s in a=e[t],a)if(a.hasOwnProperty(s))for(var d in r=a[s],r.ssrc)'audio'===r.ssrc[d].mediaType&&(n=this.getSSRCAudioCodecName(t,s,d)),'video'===r.ssrc[d].mediaType&&(o=this.getSSRCAudioCodecName(t,s,d));return i.codec.audio=n,i.codec.video=o,i};var t=function(e){return-1<e.indexOf('recv')?'IN':'OUT'}}])},function(){angular.module('rainbow').service('fRTCStatsService',[function(){'use strict';var e={};this.getCalls=function(){return e},this.nbCalls=function(){return Object.keys(e).length},this.addStreamToCall=function(t,a){if(!a.isRemote){t in e||(e[t]={});var r=e[t];r.streams||(r.streams={}),r.streams[a.id]={},r.streams[a.id]=a}},this.nbStreamsInACall=function(t){return t in e?Object.keys(e[t].streams).length:0},this.resetStatsForAllCalls=function(){e={}},this.resetStatsForCall=function(t){t in e&&delete e[t]},this.hasStatsForCall=function(t){return t in e},this.hasSSRCInStream=function(t,a,r){var n=null,o=null;return!!(t in e)&&(n=e[t],!!n.streams)&&!!(a in n.streams)&&(o=n.streams[a],o.ssrc===r)},this.hasStreamInCall=function(t,a){var r=null;return!!(t in e)&&(r=e[t],a in r.streams)},this.getSSRCMediaType=function(t,a){var r=null,n=null;return t in e?(r=e[t],!(a in r.streams))?'unknown':(n=r.streams[a],n.mediaType):'unknown'},this.getStreamsDetailsFromCall=function(a){var r=null;if(!(a in e))return[];r=e[a];var n=[];for(var o in r.streams)if(r.streams.hasOwnProperty(o)){var i=this.getSSRCMediaType(a,o),s=t(o);'audio'===i?n.push({id:o,streams:{audio:s}}):'video'===i&&n.push({id:o,streams:{video:s}})}return n},this.addCandidatePairToCall=function(t,a){var r=null,n=!1;if(t in e){r=e[t],r.candidatesPairs||(r.candidatesPairs=[]);for(var o=0;o<r.candidatesPairs.length;o++)if(r.candidatesPairs[o].id===a.id){n=!0;break}!n&&'succeeded'===a.state&&a.selected&&r.candidatesPairs.push(a)}},this.getNbCandidatePairs=function(t){var a=null,r=0;return t in e?(a=e[t],a.candidatesPairs&&(r=a.candidatesPairs.length),r):r},this.getBundlePolicyForCall=function(t){var a='unknown';if(!(t in e))return a;switch(this.getNbCandidatePairs(t)){case 0:a='failed';break;case 1:a='max-bundle';break;case 2:a=2<this.nbStreamsInACall(t)?'balanced':'max-compat';break;default:a='max-compat';}return a};var t=function(e){return-1<e.indexOf('inbound')?'IN':'OUT'}}])},function(){var e=Math.round;angular.module('rainbow').service('platformService',['$log','$rootScope','$window','$interval','settingsService','$q','$filter','$http','authService','errorHelperService',function(t,a,r,n,o,s,d,i,c,l){'use strict';function p(e){T!==e&&(t.info('[PlatformService] Handfree is now '+(e?'available':'unavailable')),T=e,y.HANDFREE.available=e,a.$broadcast('ON_AUDIO_PROFILE_CHANGED_EVENT',e),a.$broadcast('ON_INPUT_DEVICE_CHANGED_EVENT'),!e&&h.getCurrentSpeaker().then(function(e){C(e.id)}))}function u(e){if(I!==e){if(t.info('[PlatformService] Headset is now '+(e?'available':'unavailable')),I=e,y.HEADSET.available=e,!e){var r=o.getSetting('audioProfile');r===y.HEADSET.value&&o.setSetting('audioProfile',y.HANDFREE.value),h.getCurrentSpeaker().then(function(e){C(e.id)})}else{var r=o.getSetting('audioProfile');r===y.HANDFREE.value&&(o.setSetting('audioProfile',y.HEADSET.value),h.getCurrentSpeaker().then(function(e){C(e.id)}))}a.$broadcast('ON_AUDIO_PROFILE_CHANGED_EVENT',e),a.$broadcast('ON_INPUT_DEVICE_CHANGED_EVENT')}}function m(e){N!==e&&(t.info('[PlatformService] Speakerphone is now '+(e?'available':'unavailable')),N=e,y.SPEAKERPHONE.available=e,a.$broadcast('ON_AUDIO_PROFILE_CHANGED_EVENT',e),a.$broadcast('ON_INPUT_DEVICE_CHANGED_EVENT'),!e&&h.getCurrentSpeaker().then(function(e){C(e.id)}))}function g(e){A!==e&&(t.info('[PlatformService] Custom is now '+(e?'available':'unavailable')),A=e,y.CUSTOM.available=e,a.$broadcast('ON_AUDIO_PROFILE_CHANGED_EVENT',e),a.$broadcast('ON_INPUT_DEVICE_CHANGED_EVENT'),!e&&h.getCurrentSpeaker().then(function(e){C(e.id)}))}function v(){return f(),h.isAskingMedia?void t.info('[PlatformService] onAudioInputChange -- already asking media -- ignore'):void(h.isAskingMedia=!0,n(h.testGetUserMedia,2e3,1))}function f(){p(h.isHandfreeAvailable()),u(h.isHeadsetAvailable()),m(h.isSpeakerphoneAvailable()),g(h.isCustomAvailable())}function S(e,a){f(),t.info('[PlatformService] updateOutputDevice '+a),h.allowDevicesManagement()&&a&&C(a)}function C(e){t.info('[PlatformService] updateCurrentOutputDevice '+e),angular.element('#globalAudioTag')[0]&&angular.element('#globalAudioTag')[0].sinkId!==e&&O!==e?(O=e,t.info('[PlatformService] updateCurrentOutputDevice current ID '+angular.element('#globalAudioTag')[0].sinkId+' new id '+e),h.setSpeakerForElement(angular.element('#globalAudioTag')[0],'default').then(function(){h.setSpeakerForElement(angular.element('#globalAudioTag')[0],e),O=''}).catch(function(){O=''})):t.info('[PlatformService] updateCurrentOutputDevice -- ignored ')}var h=this,E=[];h.$q=s,this.isWin=0<=navigator.platform.toUpperCase().indexOf('WIN'),h.start=function(r){return s(function(o){var i=performance.now();t.info(''),t.info('[platformService] === STARTING ==='),h.languages=['en','fr','es','de','it'],E.push(a.$on('$translateChangeSuccess',function(){h.fixDeviceLabels()})),E.push(a.$on('ON_INPUT_DEVICE_CHANGED_EVENT',v)),E.push(a.$on('ON_OUTPUT_DEVICE_CHANGED_EVENT',S)),E.push(a.$on('ON_CONNECTION_STATE_CHANGE_EVENT',h.onAuthenticationStatusChangedEvent)),h.isAskingMedia=!1,h.hasAudioPermission=!1,h.hasVideoPermission=!1,h.stopWatcher(),n(h.startWatcher,2e3,1);var s=e(performance.now()-i);r.push({service:'platformService',startDuration:s}),t.info('[platformService] === STARTED ('+s+' ms) ==='),o()})},h.stop=function(){return t.info('[platformService] === STOPPING ==='),E.forEach(function(e){e()}),h.stopWatcher(),this.mediaDevicesLength=0,this.mediaDevices=[],t.info('[platformService] === STOPPED ==='),s.when()},h.onAuthenticationStatusChangedEvent=function(e,a){'connected'===a&&(h.allowDevicesManagement()&&angular.element('#globalAudioTag')[0]&&(!angular.element('#globalAudioTag')[0].sinkId||'default'===angular.element('#globalAudioTag')[0].sinkId)&&(t.info('[platformService] onAuthenticationStatusChangedEvent -- update global audio tag'),h.getCurrentSpeaker().then(function(e){e&&e.id&&C(e.id)})),h.testGetUserMedia())},this.audioDevices=0,this.videoDevices=0,this.detectRTCLoaded=function(){h.hasAudioPermission=DetectRTC.isWebsiteHasMicrophonePermissions,h.hasVideoPermission=DetectRTC.isWebsiteHasWebcamPermissions,h.fixDeviceLabels();var e=!1,a=!1,r=h.shouldAskGetUserMedia();(DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length||DetectRTC.audioOutputDevices&&DetectRTC.audioOutputDevices.length)&&(!h.hasAudioPermission||r.audio?e=!0:b=!0),DetectRTC.videoInputDevices&&DetectRTC.videoInputDevices.length&&(!h.hasVideoPermission||r.video?a=!0:R=!0),e||a?!h.isAskingMedia&&(h.isAskingMedia=!0,h.getUserMedia(e,a)):(h.fixDeviceLabels(),k().then(function(){h.isDesktop()&&h.updateNewDesktopDevicesIds(),f(),h.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(h.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,h.audioMediaDeviceUpdated()),h.videoDevices!==DetectRTC.videoInputDevices.length&&(h.videoDevices=DetectRTC.videoInputDevices.length,h.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(e){e&&t.info('[PlatformService] DetectRTC.MediaDevices device '+e.id+' with kind '+e.kind+' with label '+e.label)}),h.getCurrentSpeaker().then(function(e){C(e.id)}),h.newDevice&&h.checkAndUpdateHandFreeProfile(),h.startWatcher()}))},this.testGetUserMedia=function(){if(!h.hasAudioPermission)return void t.info('[PlatformService] testGetUserMedia -- no audio permission given');var a=performance.now();h.getCurrentMicrophone().then(function(r){var n={},o='default';r?(n.audio={optional:[{sourceId:r.id}]},o='id - '+r.id+' and label '+r.label):n.audio=!0,t.info('[PlatformService] testGetUserMedia -- getUserMedia for Mic '+o),navigator.mediaDevices.getUserMedia(n).then(function(r){var n=e(performance.now()-a);t.info('[PlatformService] testGetUserMedia -- getUserMedia success for time : '+n+' ms'),angular.forEach(r.getTracks(),function(e){t.info('[PlatformService] testGetUserMedia mediaStreamTrack -- '+e.label),e.stop()}),h.isAskingMedia=!1}).catch(function(e){t.info('[PlatformService] testGetUserMedia -- getUserMedia error '+e),h.isAskingMedia=!1})})},this.shouldAskGetUserMedia=function(){var e={audio:!1,video:!1};return angular.forEach(DetectRTC.MediaDevices,function(t){t&&t.label&&-1!==t.label.indexOf('invoke getUserMedia')&&('audioinput'===t.kind||'audiooutput'===t.kind?e.audio=!0:e.video=!0)}),t.info('[platformService] shouldAskGetUserMedia : audio '+e.audio+' and video '+e.video),e},this.updateNewDesktopDevicesIds=function(){var e=o.getSetting('handFreeInputDeviceName'),t=o.getSetting('handFreeOutputDeviceName'),a=o.getSetting('headsetDeviceName'),r=o.getSetting('customMicrophoneName'),n=o.getSetting('customSpeakerName');(e||t||a||r||n)&&angular.forEach(DetectRTC.MediaDevices,function(i){'audioinput'===i.kind?(i.normalizedLabel===a&&o.setSetting('headsetMicrophone',i.id),i.normalizedLabel===e&&o.setSetting('microphone',i.id),i.normalizedLabel===r&&o.setSetting('customMicrophone',i.id)):'audiooutput'===i.kind&&(i.normalizedLabel===a&&o.setSetting('headsetSpeaker',i.id),i.normalizedLabel===t&&o.setSetting('speaker',i.id),i.normalizedLabel===n&&o.setSetting('customSpeaker',i.id))})},this.mediaDevicesLength=0,this.mediaDevices=[],this.newDevice=null,this.devicesWatcher=function(){navigator.mediaDevices.enumerateDevices().then(function(e){(h.mediaDevicesLength!==e.length||h.checkForIdChange(e))&&(t.debug('[platformService] MediaDevices count changed ! from '+h.mediaDevicesLength+' to '+e.length),t.debug('[platformService] MediaDevices brut devices list '+JSON.stringify(e)),h.newDevice=1==e.length-h.mediaDevicesLength?h.getNewDevice(h.mediaDevices,e):null,h.mediaDevicesLength=e.length,h.mediaDevices=e,h.stopWatcher(),DetectRTC.load(h.detectRTCLoaded))})},h.checkAndUpdateHandFreeProfile=function(){t.info('[platformService] checkAndUpdateHandFreeProfile');var e=h.getActiveAudioProfile();1===e.key&&!0===e.available&&h.getCurrentSpeaker().then(function(e){e&&e.groupId===h.newDevice.groupId&&(t.info('[platformService] checkAndUpdateHandFreeProfile -- should update the Jack Mic'),a.$broadcast('ON_HANDFREE_JACK_MICROPHONE_EVENT',h.newDevice))})},h.checkForIdChange=function(e){var a=!1;return h.mediaDevices.length&&angular.forEach(h.mediaDevices,function(t){if('default'!==t.deviceId&&'communications'!==t.deviceId){for(var r=!1,n=0;n<e.length;n++)t.deviceId===e[n].deviceId&&(r=!0);r||(a=!0)}}),a&&t.info('[platformService] checkForIdChange '+a),a},h.getNewDevice=function(e,t){var a=null;return t.length&&angular.forEach(t,function(t){if('default'!==t.deviceId&&'communications'!==t.deviceId){for(var r=!1,n=0;n<e.length;n++)t.deviceId===e[n].deviceId&&(r=!0);r||'audioinput'!==t.kind||(a=t)}}),a},h.tryToGetUserMediaForEachDevice=function(){if(t.info('[platformService] tryToGetUserMediaForEachDevice'),DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length){for(var e=s.when(),r=0;r<DetectRTC.audioInputDevices.length;r++)(function(t){var a=DetectRTC.audioInputDevices[t];e=e.then(function(){return h.getUserMediaForAudioDevice(a.id)})})(r);e=e.finally(function(){if(t.info('[platformService] tryToGetUserMediaForEachDevice finally -- has audio permission '+h.hasAudioPermission),h.hasAudioPermission)h.loadDetectRTC();else{b=!1,R=!1,h.isAskingMedia=!1;a.$broadcast('ON_OPEN_GLOBAL_POPUP',{popupTitle:'information',popupBody:'devicePermission',okLabel:'ok'}),h.startWatcher()}})}},h.getUserMediaForAudioDevice=function(e){return s(function(a){if(h.hasAudioPermission)return t.info('[platformService] getUserMediaForAudioDevice for id: '+e+' no longer needed !'),void a();if(!e)return t.info('[platformService] getUserMediaForAudioDevice missing id !'),void a();t.info('[platformService] getUserMediaForAudioDevice for id: '+e);var r={};r.audio={optional:[{sourceId:e}]},navigator.mediaDevices.getUserMedia(r).then(function(r){t.info('[platformService] getUserMediaForAudioDevice for id: '+e+' success'),angular.forEach(r.getAudioTracks(),function(e){e.stop()}),h.hasAudioPermission=!0,b=!0,h.hasVideoPermission=!0,R=!0,a()}).catch(function(r){t.info('[platformService] getUserMediaForAudioDevice for id: '+e+' failed with error '+r),a()})})},h.getUserMedia=function(e,a){t.info('[platformService] getUserMedia audio: '+e+' and video: '+a),navigator.mediaDevices.getUserMedia({audio:e,video:a}).then(function(r){t.info('[platformService] getUserMedia audio: '+e+' and video: '+a+' -- success!'),angular.forEach(r.getAudioTracks(),function(e){e.stop()}),angular.forEach(r.getVideoTracks(),function(e){e.stop()}),e&&(h.hasAudioPermission=!0,b=!0),a&&(h.hasVideoPermission=!0,R=!0),r=null,h.loadDetectRTC()}).catch(function(e){t.error('[platformService] getUserMedia -- error -- '+e),h.tryToGetUserMediaForEachDevice()})},h.loadDetectRTC=function(){DetectRTC.load(function(){h.fixDeviceLabels(),k().then(function(){h.isDesktop()&&h.updateNewDesktopDevicesIds(),f(),h.isAskingMedia=!1,h.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(h.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,h.audioMediaDeviceUpdated()),h.videoDevices!==DetectRTC.videoInputDevices.length&&(h.videoDevices=DetectRTC.videoInputDevices.length,h.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(e){e&&t.info('[PlatformService] DetectRTC.MediaDevices device '+e.id+' with kind '+e.kind+' with label '+e.label)}),h.getCurrentSpeaker().then(function(e){C(e.id)}),h.startWatcher()})})},h.getWhatsNew=function(){return s(function(e){var a=config.restServerUrl+'/api/rainbow/enduser/v1.0/settings/changelogs';i({method:'GET',url:a,headers:c.getRequestHeader()}).then(function(a){t.info('[adminPlatformService] getWhatsNew -- success');var r=a.data.data.changeLog.split('\xA7%\xA7'),n={};r.forEach(function(e,t){n[h.languages[t]]=e}),Object.keys(n).forEach(function(e){0===n[e].length&&(n[e]=n.en)}),n.en||(n={en:'',fr:'',es:'',de:'',it:''}),e(n)},function(a){e({en:'',fr:'',es:'',de:'',it:''}),t.error('[adminPlatformService] '+l.getErrorFullMessage(a,'getWhatsNew'))})})},h.getAvailableLanguage=function(e){var t=e.split('-')[0],a=h.languages.find(function(e){return e===t});return a=a?a:'en'},this.isDesktop=function(){return 0<=navigator.userAgent.indexOf(' Rainbow/')},this.allowDevicesManagement=function(){return r.chrome||this.isDesktop()};var R=!1;this.isWebsiteHasWebcamPermissions=function(){return!!h.allowDevicesManagement()&&R};var b=!1;this.isWebsiteHasMicrophonePermissions=function(){return!!h.allowDevicesManagement()&&b};var y={HANDFREE:{key:1,value:'handfree',available:!1},HEADSET:{key:2,value:'headset',available:!1},SPEAKERPHONE:{key:3,value:'speakerphone',available:!1},CUSTOM:{key:4,value:'custom',available:!1}};this.audioProfileEnum=y,this.getAudioProfiles=function(){return y},this.currentAudioProfile=y.HANDFREE,this.getCurrentAudioProfile=function(){var e=o.getSetting('audioProfile'),t=null;return e===y.HEADSET.value?t=y.HEADSET:e===y.HANDFREE.value?t=y.HANDFREE:e===y.SPEAKERPHONE.value?t=y.SPEAKERPHONE:e===y.CUSTOM.value?t=y.CUSTOM:(t=y.HANDFREE,o.setSetting('audioProfile',t.value)),t},this.getActiveAudioProfile=function(){var e=this.getCurrentAudioProfile();return e.key===y.HANDFREE.key||e.available?e:y.HANDFREE},this.setCurrentAudioProfile=function(e){e&&(h.currentAudioProfile=e)},this.isHandfreeAvailable=function(){return h.isHandfreeMicrophoneAvailable()&&h.isHandfreeSpeakerAvailable()},this.isHeadsetAvailable=function(){return h.isHeadsetMicrophoneAvailable()&&h.isHeadsetSpeakerAvailable()},this.isSpeakerphoneAvailable=function(){return h.isSpeakerphoneMicrophoneAvailable()&&h.isSpeakerphoneSpeakerAvailable()},this.isCustomAvailable=function(){return h.isCustomMicrophoneAvailable()&&h.isCustomSpeakerAvailable()},this.getCurrentMicrophone=function(){if('sdk'===o.getSetting('apiMode')){var e=h.getMicrophoneForSDK();if(e)return e}switch(h.getActiveAudioProfile()){case y.SPEAKERPHONE:return h.getSpeakerphoneMicrophone();case y.CUSTOM:return h.getCustomMicrophone();case y.HEADSET:return h.getHeadsetMicrophone();default:return h.getHandfreeMicrophone();}},this.getMicrophoneForSDK=function(){var e=s.defer();return h.getMicrophones().then(function(t){e.resolve(h.getDeviceWithId(t,o.getSetting('microphone')))}),e.promise},this.getSecondRingerStatusFromSettings=function(){return o.getSetting('hasSecondRinger')},this.setSecondRingerStatusFromSettings=function(e){return o.setSetting('hasSecondRinger',e)},this.getHandfreeMicrophoneFromSettings=function(){return o.getSetting('microphone')},this.getHandfreeMicrophone=function(){var e=s.defer();return h.getMicrophones().then(function(t){e.resolve(h.getDeviceWithId(t,h.getHandfreeMicrophoneFromSettings()))}),e.promise},this.getHeadsetMicrophoneFromSettings=function(){return o.getSetting('headsetMicrophone')},this.getHeadsetMicrophone=function(){var e=s.defer();return h.getMicrophones().then(function(t){e.resolve(h.getDeviceWithId(t,h.getHeadsetMicrophoneFromSettings()))}),e.promise},this.getHeadsetDeviceName=function(){var e=s.defer();return e.resolve(o.getSetting('headsetDeviceName')),e.promise},this.getSpeakerphoneMicrophoneFromSettings=function(){return o.getSetting('speakerphoneMicrophone')},this.getSpeakerphoneMicrophone=function(){var e=s.defer();return h.getMicrophones().then(function(t){e.resolve(h.getDeviceWithId(t,h.getSpeakerphoneMicrophoneFromSettings()))}),e.promise},this.getSpeakerphoneDeviceName=function(){var e=s.defer();return e.resolve(o.getSetting('speakerphoneDeviceName')),e.promise},this.getCustomMicrophoneFromSettings=function(){return o.getSetting('customMicrophone')},this.getCustomMicrophone=function(){var e=s.defer();return h.getMicrophones().then(function(t){e.resolve(h.getDeviceWithId(t,h.getCustomMicrophoneFromSettings()))}),e.promise},this.getMicrophones=function(){var e=s.defer();return this.allowDevicesManagement()||e.resolve([]),h.getAudioInputDevices().then(function(t){e.resolve(t&&t.constructor===Array&&b?t:[])}).catch(function(a){return t.info('[PlatformService] === SERVICES FAILURE === : '+a.message),e.reject(a),e.promise}),e.promise},this.isHandfreeMicrophoneAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getHandfreeMicrophoneFromSettings(),'audioinput')},this.isHeadsetMicrophoneAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getHeadsetMicrophoneFromSettings(),'audioinput')},this.isSpeakerphoneMicrophoneAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getSpeakerphoneMicrophoneFromSettings(),'audioinput')},this.isCustomMicrophoneAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getCustomMicrophoneFromSettings(),'audioinput')},this.getCurrentSpeaker=function(){if('sdk'===o.getSetting('apiMode')){var e=h.getSpeakerForSDK();if(e)return e}switch(h.getActiveAudioProfile()){case y.SPEAKERPHONE:return h.getSpeakerphoneSpeaker();case y.CUSTOM:return h.getCustomSpeaker();case y.HEADSET:return h.getHeadsetSpeaker();default:return h.getHandfreeSpeaker();}},this.getSpeakerForSDK=function(){var e=s.defer();return h.getSpeakers().then(function(t){e.resolve(h.getDeviceWithId(t,o.getSetting('speaker')))}),e.promise},this.getHandfreeSpeakerFromSettings=function(){return o.getSetting('speaker')},this.getHandfreeSpeaker=function(){var e=s.defer();return h.getSpeakers().then(function(t){e.resolve(h.getDeviceWithId(t,h.getHandfreeSpeakerFromSettings(),!0))}),e.promise},this.getHeadsetSpeakerFromSettings=function(){return o.getSetting('headsetSpeaker')},this.getHeadsetSpeaker=function(){var e=s.defer();return h.getSpeakers().then(function(t){e.resolve(h.getDeviceWithId(t,h.getHeadsetSpeakerFromSettings()))}),e.promise},this.getSpeakerphoneSpeakerFromSettings=function(){return o.getSetting('speakerphoneSpeaker')},this.getSpeakerphoneSpeaker=function(){var e=s.defer();return h.getSpeakers().then(function(t){e.resolve(h.getDeviceWithId(t,h.getSpeakerphoneSpeakerFromSettings()))}),e.promise},this.getCustomSpeakerFromSettings=function(){return o.getSetting('customSpeaker')},this.getCustomSpeaker=function(){var e=s.defer();return h.getSpeakers().then(function(t){e.resolve(h.getDeviceWithId(t,h.getCustomSpeakerFromSettings()))}),e.promise},this.getRingingSpeakerFromSettings=function(){return o.getSetting('ringingSpeaker')},this.getRingingSpeaker=function(){var e=s.defer();return h.getSpeakers().then(function(t){e.resolve(h.getDeviceWithId(t,h.getRingingSpeakerFromSettings()))}),e.promise},this.setSpeakerForElement=function(e,a){var r=s.defer();if(!e||!e.setSinkId)return t.warn('[platformService] setSpeakerForElement -- missing element'),s.when();if(this.allowDevicesManagement()){if(a===e.sinkId)return s.when();e.id&&t.log('[platformService] setSpeakerForElement '+e.id+' with '+a),e.setSinkId(a).then(function(){t.log('[platformService] Success, audio output device attached: '+a),angular.element('#globalAudioTag')[0]&&t.log('[platformService] sinkId for globalAudioTag is '+angular.element('#globalAudioTag')[0].sinkId),r.resolve()}).catch(function(e){var a=e;'SecurityError'===e.name&&(a='[platformService] You need to use HTTPS for selecting audio output device: '+e),t.error('[platformService] '+a),r.resolve()})}else t.warn('[platformService] Browser does not support output device selection.'),r.resolve();return r.promise},this.getSpeakers=function(){var e=s.defer();return h.allowDevicesManagement()||e.resolve([]),h.getAudioOutputDevices().then(function(t){e.resolve(t&&t.constructor===Array&&b?t:[])}).catch(function(a){return t.info('[PlatformService] === SERVICES FAILURE === : '+a.message),e.reject(a),e.promise}),e.promise},this.isHandfreeSpeakerAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getHandfreeSpeakerFromSettings(),'audiooutput')};var T=!1;this.isHeadsetSpeakerAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getHeadsetSpeakerFromSettings(),'audiooutput')};var I=null;this.isSpeakerphoneSpeakerAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getSpeakerphoneSpeakerFromSettings(),'audiooutput')};var N=!1;this.isCustomSpeakerAvailable=function(){return h.isDeviceAvailable(h.mediaDevices,h.getCustomSpeakerFromSettings(),'audiooutput')};var A=!1,O='',P=[],D=[],_=[],M=[],w=[],U=!0,L=!0,F=['realtek','soundmax','high definition audio','nomachine'];h.arrayContains=function(e,t){return e.some(function(e){return-1<t.indexOf(e)})},h.getDeviceType=function(e){return e=e.toLowerCase(),h.arrayContains(F,e)?y.HANDFREE:y.HEADSET},this.normalizeAnyLabel=function(e){return e?('default'===e.id||'communications'===e.id||e.normalizedLabel||(h.isWin?e.normalizedLabel=e.label.substring(e.label.indexOf('(')+1,e.label.indexOf(')')):e.normalizedLabel=e.label),e):null};var k=function(){var e=s.defer();return h.getMicrophones().then(function(e){return P=e,h.getSpeakers()}).then(function(r){D=r;var n=[];angular.forEach(P,function(e){if('default'!==e.id&&'communications'!==e.id){e=h.normalizeAnyLabel(e);var t=n.some(function(t){return t.microphone.normalizedLabel===e.normalizedLabel});t||angular.forEach(D,function(t){if(t=h.normalizeAnyLabel(t),e.normalizedLabel===t.normalizedLabel&&h.getDeviceType(e.normalizedLabel)===y.HEADSET){var a={label:e.normalizedLabel,microphone:e,speaker:t};n.push(a),U&&_.push(a)}})}});var i=o.getSetting('headsetDeviceName');(!i||'null'===i)&&n.length&&(i=n[0].label,o.setSetting('headsetDeviceName',n[0].label),o.setSetting('headsetMicrophone',n[0].microphone.id),o.setSetting('headsetSpeaker',n[0].speaker.id));var s=[];U||(angular.forEach(n,function(e){var t=M.some(function(t){return t.label===e.label});t||(s.push(e),_.push(e))}),0<s.length&&(t.info('[PlatformService] hotplugged headset(s): '+(1<s.length?s.reduce(function(e,t){return{label:e.Label+', '+t.Label}}).label:s[0].label)),a.$broadcast('ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT',{devices:s,action:'add'})));var d=[];!U&&M.length>n.length&&(angular.forEach(M,function(e){var t=n.some(function(t){return t.label===e.label});if(!t){d.push(e);var a=_.map(function(e){return e.label}).indexOf(e.label);_.splice(a,1)}}),0<d.length&&(t.info('[PlatformService] unplugged headset(s): '+(1<d.length?d.reduce(function(e,t){return{label:e.Label+', '+t.Label}}).label:d[0].label)),a.$broadcast('ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT',{devices:d,action:'remove'}))),U=!1,M=n,e.resolve(n)}),e.promise};this.getHeadsetDevices=function(){return M};this.getSpeakerphoneDevices=function(){return w},this.getAllDevices=function(){return _},this.getHandFreeDevice=function(){var e=s.defer();return h.getHandfreeMicrophone().then(function(t){var a=t;h.getHandfreeSpeaker().then(function(t){var r=t;(!h.handFreeDevice||h.handFreeDevice.microphone&&h.handFreeDevice.microphone.id!==a.id||h.handFreeDevice.speaker&&h.handFreeDevice.speaker.id!==r.id)&&(h.handFreeDevice={label:'',microphone:a,speaker:r,profile:y.HANDFREE}),e.resolve(h.handFreeDevice)})}),e.promise},this.getCustomDevice=function(){var e=s.defer();return h.getCustomMicrophone().then(function(t){var a=t;h.getCustomSpeaker().then(function(t){var r=t;(!h.customDevice||h.customDevice.microphone&&h.customDevice.microphone.id!==a.id||h.customDevice.speaker&&h.customDevice.speaker.id!==r.id)&&(h.customDevice={label:'',microphone:a,speaker:r,profile:y.CUSTOM}),e.resolve(h.customDevice)})}),e.promise},this.getAvailableDevices=function(){var e=s.defer(),t=[];return h.getHandFreeDevice().then(function(a){t.push(a),M.forEach(function(e){e.profile=y.HEADSET,t.push(e)}),w.forEach(function(e){e.profile=y.SPEAKERPHONE,t.push(e)}),h.getCustomDevice().then(function(a){t.push(a),e.resolve(t)})}),e.promise},this.getStoredDeviceList=function(){return o.getSetting('deviceList')},this.saveDeviceList=function(e){for(var t=[],a=0;a<e.length;a++)t[a]=e[a].label;o.setSetting('deviceList',angular.toJson(t))},this.getCurrentCamera=function(){var e=s.defer();return h.getCameras().then(function(t){e.resolve(h.getDeviceWithId(t,o.getSetting('camera')))}),e.promise},this.getCameraForSDK=function(){return{id:o.getSetting('camera')}},this.getCameras=function(){var e=s.defer();return this.allowDevicesManagement()||e.resolve([]),h.getVideoInputDevices().then(function(t){e.resolve(t&&t.constructor===Array&&R?t:[])}).catch(function(a){return t.info('[PlatformService] === SERVICES FAILURE === : '+a.message),e.reject(a),e.promise}),e.promise},this.isDeviceAvailable=function(e,t,a){var r=e.find(function(e){return e.kind===a&&e.deviceId===t});return angular.isDefined(r)},this.getDeviceWithId=function(e,t,a){if(e.constructor!==Array)return null;var r=null;if('default'===t||'communications'===t)if(a){var n=h.mediaDevices.find(function(e){return e.deviceId===t&&'audioinput'===e.kind});n&&(r=e.find(function(e){return'default'!==e.id&&'communications'!==e.id&&n.groupId===e.groupId}))}else{var n=e.find(function(e){return e.id===t});n&&(r=e.find(function(e){return'default'!==e.id&&'communications'!==e.id&&n.groupId===e.groupId}))}if(r)return r;if(r=e.find(function(e){return e.id===t}),!r){if(a){var n=h.mediaDevices.find(function(e){return'default'===e.deviceId&&'audioinput'===e.kind});n&&(r=e.find(function(e){return'default'!==e.id&&'communications'!==e.id&&n.groupId===e.groupId}))}r||(n=e.find(function(e){return'default'===e.id}),n&&(r=e.find(function(e){return'default'!==e.id&&'communications'!==e.id&&n.groupId===e.groupId})))}return r?r:0<e.length?e[0]:null};var B;this.startWatcher=function(){if(h.allowDevicesManagement()){if(angular.isDefined(B))return;B=n(h.devicesWatcher,1e3)}},this.stopWatcher=function(){angular.isDefined(B)&&(n.cancel(B),B=void 0)},this.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},this.fixDeviceLabels=function(){angular.forEach(DetectRTC.MediaDevices,function(e){e&&('default'!==e.id||e.label&&'Default'!==e.label?64>e.id.length&&'Please invoke getUserMedia once.'===e.label&&(e.label=h.capitalizeFirstLetter(e.id)):e.label=h.findAndUpdateDefaultDeviceLabel(e.kind,e.groupId),t.info('[PlatformService] fixDeviceLabels || update device '+e.id+' with kind '+e.kind+' with label '+e.label))})},this.findAndUpdateDefaultDeviceLabel=function(e,t){for(var a='audioinput'===e?d('translate')('yourComputerMicrophoneDevice'):d('translate')('yourComputerSpeakerDevice'),r=0;r<DetectRTC.MediaDevices.length;r++)if('default'!==DetectRTC.MediaDevices[r].id&&DetectRTC.MediaDevices[r].kind===e&&DetectRTC.MediaDevices[r].groupId===t){a=a+' - '+DetectRTC.MediaDevices[r].label;break}return a},this.updatePermissions=function(){var e=!1;return angular.forEach(DetectRTC.MediaDevices,function(t){t&&64<=t.id.length&&('Please invoke getUserMedia once.'===t.label?e=!0:('videoinput'===t.kind&&!R&&(R=!0),'audioinput'===t.kind&&!b&&(b=!0)))}),e},this.isGetUserMediaRequested=function(){return!(R&&b)&&h.updatePermissions(DetectRTC.MediaDevices)},this.audioMediaDeviceUpdated=function(){h.fixDeviceLabels(),a.$broadcast('ON_USER_AUDIO_MEDIA_CHANGED_EVENT')},this.videoMediaDeviceUpdated=function(){h.fixDeviceLabels(),a.$broadcast('ON_USER_VIDEO_MEDIA_CHANGED_EVENT')};var x=function(e){var t=[];return angular.forEach(e,function(e){t.some(function(t){return t.id===e.id})||t.push(e)}),t};this.getAudioInputDevices=function(){return s.when(x(DetectRTC.audioInputDevices))},this.getAudioOutputDevices=function(){var e=s.defer();return e.resolve(x(DetectRTC.audioOutputDevices)),e.promise},this.getVideoInputDevices=function(){var e=s.defer();return e.resolve(x(DetectRTC.videoInputDevices)),e.promise}}])},function(){angular.module('rainbow').service('gaService',[function(){'use strict';var e={ICEFailed:{category:'webrtc',action:'CallsSuccessRate',label:'error_failed'},ICESuccess:{category:'webrtc',action:'CallsSuccessRate',label:'success'},ICENoSTUNCandidate:{category:'webrtc',action:'CallsSuccessRate',label:'error_no_stun_candidate'},ICEUsed:{category:'webrtc',action:'ICEDistribution'},ICETopology:{category:'webrtc',action:'ICETopology'},NegotiationTime:{category:'webrtc',action:'ICENegotiation',label:'DurationMs'},GetUserMedia:{category:'webrtc',action:'GetUserMediaRate',label:'success'},GetUserMediaErrorNoTrack:{category:'webrtc',action:'GetUserMediaRate',label:'error_no_Track'},GetUserMediaError:{category:'webrtc',action:'GetUserMediaRate',label:'error'},CodecsUsed:{category:'webrtc',action:'CodecsDistribution'},NbSuccessCall:{category:'webrtc',action:'CallsDistribution'},CallsDuration:{category:'webrtc',action:'CallsDurationRange'},DragAndDrop:{category:'ux',action:'dragAndDrop'},InviteFromProvider:{category:'invitations',action:'inviteFromProvider'}},t=null,a=null,r=!1,n=null,o=null,i=null;this.provideGA=function(e){i=e},this.hasGA=function(){return null!==i},this.trackICEUsed=function(t,a){if(i){var r='',n='';switch(t){case'local':r='host';break;case'peerreflexive':case'prflx':case'serverreflexive':r='stun';break;case'relayed':r='relay';break;default:r=t;}switch(a){case'local':n='host';break;case'peerreflexive':case'prflx':case'serverreflexive':n='stun';break;case'relayed':n='relay';break;default:n=a;}i.send('event',e.ICEUsed.category,e.ICEUsed.action,r+'|'+n)}},this.trackICEFailed=function(t){i&&t&&o!==t&&(i.send('event',e.ICEFailed.category,e.ICEFailed.action,e.ICEFailed.label),o=t)},this.trackICESuccess=function(t){i&&t&&n!==t&&(i.send('event',e.ICESuccess.category,e.ICESuccess.action,e.ICESuccess.label),n=t)},this.trackICENoSTUNCandidate=function(){i&&i.send('event',e.ICENoSTUNCandidate.category,e.ICENoSTUNCandidate.action,e.ICENoSTUNCandidate.label)},this.trackICETopology=function(t){i&&i.send('event',e.ICETopology.category,e.ICETopology.action,t)},this.trackGetUserMediaSuccess=function(){i&&i.send('event',e.GetUserMedia.category,e.GetUserMedia.action,e.GetUserMedia.label)},this.trackGetUserMediaErrorNoTrack=function(){i&&i.send('event',e.GetUserMediaErrorNoTrack.category,e.GetUserMediaErrorNoTrack.action,e.GetUserMediaErrorNoTrack.label)},this.trackGetUserMediaError=function(){i&&i.send('event',e.GetUserMediaError.category,e.GetUserMediaError.action,e.GetUserMediaError.label)},this.trackCodecsUsed=function(t,a){i&&i.send('event',e.CodecsUsed.category,e.CodecsUsed.action,t+'|'+a)},this.negotiationTime=function(){return a&&t?a<t?null:a-t:null},this.startNegotiationTime=function(e){t=e?e:new Date().getTime(),r=!0},this.endNegotiationTime=function(e){r&&(a=e?e:new Date().getTime(),r=!1)},this.trackNegotiationTime=function(){if(i){var r=this.negotiationTime();r&&i.send('event',e.NegotiationTime.category,e.NegotiationTime.action,e.NegotiationTime.label,r),a=null,t=null}},this.resetProvider=function(){i=null},this.trackCallSuccessNumber=function(t){t&&0<t.length&&i&&i.send('event',e.NbSuccessCall.category,e.NbSuccessCall.action,t)},this.trackCallDuration=function(t){if(i&&angular.isDefined(t)&&0<=t){var a='',r=Math.round(t/1e3);a=15>r?'very_short_less_15s':30>r?'very_short_less_30s':60>r?'short_less_60s':120>r?'short_less_120s':300>r?'short_less_300s':600>r?'normal_less_600s':1200>r?'normal_less_1200s':1800>r?'normal_less_1800s':3600>r?'long_less_3600s':'long_more_3600s',i.send('event',e.CallsDuration.category,e.CallsDuration.action,a)}},this.trackDragAndDrop=function(t){i&&i.send('event',e.DragAndDrop.category,e.DragAndDrop.action,t)},this.inviteContactsFromProvider=function(t,a){i&&i.send('event',e.InviteFromProvider.category,e.InviteFromProvider.action,t,a)}}])},function(){angular.module('rainbow').service('countryService',['$translate',function(e){'use strict';var t=this;t.countries=[{name:'Australia',"alpha-3":'AUS',"country-code":'036',"alpha-2":'AU'},{name:'Austria',"alpha-3":'AUT',"country-code":'040',"alpha-2":'AT'},{name:'Belgium',"alpha-3":'BEL',"country-code":'056',"alpha-2":'BE'},{name:'Brazil',"alpha-3":'BRA',"country-code":'076',"alpha-2":'BR'},{name:'Canada',"alpha-3":'CAN',"country-code":'124',"alpha-2":'CA'},{name:'China',"alpha-3":'CHN',"country-code":'156',"alpha-2":'CN'},{name:'Czech Republic',"alpha-3":'CZE',"country-code":'203',"alpha-2":'CZ'},{name:'Denmark',"alpha-3":'DNK',"country-code":'208',"alpha-2":'DK'},{name:'Finland',"alpha-3":'FIN',"country-code":'246',"alpha-2":'FI'},{name:'France',"alpha-3":'FRA',"country-code":'250',default:!0,"alpha-2":'FR'},{name:'Germany',"alpha-3":'DEU',"country-code":'276',"alpha-2":'DE'},{name:'Hong Kong',"alpha-3":'HKG',"country-code":'344',"alpha-2":'HK'},{name:'Ireland',"alpha-3":'IRL',"country-code":'372',"alpha-2":'IE'},{name:'Israel',"alpha-3":'ISR',"country-code":'376',"alpha-2":'IL'},{name:'Italy',"alpha-3":'ITA',"country-code":'380',"alpha-2":'IT'},{name:'Mexico',"alpha-3":'MEX',"country-code":'484',"alpha-2":'MX'},{name:'Netherlands',"alpha-3":'NLD',"country-code":'528',"alpha-2":'NL'},{name:'Norway',"alpha-3":'NOR',"country-code":'578',"alpha-2":'NO'},{name:'Poland',"alpha-3":'POL',"country-code":'616',"alpha-2":'PL'},{name:'Portugal',"alpha-3":'PRT',"country-code":'620',"alpha-2":'PT'},{name:'Russia',"alpha-3":'RUS',"country-code":'643',"alpha-2":'RU'},{name:'South Africa',"alpha-3":'ZAF',"country-code":'710',"alpha-2":'ZA'},{name:'South Korea',"alpha-3":'KOR',"country-code":'410',"alpha-2":'KR'},{name:'Spain',"alpha-3":'ESP',"country-code":'724',"alpha-2":'ES'},{name:'Sweden',"alpha-3":'SWE',"country-code":'752',"alpha-2":'SE'},{name:'Switzerland',"alpha-3":'CHE',"country-code":'756',"alpha-2":'CH'},{name:'Taiwan',"alpha-3":'TWN',"country-code":'158',"alpha-2":'TW'},{name:'Turkey',"alpha-3":'TUR',"country-code":'792',"alpha-2":'TR'},{name:'United Kingdom',"alpha-3":'GBR',"country-code":'826',"alpha-2":'GB'},{name:'United States of America',"alpha-3":'USA',"country-code":'840',"alpha-2":'US'},{name:'Afghanistan',"alpha-3":'AFG',"country-code":'004',"alpha-2":'AF'},{name:'Albania',"alpha-3":'ALB',"country-code":'008',"alpha-2":'AL'},{name:'Algeria',"alpha-3":'DZA',"country-code":'012',"alpha-2":'DZ'},{name:'Andorra',"alpha-3":'AND',"country-code":'020',"alpha-2":'AD'},{name:'Angola',"alpha-3":'AGO',"country-code":'024',"alpha-2":'AO'},{name:'Anguilla',"alpha-3":'AIA',"country-code":'660',"alpha-2":'AI'},{name:'Antigua and Barbuda',"alpha-3":'ATG',"country-code":'028',"alpha-2":'AG'},{name:'Argentina',"alpha-3":'ARG',"country-code":'032',"alpha-2":'AR'},{name:'Armenia',"alpha-3":'ARM',"country-code":'051',"alpha-2":'AM'},{name:'Aruba',"alpha-3":'ABW',"country-code":'533',"alpha-2":'AW'},{name:'Azerbaijan',"alpha-3":'AZE',"country-code":'031',"alpha-2":'AZ'},{name:'Bahamas',"alpha-3":'BHS',"country-code":'044',"alpha-2":'BS'},{name:'Bahrain',"alpha-3":'BHR',"country-code":'048',"alpha-2":'BH'},{name:'Bangladesh',"alpha-3":'BGD',"country-code":'050',"alpha-2":'BD'},{name:'Barbados',"alpha-3":'BRB',"country-code":'052',"alpha-2":'BB'},{name:'Belarus',"alpha-3":'BLR',"country-code":'112',"alpha-2":'BY'},{name:'Belize',"alpha-3":'BLZ',"country-code":'084',"alpha-2":'BZ'},{name:'Benin',"alpha-3":'BEN',"country-code":'204',"alpha-2":'BJ'},{name:'Bermuda',"alpha-3":'BMU',"country-code":'060',"alpha-2":'BM'},{name:'Bhutan',"alpha-3":'BTN',"country-code":'064',"alpha-2":'BT'},{name:'Bolivia',"alpha-3":'BOL',"country-code":'068',"alpha-2":'BO'},{name:'Bosnia and Herzegovina',"alpha-3":'BIH',"country-code":'070',"alpha-2":'BA'},{name:'Botswana',"alpha-3":'BWA',"country-code":'072',"alpha-2":'BW'},{name:'British Virgin Islands',"alpha-3":'VGB',"country-code":'092',"alpha-2":'VG'},{name:'Brunei Darussalam',"alpha-3":'BRN',"country-code":'096',"alpha-2":'BN'},{name:'Bulgaria',"alpha-3":'BGR',"country-code":'100',"alpha-2":'BG'},{name:'Burkina Faso',"alpha-3":'BFA',"country-code":'854',"alpha-2":'BF'},{name:'Burundi',"alpha-3":'BDI',"country-code":'108',"alpha-2":'BI'},{name:'Cambodia',"alpha-3":'KHM',"country-code":'116',"alpha-2":'KH'},{name:'Cameroon',"alpha-3":'CMR',"country-code":'120',"alpha-2":'CM'},{name:'Cape Verde',"alpha-3":'CPV',"country-code":'132',"alpha-2":'CV'},{name:'Cayman Islands',"alpha-3":'CYM',"country-code":'136',"alpha-2":'KY'},{name:'Central African Republic',"alpha-3":'CAF',"country-code":'140',"alpha-2":'CF'},{name:'Chad',"alpha-3":'TCD',"country-code":'148',"alpha-2":'TD'},{name:'Chile',"alpha-3":'CHL',"country-code":'152',"alpha-2":'CL'},{name:'Colombia',"alpha-3":'COL',"country-code":'170',"alpha-2":'CO'},{name:'Comoros',"alpha-3":'COM',"country-code":'174',"alpha-2":'KM'},{name:'Congo',"alpha-3":'COG',"country-code":'178',"alpha-2":'CG'},{name:'Congo, Democratic Republic of',"alpha-3":'COD',"country-code":'180',"alpha-2":'CD'},{name:'Costa Rica',"alpha-3":'CRI',"country-code":'188',"alpha-2":'CR'},{name:'Ivory Coast',"alpha-3":'CIV',"country-code":'384',"alpha-2":'CI'},{name:'Croatia',"alpha-3":'HRV',"country-code":'191',"alpha-2":'HR'},{name:'Cyprus',"alpha-3":'CYP',"country-code":'196',"alpha-2":'CY'},{name:'Djibouti',"alpha-3":'DJI',"country-code":'262',"alpha-2":'DJ'},{name:'Dominica',"alpha-3":'DMA',"country-code":'212',"alpha-2":'DM'},{name:'Dominican Republic',"alpha-3":'DOM',"country-code":'214',"alpha-2":'DO'},{name:'Ecuador',"alpha-3":'ECU',"country-code":'218',"alpha-2":'EC'},{name:'El Salvador',"alpha-3":'SLV',"country-code":'222',"alpha-2":'SV'},{name:'Egypt',"alpha-3":'EGY',"country-code":'818',"alpha-2":'EG'},{name:'Eritrea',"alpha-3":'ERI',"country-code":'232',"alpha-2":'ER'},{name:'Estonia',"alpha-3":'EST',"country-code":'233',"alpha-2":'EE'},{name:'Ethiopia',"alpha-3":'ETH',"country-code":'231',"alpha-2":'ET'},{name:'Fiji',"alpha-3":'FJI',"country-code":'242',"alpha-2":'FJ'},{name:'French Guiana',"alpha-3":'GUF',"country-code":'254',"alpha-2":'GF'},{name:'French Polynesia',"alpha-3":'PYF',"country-code":'258',"alpha-2":'PF'},{name:'Gabon',"alpha-3":'GAB',"country-code":'266',"alpha-2":'GA'},{name:'Gambia',"alpha-3":'GMB',"country-code":'270',"alpha-2":'GM'},{name:'Georgia',"alpha-3":'GEO',"country-code":'268',"alpha-2":'GE'},{name:'Ghana',"alpha-3":'GHA',"country-code":'288',"alpha-2":'GH'},{name:'Greece',"alpha-3":'GRC',"country-code":'300',"alpha-2":'GR'},{name:'Grenada',"alpha-3":'GRD',"country-code":'308',"alpha-2":'GD'},{name:'Guadeloupe',"alpha-3":'GLP',"country-code":'312',"alpha-2":'GP'},{name:'Guatemala',"alpha-3":'GTM',"country-code":'320',"alpha-2":'GT'},{name:'Guinea',"alpha-3":'GIN',"country-code":'324',"alpha-2":'GN'},{name:'Guyana',"alpha-3":'GUY',"country-code":'328',"alpha-2":'GY'},{name:'Haiti',"alpha-3":'HTI',"country-code":'332',"alpha-2":'HT'},{name:'Honduras',"alpha-3":'HND',"country-code":'340',"alpha-2":'HN'},{name:'Hungary',"alpha-3":'HUN',"country-code":'348',"alpha-2":'HU'},{name:'Iceland',"alpha-3":'ISL',"country-code":'352',"alpha-2":'IS'},{name:'India',"alpha-3":'IND',"country-code":'356',"alpha-2":'IN'},{name:'Indonesia',"alpha-3":'IDN',"country-code":'360',"alpha-2":'ID'},{name:'Iraq',"alpha-3":'IRQ',"country-code":'368',"alpha-2":'IQ'},{name:'Jamaica',"alpha-3":'JAM',"country-code":'388',"alpha-2":'JM'},{name:'Japan',"alpha-3":'JPN',"country-code":'392',"alpha-2":'JP'},{name:'Jordan',"alpha-3":'JOR',"country-code":'400',"alpha-2":'JO'},{name:'Kazakhstan',"alpha-3":'KAZ',"country-code":'398',"alpha-2":'KZ'},{name:'Kenya',"alpha-3":'KEN',"country-code":'404',"alpha-2":'KE'},{name:'Kuwait',"alpha-3":'KWT',"country-code":'414',"alpha-2":'KW'},{name:'Kyrgyzstan',"alpha-3":'KGZ',"country-code":'417',"alpha-2":'KG'},{name:'Latvia',"alpha-3":'LVA',"country-code":'428',"alpha-2":'LV'},{name:'Lebanon',"alpha-3":'LBN',"country-code":'422',"alpha-2":'LB'},{name:'Lesotho',"alpha-3":'LSO',"country-code":'426',"alpha-2":'LS'},{name:'Liberia',"alpha-3":'LBR',"country-code":'430',"alpha-2":'LR'},{name:'Libya',"alpha-3":'LBY',"country-code":'434',"alpha-2":'LY'},{name:'Liechtenstein',"alpha-3":'LIE',"country-code":'438',"alpha-2":'LI'},{name:'Lithuania',"alpha-3":'LTU',"country-code":'440',"alpha-2":'LT'},{name:'Luxembourg',"alpha-3":'LUX',"country-code":'442',"alpha-2":'LU'},{name:'Macao',"alpha-3":'MAC',"country-code":'446',"alpha-2":'MO'},{name:'Macedonia',"alpha-3":'MKD',"country-code":'807',"alpha-2":'MK'},{name:'Madagascar',"alpha-3":'MDG',"country-code":'450',"alpha-2":'MG'},{name:'Malawi',"alpha-3":'MWI',"country-code":'454',"alpha-2":'MW'},{name:'Malaysia',"alpha-3":'MYS',"country-code":'458',"alpha-2":'MY'},{name:'Maldives',"alpha-3":'MDV',"country-code":'462',"alpha-2":'MV'},{name:'Mali',"alpha-3":'MLI',"country-code":'466',"alpha-2":'ML'},{name:'Malta',"alpha-3":'MLT',"country-code":'470',"alpha-2":'MT'},{name:'Mauritius',"alpha-3":'MUS',"country-code":'480',"alpha-2":'MU'},{name:'Mayotte',"alpha-3":'MYT',"country-code":'175',"alpha-2":'YT'},{name:'Moldova',"alpha-3":'MDA',"country-code":'498',"alpha-2":'MD'},{name:'Monaco',"alpha-3":'MCO',"country-code":'492',"alpha-2":'MC'},{name:'Mongolia',"alpha-3":'MNG',"country-code":'496',"alpha-2":'MN'},{name:'Montenegro',"alpha-3":'MNE',"country-code":'499',"alpha-2":'ME'},{name:'Montserrat',"alpha-3":'MSR',"country-code":'500',"alpha-2":'MS'},{name:'Morocco',"alpha-3":'MAR',"country-code":'504',"alpha-2":'MA'},{name:'Mozambique',"alpha-3":'MOZ',"country-code":'508',"alpha-2":'MZ'},{name:'Myanmar',"alpha-3":'MMR',"country-code":'104',"alpha-2":'MM'},{name:'Namibia',"alpha-3":'NAM',"country-code":'516',"alpha-2":'NA'},{name:'Nepal',"alpha-3":'NPL',"country-code":'524',"alpha-2":'NP'},{name:'New Zealand',"alpha-3":'NZL',"country-code":'554',"alpha-2":'NZ'},{name:'Nicaragua',"alpha-3":'NIC',"country-code":'558',"alpha-2":'NI'},{name:'Niger',"alpha-3":'NER',"country-code":'562',"alpha-2":'NE'},{name:'Nigeria',"alpha-3":'NGA',"country-code":'566',"alpha-2":'NG'},{name:'Oman',"alpha-3":'OMN',"country-code":'512',"alpha-2":'OM'},{name:'Pakistan',"alpha-3":'PAK',"country-code":'586',"alpha-2":'PK'},{name:'Palestine',"alpha-3":'PSE',"country-code":'275',"alpha-2":'PS'},{name:'Panama',"alpha-3":'PAN',"country-code":'591',"alpha-2":'PA'},{name:'Paraguay',"alpha-3":'PRY',"country-code":'600',"alpha-2":'PY'},{name:'Peru',"alpha-3":'PER',"country-code":'604',"alpha-2":'PE'},{name:'Philippines',"alpha-3":'PHL',"country-code":'608',"alpha-2":'PH'},{name:'Puerto Rico',"alpha-3":'PRI',"country-code":'630',"alpha-2":'PR'},{name:'Qatar',"alpha-3":'QAT',"country-code":'634',"alpha-2":'QA'},{name:'Romania',"alpha-3":'ROU',"country-code":'642',"alpha-2":'RO'},{name:'Rwanda',"alpha-3":'RWA',"country-code":'646',"alpha-2":'RW'},{name:'Saint Kitts and Nevis',"alpha-3":'KNA',"country-code":'659',"alpha-2":'KN'},{name:'Saint Lucia',"alpha-3":'LCA',"country-code":'662',"alpha-2":'LC'},{name:'Saint Vincent and the Grenadines',"alpha-3":'VCT',"country-code":'670',"alpha-2":'VC'},{name:'Saudi Arabia',"alpha-3":'SAU',"country-code":'682',"alpha-2":'SA'},{name:'Senegal',"alpha-3":'SEN',"country-code":'686',"alpha-2":'SN'},{name:'Serbia',"alpha-3":'SRB',"country-code":'688',"alpha-2":'RS'},{name:'Sierra Leone',"alpha-3":'SLE',"country-code":'694',"alpha-2":'SL'},{name:'Singapore',"alpha-3":'SGP',"country-code":'702',"alpha-2":'SG'},{name:'Slovakia',"alpha-3":'SVK',"country-code":'703',"alpha-2":'SK'},{name:'Slovenia',"alpha-3":'SVN',"country-code":'705',"alpha-2":'SI'},{name:'South Sudan',"alpha-3":'SSD',"country-code":'728',"alpha-2":'SS'},{name:'Sri Lanka',"alpha-3":'LKA',"country-code":'144',"alpha-2":'LK'},{name:'Sudan',"alpha-3":'SDN',"country-code":'729',"alpha-2":'SD'},{name:'Swaziland',"alpha-3":'SWZ',"country-code":'748',"alpha-2":'SZ'},{name:'Tajikistan',"alpha-3":'TJK',"country-code":'762',"alpha-2":'TJ'},{name:'Tanzania',"alpha-3":'TZA',"country-code":'834',"alpha-2":'TZ'},{name:'Thailand',"alpha-3":'THA',"country-code":'764',"alpha-2":'TH'},{name:'Togo',"alpha-3":'TGO',"country-code":'768',"alpha-2":'TG'},{name:'Trinidad and Tobago',"alpha-3":'TTO',"country-code":'780',"alpha-2":'TT'},{name:'Tunisia',"alpha-3":'TUN',"country-code":'788',"alpha-2":'TN'},{name:'Turkmenistan',"alpha-3":'TKM',"country-code":'795',"alpha-2":'TM'},{name:'Turks and Caicos Islands',"alpha-3":'TCA',"country-code":'796',"alpha-2":'TC'},{name:'Uganda',"alpha-3":'UGA',"country-code":'800',"alpha-2":'UG'},{name:'Ukraine',"alpha-3":'UKR',"country-code":'804',"alpha-2":'UA'},{name:'United Arab Emirates',"alpha-3":'ARE',"country-code":'784',"alpha-2":'AE'},{name:'Virgin Islands, US',"alpha-3":'VIR',"country-code":'850',"alpha-2":'VI'},{name:'Uruguay',"alpha-3":'URY',"country-code":'858',"alpha-2":'UY'},{name:'Uzbekistan',"alpha-3":'UZB',"country-code":'860',"alpha-2":'UZ'},{name:'Venezuela',"alpha-3":'VEN',"country-code":'862',"alpha-2":'VE'},{name:'Vietnam',"alpha-3":'VNM',"country-code":'704',"alpha-2":'VN'},{name:'Zambia',"alpha-3":'ZMB',"country-code":'894',"alpha-2":'ZM'},{name:'Zimbabwe',"alpha-3":'ZWE',"country-code":'716',"alpha-2":'ZW'}],t.statesOfCanada={AB:'Alberta',BC:'British Columbia',MB:'Manitoba',NB:'New Brunswick',NL:'Newfoundland and Labrador',NS:'Nova Scotia',NT:'Northwest Territories',NU:'Nunavut',ON:'Ontario',PE:'Prince Edward Island',QC:'Quebec',SK:'Saskatchewan',YT:'Yukon'},t.statesOfAmerica={AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',AA:'Armed Forces America',AE:'Armed Forces',AP:'Armed Forces Pacific',CA:'California',CO:'Colorado',CT:'Connecticut',DE:'Delaware',FL:'Florida',GA:'Georgia',GU:'Guam',HI:'Hawaii',ID:'Idaho',IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',MI:'Michigan',MN:'Minnesota',MS:'Mississippi',MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',NY:'New York',NC:'North Carolina',ND:'North Dakota',OH:'Ohio',OK:'Oklahoma',OR:'Oregon',PA:'Pennsylvania',PR:'Puerto Rico',RI:'Rhode Island',SC:'South Carolina',SD:'South Dakota',TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',VI:'Virgin Islands',VA:'Virginia',WA:'Washington',DC:'Washington DC',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming'},t.getCountries=function(a){var r=Object.assign([],t.countries).map(t.translateCountryName);if(a)r.sort(t.sortByCountryName);else{var n=r.splice(30).sort(t.sortByCountryName);r.sort(t.sortByCountryName),r.push({name:e.instant('otherCountries'),disabled:'true'}),r.push.apply(r,n)}return r},t.sortByCountryName=function(t,a){return t.name.localeCompare(a.name,e.use())},t.translateCountryName=function(a){var r=t.getCountryLabel(a['alpha-2']);if(r){var n=e.instant(r);n!==r&&(a.name=n)}return a},t.getCountryStates=function(e){return e&&'USA'===e['alpha-3']?t.statesOfAmerica:e&&'CAN'===e['alpha-3']?t.statesOfCanada:{}},t.getCountry=function(e,a){if(!e)return a?t.getDefaultCountry():null;var r=t.countries.filter(function(t){return t['alpha-3']===e});return 0<r.length?r[0]:null},t.getDefaultCountry=function(){var e=t.countries.filter(function(e){return!0===e.default});return 0<e.length?e[0]:t.countries[0]},t.getCountryName=function(e){var a=t.getCountry(e);return a?t.getCountry(e).name:null},t.getCountryCode=function(e){return e?e['alpha-3']:null},t.getDefaultState=function(e){return e&&'USA'===e['alpha-3']?'AL':e&&'CAN'===e['alpha-3']?'AB':null},t.getAlpha2Code=function(e){if(!e)return null;var a=t.countries.filter(function(t){return t['alpha-3']===e});return 0<a.length?a[0]['alpha-2']:null},t.getCountryLabel=function(e){if(3===e.length)var a=t.getAlpha2Code(e);else var a=e;return a?'country'+a:null}}]),angular.module('rainbow').filter('countryFilter',['countryService',function(e){'use strict';return function(t){return e.getCountryName(t)}}])},function(){angular.module('rainbow').service('usersService',['$q','$log','$rootScope','contactService',function(e,t,a,r){'use strict';var n=this,o=[];this.started=!1,this.start=function(r){t.info('[usersService] === STARTING ==='),n.started=!0;var i=performance.now();t.info('[usersService] start'),n.contactsInRoster=n.getAllRosterContacts(),n.lastNameList=n.orderContactsByLastName(),n.firstNameList=n.orderContactByFirstName(),n.companyNameList=n.orderContactsByCompany(),o.push(a.$on('ON_CONTACT_ROSTER_UPDATE_EVENT',n.onContactUpdatedEvent));var s=Math.round(performance.now()-i);return r.push({service:'usersService',startDuration:s}),t.info('[usersService] === STARTED ('+s+' ms) ==='),e.when()},this.stop=function(){t.info('[usersService] === STOPPING ==='),n.started&&(n.started=!1);for(var a;a=o.pop();)a();return t.info('[usersService] === STOPPED ==='),e.when()},this.onContactUpdatedEvent=function(){t.info('[usersService] onContactUpdatedEvent');var e=n.getAllRosterContacts();0!=e.length-n.contactsInRoster.length&&(t.info('[usersService] onContactUpdatedEvent - update all user lists'),n.contactsInRoster=e,n.lastNameList=n.orderContactsByLastName(),n.firstNameList=n.orderContactByFirstName(),n.companyNameList=n.orderContactsByCompany(),a.$broadcast('ON_USER_SERVICE_ROSTER_UPDATE_EVENT'))},this.getLastNameList=function(){return n.lastNameList},this.getFirstNameList=function(){return n.firstNameList},this.getCompanyNameList=function(){return n.companyNameList},this.getAllRosterContacts=function(){return r.getContacts().filter(function(e){return e.displayName&&e.roster})},this.addSeparatorsForLastname=function(e){var t=[],a='';return e.forEach(function(e){if(a!==e.lastname.charAt(0).toUpperCase()){a=e.lastname.charAt(0).toUpperCase();var r={value:a,type:'separator',id:a};t.push(r)}t.push(e)}),t},this.orderContactsByLastName=function(){var e=n.contactsInRoster;return e=n.getOrderedUsers(e,'lastname'),n.addSeparatorsForLastname(e)},this.addSeparatorsForFirstname=function(e){var t=[],a='';return e.forEach(function(e){if(a!==e.firstname.charAt(0).toUpperCase()){a=e.firstname.charAt(0).toUpperCase();var r={value:a,type:'separator',id:a};t.push(r)}t.push(e)}),t},this.orderContactByFirstName=function(){var e=n.contactsInRoster;return e=n.getOrderedUsers(e,'firstname'),n.addSeparatorsForFirstname(e)},this.addSeparatorsForCompany=function(e){var t=[],a='';return e.forEach(function(e){if(a!==e.company.name){a=e.company.name;var r={value:a,type:'separator',id:a};t.push(r)}t.push(e)}),t},this.orderContactsByCompany=function(){var e=n.contactsInRoster;return e=n.getOrderedUsers(e,'company'),n.addSeparatorsForCompany(e)},this.getFilterAndOrderUsersGroupedByOrderLabel=function(e,t,a,r){r=!!(!0&r);var o=n.getFilterAndOrderUsers(e,t,a,r);if('firstname'===t)return n.addSeparatorsForFirstname(o);return'company'===t?n.addSeparatorsForCompany(o):n.addSeparatorsForLastname(o)},this.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity=function(e,t,a,r){r=!!(!0&r);var o=n.getFilterAndOrderUsers(e,t,a,r);if('firstname'===t)return n.addSeparatorsForFirstname(o);return'company'===t?n.addSeparatorsForCompany(o):n.addSeparatorsForLastname(o)},this.getFilterAndOrderUsers=function(e,t,a,r){var o=n.getFilteredUsers(e,a,r);return n.getOrderedUsers(o,t)},this.getFilteredUsers=function(e,t,a){var r=e.filter(function(e){if('separator'===e.type)return!0;var r=e.displayName&&e.roster||a,n='offline'!==e.status&&'wait'!==e.status&&'xa'!==e.status&&'unknown'!==e.status,o='wait'===e.status,i=e.isTerminated;if('online'===t)return r&&n;return'offline'===t?r&&!n&&!i:'pending'===t?r&&o:'all'===t?r&&!i:r}),r=r.filter(function(e,t){return!!('separator'!==e.type||r[t+1]&&'separator'!==r[t+1].type)});return r},this.getOrderedUsers=function(e,t){var a=e.sort(function(e,a){if('lastname'===t){var r=e.lastname.localeCompare(a.lastname);return 0===r?e.firstname.localeCompare(a.firstname):r}if('firstname'===t){var r=e.firstname.localeCompare(a.firstname);return 0===r?e.lastname.localeCompare(a.lastname):r}if('company'===t){var n=e.company.name.localeCompare(a.company.name);return 0===n?e.lastname.localeCompare(a.lastname):n}return 0});return a}}])},function(){angular.module('rainbow').service('utilService',['$log',function(t){'use strict';var e=[{base:'A',letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:'AA',letters:/[\uA732]/g},{base:'AE',letters:/[\u00C6\u01FC\u01E2]/g},{base:'AO',letters:/[\uA734]/g},{base:'AU',letters:/[\uA736]/g},{base:'AV',letters:/[\uA738\uA73A]/g},{base:'AY',letters:/[\uA73C]/g},{base:'B',letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:'C',letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:'D',letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:'DZ',letters:/[\u01F1\u01C4]/g},{base:'Dz',letters:/[\u01F2\u01C5]/g},{base:'E',letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:'F',letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:'G',letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:'H',letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:'I',letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:'J',letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:'K',letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:'L',letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:'LJ',letters:/[\u01C7]/g},{base:'Lj',letters:/[\u01C8]/g},{base:'M',letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:'N',letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:'NJ',letters:/[\u01CA]/g},{base:'Nj',letters:/[\u01CB]/g},{base:'O',letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:'OI',letters:/[\u01A2]/g},{base:'OO',letters:/[\uA74E]/g},{base:'OU',letters:/[\u0222]/g},{base:'P',letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:'Q',letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:'R',letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:'S',letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:'T',letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:'TZ',letters:/[\uA728]/g},{base:'U',letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:'V',letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:'VY',letters:/[\uA760]/g},{base:'W',letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:'X',letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:'Y',letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:'Z',letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:'a',letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:'aa',letters:/[\uA733]/g},{base:'ae',letters:/[\u00E6\u01FD\u01E3]/g},{base:'ao',letters:/[\uA735]/g},{base:'au',letters:/[\uA737]/g},{base:'av',letters:/[\uA739\uA73B]/g},{base:'ay',letters:/[\uA73D]/g},{base:'b',letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:'c',letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:'d',letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:'dz',letters:/[\u01F3\u01C6]/g},{base:'e',letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:'f',letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:'g',letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:'h',letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:'hv',letters:/[\u0195]/g},{base:'i',letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:'j',letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:'k',letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:'l',letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:'lj',letters:/[\u01C9]/g},{base:'m',letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:'n',letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:'nj',letters:/[\u01CC]/g},{base:'o',letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:'oi',letters:/[\u01A3]/g},{base:'ou',letters:/[\u0223]/g},{base:'oo',letters:/[\uA74F]/g},{base:'p',letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:'q',letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:'r',letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:'s',letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:'t',letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:'tz',letters:/[\uA729]/g},{base:'u',letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:'v',letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:'vy',letters:/[\uA761]/g},{base:'w',letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:'x',letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:'y',letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:'z',letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];this.removeDiacritis=function(t){for(var a=0;a<e.length;a++)t=t.replace(e[a].letters,e[a].base);return t},this.escapeHtml=function(e){return e.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')},this.extractHtmlContent=function(e){var a=new DOMParser,r='{}';try{r=a.parseFromString(e,'text/html').documentElement.textContent}catch(a){t.error('[utilService] error in extractHtmlContent:',a),r='{}'}return r},this.sortAlphaNum=function(e,t){var a=/[^a-zA-Z]/g,r=/[^0-9]/g,n=e.replace(a,''),o=t.replace(a,'');if(n===o){var i=parseInt(e.replace(r,''),10),s=parseInt(t.replace(r,''),10);return i===s?0:i>s?1:-1}return n>o?1:-1},this.anonymizePhoneNumber=function(e){if(null===e||'undefined'==typeof e)return null;if(config&&config.debug)return e;var t='';return 0===e.indexOf('+')&&(t='+'),t=4<e.length?t+'*'.repeat(e.length-4-t.length)+e.slice(e.length-4):e,t}}])},function(){},function(){var e=Math.ceil,t=String.fromCharCode,a=Math.round;class r{release(){URL.revokeObjectURL(this.url)}constructor(e,t){this.url=URL.createObjectURL(t),this.fd=e}}class n{constructor(e,t,a,r,n,o,i,s,d,c,l){this.$q=e,this.$http=t,this.$log=a,this.authService=r,this.fileStorageService=n,this.TransfertPromiseQueue=o,this.FileDescriptorEventHandler=i,this.xmppService=s,this.errorHelperService=d,this.$rootScope=c,this.$interval=l,this.ONE_KILOBYTE=1024,this.ONE_MEGABYTE=1048576,this.ONE_GIGABYTE=1073741824,this.started=!1,this.thumbnailPromises=[]}start(e){this.$log.info('[FileServerService] === STARTING ===');let t=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+'/api/rainbow/fileserver/v1.0/files',this.getServercapabilities().then(()=>{this.attachHandlers(),this.transfertPromiseQueue=this.TransfertPromiseQueue.create();var r=a(performance.now()-t);e.push({service:'FileServerService',startDuration:r}),this.$log.info('[FileServerService] === STARTED ('+r+' ms) ===')}).catch((e)=>{this.$log.error('[FileServerService] === STARTING FAILURE === '+e.message)}),this.$q.when()}stop(){return this.$log.info('[FileServerService] === STOPPING ==='),this.started&&(this.started=!1),this.$log.info('[FileServerService] === STOPPED ==='),this.$q.when()}attachHandlers(){this.removeHandlers(),this.fileDescriptorEventHandler=this.FileDescriptorEventHandler.create(this),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=this.xmppService.addHandler((e)=>(this.$interval(()=>{this.fileDescriptorEventHandler.onManagementMessageReceived(e)},250,1),!0),null,'message','management'))}removeHandlers(){this.fileDescriptorEventHandler=void 0,this.fileMessageHandlerRef=void 0}getLocalImage(e,t,a=!0){return this.$q((n,o)=>{let i=this.fileStorageService.getFileDescriptorById(e),s=i?this.$q.resolve(i):this.fileStorageService.retrieveAndStoreOneFileDescriptor(e);s.then((e)=>{let o=null;o=t&&e.previewBlob&&!a?this.$q.resolve(e.previewBlob):t?this.getLargeBlobThumbnail(e):this.getBlobFromFileDescriptor(e,!1,null),o.then((t)=>{n(new r(e,t))})}).catch(()=>{let t='[fileServerService] getFileLocalURL -- no file descriptor found with '+e+' id.';this.$log.error(t),o(new Error(t))})})}getLargeBlobThumbnail(e){let t=e.url+'?thumbnail500=true';return this.getBlobFromUrl(t,e.typeMIME,e.size,e.fileName)}getPartialDataFromServer(e,a,r,n){return this.$q((o,i)=>{this.$http({method:'GET',url:e,headers:this.authService.getRequestHeaderWithRange('bytes='+a+'-'+r),responseType:'arraybuffer'}).then((e)=>{o({data:e.data,index:n})},(e)=>{let a=this.errorHelperService.handleError(e),r=JSON.parse(t.apply(null,new Uint8Array(e.data))),n=this.errorHelperService.getLocalizedError(r.errorDetailsCode);this.$log.error(n),i(a)})})}getFileStorageService(){return this.fileStorageService}getBlobThumbnailFromFileDescriptor(e,t=!1){if(e.thumbnail.isThumbnailAvailable()||e.isImage()&&e.size<20*this.ONE_KILOBYTE){var a=this.thumbnailPromises[e.id];if(a)return this.$log.info('[FileServerService] getBlobThumbnailFromFileDescriptor '+e.id+' already lauched'),a.promise;var r=this.$q.defer();this.thumbnailPromises[e.id]=r;let n=e.url;return e.thumbnail.isThumbnailAvailable()&&e.size>=20*this.ONE_KILOBYTE?t?n+='?thumbnail500=true':n+='?thumbnail=true':e.uploadedDate&&(n+='?update='+MD5.hexdigest(e.uploadedDate)),this.getBlobFromUrl(n,e.typeMIME,e.size,e.fileName).then((t)=>{e.previewBlob=t,this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'success',type:'download',fileDesc:e}),delete this.thumbnailPromises[e.id],r.resolve(t)}).catch((t)=>{this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'failure',type:'download',message:t.message,fileDesc:e}),delete this.thumbnailPromises[e.id],r.reject(t)}),r.promise}return this.$q.reject()}getBlobFromFileDescriptor(a,r=!0,n){if(!a)return this.$log.warn('[FileServerService] getBlobFromFileDescriptor : missing file descriptor'),this.$q.reject();if(this.$log.info('[FileServerService] getBlobFromFileDescriptor: '+a.id),'uploaded'!==a.state)return this.$log.warn('[FileServerService] getBlobFromFileDescriptor : file is not in uploaded state='+a.state),this.$q.reject();let o=a.url;a.uploadedDate&&(o+='?update='+MD5.hexdigest(a.uploadedDate));let s=this.ONE_MEGABYTE;if(!!this.capabilities.maxChunkSizeDownload&&0!==a.size&&a.size>s){a.size>=100*s&&(s=a.size/100+this.ONE_KILOBYTE,this.$log.debug('[FileServerService] changing chunk size: '+s));var i=this.$q.defer();let l=[],p=[];a.state='downloading',a.chunkTotalNumber=e(a.size/s),a.chunkPerformed=0,a.chunkPerformedPercent=0,this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{type:'download',fileDesc:a,cancelable:r}),this.$log.info('[FileServerService] getBlobFromFileDescriptor: need to download '+a.chunkTotalNumber+' chunks');for(let t=0,i=0,d=s-1,c=e(a.size/s);0<c;t++,c--,i+=s,d+=s)d=d<a.size?d:a.size,p.push(()=>{var e=this.$q.defer();return this.getPartialDataFromServer(o,i,d,t).then((t)=>(a.chunkPerformed++,a.chunkPerformedPercent=100*a.chunkPerformed/a.chunkTotalNumber,this.$log.info('[FileServerService] getBlobFromFileDescriptor : chunk downloaded='+a.chunkPerformed),l[t.index]=t.data,this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{type:'download',fileDesc:a,cancelable:r}),n?n(t,a.id).then(()=>e.resolve(t.data)):e.resolve(t))).catch((t)=>{this.$log.info('[FileServerService] error on chunk download='+t),e.reject(t)}),e.promise});var d=()=>{let e=new Blob(l,{type:a.typeMIME});this.$log.info('[FileServerService] getBlobFromFileDescriptor success'),a.state='uploaded',a.chunkPerformed=0,a.chunkTotalNumber=0,a.chunkPerformedPercent=0,this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{type:'download',fileDesc:a}),i.resolve(e)},c=(e)=>{let r=this.errorHelperService.handleError(e);a.state='uploaded',a.chunkPerformed=0,a.chunkTotalNumber=0,a.chunkPerformedPercent=0;let n=JSON.parse(t.apply(null,new Uint8Array(e.data))),o=this.errorHelperService.getLocalizedError(n.errorDetailsCode);this.$log.error(o),this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'failure',type:'download',message:o?o:r.message,fileDesc:a}),i.reject(r)};return this.transfertPromiseQueue.addPromiseArray(a.id,p,d,c),i.promise}return a.state='downloading',a.chunkTotalNumber=1,a.chunkPerformed=0,a.chunkPerformedPercent=0,this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{fileDesc:a,cancelable:!1}),this.getBlobFromUrl(o,a.typeMIME,a.size,a.fileName).then((e)=>(a.state='uploaded',this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{fileDesc:a}),this.$q.resolve(e))).catch((e)=>(a.state='uploaded',this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{fileDesc:a}),this.$log.info('[FileServerService] arrayPromise : error '+e.message),this.$q.reject(e)))}getBlobFromUrl(e,a){return this.$log.debug('[FileServerService] >getBlobFromUrl: '+e),this.$q((r,n)=>{this.$http({method:'GET',url:e,headers:this.authService.getRequestHeader(),responseType:'arraybuffer'}).then((e)=>{let t=new Blob([e.data],{type:a});this.$log.debug('[FileServerService] getBlobFromUrl success'),r(t)},(e)=>{let a=this.errorHelperService.handleError(e),r=JSON.parse(t.apply(null,new Uint8Array(e.data))),o=this.errorHelperService.getLocalizedError(r.errorDetailsCode);this.$log.error(o),n(a)})})}getBlobUrlAndOrientationByFileDescriptorId(e){return this.$q((t,a)=>{let r=this.fileStorageService.getFileDescriptorById(e);r?this.getBlobFromFileDescriptor(r,!1,null).then((a)=>{let n={blobUrl:URL.createObjectURL(a),id:e};return r.orientation?(n.orientation=r.orientation,void t(n)):void this.setImageOrientationForFileDescriptor(r,a).then((e)=>{n.orientation=e,t(n)}).catch(()=>{t(n)})}).catch((e)=>{a(e)}):(this.$log.error('[FileServerService] getBlobUrlAndOrientationById no file descriptor found for ID '+e),a(new Error('[FileServerService] getBlobUrlAndOrientationById no file descriptor found')))})}setImageOrientationForFileDescriptor(t,e){return this.$q((a,r)=>{if(!t||!t.isImage())return void r();var n=new FileReader;n.onload=(n)=>{t.orientation=1;var e=n.target.result,o=new DataView(e);if(65496!==o.getUint16(0,!1))return void r();for(var s=o.byteLength,d=2;d<s;){if(8>=o.getUint16(d+2,!1))return void r();var c=o.getUint16(d,!1);if(d+=2,65505===c){if(1165519206!==o.getUint32(d+=2,!1))return void r();var l=18761===o.getUint16(d+=6,!1);d+=o.getUint32(d+4,l);var p=o.getUint16(d,l);d+=2;for(var u=0;u<p;u++)if(274===o.getUint16(d+12*u,l)){var i=o.getUint16(d+12*u+8,l);return t.orientation=i,void a(i)}}else if(65280!=(65280&c))break;else d+=o.getUint16(d,!1)}r()},n.readAsArrayBuffer(e)})}uploadAFile(e,t){return this.$q((a,r)=>{let n=this.fileStorageService.getFileDescriptorById(e);n&&(n.state='uploading'),this.$http({method:'PUT',url:this.portalURL+'/'+e,headers:this.authService.getPostHeader('application/octet-stream'),data:t,uploadEventHandlers:{progress:(t)=>{this.$log.log(t)}}}).then(()=>{let t=this.fileStorageService.getFileDescriptorById(e);t&&(t.state='uploaded'),this.$log.info('[FileServerService] uploadAFile success'),this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'success',type:'upload',fileDesc:t}),this.fileStorageService.orderDocuments(),a(t)},(e)=>{let t=this.errorHelperService.handleError(e);this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'failure',type:'upload',fileDesc:n}),r(t),this.$log.error('[FileServerService] '+t.message)})})}sendPartialDataToServer(e,t,a,r,n,o){return this.$q((i,s)=>{this.$http({method:'PUT',url:this.portalURL+'/'+e+'/parts/'+o,headers:this.authService.getPostHeaderWithRange('bytes '+r+'-'+n+'/'+a,'application/octet-stream'),data:t,uploadEventHandlers:{progress:(t)=>{this.$log.log(t)}}}).then((e)=>{let t=e.data.data;this.$log.info('[FileServerService] sendPartialDataToServer success'),i(t)},(e)=>{let t=this.errorHelperService.handleError(e);s(t),this.$log.error('[FileServerService] '+t.message)})})}calculateMd5(e,t){var a=new FileReader;a.readAsBinaryString(e),a.onloadend=()=>{var e=MD5.hash(a.result),r=this.asciiToHex(e);t(r)}}asciiToHex(e){for(var t=[],a=0;a<e.length;a++){let r=(+e.charCodeAt(a)).toString(16);r.length%2&&(r='0'+r),t.push(r)}return t.join('')}uploadAFileByChunk(t,r,n,o){this.$log.info('[FileServerService] >uploadAFileByChunk');let s=this.ONE_MEGABYTE;if(s<r.size){r.size>=100*s&&(s=a(r.size/100+this.ONE_KILOBYTE),this.$log.debug('[FileServerService] changing chunk size: '+s));var i=this.$q.defer();t.chunkTotalNumber=e(r.size/s),t.chunkPerformed=0,t.chunkPerformedPercent=0,t.state='uploading',this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{fileDesc:t,cancelable:!0});let l=[];for(let a=0,i=0,d=s-1,c=e(r.size/s);0<c;a++,c--,i+=s,d+=s){let e=d<r.size?d:r.size,s=r.slice(i,e+1);l.push(()=>{var d=this.$q.defer();return this.calculateMd5(s,(c)=>{this.$log.info('[FileServerService] sendPartialDataToServer calculated checksum='+c),this.sendPartialDataToServer(t.id,s,r.size,i,e,a).then((e)=>{if(this.$log.info('[FileServerService] sendPartialDataToServer md5sum='+e.md5sum),e.md5sum.localeCompare(c)){this.$log.error('[FileServerService] Wrong Checksum for chunk detected: '+e.md5sum+'/'+c);d.reject({errorDetailsCode:500,message:'Wrong Checksum for chunk'})}else return t.chunkPerformed++,t.chunkPerformedPercent=100*t.chunkPerformed/t.chunkTotalNumber,o&&o(n,t),this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{fileDesc:t,cancelable:!0}),d.resolve(e)}).catch((e)=>{this.$log.info('[FileServerService] error on chunk upload='+e),d.reject(e)})}),d.promise})}var d=()=>{this.$http({method:'PUT',url:this.portalURL+'/'+t.id+'/parts/end',headers:this.authService.getPostHeader('application/octet-stream'),uploadEventHandlers:{progress:(t)=>{this.$log.log(t)}}}).then(()=>{this.$log.info('[FileServerService] uploadAFileByChunk success'),t.state='uploaded',t.chunkPerformed=0,t.chunkTotalNumber=0,t.chunkPerformedPercent=0,o&&o(n,t),this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'success',type:'upload',fileDesc:t}),this.fileStorageService.orderDocuments(),this.fileStorageService.retrieveUserConsumption(),i.resolve(t)},(e)=>{let a=this.errorHelperService.handleError(e);this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'failure',type:'upload',fileDesc:t}),i.reject(a)})},c=(e)=>{let a=this.errorHelperService.handleError(e);this.$rootScope.$broadcast('ON_FILE_TRANSFER_EVENT',{result:'failure',type:'upload',fileDesc:t}),i.reject(a)};return this.transfertPromiseQueue.addPromiseArray(t.id,l,d,c),i.promise}return o&&o(n,t),this.uploadAFile(t.id,r,t.typeMIME).then(()=>(this.$log.info('[FileServerService] uploadAFile success'),o&&o(n,t),this.fileStorageService.retrieveUserConsumption(),this.$q.resolve(t)))}isTransferInProgress(){return this.transfertPromiseQueue.isTransferInProgress()}cancelAllTransfers(){this.transfertPromiseQueue.cancelAllTransfers()}cancelCurrentFiletransfer(e){this.transfertPromiseQueue.cancelCurrentFiletransfer(e)}getServercapabilities(){return this.$q((e,t)=>{this.$http({method:'GET',url:config.restServerUrl+'/api/rainbow/fileserver/v1.0/capabilities',headers:this.authService.getRequestHeader()}).then((t)=>{this.$log.info('[FileServerService] getServercapabilities -- success'),this.capabilities=t.data.data,e(this.capabilities)},(e)=>{let a=this.errorHelperService.handleError(e);this.$log.error('[FileServerService] getServercapabilities '+a.message),t(a)})})}getBlobFromUrlWithOptimization(a,r,n=0,o='',i=''){return 0!==i.length&&(a+='?update='+MD5.hexdigest(i)),!!this.capabilities.maxChunkSizeDownload&&0!==n&&n>this.capabilities.maxChunkSizeDownload?this.$q((o,i)=>{let s=this.capabilities.maxChunkSizeDownload;s>this.ONE_MEGABYTE&&(s=this.ONE_MEGABYTE);let d=0,c=s-1,l=e(n/s),p=Array(l);this.$log.debug('[FileServerService] getBlobFromUrlWithOptimization : '+l+' chunks to be downloaded');let u=[];for(let e=0;0<l;e++,l--,d+=s,c+=s)u.push(this.getPartialDataFromServer(a,d,c,e).then((e)=>(p[e.index]=e.data,e.data)));this.$q.all(u).then(()=>{let e=new Blob(p,{type:r});this.$log.debug('[FileServerService] getBlobFromUrlWithOptimization success'),o(e)},(e)=>{let a=this.errorHelperService.handleError(e),r=JSON.parse(t.apply(null,new Uint8Array(e.data))),n=this.errorHelperService.getLocalizedError(r.errorDetailsCode);this.$log.error(n),i(a)})}):this.getBlobFromUrl(a,r,n,o)}getBlobUrlFromUrl(e,t,a=0,r=''){return this.$q((n,o)=>{this.getBlobFromUrlWithOptimization(e,t,a,r).then((e)=>{n(URL.createObjectURL(e))}).catch((e)=>{o(e)})})}}n.$inject=['$q','$http','$log','authService','fileStorageService','TransfertPromiseQueue','FileDescriptorEventHandler','xmppService','errorHelperService','$rootScope','$interval'],angular.module('rainbow').service('fileServerService',n)},function(){class e{constructor(e,t,a,r,n,o,i,s,d,c,l,p,u){this.$injector=e,this.$q=t,this.$http=a,this.$log=r,this.$rootScope=n,this.authService=o,this.fileViewerFactory=i,this.errorHelperService=s,this.orderByFilter=d,this.contactService=c,this.helpersService=l,this.fileViewerElementFactory=p,this.fileDescriptorFactory=u,this.started=!1,this.rotationValues={1:'rotate(0deg)',3:'rotate(180deg)',6:'rotate(90deg)',8:'rotate(270deg)'}}start(e){this.$log.info('[FileStorageService] === STARTING ===');let t=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+'/api/rainbow/filestorage/v1.0/files',this.fileDescriptors=[],this.fileDescriptorsByDate=[],this.fileDescriptorsByName=[],this.fileDescriptorsBySize=[],this.receivedFileDescriptors=[],this.receivedFileDescriptorsByName=[],this.receivedFileDescriptorsByDate=[],this.receivedFileDescriptorsBySize=[],this.consumptionData={},this.channelService=this.$injector.get('channelService'),this.retrieveFileDescriptorsListPerOwner().then(()=>this.retrieveReceivedFiles(this.contactService.userContact.dbId)).then(()=>(this.orderDocuments(),this.retrieveUserConsumption())).then(()=>{this.started=!0;var a=Math.round(performance.now()-t);e.push({service:'FileStorageService',startDuration:a}),this.$log.info('[FileStorageService] === STARTED ('+a+' ms) ===')}).catch((e)=>{this.$log.error('[FileStorageService] === STARTING === failure -- '+e.message)}),this.$rootScope.$on('ROOM_UPDATE_EVENT',(e,t,a)=>{a&&'remove'===a&&(this.$log.info('[FileStorageService] ROOM_UPDATE_EVENT REMOVED for roomId='+t.dbId),this.removeRoomFileViewer(t))}),this.$q.when()}stop(){return this.$log.info('[FileStorageService] === STOPPING ==='),this.started&&(this.started=!1),this.$log.info('[FileStorageService] === STOPPED ==='),this.$q.when()}reinit(e){return this.$q((t,a)=>e?void(this.$log.info('[FileStorageService] === reinit blocking ==='),this.reinitInternal().then(()=>{t()}).catch(()=>{a()})):(this.$log.info('[FileStorageService] === reinit not blocking ==='),t(),void this.reinitInternal()))}reinitInternal(){return this.$q((e,t)=>{this.retrieveFileDescriptorsListPerOwner().then(()=>this.retrieveReceivedFiles(this.contactService.userContact.dbId)).then(()=>{this.orderDocuments(),this.$log.info('[FileStorageService] reinitInternal done'),e()}).catch((e)=>{this.$log.error('[FileStorageService] reinitInternal failure -- '+e.message),t()})})}removeRoomFileViewer(e){this.$log.info('[FileStorageService] >removeRoomFileViewer: '+e.dbId);let t;do if(t=this.getFileDescriptorByViewerId(e.dbId),t){var a=t.viewers.find((t)=>t.viewerId===e.dbId);a&&(this.$log.info('[FileStorageService] >viewer found delete it'),t.viewers.splice(t.viewers.indexOf(a),1))}while(t)}getFileDescriptorByViewerId(e){for(let t of this.fileDescriptors)for(let a of t.viewers)if(a.viewerId===e)return t;for(let t of this.receivedFileDescriptors)if(t.id===e)return t;return null}getFileDescriptorById(e){for(let t of this.fileDescriptors)if(t.id===e)return t;for(let t of this.receivedFileDescriptors)if(t.id===e)return t;return null}getCompleteFileDescriptorById(e){return this.$q((t,a)=>{let r;if(this.fileDescriptors.some((t)=>t.id===e&&(r=t,!0))){let e=[];for(let t of r.viewers)if('user'===t.type)e.push(this.contactService.getContactByDBId(t.viewerId).then((e)=>(t.contact=e,t)).catch((e)=>{this.$log.error('[FileStorageService] '+e),a(e)}));else;this.$q.all(e).then(()=>{t(r)}).catch((e)=>{this.$log.error('[FileStorageService] '+e),a(e)})}else a()})}getDocuments(){return this.fileDescriptors}getReceivedDocuments(){return this.receivedFileDescriptors}getDocumentsByName(e){return e?this.receivedFileDescriptorsByName:this.fileDescriptorsByName}getDocumentsByDate(e){return e?this.receivedFileDescriptorsByDate:this.fileDescriptorsByDate}getDocumentsBySize(e){return e?this.receivedFileDescriptorsBySize:this.fileDescriptorsBySize}getReceivedFilesFromContact(e){let t=this.receivedFileDescriptorsByDate.filter((t)=>t.ownerId===e);return t}getSentFilesToContact(e){let t=this.fileDescriptorsByDate.filter((t)=>{for(let a=0;a<t.viewers.length;a++)if(t.viewers[a].viewerId===e)return!0;return!1});return t}getReceivedFilesForRoom(e){let t=this.receivedFileDescriptorsByDate.filter((t)=>{for(let a=0;a<t.viewers.length;a++)if(t.viewers[a].viewerId===e&&t.ownerId!==this.contactService.userContact.dbId)return!0;return!1});return t}getConsumptionData(){return this.consumptionData}createFileDescriptor(e,t,a,r){return this.$q((n,o)=>{this.$http({method:'POST',url:this.portalURL,headers:this.authService.getRequestHeader(),data:{fileName:e,extension:t,size:a,viewers:r}}).then((e)=>{const t=this.createFileDescriptorFromData(e.data.data);this.$log.info('[FileStorageService] createFileDescriptor -- '+t.id+' -- success'),t&&this.fileDescriptors.push(t),this.orderDocuments(),n(t)}).catch((e)=>{const t=this.errorHelperService.handleError(e,'createFileDescriptor');this.$log.error('[FileStorageService] '+t.message),o(t)})})}createFileDescriptorFromData(e){if(e){let a=[];if(e.viewers)for(let t of e.viewers)a.push(this.fileViewerElementFactory(t.viewerId,t.type,t.contact,this.contactService,this.channelService));let r=e.url;r||(r=config.restServerUrl+'/api/rainbow/fileserver/v1.0/files/'+e.id);var t='unknown';return t=e.isUploaded?'uploaded':'not_uploaded',this.fileDescriptorFactory(e.id,r,e.ownerId,e.fileName,e.extension,e.typeMIME,e.size,e.registrationDate,e.uploadedDate,e.dateToSort,a,t,e.thumbnail,e.orientation)}}deleteFileDescriptor(e){return this.$q((t,a)=>{this.$http({method:'DELETE',url:this.portalURL+'/'+e,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info('[FileStorageService] deleteFileDescriptor -- success'),this.deleteFileDescriptorFromCache(e,!1),this.$rootScope.$broadcast('ON_FILE_REMOVED_FROM_STORE_EVENT',{fileId:e}),this.retrieveUserConsumption(),t(void 0)}).catch((e)=>{let t=this.errorHelperService.handleError(e,'deleteFileDescriptor');a(t),this.$log.error('[FileStorageService] '+t.message)})})}deleteAllFileDescriptor(){return this.$q((e,t)=>{this.$http({method:'DELETE',url:this.portalURL+'/all',headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info('[FileStorageService] deleteAllFileDescriptor -- success'),this.deleteAllFilesDescriptorsFromCache(),this.retrieveUserConsumption(),e()}).catch((e)=>{let a=this.errorHelperService.handleError(e,'deleteAllFileDescriptor');this.$log.error('[FileStorageService]'+a.message),t(a)})})}retrieveFileDescriptorsListPerOwner(){return this.fileDescriptors||(this.fileDescriptors=[]),this.$q((e,t)=>{this.$http({method:'GET',url:this.portalURL+'?format=full&limit=1000',headers:this.authService.getRequestHeader()}).then((t)=>{this.fileDescriptors=[];let a=t.data.data;a||e();let r=t.data.limit,n=t.data.total,o=null;if(n<=r)o=this.$q.resolve([]);else{let e=r,t=[];for(let a=1;a<n/r;a++)t.push(this.retrieveFileDescriptorsListPerOwnerwithOffset(e,r)),e+=r;o=this.$q.all(t)}o.then((t)=>{t.forEach((e)=>{a=a.concat(e)});for(let e of a){let t=this.createFileDescriptorFromData(e);'not_uploaded'===t.state?(this.$log.info('[FileStorageService] file '+t.fileName+' not uploaded'),t.ownerId===this.contactService.userContact.dbId?(this.$log.info('[FileStorageService] file '+t.fileName+' is our property, we can delete it'),this.deleteFileDescriptor(t.id)):this.$log.info('[FileStorageService] file '+t.fileName+' is NOT our property, we CANNOT delete it')):this.fileDescriptors.push(t)}this.$log.info('[FileStorageService] retrieveFileDescriptorsListPerOwner -- success'),e(this.fileDescriptors)})}).catch((e)=>{let a=this.errorHelperService.handleError(e,'retrieveFileDescriptorsListPerOwner');t(a),this.$log.error('[FileStorageService] '+a.message)})})}retrieveFileDescriptorsListPerOwnerwithOffset(e,t){return this.$q((a)=>{this.$http({method:'GET',url:this.portalURL+'?format=full&limit='+t+'&offset='+e,headers:this.authService.getRequestHeader()}).then((e)=>{a(e.data.data)})})}retrieveFilesReceivedFromPeer(e,t){return this.$q((a,r)=>{this.$http({method:'GET',url:this.portalURL+'/viewers/'+e+'?ownerId='+t+'&format=full',headers:this.authService.getRequestHeader()}).then((e)=>{let t=[],r=e.data.data;if(r)for(let e of r){let a=this.createFileDescriptorFromData(e);t.push(a)}this.$log.info('[FileStorageService] retrieveFilesReceivedFromPeer success'),a(t)}).catch((e)=>{let t=this.errorHelperService.handleError(e,'retrieveFilesReceivedFromPeer');this.$log.error('[FileStorageService] '+t.message),r(t)})})}retrieveSentFiles(e){return this.$log.info('[FileStorageService] >retrieveSentFiles'),this.$q((t,a)=>{this.$http({method:'GET',url:this.portalURL+'?format=full&viewerId='+e,headers:this.authService.getRequestHeader()}).then((e)=>{let a=[],r=e.data.data;if(r)for(let e of r){let t=this.createFileDescriptorFromData(e);'not_uploaded'===t.state?this.$log.warn('[FileStorageService] file '+t.fileName+' not uploaded'):a.push(t)}this.$log.info('[FileStorageService] retrieveSentFiles success'),t(a)}).catch((e)=>{let t=this.errorHelperService.handleError(e,'retrieveSentFiles');this.$log.error('[FileStorageService] '+t.message),a(t)})})}retrieveReceivedFilesForRoom(e){return this.$q((t,a)=>{this.$http({method:'GET',url:this.portalURL+'/viewers/'+e+'?format=full',headers:this.authService.getRequestHeader()}).then((e)=>{let a=e.data.data,r=[];a?(a.forEach((e)=>{if(e.ownerId!==this.contactService.userContact.dbId){e.viewers=[];let t=this.createFileDescriptorFromData(e);r.push(t),this.receivedFileDescriptors.find((t)=>t.id===e.id)||this.receivedFileDescriptors.push(t)}}),t(r)):t(r)}).catch((e)=>{let t=this.errorHelperService.handleError(e,'retrieveReceivedFilesForRoom');this.$log.error('[FileStorageService] '+t.message),a(t)})})}retrieveReceivedFiles(e){return this.receivedFileDescriptors||(this.receivedFileDescriptors=[]),this.$q((t,a)=>{this.$http({method:'GET',url:this.portalURL+'/viewers/'+e+'?format=full&limit=1000',headers:this.authService.getRequestHeader()}).then((a)=>{this.receivedFileDescriptors=[];let r=a.data.data;if(!r)return void t();let n=a.data.limit,o=a.data.total,i=null;if(o<=n)i=this.$q.resolve([]);else{let t=n,a=[];for(let r=1;r<o/n;r++)a.push(this.retrieveReceivedFilesWithOffset(e,t,n)),t+=n;i=this.$q.all(a)}i.then((e)=>{e.forEach((e)=>{r=r.concat(e)});for(let t of r){let e=this.createFileDescriptorFromData(t);if(e.ownerId!==this.contactService.userContact.dbId){let t=this.getFileDescriptorById(e.id);t&&(e.previewBlob=t.previewBlob),this.receivedFileDescriptors.push(e)}}this.orderReceivedDocuments(),this.$log.info('[FileStorageService] retrieveReceivedFiles -- success'),t(this.receivedFileDescriptors)})}).catch((e)=>{let t=this.errorHelperService.handleError(e,'retrieveReceivedFiles');this.$log.error('[FileStorageService] '+t.message),a(t)})})}retrieveReceivedFilesWithOffset(e,t,a){return this.$q((r)=>{this.$http({method:'GET',url:this.portalURL+'/viewers/'+e+'?format=full&limit='+a+'&offset='+t,headers:this.authService.getRequestHeader()}).then((e)=>{r(e.data.data)})})}retrieveUserConsumption(){return this.$q((e,t)=>{this.$http({method:'GET',url:config.restServerUrl+'/api/rainbow/filestorage/v1.0/users/consumption',headers:this.authService.getRequestHeader()}).then((t)=>{this.consumptionData=t.data.data,this.$log.info('[FileStorageService] retrieveUserConsumption success'),this.$rootScope.$broadcast('ON_CONSUMPTION_DATA_UPDATED_EVENT'),e(this.consumptionData)}).catch((e)=>{let a=this.errorHelperService.handleError(e,'retrieveUserConsumption');this.$log.error('[FileStorageService] '+a.message),t(a)})})}deleteFileViewer(e,t){return this.$q((a,r)=>{this.$http({method:'DELETE',url:this.portalURL+'/'+t+'/viewers/'+e,headers:this.authService.getRequestHeader()}).then((r)=>{this.$log.info('[FileStorageService] deleteFileViewer '+r.statusText);let n=this.getFileDescriptorById(t);if(n){let t=-1;for(let a=0;a<n.viewers.length;a++)if(n.viewers[a].viewerId===e){t=a;break}-1!==t&&n.viewers.splice(t,1)}a()},(e)=>{let t=this.errorHelperService.handleError(e,'deleteFileViewer');r(t),this.$log.error('[FileStorageService] '+t.message)})})}addFileViewer(e,t,a){let r=this.getFileDescriptorById(e);return r&&r.isAlreadyFileViewer(t)?this.$q.resolve(r):this.$q((r,n)=>{this.$http({method:'POST',url:this.portalURL+'/'+e+'/viewers',headers:this.authService.getRequestHeader(),data:{viewerId:t,type:a}}).then((a)=>{this.$log.info('[FileStorageService] addFileViewer success');let o=this.getFileDescriptorById(e);if(o){var i=this.fileViewerFactory([{viewerId:a.data.data.viewerId,type:a.data.data.type}])[0];'user'===i.type?this.contactService.getContactByDBId(t).then((e)=>{i.contact=e,o.viewers.push(i),r(o)}).catch((e)=>{this.$log.error('[FileStorageService] '+e),n(e)}):(o.viewers.push(i),r(o))}},(e)=>{const t=this.errorHelperService.handleError(e,'addFileViewer');n(t),this.$log.error('[FileStorageService] '+t.message)})})}copyFileToUserCloudStorage(e){return this.$q((t,a)=>{this.$http({method:'POST',url:this.portalURL+'/'+e+'/copy',headers:this.authService.getRequestHeader()}).then((r)=>{this.$log.info('[FileStorageService] copyFileToUserCloudStorage | copyFile '+e+' -- success'),this.retrieveAndStoreOneFileDescriptor(r.data.data.id,!0).then((e)=>{t(e)}).catch((e)=>{a(e)})}).catch((e)=>{let t=this.errorHelperService.handleError(e,'copyFileToUserCloudStorage');this.$log.error('[FileStorageService] copyFileToUserCloudStorage '+t.message),a(t)})})}retrieveOneFileDescriptor(e){return this.$q((t,a)=>{this.$http({method:'GET',url:this.portalURL+'/'+e+'?format=full',headers:this.authService.getRequestHeader()}).then((a)=>{let r=this.createFileDescriptorFromData(a.data.data);this.$log.info('[FileStorageService] getOneFileDescriptor '+e+' -- success'),t(r)}).catch((e)=>{let t=this.errorHelperService.handleError(e,'getOneFileDescriptor');this.$log.error('[FileStorageService] '+t.message),a(t)})})}retrieveAndStoreOneFileDescriptor(e,t){let a=this.getFileDescriptorById(e);return a&&!t?(this.$log.info('[FileStorageService] retrieveAndStoreOneFileDescriptor -- return existing fileDescriptor '+e),this.$q.resolve(a)):this.retrieveOneFileDescriptor(e).then((e)=>{a&&a.isImage()&&(e.previewBlob=a.previewBlob);let t=this.helpersService.findIndex(this.fileDescriptors,(t)=>t.id===e.id);-1<t&&this.fileDescriptors.splice(t,1);let r=this.helpersService.findIndex(this.receivedFileDescriptors,(t)=>t.id===e.id);if(-1<r&&this.receivedFileDescriptors.splice(r,1),e.ownerId===this.contactService.userContact.dbId)this.fileDescriptors.push(e),this.$log.info('[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor '+e.id+' -- now stored in my files');else{this.receivedFileDescriptors.push(e),this.$log.info('[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor '+e.id+' -- now stored in received files'),this.$rootScope.$broadcast('ON_MESSAGE_WITH_FILE_RECEIVED_EVENT')}return this.orderDocuments(),this.$rootScope.$broadcast('ON_FILE_DESCRIPTOR_RECEIVED_EVENT',{fileId:e.id}),this.$q.resolve(e)}).catch((e)=>{this.$log.warn('[FileStorageService] Error on getting FileDescriptor: '+e.errorDetailsCode);let t=this.errorHelperService.handleError(e,'retrieveAndStoreOneFileDescriptor');return 400<=t.status&&500>t.status&&a&&(404===t.status&&this.deleteFileDescriptorFromCache(a.id,!0),this.orderDocuments(),this.$log.debug('[FileStorageService] Sending ON_FILE_REMOVED_FROM_STORE_EVENT'),this.$rootScope.$broadcast('ON_FILE_REMOVED_FROM_STORE_EVENT',{fileId:a.id})),this.$q.reject(e)})}deleteFileDescriptorFromCache(e,t){this.$log.info('[FileStorageService] deleteFileDescriptorFromCache '+e);for(let a=0;a<this.receivedFileDescriptors.length;a++)if(this.receivedFileDescriptors[a].id===e){this.receivedFileDescriptors.splice(a,1);break}for(let a=0;a<this.fileDescriptors.length;a++)if(this.fileDescriptors[a].id===e){t?this.fileDescriptors.splice(a,1):this.fileDescriptors[a].state='deleted';break}this.orderDocuments()}deleteAllFilesDescriptorsFromCache(){this.$log.info('[FileStorageService] deleteAllFilesDesceiptorsFromCache'),this.fileDescriptors.forEach((e)=>{e.state='deleted',this.receivedFileDescriptors.forEach((t,a)=>{t.id===e.id&&this.receivedFileDescriptors.splice(a,1)})}),this.fileDescriptors=[],this.orderDocuments()}orderDocuments(){this.$log.debug('[FileStorageService] orderDocuments: '+this.fileDescriptors.length),this.replaceOrderedByFilter(this.fileDescriptorsByDate,this.fileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.fileDescriptorsByName,this.fileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.fileDescriptorsBySize,this.fileDescriptors,this.getSize,!1,this.sortBySize),this.orderReceivedDocuments()}orderReceivedDocuments(){this.$log.debug('[FileStorageService] orderReceivedDocuments: '+this.receivedFileDescriptors.length),this.replaceOrderedByFilter(this.receivedFileDescriptorsByName,this.receivedFileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.receivedFileDescriptorsByDate,this.receivedFileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.receivedFileDescriptorsBySize,this.receivedFileDescriptors,this.getSize,!1,this.sortBySize)}orderDocumentsForRoom(e){return this.orderByFilter(e,this.getDate,!1,this.sortByDate)}replaceOrderedByFilter(e,t,a,r,n){this.$log.debug('[FileStorageService] replaceOrderedByFilter'),e.length=0;let o=this.orderByFilter(t,a,r,n);for(let i of o)'deleted'!==i.state&&e.push(i)}getName(e){let t={name:'',date:''};e.fileName&&(t.name=e.fileName);let a;return a=e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort),t.date=a.getTime(),t}getDate(e){let t;return t=e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort),t.getTime()}getSize(e){let t={name:'',size:''};return e.name&&(t.name=e.fileName),t.size=e.size,t}sortByName(e,t){let a=-1;return e.value.name&&t.value.name&&(a=e.value.name.localeCompare(t.value.name),0===a&&(a=t.value.date-e.value.date)),a}sortBySize(e,t){let a=-1;return e.value.size&&t.value.size&&(a=t.value.size-e.value.size),a}sortByDate(e,t){let a=1;return e&&t&&(a=t.value-e.value),a}extractFileIdFromUrl(e){let t=e.split('/'),a=t.pop()||t.pop();return a}}e.$inject=['$injector','$q','$http','$log','$rootScope','authService','fileViewerFactory','errorHelperService','orderByFilter','contactService','helpersService','fileViewerElementFactory','fileDescriptorFactory'],angular.module('rainbow').service('fileStorageService',e)},function(){angular.module('rainbow').factory('FileDescriptorEventHandler',['$log','$rootScope','contactService',function(e,t,a){'use strict';function r(r){var n=this;this.fileServerService=r,this.fileStorageService=r.getFileStorageService(),n.onManagementMessageReceived=function(t){try{var a=$(t);return 0<a.find('file').length?this.manageFileStanzaData(a.find('file')):0<a.find('thumbnail').length?this.manageThumbnailStanzaData(a.find('thumbnail')):e.info('[FileDescriptorEventHandler] onManagementMessageReceived  -- ignore the message'),!0}catch(t){return e.error('[FileDescriptorEventHandler] onManagementMessageReceived ERROR '+t),!0}},n.manageFileStanzaData=function(r){for(var o=$(r).attr('action'),s=$(r).find('fileid'),d=!1,c=0;c<s.length;c++){var i=$(s[c]).text(),l=this.fileStorageService.getFileDescriptorById(i);switch(e.info('[FileDescriptorEventHandler] manageFileStanzaData -- '+o+' fileDescriptor '+i),o){case'create':e.debug('[FileDescriptorEventHandler] fileDescriptor '+i+' created on server -- do nothing');break;case'delete':l&&(l.ownerId===a.userContact.dbId&&'deleted'!==l.state&&(d=!0),this.fileStorageService.deleteFileDescriptorFromCache(i),t.$broadcast('ON_FILE_REMOVED_FROM_STORE_EVENT',{fileId:i}));break;case'update':l||(d=!0),n.fileStorageService.retrieveAndStoreOneFileDescriptor(i,!0).then(function(t){e.info('[FileDescriptorEventHandler] fileDescriptor retrieved'),t.previewBlob||n.fileServerService.getBlobThumbnailFromFileDescriptor(t).then(function(e){t.previewBlob=e})});break;default:}}d&&this.fileStorageService.retrieveUserConsumption()},n.manageThumbnailStanzaData=function(a){var r=$(a).attr('action'),n=$(a).find('fileid').text(),o=$(a).find('url').text(),i=$(a).find('mime').text(),s=$(a).find('filename').text(),d=$(a).find('size').text(),c=$(a).find('md5sum').text();if(e.info('[FileDescriptorEventHandler] manageThumbnailStanzaData -- '+r+' fileDescriptor '+n),e.debug('[FileDescriptorEventHandler]   fileUrl='+o),e.debug('[FileDescriptorEventHandler]   fileMime='+i),e.debug('[FileDescriptorEventHandler]   fileName='+s),e.debug('[FileDescriptorEventHandler]   fileSize='+d),e.debug('[FileDescriptorEventHandler]   md5sum='+c),e.debug('[FileDescriptorEventHandler]   fileId='+n),'create'===r||'update'===r){var l=this.fileStorageService.getFileDescriptorById(n);l?(e.debug('[FileDescriptorEventHandler] updating Thumbnail of found FileDescriptor '+n),(!l.previewBlob||l.thumbnail.availableThumbnail)&&l.previewBlob?(t.$broadcast('ON_FILE_DESCRIPTOR_THUMBNAIL_READY',l.id),e.info('[FileDescriptorEventHandler] preview already downloaded for '+n+' -- do nothing')):(t.$broadcast('ON_FILE_DESCRIPTOR_THUMBNAIL_READY',l.id),l.thumbnail.availableThumbnail=!0,l.thumbnail.md5sum=c,l.thumbnail.size=d,e.info('[FileDescriptorEventHandler] preview not already downloaded for '+n+' -- download it'),this.fileServerService.getBlobThumbnailFromFileDescriptor(l).then(function(){t.$broadcast('ON_FILE_DESCRIPTOR_RECEIVED_EVENT',{fileId:l.id})}))):e.error('[FileDescriptorEventHandler] FileDescriptor not found and we do nothing and its not OK')}}}return r.create=function(e){return new r(e)},r}])},function(){angular.module('rainbow').service('extensionSharingService',['$q','$log','$rootScope',function(e,t,a){'use strict';var r=this;this.extensionFound=!1,this.minVersion='1.5.1',this.port=null,this.currentStreamId='screen',this.start=function(){this.extensionId=this.extensionId||this.getExtensionId(config.webservices.server);var n=e.defer();return t.info('[extensionService] === STARTING ==='),config.extensionSharing?window.chrome&&window.chrome.runtime?(t.info('[extensionService] Chrome extension - try to ping...',this.extensionId),chrome.runtime.sendMessage(this.extensionId,{type:'ping',data:null},null,function(e){e&&'pong'===e.type?(t.info('[extensionService] Chrome extension - pong received'),t.info('[extensionService] Chrome extension - extension installed and detected'),t.info('[extensionService] Chrome extension - try to connect...'),r.port=chrome.runtime.connect(r.extensionId),r.port?(t.info('[extensionService] Chrome extension - port created'),r.port.onDisconnect.addListener(function(){t.info('Extension DISCONNECTED'),r.extensionFound=!1,r.port=null}),r.port.onMessage.addListener(function(e){switch(t.info('[extensionService] Chrome extension - connected'),e.type){case'loginResponse':r.extensionFound=!0,t.info('[extensionService] Chrome extension - ready!'),t.info('[extensionService] === STARTED ==='),a.$broadcast('ON_EXTENSION_SHARING_READY'),n.resolve();break;case'getVersionResponse':0===e.code&&e.version?(a.$broadcast('ON_EXTENSION_VERSION_UPDATED',e.version),t.info('[extensionService] Chrome extension - Detected version '+e.version)):(a.$broadcast('ON_EXTENSION_VERSION_UPDATED',null),t.error('[extensionService] Chrome extension - No version received'));break;case'startsharingResponse':0===e.code&&e.streamID?(t.info('[extensionService] Chrome extension - stream ID received '+e.streamID),a.$broadcast('ON_EXTENSION_SHARING_STREAM_FOUND',e.streamID)):(t.info('[extensionService] Chrome extension - No stream ID received'),a.$broadcast('ON_EXTENSION_SHARING_STREAM_FOUND',null));break;case'endsharingResponse':t.info('[extensionService] Chrome extension - end sharing session received');break;default:}}),r.port.postMessage({type:'login',data:null})):(t.info('[extensionService] Chrome extension - can\'t create port to contact the extension!!!'),t.info('[extensionService] === STARTED ==='),n.resolve())):(t.info('[extensionService] Chrome extension - not found'),chrome.runtime.lastError&&t.info('[extensionService] Chrome extension - error '+chrome.runtime.lastError),n.resolve())})):(t.info('[extensionService] Not in chrome'),t.info('[extensionService] === STARTED ==='),n.resolve()):(t.info('[extensionService] === STARTED ==='),n.resolve()),n.promise},this.stop=function(){return t.info('[extensionService] === STOPPING ==='),t.info('[extensionService] === STOPPED ==='),e.when()},this.getExtensionId=function(e){return(t.info('Detected domain : '+e),-1!==e.indexOf('openrainbow.net'))?'koefhabbjedbiecnldkolbijjfjinogj':-1===e.indexOf('openrainbow.org')?-1===e.indexOf('openrainbow.com')?(t.error('Unkown domain, extension may not be available'),'mgneongoclkopahpapenfhbbeckhdmnj'):'mgneongoclkopahpapenfhbbeckhdmnj':'ehamhlkmecdnidihfedapmplddlbidee'},this.setExtensionId=function(e){t.info('set extensionId to : '+e),this.extensionId=e},this.getStreamToShareFromExtension=function(t){var n=e.defer(),o=a.$on('ON_EXTENSION_SHARING_STREAM_FOUND',function(e,a){r.currentStreamId=a,o(),a?(t.video.mandatory.chromeMediaSourceId=a,n.resolve()):n.reject()});return this.port.postMessage({type:'startsharing',data:null}),n.promise},this.getStreamId=function(){return this.currentStreamId},this.isExtensionInstalled=function(){var t=e.defer();return this.extensionFound?t.resolve(!0):this.start().then(function(){t.resolve(r.extensionFound)}),t.promise},this.getExtensionVersion=function(){var t=e.defer(),r=a.$on('ON_EXTENSION_VERSION_UPDATED',function(e,a){r(),a?t.resolve(a):t.reject()});return this.port.postMessage({type:'getVersion',data:null}),t.promise},this.checkExtensionStatus=function(){var t=e.defer();return'chrome'===adapter.default.browserDetails.browser?this.isExtensionInstalled().then(function(e){e?r.checkVersion().then(function(e){e?t.resolve('good'):t.resolve('needUpdate')}):t.resolve('notInstalled')}):t.resolve('notNeeded'),t.promise},this.checkVersion=function(){var t=e.defer();return this.getExtensionVersion().then(function(e){t.resolve(0<=r.cmpVersions(e,r.minVersion))}),t.promise},this.cmpVersions=function(e,t){var a=/(\.0+)+$/,r=e.replace(a,'').split('.'),n=t.replace(a,'').split('.'),o=Math.min(r.length,n.length),s,i;for(s=0;s<o;s++)if(i=parseInt(r[s],10)-parseInt(n[s],10),i)return i;return r.length-n.length}}])},function(){class e{constructor(e,t,a,r,n,o,i,s,d,c,l,p,u,m){this.$q=e,this.$rootScope=t,this.$log=a,this.$http=r,this.authService=n,this.errorHelperService=o,this.ConferenceSession=i,this.profileService=s,this.xmppService=d,this.countryService=c,this.Conference=l,this.contactService=p,this.$translate=u,this.conferenceUserFactory=m,this.MEDIATYPE={PSTNAUDIO:'pstnAudio',WEBRTC:'webrtc',WEBRTCSHARINGONLY:'webrtcSharingOnly'},this.started=!1,this.conferenceProvisionRef=null,this.isPstnConferenceAvailable=!1,this.conferenceSessions={},this.pstnConferenceEndpoints={},this.pstnConferenceUser=null,this.pstnInstantConferenceEndpoint=null,this.pstnConferencePhoneNumbers=null}start(e){return this.$q((t)=>{let a=performance.now();this.$log.info('[PstnConferenceService] === STARTING ==='),this.isPstnConferenceAvailable=!1,this.conferenceSessions={},this.pstnConferenceEndpoints={},this.pstnConferenceUser=null,this.pstnInstantConferenceEndpoint=null,this.pstnConferencePhoneNumbers=null,this.confProvPortalURL=config.restServerUrl+'/api/rainbow/confprovisioning/v1.0/',this.confPortalURL=config.restServerUrl+'/api/rainbow/conference/v1.0/conferences/',this.started=!0;let r=Math.round(performance.now()-a);e.push({service:'pstnConferenceService',startDuration:r}),this.$log.info('[PstnConferenceService] === STARTED ('+r+' ms) ==='),t()})}stop(){return this.$q((e)=>{this.$log.info(''),this.$log.info('[PstnConferenceService] === STOPPING ==='),this.started=!1,this.$log.info('[PstnConferenceService] === STOPPED ==='),e()})}updateConference(e,t){return this.$log.info('[PstnConferenceService] updateConference'),this.$q((a,r)=>{if(e)this.$http({method:'PUT',url:this.confProvPortalURL+'conferences/'+e,headers:this.authService.getRequestHeader(),data:t}).then((e)=>{let t=e.data.data,r=this.Conference.createFromData(t);t.hasOwnProperty('id')&&(this.pstnConferenceEndpoints[t.id]&&delete this.pstnConferenceEndpoints[t.id],this.pstnConferenceEndpoints[t.id]=r,!t.scheduled&&(delete this.pstnInstantConferenceEndpoint,this.pstnInstantConferenceEndpoint=r)),this.$log.info('[PstnConferenceService] updateConference successfully'),a(r)},(e)=>{let t=e.data?e.data.errorDetails:e.data,a='updateConference failure: '+t;this.$log.error('[PstnConferenceService] '+a),r(new Error(a))});else{this.$log.error('[PstnConferenceService] updateConference failure : No confEndpoint'),r(new Error('updateConference failure: No confEndpoint'))}})}retrieveConferenceUser(e){return this.$log.info('[PstnConferenceService] retrieveConferenceUser'),e?this.pstnConferenceUser?this.$q.resolve(this.pstnConferenceUser):this.$q((t,a)=>{this.$http({method:'GET',url:this.confProvPortalURL+'users?userId='+e,headers:this.authService.getRequestHeader()}).then((e)=>{let r=e.data.data;r&&r.length?(this.pstnConferenceUser=this.conferenceUserFactory(r[0]),this.$log.info('[PstnConferenceService] retrieveConferenceUser successfully'),t(this.pstnConferenceUser)):(this.$log.warn('[PstnConferenceService] retrieveConferenceUser no ConferenceUser found'),a())},(e)=>{let t=e.data?e.data.errorDetails:e.data,r='retrieveConferenceUser failure: '+t;this.$log.error('[PstnConferenceService] '+r),a(new Error(r))})}):(this.$log.warn('[PstnConferenceService] retrieveConferenceUser missing userId'),this.$q.reject())}retrievePstnConferences(e,t){return this.$log.info('[PstnConferenceService] retrievePstnConferences with scheduled='+e),this.$q((a,r)=>{if(!this.isPstnConferenceAvailable)return this.$log.warn('[PstnConferenceService] retrieveConference - user is not allowed'),void r(new Error('notAllowed'));let n='?format=full&userId='+this.contactService.userContact.dbId+'&mediaType='+this.MEDIATYPE.PSTNAUDIO;angular.isDefined(e)&&(n+='&scheduled='+e),t&&(n+='&provisioning=true'),this.$http({method:'GET',url:this.confProvPortalURL+'conferences'+n,headers:this.authService.getRequestHeader()}).then((e)=>{let t=e.data.data;for(let a of t)this.updateOrCreatePstnConferenceEndpoint(a);this.$log.info('[PstnConferenceService] retrievePstnConferences successfully'),a(t)},(e)=>{let t=e.data?e.data.errorDetails:e.data,a='retrievePstnConferences failure: '+t;this.$log.error('[PstnConferenceService] '+a),r(new Error(a))})})}updateOrCreateConferenceSession(e,t){if(this.$log.debug('[PstnConferenceService] updateOrCreateConferenceSession for '+e),!e||!t||!t.data)return this.$log.error('[PstnConferenceService] updateOrCreateConferenceSession - Not enough data'),null;let a=this.conferenceSessions[e];return a?t.data.active!==a.active&&(this.$log.debug('active'),a.updateActiveState(t.data.active),this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',a)):(this.$log.debug('[PstnConferenceService] updateOrCreateConferenceSession - create new conferencesession with id '+e+'and data: \n'+JSON.stringify(t.data)),a=this.ConferenceSession.createFromData(e,[],t.data.active,this.MEDIATYPE.PSTNAUDIO),this.conferenceSessions[e]=a,this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',a)),t.data.participants&&(this.$log.debug('[PstnConferenceService] updateOrCreateConferenceSession - update participants for '+e+' with:\n'+JSON.stringify(t.data.participants)),a.updateParticipants(t.data.participants).then(()=>{this.$rootScope.$broadcast('ON_CONFERENCE_PARTICIPANT_EVENT',a)})),a}updateOrCreatePstnConferenceEndpoint(e){if(this.$log.info('[PstnConferenceService] updateOrCreatePstnConferenceEndpoint for '+e.id),!e)return this.$log.error('[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - no conference data !'),null;if(e.mediaType!==this.MEDIATYPE.PSTNAUDIO)return this.$log.error('[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - wrong mediaType:'+e.mediaType),null;let t=this.Conference.createFromData(e);return this.pstnConferenceEndpoints[e.id]=t,t.scheduled||(this.pstnInstantConferenceEndpoint=t,!this.pstnInstantConferenceEndpoint.name&&this.updateConference(this.pstnInstantConferenceEndpoint.id,{name:this.$translate.instant('namePersonalConference',{name:this.contactService.userContact.displayName})})),this.pstnConferenceEndpoints[e.id]}formatPstnPhoneNumbers(e){this.$log.info('[PstnConferenceService] formatPstnPhoneNumbers');let t={};return e.forEach((e)=>{if(e.locationcode){let a=this.countryService.getAlpha2Code(e.locationcode.substr(0,3));a&&!t[a]&&(t[a]={numbersList:[]}),t[a].numbersList.push({number:e.number,locationName:e.location,city:e.location.split(', ')[1],numberType:e.numberType,needLanguageSelection:e.needLanguageSelection})}}),t}retrievePstnPhoneNumbers(e){return this.$log.info('[ConferenceService] retrievePstnPhoneNumbers'),this.pstnConferencePhoneNumbers?e?this.$q.resolve(this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers)):this.$q.resolve(this.pstnConferencePhoneNumbers):this.$q((t,a)=>{this.$http({method:'GET',url:this.confProvPortalURL+'conferences/audio/phonenumbers?shortList=false',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[PstnConferenceService] retrievePstnPhoneNumbers successfully'),this.pstnConferencePhoneNumbers=a.data.data.phoneNumberList,e?t(this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers)):t(this.pstnConferencePhoneNumbers)},(e)=>{let t=e.data?e.data.errorDetails:e.data,r='retrievePstnPhoneNumbers failure: '+t;this.$log.error('[PstnConferenceService] '+r),a(new Error(r))})})}retrievePstnInstantConference(){return this.isPstnConferenceAvailable?this.retrievePstnConferences(!1).then((e)=>(e.forEach((t)=>{if(t.hasOwnProperty('id')){let a=this.Conference.createFromData(t);a.mediaType!==this.MEDIATYPE.PSTNAUDIO||a.userId!==this.contactService.userContact.dbId||a.scheduled||(this.pstnConferenceEndpoints[e.id]=a,this.pstnInstantConferenceEndpoint=a,!this.pstnInstantConferenceEndpoint.name&&this.updateConference(this.pstnInstantConferenceEndpoint.id,{name:this.$translate.instant('namePersonalConference',{name:this.contactService.userContact.displayName})}))}}),!this.pstnInstantConferenceEndpoint&&this.isPstnConferenceAvailable&&(this.$log.info('[PstnConferenceService] User has no instant conference : we create a new one'),this.retrieveConferenceUser(this.contactService.userContact.dbId).then((e)=>{this.createInstantConference(e.id,'instantConference').then((e)=>{this.pstnInstantConferenceEndpoint=e})})),this.$q.resolve()),()=>(this.$log.warn('[PstnConferenceService] retrievePstnInstantConference - issue retrieving instant conference'),this.$q.resolve())):(this.$log.info('[PstnConferenceService] retrievePstnInstantConference -- No conference rights'),this.$q.resolve())}createInstantConference(e,t=''){return this.$q((a,r)=>{this.$log.info('[PstnConferenceService] createInstantConference'),this.$http({method:'POST',url:this.confProvPortalURL+'conferences',headers:this.authService.getRequestHeader(),data:{confUserId:e,name:t}}).then((e)=>{let t=e.data.data,r=this.Conference.createFromData(t);t.hasOwnProperty('id')&&(this.pstnConferenceEndpoints[t.id]=r),this.$log.info('[PstnConferenceService] createInstantConference successfully'),a(r)},(e)=>{let t=e.data?e.data.errorDetails:e.data,a='createInstantConference failure: '+t;this.$log.error('[PstnConferenceService] '+a),r(new Error(a))})})}getConferenceSessionById(e){return this.conferenceSessions[e]}getConferenceSessionForRoom(e){let t=null;if(e&&e.length)for(let a=0;a<e.length;a++)e[a].mediaType===this.MEDIATYPE.PSTNAUDIO&&(t=this.conferenceSessions[e[a].confEndpointId]);return t}removeConferenceSession(e){e&&delete this.conferenceSessions[e]}initiatesCallParticipant(e,t,a,r){return this.$log.info('[PstnConferenceService] initiatesCallParticipant( confId='+e+', PhoneNumber='+t+', role='+a.role+' country = '+r+' )'),e&&t?this.$q((n,o)=>{this.$http({method:'POST',url:this.confPortalURL+e+'/join',headers:this.authService.getPostHeader(),data:{participantPhoneNumber:t,participant:a,country:r}}).then((t)=>{let a=t.data.status;this.$log.info('[PstnConferenceService] initiatesCallParticipant( confId='+e+') success : '+a),n()},(t)=>{let a=t.data?t.data.errorDetails:t.data,r='initiatesCallParticipant( confId='+e+') failure: '+a;this.$log.error('[PstnConferenceService] '+r),o(new Error(r))})}):(this.$log.error('[PstnConferenceService] initiatesCallParticipant - missing parameter'),this.$q.reject())}initiatesAudio(e){return this.$log.info('[PstnConferenceService] initiatesAudio( confId='+e+')'),e?this.conferenceSessions[e]&&this.conferenceSessions[e].isActive()?(this.$log.info('[PstnConferenceService] initiatesAudio : conference already started'),this.$q.resolve()):this.$q((t,a)=>{this.$http({method:'PUT',url:this.confPortalURL+e+'/start',headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info('[PstnConferenceService] initiatesAudio( confId='+e+') successfully'),t()},(e)=>{let t=this.errorHelperService.handleError(e);a(t)})}):(this.$log.error('[PstnConferenceService] initiatesAudio - missing parameter'),this.$q.reject())}initiatesAudioRecording(e,t,a,r){return this.$log.info('[PstnConferenceService] initiatesAudioRecording( confId='+e+'participantId='+t+'fileName='+a+'fileExtension='+r+')'),e&&t?this.$q((n,o)=>{this.$http({method:'POST',url:this.confPortalURL+e+'/participants/'+t+'/start-recording',headers:this.authService.getPostHeader(),data:{fileName:a,fileExtension:r}}).then(()=>{this.$log.info('[PstnConferenceService] initiatesAudioRecording( confId='+e+'participantId='+t+') successfully'),n()},(a)=>{let r=a.data?a.data.errorDetails:a.data,n='initiatesAudioRecording( confId='+e+'participantId='+t+') failure: '+r;this.$log.error('[PstnConferenceService] '+n),o(new Error(n))})}):(this.$log.error('[PstnConferenceService] initiatesAudioRecording - missing parameter'),this.$q.reject())}stopsAudioRecording(e,t){return this.$q((a,r)=>(this.$log.info('[PstnConferenceService] stopsAudioRecording( confId='+e+'participantId='+t+')'),e&&t?void this.$http({method:'POST',url:this.confPortalURL+e+'/participants/'+t+'/stop-recording',headers:this.authService.getPostHeader()}).then(()=>{this.$log.info('[PstnConferenceService] stopsAudioRecording( confId='+e+'participantId='+t+') successfully'),a()},(a)=>{let n=a.data?a.data.errorDetails:a.data,o='stopsAudioRecording( confId='+e+'participantId='+t+') failure: '+n;this.$log.error('[PstnConferenceService] '+o),r(new Error(o))}):(this.$log.error('[PstnConferenceService] initiatesAudioRecording - missing parameter'),this.$q.reject())))}pausesAudioRecording(e,t){return this.$q((a,r)=>(this.$log.info('[PstnConferenceService] pausesAudioRecording( confId='+e+'participantId='+t+')'),e&&t?void this.$http({method:'POST',url:this.confPortalURL+e+'/participants/'+t+'/pause-recording',headers:this.authService.getPostHeader()}).then(()=>{this.$log.info('[PstnConferenceService] pausesAudioRecording( confId='+e+'participantId='+t+') successfully'),a()},(a)=>{let n=a.data?a.data.errorDetails:a.data,o='pausesAudioRecording( confId='+e+'participantId='+t+') failure: '+n;this.$log.error('[PstnConferenceService] '+o),r(new Error(o))}):(this.$log.error('[PstnConferenceService] pausesAudioRecording - missing parameter'),this.$q.reject())))}resumesAudioRecording(e,t){return this.$q((a,r)=>(this.$log.info('[PstnConferenceService] resumesAudioRecording( confId='+e+'participantId='+t+')'),e&&t?void this.$http({method:'POST',url:this.confPortalURL+e+'/participants/'+t+'/resume-recording',headers:this.authService.getPostHeader()}).then(()=>{this.$log.info('[PstnConferenceService] resumesAudioRecording( confId='+e+'participantId='+t+') successfully'),a()},(a)=>{let n=a.data?a.data.errorDetails:a.data,o='resumesAudioRecording( confId='+e+'participantId='+t+') failure: '+n;this.$log.error('[PstnConferenceService] '+o),r(new Error(o))}):(this.$log.error('[PstnConferenceService] resumesAudioRecording - missing parameter'),this.$q.reject())))}makeSnapshotForConfId(e=null){if(!e){let e='[PstnConferenceService] makeSnapshotForConfId - No confId !!';return this.$log.error(e),this.$q.reject(e)}return this.$q((t,a)=>{this.$http({method:'GET',url:this.confPortalURL+e+'/snapshot?mediaType=pstnAudio',headers:this.authService.getRequestHeader()}).then((a)=>{this.$log.info('[PstnConferenceService] makeSnapshotForConfId success for confId '+e);let r=a.data;this.updateOrCreateConferenceSession(e,r),t(r.data)}).catch((t)=>{this.$log.info('[PstnConferenceService] makeSnapshotForConfId failure for confID '+e),404===t.status?this.$log.error('[PstnConferenceService] makeSnapshotForConfId - confId '+e+' not found on server'):this.$log.error('[PstnConferenceService] makeSnapshotForConfId - inconsistent object on server'),this.conferenceSessions[e]&&this.removeConferenceSession(e),a()})})}refreshConferenceSessions(){return this.$log.info('[PstnConferenceService] refreshConferenceSessions'),this.$q((e,t)=>{let a=[];for(let r in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(r)){let e=this.conferenceSessions[r];a.push(this.makeSnapshotForConfId(e.id))}this.$q.all(a).then(()=>{this.$log.info('[PstnConferenceService] refreshConferenceSessions -- success'),e()}).catch(()=>{this.$log.error('[PstnConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions'),this.removeAllConferenceSessions(),t()})})}getConferenceSessionWithConnId(e){for(let t in this.$log.info('[PstnConferenceService] getConferenceSessionWithConnId with connId : '+e),this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(t)){let a=this.conferenceSessions[t];if(a&&a.callId===e)return a}return null}removeAllConferenceSessions(){for(let e in this.$log.info('[PstnConferenceService] removeAllConferenceSessions'),this.conferenceSessions)this.conferenceSessions.hasOwnProperty(e)&&this.removeConferenceSession(e)}}e.$inject=['$q','$rootScope','$log','$http','authService','errorHelperService','ConferenceSession','profileService','xmppService','countryService','Conference','contactService','$translate','conferenceUserFactory'],angular.module('rainbow').service('pstnConferenceService',e)},function(){class e{constructor(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g,v){this.$q=e,this.$rootScope=t,this.$log=a,this.$http=r,this.uuid4=n,this.$interval=o,this.authService=i,this.xmppService=s,this.videoService=d,this.roomService=c,this.errorHelperService=l,this.ConferenceSession=p,this.contactService=u,this.platformService=m,this.Conference=g,this.profileService=v,this.MEDIATYPE={WEBRTC:'webrtc',WEBRTCSHARINGONLY:'webrtcSharingOnly'},this.started=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.connected=!1,this.disconnecting=!1,this.reconnecting=!1,this.audioProfileChanging=!1,this.conferenceEndpoints={},this.attachLocalMediaStream=(e,t)=>{if(e){if(t.hasLocalVideo){let e=t.sessions[t.localVideoSessionId];if(e){let a=t.localStreams[e.localStreamId];this.videoService.RTC.attachMediaStreamIfNeeded(angular.element('#conferenceVideoPip'),a,e.sid),this.videoService.RTC.attachMediaStreamIfNeeded(angular.element('#conferenceVideoPipSmall'),a,e.sid)}}if(t.hasLocalSharing){let e=t.sessions[t.localSharingSessionId];if(e){let a=t.localStreams[e.localStreamId];this.videoService.RTC.attachMediaStreamIfNeeded(angular.element('#conferenceSharingPip'),a,e.sid)}}}else this.videoService.RTC.clearMediaStream(angular.element('#minivideo'),null)}}start(e){return this.$q((t)=>{let a=performance.now();this.$log.info('[WebConferenceService] === STARTING ==='),this.confProvPortalURL=config.restServerUrl+'/api/rainbow/confprovisioning/v1.0/',this.confPortalURL=config.restServerUrl+'/api/rainbow/conference/v1.0/conferences/',this.conferenceEndpoints={},this.conferenceSessions={},this.listeners=[],this.statsIntervals=[],this.connected=!0,this.disconnecting=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.videoGalleryElements=[],this.attachHandlers(),this.videoGalleryElementsNumber=4,this.started=!0;let r=Math.round(performance.now()-a);e.push({service:'WebConferenceService',startDuration:r}),this.$log.info('[WebConferenceService] === STARTED ('+r+' ms) ==='),t()})}stop(){return this.$log.info('[WebConferenceService] === STOPPING ==='),this.started=!1,this.makingCall=!1,this.listeners&&this.listeners.forEach((e)=>{e()}),this.$log.info('[WebConferenceService] === STOPPED ==='),this.$q.when()}attachHandlers(){this.listeners.push(this.$rootScope.$on('ON_INPUT_DEVICE_CHANGED_EVENT',()=>{this.onAudioProfileChangeEvent()})),this.listeners.push(this.$rootScope.$on('ON_CONNECTION_STATE_CHANGE_EVENT',(e,t)=>{this.$log.info('[WebConferenceService] onConnectionStateChangeEvent : '+t);try{if('disconnected'===t)this.$log.info('[WebConferenceService] onConnectionStateChangeEvent : disconnected'),this.connected=!1;else if('connected'===t)for(let e in this.$log.info('[WebConferenceService] onConnectionStateChangeEvent : connected'),this.connected=!0,this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)){let t=this.conferenceSessions[e];if('reconnecting'===t.status)for(let e in t.sessions)if(t.sessions.hasOwnProperty(e)){let a=t.sessions[e];'audio'===a.localType&&this.sendTransportReplaceForSession(a,1e4)}}}catch(e){this.$log.info('[WebConferenceService] onConnectionStateChangeEvent error : '+e)}}))}retrieveWebConferences(e=this.MEDIATYPE.WEBRTC){return this.$log.info('[WebConferenceService] retrieveWebConferences with mediaType='+e),this.$q((t,a)=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)&&e!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.warn('[WebConferenceService] retrieveWebConferences - user is not allowed'),void a(new Error('notAllowed'));let r='?format=full&userId='+this.contactService.userContact.dbId;angular.isDefined(e)&&(r+='&mediaType='+e),this.$http({method:'GET',url:this.confProvPortalURL+'conferences'+r,headers:this.authService.getRequestHeader()}).then((e)=>{let a=e.data.data;this.$log.info('[WebConferenceService] retrieveWebConferences successfully'),t(a)},(e)=>{let t=e.data?e.data.errorDetails:e.data,r='retrieveWebConferences failure: '+t;this.$log.error('[WebConferenceService] '+r),a(new Error(r))})})}updateConference(e,t){return this.$log.info('[WebConferenceService] updateConference'),this.$q((a,r)=>{if(e)this.$http({method:'PUT',url:this.confProvPortalURL+'conferences/'+e,headers:this.authService.getRequestHeader(),data:t}).then((e)=>{let t=e.data.data,r=this.Conference.createFromData(t);t.hasOwnProperty('id')&&(this.conferenceEndpoints[t.id]&&delete this.conferenceEndpoints[t.id],this.conferenceEndpoints[t.id]=r),this.$log.info('[WebConferenceService] updateConference successfully'),a(r)},(e)=>{let t=e.data?e.data.errorDetails:e.data,a='updateConference failure: '+t;this.$log.error('[WebConferenceService] '+a),r(new Error(a))});else{this.$log.error('[WebConferenceService] updateConference failure : No confEndpoint'),r(new Error('updateConference failure: No confEndpoint'))}})}createVideoGalleryElements(){this.videoGalleryElements=[];for(let e=1,t;e<=this.videoGalleryElementsNumber;e++)t={state:'free',sessionId:'',id:'videoGallery_'+e,publisherId:'',publisherJid:''},this.videoGalleryElements.push(t)}setVideoGalleryElementsNumber(e){this.videoGalleryElementsNumber=e}getConferenceSessions(){return this.conferenceSessions}getConferenceEndpoints(){return this.conferenceEndpoints}addConferenceEndpoint(e,t){return e?void(this.conferenceEndpoints[e]=t):void this.$log.warn('[WebConferenceService] addConferenceEndpoint - missing conferenceEndpointId')}getConferenceIdToUse(e,t=this.MEDIATYPE.WEBRTC){let a=this.getPontConfIdForRoom(e,t);if(a)return a;switch(t){case this.MEDIATYPE.WEBRTC:if(e.isUserModerator(this.contactService.userContact)&&this.webrtcConferenceId)return this.webrtcConferenceId;break;case this.MEDIATYPE.WEBRTCSHARINGONLY:if(e.owner&&this.webrtcSharingOnlyConferenceId)return this.webrtcSharingOnlyConferenceId;break;default:}return''}isMyConference(e){return e&&(this.webrtcConferenceId&&e===this.webrtcConferenceId||this.webrtcSharingOnlyConferenceId&&e===this.webrtcSharingOnlyConferenceId)}startOrJoinWebConference(e){return this.$q((t,a)=>{if(!e){let e=new Error('[webConferenceService] startOrJoinWebConference error - missing parameters for room');return this.$log.error(e.message),void a(e)}let r=this.getConferenceIdToUse(e,this.MEDIATYPE.WEBRTC);if(!r){let e=new Error('[webConferenceService] startOrJoinWebConference error - no available pont conference');return this.$log.error(e.message),void a(e)}this.makeSnapshotForConfId(r,this.MEDIATYPE.WEBRTC).then(()=>{let n=this.conferenceSessions[r];if(!this.isMyConference(r)&&(!n||!n.active)){let e=new Error('[webConferenceService] startOrJoinWebConference error - no active conference to join');return this.$log.error(e.message),void a(e)}let o=this.isMyConference(r)?'moderator':'member';return n&&n.active?(this.$rootScope.$broadcast('ON_CONFERENCE_ENDED_INVITATION',e),void t(this.joinWebConference(r,o))):void t(this.startWebConference(e,r))},()=>{let e=new Error('[webConferenceService] startOrJoinWebConference error on snapshot');this.$log.error(e.message),a(e)})})}startOrJoinSharingOnlyConference(e){return this.$q((t,a)=>{if(!e){let e=new Error('[webConferenceService] startOrJoinSharingOnlyConference error - missing parameters for room');return this.$log.error(e.message),void a(e)}let r=this.getConferenceIdToUse(e,this.MEDIATYPE.WEBRTCSHARINGONLY);if(!r){let e=new Error('[webConferenceService] startOrJoinSharingOnlyConference error - no available pont conference');return this.$log.error(e.message),void a(e)}this.makeSnapshotForConfId(r,this.MEDIATYPE.WEBRTCSHARINGONLY).then(()=>{let n=this.conferenceSessions[r];if(!this.isMyConference(r)&&(!n||!n.active)){let e=new Error('[webConferenceService] startOrJoinSharingOnlyConference error - no active conference to join');return this.$log.error(e.message),void a(e)}let o=this.isMyConference(r)?'moderator':'member';return n&&n.active?(this.$rootScope.$broadcast('ON_CONFERENCE_ENDED_INVITATION',e),void t(this.joinSharingOnlyConference(r,o,!1))):void t(this.startSharingOnlyConference(e,r))},()=>{let e=new Error('[webConferenceService] startOrJoinSharingOnlyConference error on snapshot');this.$log.error(e.message),a(e)})})}startWebConference(e,t,a=!1){return this.makingCall?(this.$log.warn('[webConferenceService] already starting a conference'),this.$q.resolve()):t&&e?(this.makingCall=!0,this.$log.info('[webConferenceService] startWebConference wtih ID '+t),this.$q((e)=>{a?(this.$log.debug('[webConferenceService] startWebConference - trigger snapshot for '+t),e(this.makeSnapshotForConfId(t,this.MEDIATYPE.WEBRTC))):e()}).then(()=>this.conferenceSessions[t].active?(this.$log.info('[webConferenceService] startWebConference - No need to start an already active conference'),this.joinWebConference(t,'moderator',!1)):(this.conferenceSessions[t].status='ringing',this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',this.conferenceSessions[t]),this.$http({method:'PUT',url:this.confPortalURL+t+'/start',headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:e.dbId}}).then(()=>(this.$log.info('[webConferenceService] startWebConference - success -- now joining the conference'),this.joinWebConference(t,'moderator',!1)),(e)=>{throw this.makingCall=!1,this.$log.error('[webConferenceService] startWebConference wtih ID '+t+' failure ... -- '+this.errorHelperService.getErrorFullMessage(e)),this.leaveWebConference(t),this.removeConferenceSession(t),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT'),this.errorHelperService.handleError(e)}))).catch((e)=>(this.makingCall=!1,this.$log.error('[webConferenceService] startWebConference - error on server, can\'t start conference'),this.$rootScope.$broadcast('ON_OPEN_GLOBAL_POPUP',{popupTitle:'startConference',popupBody:'startMeetingFailure',okLabel:'ok'}),this.$q.reject(e)))):(this.$log.error('[startWebConference] No webPontConferenceId or Room!'),this.$rootScope.$broadcast('ON_OPEN_GLOBAL_POPUP',{popupTitle:'startConference',popupBody:'startMeetingFailure',okLabel:'ok'}),this.$q.reject())}startSharingOnlyConference(e,t,a=!0){return this.makingCall?(this.$log.warn('[webConferenceService] already starting a conference'),this.$q.resolve()):t&&e?(this.makingCall=!0,this.$log.info('[webConferenceService] startSharingOnlyConference wtih ID '+t),this.makeSnapshotForConfId(t,this.MEDIATYPE.WEBRTCSHARINGONLY).then(()=>{if(this.conferenceSessions[t].active)return this.$log.info('[webConferenceService] startSharingOnlyConference - No need to start an already active conference'),a?this.$q.resolve(this.joinSharingOnlyConference(t,'moderator',!1)):this.$q.resolve();this.conferenceSessions[t].status='ringing',this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',this.conferenceSessions[t]);let r=this.confPortalURL+t+'/start';return this.$q((n,o)=>{this.$http({method:'PUT',url:r,headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTCSHARINGONLY,roomId:e.dbId}}).then(()=>a?this.joinSharingOnlyConference(t,'moderator',!1).then(()=>{n()}):void n(),(e)=>{this.makingCall=!1,this.$log.error('[webConferenceService] startSharingOnlyConference wtih ID '+t+' failure ... -- '+this.errorHelperService.getErrorFullMessage(e)),this.leaveWebConference(t),this.removeConferenceSession(t),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT'),o(this.errorHelperService.handleError(e))})})}).catch((e)=>(this.makingCall=!1,this.$log.error('[webConferenceService] startSharingOnlyConference - error on server, can\'t start conference'),this.$q.reject(e)))):(this.$log.error('[startSharingOnlyConference] No webPontConferenceId or Room!'),this.$q.reject())}joinWebConference(e,t,a=!1){return this.$log.info('[webConferenceService] joinWebConference with ID '+e+' and role '+t),e?this.$q((t)=>{a?(this.$log.debug('[webConferenceService] joinWebConference - trigger snapshot for '+e),t(this.makeSnapshotForConfId(e,this.MEDIATYPE.WEBRTC))):t()}).then(()=>this.$q((a,r)=>{this.makingCall=!0,this.createVideoGalleryElements(),this.conferenceSessions[e].videoGallery=this.videoGalleryElements,'ringing'!==this.conferenceSessions[e].status&&(this.conferenceSessions[e].status='ringing',this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',this.conferenceSessions[e]));let n='web_'+this.uuid4.generate(),o=this.confPortalURL+e+'/join',i={participant:{role:t,type:'unmuted'},mediaType:this.MEDIATYPE.WEBRTC};this.getUserMediaForSession(e).then(()=>{this.$http({method:'POST',url:o,headers:this.authService.getRequestHeader(),data:i}).then((t)=>{let r=t.data.data;this.jingleJid=r.jingleJid,this.initCall(this.jingleJid,e,n,this.MEDIATYPE.WEBRTC),this.conferenceSessions[e].haveJoined=!0,this.makingCall=!1,a()},(t)=>{if(t){let a=t.data?t.data.errorDetails:t.data;this.$log.error('[conferenceService] '+('joinWebConference( confId='+e+') failure: '+a))}this.makingCall=!1;let a={popupTitle:'warning',popupBody:'joinMeetingFailure',okLabel:'ok'};t&&t.data&&403615===t.data.errorDetailsCode&&(a.popupBody='maximumNumberConferenceParticipantsReach'),this.leaveWebConference(e),delete this.conferenceSessions[e],this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT'),this.$rootScope.$broadcast('ON_OPEN_GLOBAL_POPUP',a),r(this.errorHelperService.handleError(t))})}).catch((t)=>{this.$log.error('[webConferenceService] joinWebConference - getUserMediaForSession reject -- '+t),this.makingCall=!1,'ignore'!==t&&this.leaveWebConference(e),r()})})).catch(()=>(this.makingCall=!1,this.$log.error('[webConferenceService] joinWebConference - error on server, can\'t join conference'),this.$q.reject())):(this.$log.error('[webConferenceService] joinWebConference - No webPontConferenceId !'),this.$q.reject())}joinSharingOnlyConference(e,t,a=!0){return this.$log.info('[webConferenceService] joinSharingOnlyConference with ID '+e+' and role '+t),e?this.$q((t)=>{a?(this.$log.debug('[webConferenceService] joinSharingOnlyConference - trigger snapshot for '+e),t(this.makeSnapshotForConfId(e,this.MEDIATYPE.WEBRTCSHARINGONLY))):t()}).then(()=>this.$q((a,r)=>{this.makingCall=!0,this.createVideoGalleryElements(),this.conferenceSessions[e].videoGallery=this.videoGalleryElements,'ringing'!==this.conferenceSessions[e].status&&(this.conferenceSessions[e].status='ringing',this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',this.conferenceSessions[e]));let n='web_'+this.uuid4.generate(),o=this.confPortalURL+e+'/join',i={participant:{role:t,type:'muted'},mediaType:this.MEDIATYPE.WEBRTCSHARINGONLY};this.$http({method:'POST',url:o,headers:this.authService.getRequestHeader(),data:i}).then((t)=>{let r=t.data.data;this.jingleJid=r.jingleJid,this.$log.info('[webConferenceService] joinSharingOnlyConference with ID success - jingleJid: '+this.jingleJid),this.conferenceSessions[e].jingleJid=this.jingleJid,this.conferenceSessions[e].haveJoined=!0,this.makingCall=!1,a()},(t)=>{if(t){let a=t.data?t.data.errorDetails:t.data;this.$log.error('[conferenceService] '+('joinSharingOnlyConference( confId='+e+') failure: '+a))}this.makingCall=!1;t&&t.data&&403615===t.data.errorDetailsCode&&({popupTitle:'warning',popupBody:'joinMeetingFailure',okLabel:'ok'}.popupBody='maximumNumberConferenceParticipantsReach'),this.leaveWebConference(e),delete this.conferenceSessions[e],this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT'),r(this.errorHelperService.handleError(t))})})).catch(()=>(this.makingCall=!1,this.$log.error('[webConferenceService] joinSharingOnlyConference - error on server, can\'t join conference'),this.$q.reject())):(this.$log.error('[webConferenceService] joinSharingOnlyConference - No webPontConferenceId !'),this.$q.reject())}stopWebConference(e){return this.$q((t,a)=>{if(!e)a();else{let r=e.getSFUConfEndpointId()?e.getSFUConfEndpointId():e.getSFUSharingConfEndpointId(),n=this.confPortalURL+r+'/stop';this.$http({method:'PUT',url:n,headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:e.dbId}}).then(()=>{t()},(e)=>{a(this.errorHelperService.handleError(e))})}})}getFreeVideoGalleryElement(e){this.$log.info('[webConferenceService] getFreeVideoGalleryElement '+e);let t=this.conferenceSessions[e],a=null;if(t){t.videoGallery||(this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements);for(let e=0;e<t.videoGallery.length;e++)if('free'===t.videoGallery[e].state){a=t.videoGallery[e];break}}return a}askToAddSharingToConferenceSession(e,t){let a=!this.videoService.askToAddSharing(e.id,'sharing');a&&this.addMediaToConferenceSession(t,'sharing')}addMediaToConferenceSession(e,t){if(!e)return;let a=20;'video'!==t&&(a=3),'sharing'===t&&this.contactService.setBusyState('dnd','sharing'),this.$log.info('[webConferenceService] addMediaToConferenceSession to session '+e.id+' with media '+t),this.videoService.getBrowserMedia([t],640,480,a).then((a)=>{let r=this.xmppService.connection.jingle.initiate(e.jingleJid,this.xmppService.connection.jid,t,[a],null,e.id);e.sessions[r.sid]=r,e.localStreams.push(a),r.localStreamId=e.localStreams.length-1,'video'===t?(e.hasLocalVideo=!0,e.localVideoSessionId=r.sid):(e.hasLocalSharing=!0,e.localSharingSessionId=r.sid),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',e),this.videoService.callsStats[r.sid]={},this.updateStatisticsForSession(e.id,r.sid),this.statsIntervals.push(r.getStats(5e3))})}removeMediaFromConferenceSession(e,t){if(e){'sharing'===t&&this.contactService.setBusyState('dnd','audio'),'webrtcSharingOnly'===e.type&&this.contactService.resetBusyState(),this.$log.info('[webConferenceService] removeMediaFromConferenceSession from session '+e.id);let a='video'===t?e.localVideoSessionId:e.localSharingSessionId;if(e.sessions[a]){let r=e.sessions[a];this.updateStatisticsForSession(e.id,a),this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid),delete e.sessions[a],delete e.localStreams[r.localStreamId],delete this.videoService.callsStats[a],'video'===t?(e.hasLocalVideo=!1,e.localVideoSessionId=null):(e.hasLocalSharing=!1,e.localSharingSessionId=null)}this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',e)}}dropRemoteVideoSession(e,t){if(e){if(this.$log.info('[webConferenceService] dropRemoteVideoSession fom conference '+e.id+' and session '+t),e.sessions[t]){let a=e.sessions[t];this.updateStatisticsForSession(e.id,t),this.xmppService.connection.jingle.terminate(a.sid),delete e.sessions[t],delete this.videoService.callsStats[t]}this.removeSessionFromVideoGallery(e,t),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',e)}}getUserMediaForSession(e){return this.$q((t,a)=>{let r=this.conferenceSessions[e];if(!r)return void a();r.status='ringing',r.haveJoined=!0,this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',r);this.videoService.getBrowserMedia(['audio']).then((r)=>{this.$log.info('[webConferenceService] getUserMediaForSession -- sucess');let n=this.conferenceSessions[e];if(!n||'ended'===n.status)return this.$log.info('[webConferenceService] getUserMediaForSession -- missing conference'),this.disableMediaStream(r),void a('conference does not exist anymore');if(!this.makingCall)return this.$log.info('[webConferenceService] getUserMediaForSession -- already in the conference -- ignore'),this.disableMediaStream(r),void a('ignore');n.localStreams=[r],t()}).catch(()=>{this.$log.error('[webConferenceService] getUserMediaForSession error -- getUserMedia failed');this.$rootScope.$broadcast('ON_OPEN_GLOBAL_POPUP',{popupTitle:'warning',popupBody:'devicePermission',okLabel:'ok'}),a('failed to get user media')})})}disableMediaStream(e){e&&(e.getTracks().forEach((e)=>{e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)}initCall(e,t,a,r){let n=this.conferenceSessions[t];return this.$q((e)=>{n||(this.$log.warn('[webConferenceService] initCall - no conferenceSession as though we are trying to init call'),e(this.makeSnapshotForConfId(t,r))),e()}).then(()=>{let r=this.xmppService.connection.jingle.initiate(e,this.xmppService.connection.jid,'audio',n.localStreams,a,t);n.jingleJid=e,n.sessions[r.sid]=r,n.status='ringing',this.createStatisticsForSession(t,r.sid),this.statsIntervals.push(r.getStats(5e3)),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',n)})}muteAudio(e,t){if(!e.webConferenceSession)return void this.$log.info('[webConferenceService] muteAudio trying to mute a non existing session ');for(let a in e.webConferenceSession.sessions)if(e.webConferenceSession.sessions.hasOwnProperty(a)){let r=e.webConferenceSession.sessions[a];r.muteAudio(t)}e.isMutedAudio=t,this.$rootScope.$broadcast('ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT',{conversation:e})}createStatisticsForSession(e,t){if(this.$log.info('[webConferenceService] createStatisticsForSession for conf '+e+' and session '+t),!e||!t)return void this.$log.warn('[webConferenceService] createStatisticsForSession -- missing parameters');this.videoService.callsStats[t]={};let a=[];a.push({connectionId:t,stats:this.videoService.callsStats[t]}),this.videoService.createStatisticsForSession(e,e,'pending',a).then((a)=>{this.$log.info('[webConferenceService] createStatisticsForSession success '+a),this.videoService.callsStats[t].id=a,this.conferenceSessions[e].metricsId=a,this.conferenceSessions[e].metricsState='pending'}).catch(()=>{this.$log.error('[webConferenceService] createStatisticsForSession error for conf '+e)})}updateStatisticsForSession(e,t){if(this.$log.info('[webConferenceService] updateStatisticsForSession for conf '+e+' and session '+t),!e||!t)return void this.$log.warn('[webConferenceService] updateStatisticsForSession -- missing parameters');let a=this.conferenceSessions[e];if(!a||!a.metricsId)return void this.$log.warn('[webConferenceService] updateStatisticsForSession -- missing webConference or no metricsId');a.metricsState||(a.metricsState='pending');let r=[];if(this.videoService.callsStats[t])return r.push({connectionId:t,stats:this.videoService.callsStats[t]}),void this.videoService.updateStatisticsForCall(a.metricsId,e,e,a.metricsState,r)}leaveWebConference(e){if(this.$log.info(`[WebConferenceService] leaveWebConference - ${e}`),this.contactService.resetBusyState(),!!e){let t=this.conferenceSessions[e];if(!t)return void this.$log.warn('[WebConferenceService] leaveWebConference - webConference does not exist');for(let e in t.metricsState='ended',t.sessions)if(t.sessions.hasOwnProperty(e)){let a=t.sessions[e];this.updateStatisticsForSession(t.id,a.sid),this.videoService.disableAudioVideoMedia(a),this.xmppService.connection.jingle.terminate(a.sid),delete this.videoService.callsStats[a.sid]}t.cleanupSessionData(),this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements,t.sessions={};for(let e;this.statsIntervals.length;)e=this.statsIntervals.pop(),e&&(window.clearInterval(e),e=null);this.makingCall=!1,this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',t)}}attachDistantMediaStream(e,t){if(e){let e=this.getRemoteVideoSessions(t.id);this.updateMainSessionIfNeeded(e),this.$log.info('[WebConferenceService] attachDistantMediaStream for session '+t.id);let a=this.getRemoteSharingSession(t.id);if(a&&a.remoteStreams.forEach((e)=>{0<e.getVideoTracks().length&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element('#largevideo'),e,a.sid)}),e.length)for(let r in e)e.hasOwnProperty(r)&&e[r].remoteStreams&&e[r].remoteStreams.forEach((n)=>{if(0<n.getVideoTracks().length){!a&&e[r].mainSession&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element('#largevideo'),n,e[r].sid);for(let a=0;a<t.videoGallery.length;a++)if(t.videoGallery[a].sessionId===e[r].sid){this.videoService.RTC.attachMediaStreamIfNeeded(angular.element('#'+t.videoGallery[a].id),n,t.videoGallery[a].sessionId);break}}});let r=this.getRemoteAudioSession(t.id);r&&r.remoteStreams&&r.remoteStreams.forEach((e)=>{0<e.getAudioTracks().length&&this.videoService.RTC.attachMediaStream(angular.element('#globalAudioTag'),e)})}}attachMainMediaStream(e){e&&(this.$log.info('[webConferenceService] attachMainMediaStream'),e.remoteStreams.forEach((t)=>{0<t.getVideoTracks().length&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element('#largevideo'),t,e.sid)}))}updateMainSessionIfNeeded(e){if(this.$log.info('[webConferenceService] updateMainSessionIfNeeded'),e&&e.length){let t=null,a=!0;for(let r in e)e.hasOwnProperty(r)&&(t||(t=e[r]),e[r].mainSession&&(a=!1));a&&(t.mainSession=!0)}}getRelatedRoomToActiveConferenceSession(){return this.webConferenceRoom}getRelatedRoomToActiveSharingOnlyConferenceSession(){return this.webrtcSharingOnlyRoom}getConferenceBySessionId(e){let t=null;for(let a in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(a)&&this.conferenceSessions[a].sessions)for(let r in this.conferenceSessions[a].sessions)if(this.conferenceSessions[a].sessions.hasOwnProperty(r)&&this.conferenceSessions[a].sessions[r].sid===e)return t=this.conferenceSessions[a],t;return t}getPontConfIdForRoom(e,t=this.MEDIATYPE.WEBRTC){if(e.confEndpoints&&e.confEndpoints.length)for(let a=0;a<e.confEndpoints.length;a++)if(e.confEndpoints[a].mediaType===t)return e.confEndpoints[a].confEndpointId;return''}getConferenceSessionById(e){return this.conferenceSessions[e]}getSfuConferenceSessionForRoom(e){var t=null;return e&&(t=this.conferenceSessions[e.getSFUConfEndpointId()]),t}updateWebConferenceInfos(e){this.$log.info('[WebConferenceService] updateWebConferenceInfos'),Object.assign(this.conferenceEndpoints,e),this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.webrtcConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then((e)=>{let t='nothing';e&&(t=e.name),this.webConferenceRoom=e,this.$log.info('[WebConferenceService] === updateWebConferenceInfos : webrtcConferenceId is currently attached to '+t)},()=>{this.$log.info('[WebConferenceService] === updateWebConferenceInfos FAILURE ===')})}updateWebSharingOnlyConferenceInfos(e){this.$log.info('[WebConferenceService] updateWebSharingOnlyConferenceInfos'),Object.assign(this.conferenceEndpoints,e),this.webrtcSharingOnlyConferenceId=this.getWebRtcSharingOnlyConfEndpointId(),this.webrtcSharingOnlyConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcSharingOnlyConferenceId).then((e)=>{let t=e&&e.name?e.name:'nothing';this.webrtcSharingOnlyRoom=e,this.$log.info('[WebConferenceService] === updateWebSharingOnlyConferenceInfos : webrtcSharingOnlyConferenceId is currently attached to '+t)},()=>{this.$log.info('[WebConferenceService] === updateWebSharingOnlyConferenceInfos FAILURE ===')})}updateWebConferenceRoom(){return this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.$q((e,t)=>{this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then((t)=>{let a='nothing';t&&(a=t.name),this.webConferenceRoom=t,this.$log.info('[WebConferenceService] === updateWebConferenceRoom : room is currently attached to '+a),e()},()=>{this.$log.info('[WebConferenceService] === updateWebConferenceRoom FAILURE==='),t()})})}getWebRtcConfEndpointId(){for(let e in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(e)&&this.conferenceEndpoints[e].mediaType===this.MEDIATYPE.WEBRTC)return this.conferenceEndpoints[e].id;return null}getWebRtcSharingOnlyConfEndpointId(){for(let e in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(e)&&this.conferenceEndpoints[e].mediaType===this.MEDIATYPE.WEBRTCSHARINGONLY)return this.conferenceEndpoints[e].id;return null}isJoinWebConferenceAllowed(){return!0}getWebConference(e){return e?this.conferenceSessions[e]:void 0}removeConferenceSession(e){if(e){this.removeAllJingleSessionsForConferenceSession(e),delete this.conferenceSessions[e];for(let e;this.statsIntervals.length;)e=this.statsIntervals.pop(),e&&(this.$interval.cancel(e),e=null);this.makingCall=!1}}removeAllJingleSessionsForConferenceSession(e){if(e){let t=this.conferenceSessions[e];if(t){for(let e in t.metricsState='ended',t.sessions)if(t.sessions.hasOwnProperty(e)){let a=t.sessions[e];this.updateStatisticsForSession(t.id,a.sid),delete this.videoService.callsStats[a.sid],this.videoService.disableAudioVideoMedia(a),this.xmppService.connection.jingle.terminate(a.sid)}t.sessions=[]}}}hasActiveConferenceSession(){for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)&&this.conferenceSessions[e].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[e].isActive()&&this.conferenceSessions[e].haveJoined)return!0;return!1}getActiveConferenceSession(){let e=null;for(let t in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(t)&&this.conferenceSessions[t].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[t].isActive()&&this.conferenceSessions[t].haveJoined&&(e=this.conferenceSessions[t]);return e}hasActiveSharingOnlyConferenceSession(){for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)&&this.conferenceSessions[e].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[e].isActive())return!0;return!1}getActiveSharingOnlyConferenceSession(){let e=null;for(let t in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(t)&&this.conferenceSessions[t].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[t].isActive()&&(e=this.conferenceSessions[t]);return e}hasIncomingVideoStream(e){if(e){let t=this.conferenceSessions[e];if(t)for(let e in t.sessions)if(t.sessions.hasOwnProperty(e)){let a=t.sessions[e];if(!a.isInitiator&&('video'===a.remoteType||'sharing'===a.remoteType))return!0}return!1}}getRemoteSessionsWithVideoOrSharingStreams(e){let t=[];if(!e)return t;let a=this.conferenceSessions[e];if(a)for(let e in a.sessions)if(a.sessions.hasOwnProperty(e)){let r=a.sessions[e];r.isInitiator||'video'!==r.remoteType&&'sharing'!==r.remoteType||t.push(r)}return t}getRemoteSharingSession(e){let t=null;if(!e)return t;let a=this.conferenceSessions[e];if(a)for(let e in a.sessions)if(a.sessions.hasOwnProperty(e)){let r=a.sessions[e];if(!r.isInitiator&&'sharing'===r.remoteType){t=r;break}}return t}getRemoteVideoSessions(e){let t=[];if(!e)return t;let a=this.conferenceSessions[e];if(a)for(let e in a.sessions)if(a.sessions.hasOwnProperty(e)){let r=a.sessions[e];r.isInitiator||'video'!==r.remoteType||t.push(r)}return t}getRemoteAudioSession(e){let t;if(!e)return t;let a=this.conferenceSessions[e];if(a)for(let e in a.sessions)if(a.sessions.hasOwnProperty(e)){let r=a.sessions[e];if('audio'===r.localType){t=r;break}}return t}getRemoteMainVideoSession(e){let t;if(!e)return t;let a=this.conferenceSessions[e];if(a)for(let e in a.sessions)if(a.sessions.hasOwnProperty(e)){let r=a.sessions[e];if(!r.isInitiator&&'video'===r.remoteType&&r.mainSession){t=r;break}}return t}isAlreadySubscribedToPublisher(e,t){if(!e||!t)return!1;let a=!1,r=this.conferenceSessions[e];if(r&&r.videoGallery)for(let e=0;e<r.videoGallery.length;e++)if(r.videoGallery[e].publisherId===t){a=!0;break}return a}relatePublisherToElement(e,t,a){if(!e||!t||!a)return!1;this.$log.info('[WebConferenceService] relatePublisherToElement');let r=this.conferenceSessions[e];if(r)for(let e=0;e<r.videoGallery.length;e++)if(r.videoGallery[e].id===a){r.videoGallery[e].state='busy',r.videoGallery[e].publisherId=t.participantId,r.videoGallery[e].publisherJidIm=t.jid_im,r.videoGallery[e].displayName=t.participantId;let a=this.contactService.getContactByJid(t.jid_im);a&&(r.videoGallery[e].displayName=a.displayName);break}}getRelatedPublisherToElement(e,t){if(!e||!t)return null;this.$log.info('[WebConferenceService] getRelatedPublisherToElement');let a=null,r=this.conferenceSessions[e];if(r&&r.videoGallery)for(let e=0;e<r.videoGallery.length;e++)if(t===r.videoGallery[e].id&&r.videoGallery[e].publisherId){a=r.videoGallery[e];break}return a}relateSessionToPublisher(e,t,a){if(e&&t&&a){this.$log.info('[WebConferenceService] relateSessionToPublisher pubId '+t+' sessionId '+a);let r=this.conferenceSessions[e];if(r){for(let e=0;e<r.videoGallery.length;e++)if(t===r.videoGallery[e].publisherId&&!r.videoGallery[e].sessionId){r.videoGallery[e].sessionId=a;break}this.$log.info(r.videoGallery)}}}removeSessionFromVideoGallery(e,t){if(e&&t){e.videoGallery||(this.createVideoGalleryElements(),e.videoGallery=this.videoGalleryElements),this.$log.info('[WebConferenceService] removeSessionFromVideoGallery for conference '+e.id+' sessionId '+t);for(let a=0;a<e.videoGallery.length;a++)e.videoGallery[a].sessionId===t&&(e.videoGallery[a].sessionId='',e.videoGallery[a].state='free',e.videoGallery[a].publisherId='',e.videoGallery[a].publisherJidIm='',e.videoGallery[a].displayName='')}}reInitialiseVideoGalleryElementById(e,t){if(e&&t){e.videoGallery||(this.createVideoGalleryElements(),e.videoGallery=this.videoGalleryElements),this.$log.info('[WebConferenceService] reInitialiseVideoGalleryElementById for conference '+e.id+' elementId '+t);for(let a=0;a<e.videoGallery.length;a++)e.videoGallery[a].id===t&&(e.videoGallery[a].sessionId&&this.dropRemoteVideoSession(e,e.videoGallery[a].sessionId),e.videoGallery[a].sessionId='',e.videoGallery[a].state='free',e.videoGallery[a].publisherId='',e.videoGallery[a].publisherJidIm='',e.videoGallery[a].displayName='')}}updateMainScreenSession(e,t){if(!e||!t)return;this.$log.info('[WebConferenceService] updateMainScreenSession');let a=this.conferenceSessions[e],r=null;if(a)for(let e in a.sessions)if(a.sessions.hasOwnProperty(e)){let n=a.sessions[e];t===n.sid?(n.mainSession=!0,r=n):n.mainSession=!1}r&&this.attachMainMediaStream(r)}getListOfAvailableRemoteVideoPublishers(e){if(!e)return;this.$log.info('[WebConferenceService] getListOfAvailableRemoteVideoPublishers');let t=this.conferenceSessions[e],a=[];return t&&(!t.videoGallery&&(this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements),a=t.getListOfRemoteVideoPublishers(),a=a.filter((e)=>{for(let a=0;a<t.videoGallery.length;a++)if(t.videoGallery[a].publisherId===e.participantId)return!1;let a=this.contactService.getContactByJid(e.jid_im);return e.displayName=a?a.displayName:e.participantId,!0})),a}sendTransportReplaceForSession(e,t){if(!e)return void this.$log.warn('[WebConferenceService] sendTransportReplaceForSession missing session !');if(this.reconnecting)return void this.$log.warn('[WebConferenceService] sendTransportReplaceForSession already reconnecting !');let a=this;this.reconnecting=!0,t||(t=5e3),this.$interval((e)=>{a.reconnecting=!1,a.connected&&e&&e.peerconnection&&'stable'===e.peerconnection.signalingState&&'failed'===e.peerconnection.iceConnectionState&&(a.$log.info('[WebConferenceService] sendTransportReplaceForSession for session '+e.sid),e.connection=a.xmppService.connection,e.sendTransportReplace())},t,1,!0,e)}onAudioProfileChangeEvent(){if(this.$log.info('[WebConferenceService] onAudioProfileChangeEvent'),this.audioProfileChanging)return void this.$log.info('[WebConferenceService] onAudioProfileChangeEvent -- already changing');for(let e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)){let t=this.conferenceSessions[e];for(let e in t.sessions)if(t.sessions.hasOwnProperty(e)){let a=t.sessions[e];'audio'===a.localType&&(this.audioProfileChanging=!0,this.$interval((e)=>{this.audioProfileChanging=!1;this.videoService.getBrowserMedia(['audio']).then((t)=>{e.removeStream(e.localStreams[0]),this.videoService.stopActiveAudioVideoStreams(e),e.localStreams.push(t),e.addStream(e.localStreams[0]),e.sendTransportReplace()})},500,1,!0,a))}}}onJingleError(e){this.$log.info('[WebConferenceService] onJingleError -- '+e);let t=this.getConferenceBySessionId(e);if(t&&t.sessions){let a=t.sessions[e];'audio'===a.localType?this.leaveWebConference(t.id):(this.updateStatisticsForSession(t.id,e),t.localVideoSessionId===e?this.removeMediaFromConferenceSession(t,'video'):t.localSharingSessionId===e?this.removeMediaFromConferenceSession(t,'sharing'):(this.removeSessionFromVideoGallery(t,e),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',t)))}}onIceConnectionFailedForSession(e,t){if(this.$log.info('[WebConferenceService] onIceConnectionFailedForSession -- '+t),e&&e.sessions){let a=e.sessions[t];'audio'===a.localType?(e.status='reconnecting',this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',e),this.connected&&this.sendTransportReplaceForSession(a,5e3)):e.localVideoSessionId===t?this.removeMediaFromConferenceSession(e,'video'):e.localSharingSessionId===t?this.removeMediaFromConferenceSession(e,'sharing'):(this.updateStatisticsForSession(e.id,t),delete this.videoService.callsStats[t],this.removeSessionFromVideoGallery(e,t),delete e.sessions[t],this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',e))}}onIncomingCall(e){this.$log.info('[WebConferenceService] onIncomingCall -- '+e);let t=this.xmppService.connection.jingle.sessions[e],a=t.confId,r=this.conferenceSessions[a];return r?void(r.sessions[e]=t,t.localType=t.remoteType,t.sendAnswer(),t.accept(),t.publisherId&&'sharing'!==t.remoteType&&this.relateSessionToPublisher(a,t.publisherId,t.sid),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',r),this.videoService.callsStats[t.sid]={},this.updateStatisticsForSession(r.id,t.sid),this.statsIntervals.push(t.getStats(5e3))):void this.$log.error('[WebConferenceService] onIncomingCall no such conferenceSession '+a)}onTerminatedCall(e){this.$log.info('[WebConferenceService] onTerminatedCall -- '+e);let t=this.xmppService.connection.jingle.sessions[e];if(!t){let t=this.getActiveConferenceSession()?this.getActiveConferenceSession():this.getActiveSharingOnlyConferenceSession();if(t&&t.sessions){let a=t.sessions[e];a&&(t.metricsState='ended',this.updateStatisticsForSession(t.id,e)),t.localVideoSessionId===e?this.removeMediaFromConferenceSession(t,'video'):t.localSharingSessionId===e?this.removeMediaFromConferenceSession(t,'sharing'):(this.removeSessionFromVideoGallery(t,e),this.videoService.disableAudioVideoMedia(t.sessions[e]),delete t.sessions[e],delete this.videoService.callsStats[e],this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',t))}return}let a=t.confId,r=this.conferenceSessions[a];return r?void(this.updateStatisticsForSession(r.id,e),r.localVideoSessionId===e?this.removeMediaFromConferenceSession(r,'video'):r.localSharingSessionId===e?this.removeMediaFromConferenceSession(r,'sharing'):(this.removeSessionFromVideoGallery(r,e),this.videoService.disableAudioVideoMedia(t),this.xmppService.connection.jingle.terminate(t.sid),delete r.sessions[t.sid],delete this.videoService.callsStats[e],this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',r))):void this.$log.error('[WebConferenceService] onTerminatedCall no such conferenceSession '+a)}onConferenceCallSwitched(e){this.$log.info('[WebConferenceService] onConferenceCallSwitched -- '+e);let t=this.getActiveConferenceSession();t&&this.leaveWebConference(t.id)}onIceConnectionStateChange(e,t){this.$log.info('[WebConferenceService] onIceConnectionStateChange for session '+e);let a=this.getConferenceBySessionId(e);try{a&&t.peerconnection&&('stable'===t.peerconnection.signalingState&&'connected'===t.peerconnection.iceConnectionState&&(this.$log.info('[WebConferenceService] ICE Connection established successfully'),a.status='connected',t.remoteStreams&&t.remoteStreams.forEach((e)=>{0<e.getAudioTracks().length&&(this.videoService.RTC.attachMediaStream(angular.element('#globalAudioTag'),e),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',a),this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',a)),'stable'===t.peerconnection.signalingState&&'completed'===t.peerconnection.iceConnectionState&&(this.$log.info('[WebConferenceService] ICE Connection completed successfully'),'connected'!==a.status&&(a.status='connected',t.remoteStreams&&t.remoteStreams.forEach((e)=>{0<e.getAudioTracks().length&&(this.videoService.RTC.attachMediaStream(angular.element('#globalAudioTag'),e),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast('ON_CONFERENCE_UPDATED_EVENT',a),this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',a))),'stable'===t.peerconnection.signalingState&&'disconnected'===t.peerconnection.iceConnectionState&&this.$log.info('[WebConferenceService] ICE Connection State disconnected'),'stable'===t.peerconnection.signalingState&&'failed'===t.peerconnection.iceConnectionState&&(this.$log.info('[WebConferenceService] ICE Connection State failed'),this.onIceConnectionFailedForSession(a,e)))}catch(e){this.$log.error('[WebConferenceService] onIceConnectionStateChange error '+e)}}updateOrCreateConferenceSession(e,t,a='webrtc'){if(this.$log.debug('[webConferenceService] updateOrCreateConferenceSession for '+e),!e||!t||!t.data)return this.$log.error('[webConferenceService] updateOrCreateConferenceSession - Not enough data'),null;let r=this.conferenceSessions[e];return r?t.data.active!==r.active&&(this.$log.debug('active'),r.updateActiveState(t.data.active),this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',r)):(this.$log.debug('[webConferenceService] updateOrCreateConferenceSession - create new conferencesession with id '+e+'and data: \n'+JSON.stringify(t.data)),r=this.ConferenceSession.createFromData(e,[],t.data.active,a),this.conferenceSessions[e]=r,this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',r)),t.data.participants&&(this.$log.debug('[webConferenceService] updateOrCreateConferenceSession - update participants for '+e+' with:\n'+JSON.stringify(t.data.participants)),r.updateParticipants(t.data.participants).then(()=>{this.$rootScope.$broadcast('ON_CONFERENCE_PARTICIPANT_EVENT',r)})),r}updateOrCreateWebConferenceEndpoint(e){if(this.$log.info('[WebConferenceService] updateOrCreateWebConferenceEndpoint for '+e.id),!e)return this.$log.error('[WebConferenceService] updateOrCreateWebConferenceEndpoint - no conference data !'),null;if(e.mediaType!==this.MEDIATYPE.WEBRTC&&e.mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.error('[WebConferenceService] updateOrCreateWebConferenceEndpoint - wrong mediaType:'+e.mediaType),null;let t=this.Conference.createFromData(e);return this.conferenceEndpoints[e.id]=t,t.mediaType===this.MEDIATYPE.WEBRTC?this.updateWebConferenceInfos([t]):this.updateWebSharingOnlyConferenceInfos([t]),this.conferenceEndpoints[e.id]}makeSnapshotForConfId(e=null,t){if(!e){let e='[webConferenceService] makeSnapshotForConfId - No confId !!';return this.$log.error(e),this.$q.reject(e)}return this.$q((a,r)=>{this.$http({method:'GET',url:this.confPortalURL+e+'/snapshot?mediaType=webrtc',headers:this.authService.getRequestHeader()}).then((r)=>{this.$log.info('[webConferenceService] makeSnapshotForConfId success for confId '+e);let n=r.data;this.updateOrCreateConferenceSession(e,n,t),a(n.data)}).catch((t)=>{this.$log.info('[webConferenceService] makeSnapshotForConfId failure for confID '+e),404===t.status?this.$log.error('[webConferenceService] makeSnapshotForConfId - confId '+e+' not found on server'):this.$log.error('[webConferenceService] makeSnapshotForConfId - inconsistent object on server'),this.conferenceSessions[e]&&this.removeConferenceSession(e),r()})})}refreshConferenceSessions(){return this.$log.info('[webConferenceService] refreshConferenceSessions'),this.$q((e,t)=>{let a=[];for(let r in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(r)){let e=this.conferenceSessions[r];a.push(this.makeSnapshotForConfId(e.id,e.type))}this.$q.all(a).then(()=>{this.$log.info('[webConferenceService] refreshConferenceSessions -- success'),e()}).catch(()=>{this.$log.error('[webConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions'),this.removeAllConferenceSessions(),t()})})}removeAllConferenceSessions(){for(let e in this.$log.info('[webConferenceService] removeAllConferenceSessions'),this.conferenceSessions)this.conferenceSessions.hasOwnProperty(e)&&this.removeConferenceSession(e)}getConferenceSessionForRoom(e){let t=null;if(e&&e.length)for(let a=0;a<e.length;a++)(e[a].mediaType===this.MEDIATYPE.WEBRTC||e[a].mediaType===this.MEDIATYPE.WEBRTCSHARINGONLY)&&(t=this.conferenceSessions[e[a].confEndpointId]);return t}}e.$inject=['$q','$rootScope','$log','$http','uuid4','$interval','authService','xmppService','videoService','roomService','errorHelperService','ConferenceSession','contactService','platformService','Conference','profileService'];angular.module('rainbow').service('webConferenceService',e)},function(){class e{constructor(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g){this.$q=e,this.$log=t,this.$rootScope=a,this.$interval=r,this.$translate=n,this.$http=o,this.xmppService=i,this.authService=s,this.Conference=d,this.profileService=c,this.contactService=l,this.webConferenceService=p,this.pstnConferenceService=u,this.roomService=m,this.errorHelperService=g,this.MEDIATYPE={PSTNAUDIO:'pstnAudio',WEBRTC:'webrtc',WEBRTCSHARINGONLY:'webrtcSharingOnly'},this.started=!1,this.listeners=[],this.conferenceRef=null,this.conferenceMngtRef=null,this.pgiConferenceProvisionRef=null}start(e){return this.$q((t)=>{let a=performance.now();return this.$log.info('[ConferenceService] === STARTING ==='),this.confProvPortalURL=config.restServerUrl+'/api/rainbow/confprovisioning/v1.0/',this.confPortalURL=config.restServerUrl+'/api/rainbow/conference/v1.0/conferences/',this.computePstnConferencePremission(),this.attachHandlers(),this.pstnConferenceService.retrievePstnPhoneNumbers(),this.retrieveConferences(null,!1).then(()=>this.pstnConferenceService.pstnInstantConferenceEndpoint?this.retrieveConferenceUser(this.contactService.userContact.dbId):this.$q.when()).then(()=>this.makeSnapshots()).then(()=>this.pstnConferenceService.isPstnConferenceAvailable?this.initializePersonalMeeting():this.$q.when()).then(()=>{this.started=!0;let r=Math.round(performance.now()-a);e.push({service:'conferenceService',startDuration:r}),this.$log.info('[ConferenceService] === STARTED ('+r+' ms) ==='),t()}).catch((e)=>{this.$log.info('[ConferenceService] === STARTING FAILURE === '+e.message),t()})})}stop(){return this.$q((e)=>{this.$log.info(''),this.$log.info('[ConferenceService] === STOPPING ==='),this.listeners&&this.listeners.forEach((e)=>{e()}),this.started=!1,this.$log.info('[ConferenceService] === STOPPED ==='),e()})}attachHandlers(){this.$log.info('[ConferenceService] attachHandlers'),this.conferenceRef&&(this.xmppService.connection.deleteHandler(this.conferenceRef),this.conferenceRef=null),this.conferenceRef=this.xmppService.connection.addHandler((e)=>this.onConferenceUpdate(e),'jabber:iq:conference','message',null),this.conferenceMngtRef&&(this.xmppService.connection.deleteHandler(this.conferenceMngtRef),this.conferenceMngtRef=null),this.conferenceMngtRef=this.xmppService.connection.addHandler((e)=>this.onConferenceManagement(e),null,'message','management'),this.listeners.push(this.$rootScope.$on('ON_PROFILE_FEATURES_UPDATED',()=>{this.onMyProfileFeaturesChanged()}))}reconnectService(){this.$log.info('[ConferenceService] reconnectService'),this.attachHandlers(),this.refreshConferenceSessions()}onMyProfileFeaturesChanged(){let e=this.pstnConferenceService.isPstnConferenceAvailable;if(this.computePstnConferencePremission(),!1===this.pstnConferenceService.isPstnConferenceAvailable&&!0===e&&this.$rootScope.$broadcast('ON_OPEN_GLOBAL_POPUP',{popupTitle:'information',popupBody:'pgiRightsRemovedWarning',okLabel:'ok'}),this.pstnConferenceService.isPstnConferenceAvailable)return this.retrieveConferences(null,!1).then(()=>this.pstnConferenceService.pstnInstantConferenceEndpoint?this.retrieveConferenceUser(this.contactService.userContact.dbId):this.$q.when()).then(()=>this.initializePersonalMeeting()).then(()=>this.makeSnapshots())}computePstnConferencePremission(){let e=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),t=!0,a=this.profileService.getMyProfiles();a&&0<a.length&&a.forEach((e)=>{-1!==e.profileName.toLowerCase().indexOf('conference')&&-1!==e.status.toLowerCase().indexOf('active')&&e.provisioningNeeded&&0<e.provisioningNeeded.length&&e.provisioningNeeded.forEach((e)=>{-1!==e.providerType.toLowerCase().indexOf('pgi')&&(t=e.provisioningOngoing,t&&(this.pgiConferenceProvisionRef&&(this.xmppService.connection.deleteHandler(this.pgiConferenceProvisionRef),this.pgiConferenceProvisionRef=null),this.pgiConferenceProvisionRef=this.xmppService.connection.addHandler((e)=>this.onConferenceProvisionUpdate(e),null,'message','management')))})}),this.pstnConferenceService.isPstnConferenceAvailable=e&&!t,this.$rootScope.$broadcast('ON_CONFERENCE_FEATURES_UPDATED')}onConferenceProvisionUpdate(e){let t=$(e);return 0<t.find('confuseractivated ').length&&(this.pgiConferenceProvisionRef&&(this.xmppService.connection.deleteHandler(this.pgiConferenceProvisionRef),this.pgiConferenceProvisionRef=null),this.pstnConferenceService.isPstnConferenceAvailable=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),this.pstnConferenceService.isPstnConferenceAvailable&&this.retrieveConferences(null,!1).then(()=>this.pstnConferenceService.pstnInstantConferenceEndpoint?this.retrieveConferenceUser(this.contactService.userContact.dbId):this.$q.when()).then(()=>this.initializePersonalMeeting()).then(()=>this.makeSnapshots()),this.$rootScope.$broadcast('ON_CONFERENCE_FEATURES_UPDATED')),!0}getPstnInstantConferenceEndpoint(){return this.pstnConferenceService.pstnInstantConferenceEndpoint}getPstnInstantConferenceEndpointId(){return this.pstnConferenceService.pstnInstantConferenceEndpoint?this.pstnConferenceService.pstnInstantConferenceEndpoint.id:-1}getPstnConferenceUser(){return this.pstnConferenceService.pstnConferenceUser}getWebConferenceEndpoints(){return this.webConferenceService.conferenceEndpoints}createConference(e,t,a,r,n,o){return this.$q((i,s)=>{this.$log.info('[conferenceService] createConference'),this.$http({method:'POST',url:this.confProvPortalURL+'conferences',headers:this.authService.getRequestHeader(),data:{confUserId:e,name:t,startDate:a,endDate:r,timeZone:n,provisioning:!!o}}).then((e)=>{let t=e.data.data,a=this.Conference.createFromData(t);t.hasOwnProperty('id')&&(t.mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.pstnConferenceEndpoints[t.id]=a:this.webConferenceService.conferenceEndpoints[t.id]=a),this.$log.info('[conferenceService] createConference successfully'),i(a)},(e)=>{let t=e.data?e.data.errorDetails:e.data,a='createConference failure: '+t;this.$log.error('[conferenceService] '+a),s(new Error(a))})})}deleteConference(e){return this.$q((t,a)=>{this.$log.info('[conferenceService] deleteConference'),this.$http({method:'DELETE',url:this.confProvPortalURL+'conferences/'+e,headers:this.authService.getRequestHeader()}).then(()=>{this.pstnConferenceService.pstnConferenceEndpoints[e]&&this.pstnConferenceService.pstnInstantConferenceEndpoint&&this.pstnConferenceService.pstnInstantConferenceEndpoint.id!==e&&delete this.pstnConferenceService.pstnConferenceEndpoints[e],this.webConferenceService.conferenceEndpoints[e]&&delete this.webConferenceService.conferenceEndpoints[e],this.$log.info('[conferenceService] deleteConference successfully'),t()},(e)=>{let t=e.data?e.data.errorDetails:e.data,r='deleteConference failure: '+t;this.$log.error('[conferenceService] '+r),a(new Error(r))})})}makeSnapshotsForList(e){return this.$q((t)=>{if(this.$log.info('[ConferenceService] makeSnapshotsForList'),!e||!e.length)return void t();let a=[];for(let r=0;r<e.length;r++)a.push(this.makeSnapshotForConfId(e[r].confEndpointId,e[r].mediaType));this.$q.all(a).finally(()=>{t(this.getConferenceSessionForRoom(e))})})}getConferenceSessionForRoom(e){let t=null,a=null;if(e&&e.length)for(let r=0;r<e.length;r++)e[r].mediaType===this.MEDIATYPE.PSTNAUDIO?t=this.pstnConferenceService.conferenceSessions[e[r].confEndpointId]:a=this.webConferenceService.conferenceSessions[e[r].confEndpointId];return t?t:a}getMatchingConferenceSession(e,t){let a=null;if(e&&e.length)for(let r=0;r<e.length;r++)e[r].confEndpointId===t&&(a=e[r].mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[t]:this.webConferenceService.conferenceSessions[t]);return a}makeSnapshots(){return this.$log.info('[ConferenceService] makeSnapshots'),this.$q((e)=>{let t=[];for(let a in this.pstnConferenceService.pstnInstantConferenceEndpoint&&t.push(this.makeSnapshotForConfId(this.pstnConferenceService.pstnInstantConferenceEndpoint.id,this.pstnConferenceService.pstnInstantConferenceEndpoint.mediaType)),this.webConferenceService.conferenceEndpoints)if(this.webConferenceService.conferenceEndpoints.hasOwnProperty(a)){let e=this.webConferenceService.conferenceEndpoints[a];t.push(this.makeSnapshotForConfId(e.id,e.mediaType))}this.$q.all(t).finally(()=>{this.$log.info('[ConferenceService] makeSnapshots done'),e()})})}retrieveConferenceUser(e){return this.pstnConferenceService.retrieveConferenceUser(e)}onConferenceUpdate(e){this.$log.info('[ConferenceService] onConferenceUpdate message: '+e.innerHTML);let t=$(e).find('conference-id'),a=t.text(),r=$(e).find('media-type'),n=this.MEDIATYPE.PSTNAUDIO;if(r&&r.length&&r.text&&(n=$(r[0]).text()),a){let t=null;if(t=n===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[a]:this.webConferenceService.conferenceSessions[a],!t)switch(this.$log.info('[ConferenceService] no such session for ID '+a),n){case'webrtc':break;case'webrtcsharing':let t=$(e).find('publisher'),r=t.find('jid-im').text(),o=t.find('publisher-id').text(),i={participantId:o,mediaType:n,jid_im:r};this.subscribeToPublisher(a,i);break;default:}else this.updateConferenceSession(e,t)}return!0}onConferenceManagement(e){try{let t=$(e).find('confendpoint');if(t.length&&'update'===t.attr('action')){this.$log.info('[ConferenceService] onConferenceManagement - update of conference');let t=$(e).find('confendpointid'),a=t.text();return this.$rootScope.$broadcast('ON_CONFERENCE_DATA_UPDATED_EVENT',a),!0}return!0}catch(e){return!0}}makeSnapshotForConfId(e,t=this.MEDIATYPE.PSTNAUDIO){return this.$log.info('[ConferenceService] makeSnapshotForConfId '+e),this.$q((a,r)=>{if(!e){let e=new Error('[ConferenceService] makeSnapshotForConfId missing conf ID !');return this.$log.error(e.message),void r(e)}let n=t===this.MEDIATYPE.WEBRTC||t===this.MEDIATYPE.WEBRTCSHARINGONLY?this.MEDIATYPE.WEBRTC:this.MEDIATYPE.PSTNAUDIO;this.$http({method:'GET',url:this.confPortalURL+e+'/snapshot?mediaType='+n,headers:this.authService.getRequestHeader()}).then((r)=>{this.$log.info('[ConferenceService] makeSnapshotForConfId success for confId '+e);let o=r.data;n===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.updateOrCreateConferenceSession(e,o):this.webConferenceService.updateOrCreateConferenceSession(e,o,t),a(o.data)}).catch((t)=>{this.$log.info('[ConferenceService] makeSnapshotForConfId failure for confID '+e),404===t.status?this.$log.error('[ConferenceService] makeSnapshotForConfId - confId '+e+' not found on server'):this.$log.error('[ConferenceService] makeSnapshotForConfId - inconsistent object on server'),n===this.MEDIATYPE.PSTNAUDIO?delete this.pstnConferenceService.conferenceSessions[e]:delete this.webConferenceService.conferenceSessions[e];let a=this.errorHelperService.handleError(t);r(a)})})}retrieveConferences(e,t,a){switch(this.$log.info('[ConferenceService] retrieveConferences with mediaType='+e+' and scheduled='+t),e){case this.MEDIATYPE.PSTNAUDIO:return this.pstnConferenceService.retrievePstnConferences(t,a);case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:return this.webConferenceService.retrieveWebConferences(e);default:}return this.$q((e,a)=>{if(!this.pstnConferenceService.isPstnConferenceAvailable&&!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED))return this.$log.warn('[ConferenceService] retrieveConferences - user is not allowed'),void a(new Error('notAllowed'));let r='conferences?format=full&userId='+this.contactService.userContact.dbId;angular.isDefined(t)&&(r+='&scheduled='+t),this.$http({method:'GET',url:this.confProvPortalURL+r,headers:this.authService.getRequestHeader()}).then((t)=>{let a=t.data.data;for(let e of a)switch(e.mediaType){case this.MEDIATYPE.PSTNAUDIO:this.pstnConferenceService.updateOrCreatePstnConferenceEndpoint(e);break;case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.updateOrCreateWebConferenceEndpoint(e);break;default:}this.$log.info('[ConferenceService] retrieveConferences successfully'),e(a)},(e)=>{let t=e.data?e.data.errorDetails:e.data,r='retrieveConferences failure: '+t;this.$log.error('[ConferenceService] '+r),a(new Error(r))})})}retrieveConference(e){return this.$log.info('[ConferenceService] retrieveConference'),e?this.$q((t,a)=>this.pstnConferenceService.pstnConferenceEndpoints[e]?void t(this.pstnConferenceService.pstnConferenceEndpoints[e]):this.webConferenceService.conferenceEndpoints[e]?void t(this.webConferenceService.conferenceEndpoints[e]):void this.$http({method:'GET',url:this.confProvPortalURL+'conferences/'+e,headers:this.authService.getRequestHeader()}).then((e)=>{let a=e.data.data;if(a&&a.hasOwnProperty('id')){let e=this.Conference.createFromData(a);a.mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.pstnConferenceEndpoints[a.id]=e:this.webConferenceService.conferenceEndpoints[a.id]=e}this.$log.info('[ConferenceService] retrieveConference successfully'),t(a)},(e)=>{let t=e.data?e.data.errorDetails:e.data,r='retrieveConference failure: '+t;this.$log.error('[ConferenceService] '+r),a(new Error(r))})):(this.$log.warn('[ConferenceService] retrieveConference - missing confID'),this.$q.reject(new Error('retrieveConference - missing confID')))}updateConferenceSession(e,t){this.$log.info('[ConferenceService] updateConferenceSession');let a=$(e).find('conference-state');if(a.length){let e=a.find('active'),r='true'===e.text(),n=a.find('talker-active'),o='true'===n.text(),i=a.find('recording-started'),s='true'===i.text();this.updateState(t,r,o,s)}let r=$(e).find('talkers');if(r.length){let e=[];r.find('participant-id').each((t,a)=>{let r=$(a),n=r.text();e.push(n)}),this.updateTalkers(t,e)}let n=$(e).find('participants');if(0===n.length&&(n=$(e).find('updated-participants')),n.length||(n=$(e).find('added-participants')),n.length){let e=[];n.find('participant').each((t,a)=>{let r=$(a),n=r.find('participant-id').text(),o=r.find('jid-im').text(),i=r.find('phone-number').text(),s=r.find('role').text(),d=r.find('mute').text(),c=r.find('hold').text(),l=r.find('cnx-state').text();e.push({participantId:n,jid_im:o,phoneNumber:i,participantRole:s,mute:'on'===d,held:'on'===c,participantState:l})}),this.createOrUpdateParticipants(t,e)}let o=$(e).find('removed-participants');if(o.length){let e=[];o.find('participant-id').each((t,a)=>{let r=$(a),n=r.text();e.push(n)}),this.removeParticipants(t,e)}let i=$(e).find('added-publishers');i.length&&(i.find('publisher').each((e,a)=>{let r=$(a),n=r.find('publisher-id').text(),o=r.find('media-type').text(),i=r.find('jid-im').text();this.addPublisher(t,n,o,i)}),this.$rootScope.$broadcast('ON_CONFERENCE_PUBLISHER_UPDATED',t));let s=$(e).find('removed-publishers');s.length&&(s.find('publisher').each((e,a)=>{let r=$(a),n=r.find('participant-id').text(),o=r.find('media-type').text();for(let r=0,i;r<t.publishers.length;r++)if(i=t.publishers[r],i.participantId===n&&i.mediaType===o){t.publishers.splice(r,1);break}}),this.$rootScope.$broadcast('ON_CONFERENCE_PUBLISHER_UPDATED',t));let d=$(e).find('publishers');return d.length&&(d.find('publisher').each((e,a)=>{let r=$(a),n=r.find('publisher-id').text(),o=r.find('media-type').text(),i=r.find('jid-im').text();this.addPublisher(t,n,o,i)}),this.$rootScope.$broadcast('ON_CONFERENCE_PUBLISHER_UPDATED',t)),!0}updateState(e,t,a,r){if(t||this.contactService.resetBusyState(),e.active&&!t){if(this.contactService.userContact.guestMode&&e.type!==this.MEDIATYPE.WEBRTCSHARINGONLY)this.$rootScope.$broadcast('ON_OPEN_POPUP','concludeInvitationEndMeeting');else{let t=this.roomService.findRoomsWithConfId(e.id);if(t&&t.length&&!t[0].owner)switch(e.type){case this.MEDIATYPE.WEBRTCSHARINGONLY:break;case this.MEDIATYPE.PSTNAUDIO:case this.MEDIATYPE.WEBRTC:default:if(e.isParticipantConnectedByJid(this.contactService.userContact.dbId)){let e=_escape(t[0].ownerContact.displayName),a=_escape(t[0].name),r=this.$translate.instant('meetingEndBy',{owner:e,meeting:a});this.$rootScope.$broadcast('GLOBAL_NOTIFY_MESSAGE_EVENT',r)}}else if(t&&t.length&&t[0].owner&&(e.id===this.getPstnInstantConferenceEndpointId()&&this.cleanPersonalMeeting(t[0]),e.type===this.MEDIATYPE.PSTNAUDIO)){let e=t[0].getSFUSharingConfEndpointId(),a=this.webConferenceService.getConferenceSessionById(e);a&&a.isActive()&&this.webConferenceService.stopWebConference(t[0])}}e.participants=[],e.status='ended'}e.updateStateFromData(t,a,r),this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',e)}updateTalkers(e,t){e.updateTalkers(t),this.$rootScope.$broadcast('ON_CONFERENCE_TALKER_EVENT',e)}createOrUpdateParticipants(e,t){e.updateParticipants(t).then((t)=>{e.participants.find((e)=>e.jid_im===this.contactService.userContact.id&&'disconnected'!==e.state)&&e.type!==this.MEDIATYPE.WEBRTCSHARINGONLY&&this.contactService.setBusyState('dnd','audio'),this.$rootScope.$broadcast('ON_CONFERENCE_PARTICIPANT_EVENT',e),'webrtc'===e.type&&t&&this.$rootScope.$broadcast('ON_WEB_CONFENRECE_PARTICIPANT_JOINED_EVENT',e)})}removeParticipants(e,t){if(e.removeParticipants(t),!e.participants.find((e)=>e.jid_im===this.contactService.userContact.id))switch(this.contactService.resetBusyState(),e.type){case this.MEDIATYPE.WEBRTC:if(this.webConferenceService.removeAllJingleSessionsForConferenceSession(e.id),e.active){let t=this.roomService.findRoomsWithConfId(e.id);if(t.length){let e=_escape(t[0].name),a=this.$translate.instant('meetingDisconnect',{meeting:e});this.$rootScope.$broadcast('GLOBAL_NOTIFY_MESSAGE_EVENT',a)}}e.cleanupSessionData();break;case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.removeAllJingleSessionsForConferenceSession(e.id),e.cleanupSessionData();break;case this.MEDIATYPE.PSTNAUDIO:let t=this.roomService.findRoomsWithConfId(e.id);if(t&&t.length&&t[0].getSFUSharingConfEndpointId()){let e=t[0].getSFUSharingConfEndpointId();if(t[0].owner)this.stopConference(e,this.MEDIATYPE.WEBRTC,t[0].dbId).catch(()=>{this.$log.warn('[ConferenceService] - error stoping the conference, trying to just leave it ...'),this.webConferenceService.leaveWebConference(e)});else{let t=this.webConferenceService.getConferenceSessionById(e),a=t?t.getConnectedParticipantByJid(this.contactService.userContact.jid):null;this.webConferenceService.leaveWebConference(e),a&&this.disconnectsParticipant(e,a.participantId,this.MEDIATYPE.WEBRTC)}}break;default:}this.$rootScope.$broadcast('ON_CONFERENCE_PARTICIPANT_EVENT',e)}addPublisher(e,t,a,r){let n=!0;for(let o=0,i;o<e.publishers.length;o++)if(i=e.publishers[o],i.participantId===t&&i.mediaType===a){n=!1;break}let o={participantId:t,mediaType:a,jid_im:r};if(n&&e.publishers.push(o),n&&'video'===a){let a=this.webConferenceService.getFreeVideoGalleryElement(e.id);a&&!this.webConferenceService.isAlreadySubscribedToPublisher(e.id,o.participantId)&&(this.$log.info('[ConferenceService] subscribe to publisher '+e.id+' for id '+t+'and element id '+a.id),a.state='busy',a.publisherId=o.participantId,this.$interval((e,t,r)=>{this.$log.info('[ConferenceService] subscribe to publisher '+e.id+' for id '+t.participantId+'and element id '+a.id),this.subscribeToPublisher(e.id,t,r).catch(()=>{this.$log.error('[ConferenceService] subscribe to publisher failed, reset the video gallery element with id '+r),this.webConferenceService.reInitialiseVideoGalleryElementById(e,r)})},2500,1,!0,e,o,a.id))}}stopConference(e='',t=this.MEDIATYPE.PSTNAUDIO,a=''){if(this.$log.info('[ConferenceService] stopConference( confId='+e+', type='+t+')'),!e||!a&&t!==this.MEDIATYPE.PSTNAUDIO)return this.$log.warn('[ConferenceService] stopConference missing conf ID or roomID'),this.$q.reject();let r=this.pstnConferenceService.conferenceSessions[e]?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e];return r&&r.isActive()?this.$q((r,n)=>{this.$http({method:'PUT',url:this.confPortalURL+e+'/stop',headers:this.authService.getPostHeader(),data:{mediaType:t,roomId:a}}).then(()=>{this.contactService.resetBusyState();let a=null;a=t===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e],a&&(this.updateState(a,!1,!1,!1),a.cleanupSessionData(),this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',a)),this.$log.info('[ConferenceService] stopConference( confId='+e+') successfully'),r()},(a)=>{let r=a.data?a.data.errorDetails:a.data,o='stopConference( confId='+e+') failure: '+r;if(this.$log.error('[ConferenceService] '+o),404e3!==a.data.errorDetailsCode)this.$rootScope.$broadcast('ON_OPEN_GLOBAL_POPUP',{popupTitle:'warning',popupBody:'stopMeetingFailure',okLabel:'ok'});else{let a=null;a=t===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e],a&&(a.active=!1,a.participants=[],this.removeConferenceSession(a),this.$rootScope.$broadcast('ON_CONFERENCE_STATE_EVENT',a))}n(new Error(o))})}):(this.$log.warn('[ConferenceService] stopConference - no active conference session to stop'),this.$q.reject())}removeConferenceSession(e=null){e&&(e.type===this.MEDIATYPE.WEBRTC||e.type===this.MEDIATYPE.WEBRTCSHARINGONLY?this.webConferenceService.removeConferenceSession(e.id):delete this.pstnConferenceService.conferenceSessions[e.id])}disconnectsParticipant(e,t,a=this.MEDIATYPE.PSTNAUDIO){return e&&t?this.$q((r,n)=>{this.$log.info('[ConferenceService] disconnectsParticipant( confId='+e+'participantId='+t+')'),this.$http({method:'DELETE',url:this.confPortalURL+e+'/participants/'+t+'?mediaType='+a,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info('[ConferenceService] disconnectsParticipant( confId='+e+'participantId='+t+') successfully'),r()},(a)=>{let r=a.data?a.data.errorDetails:a.data,o='disconnectsParticipant( confId='+e+'participantId='+t+') failure: '+r;this.$log.error('[ConferenceService] '+o),n(new Error(o))})}):(this.$log.warn('[ConferenceService] disconnectsParticipant missing conf ID or participantId'),this.$q.reject())}updateConference(e,t,a=this.MEDIATYPE.PSTNAUDIO){return a===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.updateConference(e,t):void this.webConferenceService.updateConference(e,t)}updateConferenceState(e,t,a=this.MEDIATYPE.PSTNAUDIO){return this.$log.info('[ConferenceService] updateConferenceState( confId='+e+', option='+t+' mediaType='+a+')'),e&&t?this.$q((r,n)=>{let o=null;return o=a===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e],o?void this.$http({method:'PUT',url:this.confPortalURL+e+'/update',headers:this.authService.getRequestHeader(),data:{option:t,mediaType:o.type}}).then((t)=>{let a=t.data.data;this.$log.info('[ConferenceService] updateConferenceState( confId='+e+') successfully'),r(a)},(t)=>{let a=t.data?t.data.errorDetails:t.data,r='updatsConferenceState( confId='+e+') failure: '+a;this.$log.error('[ConferenceService] '+r),n(new Error(r))}):(this.$log.error('[ConferenceService] updateConferenceState - no corresponding conference session to update'),void n())}):(this.$log.error('[ConferenceService] updateConferenceState - missing a parameter'),this.$q.reject())}updateParticipantState(e,t,a,r=this.MEDIATYPE.PSTNAUDIO){return this.$log.info('[ConferenceService] updateParticipantState( confId='+e+'participantId='+t+' option='+a+' mediaType='+r+')'),e&&t&&a?this.$q((n,o)=>{let i=null;return i=r===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[e]:this.webConferenceService.conferenceSessions[e],i?void this.$http({method:'PUT',url:this.confPortalURL+e+'/participants/'+t,headers:this.authService.getRequestHeader(),data:{option:a,mediaType:i.type}}).then((a)=>{let r=a.data.data;this.$log.info('[ConferenceService] updateParticipantState( confId='+e+'participantId='+t+') successfully'),n(r)},(a)=>{let r=a.data?a.data.errorDetails:a.data,n='updateParticipantState( confId='+e+'participantId='+t+') failure: '+r;this.$log.error('[ConferenceService] '+n),o(new Error(n))}):(this.$log.error('[ConferenceService] updateParticipantState - no corresponding conference session to update'),void o())}):(this.$log.error('[ConferenceService] updateParticipantState - missing a parameter'),this.$q.reject())}retrievePstnPhoneNumbers(e=!1){return this.pstnConferenceService.retrievePstnPhoneNumbers(e)}joinPstnConference(e,t,a,r,n){return this.$q((o,i)=>(this.$log.info('[ConferenceService] joinPstnConference with ( confId = '+e+' participantPhoneNumber = '+t+' country = '+r+' )'),e&&n?void this.makeSnapshotForConfId(e,this.MEDIATYPE.PSTNAUDIO).then(()=>{o(this.pstnConferenceService.initiatesCallParticipant(e,t,a,r))},()=>{i(new Error('[ConferenceService] joinPstnConference - error retrieving conference session details'))}):(this.$log.error('[ConferenceService] joinPstnConference - missing parameter'),void i(new Error('[ConferenceService] joinPstnConference - missing parameter')))))}cleanPersonalMeeting(e,t=!1){let a=e.getSFUSharingConfEndpointId(),r=this.webConferenceService.getConferenceSessionById(a);return r&&r.isActive()&&this.webConferenceService.stopWebConference(e),this.$q((a)=>{let r=e.name;return this.$log.debug('[ConferenceService] cleanPersonalMeeting - Detaching conference endpoint from room: ',r),this.roomService.deleteRoomConferenceEndPoint(e,this.getPstnInstantConferenceEndpointId()).then((t)=>404===t?(this.$log.debug('[ConferenceService] cleanPersonalMeeting - Conference already detached from personal meeting'),this.$q.reject()):(this.$log.debug('[ConferenceService] cleanPersonalMeeting - Updating name of old personal meeting'),e.name='['+moment().format('L').replace(new RegExp('[^.]?'+moment().format('YYYY')+'.?'),'')+' - '+moment().format('HH:mm')+'] '+r,this.roomService.ownerUpdateRoomNameAndDescription(e))).then(()=>(this.$log.debug('[ConferenceService] cleanPersonalMeeting - Archive old personal meeting'),this.roomService.ownerArchiveRoom(e))).then(()=>(this.$log.debug('[ConferenceService] cleanPersonalMeeting - Create room to host new personal meeting'),this.roomService.createRoom(r,e.desc,'none',null,!0,'pstnAudio'))).then((e)=>(this.$log.debug('[ConferenceService] cleanPersonalMeeting - Create room to host new personal meeting'),this.roomService.addRoomConferenceEndPoint(e,this.getPstnInstantConferenceEndpoint(),this.MEDIATYPE.PSTNAUDIO))).then((e)=>(this.$log.debug('[ConferenceService] cleanPersonalMeeting - Binding open-invite to new personal meeting'),this.roomService.bindOpenInviteToRoom(e.dbId,this.contactService.userContact.getOpenInviteId()))).then(()=>{t?(this.$log.debug('[ConferenceService] cleanPersonalMeeting - Reset open-invite'),this.contactService.resetOpenInviteId().then(()=>{this.$log.debug('[ConferenceService] cleanPersonalMeeting - Reset conference codes of new personal meeting'),this.updateConference(this.getPstnInstantConferenceEndpointId(),{resetPasswords:!0},'pstnAudio').then(()=>{a()})})):a()}).catch(()=>{this.$log.error('[ConferenceService] Something went wrong when trying to regenerate new personal meeting'),a()})})}initializePersonalMeeting(){return this.$q((e)=>this.roomService.retrieveOpenInviteRoom().then((t)=>{t&&t.isMeetingRoom()&&!t.conference.scheduled&&t.getPstnConfEndpointId()?e(t):(this.$log.warn('[ConferenceService] Open-Invite room does not meet the requirements, regenerating it ...'),e(this.cleanPersonalMeeting(t,!0)))}).catch(()=>{this.$log.warn('[ConferenceService] initializePersonalMeeting - something went wrong'),e()}))}retrievePersonalMeeting(){return this.$q((e,t)=>this.roomService.retrieveOpenInviteRoom().then((t)=>{e(t)}).catch(()=>this.pstnConferenceService.isPstnConferenceAvailable?(this.$log.warn('[ConferenceService] retrievePersonalMeeting - Creating room and attaching open-invite-id'),this.roomService.createRoom(this.$translate.instant('namePersonalConference',{name:this.contactService.userContact.displayName}),'','none',null,!0,'pstnAudio').then((e)=>this.roomService.addRoomConferenceEndPoint(e,this.getPstnInstantConferenceEndpoint(),this.MEDIATYPE.PSTNAUDIO)).then((e)=>this.roomService.bindOpenInviteToRoom(e.dbId,this.contactService.userContact.getOpenInviteId())).then((t)=>{e(t)}).catch(()=>{t(new Error('[ConferenceService] retrievePersonalMeeting - error regenerating personal meeting'))})):void t(new Error('[ConferenceService] retrievePersonalMeeting - not enough priviledges'))))}subscribeToPublisher(e='',t=null,a=''){return this.$q((r,n)=>e&&t?void(this.$log.info('[ConferenceService] subscribeToPublisher for confId '+e+' and publisher '+t.participantId),a&&this.webConferenceService.relatePublisherToElement(e,t,a),this.$http({method:'POST',url:this.confPortalURL+e+'/participants/'+t.participantId+'/subscribe',headers:this.authService.getRequestHeader()}).then((e)=>{this.$log.info('[ConferenceService] subscribeToPublisher successfully'),r(e.data)},(e)=>{let t=e.data?e.data.errorDetails:e.data,a='subscribeToPublisher failure: '+t;this.$log.error('[ConferenceService] '+a),n(new Error(a))})):(this.$log.warn('[ConferenceService] subscribeToPublisher missing parameters !! Ignore !'),void r()))}isUserContactInCall(){for(let e in this.webConferenceService.conferenceSessions)if(this.webConferenceService.conferenceSessions.hasOwnProperty(e)){let t=this.webConferenceService.conferenceSessions[e];if(t.isParticipantConnectedByJid(this.contactService.userContact.jid))return!0}return!1}stopAllConferencesFromRoom(e){var t=[],a=e.getPstnConfEndpointId(),r=e.getSFUSharingConfEndpointId(),n=e.getSFUConfEndpointId();return a&&t.push(this.stopConference(a)),r&&t.push(this.stopConference(r,'webrtc')),n&&t.push(this.stopConference(n,'webrtc')),this.$q.all(t)}refreshConferenceSessions(){let e=[this.webConferenceService.refreshConferenceSessions(),this.pstnConferenceService.refreshConferenceSessions()];return this.$q.all(e)}}e.$inject=['$q','$log','$rootScope','$interval','$translate','$http','xmppService','authService','Conference','profileService','contactService','webConferenceService','pstnConferenceService','roomService','errorHelperService'],angular.module('rainbow').service('conferenceService',e)},function(){angular.module('rainbow').service('profileService',['$q','$rootScope','$log','$http','$interval','Offer','authService','contactService',function(e,t,a,r,n,o,i,s){'use strict';var d=this;d.FeaturesEnum={COMPANY_ADMIN_COUNT:'COMPANY_ADMIN_COUNT',COMPANY_LOGO_MODIFICATION:'COMPANY_LOGO_MODIFICATION',COMPANY_DOMAIN_NAME_MODIFICATION:'COMPANY_DOMAIN_NAME_MODIFICATION',COMPANY_DETAILS_MODIFICATION:'COMPANY_DETAILS_MODIFICATION',COMPANY_SINGLE_SIGN_ON_SAML:'COMPANY_SINGLE_SIGN_ON_SAML',WEBRTC_FOR_MOBILE:'WEBRTC_FOR_MOBILE',BUBBLE_PARTICIPANT_COUNT:'BUBBLE_PARTICIPANT_COUNT',TELEPHONY_BASIC_CALL:'TELEPHONY_BASIC_CALL',TELEPHONY_SECOND_CALL:'TELEPHONY_SECOND_CALL',TELEPHONY_TRANSFER_CALL:'TELEPHONY_TRANSFER_CALL',TELEPHONY_CONFERENCE_CALL:'TELEPHONY_CONFERENCE_CALL',TELEPHONY_DEFLECT_CALL:'TELEPHONY_DEFLECT_CALL',TELEPHONY_PHONE_BOOK:'TELEPHONY_PHONE_BOOK',TELEPHONY_VOICE_MAIL:'TELEPHONY_VOICE_MAIL',TELEPHONY_CALL_FORWARD:'TELEPHONY_CALL_FORWARD',TELEPHONY_NOMADIC:'TELEPHONY_NOMADIC',CONFERENCE_PARTICIPANT_COUNT:'CONFERENCE_PARTICIPANT_COUNT',CONFERENCE_PARTICIPANT_ALLOWED:'CONFERENCE_PARTICIPANT_ALLOWED',WEBRTC_CONFERENCE_ALLOWED:'WEBRTC_CONFERENCE_ALLOWED',WEBRTC_CONFERENCE_PARTICIPANT_COUNT:'WEBRTC_CONFERENCE_PARTICIPANT_COUNT',WEBRTC_PARTICIPANT_ALLOWED:'WEBRTC_PARTICIPANT_ALLOWED',CONFERENCE_ALLOWED:'CONFERENCE_ALLOWED',CONFERENCE_DIAL_OUT:'CONFERENCE_DIAL_OUT',CONFERENCE_RECORDING:'CONFERENCE_RECORDING',MSO365_CALENDAR_PRESENCE:'MSO365_CALENDAR_PRESENCE',MSO365_DIRECTORY_SEARCH:'MSO365_DIRECTORY_SEARCH',MS_OUTLOOK_PLUGIN:'MS_OUTLOOK_PLUGIN',MS_SKYPE_PLUGIN:'MS_SKYPE_PLUGIN',FILE_SHARING_QUOTA_GB:'FILE_SHARING_QUOTA_GB',GOOGLE_CALENDAR_PRESENCE:'GOOGLE_CALENDAR_PRESENCE',WEBRTC_P2P_RECORDING:'WEBRTC_P2P_RECORDING',BUBBLE_PROMOTE_MEMBER:'BUBBLE_PROMOTE_MEMBER',BUBBLE_GUESTS_ALLOWED:'BUBBLE_GUESTS_ALLOWED',TELEPHONY_WEBRTC_GATEWAY:'TELEPHONY_WEBRTC_GATEWAY',TELEPHONY_WEBRTC_PSTN_CALLING:'TELEPHONY_WEBRTC_PSTN_CALLING',ANALYTICS_DASHBOARD_EC:'ANALYTICS_DASHBOARD_EC',ANALYTICS_DASHBOARD_BP:'ANALYTICS_DASHBOARD_BP',TELEPHONY_CALL_SUBJECT:'CALL_SUBJECT',CHANNEL_CREATE:'CHANNEL_CREATE',CHANNEL_CREATE_ADMIN_ROLE_BYPASS:'CHANNEL_CREATE_ADMIN_ROLE_BYPASS',CHANNEL_ACTIVATED:'CHANNEL_ACTIVATED'},d.started=!1,d.start=function(r){a.info(''),a.info('[profileService] === STARTING ==='),d.features={},d.profiles=[],d.mainOffers=[];var n=performance.now();return e(function(e,o){d.getServerProfile().then(function(){d.started=!0;var o=Math.round(performance.now()-n);r.push({service:'profileService',startDuration:o}),a.info('[profileService] === STARTED ('+o+' ms) ==='),t.$broadcast('ON_PROFILE_FEATURES_UPDATED'),t.$on('$destroy',t.$on('ON_PROFILE_FEATURES_UPDATE_NEEDED',d.onUserUpdateNeeded)),e()}).catch(function(e){a.info('[profileService] === STARTING FAILURE === '+e.message),o(e)})})},d.stop=function(){return a.info('[profileService] === STOPPING ==='),d.started=!1,a.info('[profileService] === STOPPED ==='),e.when()},d.restart=function(){a.info('[profileService] === RESTART ==='),d.onUserUpdateNeeded()},d.onUserUpdateNeeded=function(){d.timer||(d.timer=n(function(){d.getServerProfile().then(function(){t.$broadcast('ON_PROFILE_FEATURES_UPDATED'),d.timer=null}).catch(function(e){d.timer=null,a.info('[profileService] === onUserUpdateNeeded FAILURE === '+e.message)})},3e3,1))},d.getServerProfile=function(){return e.all([d.getServerProfiles(),d.getServerProfilesFeatures()])},d.getServerProfiles=function(){return e(function(e,t){r({method:'GET',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId+'/profiles',headers:i.getRequestHeader()}).then(function(t){d.profiles=[],d.mainOffers=[],t.data.data.forEach(function(e){a.debug('[profileService] getServerProfiles === response ==='+e),d.profiles.push(e);var t=o.createFromProfileData(e);(t.isExclusive||t.isDefault)&&d.mainOffers.push(t)}),d.mainOffers.sort(o.offerComparator),e()},function(e){var r='getServerProfiles failure: no server response';e&&(r='getServerProfiles failure: '+JSON.stringify(e)),a.error('[profileService] '+r),t(new Error(r))})})},d.getServerProfilesFeatures=function(){return e(function(e,t){r({method:'GET',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId+'/profiles/features',headers:i.getRequestHeader()}).then(function(t){d.features={},t.data.data.forEach(function(e){a.debug('[profileService] getServerProfilesFeatures === response ==='+JSON.stringify(e)),e.hasOwnProperty('featureUniqueRef')&&(d.features[e.featureUniqueRef]=e)}),e()},function(e){var r='getServerProfilesFeatures failure: no server response';e&&(r='getServerProfilesFeatures failure: '+JSON.stringify(e)),a.error('[profileService] '+r),t(new Error(r))})})},d.getUserData=function(){return i.getUserData()},d.setUserData=function(t){return e(function(e,n){var o=config.restServerUrl+'/api/rainbow/enduser/v1.0/users/'+s.userContact.dbId;r({method:'PUT',url:o,headers:i.getRequestHeader(),data:t}).then(function(r){a.info('[profileService] setUserData '+JSON.stringify(t)+' -- success'),e(r.data)},function(e){var t='setUserData failure: no server response';e&&(t='setUserData failure: '+JSON.stringify(e)),a.error('[profileService] '+t),n(new Error(t))})})},d.isFeatureEnabled=function(e){if(d.started&&d.features.hasOwnProperty(e)&&d.features[e].hasOwnProperty('featureType')&&'boolean'===d.features[e].featureType&&d.features[e].hasOwnProperty('isEnabled')){var t=d.features[e].isEnabled;return a.debug('[profileService] isFeatureEnabled('+e+'): '+t),t}return a.info('[profileService] isFeatureEnabled('+e+'): service not started or feature not enabled'),!1},d.getFeatureLimitMax=function(e){if(d.started&&d.features.hasOwnProperty(e)&&d.features[e].hasOwnProperty('featureType')&&'number'===d.features[e].featureType&&d.features[e].hasOwnProperty('limitMax')){var t=d.features[e].limitMax;return a.debug('[profileService] getFeatureLimitMax('+e+'): '+t),t}return a.info('[profileService] getFeatureLimitMax('+e+'): service not started or feature not enabled'),0},d.getFeatureLimitMin=function(e){if(d.started&&d.features.hasOwnProperty(e)&&d.features[e].hasOwnProperty('featureType')&&'number'===d.features[e].featureType&&d.features[e].hasOwnProperty('limitMin')){var t=d.features[e].limitMin;return a.debug('[profileService] getFeatureLimitMin('+e+'): '+t),t}return a.info('[profileService] getFeatureLimitMin('+e+'): service not started or feature not enabled'),0},d.getMyProfileOffer=function(){return 0<d.mainOffers.length?d.mainOffers.slice(-1)[0]:null},d.getMyProfileName=function(){var e=this.getMyProfileOffer();return e?e.name:null},d.getMyProfiles=function(){var e=[];return d.started?e=d.profiles:a.warn('[profileService] getMyProfiles(): service not started'),e},d.getMyProfileFeatures=function(){var e={};return d.started?Object.keys(d.features).forEach(function(t){var a=d.features[t],r={};Object.keys(a).filter(function(e){return'featureUniqueRef'===e||'featureType'===e||'limitMin'===e||'limitMax'===e||'isEnabled'===e}).forEach(function(e){r[e]=a[e]}),e[t]=r}):a.warn('[profileService] getMyProfileFeatures(): service not started'),e}}])},function(){angular.module('rainbow').service('updatingService',['$http','$log','$rootScope','$interval','randomString','centralizedService',function(e,t,a,r,n,o){'use strict';var i=this;i.url=window.location.origin+'/app/'+version+'/js/version.js',i.started=!1,i.start=function(){return t.info('[updatingService] === STARTING ==='),i.started=!0,t.info('[updatingService] === STARTED ==='),-1===i.url.indexOf('localhost')?void(i.interval&&r.cancel(i.interval),i.interval=r(i.checkUpdate,6e5),o.isDesktopApp()&&(i.intervalDesktop&&r.cancel(i.intervalDesktop),i.intervalDesktop=r(i.checkUpdateForDesktop,6e4))):void t.info('[updatingService] Do not start on localhost')},i.checkUpdate=function(){t.info('[updatingService] - Checking if a new version is online...'),e({method:'GET',url:i.url+'?rand='+n()}).then(function(){t.info('[updatingService] - The web client is up to date')},function(e){404===e.status?a.$broadcast('ON_AVAILABLE_UPDATE'):t.info('[updatingService] - An unknow error has been encountered.')})},i.checkUpdateForDesktop=function(){var e=o.containerVersion();if(t.info('[updatingService] - Checking if a new desktop version is available... '+e),!e){var r=navigator.userAgent.substring(navigator.userAgent.indexOf('Rainbow'));r&&(e=r.split('/')[1])}if(!e)return void t.error('[updatingService] - no desktop version found !! ');var n=e.split('.');if(35>parseInt(n[1],10)||35===parseInt(n[1],10)&&4>=parseInt(n[2],10)){t.info('[updatingService] - should update from version '+e);var i={popupTitle:'updatingDesktopTitle',popupBody:'updatingDesktopMessage',okLabel:'download',okLink:config.autorizationMicrosoftLink,blockingPopup:!0};i.okLink=0<=navigator.platform.toUpperCase().indexOf('MAC')?config.clientsURL.mac:config.clientsURL.windows,a.$broadcast('ON_OPEN_GLOBAL_POPUP',i)}},i.stop=function(){t.info('[updatingService] === STOPPING ==='),i.started=!1,i.interval&&r.cancel(i.interval),i.intervalDesktop&&r.cancel(i.intervalDesktop),t.info('[updatingService] === STOPPED ===')}}])},function(){angular.module('rainbow').service('calendarService',['$q','$rootScope','$log','$http','$interval','authService','contactService','xmppService','errorHelperService','profileService','conversationService','settingsService','$localStorage',function(e,t,a,r,n,o,i,s,d,c,l,p){'use strict';var u=this;this.intervalID=null,this.start=function(r){a.info(''),a.info('[calendarService] === STARTING ===');var o=performance.now();u.autorizationLink='',u.autorizationPopup=null,u.serviceActivated=!1,u.calendaRejectIfBusyActivated=!1,a.info('[calendarService] listen \'out of office\' status for roster contacts'),n(u.getAutoReplyForEachContact,5e3,1),u.intervalID=n(u.updateAutoReplyForEachContact,9e5),u.officeCalendarPresenceEnabled=c.isFeatureEnabled(c.FeaturesEnum.MSO365_CALENDAR_PRESENCE),u.googleCalendarPresenceEnabled=c.isFeatureEnabled(c.FeaturesEnum.GOOGLE_CALENDAR_PRESENCE),u.calendarPresenceEnabled=u.officeCalendarPresenceEnabled||u.googleCalendarPresenceEnabled,a.info('[calendarService] calendar presence status from profileService : '+u.calendarPresenceEnabled),u.disableCalendarPresencePrompt='true'===p.getSetting('disableCalendarPresence'),a.info('[calendarService] calendar presence prompt status from userSettings : '+!u.disableCalendarPresencePrompt);var s=Math.round(performance.now()-o);return r.push({service:'calendarService',startDuration:s}),a.info('[calendarService] === STARTED ('+s+' ms) ==='),u.calendarPresenceEnabled&&!i.userContact.guestMode&&(u.attachHandlers(),u.calendarPresenceChangeListener=t.$on('ON_ROSTER_PRESENCE_CHANGED_EVENT',u.onCalendarPresenceChange),u.connectionStateChangeListener=t.$on('ON_CONNECTION_STATE_CHANGE_EVENT',u.onConnectionStateChange),u.getCalendarState().then(function(e){if('none'!==e.status&&'deleted'!==e.status){u.serviceActivated=!0;var t=e.until?new Date(e.until):null,r=e.busy?'dnd':'online',n=e.busy?'busy':'';u.updateCalendarPresenceForUser(i.userContact.jid,r,t,n)}else'consent_required'===e.status?(a.info('[calendarService] calendar status -- '+e.status+' -- showPopup'),u.registerCalendars(!1)):u.disableCalendarPresencePrompt||(a.info('[calendarService] calendar status -- '+e.status+' -- showPopup'),u.registerCalendars(!1))}).catch(function(e){console.error(e),u.serviceActivated=!1,a.error('[calendarService] === STARTING FAILURE ===')})),e.when()},this.stop=function(){return a.info('[calendarService] === STOPPING ==='),u.serviceActivated=!1,u.calendarPresenceChangeListener&&u.calendarPresenceChangeListener(),u.connectionStateChangeListener&&u.connectionStateChangeListener(),this.messageHandlerRef&&(s.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),u.intervalID&&n.cancel(u.intervalID),a.info('[calendarService] === STOPPED ==='),e.when()},this.attachHandlers=function(){a.info('[calendarService] attachHandlers'),this.messageHandlerRef&&(s.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.messageHandlerRef=s.addHandler(function(e){return u.onUpdateMessageReceived(e),!0},'jabber:iq:configuration','message',null)},this.onConnectionStateChange=function(e,t){'connected'===t&&(a.info('[calendarService] onConnectionStateChange state:'+t),u.getCalendarState().then(function(e){if('none'!==e.status&&'deleted'!==e.status&&'consent_required'!==e.status){u.serviceActivated=!0;var t=new Date(e.until),a=e.busy?'dnd':'online',r=e.busy?'busy':'';u.updateCalendarPresenceForUser(i.userContact.jid,a,t,r)}}))},this.onUpdateMessageReceived=function(e){var r=$(e).find('calendar');if(r.length){var n=r.attr('status');a.info('[calendarService] onUpdateMessageReceived with status : '+n),u.serviceActivated='enabled'===n,t.$broadcast('ON_CALENDAR_STATUS_CHANGE',u.serviceActivated)}return!0},this.onCalendarPresenceChange=function(e,t){if(i.isTelJid(t.jid)&&'calendar'===i.getRessourceFromJid(t.jid)){var r=i.getImJid(t.jid);r&&(a.info('[calendarService] onCalendarPresenceChange -- status: '+t.status+' -- until: '+t.until+' -- message: '+t.message),u.updateCalendarPresenceForUser(r,t.status,t.until,t.message))}},this.updateAutoReplyForEachContact=function(){u.getAutoReplyInfoForContact(i.userContact),u.getAutoReplyForEachContact()},this.getAutoReplyForEachContact=function(){a.info('[calendarService] getAutoReplyForEachContact'),l.getConversations().forEach(function(e){null!==e.contact&&u.getAutoReplyInfoForContact(e.contact)})},this.getAutoReplyInfoForContact=function(t){return e(function(e,n){if(!t.calendarState.status)return a.info('[calendarService] getAutoReplyInfoForContact user has no calendar state'),void e();if(t.calendarState.lastUpdate){var i=moment.duration(t.calendarState.lastUpdate.diff(moment())),s=Math.abs(Math.floor(i.asMinutes()));if(15>s)return a.info('[calendarService] getAutoReplyInfoForContact state has been updated in the last 15min'),void e()}t.calendarState.lastUpdate=moment(),r({method:'GET',url:config.restServerUrl+'/api/rainbow/calendar/v1.0/automatic_reply?userid='+t.jid,headers:o.getRequestHeader()}).then(function(r){u.treatOutOfOfficeState(r.data,t),a.info('[calendarService] getAutoReplyInfoForContact success for contact '+t.jid),e()},function(e){var t=d.handleError(e);a.error('[calendarService] '+d.getErrorFullMessage(e,'getAutoReplyInfoForContact')),n(t)})})},this.getCalendarState=function(){return e(function(e,t){r({method:'GET',url:config.restServerUrl+'/api/rainbow/calendar/v1.0',headers:o.getRequestHeader()}).then(function(t){a.info('[calendarService] getCalendarState success -- status '+t.data.status),e(t.data)},function(){a.error('[calendarService] getCalendarState failure -- CalendarService portal not responding'),t()})})},this.registerCalendars=function(r){return e(function(n){if(u.serviceActivated)a.warn('[calendarService] registerCalendars -- already registered, ignore !'),n();else{a.info('[calendarService] registerCalendars');var o=[];u.officeCalendarPresenceEnabled&&o.push(u.getCalendarRegistrationInfo('office365')),u.googleCalendarPresenceEnabled&&o.push(u.getCalendarRegistrationInfo('googleCalendar')),e.all(o).finally(function(){if(u.autorizationGoogleLink||u.autorizationMicrosoftLink){var e={authentMicrosoftUrl:u.autorizationMicrosoftLink,authentGoogleUrl:u.autorizationGoogleLink,fromSettings:r};a.info('[calendarService] registerCalendars -- show registration popup'),t.$broadcast('ON_OPEN_CALENDARSELECTION_POPUP',e),n()}else a.error('[calendarService] registerCalendars -- no calendar provider response'),n()})}})},this.getCalendarRegistrationInfo=function(t){var n='o365',i='office365';return'googleCalendar'===t&&(n='gcal',i='google'),e(function(e,s){var d=p.getAppliLanguage().code;r({method:'POST',url:config.restServerUrl+'/api/rainbow/calendar/v1.0/register',headers:o.getRequestHeader(),data:{type:i,callback:window.location.origin+'/redirectO365.html?provider='+n+'&lang='+d}}).then(function(r){a.info('[calendarService] getCalendarRegistrationInfo for '+t+' -- success'),u.autorizationLink=r.data.url,'googleCalendar'===t?u.autorizationGoogleLink=u.autorizationLink:u.autorizationMicrosoftLink=u.autorizationLink,e(u.autorizationLink)},function(e){a.error('[calendarService] getCalendarRegistrationInfo failure'),a.error(e),s()})})},this.deactivateCalendar=function(){return a.info('[calendarService] deactivateCalendar'),e(function(e,t){r({method:'DELETE',url:config.restServerUrl+'/api/rainbow/calendar/v1.0',headers:o.getRequestHeader()}).then(function(){a.info('[calendarService] deactivateCalendar success'),u.serviceActivated=!1,e()},function(e){a.error('[calendarService] deactivateCalendar failure'),a.error(e),t()})})},this.updateCalendarPresenceForUser=function(e,r,n,o){i.getOrCreateContact(e).then(function(s){s.calendarState.status=r,s.calendarState.message=o;var d=null;'online'===r||n||(n=new Date),n&&(d=moment(n)),s.calendarState.mdate=d,d?d.isSame(moment(),'d')?(s.calendarState.until=d.format('LT'),s.calendarState.untilDate=!1):(s.calendarState.until=d.format('ll'),s.calendarState.untilDate=!0):(!n&&(n=new Date),s.calendarState.until=n,s.calendarState.untilDate=!1),i.isUserContact(s)?(a.info('[calendarService] updateCalendarPresenceForUser for my user : '+r+' until '+n),!u.serviceActivated&&'offline'!==r&&(u.serviceActivated=!0,t.$broadcast('ON_CALENDAR_STATUS_CHANGE',u.serviceActivated)),u.getAutoReplyInfoForContact(i.userContact)):a.info('[calendarService] updateCalendarPresenceForUser for user : '+e+' with : '+r+' until '+n),t.$broadcast('ON_CONTACT_CALENDAR_STATUS_CHANGE',s)}).catch(function(t){a.error('[calendarService] updateCalendarPresenceForUser failure for user '+e+' with error : '+t)})},this.treatOutOfOfficeState=function(e,r){if(a.info('[calendarService] treatOutOfOfficeState for user : '+r.jid+' with data enabled '+e.enabled+' and text '+e.message_text+' and date end '+e.end),e.enabled){if(r.calendarState.autoReplyOn=!0,r.calendarState.autoReplyInfos={},e.message_text&&(r.calendarState.autoReplyInfos.message=e.message_text),e.end){var n=moment(e.end);r.calendarState.autoReplyInfos.mdate=n,n?n.isSame(moment(),'d')?(r.calendarState.autoReplyInfos.until=n.format('LT'),r.calendarState.autoReplyInfos.untilDate=!1):(r.calendarState.autoReplyInfos.until=n.format('ll'),r.calendarState.autoReplyInfos.untilDate=!0):(r.calendarState.autoReplyInfos.until=e.end,r.calendarState.autoReplyInfos.untilDate=!0)}t.$broadcast('ON_CALENDAR_STATUS_CHANGE',u.serviceActivated)}else r.calendarState.autoReplyOn=!1,r.calendarState.autoReplyInfos={};t.$broadcast('ON_CONTACT_CALENDAR_STATUS_CHANGE',r)},this.calendarCancelCallback=function(){u.serviceActivated=!1,p.setSetting('disableCalendarPresence',!0),i.setUserSettings({promptForCalendarPresence:!1}),t.$broadcast('ON_CALENDAR_STATUS_CHANGE',!1)},this.calendarLaterCallback=function(){u.serviceActivated=!1,t.$broadcast('ON_CALENDAR_STATUS_CHANGE',!1)},this.setCalendarRejectIfBusy=function(){u.calendaRejectIfBusyActivated=!1},this.getCalendarRejectIfBusy=function(){return u.calendaRejectIfBusyActivated}}])},function(e,t){'use strict';Object.defineProperty(t,'__esModule',{value:!0});class a{constructor(e,t,a,r,n,o,i,s,d){this.$q=e,this.$log=t,this.roomService=a,this.contactService=r,this.pstnConferenceService=n,this.conferenceService=o,this.orderByFilter=i,this.$rootScope=s,this.webConferenceService=d,this.started=!1,this.meetings=[],this.room=null,this.listeners=[]}start(e){return this.$q((t)=>{let a=performance.now();this.$log.info('[MeetingService] === STARTING ==='),this.updateMeetingLists(),this.started=!0;var r=Math.round(performance.now()-a);e.push({service:'MeetingService',startDuration:r}),this.$log.info('[MeetingService] === STARTED ('+r+' ms) ==='),t()})}stop(){return this.$log.info('[MeetingService] === STOPPING ==='),this.meetings=[],this.started&&(this.started=!1),this.listeners&&this.listeners.forEach((e)=>{e()}),this.$log.info('[MeetingService] === STOPPED ==='),this.$q.when()}stopActiveConferenceSession(e){return this.$q((t)=>{let a=this.pstnConferenceService.getConferenceSessionById(e);a&&a.isActive()?this.conferenceService.stopConference(e,'pstnAudio').finally(()=>{t()}).catch(()=>{this.$log.error('[MeetingService] stopActiveConferenceSession -- Could not stop conference with id: '+e),t()}):t()})}notifyUsersCancelConference(e,t=!1){return this.$q((a)=>{let r=e.getPstnConfEndpointId(),n=e.users.map((e)=>e.contact),o=e.guestEmails;r&&(0<n.length||0<o.length)?this.roomService.notifyUsersCancelConference(e,n,o,t).finally(()=>{a()}).catch(()=>{this.$log.error('[MeetingService] notifyUsersCancelConference -- Could not notify conference participants of cnacellation of conference with id: '+r)}):a()})}getStartDate(e){return e.conference&&e.conference.scheduled?moment(e.conference.scheduledStartDate):moment(e.creationDate)}sortByDate(e,t){var a=1;return e&&t&&(a=t.value-e.value),a}updateMeetingLists(){this.meetings=[],this.meetings=this.orderByFilter(this.roomService.getRooms().filter((e)=>e.isMeetingRoom()&&e.status!==this.roomService.RoomUserStatus.REJECTED&&e.status!==this.roomService.RoomUserStatus.DELETED),this.getStartDate,!0,this.sortByDate)}getMeetings(){return this.meetings}getAvailableMeetings(){let e=this.meetings.filter((e)=>{let t=e.conference.scheduledEndDate&&moment().isAfter(e.conference.scheduledEndDate),a=!e.getPstnConfEndpointId();return'invited'!==e.status&&e.conference.scheduled&&!t&&!a});return this.meetings.forEach((t)=>{t.conference.scheduled||'invited'===t.status||'unsubscribed'===t.status||'none'===t.status||t.owner||e.push(t)}),e}getPastMeetings(){let e=this.meetings.filter((e)=>{let t=e.conference.scheduledEndDate&&moment().isAfter(e.conference.scheduledEndDate),a=!e.getPstnConfEndpointId();return e.conference.scheduled&&(t||a)});return this.meetings.forEach((t)=>{t.conference.scheduled||'unsubscribed'!==t.status&&'none'!==t.status?!t.conference.scheduled&&!t.getPstnConfEndpointId()&&e.push(t):e.push(t)}),this.orderByFilter(e,this.getStartDate,!1,this.sortByDate)}getMeetingInvitations(){return this.meetings.filter((e)=>'invited'===e.status)}getActiveInstantMeeting(){let e=null;return this.updateMeetingLists(),this.meetings.some((t)=>{let a=t.getPstnConfEndpointId();if(t.conference&&!t.conference.scheduled&&a){let r=this.pstnConferenceService.getConferenceSessionById(a);if(r&&r.isActive())return e=t,!0}return!1}),e}retrieveMeetingInformation(e,t=!1){return this.$q((a)=>{let r={name:e.name,topic:e.desc,creationDate:e.creationDate,users:e.users,guestEmails:e.guestEmails},n=e.getPstnConfEndpointId();n?this.conferenceService.retrieveConference(n).finally(()=>{let o=this.pstnConferenceService.pstnConferenceEndpoints[n]?this.pstnConferenceService.pstnConferenceEndpoints[n]:e.conference;o&&(r.id=n,r.scheduled=o.scheduled,r.scheduledStartDate=o.scheduledStartDate,r.scheduledEndDate=o.scheduledEndDate,r.scheduledDuration=o.scheduledDuration,r.scheduledTimezone=o.scheduledTimezone,r.lastUpdateDate=o.lastUpdateDate,r.passCodes=o.passCodes?o.passCodes:[]),this.conferenceService.retrievePstnPhoneNumbers(t).then((e)=>{r.phoneNumbers=e,a(r)})}).catch(()=>{this.$log.error('[MeetingService] retrieveMeetingInformation -- Could not retrieve conference information of conference with id: '+n)}):a(r)})}findAndDetachConferenceFromRooms(e){return this.$q((t)=>{let a=this.roomService.findRoomsWithConfId(e);0<a.length?this.stopActiveConferenceSession(e).then(()=>this.roomService.removeConfIdInAllRooms(a)).finally(()=>{t()}).catch(()=>{this.$log.error('[MeetingService] findAndDetachConferenceFromRooms -- An error occured when detaching conference  '+e)}):t()})}createScheduledMeeting(e,t,a,r,n,o,i,s=!1,d=null){return this.$q((c,l)=>{let p=this.conferenceService.getPstnConferenceUser(),u=null,m=null;return p?(this.$log.debug('[MeetingService] createScheduledMeeting - Creating room'),this.roomService.createRoom(e,t,!0,d).then((t)=>(this.$log.debug('[MeetingService] createScheduledMeeting - Room created'),u=t,this.$log.debug('[MeetingService] createScheduledMeeting - Creating conference'),this.conferenceService.createConference(p.id,e,n,o,i))).then((e)=>(this.$log.debug('[MeetingService] createScheduledMeeting - Conference created'),m=e,this.$log.debug('[MeetingService] createScheduledMeeting - Associating conference to room'),this.roomService.addRoomConferenceEndPoint(u,m))).then((e)=>(u=e,this.$log.debug('[MeetingService] createScheduledMeeting - Conference associated to room'),u.conference={guestEmails:[],mediaType:'pstnAudio',scheduled:!0,scheduledEndDate:o,scheduledStartDate:n,scheduledTimezone:i},this.$log.debug('[MeetingService] createScheduledMeeting - Adding users to room'),this.roomService.addRoomUsers(u,a))).then((e)=>{this.$log.debug('[MeetingService] Users added to room'),a.push(this.contactService.userContact),this.$log.debug('[MeetingService] createScheduledMeeting - Notifying confernece participants'),this.roomService.notifyRoomUsersJoinConference(u,a,r,s,!1).then(()=>{this.$log.debug('[MeetingService] createScheduledMeeting - Participants successfully notified')}).catch(()=>{this.$log.error('[MeetingService] createScheduledMeeting - error when sending conference invitation')}),c(e)}).catch((e)=>{let t=e.message?e.message:'Unknown error';e&&e.data&&403620===e.data.errorDetailsCode&&(t='meetingMaxLimitReached'),this.$log.error('[MeetingService] createScheduledMeeting - '+t),u&&this.roomService.deleteRoomUsers(u,a).finally(()=>{this.roomService.ownerDeleteRoom(u)}),m&&this.conferenceService.deleteConference(m.id),l(new Error(t))})):void(this.$log.error('[MeetingService] createScheduledMeeting - No conference user associated to user'),l())})}createScheduledMeetingWithConference(e,t,a,r,n,o,i,s,d=!1,c=null){return this.$q((l,p)=>{let u=null,m=null;return this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Creating room'),this.roomService.createRoom(t,a,!0,c).then((a)=>(this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Room created'),u=a,this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Updating conference'),this.conferenceService.updateConference(e.id,{name:t,startDate:o,endDate:i,timeZone:s}))).then((e)=>(this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Conference updated'),m=e,this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Associating conference to room'),this.roomService.addRoomConferenceEndPoint(u,m))).then((e)=>(u=e,this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Conference associated to room'),u.conference={guestEmails:[],mediaType:'pstnAudio',scheduled:!0,scheduledEndDate:i,scheduledStartDate:o,scheduledTimezone:s},this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Adding users to room'),this.roomService.addRoomUsers(u,r))).then((e)=>{this.$log.debug('[MeetingService] Users added to room'),r.push(this.contactService.userContact),this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Notifying confernece participants'),this.roomService.notifyRoomUsersJoinConference(u,r,n,d,!1).then(()=>{this.$log.debug('[MeetingService] createScheduledMeetingWithConference - Participants successfully notified')}).catch(()=>{this.$log.error('[MeetingService] createScheduledMeetingWithConference - error when sending conference invitation')}),l(e)}).catch((e)=>{let t=e.message?e.message:'Unknown error';e&&e.data&&403620===e.data.errorDetailsCode&&(t='meetingMaxLimitReached'),this.$log.error('[MeetingService] createScheduledMeetingWithConference - '+t),u&&this.roomService.deleteRoomUsers(u,r).finally(()=>{this.roomService.ownerDeleteRoom(u)}),p(new Error(t))})})}updateScheduledMeeting(e,t,a,r,n,o,i,s,d,c,l=!1,p=null){return this.$q((u,m)=>{if(e!==void 0&&null!==e){let g=[];this.$log.debug('[MeetingService] updateScheduledMeeting - Update conference object'),g.push(this.conferenceService.updateConference(e.getPstnConfEndpointId(),{name:t,startDate:s,endDate:d,timeZone:c}).finally(()=>(this.$log.debug('[MeetingService] updateScheduledMeeting - Update meeting name and description'),e.name=t,e.desc=a,this.roomService.ownerUpdateRoomNameAndDescription(e)))),o&&0<o.length&&(this.$log.debug('[MeetingService] updateScheduledMeeting - Deleting removed users from meeting'),g.push(this.roomService.deleteRoomUsers(e,o))),this.$log.debug('[MeetingService] updateScheduledMeeting - Adding new users to meeting'),r&&0<r.length&&g.push(this.roomService.addRoomUsers(e,r)),p&&(this.$log.debug('[MeetingService] updateScheduledMeeting - Setting avatar of meeting'),g.push(this.roomService.setAvatarRoom({id:e.dbId},p))),this.$q.all(g).finally(()=>{(o&&o.length||i&&i.length)&&(this.$log.debug('[MeetingService] updateScheduledMeeting - Notifying participants removed of cancellation'),this.roomService.notifyUsersCancelConference(e,o,i,l)),this.$log.debug('[MeetingService] updateScheduledMeeting - Notifying participants of update'),r.push(this.contactService.userContact),this.roomService.notifyRoomUsersJoinConference(e,r,n,l,!0),this.updateMeetingLists(),u(this.roomService.getRoomById(e.dbId))}).catch((e)=>{let t=e&&e.message?e.message:'Unknown error';this.$log.error('[MeetingService] updateScheduledMeeting - '+t),m()})}else this.$log.error('[MeetingService] updateScheduledMeeting - no meeting to update'),m()})}reScheduleMeeting(e,t,a,r,n,o,i,s,d=!1,c){let l=this.conferenceService.getPstnConferenceUser(),p=null;return l?this.$q((t)=>{let a=e.getPstnConfEndpointId();a?(this.$log.debug('[MeetingService] reScheduleMeeting - stopping active session '+a),this.stopActiveConferenceSession(a).then(()=>{this.$log.debug('[MeetingService] reScheduleMeeting - disassociating conference from room '+a),t(this.roomService.deleteRoomConferenceEndPoint(e,a))})):t()}).then(()=>(this.$log.debug('[MeetingService] reScheduleMeeting - Creating conference'),this.conferenceService.createConference(l.id,e.name,o,i,s))).then((t)=>(this.$log.debug('[MeetingService] reScheduleMeeting - Conference created'),p=t,this.$log.debug('[MeetingService] reScheduleMeeting - Associating conference to room'),this.roomService.addRoomConferenceEndPoint(e,p))).then(()=>(this.$log.debug('[MeetingService] reScheduleMeeting - Conference associated to room'),this.$log.debug('[MeetingService] reScheduleMeeting - Removing contacts from room'),this.roomService.deleteRoomUsers(e,r))).finally(()=>(this.$log.debug('[MeetingService] reScheduleMeeting - Users deleted from room'),this.$log.debug('[MeetingService] reScheduleMeeting - Setting avatar'),this.roomService.setAvatarRoom({id:e.dbId},c))).finally(()=>(this.$log.debug('[MeetingService] reScheduleMeeting - Avatar set to room'),this.$log.debug('[MeetingService] reScheduleMeeting - Adding users to room'),this.roomService.addRoomUsers(e,t))).finally(()=>(this.$log.debug('[MeetingService] reScheduleMeeting - Users added to room'),this.$log.debug('[MeetingService] reScheduleMeeting - Notifying participants of conference'),t.push(this.contactService.userContact),this.roomService.notifyRoomUsersJoinConference(e,t,a,d,!1))).then((e)=>this.roomService.getRoomById(e.dbId)).catch((e)=>{let t=e.message?e.message:'Unknown error';return this.$log.error('[MeetingService] reScheduleMeeting - '+t),p&&this.conferenceService.deleteConference(p.id),this.$q.reject()}):(this.$log.error('[MeetingService] reScheduleMeeting - No conference user associated to user'),this.$q.reject())}deleteMeeting(e,t=!1){return e.conference.scheduled?this.deleteScheduledMeeting(e,t):this.roomService.ownerDeleteRoom(e)}endMeeting(e,t=!1){if(e.conference.scheduled)return this.endScheduledMeeting(e,t);else{let t=e.getSFUSharingConfEndpointId(),a=this.webConferenceService.getConferenceSessionById(t);return a&&a.isActive()&&this.webConferenceService.stopWebConference(e),this.conferenceService.stopConference(this.conferenceService.getPstnInstantConferenceEndpointId())}}endScheduledMeeting(e,t=!1){let a=e.getSFUSharingConfEndpointId(),r=this.webConferenceService.getConferenceSessionById(a);r&&r.isActive()&&this.webConferenceService.stopWebConference(e);let n=e.getPstnConfEndpointId();if(n){let a=moment(e.conference.scheduledStartDate);return moment().isBefore(a)&&this.notifyUsersCancelConference(e,t),this.stopActiveConferenceSession(n).then(()=>this.roomService.deleteRoomConferenceEndPoint(e,n))}else{new Error('[MeetingService] unable to end scheduled meeting: no confEndpoints found');return this.$q.reject()}}deleteScheduledMeeting(e,t=!1){return this.endScheduledMeeting(e,t).finally(()=>this.roomService.ownerArchiveRoom(e)).finally(()=>this.roomService.ownerDeleteRoom(e).then(()=>{this.updateMeetingLists(),this.$rootScope.$broadcast('MEETING_DELETE_EVENT',e)})).catch((e)=>{let t=e.message?e.message:'Unknown error';return this.$log.error('[MeetingService] deleteScheduledMeeting - '+t),this.$q.reject()})}attendeeExitsMeeting(e){if(e.owner)return this.$q.reject();let t=[],a=e.getPstnConfEndpointId();if(a){let e=this.pstnConferenceService.getConferenceSessionById(a);if(e){let r=e.getConnectedParticipantByJid(this.contactService.userContact.jid);r&&t.push(this.conferenceService.disconnectsParticipant(a,r.participantId,'pstnAudio'))}}return t.push(this.roomService.participantCloseRoom(e)),this.$q.all(t)}acceptMeetingInvitation(e){return this.roomService.acceptRoomInvitation(e).then(()=>(this.conferenceService.makeSnapshotForConfId(e.getPstnConfEndpointId(),'pstnAudio'),this.roomService.getServerRoom(e.dbId)))}declineMeetingInvitation(e){return this.roomService.declineRoomInvitation(e)}startMeeting(e){let t=e.getPstnConfEndpointId();if(t)return this.pstnConferenceService.initiatesAudio(t);else{let e=new Error('[MeetingService] No confEndpoint associated to meeting');return this.$log.error(e.message),this.$q.reject()}}updateMeetingName(e,t){let a=e.getPstnConfEndpointId();return this.conferenceService.updateConference(a,{name:t}).finally(()=>(e.name=t,this.roomService.ownerUpdateRoomNameAndDescription(e)))}}a.$inject=['$q','$log','roomService','contactService','pstnConferenceService','conferenceService','orderByFilter','$rootScope','webConferenceService'],angular.module('rainbow').service('meetingService',a)},function(){class e{constructor(e,t,a,r,n,o,i){this.$q=e,this.$rootScope=t,this.$log=a,this.fileServerService=r,this.fileStorageService=n,this.xmppService=o,this.$interval=i,this.started=!1,this.recording=!1,this.upload=!1,this.filename='',this.recordStopOrigin='LOCAL'}start(){return this.started=!1,this.recording=!1,this.recorder=null,this.data=[],this.audioContext=null,this.recordBuffer=null,this.recordFile=null,this.initConversationRecordContext(),this.$log.info('[RecordsService] start'),this.$q.when()}stop(){return this.$log.info('[RecordsService stop'),this.started&&(this.started=!1),this.$q.when()}onDataAvailable(e){this.$log.info('[RecordService] >onDataAvailable: size = '+e.data.size),0<e.data.size&&this.data.push(e.data)}onStop(){this.recordBuffer=new Blob(this.data,{type:'video/mp4'}),this.recordFile={name:this.filename,extension:'mp4',size:this.recordBuffer.size},this.data=[],this.recording=!1,this.recorder=null,this.$rootScope.$broadcast('ON_OPEN_RECORDINGFILESTORAGE_POPUP',this.recordFile,this.recordStopOrigin),this.$rootScope.$broadcast('ON_WEBRTC_RECORD_SAVED',this.recordFile,this.recordBuffer,this.recordStopOrigin),this.recordStopOrigin='LOCAL'}closeAudioContext(){this.audioContext&&(this.audioContext.destination&&this.audioContext.destination.disconnect(),'closed'!==this.audioContext.state&&(this.audioContext.close(),this.audioContext=null))}cleanRecord(){!1===this.recording?(this.recordBuffer=null,this.recordFile=null):this.$log.error('[RecordsService] Unexpected record cleaning while recording not stopped')}onError(e){this.$log.error('[RecordService] error : '+e.message||!1),this.recording=!1,this.stopConvTimer(),this.$rootScope.$broadcast('ON_WEBRTC_RECORD_ERROR')}createRecord(e,t='REMOTE',a=!1,r='',n=!1,o){let s=null,d=null,c=null,l=null,p=[];this.recorder=null,this.upload=a,this.filename=r;let i=!1,u=null,m=null,g=null,v=null;if(o&&MediaRecorder.isTypeSupported(o)?s={mimeType:o}:n?MediaRecorder.isTypeSupported('audio/webm')&&(s={mimeType:'audio/webm'}):MediaRecorder.isTypeSupported('video/webm;codecs=vp9')?s={mimeType:'video/webm; codecs=vp9'}:MediaRecorder.isTypeSupported('video/webm;codecs=vp8')?s={mimeType:'video/webm; codecs=vp8'}:MediaRecorder.isTypeSupported('video/webm;codecs=h264')?s={mimeType:'video/webm; codecs=h264'}:MediaRecorder.isTypeSupported('video/mpeg')&&(s={mimeType:'video/mpeg'}),null==s)return this.$log.error('[RecordsService] Codecs : '+o+' are not available for the navigator'),!1;if(this.$log.info('[RecordsService] createRecord -- mimeType used '+s.mimeType),d=this.xmppService.connection.jingle.sessions[e].localStreams,c=this.xmppService.connection.jingle.sessions[e].remoteStreams,i=d&&d.length&&null!==d[0]||c&&c.length&&null!==c[0],null===this.recorder&&i){let e=null,a;for(a=0;a<c.length;a++)c[a]&&null!=c[a]&&(e=a,c[a].getAudioTracks().forEach((t)=>{p.push(t),v=a,e=null}),null!=e&&(g=e));for(e=null,a=0;a<d.length;a++)d[a]&&null!=d[a]&&(e=a,d[a].getAudioTracks().forEach((t)=>{p.push(t),m=a,e=null}),null!==e&&(u=e));if(this.audioContext&&(this.$log.error('[RecordsService] anomaly audio Context not previously released'),this.closeAudioContext()),p.length){this.audioContext=new AudioContext;let e=p.map((e)=>this.audioContext.createMediaStreamSource(new MediaStream([e]))),t=this.audioContext.createMediaStreamDestination();e.forEach((e)=>e.connect(t)),l=new MediaStream(t.stream)}else l=new MediaStream;if(!n)if('LOCAL'===t&&null!==u){var f=d[u].getVideoTracks();f.forEach((e)=>{l.addTrack(e)})}else null===g?c[v].getVideoTracks().forEach((e)=>{l.addTrack(e)}):c[g].getVideoTracks().forEach((e)=>{l.addTrack(e)});this.recorder=new MediaRecorder(l,s),this.recorder.ondataavailable=this.onDataAvailable.bind(this),this.recorder.onstop=this.onStop.bind(this),this.recorder.onerror=this.onError.bind(this)}else return this.$log.error('[RecordsService] Cannot get Stream'),!1;return!0}uploadFile(){return this.$q((e,t)=>{let a=this.recordBuffer,r=this.recordFile,n='';!1!==this.recording&&(this.$log.error('[RecordsService] Unexpected uploading file when recording not stopped'),n='recording not stopped pb',t(n)),0===r.size&&(this.$log.error('[RecordsService] error uploading empty file'),n='empty file pb',t(n)),this.fileStorageService.createFileDescriptor(r.name,r.extension,r.size).then((r)=>{var o;this.fileServerService.uploadAFileByChunk(r,a,o,()=>{}).then(()=>{this.$log.info('[RecordsService] uploadFile success'),this.cleanRecord(),e()}).catch((e)=>{this.$log.error('[RecordsService] Unexpected error while uploading file',e),n='server pb',t(n)})}).catch((e)=>{this.$log.error('[RecordsService] Unexpected error while creating file descriptor!',e),n='file descriptor pb',t(n)})})}setRecordStopOrigin(e){e&&''!==e&&(this.recordStopOrigin=e)}localSaveFile(){let e=this.recordBuffer,t=this.recordFile;return!1===this.recording?void(this.downloadFile(e,null,null,t.name,!0),this.cleanRecord()):void this.$log.error('[RecordsService] Unexpected file local storage when recording not stopped')}downloadFile(){this.$log.info('[RecordsService] downloadFile -- default function')}startRecording(e){null!==this.recorder&&(e?this.recorder.start(e):this.recorder.start(),this.recording=!0,this.startConvTimer())}stopRecording(){null!==this.recorder&&(this.recorder.stop(),this.recording=!1,this.closeAudioContext()),this.stopConvTimer(),this.initConversationRecordContext()}pauseResumeRecording(){null!==this.recorder&&('recording'===this.recorder.state?(this.recorder.pause(),this.conversationRecordContext.pause=!0,this.stopConvTimer()):(this.recorder.resume(),this.conversationRecordContext.pause=!1,this.startConvTimer()))}setOnDataAvailableCallback(e){null!==this.recorder&&(this.recorder.ondataavailable=e)}setOnErrorCallback(e){null!==this.recorder&&(this.recorder.onerror=e)}setOnPauseCallback(e){null!==this.recorder&&(this.recorder.onpause=e)}setOnResumeCallback(e){null!==this.recorder&&(this.recorder.onresume=e)}setOnStartCallback(e){null!==this.recorder&&(this.recorder.onstart=e)}setOnStopCallback(e){null!==this.recorder&&(this.recorder.onstop=e)}initConversationRecordContext(){this.conversationRecordContext={conversationId:'',recorder:!1,pause:!1,actualRecordTime:0,updateTimer:null,recordStopSource:'LOCAL'}}getConversationRecordContext(e){return e===this.conversationRecordContext.conversationId?this.conversationRecordContext:null}setConversationRecordContext(e,t,a,r,n){e&&''!==e&&(this.conversationRecordContext.conversationId=e,this.conversationRecordContext.recorder=t&&this.recording,this.conversationRecordContext.pause=a,this.conversationRecordContext.actualRecordTime=r,this.conversationRecordContext.recordStopSource=n)}startConvTimer(){this.conversationRecordContext.updateTimer=this.$interval(()=>{this.conversationRecordContext.actualRecordTime++},1e3)}stopConvTimer(){null!==this.conversationRecordContext.updateTimer&&(this.$interval.cancel(this.conversationRecordContext.updateTimer),this.conversationRecordContext.updateTimer=null)}}e.$inject=['$q','$rootScope','$log','fileServerService','fileStorageService','xmppService','$interval'],angular.module('rainbow').service('recordsService',e)},function(){(function(){'use strict';angular.module('rainbow').service('phonebookService',['$q','$rootScope','$log','$http','contactService','authService','orderByFilter','profileService','conversationService',function(e,t,a,r,n,o,i,s){this.search=function(d){return a.info('[phonebookService] search PBXContact from phonebook with text '+d),e(function(e,c){if(!config.permitSearchFromPhoneBook&&!s.isFeatureEnabled(s.FeaturesEnum.TELEPHONY_PHONE_BOOK)){a.info('[phonebookService] search from phonebook not allowed for the user profile');return void e([])}var l=config.restServerUrl+'/api/rainbow/search/v1.0/phonebooks?limit=20&name='+encodeURIComponent(d);r({method:'GET',url:l,headers:o.getRequestHeader()}).then(function(t){var r=t.data.phoneBooks;a.info('[phonebookService] search find '+r.length+' phonebooks contact(s)');var o=[];r.forEach(function(e){var t=n.createBasicContact(null,e.number);t.updateName(e.firstName,e.lastName),t.getAvatar(),o.push(t)}),o=i(o,'_displayName',!1),e(o)},function(e){e.data&&(401===e.data.errorCode&&t.$broadcast('ON_SESSION_EXPIRED_NOTIFICATION_EVENT'),a.warn('[phonebookService] search failure '+e.data.errorMsg)),c(new Error('phonebook service failure'))})})}}])})()},function(){angular.module('rainbow').service('adminCompanyService',['$q','$log','$http','$rootScope','authService','errorHelperService','Company','contactService','settingsService','Site','CompanyInvitation','pushImageHelperService','CompanyRequest','companyService',function(e,t,a,r,n,o,i,s,d,c,l,p,u,m){'use strict';var g=this;g.start=function(){return t.info('[adminCompanyService] === STARTING ==='),g.portalURL=config.restServerUrl+'/api/rainbow/admin/v1.0/',t.info('[adminCompanyService] === STARTED ==='),e.when()},g.stop=function(){return t.info('[adminCompanyService] === STOPPING ==='),t.info('[adminCompanyService] === STOPPED ==='),e.when()},g.getCompanies=function(r,d,c,l,p,u,v,f,S,C,h,E){var R=e.defer(),b=s.userContact;if(!b.isSuperadmin()&&!b.isBPAdmin()&&!b.isOrganizationAdmin())return g.getCompany(b.company.id).then(function(e){return{companies:[e]}});var y=g.portalURL+'companies?format='+(p?p:'full');return r&&(y+='&organisationId='+r),d&&c&&(y+='&offset='+c*(d-1)),c&&(y+='&limit='+c),l&&(y+='&name='+l),u&&(y+='&bpId='+u),v&&(Array.isArray(v)?v.forEach(function(e){y+='&status='+e}):y+='&status='+v),void 0!==f&&null!==f&&(y+='&isBP='+f),S&&(y+='&bpType='+S),C&&(y+='&offerCanBeSold='+C),h&&(y+='&externalReference='+h),a({method:'GET',url:y,headers:n.getRequestHeader()}).then(function(e){var a=e.data.data;t.info('[adminCompanyService] getCompanies success');var r=[];a.forEach(function(e){var t=i.createFromData(e);(angular.isUndefined(E)||!E)&&m.getCompanyLogo(t),r.push(t)}),R.resolve({companies:r,limit:e.data.limit,offset:e.data.offset,total:e.data.total})},function(e){var a=o.handleError(e);R.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getCompanies'))}),R.promise},g.getAllCompaniesSmall=function(e,t,a,r,n){return g.getAllCompanies(e,t,a,r,n,'small')},g.getAllCompanies=function(t,a,r,n,o,i){var s=1e3;return e(function(d,c){g.getCompanies(t,1,s,null,i,a,r,n,o).then(function(a){if(a.total>a.limit){for(var r=[],n=Math.ceil(a.total/s),o=2;o<=n;o++)r.push(g.getCompanies(t,o,s,null,'small').then(function(e){a.companies=a.companies.concat(e.companies),a.limit+=e.limit}));e.all(r).then(function(){d(a)})}else d(a)}).catch(function(e){c(e)})})},g.getCompany=function(r){return e(function(e,s){a({method:'GET',url:g.portalURL+'companies/'+r,headers:n.getRequestHeader()}).then(function(a){t.info('[adminCompanyService] getCompany success');var r=a.data.data,n=i.createFromData(r);m.getCompanyLogo(n),m.getCompanyBanner(n),e(n)},function(e){var a=o.handleError(e);s(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getCompany'))})})},g.getDefaultCompany=function(){return e(function(e,r){a({method:'GET',url:g.portalURL+'companies/default',headers:n.getRequestHeader()}).then(function(a){t.info('[adminCompanyService] getDefaultCompany success');var r=a.data.data,n=i.createFromData(r);e(n)},function(e){var a=o.handleError(e);r(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getDefaultCompany'))})})},g.searchCompanies=function(t){var a=e.defer(),r=t.toLowerCase();return g.getCompanies().then(function(e){var t=e.companies.filter(function(e){return-1<e.name.toLowerCase().indexOf(r)});a.resolve(t)}),a.promise},g.createCompany=function(d){var c=i.prune(d,s.userContact),l=e.defer();return a({method:'POST',url:g.portalURL+'companies',headers:n.getRequestHeader(),data:c}).then(function(e){t.info('[adminCompanyService] createCompany success');var a=i.createFromData(e.data.data);r.$broadcast('ADMIN_COMPANIES_CHANGE'),l.resolve(a)},function(e){var a=o.handleError(e);l.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'createCompany'))}),l.promise},g.createCompanyEndUser=function(r){var d=i.prune(r,s.userContact),c=e.defer();return a({method:'POST',url:config.restServerUrl+'/api/rainbow/enduser/v1.0/companies',headers:n.getRequestHeader(),data:d}).then(function(e){t.info('[adminCompanyService] createCompany success');var a=e.data.data,r=i.createFromData(a);c.resolve(r)},function(e){var a=o.handleError(e);c.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'createCompanyEndUser'))}),c.promise},g.updateCompany=function(d){var c=i.prune(d,s.userContact),l=e.defer();return a({method:'PUT',url:g.portalURL+'companies/'+d.id,headers:n.getRequestHeader(),data:c}).then(function(e){t.info('[adminCompanyService] updateCompany success');var a=e.data.data,n=i.createFromData(a);l.resolve(n),r.$broadcast('ON_COMPANY_CHANGE_EVENT',d.id)},function(e){var a=o.handleError(e);l.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'updateCompany'))}),l.promise},g.addVisibility=function(r,i){var s=e.defer();return a({method:'POST',url:g.portalURL+'companies/'+r+'/visible-by/'+i,headers:n.getRequestHeader()}).then(function(){t.info('[adminCompanyService] addVisibility success'),s.resolve()},function(e){var a=o.handleError(e);s.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'addVisibility'))}),s.promise},g.removeVisibility=function(r,i){var s=e.defer();return a({method:'DELETE',url:g.portalURL+'companies/'+r+'/visible-by/'+i,headers:n.getRequestHeader()}).then(function(){t.info('[adminCompanyService] removeVisibility success'),s.resolve()},function(e){var a=o.handleError(e);s.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'removeVisibility'))}),s.promise},g.getAllSiteCompany=function(r){var i=e.defer();return a({method:'GET',url:g.portalURL+'companies/'+r+'/sites',headers:n.getRequestHeader()}).then(function(e){t.info('[adminCompanyService] getAllSiteCompany success');var a=e.data.data,r=[];a.forEach(function(e){var t=c.createFromData(e);r.push(t)}),i.resolve(r)},function(e){var a=o.handleError(e);i.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getAllSiteCompany'))}),i.promise},g.getCompanyAdministrators=function(r){return e(function(e,i){a({method:'GET',url:g.portalURL+'companies/'+r+'/administrators',headers:n.getRequestHeader()}).then(function(a){t.info('[adminCompanyService] getCompanyAdministrators success');var r=a.data.data,n=[];r.forEach(function(e){var t={id:e.id};n.push(t)}),e(n)},function(e){var a=o.handleError(e);i(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getCompanyAdministrators'))})})},g.deleteCompany=function(r){var i=e.defer();return a({method:'DELETE',url:g.portalURL+'companies/'+r,headers:n.getRequestHeader()}).then(function(){t.info('[adminCompanyService] deleteCompany success'),i.resolve()},function(e){var a=o.handleError(e);i.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'deleteCompany'))}),i.promise},g.pushLogo=function(a,n,o){return e(function(i,s){var d=g.portalURL+'companies/'+a+'/avatar';(angular.isDefined(n)&&null!==n?p.pushImage(d,n):e.resolve()).then(function(){return g.getCompany(a)}).then(function(e){return e.avatarShape=o,g.updateCompany(e)}).then(function(){r.$broadcast('ON_COMPANY_CHANGE_EVENT',a),t.info('[adminCompanyService] pushLogo success'),i()}).catch(function(e){s(e)})})},g.deleteLogo=function(i){return e(function(e,s){a({method:'DELETE',url:g.portalURL+'companies/'+i+'/avatar',headers:n.getRequestHeader()}).then(function(){r.$broadcast('ON_COMPANY_CHANGE_EVENT',i),g.getCompany(i).then(function(e){return e.avatarShape='circle',g.updateCompany(e)}).then(function(){t.info('[adminCompanyService] deleteLogo success'),e()}).catch(function(e){s(e)})},function(e){var a=o.handleError(e);s(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'deleteLogo'))})})},g.pushBanner=function(t,a,n){return e(function(e,o){var i=g.portalURL+'companies/'+t+'/banner';return p.pushImage(i,a,n).then(function(){r.$broadcast('ON_COMPANY_CHANGE_EVENT',t),e()}).catch(function(e){o(e)})})},g.deleteBanner=function(i){return e(function(e,s){a({method:'DELETE',url:g.portalURL+'companies/'+i+'/banner',headers:n.getRequestHeader()}).then(function(){r.$broadcast('ON_COMPANY_CHANGE_EVENT',i),t.info('[adminCompanyService] deleteBanner success'),e()},function(e){var a=o.handleError(e);s(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'deleteBanner'))})})},g.getCompanyInvitations=function(r,i,s){return e(function(e,d){var c=g.portalURL+'companies/'+r+'/join-companies/invitations?format=medium&status=pending declined&limit='+s;i&&(c+='&offset='+s*(i-1)),a({method:'GET',url:c,headers:n.getRequestHeader()}).then(function(a){var r=[];a.data.data.forEach(function(e){var t=l.createFromData(e);r.push(t)}),t.info('[adminCompanyService] getCompanyInvitations success (found '+r.length+' invitation(s))'),e({invitations:r,total:a.data.total})},function(e){var a=o.handleError(e);d(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getCompanyInvitations'))})})},g.joinCompanyInvitation=function(r,i,s,c,l,p){var u=e.defer(),m=d.getAppliLanguageCodeForServer(),v={lang:m};return c&&(v.customMessage=c),s?v.invitedUserId=s:i&&(v.email=i),l&&(v.invitedToBeCompanyAdmin=l),p&&(v.invitedToBeBpAdmin=p),a({method:'POST',url:g.portalURL+'companies/'+r+'/join-companies/invitations',headers:n.getRequestHeader(),data:v}).then(function(){t.info('[adminCompanyService] joinCompanyInvitation success'),u.resolve()},function(e){var a=o.handleError(e);u.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'joinCompanyInvitation'))}),u.promise},g.cancelJoinCompanyInvitation=function(r,i){var s=e.defer();return a({method:'POST',url:g.portalURL+'companies/'+r+'/join-companies/invitations/'+i+'/cancel',headers:n.getRequestHeader()}).then(function(e){var a=l.createFromData(e.data.data);t.info('[adminCompanyService] cancelJoinCompanyInvitation success'),s.resolve(a)},function(e){var a=o.handleError(e);s.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'cancelJoinCompanyInvitation'))}),s.promise},g.resendJoinCompanyInvitation=function(r,i){var s=e.defer();return a({method:'POST',url:g.portalURL+'companies/'+r+'/join-companies/invitations/'+i+'/re-send',headers:n.getRequestHeader()}).then(function(e){var a=l.createFromData(e.data.data);t.info('[adminCompanyService] resendJoinCompanyInvitation success'),s.resolve(a)},function(e){var a=o.handleError(e);s.reject(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'resendJoinCompanyInvitation'))}),s.promise},g.getCompanyJoinRequests=function(r){return e(function(e,i){a({method:'GET',url:g.portalURL+'companies/'+r+'/join-companies/requests?format=medium&status=pending',headers:n.getRequestHeader()}).then(function(a){var r=[];a.data.data.forEach(function(e){var t=u.createFromData(e);r.push(t)}),t.info('[adminCompanyService] getCompanyJoinRequests success (found '+a.data.total+' invitation(s))'),e({companyRequests:r,total:a.data.total})},function(e){var a=o.handleError(e);i(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getCompanyJoinRequests'))})})},g.getJoinCompanyRequest=function(r,i){return e(function(e,s){a({method:'GET',url:g.portalURL+'companies/'+r+'/join-companies/requests/'+i+'?status=pending',headers:n.getRequestHeader()}).then(function(a){var r=u.createFromData(a.data.data);t.info('[adminCompanyService] getJoinCompanyRequest success'),e(r)},function(e){var a=o.handleError(e);s(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getJoinCompanyRequest'))})})},g.acceptCompanyJoinRequests=function(r,i){return e(function(e,s){a({method:'POST',url:g.portalURL+'companies/'+r+'/join-companies/requests/'+i+'/accept',headers:n.getRequestHeader()}).then(function(a){var r=u.createFromData(a.data.data);t.info('[adminCompanyService] acceptCompanyJoinRequests success'),e(r)},function(e){var a=o.handleError(e);t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'acceptCompanyJoinRequests')),s(a)})})},g.declineCompanyJoinRequests=function(r,i){return e(function(e,s){a({method:'POST',url:g.portalURL+'companies/'+r+'/join-companies/requests/'+i+'/decline',headers:n.getRequestHeader()}).then(function(a){var r=u.createFromData(a.data.data);t.info('[adminCompanyService] declineCompanyJoinRequests success'),e(r)},function(e){var a=o.handleError(e);t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'declineCompanyJoinRequests')),s(a)})})},g.getOAuthConsentUrl=function(){var r=d.getAppliLanguage().code;return e(function(e,i){a({method:'GET',url:config.restServerUrl+'/api/rainbow/office365/v1.0/consent?callback='+window.location.origin+'/redirectO365.html?provider=o365&lang='+r,headers:n.getRequestHeader()}).then(function(a){var r=a.data.url;t.info('[adminCompanyService] getOAuthConsentUrl success: '+r),e(r)},function(e){var a=o.handleError(e);t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getOAuthConsentUrl')),i(a)})})},g.getCompanyConferenceSettings=function(r){return e(function(e,i){a({method:'GET',url:g.portalURL+'companies/'+r+'/settings/conferences',headers:n.getRequestHeader()}).then(function(a){t.info('[adminCompanyService] getCompanyConferenceSettings success');var r=a.data.data;e(r)},function(e){var a=o.handleError(e);i(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getCompanyConferenceSettings'))})})},g.setCompanyConferenceSettings=function(r,i){return e(function(e,s){a({method:'PUT',url:g.portalURL+'companies/'+r+'/settings/conferences',headers:n.getRequestHeader(),data:{confDialOutDisabled:!i}}).then(function(a){t.info('[adminCompanyService] setCompanyConferenceSettings success');var r=a.data.data;e(r)},function(e){var a=o.handleError(e);s(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'setCompanyConferenceSettings'))})})},g.createCompanySingleSignOnServerConfig=function(r,i,s,d,c,l,p){return e(function(e,u){a({method:'POST',url:g.portalURL+'companies/'+r+'/settings/sso',headers:n.getRequestHeader(),data:{type:i,loginUrl:s,logoutUrl:d,certificates:c,uidAttribute:l,enabled:p}}).then(function(){t.info('[adminCompanyService] createCompanySingleSignOnServerConfig success'),e()},function(e){var a=o.handleError(e);u(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'createCompanySingleSignOnServerConfig'))})})},g.deleteCompanySingleSignOnServerConfig=function(r,i){return e(function(e,s){a({method:'DELETE',url:g.portalURL+'companies/'+r+'/settings/sso/'+i,headers:n.getRequestHeader()}).then(function(){t.info('[adminCompanyService] deleteCompanySingleSignOnServerConfig success'),e()},function(e){var a=o.handleError(e);s(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'deleteCompanySingleSignOnServerConfig'))})})},g.isCompanySingleSignOnAvailable=function(t){return e(function(e,a){t?g.getCompanySingleSignOnServerConfig(t).then(function(t){e(t&&0<t.length)}).catch(function(e){a(e)}):e(!1)})},g.getCompanySingleSignOnServerConfig=function(r){return e(function(e,i){a({method:'GET',url:g.portalURL+'companies/'+r+'/settings/sso',headers:n.getRequestHeader()}).then(function(a){t.info('[adminCompanyService] getCompanySingleSignOnServerConfig success');var r=a.data;e(r)},function(e){var a=o.handleError(e);i(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'getCompanySingleSignOnServerConfig'))})})},g.updateCompanySingleSignOnServerConfig=function(r,i,s,d,c,l,p){return e(function(e,u){a({method:'PUT',url:g.portalURL+'companies/'+r+'/settings/sso/'+i,headers:n.getRequestHeader(),data:{loginUrl:s,logoutUrl:d,certificates:c,uidAttribute:l,enabled:p}}).then(function(a){t.info('[adminCompanyService] updateCompanySingleSignOnConfig success');var r=a.data;e(r)},function(e){var a=o.handleError(e);u(a),t.error('[adminCompanyService] '+o.getErrorFullMessage(e,'updateCompanySingleSignOnConfig'))})})}}])},function(){angular.module('rainbow').service('adminUserService',['$q','$log','$http','authService','errorHelperService','Company','User','Site','Organisation','userInfoService','contactService','PhoneNumber',function(e,t,a,r,n,o,i,s,d,c,l,p){'use strict';var u=this;u.start=function(){return t.info('[adminUserService] === STARTING ==='),u.portalURL=config.restServerUrl+'/api/rainbow/admin/v1.0/',t.info('[adminUserService] === STARTED ==='),e.when()},u.stop=function(){return t.info('[adminUserService] === STOPPING ==='),t.info('[adminUserService] === STOPPED ==='),e.when()},u.getUsersByEmail=function(c,l){return e(function(e,p){var m=u.portalURL+'users?format=full';c&&c instanceof d&&(m+='&organisationId='+c.id),c&&c instanceof o&&(m+='&companyId='+c.id),c&&c instanceof s&&(m+='&siteId='+c.id),l&&(m+='&email='+encodeURIComponent(l)),a({method:'GET',url:m,headers:r.getRequestHeader()}).then(function(a){var r=a.data.data;t.info('[adminUserService] getUsersByEmail success (find '+a.data.total+' user(s))');var n=[];r.forEach(function(e){var t=i.createFromData(e);n.push(t)}),e({users:n,total:a.data.total})},function(e){var a=n.handleError(e);p(a),t.error('[adminOfferSubscriptionService] '+n.getErrorFullMessage(e,'getUsersByEmail'))})})},u.getUsers=function(c,l,p,m,g,v,f){return e(function(e,S){var C=u.portalURL+'users?format=full&limit='+p;c&&c instanceof d&&(C+='&organisationId='+c.id),c&&c instanceof o&&(C+='&companyId='+c.id),c&&c instanceof s&&(C+='&siteId='+c.id),l&&(C+='&offset='+p*(l-1)),m&&(C+='&displayName='+encodeURIComponent(m)+'&useEmails=true'),g!==void 0&&null!==g&&(C+='&isTerminated='+g),v&&(C+='&roles=admin&roles=bp_admin&roles=bp_finance&roles=superadmin'),a({method:'GET',url:C,headers:r.getRequestHeader()}).then(function(a){var r=a.data.data;t.info('[adminUserService] getUsers success (find '+a.data.total+' user(s))');var n=[];r.forEach(function(e){var t=i.createFromData(e,f);n.push(t)}),e({users:n,limit:a.data.limit,offset:a.data.offset,total:a.data.total})},function(e){var a=n.handleError(e);S(a),t.error('[adminOfferSubscriptionService] '+n.getErrorFullMessage(e,'getUsers'))})})},u.searchUsers=function(o,s,d,c){return e(function(e,l){var p=config.restServerUrl+'/api/rainbow/search/v1.0/users?limit='+d;o&&(p+='&companyId='+o.id),s&&(p+='&offset='+d*(s-1)),c&&(p+='&displayName='+encodeURIComponent(c)),a({method:'GET',url:p,headers:r.getRequestHeader()}).then(function(a){var r=a.data.data;t.info('[adminUserService] searchUsers success (find '+a.data.total+' user(s))');var n=[];r.forEach(function(e){var t=i.createFromData(e);n.push(t)}),e({users:n,total:a.data.total})},function(e){var a=n.handleError(e);l(a),t.error('[adminOfferSubscriptionService] '+n.getErrorFullMessage(e,'searchUsers'))})})},u.getUser=function(o){var s=e.defer();return a({method:'GET',url:u.portalURL+'users/'+o,headers:r.getRequestHeader()}).then(function(e){t.info('[adminUserService] getUser success');var a=e.data.data,r=i.createFromData(a);s.resolve(r)},function(e){var a=n.handleError(e);s.reject(a),t.error('[adminUserService] '+n.getErrorFullMessage(e,'getUser'))}),s.promise},u.createUser=function(o){var s=i.prune(o,l.userContact),d=e.defer();return a({method:'POST',url:u.portalURL+'users',headers:r.getRequestHeader(),data:s}).then(function(e){var a=i.createFromData(e.data.data);t.info('[adminUserService] createUser success'),d.resolve(a)},function(e){var a=n.handleError(e);d.reject(a),t.error('[adminUserService] '+n.getErrorFullMessage(e,'createUser'))}),d.promise},u.deleteUser=function(o){var i=e.defer();return a({method:'DELETE',url:u.portalURL+'users/'+o.id,headers:r.getRequestHeader()}).then(function(){t.info('[adminUserService] deleteUser success'),i.resolve()},function(e){var a=n.handleError(e);i.reject(a),t.error('[adminUserService] '+n.getErrorFullMessage(e,'deleteUser'))}),i.promise},u.updateUser=function(o){var s=i.prune(o,l.userContact),d=e.defer();return a({method:'PUT',url:u.portalURL+'users/'+o.id,headers:r.getRequestHeader(),data:s}).then(function(){t.info('[adminUserService] updateUser success'),d.resolve()},function(e){var a=n.handleError(e);d.reject(a),t.error('[adminUserService] '+n.getErrorFullMessage(e,'updateUser'))}),d.promise},u.getUserAvatar=function(e){var t=c.computeUserColor(e.firstName+' '+e.lastName).color;c.getAvatarImage(e.id,e.initials,t,50,e.lastAvatarUpdateDate).then(function(t){e.image=t})},u.expandTelephonyInfo=function(e){var t={};return e.phoneNumbers&&e.phoneNumbers.forEach(function(e){var a=e.number,r=e.numberE164,n=e.deviceType;switch(e.type){case'work':'landline'===n&&(t.phoneProNumber&&t.phoneProNumber.systemId||(t.phonePro=a,t.phoneProCan=r,t.phoneProExt=e.shortNumber,t.phoneProIsMonitored=e.isMonitored,t.phoneProNumber=p.createFromData(e))),'mobile'===n&&(t.mobilePro=a,t.mobileProCan=r);break;case'home':'landline'===n&&(t.phonePerso=a,t.phonePersoCan=r),'mobile'===n&&(t.mobilePerso=a,t.mobilePersoCan=r);break;case'rainbow':t.rainbowPhoneNumber=a;break;default:}}),t},u.getAllUsers=function(t,a){var r=1e3;return e(function(n,o){var i;u.getUsers(t,1,r,void 0,void 0,void 0,a).then(function(n){if(i=n,n.total>n.limit){var o=Math.ceil(n.total/r),s=Array.apply(null,Array(o-1));s=s.map(function(e,t){return t+2});for(var d=[];0<s.length;)d.push(s.splice(0,5));return d.reduce(function(n,o){return n.then(function(){var n=o.map(function(e){return u.getUsers(t,e,r,void 0,void 0,void 0,a).then(function(e){i.users=i.users.concat(e.users),i.limit+=e.limit})});return e.all(n)})},e.resolve())}}).then(function(){n(i)}).catch(function(e){o(e)})})}}])},function(){angular.module('rainbow').filter('emojione',['$sce','$sanitize',function(e,t){'use strict';return function(a){return angular.isString(a)?t(e.trustAsHtml(emojione.shortnameToImage(a))):a}}]),angular.module('rainbow').filter('emojiUnicodeToShort',function(){'use strict';return function(e){return angular.isString(e)?emojione.toShort(e):e}}),angular.module('rainbow').filter('emojiShortToUnicode',function(){'use strict';return function(e){return angular.isString(e)?emojione.shortnameToUnicode(e):e}})},function(){angular.module('rainbow').factory('PromiseQueue',['$log',function(e){'use strict';function t(){var t=this;this.queue=[],this.started=!1,this.add=function(e){this.queue.push(e),this.started||(this.started=!0,this.execute())},this.execute=function(){var a=this.queue.shift();if(a)try{t.timeoutPromise(2e4,a).then(function(){t.execute()}).catch(function(a){var r=a&&a.message?a.message:'Unknown error';e.error('[PromiseQueue] execute failure -- '+r),t.execute()})}catch(a){var r=a&&a.message?a.message:'Unknown error',n=a&&a.stack?a.stack:'Unknown stack';e.error('[PromiseQueue] execution exception  -- '+r+' : '+n),t.execute()}else this.started=!1},t.timeoutPromise=function(e,t){var a=new Promise(function(t,a){r=setTimeout(function(){a(new Error('Timed out in '+e+'ms.'))},e)}),r;return Promise.race([t(),a]).then(function(e){return clearTimeout(r),e})}}return t.create=function(){return new t},t}])},function(){angular.module('rainbow').factory('TransfertPromiseQueue',['$log','$q',function(e,t){'use strict';function a(){var a=this;a.fileQueue=[],a.clearContext=function(){a.currentId=null,a.currentQueue=[],a.promiseCompletion=void 0,a.promiseReject=void 0,a.initialQueueSize=0,a.promisesDone=0,a.chunkErrorCounter=0,a.currentPromise=void 0},a.clearContext(),a.addPromiseArray=function(r,n,o,i){e.debug('[TransfertPromiseQueue] adding promiseArray');var s={};return s.id=r,s.promiseArray=n,s.promiseCompletion=o,s.promiseReject=i,0!==a.fileQueue.length||a.currentPromise?(a.fileQueue.push(s),e.debug('[TransfertPromiseQueue] adding PromiseArray in FileQueue: '+a.fileQueue.length)):(e.debug('[TransfertPromiseQueue] configuring file to transfert: '+s.promiseArray.length),a.fileQueue.push(s),a.popFileQueue()),e.debug('[TransfertPromiseQueue] adding promise on FileQueue: '+a.fileQueue.length),t},a.popFileQueue=function(){if(0<a.fileQueue.length){e.debug('[TransfertPromiseQueue] go to next file');var t=a.fileQueue.shift();a.currentId=t.id,a.currentQueue=t.promiseArray,a.promiseCompletion=t.promiseCompletion,a.promiseReject=t.promiseReject,a.initialQueueSize=a.currentQueue.length,a.promisesDone=0,a.chunkErrorCounter=0,a.currentPromise=a.currentQueue.shift(),a.execute()}else e.debug('[TransfertPromiseQueue] no more file to transfert'),a.clearContext()},a.execute=function(){e.debug('[TransfertPromiseQueue] execute'),a.currentPromise?(e.debug('[TransfertPromiseQueue] performing promise: '+a.promisesDone),a.currentPromise().then(function(){e.debug('[TransfertPromiseQueue] promise success go to next one'),a.promisesDone++,a.chunkErrorCounter=0,a.promisesDone>=a.initialQueueSize?(a.promiseCompletion&&a.promiseCompletion(),a.popFileQueue()):(a.currentPromise=a.currentQueue.shift(),a.execute())}).catch(function(t){var r=t&&t.message?t.message:'Unknown error';e.error('[TransfertPromiseQueue] failure executing promise -- '+r),a.chunkErrorCounter++,t&&500<=t.errorDetailsCode&&3>=a.chunkErrorCounter?a.execute():(e.error('[TransfertPromiseQueue] 3 chunk failed - ABORT File Upload'),a.promiseReject(t),a.popFileQueue())})):(e.debug('[TransfertPromiseQueue] no promise to perform'),a.currentPromise=void 0)},a.isTransferInProgress=function(){return e.debug('[TransfertPromiseQueue] >isTransferInProgress: '+a.fileQueue.length+'/'+a.currentQueue.length),0<a.fileQueue.length||0<a.currentQueue.length||a.currentPromise},a.cancelAllTransfers=function(){e.debug('[TransfertPromiseQueue] cancelAllTransfers'),a.fileQueue=[],a.currentQueue=[]},a.cancelCurrentFiletransfer=function(t){if(e.debug('[TransfertPromiseQueue] cancelCurrentFiletransfer'),a.currentId===t)e.debug('[TransfertPromiseQueue] cancelling current promise'),a.popFileQueue();else{var r=a.fileQueue.find(function(e){return e.id===t});if(r){var n=a.fileQueue.indexOf(r);e.debug('[TransfertPromiseQueue] promise to remove at position='+n),a.fileQueue.splice(n,1)}}}}return a.create=function(){return e.debug('[TransfertPromiseQueue] >create'),new a},a}])},function(){window.sdk=angular.module('sdk',['pascalprecht.translate','ngSanitize','angularRandomString','ngFileSaver','angular-jwt','uuid4','rainbow','rainbowAdmin'],function(){'use strict'})},function(){sdk.constant('SDK',{OK:1,ERROR:-1,ERRORUNAUTHORIZED:-2,ERRORXMPP:-4,ERRORXMPPJID:-8,ERRORBADREQUEST:-16,ERRORUNSUPPORTED:-32,ERRORNOTFOUND:-64})},function(){sdk.remoteConsole={debug:!1,log:!1,info:!1,warn:!1,error:!1},sdk.hasVerboseLog=!1,sdk.useAngularEvents=!1,sdk.hasBeenLaunchedFromConfig=!1,sdk.key={appID:'',appSecret:'',host:'openrainbow.com'},sdk.config(['consoleLogsProvider','$provide','$httpProvider','$translateProvider',function(e,t,a,r){'use strict';var n=function(e){var t=e.toDateString()+' '+('0'+e.getHours()).slice(-2)+':'+('0'+e.getMinutes()).slice(-2)+':'+('0'+e.getSeconds()).slice(-2);return t};t.decorator('$log',['$delegate',function(t){var a=t.debug;t.debug=function(){var t=[].slice.call(arguments);sdk.remoteConsole.debug&&console.re.debug(t[0]),sdk.hasVerboseLog&&a.apply(null,t),e.setLogs(['['+n(new Date)+']']+'debug : '+t+'\n')};var r=t.log;t.log=function(){var t=[].slice.call(arguments);sdk.remoteConsole.log&&console.re.log(t[0]),sdk.hasVerboseLog&&r.apply(null,t),e.setLogs(['['+n(new Date)+']']+'log : '+t+'\n')};var o=t.info;t.info=function(){var t=[].slice.call(arguments);sdk.remoteConsole.info&&console.re.info(t[0]),sdk.hasVerboseLog&&o.apply(null,t),e.setLogs(['['+n(new Date)+']']+'info : '+t+'\n')};var i=t.warn;t.warn=function(){var t=[].slice.call(arguments);sdk.remoteConsole.warn&&console.re.warn(t[0]),i.apply(null,t),e.setLogs(['['+n(new Date)+']']+'warn : '+t+'\n')};var s=t.error;return t.error=function(){var t=[].slice.call(arguments);sdk.remoteConsole.error&&console.re.error(t[0]),s.apply(null,t),e.setLogs(['['+n(new Date)+']']+'error : '+t+'\n')},t.webrtc=function(){var t=[].slice.call(arguments),r='rtcweb : '+t[0];t[0]='%c '+n(new Date)+' | RTCWEB | '+t[0],t[t.length]='color:green',sdk.remoteConsole.log&&console.re.log(t[0]),a.apply(null,t),e.setLogs(['['+n(new Date)+']']+r+'\n')},t.sdk=function(){var t=[].slice.call(arguments),r='RBW-SDK : '+t[0];t[0]='%c '+n(new Date)+' | RBW-SDK | '+t[0],t[t.length]='color:green',sdk.remoteConsole.log&&console.re.log(t[0]),a.apply(null,t),e.setLogs(['['+n(new Date)+']']+r+'\n')},t}]),a.defaults.useXDomain=!0,r.useSanitizeValueStrategy(null)}]),sdk.run([function(){'use strict'}]),sdk.provider('consoleLogs',[function(){'use strict';this.logsBuffer=[],this.logsMaxLength=2e6,this.$get=function(){var e=this.logsBuffer;return{getLogs:function(){return e}}},this.cleanBuffer=function(){this.logsBuffer.length>this.logsMaxLength&&(this.logsBuffer=this.logsBuffer.slice(-this.logsMaxLength))},this.setLogs=function(e){1e3===this.logsBuffer&&this.logsBuffer.shift(),this.logsBuffer.push(e)}}])},function(){window.config={xmpp:{protocol:'wss',server:'sandbox.openrainbow.com',port:'443',pingInterval:'60000'},webservices:{protocol:'https',server:'sandbox.openrainbow.com',port:'443'},cpaas:{protocol:'https',server:'',port:'8887'}}},function(){angular.module('sdk').service('connectionService',['$q','$log','$rootScope','authService','xmppService','companyService','contactService','botService','fileServerService','fileStorageService','roomService','groupService','videoService','webrtcServiceEventHandler','telephonyService','conferenceService','pstnConferenceService','webConferenceService','conversationService','callLogService','platformService','invitationService','adminCompanyService','adminUserService','profileService','channelService','cpaasService','webrtcGatewayService','recordsService','SDK',function(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f,S,C,h,E,R,b,y,T,I,N,A,O,P){'use strict';var D=this,_='ConnectSrv | ',M='disconnected';this.RAINBOW_ONCONNECTIONSTATECHANGED='rainbowconnectionstatechanged',this.RAINBOW_ONSTARTED='started',this.RAINBOW_ONSIGNED='signed',this.RAINBOW_ONSTOPPED='stopped',this.RAINBOW_CONNECTIONINPROGRESS='inProgress',this.RAINBOW_ONUSERTOKENRENEW='userTokenRenew',this.RAINBOW_ONUSERTOKENRENEWFAILED='userTokenRenewFailed',this.RAINBOW_ONAPPTOKENRENEW='applicationTokenRenew',this.RAINBOW_ONAPPTOKENRENEWFAILED='applicationTokenRenewFailed',this.RAINBOW_CONNECTIONCONNECTED='connected',this.RAINBOW_CONNECTIONDISCONNECTED='disconnected',this.RAINBOW_OFFICIAL_HOST='openrainbow.com',this.RAINBOW_BETA_HOST='openrainbow.net',this.RAINBOW_DEV_HOST='openrainbow.org',this.RAINBOW_SANDBOX_HOST='sandbox.openrainbow.com';var w=this.RAINBOW_SANDBOX_HOST;this.RAINBOW_CPAASPREPROD_HOST='cpaaspreprod.openrainbow.net';var w=this.RAINBOW_CPAASPREPROD_HOST;this.RAINBOW_CHINA_HOST='openrainbow.cn.com';var w=this.RAINBOW_CHINA_HOST;this.RAINBOW_CHINASANDBOX_HOST='sandbox.openrainbow.cn.com';var w=this.RAINBOW_CHINASANDBOX_HOST;this.signin=function(e,t){return w=this.RAINBOW_SANDBOX_HOST,U(e,t,null)},this.signinOnRainbowOfficial=function(e,t){return w=this.RAINBOW_OFFICIAL_HOST,U(e,t,null)},this.signinOnRainbowBeta=function(e,t){return w=this.RAINBOW_BETA_HOST,U(e,t,null)},this.signinOnRainbowCPaasPreProd=function(e,t){return w=this.RAINBOW_CPAASPREPROD_HOST,U(e,t,null)},this.signinOnRainbowDev=function(e,t){return w=this.RAINBOW_DEV_HOST,U(e,t,null)},this.signinOnRainbowHosted=function(e,t,a){return w=a,U(e,t,null)},this.signinSandBoxWithToken=function(e){return w=this.RAINBOW_SANDBOX_HOST,U(null,null,e)},this.signinOnRainbowOfficialWithToken=function(e){return w=this.RAINBOW_OFFICIAL_HOST,U(null,null,e)},this.signinOnRainbowBetaWithToken=function(e){return w=this.RAINBOW_BETA_HOST,U(null,null,e)},this.signinOnRainbowDevWithToken=function(e){return w=this.RAINBOW_DEV_HOST,U(null,null,e)},this.signinOnRainbowHostedWithToken=function(e,t){return w=t,U(null,null,e)},this.signout=function(){var r=e.defer(),E={code:P.OK,label:'OK'};return t.sdk(_+'[signout    ] :: Try to sign-out...'),u.stop().then(function(){return t.sdk(_+'[signout    ] :: Video service stopped'),m.stop()}).then(function(){return t.sdk(_+'[signout    ] :: WebRTCEventHandler service stopped'),i.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Contact service stopped'),s.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Bot service stopped'),T.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Profile service stopped'),C.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Conversation service stopped'),v.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Conference service stopped'),S.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Web Conference service stopped'),f.stop()}).then(function(){return t.sdk(_+'[signout    ] :: PTSN Conference service stopped'),h.stop()}).then(function(){return t.sdk(_+'[signout    ] :: ChannelService service stopped'),I.stop()}).then(function(){return t.sdk(_+'[signout    ] :: CallLog service stopped'),g.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Telephony service stopped'),d.stop()}).then(function(){return t.sdk(_+'[signout    ] :: FileServer service stopped'),c.stop()}).then(function(){return t.sdk(_+'[signout    ] :: FileStorage service stopped'),R.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Group service stopped'),p.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Room service stopped'),l.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Company service stopped'),o.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Admin Company service stopped'),b.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Admin User service stopped'),y.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Invitation service stopped'),A.stop()}).then(function(){return t.sdk(_+'[signout    ] :: webrtcGateway service stopped'),n.stop()}).then(function(){return t.sdk(_+'[signout    ] :: Records service stopped'),O.stop()}).then(function(){t.sdk(_+'[signout    ] :: XMPP service stopped'),t.sdk(_+'[signout    ] :: Services Successfully unloaded!'),sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONSTOPPED):$(document).trigger(D.RAINBOW_ONSTOPPED,null),r.resolve(E)}).catch(function(e){return t.sdk(_+'[signout    ] :: Error during signout...'),r.reject(e),r.promise}),r.promise},this.updateUserPassword=function(e,t){return i.updateUserPassword(e,t,!1)},this.getState=function(){return M},this.getToken=function(){return r.token};var U=function(N,M,U){var F=e.defer(),k=!1;if(!U){if(!N)return F.reject({code:P.ERRORBADREQUEST,label:'Parameter \'login\' is missing or empty'});if(!M)return F.reject({code:P.ERRORBADREQUEST,label:'Parameter \'password\' is missing or empty'})}else k=!0,N=null,M=null;t.sdk(_+'[signin     ] :: Rainbow host used '+w),k?t.sdk(_+'[signin     ] :: Try to sign-in with given token'):t.sdk(_+'[signin     ] :: Try to sign-in with '+N+'...');var B={code:P.OK,label:'',account:null};return r.removeCredentials(),r.authenticateOnHost(N,M,w,{appID:sdk.key.appID,appSecret:sdk.key.appSecret},U).then(function(){B.account={},B.label='ok',B.account.userId=r.userId,B.account.companyId=r.companyId,B.account.loginEmail=r.login,B.account.roles=r.userData.roles,B.token=r.token,B.userData=r.userData;var M=[];t.sdk(_+'[signin     ] :: Successfully sign-in with '+N+' | '+r.jidIm),sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONSIGNED,B):$(document).trigger(D.RAINBOW_ONSIGNED,[B]),r.startTokenSurvey(),t.sdk(_+'[signin     ] :: Start services...'),n.disconnectionHandler=L,n.start(M).then(function(){return t.sdk(_+'[signin     ] :: XMPP service ready!'),o.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Company service ready!'),b.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Admin company service ready!'),y.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Admin user service ready!'),i.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Contact service ready!'),T.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Profile service ready!'),R.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Invitation service ready!'),d.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: FileServer service ready!'),c.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: FileStorage service ready!'),l.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Room service ready!'),p.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Group service ready!'),A.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: WebrtcGateway service ready!'),u.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Video service ready!'),m.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: WebRTCEventHandler service ready!'),g.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Telephony service ready!'),f.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: PSTN Conference service ready!'),S.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Web Conference service ready!'),C.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Conversation service ready!'),t.sdk(_+'[signin     ] :: Send initial presence'),i.sendPresenceFromConfiguration(),e.when()}).then(function(){return t.sdk(_+'[signin     ] :: Initial presence sent !'),h.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: CallLog service ready!'),E.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Platform service ready!'),s.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Bot service ready!'),v.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Conference service ready!'),O.start(M)}).then(function(){return t.sdk(_+'[signin     ] :: Records service ready!'),I.start(M)}).then(function(){t.sdk(_+'[signin     ] :: Channel service ready!'),t.sdk(_+'[signin     ] :: Services Successfully loaded!'),a.$broadcast('ON_CONNECTION_STATE_CHANGE_EVENT','connected'),sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONSTARTED):$(document).trigger(D.RAINBOW_ONSTARTED,B),F.resolve(B)}).catch(function(){t.sdk(_+'[signin     ] :: Error during signin'),B.code=P.ERRORXMPP,B.label='errorXMPP',B.account=null,F.reject(B)})}).catch(function(){t.sdk(_+'[signin     ] :: Error during signin'),B.code=P.ERRORUNAUTHORIZED,B.label='errorUnauthorized',F.reject(B)}),F.promise},L=function(){t.sdk(_+'[discHandler] :: Disconnected from the XMPP Rainbow Cloud Services')},F=function(e,r){t.sdk(_+'[onChange   ] :: Connection state changed to '+r),M=r,sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONCONNECTIONSTATECHANGED,r):$(document).trigger(D.RAINBOW_ONCONNECTIONSTATECHANGED,[r])};(function(){a.$on('$destroy',a.$on('ON_CONNECTION_STATE_CHANGE_EVENT',F)),a.$on('$destroy',a.$on('ON_AUTH_TOKEN_RENEW',function(){sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONUSERTOKENRENEW):($(document).trigger(D.RAINBOW_ONUSERTOKENRENEW),null)})),a.$on('$destroy',a.$on('ON_AUTH_TOKEN_EXPIRE',function(){sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONUSERTOKENRENEWFAILED):$(document).trigger(D.RAINBOW_ONUSERTOKENRENEWFAILED,null),signout()})),a.$on('$destroy',a.$on('ON_AUTH_TOKEN_RENEW',function(){sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONAPPTOKENRENEW):$(document).trigger(D.RAINBOW_ONAPPTOKENRENEW,null)})),a.$on('$destroy',a.$on('ON_AUTH_TOKEN_EXPIRE',function(){sdk.useAngularEvents?a.$broadcast(D.RAINBOW_ONAPPTOKENRENEWFAILED):$(document).trigger(D.RAINBOW_ONAPPTOKENRENEWFAILED,null),signout()})),window.addEventListener('beforeunload',function(){a.$broadcast('ON_CONNECTION_STATE_CHANGE_EVENT','disconnected'),u.stop(),i.stop(),C.stop(),p.stop(),g.stop(),d.stop(),c.stop(),h.stop(),n.stop(),T.stop(),O.stop(),I.stop(),A.stop()})})()}])},function(){angular.module('sdk').service('presenceService',['$log','$rootScope','xmppService','contactService','SDK',function(e,t,a,r,n){'use strict';var o=this,i='PresenceSvr| ';this.RAINBOW_PRESENCE_ONLINE='online',this.RAINBOW_PRESENCE_AWAY='away',this.RAINBOW_PRESENCE_DONOTDISTURB='dnd',this.RAINBOW_PRESENCE_OFFLINE='xa',this.RAINBOW_PRESENCE_BUSY='busy',this.RAINBOW_PRESENCE_UNKNOW='unknow',this.RAINBOW_ONCONTACTPRESENCECHANGED='rainbowcontactpresencechanged',this.RAINBOW_ONPRESENCECHANGED='rainbowpresencechanged',this.RAINBOW_ONCONTACTRICHPRESENCECHANGED='rainbowcontactrichpresencechanged',this.RAINBOW_ONRICHPRESENCECHANGED='rainbowrichpresencechanged',this.setPresenceTo=function(t){return t!==this.RAINBOW_PRESENCE_DONOTDISTURB&&t!==this.RAINBOW_PRESENCE_AWAY&&t!==this.RAINBOW_PRESENCE_OFFLINE&&t!==this.RAINBOW_PRESENCE_ONLINE?{code:n.ERRORBADREQUEST,label:'Parameter \'strPresenceState\' should be \'dnd\', \'away\', \'xa\' (invisible) or \'online\''}:(e.sdk(i+'[setPresTo  ] :: Set presence to '+t),r.changeMyPresence(t),{code:n.OK,label:'OK'})};t.$on('$destroy',t.$on('ON_ROSTER_PRESENCE_CHANGED_EVENT',function(r,n){var s=n.message||'\'\'';n.jid===a.fullJid?(e.sdk(i+'[onChange   ] :: Presence changed for me ('+n.jid+') to  '+n.status+' | '+s),sdk.useAngularEvents?t.$broadcast(o.RAINBOW_ONPRESENCECHANGED,n):$(document).trigger(o.RAINBOW_ONPRESENCECHANGED,[n])):(e.sdk(i+'[onChange   ] :: Presence changed for contact ('+n.jid+') to  '+n.status+' | '+s),sdk.useAngularEvents?t.$broadcast(o.RAINBOW_ONCONTACTPRESENCECHANGED,n):$(document).trigger(o.RAINBOW_ONCONTACTPRESENCECHANGED,[n]))})),t.$on('$destroy',t.$on('ON_UPDATE_CONTACT_RICH_STATUS_EVENT',function(r,n){var s=n.message||'\'\'',d=n.telStatus||'\'\'';a.fullJid.includes(n.jid)?(e.sdk(i+'[onChange   ] :: Rich Presence changed for myself to status '+n.status+', message '+s+' and telStatus '+d),sdk.useAngularEvents?t.$broadcast(o.RAINBOW_ONRICHPRESENCECHANGED,n):$(document).trigger(o.RAINBOW_ONRICHPRESENCECHANGED,[n])):(e.sdk(i+'[onChange   ] :: Rich Presence changed for contact ('+n.jid+') to status '+n.status+', message '+s+' and telStatus '+d),sdk.useAngularEvents?t.$broadcast(o.RAINBOW_ONCONTACTRICHPRESENCECHANGED,n):$(document).trigger(o.RAINBOW_ONCONTACTRICHPRESENCECHANGED,[n]))}))}])},function(){angular.module('sdk').service('userProfileService',['$q','$log','$rootScope','contactService','xmppService','profileService','adminUserService','SDK',function(e,t,a,r,n,o,i,s){'use strict';var d=this,c='UserProfile| ';this.getProfile=function(){var a=e.defer();return o.getUserData().then(function(e){t.sdk(c+'[getProfile] :: got');var r={name:e.lastName,firstName:e.firstName,phoneNumbers:e.phoneNumbers};a.resolve(r)}).catch(function(e){t.sdk(c+'[getProfile] :: Error when trying to get Profile - '+e),a.reject(e)}),a.promise},this.updateFirstName=function(a){var r=e.defer();if(!a||'string'!=typeof a||1>a.length)r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'strFirstname\' is missing, empty or null'});else{o.setUserData({firstName:a}).then(function(e){t.sdk(c+'[updateFirstName] :: First name updated');var a={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};r.resolve(a)}).catch(function(e){t.sdk(c+'[updateFirstName] :: Error when updating first name - '+e),r.reject(e)})}return r.promise},this.updateLastName=function(a){var r=e.defer();if(!a||'string'!=typeof a||1>a.length)r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'strName\' is missing, empty or null'});else{o.setUserData({lastName:a}).then(function(e){t.sdk(c+'[updateName] :: Name updated');var a={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};r.resolve(a)}).catch(function(e){t.sdk(c+'[updateName] :: Error when updating name - '+e),r.reject(e)})}return r.promise},this.updatePhoneNumber=function(a,r,n,i){var d=e.defer();if((!a||'string'!=typeof a||0>['home','work','other'].indexOf(a))&&d.reject({code:s.ERRORBADREQUEST,label:'Parameter \'type\' is missing or not in \'home\', \'work\', \'other\''}),!r||'string'!=typeof r||0>['landline','mobile','fax','other'].indexOf(r))d.reject({code:s.ERRORBADREQUEST,label:'Parameter \'deviceType\' is missing or not in \'landline\', \'mobile\', \'fax\', \'other\''});else if(!n||'string'!=typeof n)d.reject({code:s.ERRORBADREQUEST,label:'Parameter \'strPhoneNumber\' is missing, empty or null'});else{var l={phoneNumbers:[{type:a,deviceType:r,number:n}]};i&&'string'==typeof i&&(l.country=i),o.getUserData().then(function(e){if(e.phoneNumbers.length){var t=!1;if(t=e.phoneNumbers.some(function(e){return e.type===a&&e.deviceType===r&&(e.number=n,!0)}),!t){e.phoneNumbers.push({type:a,deviceType:r,number:n})}return o.setUserData(e)}return o.setUserData(l)}).then(function(e){t.sdk(c+'[updatePhoneNumber] :: Phone number updated');var a={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};d.resolve(a)}).catch(function(e){t.sdk(c+'[updatePhoneNumber] :: Error when updating phone number - '+e),d.reject(e)})}return d.promise},this.updatePhotoFromUrl=function(a){var n=e.defer();return!a||'string'!=typeof a||1>a.length?n.reject({code:s.ERRORBADREQUEST,label:'Parameter \'imgUrl\' is missing, empty or null'}):r.pushAvatarImage(a).then(function(){t.sdk(c+'[updatePhotoFromUrl] :: Photo updated'),n.resolve()}).catch(function(e){t.sdk(c+'[updatePhotoFromUrl] :: Error when updating Photo - '+e),n.reject(e)}),n.promise}}])},function(){angular.module('sdk').service('contactsService',['$log','$q','$rootScope','contactService','directoryService','invitationService','SDK',function(e,t,a,r,n,o,i){'use strict';var s=this,d='ContactsSrv| ';this.RAINBOW_ONCONTACTINFORMATIONCHANGED='rainbowcontactinformationchanged',this.RAINBOW_ONINFORMATIONCHANGED='rainbowinformationchanged',this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED='rainbowsubscriptionnumberchanged',this.RAINBOW_ONCONTACTINVITATIONRECEIVED='rainbowinvitationreceived',this.getContactByJID=function(e){return e?r.getContactByJid(e):{code:i.ERRORBADREQUEST,label:'Parameter \'strJID\' is missing or empty'}},this.getContactById=function(e){return e?r.getContactById(e):{code:i.ERRORBADREQUEST,label:'Parameter \'strId\' is missing or empty'}},this.getNetworkContacts=function(){return r.getContacts().filter(function(e){return e.id!==r.userContact.id&&!e.isBot&&e.roster})},this.getAll=function(){return r.getContacts().filter(function(e){return e.id!==r.userContact.id&&!e.isBot})},this.getConnectedUser=function(){return r.userContact||null},this.getConnectedUserPhone=function(){return r.userContact?0===r.userContact.pbxId.length?null:{phoneNumber:r.userContact.phonePbx,pbxId:r.userContact.pbxId}:null},this.searchByName=function(e,a){var r=t.defer();return e?(!a&&(a=20),n.search(e,!0,Math.min(a,1e3)).then(function(e){r.resolve(e)}).catch(function(e){r.reject(e)})):r.reject({code:i.ERRORBADREQUEST,label:'Parameter \'strName\' is missing or empty'}),r.promise},this.searchByLogin=function(e){var a=t.defer();return e?n.searchUserByLogin(e).then(function(e){a.resolve(e)}).catch(function(e){404===e.status||400===e.status?a.resolve(null):a.reject(e)}):a.reject({code:i.ERRORBADREQUEST,label:'Parameter \'strLogin\' is missing or empty'}),a.promise},this.searchByJid=function(e){var a=t.defer();return e?n.searchUserByJid(e).then(function(e){a.resolve(e)}).catch(function(e){404===e.status||400===e.status?a.resolve(null):a.reject(e)}):a.reject({code:i.ERRORBADREQUEST,label:'Parameter \'strJid\' is missing or empty'}),a.promise},this.searchById=function(e){var a=t.defer();return e?r.getContactByDBId(e,!0).then(function(e){a.resolve(e)}).catch(function(e){404===e.status||400===e.status?a.resolve(null):a.reject(e)}):a.reject({code:i.ERRORBADREQUEST,label:'Parameter \'strId\' is missing or empty'}),a.promise},this.acceptInvitation=function(e){var a=t.defer();return e?o.acceptInvitation(e).then(function(){a.resolve({code:i.OK,label:'OK'})}).catch(function(e){a.reject(e)}):a.reject({code:i.ERRORBADREQUEST,label:'Parameter \'invitation\' is missing or null'}),a.promise},this.declineInvitation=function(e){var a=t.defer();return e?(o.declineInvitation(e).then(function(){a.resolve({code:i.OK,label:'OK'})}).catch(function(e){a.reject(e)}),a.promise):a.reject({code:i.ERRORBADREQUEST,label:'Parameter \'invitation\' is missing or null'})},this.addToNetwork=function(e){var a=t.defer();return e?(o.joinContactInvitation(e).then(function(){a.resolve(e)}).catch(function(e){a.reject(e)}),a.promise):{code:i.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}},this.sendInvitationByEmail=function(e,a){var r=t.defer();return e?o.sendInvitationByEmail(e,a).then(function(){r.resolve(contact)}).catch(function(e){r.reject(e)}):r.reject({code:i.ERRORBADREQUEST,label:'Parameter \'email\' is missing or null'}),r.promise},this.removeFromNetwork=function(e){var a=t.defer();return e||a.reject({code:i.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),r.removeContact(e).then(function(){a.resolve({code:i.OK,label:'OK'})}).catch(function(e){a.reject(e)}),a.promise},this.getInvitationById=function(e){return e?o.getInvitation(e):{code:i.ERRORBADREQUEST,label:'Parameter \'strInvitationId\' is missing or null'}},this.getInvitationsReceived=function(){return o.getReceivedInvitations()},this.cancelInvitation=function(e){var a=t.defer();return e?o.cancelOneSendInvitation(e).then(function(){a.resolve({code:i.OK,label:'OK'})}).catch(function(e){a.reject(e)}):a.reject({code:i.ERRORBADREQUEST,label:'Parameter \'invitation\' is missing or null'}),a.promise},this.getInvitationsSent=function(){return o.getSentInvitations()};a.$on('$destroy',a.$on('ON_CONTACT_UPDATED_EVENT',function(t,r){e.sdk(d+'[onChange   ] :: Information changed for contact '+r.displayNameForLog()),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCONTACTINFORMATIONCHANGED,r):$(document).trigger(s.RAINBOW_ONCONTACTINFORMATIONCHANGED,[r])})),a.$on('$destroy',a.$on('ON_USER_CONTACT_UPDATED_EVENT',function(t,r){e.sdk(d+'[onChange   ] :: Information changed for me ('+r.displayNameForLog()+')'),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONINFORMATIONCHANGED,r):$(document).trigger(s.RAINBOW_ONINFORMATIONCHANGED,[r])})),a.$on('$destroy',a.$on('ON_INVITATIONS_NUMBER_UPDATED',function(){e.sdk(d+'[onChange   ] :: Invitation number changed'),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED):$(document).trigger(s.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED,[])})),a.$on('$destroy',a.$on('ON_INVITATION_CHANGED',function(t,r){e.sdk(d+'[onChange   ] :: Invitation received'),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCONTACTINVITATIONRECEIVED,r):$(document).trigger(s.RAINBOW_ONCONTACTINVITATIONRECEIVED,[r])}))}])},function(){angular.module('sdk').service('pbxService',['$q','$log','$rootScope','telephonyService','Call','SDK',function(e,t,a,r,n,o){'use strict';var i=this,s='TelphonySrv| ';this.RAINBOW_ONTELEPHONYCALLSTATECHANGED='rainbowontelephonycallstatechanged',this.RAINBOW_ONTELEPHONYSTARTED='rainbowontelephonystarted',this.RAINBOW_ONTELEPHONYSTOPPED='rainbowontelephonystopped',this.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED='rainbowontelephonyforwardstatechanged',this.RAINBOW_TELEPHONYDIALING='dialing',this.RAINBOW_TELEPHONYRINGINGOUTGOING='ringingOutgoing',this.RAINBOW_TELEPHONYINCOMING='incomingCall',this.RAINBOW_TELEPHONYACTIVE='active',this.RAINBOW_TELEPHONYRELEASING='releasing',this.RAINBOW_TELEPHONYUNKNOW='Unknown',this.isTelephonyAvailable=function(){return r.started},this.getAgentVersion=function(){return r.agentStatus.agentVersion||'unknown'},this.getXMPPAgentStatus=function(){return r.agentStatus.xmppAgent||'unknown'},this.getPhoneAPIStatus=function(){return r.agentStatus.phoneApi||'unknown'},this.callByNumber=function(t){var a=e.defer();return t?r.makeCallByPhoneNumber(t).then(function(){a.resolve({code:o.OK,label:'OK'})}).catch(function(e){a.reject({code:o.ERROR,label:e})}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'strPhoneNumber\' is missing or empty'}),a.promise},this.calls=function(){return r.calls},this.release=function(t){var a=e.defer();return t?r.releaseCall(t).then(function(){a.resolve({code:o.OK,label:'OK'})}).catch(function(e){a.reject({code:o.ERROR,label:e})}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}),a.promise},this.deflectToVM=function(t){var a=e.defer();return t?r.deflectCallToVM(t).then(function(){a.resolve({code:o.OK,label:'OK'})}).catch(function(e){a.reject({code:o.ERROR,label:e})}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}),a.promise},this.forwardToDevice=function(t){var a=e.defer();return t&&'string'==typeof t&&0!==t.length?r.forwardToDevice(t).then(function(){a.resolve({code:o.OK,label:'OK'})}).catch(function(e){a.reject({code:o.ERROR,label:e})}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'strPhoneNumber\' is missing or empty'}),a.promise},this.forwardToVoicemail=function(){var t=e.defer();return r.forwardToVoicemail().then(function(){t.resolve({code:o.OK,label:'OK'})}).catch(function(e){t.reject({code:o.ERROR,label:e})}),t.promise},this.cancelForward=function(){var t=e.defer();return r.cancelForward().then(function(){t.resolve({code:o.OK,label:'OK'})}).catch(function(e){t.reject({code:o.ERROR,label:e})}),t.promise},this.getForwardStatusFromServer=function(){var t=e.defer();return r.getForwardStatus().then(function(){t.resolve({code:o.OK,label:'OK'})}).catch(function(e){t.reject({code:o.ERROR,label:e})}),t.promise},this.getForwardStatus=function(){return r.getForwardObject()},this.answer=function(t){var a=e.defer();return t?r.answerCall(t).then(function(){a.resolve({code:o.OK,label:'OK'})}).catch(function(e){a.reject({code:o.ERROR,label:e})}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}),a.promise},this.hold=function(t){var a=e.defer();return t?r.holdCall(t).then(function(){a.resolve({code:o.OK,label:'OK'})}).catch(function(e){a.reject({code:o.ERROR,label:e})}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}),a.promise},this.retrieve=function(t){var a=e.defer();return t?r.retrieveCall(t).then(function(){a.resolve({code:o.OK,label:'OK'})}).catch(function(e){a.reject({code:o.ERROR,label:e})}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}),a.promise},this.transfertCall=function(t,a){var n=e.defer();return t?a?r.transfertCall(t,a).then(function(){n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject({code:o.ERROR,label:e})}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'heldCall\' is missing or null'}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'activeCall\' is missing or null'}),n.promise},this.conferenceCall=function(t,a){var n=e.defer();return t?a?r.conferenceCall(t,a).then(function(){n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject({code:o.ERROR,label:e})}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'heldCall\' is missing or null'}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'activeCall\' is missing or null'}),n.promise};a.$on('$destroy',a.$on('ON_CALL_FORWARDED_EVENT',function(e,r){t.sdk(s+'[onForwardChange] :: Forward state changed to '+r),sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,r):$(document).trigger(i.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,[r])})),a.$on('$destroy',a.$on('ON_TELEPHONY_STATUS_CHANGED_EVENT',function(e,r){t.sdk(s+'[onChange   ] :: PBX state changed to '+r),'started'===r?sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONTELEPHONYSTARTED):$(document).trigger(i.RAINBOW_ONTELEPHONYSTARTED,null):sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONTELEPHONYSTOPPED):$(document).trigger(i.RAINBOW_ONTELEPHONYSTOPPED,null)})),a.$on('$destroy',a.$on('ON_CALL_UPDATED_EVENT',function(e,r){r.type.value===n.Type.PHONE.value&&(t.sdk(s+'[onTelChange] :: Telephony state changed to '+r),sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONTELEPHONYCALLSTATECHANGED,r):$(document).trigger(i.RAINBOW_ONTELEPHONYCALLSTATECHANGED,[r]))}))}])},function(){angular.module('sdk').service('conversationsService',['$q','$log','$rootScope','Conversation','conversationService','SDK',function(e,t,a,r,n,o){'use strict';var i=this,s='ConversSrv | ';this.RAINBOW_ONCONVERSATIONREMOVED='rainbowconversationremoved',this.RAINBOW_ONCONVERSATIONCHANGED='rainbowconversationchanged',this.RAINBOW_ONCONVERSATIONSCHANGED='rainbowconversationschanged',this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED='rainbowconversationsmissedcounterchanged';this.getAllConversations=function(){var e=n.getConversations(),t=[];return e.forEach(function(e){t.push(e)}),t},this.getCallById=function(e){if(!e)return{code:o.ERRORBADREQUEST,label:'Parameter \'strCallId\' is missing or empty'};var t=n.getConversations(),a=null;return t.forEach(function(t){t.videoCall&&t.videoCall.id===e?a=t.videoCall:t.audioCall&&t.audioCall.id===e&&(a=t.audioCall)}),a},this.getConversationById=function(e){return e?n.getConversationById(e):{code:o.ERRORBADREQUEST,label:'Parameter \'callId\' is missing or empty'}},this.getConversationByBubbleId=function(e){return e?n.getConversationByRoomDbId(e):{code:o.ERRORBADREQUEST,label:'Parameter \'strBubbleId\' is missing or empty'}},this.openConversationForContact=function(a){var r=e.defer();return a?(t.sdk(s+'[createConve] :: Try to create of get a conversation with '+a.lastname+' '+a.firstname),n.getOrCreateOneToOneConversation(a.jid).then(function(e){t.sdk(s+'[createConve] :: Conversation retrieved or created '+e.id),r.resolve(e)}).catch(function(e){t.sdk(s+'[createConve] :: Error'),r.reject(e)})):r.reject({code:o.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),r.promise},this.openConversationForBubble=function(a){var r=e.defer();return a?(t.sdk(s+'[createConve] :: Try to create or get a conversation for a bubble '+a.name+'('+a.id+')'),n.getRoomConversation(a.jid).then(function(e){t.sdk(s+'[createConve] :: Conversation retrieved or created '+e.id),r.resolve(e)}).catch(function(e){t.sdk(s+'[createConve] :: Error'),r.reject(e)})):r.reject({code:o.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'}),r.promise},this.closeConversation=function(t){var a=e.defer();return t?n.closeConversation(t).then(function(){a.resolve(null)}).catch(function(e){a.reject(e)}):a.reject({code:o.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}),a.promise},a.$on('$destroy',a.$on('ON_CONVERSATIONS_UPDATED_EVENT',function(e,t,n){void 0!==t&&void 0!==n&&(n!==r.EventType.NEW||(sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCONVERSATIONSCHANGED,t):$(document).trigger(i.RAINBOW_ONCONVERSATIONSCHANGED,[t])))})),a.$on('$destroy',a.$on('ON_CONVERSATION_REMOVE_EVENT',function(e,t){sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCONVERSATIONREMOVED,t):$(document).trigger(i.RAINBOW_ONCONVERSATIONREMOVED,[t])})),a.$on('$destroy',a.$on('ON_CONVERSATION_UPDATED_EVENT',function(e,t){sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCONVERSATIONCHANGED,t):$(document).trigger(i.RAINBOW_ONCONVERSATIONCHANGED,[t])})),a.$on('$destroy',a.$on('ON_MISSED_COUNTER_CHANGED_EVENT',function(e,t){sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,t):$(document).trigger(i.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,[t])}))}])},function(){angular.module('sdk').service('imService',['$q','$rootScope','$log','fileStorageService','conversationService','Conversation','Message','SDK',function(e,t,a,r,n,o,i,s){'use strict';var d=this;this.RAINBOW_ONNEWIMMESSAGERECEIVED='rainbownewimmessagereceived',this.RAINBOW_ONNEWIMRECEIPTRECEIVED='rainbownewimreceiptreceived',this.RAINBOW_ONNEWPARTICIPANTSTATUS='rainbownewparticipantstatus',this.getMessagesFromConversation=function(t,a){var r=e.defer();if(!t)r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'});else return a=a?Math.min(a,100):30,n.getHistoryPage(t,a);return r.promise},this.getMessageFromConversationById=function(e,t){if(!e)return{code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'};if(!t)return{code:s.ERRORBADREQUEST,label:'Parameter \'strMessageId\' is missing or empty'};var a=e.getMessageById(t);return a&&a.fileId&&(a.shortFileDescriptor=r.getFileDescriptorById(a.fileId)),a},this.getMessageFromBubbleById=function(e,t){if(!e)return{code:s.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'};if(!t)return{code:s.ERRORBADREQUEST,label:'Parameter \'strMessageId\' is missing or empty'};var a=n.getConversationByRoomDbId(e.dbId);if(!a)return{code:s.ERRORBADREQUEST,label:'Parameter \'bubble\' don\'t have a conversation'};if(a.type!==o.Type.ROOM)return{code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is not a bubble conversation'};var i=a.getMessageById(t);return i&&i.fileId&&(i.shortFileDescriptor=r.getFileDescriptorById(i.fileId)),i},this.sendMessageToConversation=function(e,t){return a.sdk('IMSrv      | '+'[sendMessage] :: Try to send a message...'),e?t?1024<t.length?{code:s.ERRORBADREQUEST,label:'Parameter \'strMessage\' should be lower than 1024 characters'}:n.sendChatMessage(e,t):{code:s.ERRORBADREQUEST,label:'Parameter \'strMessage\' is missing or empty'}:{code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}},this.sendIsTypingStateInConversation=function(t,a){var r=e.defer();return t?'boolean'==typeof a?(t=t.id?n.getConversationById(t.id):null,t?(n.sendIsTypingState(t,a),r.resolve()):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'conversation\': this conversation doesn\'t exist'})):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'status\' is missing or null'}):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}),r.promise},this.sendMessageToBubble=function(t,a){var r=e.defer();return t?a?1024<a.length?r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'strMessage\' should be lower than 1024 characters'}):n.getRoomConversation(t.jid).then(function(e){if(!e)r.reject({code:s.ERRORNOTFOUND,label:'No \'conversation\' found'});else{var t=n.sendChatMessage(e,a);r.resolve(t)}}):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'strMessage\' is missing or empty'}):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'}),r.promise},this.sendIsTypingStateInBubble=function(t,a){var r=e.defer();return t?'boolean'==typeof a?t.jid?n.getRoomConversation(t.jid).then(function(e){e?(n.sendIsTypingState(e,a),r.resolve()):r.reject({code:s.ERRORNOTFOUND,label:'No \'conversation\' found for this bubble'})}):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'bubble\': this bubble isn\'t a valid one'}):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'status\' is missing or null'}):r.reject({code:s.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'}),r.promise},this.removeAllMessagesFromConversation=function(t){var a=e.defer();return t?t.type===o.Type.ONE_TO_ONE?n.removeAllMessages(t).then(function(){a.resolve({code:s.OK,label:'OK'})}).catch(function(e){a.reject(e)}):a.reject({code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is not a one-to-one conversation'}):a.reject({code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}),a.promise},this.markMessageFromConversationAsRead=function(e,t){return t?e?t.receiptStatus===i.ReceiptStatus.READ?{code:s.ERRORBADREQUEST,label:'Parameter \'message\' is aldready marked as read'}:(e.sendAckReadMessage(t),t.receiptStatus===i.ReceiptStatus.READ&&n.decreaseMissedIMCounterForConversation(e),{code:s.OK,label:'OK'}):{code:s.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}:{code:s.ERRORBADREQUEST,label:'Parameter \'message\' is missing or empty'}},t.$on('$destroy',t.$on('ON_CONVERSATION_MESSAGE_RECEIVED',function(e,a,r,n){sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONNEWIMMESSAGERECEIVED,a,r,n):$(document).trigger(d.RAINBOW_ONNEWIMMESSAGERECEIVED,[a,r,n])})),t.$on('$destroy',t.$on('ON_CONVERSATION_RECEIPT_RECEIVED',function(e,a,r,n){sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONNEWIMRECEIPTRECEIVED,a,r,n):$(document).trigger(d.RAINBOW_ONNEWIMRECEIPTRECEIVED,[a,r,n])})),t.$on('$destroy',t.$on('ON_CONVERSATIONS_STATUS_MESSAGE_EVENT',function(e,a,r,n){n&&n.value&&(sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONNEWPARTICIPANTSTATUS,r,a,n.value):$(document).trigger(d.RAINBOW_ONNEWPARTICIPANTSTATUS,[r,a,n.value]))}))}])},function(){angular.module('sdk').service('webRTCService',['$q','$log','$rootScope','videoService','platformService','settingsService','xmppService','extensionSharingService','Call','webrtcGatewayService','recordsService','conversationService','SDK',function(e,t,a,r,n,o,i,s,d,c,l,p,u){'use strict';var m=this,g='webRTCSrv  | ';this.isChromeExtensionInstalled=!1,this.RAINBOW_ONWEBRTCCALLSTATECHANGED='rainbowonwebrtccallstatechanged',this.RAINBOW_ONWEBRTCMEDIADEVICECHANGED='rainbowonwebrtcmediadevicechanged',this.RAINBOW_ONWEBRTCERRORHANDLED='rainbowonwebrtcerrorhandled',this.RAINBOW_ONWEBRTCSTREAMADDED='rainbowonwebrtcstreamadded',this.RAINBOW_ONWEBRTCTRACKCHANGED='rainbowonwebrtctrackchanged',this.RAINBOW_ONWEBRTCTMEDIAERROROCCURED='rainbowonwebrtcmediaerroroccured',this.RAINBOW_ONWEBRTCTRECORDSTARTED='rainbowonwebrtcrecordstarted',this.RAINBOW_ONWEBRTCTRECORDSTOPPED='rainbowonwebrtcrecordstopped',this.RAINBOW_ONWEBRTCTRECORDPAUSED='rainbowonwebrtcrecordpaused',this.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED='rainbowonwebrtcrecordremotestarted',this.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED='rainbowonwebrtcrecordremotestopped',this.RAINBOW_ONWEBRTCTRECORDDONE='rainbowonwebrtcrecorddone',this.RAINBOW_ONWEBRTCTRECORDERROR='rainbowonwebrtcrecorderror',this.canMakeAudioVideoCall=function(){return'https:'===location.protocol&&DetectRTC.isWebRTCSupported&&DetectRTC.isGetUserMediaSupported},this.hasAMicrophone=function(){return DetectRTC.hasMicrophone},this.hasACamera=function(){return DetectRTC.hasWebcam},this.useMicrophone=function(e){return e?(o.setSetting('microphone',e),o.setSetting('headsetMicrophone',e),{code:u.OK,label:'OK'}):{code:u.ERRORBADREQUEST,label:'Parameter \'strMicrophoneId\' is missing or empty'}},this.useSpeaker=function(e){return e?(o.setSetting('speaker',e),o.setSetting('headsetSpeaker',e),o.setSetting('ringingSpeaker',e),n.setSpeakerForElement(document.getElementById('largevideo'),e),{code:u.OK,label:'OK'}):{code:u.ERRORBADREQUEST,label:'Parameter \'strSpeakerId\' is missing or empty'}},this.useCamera=function(e){return e?(o.setSetting('camera',e),{code:u.OK,label:'OK'}):{code:u.ERRORBADREQUEST,label:'Parameter \'strCameraId\' is missing or empty'}},this.callInAudio=function(e,t){return e?this.canMakeAudioVideoCall()?(r.makeCall(e,'audio',t),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}},this.callInVideo=function(e,t){return e?this.canMakeAudioVideoCall()?(r.makeCall(e,'video',t),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}},this.callInSharing=function(t,a){var n=e.defer();return t?this.canMakeDesktopSharingCall().then(function(){r.makeDesktopSharingCall(t,'sharingOnly',a),n.resolve({code:u.OK,label:'OK'})}).catch(function(e){n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),n.promise},this.callinAudioWithSharing=function(t,a){var n=e.defer();return t?this.canMakeDesktopSharingCall().then(function(){r.makeDesktopSharingCall(t,a),n.resolve({code:u.OK,label:'OK'})}).catch(function(e){n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),n.promise},this.answerInAudio=function(e){return e?this.canMakeAudioVideoCall()?(r.answerCall(e,'audio'),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}},this.answerInVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.answerCall(e,'video'),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}},this.getPeerConnectionForCall=function(e){if(!e)return{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'};if(!e.id)return{code:u.ERRORBADREQUEST,label:'Can not get the call ID'};var t=i.connection.jingle.sessions[e.id];return t.peerconnection},this.showLocalVideo=function(){return this.canMakeAudioVideoCall()?(r.attachLocalMediaStream(!0),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}},this.hideLocalVideo=function(){return this.canMakeAudioVideoCall()?(r.attachLocalMediaStream(!1),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}},this.showRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.attachDistantMediaStream(!0,e),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}},this.hideRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.attachDistantMediaStream(!1,e),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}},this.addVideoToCall=function(e){return this.canMakeAudioVideoCall()?(r.addVideoToCall(e,!1),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}},this.addSharingToCall=function(t){var a=e.defer();return this.canMakeDesktopSharingCall().then(function(){r.addSharingToCall(t),a.resolve({code:u.OK,label:'OK'})}).catch(function(e){a.reject(e)}),a.promise},this.removeVideoFromCall=function(e){return this.canMakeAudioVideoCall()?(r.removeVideoFromCall(e),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}},this.removeSharingFromCall=function(e){return this.canMakeAudioVideoCall()||this.isChromeExtensionInstalled?(r.removeSharingFromCall(e),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC or Sharing is not supported by your browser'}},this.release=function(e){return e?(this.canMakeAudioVideoCall()||t.warn('[webRTCService] release called but WebRTC is not supported by your browser'),r.rejectCall(e),{code:u.OK,label:'OK'}):{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'}},this.muteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteAudio(e,!0),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}},this.muteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteVideo(e,!0),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}},this.unmuteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteAudio(e,!1),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}},this.unmuteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteVideo(e,!1),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'}},this.getLocalStreamsFromCall=function(e){if(!e||!('id'in e))return{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or empty'};if(e.type!==d.Type.WEBRTC)return{code:u.ERRORNOTFOUND,label:'This call is not an audio or audio/video call'};var t=i.connection.jingle.sessions[e.id];return t?t.localStreams:[]},this.getRemoteStreamsFromCall=function(e){if(!e||!('id'in e))return{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or empty'};if(e.type!==d.Type.WEBRTC)return{code:u.ERRORNOTFOUND,label:'This call is not an audio or audio/video call'};var t=i.connection.jingle.sessions[e.id];return t?t.remoteStreams:[]},this.setChromeExtensionIdForSharing=function(e){return e?(s.setExtensionId(e),{code:u.OK,label:'OK'}):{code:u.ERRORBADREQUEST,label:'Parameter \'strExtensionId\' is missing or empty'}},this.canMakeDesktopSharingCall=function(){var t=e.defer();return s.isExtensionInstalled().then(function(e){e?(m.isChromeExtensionInstalled=!0,t.resolve({code:u.OK,label:'OK'})):(m.isChromeExtensionInstalled=!1,t.reject({code:u.ERRORUNSUPPORTED,label:'Not Chrome Extension installed for desktop sharing'}))}).catch(function(e){t.reject(e)}),t.promise},this.startRecording=function(e,r,n,o,i,s){if(t.sdk(g+'[startRecording] :: Enter'),!e)return{code:u.ERRORBADREQUEST,label:'Parameter \'call\' is missing or null'};if(!r)return{code:u.ERRORBADREQUEST,label:'Parameter \'fileName\' is missing or null'};n=void 0===n||null===n||n,o=void 0===o||null===o||o,i=void 0!==i&&null!==i&&i,s=void 0===s||null===s?'video/webm;codecs=vp9':s,t.sdk(g+'[startRecording] :: Prepare recording...');var d=l.createRecord(e.id,n?'REMOTE':'LOCAL',o,r,i,s);if(d){l.setOnPauseCallback(function(){t.sdk(g+'[onRTCChange] :: WebRTC recording paused'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDPAUSED):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDPAUSED,null)}),t.sdk(g+'[startRecording] :: Start recording...'),l.startRecording();var c=p.getConversationById(e.conversationId);return c?(t.sdk(g+'[startRecording] :: Notify remote peer',c),p.sendRecordingMessage(c,'start')):t.sdk(g+'[startRecording] :: No conversation found - can\'t notify remote peer'),t.sdk(g+'[startRecording] :: WebRTC recording started'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDSTARTED):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDSTARTED,null),{code:u.OK,label:'OK'}}return t.sdk(g+'[startRecording] :: can\'t start a webRTC recording'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDERROR):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDERROR,null),{code:u.ERRORBADREQUEST,label:'Can\'t record the conversation'}},this.stopRecording=function(e){t.sdk(g+'[stopRecording] :: Stop current WebRTC recording'),l.setOnPauseCallback(null),l.stopRecording();var r=p.getConversationById(e.conversationId);return r?(t.sdk(g+'[stopRecording] :: Notify remote peer',r),p.sendRecordingMessage(r,'stop')):t.sdk(g+'[stopRecording] :: No conversation found - can\'t notify remote peer'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDSTOPPED):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDSTOPPED,null),{code:u.OK,label:'OK'}},this.callUsingMediaPillar=function(e){return e?this.canMakeAudioVideoCall()?(c.mediaPillarMakeCall(e,null),{code:u.OK,label:'OK'}):{code:u.ERRORUNSUPPORTED,label:'WebRTC is not supported by your browser'}:{code:u.ERRORBADREQUEST,label:'Parameter \'number\' is missing or null'}};a.$on('$destroy',a.$on('ON_CALL_UPDATED_EVENT',function(e,r){r.type.value===d.Type.WEBRTC.value&&(t.sdk(g+'[onRTCChange] :: WebRTC state changed to '+r),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCCALLSTATECHANGED,r):$(document).trigger(m.RAINBOW_ONWEBRTCCALLSTATECHANGED,[r]))})),a.$on('$destroy',a.$on('ON_WEBRTC_CALL_ERROR_EVENT',function(e,r){t.sdk(g+'[onRTCError ] :: WebRTC Error'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCERRORHANDLED,r):$(document).trigger(m.RAINBOW_ONWEBRTCERRORHANDLED,[r])})),a.$on('$destroy',a.$on('ON_WEBRTC_REMOTE_STREAM_ADDED',function(e,r){t.sdk(g+'[onRTCStream] :: WebRTC remote stream added'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCSTREAMADDED,r):$(document).trigger(m.RAINBOW_ONWEBRTCSTREAMADDED,[r])})),a.$on('$destroy',a.$on('ON_WEBRTC_CALL_ESCALATION_SUCCESS',function(e,r){t.sdk(g+'[onRTCEsc   ] :: WebRTC Escalade'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRACKCHANGED,r):$(document).trigger(m.RAINBOW_ONWEBRTCTRACKCHANGED,[r])})),a.$on('$destroy',a.$on('ON_WEBRTC_GETUSERMEDIA_ERROR',function(e,r){t.sdk(g+'[onRTCError ] :: WebRTC getUserMedia error'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTMEDIAERROROCCURED,r):$(document).trigger(m.RAINBOW_ONWEBRTCMEDIAERROROCCURED,[r])})),a.$on('$destroy',a.$on('ON_WEBRTC_RECORD_SAVED',function(e,r,n,o){t.sdk(g+'[onRTCRec   ] :: WebRTC record received'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDDONE,r,n,o):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDDONE,[r,n,o])})),a.$on('$destroy',a.$on('ON_WEBRTC_RECORD_ERROR',function(){t.sdk(g+'[onRTCRec   ] :: WebRTC record error'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDERROR):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDERROR,null)})),a.$on('$destroy',a.$on('ON_RECORDING_START_MSG_RECEIVED',function(){t.sdk(g+'[onRTCRecRem] :: WebRTC record started by remote peer'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED,null)})),a.$on('$destroy',a.$on('ON_RECORDING_STOP_MSG_RECEIVED',function(){t.sdk(g+'[onRTCRecRem] :: WebRTC record stopped by remote peer'),sdk.useAngularEvents?a.$broadcast(m.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED):$(document).trigger(m.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED,null)}))}])},function(){angular.module('sdk').service('bubblesService',['$q','$rootScope','$log','roomService','Room','videoService','conversationService','contactService','conferenceService','profileService','webConferenceService','PromiseQueue','SDK',function(e,t,a,r,n,o,i,s,d,c,l,p,u){'use strict';var m=this,g='BubbleSrv  | ',v=null,f=null;this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED='rainbowbubblerequesttojoin',this.RAINBOW_ONBUBBLEUPDATED='rainbowbubbleupdated',this.RAINBOW_ONWEBCONFERENCEUPDATED='rainbowwebconferenceupdated',this.RAINBOW_ONWEBRTCMEDIAERROROCCURED='rainbowwebrtcmediaerroroccured',this.RAINBOW_ONBUBBLEAVATARUPDATED='rainbowbubbleavatarupdated',this.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED='rainbowbubbleconferencestartinvitation',this.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED='rainbowbubblesharingconferencestartinvitation',this.showLocalVideo=function(){return!1,o.attachLocalMediaStream(!0),{code:u.OK,label:'OK'}},this.createBubble=function(t,n,o,s,d){var c=e.defer(),l=null,p=!1;return o&&(p=!0),s=!!s,t?r.createRoom(t,n||'',p,d,s).then(function(e){return l=e,i.getRoomConversation(l.jid)}).then(function(e){a.sdk(g+'[create     ] :: New bubble '+t+' created successfully'),r.sendInitialRoomPresence(e.room),c.resolve(l)}).catch(function(e){a.sdk(g+'[create     ] :: Error when creating a bubble'),c.reject(e)}):c.reject({code:u.ERRORBADREQUEST,label:'Parameter \'strName\' is missing or empty'}),c.promise},this.deleteBubble=function(t){var a=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?this.closeBubble(t).then(function(e){return r.ownerDeleteRoom(e)}).then(function(e){a.resolve(e)}).catch(function(e){a.reject(e)}):a.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'}),a.promise},this.deleteAllBubbles=function(){var e=p.create(),t=r.getMyRooms();return t.forEach(function(t){e.add(function(){return m.deleteBubble(t)})}),e.execute()},this.inviteContactToBubble=function(t,o,i,s){var d=e.defer();if(o=o&&o.dbId?r.getRoomById(o.dbId):null,!t)d.reject({code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'});else if(!o)d.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'});else{var c=n.Privilege.USER;i&&(c=n.Privilege.MODERATOR);var l=!1;'boolean'==typeof s&&(l=!s);var p=!1,m=!1,v=!1,f=!1,S=!1;o.users.forEach(function(e){if(e.contact.id===t.id)switch(e.status){case'invited':v=!0;break;case'accepted':p=!0;break;case'unsubscribed':m=!0;break;case'rejected':f=!0;break;case'deleted':S=!0;break;default:}}),p||v?d.reject({code:u.ERRORBADREQUEST,label:'Contact has been already invited or is already a member of the room'}):m||f?r.ownerReinviteRejectedUser(o,t,null,c,l).then(function(e){e.updateAvatarInfo(),d.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when inviting a contact'),d.reject(e)}):S?r.ownerReinviteDeletedUser(o,t,null,c).then(function(e){e.updateAvatarInfo(),d.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when inviting a contact'),d.reject(e)}):r.addRoomUser(o,t,null,c,l).then(function(e){e.updateAvatarInfo(),d.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when inviting a contact'),d.reject(e)})}return d.promise},this.removeContactFromBubble=function(t,n){var o=e.defer();if(n=n&&n.dbId?r.getRoomById(n.dbId):null,!t)o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'});else if(!n)o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or is null'});else{var i='';switch(n.users.forEach(function(e){e.contact.id===t.id&&(i=e.status)}),i){case r.RoomUserStatus.INVITED:r.ownerDeletesUserFromRoom(n,t).then(function(e){e.updateAvatarInfo(),o.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when removing a contact'),o.reject(e)});break;case r.RoomUserStatus.ACCEPTED:r.unsubscribeUserFromRoom(n,t).then(function(e){e.updateAvatarInfo(),o.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when removing a contact'),o.reject(e)});break;default:o.resolve(n);}}return o.promise},this.promoteContactToModerator=function(t,n){var o=e.defer();return n=n&&n.dbId?r.getRoomById(n.dbId):null,t?n?r.updateRoomUser(n,t,null,'moderator').then(function(e){e.updateAvatarInfo(),o.resolve(e)}).catch(function(e){a.sdk(g+'[promote    ] :: Error when promoving a contact'),o.reject(e)}):o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or is null'}):o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),o.promise},this.demoteContactFromModerator=function(t,n){var o=e.defer();return n=n&&n.dbId?r.getRoomById(n.dbId):null,t?n?r.updateRoomUser(n,t,null,'user').then(function(e){e.updateAvatarInfo(),o.resolve(e)}).catch(function(e){a.sdk(g+'[demote     ] :: Error when demoting a contact'),o.reject(e)}):o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or is null'}):o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),o.promise},this.changeOwner=function(t,n){var o=e.defer();return n=n&&n.dbId?r.getRoomById(n.dbId):null,t?n?r.changeRoomOwner(n,t).then(function(e){e.updateAvatarInfo(),o.resolve(e)}).catch(function(e){a.sdk(g+'[changeOwner] :: Error when changing bubble owner'),o.reject(e)}):o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or is null'}):o.reject({code:u.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),o.promise},this.acceptInvitationToJoinBubble=function(t){var n=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?r.acceptRoomInvitation(t).then(function(){n.resolve(t)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when joining a bubble'),n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'}),n.promise},this.declineInvitationToJoinBubble=function(t){var n=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?r.declineRoomInvitation(t).then(function(e){n.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when joining a bubble'),n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'}),n.promise},this.leaveBubble=function(t){var n=e.defer();if(t=t&&t.dbId?r.getRoomById(t.dbId):null,!t)n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'});else{var o=!1;if(t.users.forEach(function(e){s.isUserContact(e)||'moderator'!==e.privilege||'accepted'!==e.status||(o=!0)}),o)switch(t.status){case r.RoomUserStatus.UNSUBSCRIBED:r.participantCloseRoom(t).then(function(e){n.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when leaving a bubble'),n.reject(e)});break;default:r.unsubscribeMeFromRoom(t).then(function(e){n.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when leaving a bubble'),n.reject(e)});}else n.reject({code:u.ERRORBADREQUEST,label:'Can\'t leave the bubble. No other moderator'})}return n.promise},this.closeBubble=function(t){var n=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?this.isBubbleArchived(t)?n.resolve(t):r.ownerArchiveRoom(t).then(function(e){n.resolve(e)}).catch(function(e){a.sdk(g+'[invite     ] :: Error when closing a bubble'),n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'}),n.promise},this.isBubbleArchived=function(e){var t=!0;return e=e&&e.dbId?r.getRoomById(e.dbId):null,e?e.status===r.RoomUserStatus.UNSUBSCRIBED?e.users.forEach(function(e){e.status!==r.RoomUserStatus.UNSUBSCRIBED&&e.status!==r.RoomUserStatus.DELETED&&(t=!1)}):t=!1:t=!1,t},this.getAllBubbles=function(){return r.getRooms()},this.getAllOwnedBubbles=function(){return r.getMyRooms()},this.getAllPendingBubbles=function(){var e=r.getRooms().filter(function(e){return'invited'===e.status});return e},this.getBubbleById=function(e){return e?r.getRoomById(e):{code:u.ERRORBADREQUEST,label:'Parameter \'strBubbleId\' is missing or empty'}},this.updateDescriptionForBubble=function(t,a){var n=e.defer();return a=a&&a.dbId?r.getRoomById(a.dbId):null,t?a?(a.desc=t,r.ownerUpdateRoom(a).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)})):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or empty'}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'strDescription\' is missing or empty'}),n.promise},this.updateAvatarForBubble=function(t,a){var n=e.defer();return a=a&&a.dbId?r.getRoomById(a.dbId):null,t?a?(a.id=a.dbId,r.setAvatarRoom(a,t).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)})):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or empty'}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'urlAvatar\' is missing or empty'}),n.promise},this.deleteAvatarFromBubble=function(t){var a=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?r.deleteAvatarRoom(t.dbId).then(function(e){a.resolve(e)}).catch(function(e){a.reject(e)}):a.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or empty'}),a.promise},this.updateCustomDataForBubble=function(t,a){var n=e.defer();return a=a&&a.dbId?r.getRoomById(a.dbId):null,t?a?(a.customData=t,r.ownerUpdateRoomCustomData(a).then(function(e){a.customData=e,n.resolve(a)}).catch(function(e){n.reject(e)})):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or empty'}):n.reject({code:u.ERRORBADREQUEST,label:'Parameter \'customData\' is missing or empty'}),n.promise},this.deleteCustomDataForBubble=function(t){var a=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?(t.customData={},r.ownerUpdateRoomCustomData(t).then(function(e){t.customData=e,a.resolve(t)}).catch(function(e){a.reject(e)})):a.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or empty'}),a.promise},this.isWebRtcConferenceAllowed=function(){return c.isFeatureEnabled(c.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)},this.hasActiveConferenceSession=function(){return!!l.hasActiveConferenceSession()},this.getWebRtcConferenceBubble=function(){return l.getRelatedRoomToActiveConferenceSession()},this.startOrJoinWebRtcConference=function(t){var a=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?this.hasActiveConferenceSession()?a.reject({code:u.ERROR,label:'Already in a conference'}):l.startOrJoinWebConference(t).then(function(){v=t,f='webrtc',a.resolve(r.getRoomById(t.dbId))}).catch(function(e){a.reject(e)}):a.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or empty'}),a.promise},this.addMediaToConferenceSession=function(e){return e?l.addMediaToConferenceSession(e,'video'):{code:u.ERROR,label:'Parameter \'conferenceSession\' is missing or empty'}},this.removeMediaFromConferenceSession=function(e){return e?(l.removeMediaFromConferenceSession(e,'video'),e):{code:u.ERROR,label:'Parameter \'conferenceSession\' is missing or empty'}},this.addLocalVideoStreamToConference=function(e){return e?(l.attachLocalMediaStream(!0,e),e):{code:u.ERROR,label:'Parameter \'conferenceSession\' is missing or empty'}},this.getConferenceSessionById=function(e){return e?l.getConferenceSessionById(e):{code:u.ERROR,label:'Parameter \'conferenceId\' is missing or empty'}},this.addDistantVideoStreamToConference=function(e){return e?(l.attachDistantMediaStream(!0,e),e):{code:u.ERROR,label:'Parameter \'conferenceSession\' is missing or empty'}},this.updateMainVideoSession=function(e,t){if(!e)defered.reject({code:u.ERRORBADREQUEST,label:'Parameter \'conferenceId\' is missing or empty'});else if(!t)defered.reject({code:u.ERRORBADREQUEST,label:'Parameter \'sessionId\' is missing or empty'});else return l.updateMainScreenSession(e,t),l.getConferenceSessionById(e)},this.startOrJoinSharingWebRtcConference=function(t){var a=e.defer();return t=t&&t.dbId?r.getRoomById(t.dbId):null,t?this.hasActiveConferenceSession()?a.reject({code:u.ERROR,label:'Already in a conference'}):l.startOrJoinSharingOnlyConference(t).then(function(){a.resolve(r.getRoomById(t.dbId)),v=t,f='sharing'}).catch(function(e){a.reject(e)}):a.reject({code:u.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or empty'}),a.promise},this.stopWebRtcConference=function(){var t=e.defer();if(v=v&&v.dbId?r.getRoomById(v.dbId):null,!this.hasActiveConferenceSession()||!v)t.reject({code:u.ERRORBADREQUEST,label:'No known conference in a Bubble'});else{var a='';a='webrtc'===f?v.getSFUConfEndpointId():v.getSFUSharingConfEndpointId();var n=l.getConferenceSessionById(a),o=n?n.getParticipantByJid(s.userContact.jid):null;'moderator'===o.role?d.stopConference(a,f,v.dbId).then(function(){v=null,f=null,t.resolve()}).catch(function(e){t.reject(e)}):d.disconnectsParticipant(a,o.participantId,f).then(function(){v=null,f=null,t.resolve()}).catch(function(e){t.reject(e)})}return t.promise},t.$on('$destroy',t.$on('ON_CONFERENCE_UPDATED_EVENT',function(e,a){sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONWEBCONFERENCEUPDATED,a):$(document).trigger(m.RAINBOW_ONWEBCONFERENCEUPDATED,[a])})),t.$on('$destroy',t.$on('ON_WEBRTC_GETUSERMEDIA_ERROR',function(e,a){sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONWEBRTCMEDIAERROROCCURED,a):$(document).trigger(m.RAINBOW_ONWEBRTCMEDIAERROROCCURED,[a])})),t.$on('$destroy',t.$on('ON_CONFERENCE_TALKER_EVENT',function(e,a){sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONWEBCONFERENCEUPDATED,a):$(document).trigger(m.RAINBOW_ONWEBCONFERENCEUPDATED,[a])})),t.$on('$destroy',t.$on('ON_CONFERENCE_PARTICIPANT_EVENT',function(e,a){sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONWEBCONFERENCEUPDATED,a):$(document).trigger(m.RAINBOW_ONWEBCONFERENCEUPDATED,[a])})),t.$on('$destroy',t.$on(r.ROOM_UPDATE_EVENT,function(e,a){sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONBUBBLEUPDATED,a):$(document).trigger(m.RAINBOW_ONBUBBLEUPDATED,[a])})),t.$on('$destroy',t.$on(r.ROOM_AVATAR_UPDATE_EVENT,function(e,a){sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONBUBBLEAVATARUPDATED,a):$(document).trigger(m.RAINBOW_ONBUBBLEAVATARUPDATED,[a])})),t.$on('$destroy',t.$on(r.ROOM_INVITATION,function(e,a){sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,a):$(document).trigger(m.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,[a])})),t.$on('$destroy',t.$on('ON_CONFERENCE_STARTED_INVITATION',function(e,a){var r=a.confEndpoints;r&&r.forEach(function(e){'webrtc'===e.mediaType&&(sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED,a):$(document).trigger(m.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED,[a])),'webrtcSharingOnly'===e.mediaType&&(sdk.useAngularEvents?t.$broadcast(m.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED,a):$(document).trigger(m.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED,[a]))})}))}])},function(){angular.module('sdk').service('groupsService',['$q','$rootScope','$log','groupService','Group','contactService','PromiseQueue','SDK',function(e,t,a,r,n,o,i,s){'use strict';var d=this,c='GroupSrv  | ';this.RAINBOW_ONGROUPCREATED='rainbowgroupcreated',this.RAINBOW_ONGROUPUPDATED='rainbowgroupupdated',this.RAINBOW_ONGROUPDELETED='rainbowgroupdeleted',this.RAINBOW_ONGROUPUSERADDED='rainbowgroupuseradded',this.RAINBOW_ONGROUPUSERREMOVED='rainbowgroupuserdeleted',this.createGroup=function(t,o,i){var d=e.defer(),l=null,p=!1;return'boolean'==typeof i&&(p=i),t?(l=new n(null,t,o||'',p),r.addGroup(l).then(function(e){a.sdk(c+'[create     ] :: New group '+t+' created successfully'),d.resolve(e)}).catch(function(e){a.sdk(c+'[create     ] :: Error when creating a group'),d.reject(e)})):d.reject({code:s.ERRORBADREQUEST,label:'Parameter \'strName\' is missing or empty'}),d.promise},this.deleteGroup=function(t){var n=e.defer();return t?r.removeGroup(t.id).then(function(){a.sdk(c+'[delete     ] :: Group deleted successfully'),n.resolve({code:s.OK,label:'OK'})}).catch(function(e){a.sdk(c+'[delete     ] :: Error when deleting a group'),n.reject(e)}):n.reject({code:s.ERRORBADREQUEST,label:'Parameter \'group\' is missing or empty'}),n.promise},this.deleteAllGroups=function(){var t=e.defer(),n=[],o=r.getGroupsAsArray(),i=function(e){return r.removeGroup(e.id)};return o.forEach(function(e){n.push(i(e))}),Promise.all(n).then(function(){a.sdk(c+'[deleteAll  ] :: All groups deleted successfully'),t.resolve({code:s.OK,label:'OK'})}).catch(function(e){a.sdk(c+'[deleteAll  ] :: Error when deleting all groups'),t.reject(e)}),t.promise},this.getAll=function(){return r.getGroupsAsArray()},this.getFavoritesGroups=function(){return r.getGroupsAsArray().filter(function(e){return e.isFavorite})},this.setGroupAsFavorite=function(t){var a=e.defer();return t.isFavorite=!0,r.updateGroup(t).then(function(){a.resolve(t)}).catch(function(e){a.reject(e)}),a.promise},this.unsetGroupAsFavorite=function(t){var a=e.defer();return t.isFavorite=!1,r.updateGroup(t).then(function(){a.resolve(t)}).catch(function(e){a.reject(e)}),a.promise},this.getGroupById=function(e){var t=null;return r.getGroupsAsArray().some(function(a){return e===a.id&&(t=a,!0)}),t},this.getDetailedGroupById=function(t){var a=e.defer();return t?r.getGroup(t).then(function(e){a.resolve(e)}).catch(function(e){a.reject(e)}):a.reject({code:s.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),a.promise},this.addContactInGroup=function(t,n){var o=e.defer(),i=this;return t?n?r.addGroupUser(n,t).then(function(e){a.sdk(c+'[addContactInGroup] :: contact added successfully'),o.resolve(e)}).catch(function(e){a.sdk(c+'[addContactInGroup] :: Error when adding a contact in a group'),o.reject(e)}):o.reject({code:s.ERRORBADREQUEST,label:'Parameter \'group\' is missing or null'}):o.reject({code:s.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'}),o.promise},this.removeContactFromGroup=function(t,a){var n=e.defer();if(!t)n.reject({code:s.ERRORBADREQUEST,label:'Parameter \'contact\' is missing or null'});else if(!a)n.reject({code:s.ERRORBADREQUEST,label:'Parameter \'group\' is missing or null'});else return r.removeGroupUser(a.id,t);return n.promise},t.$on('$destroy',t.$on(r.ON_UPDATE_GROUP_EVENT,function(e,a){r.getGroup(a).then(function(e){sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONGROUPUPDATED,e):$(document).trigger(d.RAINBOW_ONGROUPUPDATED,[e])}).catch(function(){})})),t.$on('$destroy',t.$on(r.ON_CREATED_GROUP_EVENT,function(e,a){r.getGroup(a).then(function(e){sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONGROUPCREATED,e):$(document).trigger(d.RAINBOW_ONGROUPCREATED,[e])}).catch(function(){})})),t.$on('$destroy',t.$on(r.ON_REMOVED_GROUP_EVENT,function(e,a){sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONGROUPDELETED,a):$(document).trigger(d.RAINBOW_ONGROUPDELETED,[a])})),t.$on('$destroy',t.$on(r.ON_ADD_GROUP_USER_EVENT,function(e,a,n){r.getGroup(a).then(function(e){sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONGROUPUSERADDED,e,n):$(document).trigger(d.RAINBOW_ONGROUPUSERADDED,[e,n])}).catch(function(){})})),t.$on('$destroy',t.$on(r.ON_REMOVE_GROUP_USER_EVENT,function(e,a,n){r.getGroup(a).then(function(e){sdk.useAngularEvents?t.$broadcast(d.RAINBOW_ONGROUPUSERREMOVED,e,n):$(document).trigger(d.RAINBOW_ONGROUPUSERREMOVED,[e,n])}).catch(function(){})}))}])},function(){angular.module('sdk').service('callsLogService',['$q','$rootScope','$log','callLogService',function(e,t,a,r){'use strict';var n=this,o=!1;this.RAINBOW_ONCALLLOGUPDATED='rainbowcalllogupdated',this.RAINBOW_ONCALLLOGACKUPDATED='rainbowcalllogackupdated',this.getAll=function(){r.orderCallLogsFunction();for(var e=r.getSimplifiedCallLogs(),t=0;t<e.length;t++){var a=0,n=e[t].duration;if(n&&'string'==typeof n&&n.match(/^(?:(?:([01]?\d|2[0-3])h )?([0-5]?\d)m )?([0-5]?\ds)$/)){n=n.replace(/[hms]/g,'');for(var o=n.split(' ').reverse(),i=0;i<o.length;i++)a+=o[i]*Math.pow(60,i);e[t].duration=1e3*a}}return e},this.getMissedCallLogCounter=function(){return r.getMissedCallLogCounter()},this.deleteOneCallLog=function(e){return r.deleteOneCallLog(e)},this.deleteCallLogsForContact=function(e){return r.deleteCallLogsForContact(e)},this.deleteAllCallLogs=function(){return r.deleteAllCallLogs()},this.markCallLogAsRead=function(e){return r.markCallLogAsRead(e)},this.markAllCallsLogsAsRead=function(){return r.markAllCallsLogsAsRead()},this.isInitialized=function(){return o},t.$on('$destroy',t.$on('ON_CALL_LOG_UPDATED',function(e,a){o=!0,sdk.useAngularEvents?t.$broadcast(n.RAINBOW_ONCALLLOGUPDATED,a):$(document).trigger(n.RAINBOW_ONCALLLOGUPDATED,[a])})),t.$on('$destroy',t.$on('ON_CALL_LOG_ACK_UPDATED',function(e,a){o=!0,sdk.useAngularEvents?t.$broadcast(n.RAINBOW_ONCALLLOGACKUPDATED,a):$(document).trigger(n.RAINBOW_ONCALLLOGACKUPDATED,[a])}))}])},function(){angular.module('sdk').service('cpaasService',['$q','$log','$rootScope','$http','SDK',function(e,t,a,r){'use strict';var n=this,o='CPaaSSrv   | ',i='',s='',d='',c='https',l='443',p='openrainbow.com';this.isAuthenticated=!1,this.hasSession=!1,this.RAINBOW_ONCPAAS_SESSION_CREATED='rainbowoncpaassessioncreated',this.authenticate=function(a,d,u){var m=e.defer();if(t.sdk(o+'[authent    ] :: Try to authenticate application '+a),0<a.length){var g=btoa(a+':'+d);u&&(p=u),r({method:'GET',url:c+'://'+p+':'+l+'/api/rainbow/applications/v1.0/authentication/login',headers:{Accept:'application/json',Authorization:'Basic '+g}}).success(function(e){t.sdk(o+'[authent    ] :: Authentication is successfull for application '+e.loggedInApplication.id),i=e.token,s=e.loggedInApplication.id,n.isAuthenticated=!0,m.resolve(e.data)}).error(function(e){t.sdk(o+'[authent    ] :: Authentication fails: '+e.errorDetails),m.resolve()})}else m.resolve();return m.promise},this.createSession=function(a,i){var m=e.defer();return t.sdk(o+'[session    ] :: Try to create a new session for userID'+a+' on app '+s),this.isAuthenticated?r({method:'POST',url:c+'://'+p+':'+l+'/api/v1.0/sdk/applications/'+s+'/sessions',headers:u(),data:{event:'session_start',data:{localUserURI:a,localUserSessionURI:i}}}).success(function(e){t.sdk(o+'[session    ] :: Session successfully created '+e.data.session.id),d=e.data.session.id,n.hasSession=!0,m.resolve(e.data)}).error(function(e){m.reject(e)}):t.sdk(o+'[session    ] :: Warning, the application is not authenticated. No way to track sessions...'),m.promise},this.appToken=function(){return i},this.updateSession=function(a){var n=e.defer();return t.sdk(o+'[session    ] :: Try to update information on the session '+d),this.isAuthenticated&&this.hasSession?r({method:'PUT',url:c+'://'+p+':'+l+'/api/v1.0/sdk/applications/'+s+'/sessions/'+d+'/info',headers:u(),data:{event:'session_info',data:a}}).success(function(e){t.sdk(o+'[session    ] :: Information successfully updated for session '+d),n.resolve(e.data)}).error(function(e){n.reject(e)}):t.sdk(o+'[session    ] :: Warning, the application is not authenticated. No way to track sessions...'),n.promise};var u=function(){return{"x-access-sdk-token":i,Accept:'application/json'}};a.$on('$destroy',function(){})}])},function(){angular.module('sdk').service('filesStorageService',['$q','$rootScope','$log','Conversation','fileStorageService','fileServerService','conversationService','contactService','SDK',function(e,t,a,r,n,o,i,s,d){'use strict';var c=this,l='StorageSrv   | ';this.RAINBOW_ONFILEUPLOADED='rainbowfileuploaded',this.RAINBOW_ONFILEUPLOADED_ERROR='rainbowfileuploadederror',this.RAINBOW_ONFILEDOWNLOADED='rainbowonfiledownloaded',this.RAINBOW_ONFILEDOWNLOADED_ERROR='rainbowfiledownloadederror',this.RAINBOW_ONCHUNKLOADMESSAGE='rainbowonchunkloadmessage';var p={success:{download:c.RAINBOW_ONFILEDOWNLOADED,upload:c.RAINBOW_ONFILEUPLOADED},error:{download:c.RAINBOW_ONFILEDOWNLOADED_ERROR,upload:c.RAINBOW_ONFILEUPLOADED_ERROR}};this._addFileToConversation=function(t,a,r){return e(function(n,o){return e(function(e){if('string'==typeof a){var t=new XMLHttpRequest;t.open('GET',a,!0),t.onreadystatechange=function(){if(t.readyState===XMLHttpRequest.DONE){var r=t.response,n=new File([r],a.replace(/^.*[\\\/]/,''));e(n)}},t.responseType='blob',t.send()}else e(a)}).then(function(e){1e8<e.size?o({code:d.ERRORBADREQUEST,label:'The file is too large (limited to 100MB)'}):i.sendFSMessage(t,e,r).then(function(e){n(e)})})})},this.uploadFileToConversation=function(e,t,n){return new Promise(function(o,i){e?t?e.type===r.Type.ONE_TO_ONE?(a.sdk(l+'[addFileCnv ] ::  Add file to the conversation '+e.id),c._addFileToConversation(e,t,n).then(function(e){a.sdk(l+'[addFileCnv ] ::  file added'),o(e)}).catch(function(e){i(e)})):i({code:d.ERRORBADREQUEST,label:'Parameter \'conversation\' is not a one-to-one conversation'}):i({code:d.ERRORBADREQUEST,label:'Parameter \'file\' is missing or null'}):i({code:d.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'})})},this.uploadFileToBubble=function(e,t,n){return new Promise(function(o,s){if(!e)s({code:d.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'});else if(!t)s({code:d.ERRORBADREQUEST,label:'Parameter \'file\' is missing or null'});else{var p=i.getConversationByRoomDbId(e.dbId);p?p.type===r.Type.ROOM?(a.sdk(l+'[addFileBub ] ::  Try to add a file '+t+' to the bubble '+e.dbId),c._addFileToConversation(p,t,n).then(function(e){a.sdk(l+'[addFileBub ] ::  file added'),o(e)}).catch(function(e){s(e)})):s({code:d.ERRORBADREQUEST,label:'Parameter \'conversation\' is not a bubble conversation'}):s({code:d.ERRORBADREQUEST,label:'Parameter \'bubble\' don\'t have a conversation'})}})},this.downloadFile=function(e){return new Promise(function(t,r){if(!e)r({code:d.ERRORBADREQUEST,label:'Parameter \'fileDescriptor\' is missing or null'});else{a.sdk(l+'[getFile    ] ::  Try to get a file '+e.fileName);({url:e.url||config.restServerUrl+'/api/rainbow/fileserver/v1.0/files/'+e.id,mime:e.mime||e.typeMIME,filesize:e.filesize||e.size,filename:e.filename||e.fileName});o.getBlobFromFileDescriptor(e,!0).then(function(e){a.sdk(l+'[getFile    ] ::  file downloaded'),t(e)}).catch(function(e){r(e)})}})},this.removeFile=function(e){return new Promise(function(t,r){if(e||r({code:d.ERRORBADREQUEST,label:'Parameter \'fileDescriptor\' is missing or null'}),!e.id&&!e.url)r({code:d.ERRORBADREQUEST,label:'Parameter \'fileDescriptor\' don\'t contain information to remove the file'});else{a.sdk(l+'[removeFile ] ::  Try to remove a file '+e.filename);var o=e.id;if(!o){var i=e.url.split('/');o=i.pop()||i.pop()}n.deleteFileDescriptor(o).then(function(){a.sdk(l+'[getFile    ] ::  file removed'),t({code:d.OK,label:'OK'})}).catch(function(e){r(e)})}})},this.getFileDescriptorFromId=function(e){return a.sdk(l+'[getFileDescriptorFromId] ::  get file descriptor '+e),n.getFileDescriptorById(e)},this.getFilesReceivedInConversation=function(e){return new Promise(function(t,o){e?e.type===r.Type.ONE_TO_ONE?(a.sdk(l+'[getFilesRcv] ::  get files received in conversation '+e.id+'...'),n.retrieveFilesReceivedFromPeer(s.userContact.dbId,e.contact.dbId).then(function(e){a.sdk(l+'[getFilesRcv] ::  shared '+e.length),t(e)}).catch(function(e){o(e)})):o({code:d.ERRORBADREQUEST,label:'Parameter \'conversation\' is not a one-to-one conversation'}):o({code:d.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'})})},this.getFilesReceivedInBubble=function(e){return new Promise(function(t,r){e?(a.sdk(l+'[getFilesRcv] ::  get files received in bubble '+e.dbId+'...'),n.retrieveReceivedFilesForRoom(e.dbId).then(function(e){a.sdk(l+'[getFilesRcv] ::  shared '+e.length),t(e)}).catch(function(e){r(e)})):r({code:d.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'})})},this.getFilesSentInConversation=function(e){return new Promise(function(t,o){e?e.type===r.Type.ONE_TO_ONE?(a.sdk(l+'[getFilesSnd] ::  get files sent in conversation '+e.id+'...'),n.retrieveSentFiles(e.contact.dbId).then(function(e){a.sdk(l+'[getFilesSnd] ::  shared '+e.length),t(e)}).catch(function(e){o(e)})):o({code:d.ERRORBADREQUEST,label:'Parameter \'conversation\' is not a one-to-one conversation'}):o({code:d.ERRORBADREQUEST,label:'Parameter \'conversation\' is missing or null'})})},this.getFilesSentInBubble=function(e){return new Promise(function(t,r){e?(a.sdk(l+'[getFilesRcv] ::  get files received in bubble '+e.dbId+'...'),n.retrieveSentFiles(e.dbId).then(function(e){a.sdk(l+'[getFilesSnd] ::  shared '+e.length),t(e)}).catch(function(e){r(e)})):r({code:d.ERRORBADREQUEST,label:'Parameter \'bubble\' is missing or null'})})},this.getUserQuotaConsumption=function(){return new Promise(function(e){n.retrieveUserConsumption().then(function(t){e(t)})})},this.getAllFilesSent=function(){return n.getDocuments()},this.getAllFilesReceived=function(){return n.getReceivedDocuments()},this.cancelCurrentFileTransfer=function(e){return new Promise(function(t,a){if(!e)a({code:d.ERRORBADREQUEST,label:'Parameter \'id\' is missing or null'});else{var r=n.getFileDescriptorById(e);null==r?a({code:d.ERRORBADREQUEST,label:'Could not find a file with the id '+e}):'downloading'!==r.state&&'uploading'!==r.state?a({code:d.ERRORBADREQUEST,label:'File Status is not set to \'downloading\' or \'uploading\''}):(o.cancelCurrentFiletransfer(e),'not_uploaded'!==r.state&&'uploading'!==r.state?(r.state='uploaded',t(r)):'not_uploaded'!==r.state&&'uploading'===r.state&&(r.state='not_uploaded',t(r)))}})};t.$on('$destroy',t.$on('ON_FILE_TRANSFER_EVENT',function(e,r){r.result&&r.type?(a.sdk(l+'[OnFileTrans] ::  file transfered...'),sdk.useAngularEvents?t.$broadcast(p[r.result][r.type],r):$(document).trigger(p[r.result][r.type],[r])):(r=r.fileDesc,('uploading'===r.state||'downloading'===r.state)&&(sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONCHUNKLOADMESSAGE,r):$(document).trigger(c.RAINBOW_ONCHUNKLOADMESSAGE,[r])))}))}])},function(){angular.module('sdk').service('capabilitiesService',['profileService',function(e){'use strict';this.getAll=function(){return e.getMyProfileFeatures()},this.hasS4BExtensionEnabled=function(){return e.isFeatureEnabled('MS_SKYPE_PLUGIN')},this.hasOutlookExtensionEnabled=function(){return e.isFeatureEnabled('MS_OUTLOOK_PLUGIN')},this.hasCalendarPresenceEnabled=function(){return e.isFeatureEnabled('MSO365_CALENDAR_PRESENCE')},this.hasTelephonyBasicCallEnabled=function(){return e.isFeatureEnabled('TELEPHONY_BASIC_CALL')},this.hasTelephonySecondCallEnabled=function(){return e.isFeatureEnabled('TELEPHONY_SECOND_CALL')},this.hasTelephonyTransferCallEnabled=function(){return e.isFeatureEnabled('TELEPHONY_TRANSFER_CALL')},this.hasTelephonyConferenceCallEnabled=function(){return e.isFeatureEnabled('TELEPHONY_CONFERENCE_CALL')},this.hasTelephonyDeflectCallEnabled=function(){return e.isFeatureEnabled('TELEPHONY_DEFLECT_CALL')},this.hasTelephonyForwardCallEnabled=function(){return e.isFeatureEnabled('TELEPHONY_FORWARD_CALL')},this.hasTelephonyPhoneBookEnabled=function(){return e.isFeatureEnabled('TELEPHONY_PHONE_BOOK')},this.hasTelephonyVoiceMailEnabled=function(){return e.isFeatureEnabled('TELEPHONY_VOICE_MAIL')},this.hasWebRTCAudioMobileEnabled=function(){return e.isFeatureEnabled('WEBRTC_FOR_MOBILE')},this.hasWebRTCVideoMobileEnabled=function(){return e.isFeatureEnabled('WEBRTC_FOR_MOBILE_VIDEO')},this.hasBridgeConferenceEnabled=function(){return e.isFeatureEnabled('CONFERENCE_ALLOWED')},this.hasBridgeConferenceRecordEnabled=function(){return e.isFeatureEnabled('CONFERENCE_RECORDING')},this.hasBridgeConferenceDialOutEnabled=function(){return e.isFeatureEnabled('CONFERENCE_DIAL_OUT')},this.maxParticipantsPerBubbleAllowed=function(){return e.getFeatureLimitMax('BUBBLE_PARTICIPANT_COUNT')},this.maxParticipantsPerBridgeConferenceAllowed=function(){return e.getFeatureLimitMax('CONFERENCE_PARTICIPANT_COUNT')},this.maxFileStorageQuotaAllowed=function(){return e.getFeatureLimitMax('FILE_SHARING_QUOTA_GB')}}])},function(){angular.module('sdk').service('adminService',['$q','$rootScope','$log','Company','User','adminCompanyService','adminUserService','SDK',function(e,t,a,r,n,o,i){'use strict';var s=this;this.createEssentialCompany=function(t,a){return e(function(e,n){var i=r.create(null,'');i.name=t,i.country=a,o.createCompanyEndUser(i).then(function(t){e(t)}).catch(function(e){n(e)})})},this.createCompany=function(t,a,n){return e(function(e,i){var s=r.create(null,'');s.name=t,s.country=a,n&&(s.state=n),s.economicActivityClassification='',o.createCompany(s).then(function(t){e(t)}).catch(function(e){i(e)})})},this.removeCompany=function(t){return e(function(e,a){o.deleteCompany(t.id).then(function(){e(t)}).catch(function(e){a(e)})})},this.createUserForCompany=function(t,a,r,o,s){return e(function(e,d){var c=n.create();c.loginEmail=t,c.firstName=a,c.lastName=r,c.password=o,c.language='en',c.companyId=s.id,c.adminType='undefined',c.isActive=!0,c.isInitialized=!0,i.createUser(c).then(function(t){e(t)}).catch(function(e){d(e)})})},this.removeUserFromCompany=function(t){return e(function(e,a){i.deleteUser(t).then(function(){e(t)}).catch(function(e){a(e)})})},this.setVisibilityForCompany=function(t,a){return e(function(e,r){o.addVisibility(t.id,a.id).then(function(){e(t)}).catch(function(e){r(e)})})},this.promoteCompanyToBP=function(t,a,r){return e(function(e,n){t.isBP=!0,t.bpType=a,t.bpBusinessModel='resell',t.bpApplicantNumber=r,t.bpCRDid=r,t.supportEmail='rford@sandbox.westworld.com',o.updateCompany(t).then(function(t){e(t)}).catch(function(e){n(e)})})}}])},function(){angular.module('sdk').service('channelsService',['$log','$q','$rootScope','channelService','contactService','SDK',function(e,t,a,r,n,o){'use strict';var i=this,s='ChannelsSrv| ';this.RAINBOW_ONCHANNELMESSAGERECEIVED='rainbowchannelmessagereceived',this.RAINBOW_ONCHANNELUPDATED='rainbowchannelupdate',this.RAINBOW_ONCHANNELDELETED='rainbowchanneldeleted',this.RAINBOW_ONCHANNELUSERSUPDATED='rainbowchannelusersupdate',this.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED='rainbowchannelretractmessage',this.RAINBOW_ONCHANNELAVATARUPDATED='rainbowchannelavatarupdate',this.RAINBOW_ONCHANNELUSERSUBSCRIBED='rainbowchannelusersubscribed',this.RAINBOW_ONCHANNELUSERUNSUBSCRIBED='rainbowchanneluserunsubscribed',this.getMyChannels=function(){return r.getMyChannels()},this.createChannel=function(a,n,i,d,c){var l=t.defer();if(e.sdk(s+'[createCha  ] :: Try to create a new channel...'),!a)l.reject({code:o.ERRORBADREQUEST,label:'Parameter \'channelName\' is missing or empty'});else{var p='company'===i?'company_public':'company_closed';d=d||100,n=n||'',c=c||'',r.createChannel(a,p,n,c,!1).then(function(t){e.sdk(s+'[createCha  ] :: created: '+t.id),l.resolve(t)}).catch(function(e){l.reject(e)})}return l.promise},this.createPublicChannel=function(a,n,i,d){var c=t.defer();if(e.sdk(s+'[createCha  ] :: Try to create a new public channel...'),!a)c.reject({code:o.ERRORBADREQUEST,label:'Parameter \'channelName\' is missing or empty'});else{i=i||100,n=n||'',d=d||'',r.createChannel(a,'company_public',n,d,!1).then(function(t){e.sdk(s+'[createCha  ] :: created: '+t.id),c.resolve(t)}).catch(function(e){c.reject(e)})}return c.promise},this.createPrivateChannel=function(a,n,i,d){var c=t.defer();if(e.sdk(s+'[createCha  ] :: Try to create a new private channel...'),!a)c.reject({code:o.ERRORBADREQUEST,label:'Parameter \'channelName\' is missing or empty'});else{i=i||100,n=n||'',d=d||'',r.createChannel(a,'company_closed',n,d,!1).then(function(t){e.sdk(s+'[createCha  ] :: created: '+t.id),c.resolve(t)}).catch(function(e){c.reject(e)})}return c.promise},this.deleteChannel=function(a){var n=t.defer();return(e.sdk(s+'[deleteCha  ] :: Try to delete a channel...'),!a)?n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}):(r.deleteChannel(a).then(function(){e.sdk(s+'[deleteCha  ] :: deleted: '+a),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}),n.promise)},this.findChannels=function(a){var n=t.defer();return e.sdk(s+'[findCha    ] :: Try to find channels...'),a?r.findChannels(a).then(function(t){e.sdk(s+'[findCha    ] :: found: '+t.length),n.resolve(t)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'filter\' is missing or empty'}),n.promise},this.getChannel=function(a){var n=t.defer();return e.sdk(s+'[getChannel ] :: Try to get a channel...'),a?r.getChannel(a).then(function(t){e.sdk(s+'[getChannel ] :: got: '+t.id),n.resolve(t)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),n.promise},this.publishToChannel=function(a,n,i,d,c){var l=t.defer();return e.sdk(s+'[publishTo  ] :: Try to publish a channel...'),a?n?c&&-1===['basic, markdown, html, data'].indexOf(c)?l.reject({code:o.ERRORBADREQUEST,label:'Parameter \'type\' could be \'basic\', \'markdown\', \'html\' or \'data\''}):(i=i||'',d=d||'',c=c?'urn:xmpp:channels:'+c:'urn:xmpp:channels:basic',r.publishToChannel(a.id,null,c,n,i,d).then(function(){e.sdk(s+'[publishTo  ] :: published: '+a.id),l.resolve({code:o.OK,label:'OK'})}).catch(function(e){l.reject(e)})):l.reject({code:o.ERRORBADREQUEST,label:'Parameter \'message\' is missing or empty'}):l.reject({code:o.ERRORBADREQUEST,label:'Parameter \'channel\' is missing or empty'}),l.promise},this.subscribeToChannelById=function(a){var n=t.defer();e.sdk(s+'[subscribeTo] :: Try to subscribe to a channel...'),a||n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or null'});var i=r.getChannelFromCache(a);return i?r.subscribeToChannel(i).then(function(){e.sdk(s+'[subscribeTo] :: subscribed: '+a),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}):r.getChannel(a).then(function(t){return t?void r.subscribeToChannel(t).then(function(){e.sdk(s+'[subscribeTo] :: subscribed: '+a),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'No channel found with id '+a})}),n.promise},this.subscribeToChannel=function(a){var n=t.defer();return e.sdk(s+'[subscribeTo] :: Try to subscribe to a channel...'),a?r.subscribeToChannel(a).then(function(){e.sdk(s+'[subscribeTo] :: subscribed: '+a.id),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'channel\' is missing or null'}),n.promise},this.unsubscribeFromChannelById=function(a){var n=t.defer();e.sdk(s+'[unsubscribe] :: Try to unsubscribe from a channel...'),a||n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});var i=r.getChannelFromCache(a);return i?r.unsubscribeToChannel(i).then(function(){e.sdk(s+'[unsubscribe] :: unsubscribed: '+a),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}):r.getChannel(a).then(function(t){return t?void r.unsubscribeToChannel(t).then(function(){e.sdk(s+'[unsubscribe] :: unsubscribed: '+a),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'No channel found with id '+a})}),n.promise},this.unsubscribeFromChannel=function(a){var n=t.defer();return e.sdk(s+'[unsubscribe] :: Try to unsubscribe from a channel...'),a?r.unsubscribeToChannel(a).then(function(){e.sdk(s+'[unsubscribe] :: unsubscribed: '+a.id),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'channel\' is missing or null'}),n.promise},this.updateChannel=function(a,n,i,d,c,l,p){var u=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to update a channel...'),!a)return u.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});var m={};return null!=n&&(m.topic=n),null!=i&&(m.mode='company'===i?'company_public':'company_closed'),null!=d&&(m.max_items=d),null!=c&&(m.max_payload_size=c),null!=l&&(m.name=l),null!=p&&(m.cateogry=p),r.updateChannel(a,m).then(function(t){t.visibility=m.visibility,e.sdk(s+'[updateCha  ] :: updated: '+a),u.resolve(t)}).catch(function(e){u.reject(e)}),u.promise},this.updateChannelVisibility=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to update visibility of a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else if(!n)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'visibility\' is missing or empty'});else{var d={};null!=n&&(d.mode='company'===n?'company_public':'company_closed'),r.updateChannel(a,d).then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.setChannelVisibilityToPublic=function(a){var n=t.defer();if(e.sdk(s+'[setChannel ] :: Try to update visibility to visible for a channel...'),!a)n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{r.updateChannel(a,{mode:'company_public'}).then(function(t){e.sdk(s+'[setChannel ] :: updated: '+a),n.resolve(t)}).catch(function(e){n.reject(e)})}return n.promise},this.setChannelVisibilityToPrivate=function(a){var n=t.defer();if(e.sdk(s+'[setChannel ] :: Try to update visibility to private for a channel...'),!a)n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{r.updateChannel(a,{mode:'company_closed'}).then(function(t){e.sdk(s+'[setChannel ] :: updated: '+a),n.resolve(t)}).catch(function(e){n.reject(e)})}return n.promise},this.updateChannelName=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to update the name of a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{var d={};null!=n&&(d.name=n),r.updateChannel(a,d).then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.updateChannelTopic=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to update the topic of a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{var d={};null!=n&&(d.topic=n),r.updateChannel(a,d).then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.updateChannelCategory=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to update the name of a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{var d={};null!=n&&(d.category=n),r.updateChannel(a,d).then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.uploadChannelAvatar=function(a,n){var i=t.defer();return e.sdk(s+'[uploadCha  ] :: Try to update the avatar of a channel...'),a?n?r.uploadChannelAvatar(a,n,512).then(function(){e.sdk(s+'[uploadCha  ] :: updated: '+a),i.resolve({code:o.OK,label:'OK'})}).catch(function(e){i.reject(e)}):i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'urlAvatar\' is missing or empty'}):i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),i.promise},this.deleteChannelAvatar=function(a){var n=t.defer();return e.sdk(s+'[deleteCha  ] :: Try to delete the avatar of a channel...'),a?r.deleteChannelAvatar(a).then(function(){e.sdk(s+'[deleteCha  ] :: updated: '+a),n.resolve({code:o.OK,label:'OK'})}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),n.promise},this.getChannelUsers=function(a,n){var i=t.defer();return e.sdk(s+'[getUsers   ] :: Try to get users of a channel...'),a?r.getChannelUsers(a,n).then(function(t){e.sdk(s+'[getUsers   ] :: got: '+a),i.resolve(t.data)}).catch(function(e){i.reject(e)}):i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),i.promise},this.removeAllUsersFromChannel=function(a){var n=t.defer();return e.sdk(s+'[removeAllUs] :: Try to get remove all users of a channel...'),a?r.removeAllUsersFromChannel(a).then(function(){return r.getChannel(a)}).then(function(t){e.sdk(s+'[removeAllUs] :: removed: '+a),n.resolve(t)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),n.promise},this.updateChannelUsers=function(a,n,i){var d=t.defer();return e.sdk(s+'[updateCha  ] :: Try to get updated users of a channel...'),a?(i=i||'member',r.updateChannelUsers(a,n,i).then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),d.resolve(t)}).catch(function(e){d.reject(e)})):d.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),d.promise},this.addMembersToChannel=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to add members to a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{r.updateChannelUsers(a,n,'member').then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.addPublishersToChannel=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to add publishers to a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{r.updateChannelUsers(a,n,'publisher').then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.addOwnersToChannel=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to add owners to a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{r.updateChannelUsers(a,n,'owner').then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.removeUsersFromChannel=function(a,n){var i=t.defer();if(e.sdk(s+'[updateCha  ] :: Try to remove users from a channel...'),!a)i.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'});else{r.updateChannelUsers(a,n,'none').then(function(t){e.sdk(s+'[updateCha  ] :: updated: '+a),i.resolve(t)}).catch(function(e){i.reject(e)})}return i.promise},this.getChannelItems=function(a,n,i,d){var c=t.defer();return e.sdk(s+'[getItems   ] :: Try to get messages of a channel...'),a?r.getChannelItems(a,n,i,d).then(function(t){e.sdk(s+'[getItems   ] :: got: '+a),c.resolve(t)}).catch(function(e){c.reject(e)}):c.reject({code:o.ERRORBADREQUEST,label:'Parameter \'id\' is missing or empty'}),c.promise};a.$on('$destroy',a.$on('CHANNEL_MESSAGE_RECEIVED',function(t,r,n){e.sdk(s+'[Channel    ] :: got a message'),i.getChannel(n.channelId).then(function(t){0===r?sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELMESSAGERECEIVED,t,n):$(document).trigger(i.RAINBOW_ONCHANNELMESSAGERECEIVED,[t,n]):(e.sdk(s+'[Channel    ] :: got a retracted message'),sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,t,n):$(document).trigger(i.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,[t,n]))})}));a.$on('$destroy',a.$on('CHANNEL_UPDATE_EVENT',function(t,r,n){e.sdk(s+'[Channel    ] :: channel updated ('+r+') id:'+n),3===r?sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELDELETED,n):$(document).trigger(i.RAINBOW_ONCHANNELDELETED,[n]):i.getChannel(n).then(function(e){sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELUPDATED,e,r):$(document).trigger(i.RAINBOW_ONCHANNELUPDATED,[e,r])})}));a.$on('$destroy',a.$on('CHANNEL_USERS_UPDATE_EVENT',function(t,r,n){e.sdk(s+'[Channel    ] :: channel users updated, id:'+r),i.getChannel(r).then(function(e){sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELUSERSUPDATED,e,n):$(document).trigger(i.RAINBOW_ONCHANNELUSERSUPDATED,[e,n])})}));a.$on('$destroy',a.$on('ON_UPDATE_CHANNEL_AVATAR',function(){i.getChannel(channelId).then(function(t){e.sdk(s+'[Channel    ] :: avatar updated for channel id:'+t.id),sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELAVATARUPDATED,t):$(document).trigger(i.RAINBOW_ONCHANNELAVATARUPDATED,[t])})}));a.$on('$destroy',a.$on('CHANNEL_USER_SUBSCRIPTION_EVENT',function(t,r,o,d){var c=null;i.getChannel(o).then(function(e){return c=e,n.getContactByDBId(d,!0)}).then(function(t){t=t||d,4===r?(e.sdk(s+'[Channel    ] :: user subscribed to a channel: '+o),sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELUSERSUBSCRIBED,c,t):$(document).trigger(i.RAINBOW_ONCHANNELUSERSUBSCRIBED,[c,t])):(e.sdk(s+'[Channel    ] :: user unsubscribed from a channel: '+o),sdk.useAngularEvents?a.$broadcast(i.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,c,t):$(document).trigger(i.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,[c,t]))})}))}])},function(){angular.module('sdk').service('rainbowSDK',['$log','$q','$rootScope','connectionService','presenceService','contactsService','conversationsService','imService','pbxService','webRTCService','bubblesService','groupsService','callsLogService','userProfileService','settingsService','cpaasService','filesStorageService','capabilitiesService','channelsService','adminService','SDK',function(e,t,a,r,n,o,i,s,d,c,l,p,u,m,g,v,f,S,C,h){'use strict';var E=this,R=null;this.isReady=!1,this.RAINBOW_ONREADY='ready',this.RAINBOW_ONLOADED='loaded',this.connection=r,this.presence=n,this.contacts=o,this.conversations=i,this.im=s,this.telephony=d,this.webRTC=c,this.bubbles=l,this.groups=p,this.callsLog=u,this.userProfile=m,this.fileStorage=f,this.caps=S,this.channels=C,this.admin=h,this.version=function(){return window.version},this.mode=function(){return g.getSetting('apiMode')},this.setVerboseLog=function(e){return sdk.hasVerboseLog=e,sdk.hasVerboseLog},this.useAngularEvents=function(e){return sdk.useAngularEvents=e,sdk.useAngularEvents},this.setKeyFromConfig=function(t,a){return e.sdk('SDKSrv     | [initialize ] :: Linked to application ID '+t+' from configuration file'),sdk.key.appID=t,sdk.key.appSecret=a,!0},this.hasBeenLaunchedFromConfig=function(t){var a=t?'YES':'NO';return e.sdk('SDKSrv     | [initialize ] :: SDK lauched from a configuration file '+a),sdk.hasBeenLaunchedFromConfig=t,sdk.hasBeenLaunchedFromConfig},this.initialize=function(a,r){var n=t.defer();return a&&0<a.length?(sdk.key.appID=a,e.sdk('SDKSrv     | [initialize ] :: Initialize the SDK for the application'+sdk.key.appID+'...')):e.sdk('SDKSrv     | [initialize ] :: Initialize the SDK without an application key...'),r&&0<r.length&&(sdk.key.appSecret=r),b().then(function(){e.sdk('SDKSrv     | [initialize ] :: Initialize step 1/2 ok'),y().then(function(){e.sdk('SDKSrv     | [initialize ] :: Initialize step 2/2 ok'),e.sdk('SDKSrv     | [initialize ] :: SDK Initialized successfully!'),n.resolve()})}),n.promise};var b=function(){var e=t.defer();if(!E.isReady)var r=a.$on('RAINBOW_INTERNAL_READY',function(){r(),e.resolve()});else e.resolve();return e.promise},y=function(){var e=t.defer();return DetectRTC.load(function(){T(),e.resolve()}),e.promise};this.load=function(){e.sdk('SDKSrv     | [initialize ] :: Rainbow SDK loaded!'),sdk.useAngularEvents?a.$broadcast(E.RAINBOW_ONLOADED):$(document).trigger(E.RAINBOW_ONLOADED,null)},this.ready=function(){e.sdk('SDKSrv     | [initialize ] :: Rainbow SDK ready!'),sdk.useAngularEvents?a.$broadcast(E.RAINBOW_ONREADY):$(document).trigger(E.RAINBOW_ONREADY,null)};var T=function(){e.sdk('SDKSrv     | [initialize ] :: Initializing the Rainbow SDK...'),e.sdk('SDKSrv     | [initialize ] :: -----------------------------'),e.sdk('SDKSrv     | [initialize ] :: Platform    | '+DetectRTC.osName+' '+DetectRTC.osVersion),e.sdk('SDKSrv     | [initialize ] :: Screen      | '+window.screen.width+'x'+window.screen.height),e.sdk('SDKSrv     | [initialize ] :: Cookie      | '+navigator.cookieEnabled),e.sdk('SDKSrv     | [initialize ] :: Java        | '+navigator.javaEnabled()),e.sdk('SDKSrv     | [initialize ] :: Server      | '+config.webservices.server),e.sdk('SDKSrv     | [initialize ] :: Version WEB | '+window.version),e.sdk('SDKSrv     | [initialize ] :: Version SDK | '+window.sdkversion),e.sdk('SDKSrv     | [initialize ] :: Browser     | '+DetectRTC.browser.name+' '+DetectRTC.browser.fullVersion),e.sdk('SDKSrv     | [initialize ] :: Microphone  | '+DetectRTC.hasMicrophone),e.sdk('SDKSrv     | [initialize ] :: Camera      | '+DetectRTC.hasWebcam),e.sdk('SDKSrv     | [initialize ] :: Speakers    | '+DetectRTC.hasSpeakers),e.sdk('SDKSrv     | [initialize ] :: WebRTC      | '+DetectRTC.isWebRTCSupported),e.sdk('SDKSrv     | [initialize ] :: Mode        | '+E.mode()),e.sdk('SDKSrv     | [initialize ] :: verboseLog  | '+sdk.hasVerboseLog),e.sdk('SDKSrv     | [initialize ] :: ng-events   | '+sdk.useAngularEvents),e.sdk('SDKSrv     | [initialize ] :: launcher    | '+sdk.hasBeenLaunchedFromConfig),e.sdk('SDKSrv     | [initialize ] :: appID       | '+sdk.key.appID),e.sdk('SDKSrv     | [initialize ] :: -----------------------------'),e.sdk('SDKSrv     | [initialize ] :: Initialized!'),E.ready()},I=function(){R();var e={browser:{name:DetectRTC.browser.name,fullVersion:DetectRTC.browser.fullVersion,version:DetectRTC.browser.version},screen:{displayResolution:DetectRTC.displayResolution},os:{name:DetectRTC.osName,version:DetectRTC.osVersion,isMobileDevice:!1},ua:navigator.userAgent};v.updateSession(e).then(function(){}).catch(function(){})};e.sdk('SDKSrv     | [           ] :: Welcome to the Rainbow SDK for Web!'),function(){window.rainbowSDK=E,g.setSetting('apiMode','sdk'),config.webservices.currentServer=config.webservices.server,R=a.$on(v.RAINBOW_ONCPAAS_SESSION_CREATED,I),E.isReady=!0,a.$broadcast('RAINBOW_INTERNAL_READY')}(),a.$on('$destroy',function(){R&&R()})}])},function(e,t,a){'use strict';function r(e,t,a){const r=e.match(t);return r&&r.length>=a&&parseInt(r[a],10)}function n(e,t,a){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return n.apply(this,arguments);const o=(t)=>{const e=a(t);e&&r(e)};return this._eventMap=this._eventMap||{},this._eventMap[r]=o,n.apply(this,[e,o])};const o=r.removeEventListener;r.removeEventListener=function(e,a){if(e!==t||!this._eventMap||!this._eventMap[a])return o.apply(this,arguments);const r=this._eventMap[a];return delete this._eventMap[a],o.apply(this,[e,r])},Object.defineProperty(r,'on'+t,{get(){return this['_on'+t]},set(e){this['_on'+t]&&(this.removeEventListener(t,this['_on'+t]),delete this['_on'+t]),e&&this.addEventListener(t,this['_on'+t]=e)},enumerable:!0,configurable:!0})}function o(e){return'boolean'==typeof e?(ae=e,e?'adapter.js logging disabled':'adapter.js logging enabled'):new Error('Argument type: '+typeof e+'. Please use a boolean.')}function i(e){return'boolean'==typeof e?(re=!e,'adapter.js deprecation warnings '+(e?'disabled':'enabled')):new Error('Argument type: '+typeof e+'. Please use a boolean.')}function s(){if('object'==typeof window){if(ae)return;'undefined'!=typeof console&&'function'==typeof console.log&&console.log.apply(console,arguments)}}function d(e,t){re&&console.warn(e+' is deprecated, please use '+t+' instead.')}function c(e){const{navigator:t}=e,a={browser:null,version:null};if('undefined'==typeof e||!e.navigator)return a.browser='Not a browser.',a;if(t.mozGetUserMedia)a.browser='firefox',a.version=r(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)a.browser='chrome',a.version=r(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))a.browser='edge',a.version=r(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(e.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))a.browser='safari',a.version=r(t.userAgent,/AppleWebKit\/(\d+)\./,1);else return a.browser='Not a supported browser.',a;return a}function l(e){return'object'==typeof e?Object.keys(e).reduce(function(t,a){const r='object'==typeof e[a],n=r?l(e[a]):e[a],o=r&&!Object.keys(n).length;return void 0===n||o?t:Object.assign(t,{[a]:n})},{}):e}function p(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const a=c(e),r=function(e){if('object'!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((a)=>{if('require'===a||'advanced'===a||'mediaSource'===a)return;const n='object'==typeof e[a]?e[a]:{ideal:e[a]};void 0!==n.exact&&'number'==typeof n.exact&&(n.min=n.max=n.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):'deviceId'===t?'sourceId':t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};'number'==typeof n.ideal?(e[r('min',a)]=n.ideal,t.optional.push(e),e={},e[r('max',a)]=n.ideal,t.optional.push(e)):(e[r('',a)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&'number'!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[r('',a)]=n.exact):['min','max'].forEach((e)=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,a)]=n[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(61<=a.version)return n(e);if(e=JSON.parse(JSON.stringify(e)),e&&'object'==typeof e.audio){const t=function(e,t,a){t in e&&!(a in e)&&(e[a]=e[t],delete e[t])};e=JSON.parse(JSON.stringify(e)),t(e.audio,'autoGainControl','googAutoGainControl'),t(e.audio,'noiseSuppression','googNoiseSuppression'),e.audio=r(e.audio)}if(e&&'object'==typeof e.video){let o=e.video.facingMode;o=o&&('object'==typeof o?o:{ideal:o});const i=66>a.version;if(o&&('user'===o.exact||'environment'===o.exact||'user'===o.ideal||'environment'===o.ideal)&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!i)){delete e.video.facingMode;let a;if('environment'===o.exact||'environment'===o.ideal?a=['back','rear']:('user'===o.exact||'user'===o.ideal)&&(a=['front']),a)return t.mediaDevices.enumerateDevices().then((t)=>{t=t.filter((e)=>'videoinput'===e.kind);let i=t.find((e)=>a.some((t)=>e.label.toLowerCase().includes(t)));return!i&&t.length&&a.includes('back')&&(i=t[t.length-1]),i&&(e.video.deviceId=o.exact?{exact:i.deviceId}:{ideal:i.deviceId}),e.video=r(e.video),ne('chrome: '+JSON.stringify(e)),n(e)})}e.video=r(e.video)}return ne('chrome: '+JSON.stringify(e)),n(e)},o=function(t){return 64<=a.version?t:{name:{PermissionDeniedError:'NotAllowedError',PermissionDismissedError:'NotAllowedError',InvalidStateError:'NotAllowedError',DevicesNotFoundError:'NotFoundError',ConstraintNotSatisfiedError:'OverconstrainedError',TrackStartError:'NotReadableError',MediaDeviceFailedDueToShutdown:'NotAllowedError',MediaDeviceKillSwitchOn:'NotAllowedError',TabCaptureError:'AbortError',ScreenCaptureError:'AbortError',DeviceCaptureError:'AbortError'}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString(){return this.name+(this.message&&': ')+this.message}}};t.getUserMedia=function(e,a,r){n(e,(e)=>{t.webkitGetUserMedia(e,a,(t)=>{r&&r(o(t))})})}.bind(t);const i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e,(e)=>i(e).then((t)=>{if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((e)=>{e.stop()}),new DOMException('','NotFoundError');return t},(t)=>Promise.reject(o(t))))}}function u(e,t){return e.navigator.mediaDevices&&'getDisplayMedia'in e.navigator.mediaDevices?void 0:e.navigator.mediaDevices?'function'==typeof t?void(e.navigator.mediaDevices.getDisplayMedia=function(a){return t(a).then((t)=>{const r=a.video&&a.video.width,n=a.video&&a.video.height,o=a.video&&a.video.frameRate;return a.video={mandatory:{chromeMediaSource:'desktop',chromeMediaSourceId:t,maxFrameRate:o||3}},r&&(a.video.mandatory.maxWidth=r),n&&(a.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(a)})}):void console.error('shimGetDisplayMedia: getSourceId argument is not a function'):void 0}function m(e,t,a){!t||a.has(t.id)||(a.set(t.id,t),Object.keys(t).forEach((r)=>{r.endsWith('Id')?m(e,e.get(t[r]),a):r.endsWith('Ids')&&t[r].forEach((t)=>{m(e,e.get(t),a)})}))}function g(e,t,a){const r=a?'outbound-rtp':'inbound-rtp',n=new Map;if(null===t)return n;const o=[];return e.forEach((e)=>{'track'===e.type&&e.trackIdentifier===t.id&&o.push(e)}),o.forEach((t)=>{e.forEach((a)=>{a.type===r&&a.trackId===t.id&&m(e,a,n)})}),n}function v(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function f(t){if('object'==typeof t&&t.RTCPeerConnection&&!('ontrack'in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,'ontrack',{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener('track',this._ontrack),this.addEventListener('track',this._ontrack=e)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=(a)=>{a.stream.addEventListener('addtrack',(e)=>{let r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t)=>t.track&&t.track.id===e.track.id):{track:e.track};const n=new Event('track');n.track=e.track,n.receiver=r,n.transceiver={receiver:r},n.streams=[a.stream],this.dispatchEvent(n)}),a.stream.getTracks().forEach((e)=>{let r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t)=>t.track&&t.track.id===e.id):{track:e};const n=new Event('track');n.track=e,n.receiver=r,n.transceiver={receiver:r},n.streams=[a.stream],this.dispatchEvent(n)})},this.addEventListener('addstream',this._ontrackpoly)),e.apply(this,arguments)}}else n(t,'track',(t)=>(t.transceiver||Object.defineProperty(t,'transceiver',{value:{receiver:t.receiver}}),t))}function S(e){if('object'==typeof e&&e.RTCPeerConnection&&!('getSenders'in e.RTCPeerConnection.prototype)&&'createDTMFSender'in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&('audio'===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const a=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e){let r=a.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const a=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],a.apply(this,[e]),e.getTracks().forEach((e)=>{this._senders.push(t(this,e))})};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e)=>{const t=this._senders.find((t)=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if('object'==typeof e&&e.RTCPeerConnection&&'getSenders'in e.RTCPeerConnection.prototype&&'createDTMFSender'in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!('dtmf'in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e)=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,'dtmf',{get(){return void 0===this._dtmf&&('audio'===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function C(e){if(!('object'==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!('getStats'in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e)=>e._pc=this),e});const a=e.RTCPeerConnection.prototype.addTrack;a&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=a.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t)=>g(t,e.track,!0))}}if(!('getStats'in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e)=>e._pc=this),e}),n(e,'track',(t)=>(t.receiver._pc=t.srcElement,t)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t)=>g(t,e.track,!1))}}if(!('getStats'in e.RTCRtpSender.prototype&&'getStats'in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,a,n;return(this.getSenders().forEach((a)=>{a.track===e&&(t?n=!0:t=a)}),this.getReceivers().forEach((t)=>(t.track===e&&(a?n=!0:a=t),t.track===e)),n||t&&a)?Promise.reject(new DOMException('There are more than one sender or receiver for the track.','InvalidAccessError')):t?t.getStats():a?a.getStats():Promise.reject(new DOMException('There is no sender or receiver for the track.','InvalidAccessError'))}return t.apply(this,arguments)}}function h(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e)=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,a){if(!a)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[a.id]?-1===this._shimmedLocalStreams[a.id].indexOf(r)&&this._shimmedLocalStreams[a.id].push(r):this._shimmedLocalStreams[a.id]=[a,r],r};const a=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e)=>{const t=this.getSenders().find((t)=>t.track===e);if(t)throw new DOMException('Track already exists.','InvalidAccessError')});const t=this.getSenders();a.apply(this,arguments);const r=this.getSenders().filter((e)=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t)=>{const a=this._shimmedLocalStreams[t].indexOf(e);-1!==a&&this._shimmedLocalStreams[t].splice(a,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),n.apply(this,arguments)}}function E(e){function t(e,t){let a=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t)=>{const r=e._reverseStreams[t],n=e._streams[r.id];a=a.replace(new RegExp(n.id,'g'),r.id)}),new RTCSessionDescription({type:t.type,sdp:a})}function a(e,t){let a=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t)=>{const r=e._reverseStreams[t],n=e._streams[r.id];a=a.replace(new RegExp(r.id,'g'),n.id)}),new RTCSessionDescription({type:t.type,sdp:a})}if(!e.RTCPeerConnection)return;const r=c(e);if(e.RTCPeerConnection.prototype.addTrack&&65<=r.version)return h(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e)=>this._reverseStreams[e.id])};const o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e)=>{const t=this.getSenders().find((t)=>t.track===e);if(t)throw new DOMException('Track already exists.','InvalidAccessError')}),!this._reverseStreams[t.id]){const a=new e.MediaStream(t.getTracks());this._streams[t.id]=a,this._reverseStreams[a.id]=t,t=a}o.apply(this,[t])};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(a,t){if('closed'===this.signalingState)throw new DOMException('The RTCPeerConnection\'s signalingState is \'closed\'.','InvalidStateError');const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find((e)=>e===a))throw new DOMException('The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.','NotSupportedError');const n=this.getSenders().find((e)=>e.track===a);if(n)throw new DOMException('Track already exists.','InvalidAccessError');this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[t.id];if(o)o.addTrack(a),Promise.resolve().then(()=>{this.dispatchEvent(new Event('negotiationneeded'))});else{const r=new e.MediaStream([a]);this._streams[t.id]=r,this._reverseStreams[r.id]=t,this.addStream(r)}return this.getSenders().find((e)=>e.track===a)},['createOffer','createAnswer'].forEach(function(a){const r=e.RTCPeerConnection.prototype[a];e.RTCPeerConnection.prototype[a]=function(){const e=arguments,a=arguments.length&&'function'==typeof arguments[0];return a?r.apply(this,[(a)=>{const r=t(this,a);e[0].apply(null,[r])},(t)=>{e[1]&&e[1].apply(null,t)},arguments[2]]):r.apply(this,arguments).then((e)=>t(this,e))}});const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=a(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const d=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,'localDescription');Object.defineProperty(e.RTCPeerConnection.prototype,'localDescription',{get(){const e=d.get.apply(this);return''===e.type?e:t(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if('closed'===this.signalingState)throw new DOMException('The RTCPeerConnection\'s signalingState is \'closed\'.','InvalidStateError');if(!e._pc)throw new DOMException('Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.','TypeError');const t=e._pc===this;if(!t)throw new DOMException('Sender was not created by this connection.','InvalidAccessError');this._streams=this._streams||{};let a;Object.keys(this._streams).forEach((t)=>{const r=this._streams[t].getTracks().find((t)=>e.track===t);r&&(a=this._streams[t])}),a&&(1===a.getTracks().length?this.removeStream(this._reverseStreams[a.id]):a.removeTrack(e.track),this.dispatchEvent(new Event('negotiationneeded')))}}function R(e){if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,a,r){const n=arguments;if(0<arguments.length&&'function'==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||'function'!=typeof arguments[0]))return t.apply(this,[]);const o=function(e){const t={},a=e.result();return a.forEach((e)=>{const a={id:e.id,timestamp:e.timestamp,type:{localcandidate:'local-candidate',remotecandidate:'remote-candidate'}[e.type]||e.type};e.names().forEach((t)=>{a[t]=e.stat(t)}),t[a.id]=a}),t},i=function(e){return new Map(Object.keys(e).map((t)=>[t,e[t]]))};if(2<=arguments.length){return t.apply(this,[function(e){n[1](i(o(e)))},arguments[0]])}return new Promise((e,a)=>{t.apply(this,[function(t){e(i(o(t)))},a])}).then(a,r)},['setLocalDescription','setRemoteDescription','addIceCandidate'].forEach(function(t){const a=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new('addIceCandidate'===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}});const a=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?a.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function b(e){n(e,'negotiationneeded',(t)=>{const e=t.target;return'stable'===e.signalingState?t:void 0})}function y(e){let t=!1;return e=JSON.parse(JSON.stringify(e)),e.filter((e)=>{if(e&&(e.urls||e.url)){var a=e.urls||e.url;e.url&&!e.urls&&d('RTCIceServer.url','RTCIceServer.urls');const r='string'==typeof a;return r&&(a=[a]),a=a.filter((e)=>{if(0===e.indexOf('stun:'))return!1;const a=e.startsWith('turn')&&!e.startsWith('turn:[')&&e.includes('transport=udp');return a&&!t?(t=!0,!0):a&&!t}),delete e.url,e.urls=r?a[0]:a,!!a.length}})}function T(e){const t=e&&e.navigator,a=function(t){return{name:{PermissionDeniedError:'NotAllowedError'}[t.name]||t.name,message:t.message,constraint:t.constraint,toString(){return this.name}}},r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch((t)=>Promise.reject(a(t)))}}function I(e){!('getDisplayMedia'in e.navigator)||!e.navigator.mediaDevices||e.navigator.mediaDevices&&'getDisplayMedia'in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator.mediaDevices))}function N(e){const t=c(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),15025>t.version)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,'enabled');Object.defineProperty(e.MediaStreamTrack.prototype,'enabled',{set(e){t.set.call(this,e);const a=new Event('enabled');a.enabled=e,this.dispatchEvent(a)}})}e.RTCRtpSender&&!('dtmf'in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,'dtmf',{get(){return void 0===this._dtmf&&('audio'===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):'video'===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const a=ie()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=y(e.iceServers,t.version),s('ICE servers after filtering:',e.iceServers)),new a(e)},e.RTCPeerConnection.prototype=a.prototype}function A(e){e.RTCRtpSender&&!('replaceTrack'in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}function O(e){const t=c(e),a=e&&e.navigator,r=e&&e.MediaStreamTrack;if(a.getUserMedia=function(e,t,r){d('navigator.getUserMedia','navigator.mediaDevices.getUserMedia'),a.mediaDevices.getUserMedia(e).then(t,r)},!(55<t.version&&'autoGainControl'in a.mediaDevices.getSupportedConstraints())){const e=function(e,t,a){t in e&&!(a in e)&&(e[a]=e[t],delete e[t])},t=a.mediaDevices.getUserMedia.bind(a.mediaDevices);if(a.mediaDevices.getUserMedia=function(a){return'object'==typeof a&&'object'==typeof a.audio&&(a=JSON.parse(JSON.stringify(a)),e(a.audio,'autoGainControl','mozAutoGainControl'),e(a.audio,'noiseSuppression','mozNoiseSuppression')),t(a)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const a=t.apply(this,arguments);return e(a,'mozAutoGainControl','autoGainControl'),e(a,'mozNoiseSuppression','noiseSuppression'),a}}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(a){return'audio'===this.kind&&'object'==typeof a&&(a=JSON.parse(JSON.stringify(a)),e(a,'autoGainControl','mozAutoGainControl'),e(a,'noiseSuppression','mozNoiseSuppression')),t.apply(this,[a])}}}}function P(e,t){e.navigator.mediaDevices&&'getDisplayMedia'in e.navigator.mediaDevices||!e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=function(a){if(!(a&&a.video)){const e=new DOMException('getDisplayMedia without video constraints is undefined');return e.name='NotFoundError',e.code=8,Promise.reject(e)}return!0===a.video?a.video={mediaSource:t}:a.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(a)})}function D(e){'object'==typeof e&&e.RTCTrackEvent&&'receiver'in e.RTCTrackEvent.prototype&&!('transceiver'in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,'transceiver',{get(){return{receiver:this.receiver}}})}function _(e){const t=c(e);if('object'!=typeof e||!(e.RTCPeerConnection||e.mozRTCPeerConnection))return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),['setLocalDescription','setRemoteDescription','addIceCandidate'].forEach(function(t){const a=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new('addIceCandidate'===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}});const a=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?a.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};const r={inboundrtp:'inbound-rtp',outboundrtp:'outbound-rtp',candidatepair:'candidate-pair',localcandidate:'local-candidate',remotecandidate:'remote-candidate'},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,a,o){return n.apply(this,[e||null]).then((n)=>{if(53>t.version&&!a)try{n.forEach((e)=>{e.type=r[e.type]||e.type})}catch(t){if('TypeError'!==t.name)throw t;n.forEach((e,t)=>{n.set(t,Object.assign({},e,{type:r[e.type]||e.type}))})}return n}).then(a,o)}}function M(e){if(!('object'==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender))return;if(e.RTCRtpSender&&'getStats'in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e)=>e._pc=this),e});const a=e.RTCPeerConnection.prototype.addTrack;a&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=a.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function w(e){if(!('object'==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender))return;if(e.RTCRtpSender&&'getStats'in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e)=>e._pc=this),e}),n(e,'track',(t)=>(t.receiver._pc=t.srcElement,t)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function U(e){!e.RTCPeerConnection||'removeStream'in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){d('removeStream','removeTrack'),this.getSenders().forEach((t)=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function L(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function F(e){if('object'==typeof e&&e.RTCPeerConnection){if('getLocalStreams'in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!('addStream'in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getTracks().forEach((a)=>t.call(this,a,e))},e.RTCPeerConnection.prototype.addTrack=function(e,a){return a&&(this._localStreams?!this._localStreams.includes(a)&&this._localStreams.push(a):this._localStreams=[a]),t.call(this,e,a)}}'removeStream'in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const a=e.getTracks();this.getSenders().forEach((e)=>{a.includes(e.track)&&this.removeTrack(e)})})}}function k(e){if('object'==typeof e&&e.RTCPeerConnection&&('getRemoteStreams'in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!('onaddstream'in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,'onaddstream',{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener('addstream',this._onaddstream),this.removeEventListener('track',this._onaddstreampoly)),this.addEventListener('addstream',this._onaddstream=e),this.addEventListener('track',this._onaddstreampoly=(t)=>{t.streams.forEach((e)=>{if(this._remoteStreams||(this._remoteStreams=[]),!this._remoteStreams.includes(e)){this._remoteStreams.push(e);const t=new Event('addstream');t.stream=e,this.dispatchEvent(t)}})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener('track',this._onaddstreampoly=function(t){t.streams.forEach((t)=>{if(e._remoteStreams||(e._remoteStreams=[]),!(0<=e._remoteStreams.indexOf(t))){e._remoteStreams.push(t);const a=new Event('addstream');a.stream=t,e.dispatchEvent(a)}})}),t.apply(e,arguments)}}}function B(e){if('object'!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,a=t.createOffer,r=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,i=t.addIceCandidate;t.createOffer=function(e,t){const r=2<=arguments.length?arguments[2]:arguments[0],n=a.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const a=2<=arguments.length?arguments[2]:arguments[0],n=r.apply(this,[a]);return t?(n.then(e,t),Promise.resolve()):n};let s=function(e,t,a){const r=n.apply(this,[e]);return a?(r.then(t,a),Promise.resolve()):r};t.setLocalDescription=s,s=function(e,t,a){const r=o.apply(this,[e]);return a?(r.then(t,a),Promise.resolve()):r},t.setRemoteDescription=s,s=function(e,t,a){const r=i.apply(this,[e]);return a?(r.then(t,a),Promise.resolve()):r},t.addIceCandidate=s}function x(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,a=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=(e)=>a(H(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,a,r){t.mediaDevices.getUserMedia(e).then(a,r)}.bind(t))}function H(e){return e&&void 0!==e.video?Object.assign({},e,{video:l(e.video)}):e}function G(e){const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,a){if(e&&e.iceServers){const t=[];for(let a=0,r;a<e.iceServers.length;a++)r=e.iceServers[a],!r.hasOwnProperty('urls')&&r.hasOwnProperty('url')?(d('RTCIceServer.url','RTCIceServer.urls'),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,t.push(r)):t.push(e.iceServers[a]);e.iceServers=t}return new t(e,a)},e.RTCPeerConnection.prototype=t.prototype,'generateCertificate'in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,'generateCertificate',{get(){return t.generateCertificate}})}function V(e){'object'==typeof e&&e.RTCPeerConnection&&'receiver'in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,'transceiver',{get(){return{receiver:this.receiver}}})}function j(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){'undefined'!=typeof e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e)=>e.sender.track&&'audio'===e.sender.track.kind);!1===e.offerToReceiveAudio&&t?'sendrecv'===t.direction?t.setDirection?t.setDirection('sendonly'):t.direction='sendonly':'recvonly'===t.direction&&(t.setDirection?t.setDirection('inactive'):t.direction='inactive'):!0===e.offerToReceiveAudio&&!t&&this.addTransceiver('audio'),'undefined'!=typeof e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const a=this.getTransceivers().find((e)=>e.sender.track&&'video'===e.sender.track.kind);!1===e.offerToReceiveVideo&&a?'sendrecv'===a.direction?a.setDirection?a.setDirection('sendonly'):a.direction='sendonly':'recvonly'===a.direction&&(a.setDirection?a.setDirection('inactive'):a.direction='inactive'):!0===e.offerToReceiveVideo&&!a&&this.addTransceiver('video')}return t.apply(this,arguments)}}function W(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&'foundation'in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(t){if('object'==typeof t&&t.candidate&&0===t.candidate.indexOf('a=')&&(t=JSON.parse(JSON.stringify(t)),t.candidate=t.candidate.substr(2)),t.candidate&&t.candidate.length){const a=new e(t),r=de.a.parseCandidate(t.candidate),n=Object.assign(a,r);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new e(t)},t.RTCIceCandidate.prototype=e.prototype,n(t,'icecandidate',(a)=>(a.candidate&&Object.defineProperty(a,'candidate',{value:new t.RTCIceCandidate(a.candidate),writable:'false'}),a))}function q(e){if(e.RTCSctpTransport||!e.RTCPeerConnection)return;const t=c(e);'sctp'in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,'sctp',{get(){return'undefined'==typeof this._sctp?null:this._sctp}});const a=function(e){const t=de.a.splitSections(e.sdp);return t.shift(),t.some((e)=>{const t=de.a.parseMLine(e);return t&&'application'===t.kind&&-1!==t.protocol.indexOf('SCTP')})},r=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||2>t.length)return-1;const a=parseInt(t[1],10);return a===a?a:-1},n=function(e){let a=65536;return'firefox'===t.browser&&(57>t.version?-1===e?a=16384:a=2147483637:60>t.version?a=57===t.version?65535:65536:a=2147483637),a},o=function(e,a){let r=65536;'firefox'===t.browser&&57===t.version&&(r=65535);const n=de.a.matchPrefix(e.sdp,'a=max-message-size:');return 0<n.length?r=parseInt(n[0].substr(19),10):'firefox'===t.browser&&-1!==a&&(r=2147483637),r},i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,a(arguments[0])){const e=r(arguments[0]),t=n(e),a=o(arguments[0],e);let i=0===t&&0===a?Number.POSITIVE_INFINITY:0===t||0===a?Math.max(t,a):Math.min(t,a);const s={};Object.defineProperty(s,'maxMessageSize',{get(){return i}}),this._sctp=s}return i.apply(this,arguments)}}function J(e){function t(e,t){const a=e.send;e.send=function(){const r=arguments[0],n=r.length||r.size||r.byteLength;if('open'===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError('Message too large (can send a maximum of '+t.sctp.maxMessageSize+' bytes)');return a.apply(e,arguments)}}if(!(e.RTCPeerConnection&&'createDataChannel'in e.RTCPeerConnection.prototype))return;const a=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=a.apply(this,arguments);return t(e,this),e},n(e,'datachannel',(a)=>(t(a.channel,a.target),a))}function K(e){if(!e.RTCPeerConnection||'connectionState'in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,'connectionState',{get(){return{completed:'connected',checking:'connecting'}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,'onconnectionstatechange',{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener('connectionstatechange',this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener('connectionstatechange',this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),['setLocalDescription','setRemoteDescription'].forEach((e)=>{const a=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=(t)=>{const e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;const a=new Event('connectionstatechange',t);e.dispatchEvent(a)}return t},this.addEventListener('iceconnectionstatechange',this._connectionstatechangepoly)),a.apply(this,arguments)}})}function z(e){if(!e.RTCPeerConnection)return;const t=c(e);if('chrome'===t.browser&&71<=t.version)return;const a=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf('\na=extmap-allow-mixed')&&(e.sdp=e.sdp.split('\n').filter((e)=>'a=extmap-allow-mixed'!==e.trim()).join('\n')),a.apply(this,arguments)}}a.r(t);var Y={};a.r(Y),a.d(Y,'shimGetUserMedia',function(){return p}),a.d(Y,'shimGetDisplayMedia',function(){return u}),a.d(Y,'shimMediaStream',function(){return v}),a.d(Y,'shimOnTrack',function(){return f}),a.d(Y,'shimGetSendersWithDtmf',function(){return S}),a.d(Y,'shimSenderReceiverGetStats',function(){return C}),a.d(Y,'shimAddTrackRemoveTrackWithNative',function(){return h}),a.d(Y,'shimAddTrackRemoveTrack',function(){return E}),a.d(Y,'shimPeerConnection',function(){return R}),a.d(Y,'fixNegotiationNeeded',function(){return b});var Q={};a.r(Q),a.d(Q,'shimGetUserMedia',function(){return T}),a.d(Q,'shimGetDisplayMedia',function(){return I}),a.d(Q,'shimPeerConnection',function(){return N}),a.d(Q,'shimReplaceTrack',function(){return A});var X={};a.r(X),a.d(X,'shimGetUserMedia',function(){return O}),a.d(X,'shimGetDisplayMedia',function(){return P}),a.d(X,'shimOnTrack',function(){return D}),a.d(X,'shimPeerConnection',function(){return _}),a.d(X,'shimSenderGetStats',function(){return M}),a.d(X,'shimReceiverGetStats',function(){return w}),a.d(X,'shimRemoveStream',function(){return U}),a.d(X,'shimRTCDataChannel',function(){return L});var Z={};a.r(Z),a.d(Z,'shimLocalStreamsAPI',function(){return F}),a.d(Z,'shimRemoteStreamsAPI',function(){return k}),a.d(Z,'shimCallbacksAPI',function(){return B}),a.d(Z,'shimGetUserMedia',function(){return x}),a.d(Z,'shimConstraints',function(){return H}),a.d(Z,'shimRTCIceServerUrls',function(){return G}),a.d(Z,'shimTrackEventTransceiver',function(){return V}),a.d(Z,'shimCreateOfferLegacy',function(){return j});var ee={};a.r(ee),a.d(ee,'shimRTCIceCandidate',function(){return W}),a.d(ee,'shimMaxMessageSize',function(){return q}),a.d(ee,'shimSendThrowTypeError',function(){return J}),a.d(ee,'shimConnectionState',function(){return K}),a.d(ee,'removeAllowExtmapMixed',function(){return z});var te={};a.r(te),a.d(te,'default',function(){return le});let ae=!0,re=!0;const ne=s;var oe=a(1),ie=a.n(oe),se=a(0),de=a.n(se);const ce=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const a=s,n=c(e),d={browserDetails:n,commonShim:ee,extractVersion:r,disableLog:o,disableWarnings:i};switch(n.browser){case'chrome':if(!R||!t.shimChrome)return a('Chrome shim is not included in this adapter release.'),d;a('adapter.js shimming chrome.'),d.browserShim=Y,p(e),v(e),R(e),f(e),E(e),S(e),C(e),b(e),W(e),K(e),q(e),J(e),z(e);break;case'firefox':if(!_||!t.shimFirefox)return a('Firefox shim is not included in this adapter release.'),d;a('adapter.js shimming firefox.'),d.browserShim=X,O(e),_(e),D(e),U(e),M(e),w(e),L(e),W(e),K(e),q(e),J(e);break;case'edge':if(!N||!t.shimEdge)return a('MS edge shim is not included in this adapter release.'),d;a('adapter.js shimming edge.'),d.browserShim=Q,T(e),I(e),N(e),A(e),q(e),J(e);break;case'safari':if(!t.shimSafari)return a('Safari shim is not included in this adapter release.'),d;a('adapter.js shimming safari.'),d.browserShim=Z,G(e),j(e),B(e),F(e),k(e),V(e),x(e),W(e),q(e),J(e),z(e);break;default:a('Unsupported browser!');}return d}({window});var le=ce;a(2),a(3),window.adapter=te,window.version='1.52.8',a(4),a(5),a(96),a(97),a(98),a(99),a(100),a(101),a(102),a(103),a(104),a(105),a(106),a(107),a(108),a(109),a(110),a(111),a(112),a(113),a(114),a(115),a(116)}]);